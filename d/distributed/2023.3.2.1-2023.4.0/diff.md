# Comparing `tmp/distributed-2023.3.2.1.tar.gz` & `tmp/distributed-2023.4.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "distributed-2023.3.2.1.tar", last modified: Wed Apr  5 16:56:20 2023, max compression
+gzip compressed data, was "distributed-2023.4.0.tar", last modified: Fri Apr 14 18:42:33 2023, max compression
```

## Comparing `distributed-2023.3.2.1.tar` & `distributed-2023.4.0.tar`

### file list

```diff
@@ -1,286 +1,287 @@
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.267234 distributed-2023.3.2.1/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      104 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/AUTHORS.md
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1533 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/LICENSE.txt
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      680 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/MANIFEST.in
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2845 2023-04-05 16:56:20.267399 distributed-2023.3.2.1/PKG-INFO
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1801 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/README.rst
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.268954 distributed-2023.3.2.1/distributed/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4163 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5528 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/_concurrent_futures_thread.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1297 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/_signals.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1372 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/_stories.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      502 2023-04-05 16:56:20.269029 distributed-2023.3.2.1/distributed/_version.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    28698 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/active_memory_manager.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    10649 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/actor.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7347 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/batched.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      121 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/bokeh.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5742 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/cfexecutor.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1947 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/chaos.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.145423 distributed-2023.3.2.1/distributed/cli/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/cli/__init__.py
--rwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7077 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/cli/dask_scheduler.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1269 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/cli/dask_spec.py
--rwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5468 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/cli/dask_ssh.py
--rwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    15948 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/cli/dask_worker.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1092 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/cli/utils.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)   193160 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/client.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    10985 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/cluster_dump.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6717 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/collections.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.153433 distributed-2023.3.2.1/distributed/comm/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1285 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8597 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/addressing.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    37224 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/asyncio_tcp.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    11809 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/core.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    10253 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/inproc.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2815 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/registry.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    24495 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/tcp.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    22794 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/ucx.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4220 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/utils.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    14184 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/comm/ws.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8097 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/compatibility.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6874 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/config.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    55836 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/core.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2146 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/counter.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.158612 distributed-2023.3.2.1/distributed/dashboard/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/__init__.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.164263 distributed-2023.3.2.1/distributed/dashboard/components/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1550 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/components/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5818 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/components/nvml.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)   146950 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/components/scheduler.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    19467 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/components/shared.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    15424 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/components/worker.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1832 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/dashboard/core.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2313 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/export_tool.js
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      763 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/export_tool.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5568 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/dashboard/scheduler.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.164833 distributed-2023.3.2.1/distributed/dashboard/templates/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      241 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/templates/performance_report.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      199 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/theme.yaml
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1668 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/utils.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      840 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/dashboard/worker.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.172191 distributed-2023.3.2.1/distributed/deploy/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      466 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6702 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/adaptive.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7802 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/adaptive_core.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    19472 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/cluster.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    10434 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/local.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    15514 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/old_ssh.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    23841 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/spec.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    15265 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/ssh.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6106 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/subprocess.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      888 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/deploy/utils.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.180023 distributed-2023.3.2.1/distributed/diagnostics/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      221 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1302 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/cluster_dump.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2190 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/eventstream.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4991 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/diagnostics/graph_layout.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6972 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/memory_sampler.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    10781 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/nvml.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    22472 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/diagnostics/plugin.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    12565 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/progress.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6063 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/progress_stream.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    14665 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/progressbar.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5677 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/task_stream.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2434 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diagnostics/websocket.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     9172 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/diskutils.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    45165 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/distributed-schema.yaml
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    13999 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/distributed.yaml
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8536 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/event.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.184143 distributed-2023.3.2.1/distributed/http/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)       84 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      258 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/health.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1480 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/prometheus.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4377 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/proxy.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2548 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/routing.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.186858 distributed-2023.3.2.1/distributed/http/scheduler/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/scheduler/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2943 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/scheduler/api.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6926 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/scheduler/info.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2159 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/scheduler/json.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      659 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/http/scheduler/missing_bokeh.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.188820 distributed-2023.3.2.1/distributed/http/scheduler/prometheus/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      291 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/scheduler/prometheus/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6602 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/scheduler/prometheus/core.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3514 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/scheduler/prometheus/semaphore.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1617 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/scheduler/prometheus/stealing.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.189291 distributed-2023.3.2.1/distributed/http/static/
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.191369 distributed-2023.3.2.1/distributed/http/static/css/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2260 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/css/base.css
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      250 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/css/gpu.css
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      840 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/css/individual-cluster-map.css
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1012 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/css/status.css
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.196496 distributed-2023.3.2.1/distributed/http/static/images/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1607 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/images/dask-logo.svg
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      552 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/images/fa-bars.svg
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    15086 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/images/favicon.ico
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    11002 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/images/jupyter.svg
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    18663 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/images/numpy.png
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1213 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/images/pandas.png
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)   830916 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/images/python.png
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      667 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/individual-cluster-map.html
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.203489 distributed-2023.3.2.1/distributed/http/static/js/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    17271 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/js/anime.min.js
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     9337 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/js/individual-cluster-map.js
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3276 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/static/js/reconnecting-websocket.min.js
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      223 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/statics.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.211504 distributed-2023.3.2.1/distributed/http/templates/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2930 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/base.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      388 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/call-stack.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1351 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/exceptions.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      404 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/gpu.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      276 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/json-index.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      116 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/logs.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      369 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/main.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)       95 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/simple.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      635 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/status.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5672 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/task.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1405 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/worker-table.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2024 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/worker.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      457 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/templates/workers.html
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1184 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/utils.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.212015 distributed-2023.3.2.1/distributed/http/worker/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/worker/__init__.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.212880 distributed-2023.3.2.1/distributed/http/worker/prometheus/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      288 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/worker/prometheus/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     9702 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/http/worker/prometheus/core.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5599 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/lock.py
--rwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    12252 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/metrics.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8044 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/multi_lock.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    33455 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/nanny.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6710 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/node.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1449 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/objects.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7513 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/preloading.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    12887 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/process.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      931 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/proctitle.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    16141 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/profile.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.221402 distributed-2023.3.2.1/distributed/protocol/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3442 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1336 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/arrow.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6159 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/compression.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5964 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/core.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1181 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/cuda.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2788 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/cupy.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      836 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/h5py.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1127 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/keras.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1466 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/netcdf4.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2139 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/numba.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6664 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/numpy.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3043 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/pickle.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1507 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/rmm.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      800 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/scipy.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    28361 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/protocol/serialize.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      955 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/sparse.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1993 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/torch.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6102 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/protocol/utils.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3733 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/publish.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    15652 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/pubsub.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/py.typed
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    10082 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/queues.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7620 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/recreate_tasks.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)   294107 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/scheduler.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    13825 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/security.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    20568 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/semaphore.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.225898 distributed-2023.3.2.1/distributed/shuffle/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      692 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/shuffle/__init__.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2938 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/shuffle/_arrow.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     9212 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/shuffle/_buffer.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2499 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/shuffle/_comms.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3550 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/shuffle/_disk.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2361 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/shuffle/_limiter.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    13924 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/shuffle/_merge.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5203 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/shuffle/_rechunk.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     9878 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/shuffle/_scheduler_extension.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6869 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/shuffle/_shuffle.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    33146 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/shuffle/_worker_extension.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      607 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/sizeof.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    13287 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/spill.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    19859 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/stealing.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1883 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/system.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8642 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/system_monitor.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7104 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/threadpoolexecutor.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    54533 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/utils.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    13992 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/utils_comm.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8050 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/utils_perf.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    80266 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/utils_test.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8463 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/variable.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5146 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/versions.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.226934 distributed-2023.3.2.1/distributed/widgets/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      267 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/__init__.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.234859 distributed-2023.3.2.1/distributed/widgets/templates/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2265 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/client.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1589 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/cluster.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1258 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/widgets/templates/computation.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      518 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/future.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      544 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/has_what.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      234 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/local_cluster.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      636 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/log.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      168 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/logs.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1290 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/process_interface.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      317 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/scheduler.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6705 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/scheduler_info.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      407 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/security.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      448 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/task_state.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      295 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/who_has.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      407 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/widgets/templates/worker_state.html.j2
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)   126446 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/worker.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2276 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/worker_client.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    20860 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/distributed/worker_memory.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)   141533 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/distributed/worker_state_machine.py
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.142289 distributed-2023.3.2.1/distributed.egg-info/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2845 2023-04-05 16:56:19.000000 distributed-2023.3.2.1/distributed.egg-info/PKG-INFO
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8219 2023-04-05 16:56:20.000000 distributed-2023.3.2.1/distributed.egg-info/SOURCES.txt
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        1 2023-04-05 16:56:19.000000 distributed-2023.3.2.1/distributed.egg-info/dependency_links.txt
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      335 2023-04-05 16:56:19.000000 distributed-2023.3.2.1/distributed.egg-info/entry_points.txt
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        1 2023-04-05 16:56:19.000000 distributed-2023.3.2.1/distributed.egg-info/not-zip-safe
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      227 2023-04-05 16:56:19.000000 distributed-2023.3.2.1/distributed.egg-info/requires.txt
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)       12 2023-04-05 16:56:19.000000 distributed-2023.3.2.1/distributed.egg-info/top_level.txt
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.081461 distributed-2023.3.2.1/docs/
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.265641 distributed-2023.3.2.1/docs/source/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    11754 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/active_memory_manager.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8000 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/actors.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4113 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/api.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3519 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/asynchronous.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)   248382 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/changelog.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7084 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/client.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3770 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/communications.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7048 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/develop.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6823 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/diagnosing-performance.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3392 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/efficiency.rst
-drwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)        0 2023-04-05 16:56:20.266405 distributed-2023.3.2.1/docs/source/examples/
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8953 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/examples/word-count.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)       75 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/examples-overview.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4228 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/faq.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4613 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/foundations.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4016 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/http_services.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4423 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/index.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1182 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/install.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     7293 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/journey.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6470 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/killed.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     1828 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/limitations.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6458 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/locality.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2807 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/logging.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6546 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/manage-computation.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8550 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/memory.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4100 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/plugins.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3265 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/priority.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6831 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/prometheus.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    11199 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/protocol.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3107 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/publish.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      402 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/queues.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2942 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/quickstart.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8773 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/related-work.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3418 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/resilience.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6049 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/resources.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    16084 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/scheduling-policies.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    16901 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/scheduling-state.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     6518 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/serialization.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     8343 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/task-launch.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     4190 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/tls.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5557 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/work-stealing.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    13489 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/worker-memory.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    22542 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/worker-state.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     3467 2023-04-05 16:36:53.000000 distributed-2023.3.2.1/docs/source/worker.rst
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)      257 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/requirements.txt
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     5257 2023-04-05 16:56:20.268628 distributed-2023.3.2.1/setup.cfg
--rwxr-xr-x   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)     2658 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/setup.py
--rw-r--r--   0 bzaitlen (1504706408) NVIDIA.COM\Domain Users (1019530959)    68352 2023-04-05 16:52:38.000000 distributed-2023.3.2.1/versioneer.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.870804 distributed-2023.4.0/
+-rw-r--r--   0 james      (501) staff       (20)      104 2020-06-30 15:19:20.000000 distributed-2023.4.0/AUTHORS.md
+-rw-r--r--   0 james      (501) staff       (20)     1533 2022-10-21 17:45:03.000000 distributed-2023.4.0/LICENSE.txt
+-rw-r--r--   0 james      (501) staff       (20)      633 2023-04-14 18:06:24.000000 distributed-2023.4.0/MANIFEST.in
+-rw-r--r--   0 james      (501) staff       (20)     2882 2023-04-14 18:42:33.870089 distributed-2023.4.0/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     1801 2022-10-21 17:45:03.000000 distributed-2023.4.0/README.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.871643 distributed-2023.4.0/distributed/
+-rw-r--r--   0 james      (501) staff       (20)     3836 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5528 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/_concurrent_futures_thread.py
+-rw-r--r--   0 james      (501) staff       (20)     1297 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/_signals.py
+-rw-r--r--   0 james      (501) staff       (20)     1372 2022-11-10 20:28:41.000000 distributed-2023.4.0/distributed/_stories.py
+-rw-r--r--   0 james      (501) staff       (20)      500 2023-04-14 18:42:33.871793 distributed-2023.4.0/distributed/_version.py
+-rw-r--r--   0 james      (501) staff       (20)    29277 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/active_memory_manager.py
+-rw-r--r--   0 james      (501) staff       (20)    10649 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/actor.py
+-rw-r--r--   0 james      (501) staff       (20)     7347 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/batched.py
+-rw-r--r--   0 james      (501) staff       (20)      121 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/bokeh.py
+-rw-r--r--   0 james      (501) staff       (20)     5742 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/cfexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)     1947 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/chaos.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.698760 distributed-2023.4.0/distributed/cli/
+-rw-r--r--   0 james      (501) staff       (20)        0 2020-06-30 15:19:20.000000 distributed-2023.4.0/distributed/cli/__init__.py
+-rwxr-xr-x   0 james      (501) staff       (20)     7077 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/cli/dask_scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)     1269 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/cli/dask_spec.py
+-rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/cli/dask_ssh.py
+-rwxr-xr-x   0 james      (501) staff       (20)    15948 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/cli/dask_worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1092 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/cli/utils.py
+-rw-r--r--   0 james      (501) staff       (20)   200823 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/client.py
+-rw-r--r--   0 james      (501) staff       (20)    10985 2022-12-02 19:43:17.000000 distributed-2023.4.0/distributed/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     6717 2023-01-30 20:01:26.000000 distributed-2023.4.0/distributed/collections.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.709043 distributed-2023.4.0/distributed/comm/
+-rw-r--r--   0 james      (501) staff       (20)     1285 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/comm/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     8597 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/comm/addressing.py
+-rw-r--r--   0 james      (501) staff       (20)    37224 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/comm/asyncio_tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    11809 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/comm/core.py
+-rw-r--r--   0 james      (501) staff       (20)    10253 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/comm/inproc.py
+-rw-r--r--   0 james      (501) staff       (20)     2815 2022-11-15 16:22:42.000000 distributed-2023.4.0/distributed/comm/registry.py
+-rw-r--r--   0 james      (501) staff       (20)    24495 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/comm/tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    22794 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/comm/ucx.py
+-rw-r--r--   0 james      (501) staff       (20)     4220 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/comm/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14184 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/comm/ws.py
+-rw-r--r--   0 james      (501) staff       (20)     7959 2023-04-14 18:06:27.000000 distributed-2023.4.0/distributed/compatibility.py
+-rw-r--r--   0 james      (501) staff       (20)     6874 2022-12-02 19:43:17.000000 distributed-2023.4.0/distributed/config.py
+-rw-r--r--   0 james      (501) staff       (20)    56025 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2146 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/counter.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.714942 distributed-2023.4.0/distributed/dashboard/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:03.000000 distributed-2023.4.0/distributed/dashboard/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.720888 distributed-2023.4.0/distributed/dashboard/components/
+-rw-r--r--   0 james      (501) staff       (20)     1550 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/dashboard/components/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5818 2022-11-15 18:24:05.000000 distributed-2023.4.0/distributed/dashboard/components/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)     7055 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/dashboard/components/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)   146950 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/dashboard/components/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    19467 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/dashboard/components/shared.py
+-rw-r--r--   0 james      (501) staff       (20)    15424 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/dashboard/components/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1690 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/dashboard/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2313 2021-07-06 20:52:40.000000 distributed-2023.4.0/distributed/dashboard/export_tool.js
+-rw-r--r--   0 james      (501) staff       (20)      763 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/dashboard/export_tool.py
+-rw-r--r--   0 james      (501) staff       (20)     5717 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/dashboard/scheduler.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.721593 distributed-2023.4.0/distributed/dashboard/templates/
+-rw-r--r--   0 james      (501) staff       (20)      241 2022-06-06 20:36:46.000000 distributed-2023.4.0/distributed/dashboard/templates/performance_report.html
+-rw-r--r--   0 james      (501) staff       (20)      199 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/dashboard/theme.yaml
+-rw-r--r--   0 james      (501) staff       (20)     1668 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/dashboard/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      840 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/dashboard/worker.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.727676 distributed-2023.4.0/distributed/deploy/
+-rw-r--r--   0 james      (501) staff       (20)      466 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/deploy/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6702 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/deploy/adaptive.py
+-rw-r--r--   0 james      (501) staff       (20)     7802 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/deploy/adaptive_core.py
+-rw-r--r--   0 james      (501) staff       (20)    19472 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/deploy/cluster.py
+-rw-r--r--   0 james      (501) staff       (20)    10434 2022-12-02 19:43:17.000000 distributed-2023.4.0/distributed/deploy/local.py
+-rw-r--r--   0 james      (501) staff       (20)    15514 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/deploy/old_ssh.py
+-rw-r--r--   0 james      (501) staff       (20)    23841 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/deploy/spec.py
+-rw-r--r--   0 james      (501) staff       (20)    15265 2022-11-15 18:24:05.000000 distributed-2023.4.0/distributed/deploy/ssh.py
+-rw-r--r--   0 james      (501) staff       (20)     7656 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/deploy/subprocess.py
+-rw-r--r--   0 james      (501) staff       (20)      888 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/deploy/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.732762 distributed-2023.4.0/distributed/diagnostics/
+-rw-r--r--   0 james      (501) staff       (20)      221 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/diagnostics/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1302 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/diagnostics/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     2190 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/diagnostics/eventstream.py
+-rw-r--r--   0 james      (501) staff       (20)     4994 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/diagnostics/graph_layout.py
+-rw-r--r--   0 james      (501) staff       (20)     6972 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/diagnostics/memory_sampler.py
+-rw-r--r--   0 james      (501) staff       (20)    10781 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/diagnostics/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)    26647 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/diagnostics/plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    12565 2022-12-02 19:43:17.000000 distributed-2023.4.0/distributed/diagnostics/progress.py
+-rw-r--r--   0 james      (501) staff       (20)     6063 2022-11-07 19:30:53.000000 distributed-2023.4.0/distributed/diagnostics/progress_stream.py
+-rw-r--r--   0 james      (501) staff       (20)    14665 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/diagnostics/progressbar.py
+-rw-r--r--   0 james      (501) staff       (20)     1124 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/diagnostics/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)     5677 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/diagnostics/task_stream.py
+-rw-r--r--   0 james      (501) staff       (20)     2434 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/diagnostics/websocket.py
+-rw-r--r--   0 james      (501) staff       (20)     9172 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/diskutils.py
+-rw-r--r--   0 james      (501) staff       (20)    45370 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/distributed-schema.yaml
+-rw-r--r--   0 james      (501) staff       (20)    14016 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/distributed.yaml
+-rw-r--r--   0 james      (501) staff       (20)     8536 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/event.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.735201 distributed-2023.4.0/distributed/http/
+-rw-r--r--   0 james      (501) staff       (20)       84 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      258 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/http/health.py
+-rw-r--r--   0 james      (501) staff       (20)     1480 2022-11-15 18:24:05.000000 distributed-2023.4.0/distributed/http/prometheus.py
+-rw-r--r--   0 james      (501) staff       (20)     4377 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/proxy.py
+-rw-r--r--   0 james      (501) staff       (20)     2548 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/routing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.737286 distributed-2023.4.0/distributed/http/scheduler/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/scheduler/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2943 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/http/scheduler/api.py
+-rw-r--r--   0 james      (501) staff       (20)     6926 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/scheduler/info.py
+-rw-r--r--   0 james      (501) staff       (20)     2159 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/scheduler/json.py
+-rw-r--r--   0 james      (501) staff       (20)      625 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/http/scheduler/missing_bokeh.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.739444 distributed-2023.4.0/distributed/http/scheduler/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      291 2022-11-15 18:24:05.000000 distributed-2023.4.0/distributed/http/scheduler/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6873 2023-04-14 18:06:27.000000 distributed-2023.4.0/distributed/http/scheduler/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     3514 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/http/scheduler/prometheus/semaphore.py
+-rw-r--r--   0 james      (501) staff       (20)     1617 2022-12-02 19:43:17.000000 distributed-2023.4.0/distributed/http/scheduler/prometheus/stealing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.739949 distributed-2023.4.0/distributed/http/static/
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.743537 distributed-2023.4.0/distributed/http/static/css/
+-rw-r--r--   0 james      (501) staff       (20)     2260 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/http/static/css/base.css
+-rw-r--r--   0 james      (501) staff       (20)      250 2021-11-11 21:43:12.000000 distributed-2023.4.0/distributed/http/static/css/gpu.css
+-rw-r--r--   0 james      (501) staff       (20)      840 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/static/css/individual-cluster-map.css
+-rw-r--r--   0 james      (501) staff       (20)     1012 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/http/static/css/status.css
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.749050 distributed-2023.4.0/distributed/http/static/images/
+-rw-r--r--   0 james      (501) staff       (20)     1607 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/static/images/dask-logo.svg
+-rw-r--r--   0 james      (501) staff       (20)      552 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/static/images/fa-bars.svg
+-rw-r--r--   0 james      (501) staff       (20)    15086 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/static/images/favicon.ico
+-rw-r--r--   0 james      (501) staff       (20)    11002 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/http/static/images/jupyter.svg
+-rw-r--r--   0 james      (501) staff       (20)    18663 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/http/static/images/numpy.png
+-rw-r--r--   0 james      (501) staff       (20)     1213 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/http/static/images/pandas.png
+-rw-r--r--   0 james      (501) staff       (20)   830916 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/http/static/images/python.png
+-rw-r--r--   0 james      (501) staff       (20)      667 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/static/individual-cluster-map.html
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.757604 distributed-2023.4.0/distributed/http/static/js/
+-rw-r--r--   0 james      (501) staff       (20)    17271 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/static/js/anime.min.js
+-rw-r--r--   0 james      (501) staff       (20)     9337 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/static/js/individual-cluster-map.js
+-rw-r--r--   0 james      (501) staff       (20)     3276 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/static/js/reconnecting-websocket.min.js
+-rw-r--r--   0 james      (501) staff       (20)      223 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/statics.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.769193 distributed-2023.4.0/distributed/http/templates/
+-rw-r--r--   0 james      (501) staff       (20)     2930 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/http/templates/base.html
+-rw-r--r--   0 james      (501) staff       (20)      388 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/templates/call-stack.html
+-rw-r--r--   0 james      (501) staff       (20)     1351 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/templates/exceptions.html
+-rw-r--r--   0 james      (501) staff       (20)      404 2021-11-11 21:43:12.000000 distributed-2023.4.0/distributed/http/templates/gpu.html
+-rw-r--r--   0 james      (501) staff       (20)      276 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/templates/json-index.html
+-rw-r--r--   0 james      (501) staff       (20)      116 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/templates/logs.html
+-rw-r--r--   0 james      (501) staff       (20)      369 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/templates/main.html
+-rw-r--r--   0 james      (501) staff       (20)       95 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/templates/simple.html
+-rw-r--r--   0 james      (501) staff       (20)      635 2022-11-15 16:22:42.000000 distributed-2023.4.0/distributed/http/templates/status.html
+-rw-r--r--   0 james      (501) staff       (20)     5672 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/templates/task.html
+-rw-r--r--   0 james      (501) staff       (20)     1405 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/templates/worker-table.html
+-rw-r--r--   0 james      (501) staff       (20)     2024 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/templates/worker.html
+-rw-r--r--   0 james      (501) staff       (20)      457 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/templates/workers.html
+-rw-r--r--   0 james      (501) staff       (20)     1184 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/http/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.770281 distributed-2023.4.0/distributed/http/worker/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.4.0/distributed/http/worker/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.771506 distributed-2023.4.0/distributed/http/worker/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      288 2022-11-15 18:24:05.000000 distributed-2023.4.0/distributed/http/worker/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     9973 2023-04-14 18:06:27.000000 distributed-2023.4.0/distributed/http/worker/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     5599 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/lock.py
+-rwxr-xr-x   0 james      (501) staff       (20)    12252 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/metrics.py
+-rw-r--r--   0 james      (501) staff       (20)     8044 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/multi_lock.py
+-rw-r--r--   0 james      (501) staff       (20)    33455 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/nanny.py
+-rw-r--r--   0 james      (501) staff       (20)     6710 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/node.py
+-rw-r--r--   0 james      (501) staff       (20)     1449 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/objects.py
+-rw-r--r--   0 james      (501) staff       (20)     7513 2022-12-02 19:43:17.000000 distributed-2023.4.0/distributed/preloading.py
+-rw-r--r--   0 james      (501) staff       (20)    12887 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/process.py
+-rw-r--r--   0 james      (501) staff       (20)      931 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/proctitle.py
+-rw-r--r--   0 james      (501) staff       (20)    16141 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/profile.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.782381 distributed-2023.4.0/distributed/protocol/
+-rw-r--r--   0 james      (501) staff       (20)     3442 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1336 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     6159 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/protocol/compression.py
+-rw-r--r--   0 james      (501) staff       (20)     5964 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1181 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/cuda.py
+-rw-r--r--   0 james      (501) staff       (20)     2788 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/cupy.py
+-rw-r--r--   0 james      (501) staff       (20)      836 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/h5py.py
+-rw-r--r--   0 james      (501) staff       (20)     1127 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/keras.py
+-rw-r--r--   0 james      (501) staff       (20)     1466 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/netcdf4.py
+-rw-r--r--   0 james      (501) staff       (20)     2139 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/numba.py
+-rw-r--r--   0 james      (501) staff       (20)     6664 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/protocol/numpy.py
+-rw-r--r--   0 james      (501) staff       (20)     3043 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/protocol/pickle.py
+-rw-r--r--   0 james      (501) staff       (20)     1507 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)      800 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/scipy.py
+-rw-r--r--   0 james      (501) staff       (20)    28504 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/protocol/serialize.py
+-rw-r--r--   0 james      (501) staff       (20)      955 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/protocol/sparse.py
+-rw-r--r--   0 james      (501) staff       (20)     1993 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/torch.py
+-rw-r--r--   0 james      (501) staff       (20)     6102 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/protocol/utils.py
+-rw-r--r--   0 james      (501) staff       (20)     3733 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/publish.py
+-rw-r--r--   0 james      (501) staff       (20)    15652 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/pubsub.py
+-rw-r--r--   0 james      (501) staff       (20)        0 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/py.typed
+-rw-r--r--   0 james      (501) staff       (20)    10082 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/queues.py
+-rw-r--r--   0 james      (501) staff       (20)     7620 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/recreate_tasks.py
+-rw-r--r--   0 james      (501) staff       (20)   301071 2023-04-14 18:06:27.000000 distributed-2023.4.0/distributed/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    13825 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/security.py
+-rw-r--r--   0 james      (501) staff       (20)    20568 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/semaphore.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.788315 distributed-2023.4.0/distributed/shuffle/
+-rw-r--r--   0 james      (501) staff       (20)      692 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/shuffle/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2938 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/shuffle/_arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     9212 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/shuffle/_buffer.py
+-rw-r--r--   0 james      (501) staff       (20)     2499 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/shuffle/_comms.py
+-rw-r--r--   0 james      (501) staff       (20)     3550 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/shuffle/_disk.py
+-rw-r--r--   0 james      (501) staff       (20)     2361 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/shuffle/_limiter.py
+-rw-r--r--   0 james      (501) staff       (20)    11736 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/shuffle/_merge.py
+-rw-r--r--   0 james      (501) staff       (20)     5203 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/shuffle/_rechunk.py
+-rw-r--r--   0 james      (501) staff       (20)    10437 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/shuffle/_scheduler_extension.py
+-rw-r--r--   0 james      (501) staff       (20)     8299 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/shuffle/_shuffle.py
+-rw-r--r--   0 james      (501) staff       (20)    33146 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/shuffle/_worker_extension.py
+-rw-r--r--   0 james      (501) staff       (20)      607 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/sizeof.py
+-rw-r--r--   0 james      (501) staff       (20)    13410 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/spill.py
+-rw-r--r--   0 james      (501) staff       (20)    19859 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/stealing.py
+-rw-r--r--   0 james      (501) staff       (20)     1883 2022-10-27 14:20:24.000000 distributed-2023.4.0/distributed/system.py
+-rw-r--r--   0 james      (501) staff       (20)     8808 2023-04-14 18:06:27.000000 distributed-2023.4.0/distributed/system_monitor.py
+-rw-r--r--   0 james      (501) staff       (20)     7104 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/threadpoolexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)    54593 2023-04-14 18:06:27.000000 distributed-2023.4.0/distributed/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    13992 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/utils_comm.py
+-rw-r--r--   0 james      (501) staff       (20)     8050 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/utils_perf.py
+-rw-r--r--   0 james      (501) staff       (20)    80266 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     8463 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/variable.py
+-rw-r--r--   0 james      (501) staff       (20)     5194 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/versions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.788915 distributed-2023.4.0/distributed/widgets/
+-rw-r--r--   0 james      (501) staff       (20)      267 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/widgets/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.804935 distributed-2023.4.0/distributed/widgets/templates/
+-rw-r--r--   0 james      (501) staff       (20)     2265 2022-11-10 20:28:41.000000 distributed-2023.4.0/distributed/widgets/templates/client.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1589 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1270 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/widgets/templates/computation.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      518 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/future.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      544 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/has_what.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      234 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/local_cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      636 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/log.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      168 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/logs.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1290 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/process_interface.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      317 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/scheduler.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     6705 2022-10-21 17:45:03.000000 distributed-2023.4.0/distributed/widgets/templates/scheduler_info.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/security.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      448 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/task_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      295 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/who_has.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.4.0/distributed/widgets/templates/worker_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)   126773 2023-04-14 18:06:27.000000 distributed-2023.4.0/distributed/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2276 2023-03-13 21:41:35.000000 distributed-2023.4.0/distributed/worker_client.py
+-rw-r--r--   0 james      (501) staff       (20)    21367 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/worker_memory.py
+-rw-r--r--   0 james      (501) staff       (20)   141533 2023-04-14 18:06:24.000000 distributed-2023.4.0/distributed/worker_state_machine.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.695411 distributed-2023.4.0/distributed.egg-info/
+-rw-r--r--   0 james      (501) staff       (20)     2882 2023-04-14 18:42:33.000000 distributed-2023.4.0/distributed.egg-info/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     8264 2023-04-14 18:42:33.000000 distributed-2023.4.0/distributed.egg-info/SOURCES.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-04-14 18:42:33.000000 distributed-2023.4.0/distributed.egg-info/dependency_links.txt
+-rw-r--r--   0 james      (501) staff       (20)      335 2023-04-14 18:42:33.000000 distributed-2023.4.0/distributed.egg-info/entry_points.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-04-14 18:42:32.000000 distributed-2023.4.0/distributed.egg-info/not-zip-safe
+-rw-r--r--   0 james      (501) staff       (20)      227 2023-04-14 18:42:33.000000 distributed-2023.4.0/distributed.egg-info/requires.txt
+-rw-r--r--   0 james      (501) staff       (20)       12 2023-04-14 18:42:33.000000 distributed-2023.4.0/distributed.egg-info/top_level.txt
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.630319 distributed-2023.4.0/docs/
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.867156 distributed-2023.4.0/docs/source/
+-rw-r--r--   0 james      (501) staff       (20)    11754 2022-10-27 14:20:24.000000 distributed-2023.4.0/docs/source/active_memory_manager.rst
+-rw-r--r--   0 james      (501) staff       (20)     8000 2022-11-15 18:24:05.000000 distributed-2023.4.0/docs/source/actors.rst
+-rw-r--r--   0 james      (501) staff       (20)     4113 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/api.rst
+-rw-r--r--   0 james      (501) staff       (20)     3519 2022-11-15 18:24:05.000000 distributed-2023.4.0/docs/source/asynchronous.rst
+-rw-r--r--   0 james      (501) staff       (20)   252029 2023-04-14 18:16:58.000000 distributed-2023.4.0/docs/source/changelog.rst
+-rw-r--r--   0 james      (501) staff       (20)     7084 2021-11-11 21:43:12.000000 distributed-2023.4.0/docs/source/client.rst
+-rw-r--r--   0 james      (501) staff       (20)     3770 2021-11-11 17:33:04.000000 distributed-2023.4.0/docs/source/communications.rst
+-rw-r--r--   0 james      (501) staff       (20)     7048 2022-08-08 21:17:38.000000 distributed-2023.4.0/docs/source/develop.rst
+-rw-r--r--   0 james      (501) staff       (20)     6823 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/diagnosing-performance.rst
+-rw-r--r--   0 james      (501) staff       (20)     3392 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/efficiency.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-04-14 18:42:33.868657 distributed-2023.4.0/docs/source/examples/
+-rw-r--r--   0 james      (501) staff       (20)     8953 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/examples/word-count.rst
+-rw-r--r--   0 james      (501) staff       (20)       75 2020-06-30 15:19:20.000000 distributed-2023.4.0/docs/source/examples-overview.rst
+-rw-r--r--   0 james      (501) staff       (20)     4228 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/faq.rst
+-rw-r--r--   0 james      (501) staff       (20)     4613 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/foundations.rst
+-rw-r--r--   0 james      (501) staff       (20)     4016 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/http_services.rst
+-rw-r--r--   0 james      (501) staff       (20)     4423 2023-03-13 21:41:35.000000 distributed-2023.4.0/docs/source/index.rst
+-rw-r--r--   0 james      (501) staff       (20)     1182 2022-08-08 21:17:38.000000 distributed-2023.4.0/docs/source/install.rst
+-rw-r--r--   0 james      (501) staff       (20)     7293 2021-11-11 17:33:04.000000 distributed-2023.4.0/docs/source/journey.rst
+-rw-r--r--   0 james      (501) staff       (20)     6470 2023-04-14 18:06:24.000000 distributed-2023.4.0/docs/source/killed.rst
+-rw-r--r--   0 james      (501) staff       (20)     1828 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/limitations.rst
+-rw-r--r--   0 james      (501) staff       (20)     6458 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/locality.rst
+-rw-r--r--   0 james      (501) staff       (20)     2807 2021-11-11 17:33:04.000000 distributed-2023.4.0/docs/source/logging.rst
+-rw-r--r--   0 james      (501) staff       (20)     6546 2021-07-06 20:52:40.000000 distributed-2023.4.0/docs/source/manage-computation.rst
+-rw-r--r--   0 james      (501) staff       (20)     8550 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/memory.rst
+-rw-r--r--   0 james      (501) staff       (20)     4100 2023-02-14 16:13:20.000000 distributed-2023.4.0/docs/source/plugins.rst
+-rw-r--r--   0 james      (501) staff       (20)     3265 2021-11-11 21:43:12.000000 distributed-2023.4.0/docs/source/priority.rst
+-rw-r--r--   0 james      (501) staff       (20)     7416 2023-04-14 18:06:27.000000 distributed-2023.4.0/docs/source/prometheus.rst
+-rw-r--r--   0 james      (501) staff       (20)    11199 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/protocol.rst
+-rw-r--r--   0 james      (501) staff       (20)     3107 2020-12-18 22:54:04.000000 distributed-2023.4.0/docs/source/publish.rst
+-rw-r--r--   0 james      (501) staff       (20)      402 2023-04-14 18:06:24.000000 distributed-2023.4.0/docs/source/queues.rst
+-rw-r--r--   0 james      (501) staff       (20)     2942 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/quickstart.rst
+-rw-r--r--   0 james      (501) staff       (20)     8773 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/related-work.rst
+-rw-r--r--   0 james      (501) staff       (20)     3418 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/resilience.rst
+-rw-r--r--   0 james      (501) staff       (20)     6049 2022-11-15 18:24:05.000000 distributed-2023.4.0/docs/source/resources.rst
+-rw-r--r--   0 james      (501) staff       (20)    16084 2022-11-18 16:31:28.000000 distributed-2023.4.0/docs/source/scheduling-policies.rst
+-rw-r--r--   0 james      (501) staff       (20)    16901 2022-11-15 18:24:05.000000 distributed-2023.4.0/docs/source/scheduling-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     6518 2021-11-11 17:33:04.000000 distributed-2023.4.0/docs/source/serialization.rst
+-rw-r--r--   0 james      (501) staff       (20)     8343 2022-08-08 21:17:38.000000 distributed-2023.4.0/docs/source/task-launch.rst
+-rw-r--r--   0 james      (501) staff       (20)     4190 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/tls.rst
+-rw-r--r--   0 james      (501) staff       (20)     5557 2021-11-11 17:33:04.000000 distributed-2023.4.0/docs/source/work-stealing.rst
+-rw-r--r--   0 james      (501) staff       (20)    13489 2023-03-13 21:41:35.000000 distributed-2023.4.0/docs/source/worker-memory.rst
+-rw-r--r--   0 james      (501) staff       (20)    22542 2023-04-14 18:06:24.000000 distributed-2023.4.0/docs/source/worker-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     3467 2022-10-21 17:45:03.000000 distributed-2023.4.0/docs/source/worker.rst
+-rw-r--r--   0 james      (501) staff       (20)     8995 2023-04-14 18:34:10.000000 distributed-2023.4.0/pyproject.toml
+-rw-r--r--   0 james      (501) staff       (20)       38 2023-04-14 18:42:33.870975 distributed-2023.4.0/setup.cfg
+-rw-r--r--   0 james      (501) staff       (20)      171 2023-04-14 18:06:24.000000 distributed-2023.4.0/setup.py
```

### Comparing `distributed-2023.3.2.1/LICENSE.txt` & `distributed-2023.4.0/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/MANIFEST.in` & `distributed-2023.4.0/MANIFEST.in`

 * *Files 10% similar despite different names*

```diff
@@ -11,14 +11,12 @@
 recursive-include docs *.rst
 recursive-exclude distributed **/tests/*
 
 include setup.py
 include README.rst
 include LICENSE.txt
 include MANIFEST.in
-include requirements.txt
 include distributed/py.typed
 exclude distributed/pytest_resourceleaks.py
 
 prune docs/_build
-include versioneer.py
 include distributed/_version.py
```

### Comparing `distributed-2023.3.2.1/PKG-INFO` & `distributed-2023.4.0/PKG-INFO`

 * *Files 3% similar despite different names*

```diff
@@ -1,15 +1,14 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.3.2.1
+Version: 2023.4.0
 Summary: Distributed scheduler for Dask
-Home-page: https://distributed.dask.org
-Maintainer: Matthew Rocklin
-Maintainer-email: mrocklin@gmail.com
+Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
+Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
 Classifier: Intended Audience :: Science/Research
 Classifier: License :: OSI Approved :: BSD License
 Classifier: Operating System :: OS Independent
 Classifier: Programming Language :: Python
@@ -18,14 +17,15 @@
 Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
 Classifier: Programming Language :: Python :: 3.11
 Classifier: Topic :: Scientific/Engineering
 Classifier: Topic :: System :: Distributed Computing
 Requires-Python: >=3.8
+Description-Content-Type: text/x-rst
 License-File: LICENSE.txt
 License-File: AUTHORS.md
 
 Distributed
 ===========
 
 |Test Status| |Longitudinal Report (full)| |Longitudinal Report (short)| |Coverage| |Doc Status| |Discourse| |Version Status| |NumFOCUS|
```

### Comparing `distributed-2023.3.2.1/README.rst` & `distributed-2023.4.0/README.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/__init__.py` & `distributed-2023.4.0/distributed/__init__.py`

 * *Files 6% similar despite different names*

```diff
@@ -3,22 +3,15 @@
 # isort: off
 from distributed import config  # load distributed configuration first
 from distributed import widgets  # load distributed widgets second
 
 # isort: on
 
 import atexit
-import weakref
 
-# This finalizer registers an atexit handler that has to happen before
-# distributed registers its handlers, otherwise we observe hangs on
-# cluster shutdown when using the UCX comms backend. See
-# https://github.com/dask/distributed/issues/7726 for more discussion
-
-weakref.finalize(lambda: None, lambda: None)
 import dask
 from dask.config import config  # type: ignore
 
 from distributed._version import get_versions
 from distributed.actor import Actor, ActorFuture, BaseActorFuture
 from distributed.client import (
     Client,
```

### Comparing `distributed-2023.3.2.1/distributed/_concurrent_futures_thread.py` & `distributed-2023.4.0/distributed/_concurrent_futures_thread.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/_signals.py` & `distributed-2023.4.0/distributed/_signals.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/_stories.py` & `distributed-2023.4.0/distributed/_stories.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/active_memory_manager.py` & `distributed-2023.4.0/distributed/active_memory_manager.py`

 * *Files 7% similar despite different names*

```diff
@@ -11,23 +11,23 @@
 from collections import defaultdict
 from collections.abc import Generator
 from typing import TYPE_CHECKING, Any, Literal, NamedTuple
 
 import dask
 from dask.utils import parse_timedelta
 
+# Needed to avoid Sphinx WARNING: more than one target found for cross-reference 'TaskState' and 'WorkerState'"
+# https://github.com/agronholm/sphinx-autodoc-typehints#dealing-with-circular-imports
+from distributed import client
+from distributed import scheduler as scheduler_module
 from distributed.compatibility import PeriodicCallback
 from distributed.core import Status
 from distributed.metrics import time
 from distributed.utils import import_term, log_errors
 
-if TYPE_CHECKING:
-    from distributed.client import Client
-    from distributed.scheduler import Scheduler, TaskState, WorkerState
-
 # Main logger. This is reasonably terse also at DEBUG level.
 logger = logging.getLogger(__name__)
 # Per-task logging. Exceptionally verbose at DEBUG level.
 task_logger = logging.getLogger(__name__ + ".tasks")
 
 
 class ActiveMemoryManagerExtension:
@@ -42,32 +42,35 @@
     a copy and, in the next iteration, you delete the original (if the copy succeeded).
 
     This extension is configured by the dask config section
     ``distributed.scheduler.active-memory-manager``.
     """
 
     #: Back-reference to the scheduler holding this extension
-    scheduler: Scheduler
+    scheduler: scheduler_module.Scheduler
     #: All active policies
     policies: set[ActiveMemoryManagerPolicy]
     #: Memory measure to use. Must be one of the attributes or properties of
     #: :class:`distributed.scheduler.MemoryState`.
     measure: str
     #: Run automatically every this many seconds
     interval: float
     #: Current memory (in bytes) allocated on each worker, plus/minus pending actions
     #: This attribute only exist within the scope of self.run().
-    workers_memory: dict[WorkerState, int]
+    workers_memory: dict[scheduler_module.WorkerState, int]
     #: Pending replications and deletions for each task
     #: This attribute only exist within the scope of self.run().
-    pending: dict[TaskState, tuple[set[WorkerState], set[WorkerState]]]
+    pending: dict[
+        scheduler_module.TaskState,
+        tuple[set[scheduler_module.WorkerState], set[scheduler_module.WorkerState]],
+    ]
 
     def __init__(
         self,
-        scheduler: Scheduler,
+        scheduler: scheduler_module.Scheduler,
         # The following parameters are exposed so that one may create, run, and throw
         # away on the fly a specialized manager, separate from the main one.
         policies: set[ActiveMemoryManagerPolicy] | None = None,
         *,
         measure: str | None = None,
         register: bool = True,
         start: bool | None = None,
@@ -178,15 +181,15 @@
         ts_stop = time()
         logger.debug("Active Memory Manager run in %.0fms", (ts_stop - ts_start) * 1000)
 
     def _run_policies(self) -> None:
         """Sequentially run ActiveMemoryManagerPolicy.run() for all registered policies,
         obtain replicate/drop suggestions, and use them to populate self.pending.
         """
-        ws: WorkerState | None
+        ws: scheduler_module.WorkerState | None
 
         for policy in list(self.policies):  # a policy may remove itself
             logger.debug("Running policy: %s", policy)
             policy_gen = policy.run()
             ws = None
             while True:
                 try:
@@ -224,18 +227,18 @@
                         )
 
                 else:
                     raise ValueError(f"Unknown op: {suggestion.op}")  # pragma: nocover
 
     def _find_recipient(
         self,
-        ts: TaskState,
-        candidates: set[WorkerState] | None,
-        pending_repl: set[WorkerState],
-    ) -> WorkerState | None:
+        ts: scheduler_module.TaskState,
+        candidates: set[scheduler_module.WorkerState] | None,
+        pending_repl: set[scheduler_module.WorkerState],
+    ) -> scheduler_module.WorkerState | None:
         """Choose a worker to acquire a new replica of an in-memory task among a set of
         candidates. If candidates is None, default to all workers in the cluster.
         Regardless, workers that either already hold a replica or are scheduled to
         receive one at the end of this AMM iteration are not considered.
 
         Returns
         -------
@@ -281,18 +284,18 @@
         task_logger.debug(
             "(replicate, %s, %s): replicating to %s", ts, orig_candidates, choice
         )
         return choice
 
     def _find_dropper(
         self,
-        ts: TaskState,
-        candidates: set[WorkerState] | None,
-        pending_drop: set[WorkerState],
-    ) -> WorkerState | None:
+        ts: scheduler_module.TaskState,
+        candidates: set[scheduler_module.WorkerState] | None,
+        pending_drop: set[scheduler_module.WorkerState],
+    ) -> scheduler_module.WorkerState | None:
         """Choose a worker to drop its replica of an in-memory task among a set of
         candidates. If candidates is None, default to all workers in the cluster.
         Regardless, workers that either do not hold a replica or are already scheduled
         to drop theirs at the end of this AMM iteration are not considered.
         This method also ensures that a key will not lose its last replica.
 
         Returns
@@ -381,16 +384,20 @@
     def _enact_suggestions(self) -> None:
         """Iterate through self.pending, which was filled by self._run_policies(), and
         push the suggestions to the workers through bulk comms. Return immediately.
         """
         logger.debug("Enacting suggestions for %d tasks:", len(self.pending))
 
         validate = self.scheduler.validate
-        drop_by_worker: (defaultdict[WorkerState, list[str]]) = defaultdict(list)
-        repl_by_worker: (defaultdict[WorkerState, list[str]]) = defaultdict(list)
+        drop_by_worker: (
+            defaultdict[scheduler_module.WorkerState, list[str]]
+        ) = defaultdict(list)
+        repl_by_worker: (
+            defaultdict[scheduler_module.WorkerState, list[str]]
+        ) = defaultdict(list)
 
         for ts, (pending_repl, pending_drop) in self.pending.items():
             if not ts.who_has:
                 continue
             if validate:
                 # Never drop the last replica
                 assert ts.who_has - pending_drop
@@ -415,24 +422,26 @@
             self.scheduler.request_remove_replicas(
                 ws.address, keys, stimulus_id=stimulus_id
             )
 
 
 class Suggestion(NamedTuple):
     op: Literal["replicate", "drop"]
-    ts: TaskState
-    candidates: set[WorkerState] | None = None
+    ts: scheduler_module.TaskState
+    candidates: set[scheduler_module.WorkerState] | None = None
 
 
 if TYPE_CHECKING:
     # TODO import from typing (requires Python >=3.10)
     from typing_extensions import TypeAlias
 
 # TODO remove quotes (requires Python >=3.9)
-SuggestionGenerator: TypeAlias = "Generator[Suggestion, WorkerState | None, None]"
+SuggestionGenerator: TypeAlias = (
+    "Generator[Suggestion, scheduler_module.WorkerState | None, None]"
+)
 
 
 class ActiveMemoryManagerPolicy(abc.ABC):
     """Abstract parent class"""
 
     __slots__ = ("manager",)
 
@@ -486,17 +495,17 @@
 
     Usage: ``client.amm.start()`` etc.
 
     All methods are asynchronous if the client is asynchronous and synchronous if the
     client is synchronous.
     """
 
-    _client: Client
+    _client: client.Client
 
-    def __init__(self, client: Client):
+    def __init__(self, client: client.Client):
         self._client = client
 
     def _run(self, method: str) -> Any:
         """Remotely invoke ActiveMemoryManagerExtension.amm_handler"""
         return self._client.sync(self._client.scheduler.amm_handler, method=method)
 
     def start(self) -> Any:
```

### Comparing `distributed-2023.3.2.1/distributed/actor.py` & `distributed-2023.4.0/distributed/actor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/batched.py` & `distributed-2023.4.0/distributed/batched.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/cfexecutor.py` & `distributed-2023.4.0/distributed/cfexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/chaos.py` & `distributed-2023.4.0/distributed/chaos.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/cli/dask_scheduler.py` & `distributed-2023.4.0/distributed/cli/dask_scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/cli/dask_spec.py` & `distributed-2023.4.0/distributed/cli/dask_spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/cli/dask_ssh.py` & `distributed-2023.4.0/distributed/cli/dask_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/cli/dask_worker.py` & `distributed-2023.4.0/distributed/cli/dask_worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/cli/utils.py` & `distributed-2023.4.0/distributed/cli/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/client.py` & `distributed-2023.4.0/distributed/client.py`

 * *Files 1% similar despite different names*

```diff
@@ -68,14 +68,15 @@
     PooledRPCCall,
     Status,
     clean_exception,
     connect,
     rpc,
 )
 from distributed.diagnostics.plugin import (
+    ForwardLoggingPlugin,
     NannyPlugin,
     UploadFile,
     WorkerPlugin,
     _get_plugin_name,
 )
 from distributed.metrics import time
 from distributed.objects import HasWhat, SchedulerInfo, WhoHas
@@ -120,14 +121,16 @@
 
 _current_client: ContextVar[Client | None] = ContextVar("_current_client", default=None)
 
 DEFAULT_EXTENSIONS = {
     "pubsub": PubSubClientExtension,
 }
 
+TOPIC_PREFIX_FORWARDED_LOG_RECORD = "forwarded-log-record"
+
 
 def _get_global_client() -> Client | None:
     c = _current_client.get()
     if c:
         return c
     L = sorted(list(_global_clients), reverse=True)
     for k in L:
@@ -1926,15 +1929,15 @@
             dsk = {skey: (func,) + tuple(args)}
 
         futures = self._graph_to_futures(
             dsk,
             [skey],
             workers=workers,
             allow_other_workers=allow_other_workers,
-            priority={skey: 0},
+            internal_priority={skey: 0},
             user_priority=priority,
             resources=resources,
             retries=retries,
             fifo_timeout=fifo_timeout,
             actors=actor,
         )
 
@@ -2130,15 +2133,15 @@
         internal_priority = dict(zip(keys, range(len(keys))))
 
         futures = self._graph_to_futures(
             dsk,
             keys,
             workers=workers,
             allow_other_workers=allow_other_workers,
-            priority=internal_priority,
+            internal_priority=internal_priority,
             resources=resources,
             retries=retries,
             user_priority=priority,
             fifo_timeout=fifo_timeout,
             actors=actor,
         )
         logger.debug("map(%s, ...)", funcname(func))
@@ -2970,25 +2973,29 @@
             wait=wait,
             nanny=nanny,
             on_error=on_error,
             **kwargs,
         )
 
     @staticmethod
-    def _get_computation_code(stacklevel: int | None = None) -> str:
+    def _get_computation_code(
+        stacklevel: int | None = None, nframes: int = 1
+    ) -> tuple[str, ...]:
         """Walk up the stack to the user code and extract the code surrounding
         the compute/submit/persist call. All modules encountered which are
         ignored through the option
         `distributed.diagnostics.computations.ignore-modules` will be ignored.
         This can be used to exclude commonly used libraries which wrap
         dask/distributed compute calls.
 
         ``stacklevel`` may be used to explicitly indicate from which frame on
         the stack to get the source code.
         """
+        if nframes <= 0:
+            return ()
         ignore_modules = dask.config.get(
             "distributed.diagnostics.computations.ignore-modules"
         )
         if not isinstance(ignore_modules, list):
             raise TypeError(
                 "Ignored modules must be a list. Instead got "
                 f"({type(ignore_modules)}, {ignore_modules})"
@@ -2999,47 +3006,51 @@
                 pattern = re.compile("|".join([f"(?:{mod})" for mod in ignore_modules]))
             else:
                 pattern = None
         else:
             # stacklevel 0 or less - shows dask internals which likely isn't helpful
             stacklevel = stacklevel if stacklevel > 0 else 1
 
+        code: list[str] = []
         for i, (fr, _) in enumerate(traceback.walk_stack(sys._getframe().f_back), 1):
+            if len(code) >= nframes:
+                break
             if stacklevel is not None:
                 if i != stacklevel:
                     continue
             elif pattern is not None and (
                 pattern.match(fr.f_globals.get("__name__", ""))
                 or fr.f_code.co_name in ("<listcomp>", "<dictcomp>")
             ):
                 continue
             try:
-                return inspect.getsource(fr)
+                code.append(inspect.getsource(fr))
             except OSError:
                 # Try to fine the source if we are in %%time or %%timeit magic.
                 if (
                     fr.f_code.co_filename in {"<timed exec>", "<magic-timeit>"}
                     and "IPython" in sys.modules
                 ):
                     from IPython import get_ipython
 
                     ip = get_ipython()
                     if ip is not None:
                         # The current cell
-                        return ip.history_manager._i00
+                        code.append(ip.history_manager._i00)
                 break
-        return "<Code not available>"
+
+        return tuple(reversed(code))
 
     def _graph_to_futures(
         self,
         dsk,
         keys,
         workers=None,
         allow_other_workers=None,
-        priority=None,
+        internal_priority=None,
         user_priority=0,
         resources=None,
         retries=None,
         fifo_timeout=0,
         actors=None,
     ):
         with self._refcount_lock:
@@ -3067,29 +3078,45 @@
                 annotations["resources"] = resources
 
             # Merge global and local annotations
             annotations = merge(dask.config.get("annotations", {}), annotations)
 
             # Pack the high level graph before sending it to the scheduler
             keyset = set(keys)
-            dsk = dsk.__dask_distributed_pack__(self, keyset, annotations)
 
             # Create futures before sending graph (helps avoid contention)
             futures = {key: Future(key, self, inform=False) for key in keyset}
-
+            # Circular import
+            from distributed.protocol import serialize
+            from distributed.protocol.serialize import ToPickle
+
+            header, frames = serialize(ToPickle(dsk), on_error="raise")
+            nbytes = len(header) + sum(map(len, frames))
+            if nbytes > 10_000_000:
+                warnings.warn(
+                    f"Sending large graph of size {format_bytes(nbytes)}.\n"
+                    "This may cause some slowdown.\n"
+                    "Consider scattering data ahead of time and using futures."
+                )
             self._send_to_scheduler(
                 {
-                    "op": "update-graph-hlg",
-                    "hlg": dsk,
+                    "op": "update-graph",
+                    "graph_header": header,
+                    "graph_frames": frames,
                     "keys": list(map(stringify, keys)),
-                    "priority": priority,
+                    "internal_priority": internal_priority,
                     "submitting_task": getattr(thread_state, "key", None),
                     "fifo_timeout": fifo_timeout,
                     "actors": actors,
-                    "code": self._get_computation_code(),
+                    "code": self._get_computation_code(
+                        nframes=dask.config.get(
+                            "distributed.diagnostics.computations.nframes"
+                        )
+                    ),
+                    "annotations": ToPickle(annotations),
                 }
             )
             return futures
 
     def get(
         self,
         dsk,
@@ -4916,14 +4943,154 @@
     @property
     def amm(self):
         """Convenience accessors for the :doc:`active_memory_manager`"""
         from distributed.active_memory_manager import AMMClientProxy
 
         return AMMClientProxy(self)
 
+    def _handle_forwarded_log_record(self, event):
+        _, record_attrs = event
+        record = logging.makeLogRecord(record_attrs)
+        dest_logger = logging.getLogger(record.name)
+        dest_logger.handle(record)
+
+    def forward_logging(self, logger_name=None, level=logging.NOTSET):
+        """
+        Begin forwarding the given logger (by default the root) and all loggers
+        under it from worker tasks to the client process. Whenever the named
+        logger handles a LogRecord on the worker-side, the record will be
+        serialized, sent to the client, and handled by the logger with the same
+        name on the client-side.
+
+        Note that worker-side loggers will only handle LogRecords if their level
+        is set appropriately, and the client-side logger will only emit the
+        forwarded LogRecord if its own level is likewise set appropriately. For
+        example, if your submitted task logs a DEBUG message to logger "foo",
+        then in order for ``forward_logging()`` to cause that message to be
+        emitted in your client session, you must ensure that the logger "foo"
+        have its level set to DEBUG (or lower) in the worker process *and* in the
+        client process.
+
+        Parameters
+        ----------
+        logger_name : str, optional
+            The name of the logger to begin forwarding. The usual rules of the
+            ``logging`` module's hierarchical naming system apply. For example,
+            if ``name`` is ``"foo"``, then not only ``"foo"``, but also
+            ``"foo.bar"``, ``"foo.baz"``, etc. will be forwarded. If ``name`` is
+            ``None``, this indicates the root logger, and so *all* loggers will
+            be forwarded.
+
+            Note that a logger will only forward a given LogRecord if the
+            logger's level is sufficient for the LogRecord to be handled at all.
+
+        level : str | int, optional
+            Optionally restrict forwarding to LogRecords of this level or
+            higher, even if the forwarded logger's own level is lower.
+
+        Examples
+        --------
+        For purposes of the examples, suppose we configure client-side logging
+        as a user might: with a single StreamHandler attached to the root logger
+        with an output level of INFO and a simple output format::
+
+            import logging
+            import distributed
+            import io, yaml
+
+            TYPICAL_LOGGING_CONFIG = '''
+            version: 1
+            handlers:
+              console:
+                class : logging.StreamHandler
+                formatter: default
+                level   : INFO
+            formatters:
+              default:
+                format: '%(asctime)s %(levelname)-8s [worker %(worker)s] %(name)-15s %(message)s'
+                datefmt: '%Y-%m-%d %H:%M:%S'
+            root:
+              handlers:
+                - console
+            '''
+            config = yaml.safe_load(io.StringIO(TYPICAL_LOGGING_CONFIG))
+            logging.config.dictConfig(config)
+
+        Now create a client and begin forwarding the root logger from workers
+        back to our local client process.
+
+        >>> client = distributed.Client()
+        >>> client.forward_logging()  # forward the root logger at any handled level
+
+        Then submit a task that does some error logging on a worker. We see
+        output from the client-side StreamHandler.
+
+        >>> def do_error():
+        ...     logging.getLogger("user.module").error("Hello error")
+        ...     return 42
+        >>> client.submit(do_error).result()
+        2022-11-09 03:43:25 ERROR    [worker tcp://127.0.0.1:34783] user.module     Hello error
+        42
+
+        Note how an attribute ``"worker"`` is also added by dask to the
+        forwarded LogRecord, which our custom formatter uses. This is useful for
+        identifying exactly which worker logged the error.
+
+        One nuance worth highlighting: even though our client-side root logger
+        is configured with a level of INFO, the worker-side root loggers still
+        have their default level of ERROR because we haven't done any explicit
+        logging configuration on the workers. Therefore worker-side INFO logs
+        will *not* be forwarded because they never even get handled in the first
+        place.
+
+        >>> def do_info_1():
+        ...     # no output on the client side
+        ...     logging.getLogger("user.module").info("Hello info the first time")
+        ...     return 84
+        >>> client.submit(do_info_1).result()
+        84
+
+        It is necessary to set the client-side logger's level to INFO before the info
+        message will be handled and forwarded to the client. In other words, the
+        "effective" level of the client-side forwarded logging is the maximum of each
+        logger's client-side and worker-side levels.
+
+        >>> def do_info_2():
+        ...     logger = logging.getLogger("user.module")
+        ...     logger.setLevel(logging.INFO)
+        ...     # now produces output on the client side
+        ...     logger.info("Hello info the second time")
+        ...     return 84
+        >>> client.submit(do_info_2).result()
+        2022-11-09 03:57:39 INFO     [worker tcp://127.0.0.1:42815] user.module     Hello info the second time
+        84
+        """
+
+        plugin_name = f"forward-logging-{logger_name or '<root>'}"
+        topic = f"{TOPIC_PREFIX_FORWARDED_LOG_RECORD}-{plugin_name}"
+        # note that subscription is idempotent
+        self.subscribe_topic(topic, self._handle_forwarded_log_record)
+        # note that any existing plugin with the same name will automatically be
+        # removed and torn down (see distributed.worker.Worker.plugin_add()), so
+        # this is effectively idempotent, i.e., forwarding the same logger twice
+        # won't cause every LogRecord to be forwarded twice
+        return self.register_worker_plugin(
+            ForwardLoggingPlugin(logger_name, level, topic), plugin_name
+        )
+
+    def unforward_logging(self, logger_name=None):
+        """
+        Stop forwarding the given logger (default root) from worker tasks to the
+        client process.
+        """
+        plugin_name = f"forward-logging-{logger_name or '<root>'}"
+        topic = f"{TOPIC_PREFIX_FORWARDED_LOG_RECORD}-{plugin_name}"
+        self.unsubscribe_topic(topic)
+        return self.unregister_worker_plugin(plugin_name)
+
 
 class _WorkerSetupPlugin(WorkerPlugin):
     """This is used to support older setup functions as callbacks"""
 
     def __init__(self, setup):
         self._setup = setup
 
@@ -5553,27 +5720,29 @@
             lambda dask_scheduler: dask_scheduler.monitor.count
         )
         await get_client().get_task_stream(start=0, stop=0)  # ensure plugin
 
     async def __aexit__(self, exc_type, exc_value, traceback, code=None):
         client = get_client()
         if code is None:
-            code = client._get_computation_code(self._stacklevel + 1)
+            frames = client._get_computation_code(self._stacklevel + 1, nframes=1)
+            code = frames[0] if frames else "<Code not available>"
         data = await client.scheduler.performance_report(
             start=self.start, last_count=self.last_count, code=code, mode=self.mode
         )
         with open(self.filename, "w") as f:
             f.write(data)
 
     def __enter__(self):
         get_client().sync(self.__aenter__)
 
     def __exit__(self, exc_type, exc_value, traceback):
         client = get_client()
-        code = client._get_computation_code(self._stacklevel + 1)
+        frames = client._get_computation_code(self._stacklevel + 1, nframes=1)
+        code = frames[0] if frames else "<Code not available>"
         client.sync(self.__aexit__, exc_type, exc_value, traceback, code=code)
 
 
 class get_task_metadata:
     """Collect task metadata within a context block
 
     This gathers ``TaskState`` metadata and final state from the scheduler
```

### Comparing `distributed-2023.3.2.1/distributed/cluster_dump.py` & `distributed-2023.4.0/distributed/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/collections.py` & `distributed-2023.4.0/distributed/collections.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/__init__.py` & `distributed-2023.4.0/distributed/comm/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/addressing.py` & `distributed-2023.4.0/distributed/comm/addressing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/asyncio_tcp.py` & `distributed-2023.4.0/distributed/comm/asyncio_tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/core.py` & `distributed-2023.4.0/distributed/comm/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/inproc.py` & `distributed-2023.4.0/distributed/comm/inproc.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/registry.py` & `distributed-2023.4.0/distributed/comm/registry.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/tcp.py` & `distributed-2023.4.0/distributed/comm/tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/ucx.py` & `distributed-2023.4.0/distributed/comm/ucx.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/utils.py` & `distributed-2023.4.0/distributed/comm/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/comm/ws.py` & `distributed-2023.4.0/distributed/comm/ws.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/compatibility.py` & `distributed-2023.4.0/distributed/compatibility.py`

 * *Files 5% similar despite different names*

```diff
@@ -38,25 +38,18 @@
         func_call = functools.partial(ctx.run, func, *args, **kwargs)
         return await loop.run_in_executor(None, func_call)
 
 
 if sys.version_info >= (3, 9):
     from random import randbytes
 else:
-    try:
-        import numpy
+    from random import getrandbits
 
-        def randbytes(size):
-            return numpy.random.randint(255, size=size, dtype="u8").tobytes()
-
-    except ImportError:
-        import secrets
-
-        def randbytes(size):
-            return secrets.token_bytes(size)
+    def randbytes(size):
+        return getrandbits(size * 8).to_bytes(size, "little")
 
 
 if tornado.version_info >= (6, 2, 0, 0):
     from tornado.ioloop import PeriodicCallback
 else:
     # Backport from https://github.com/tornadoweb/tornado/blob/a4f08a31a348445094d1efa17880ed5472db9f7d/tornado/ioloop.py#L838-L962
     # License https://github.com/tornadoweb/tornado/blob/v6.2.0/LICENSE
```

### Comparing `distributed-2023.3.2.1/distributed/config.py` & `distributed-2023.4.0/distributed/config.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/core.py` & `distributed-2023.4.0/distributed/core.py`

 * *Files 0% similar despite different names*

```diff
@@ -380,14 +380,15 @@
             self.digests = defaultdict(Digest)
         except ImportError:
             self.digests = None
 
         # In case crick is not installed, also log cumulative totals (reset at server
         # restart) and local maximums (reset by prometheus poll)
         self.digests_total = defaultdict(float)
+        self.digests_total_since_heartbeat = defaultdict(float)
         self.digests_max = defaultdict(float)
 
         self.counters = defaultdict(Counter)
         pc = PeriodicCallback(self._shift_counters, 5000)
         self.periodic_callbacks["shift_counters"] = pc
 
         pc = PeriodicCallback(
@@ -956,14 +957,16 @@
 
     def digest_metric(self, name: Hashable, value: float) -> None:
         # Granular data (requires crick)
         if self.digests is not None:
             self.digests[name].add(value)
         # Cumulative data (reset by server restart)
         self.digests_total[name] += value
+        # Cumulative data sent to scheduler and reset on heartbeat
+        self.digests_total_since_heartbeat[name] += value
         # Local maximums (reset by Prometheus poll)
         self.digests_max[name] = max(self.digests_max[name], value)
 
 
 def context_meter_to_server_digest(digest_tag: str) -> Callable:
     """Decorator for an async method of a Server subclass that calls
     ``distributed.metrics.context_meter.meter`` and/or ``digest_metric``.
```

### Comparing `distributed-2023.3.2.1/distributed/counter.py` & `distributed-2023.4.0/distributed/counter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/components/__init__.py` & `distributed-2023.4.0/distributed/dashboard/components/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/components/nvml.py` & `distributed-2023.4.0/distributed/dashboard/components/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/components/scheduler.py` & `distributed-2023.4.0/distributed/dashboard/components/scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/components/shared.py` & `distributed-2023.4.0/distributed/dashboard/components/shared.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/components/worker.py` & `distributed-2023.4.0/distributed/dashboard/components/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/core.py` & `distributed-2023.4.0/distributed/dashboard/core.py`

 * *Files 16% similar despite different names*

```diff
@@ -3,31 +3,28 @@
 import functools
 import warnings
 
 from bokeh.application import Application
 from bokeh.application.handlers.function import FunctionHandler
 from bokeh.server.server import BokehTornado
 from bokeh.server.util import create_hosts_allowlist
-from packaging.version import parse as parse_version
 
 import dask
 
 from distributed.dashboard.utils import BOKEH_VERSION
-from distributed.versions import MAX_BOKEH_VERSION, MIN_BOKEH_VERSION
+from distributed.versions import BOKEH_REQUIREMENT
 
-if BOKEH_VERSION < parse_version(MIN_BOKEH_VERSION) or BOKEH_VERSION > parse_version(
-    MAX_BOKEH_VERSION
-):
+if BOKEH_VERSION not in BOKEH_REQUIREMENT.specifier:
     warnings.warn(
-        f"\nDask needs bokeh >= {MIN_BOKEH_VERSION}, < 3 for the dashboard."
-        f"\nYou have bokeh=={BOKEH_VERSION}."
+        f"\nDask needs {BOKEH_REQUIREMENT} for the dashboard."
+        f"\nYou have bokeh={BOKEH_VERSION}."
         "\nContinuing without the dashboard."
     )
     raise ImportError(
-        f"Dask needs bokeh >= {MIN_BOKEH_VERSION}, < 3, not bokeh=={BOKEH_VERSION}"
+        f"Dask needs {BOKEH_REQUIREMENT} for the dashboard, not bokeh={BOKEH_VERSION}"
     )
 
 
 if BOKEH_VERSION.major < 3:
     from bokeh.models import Panel as TabPanel  # noqa: F401
 else:
     from bokeh.models import TabPanel  # noqa: F401
```

### Comparing `distributed-2023.3.2.1/distributed/dashboard/export_tool.js` & `distributed-2023.4.0/distributed/dashboard/export_tool.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/export_tool.py` & `distributed-2023.4.0/distributed/dashboard/export_tool.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/scheduler.py` & `distributed-2023.4.0/distributed/dashboard/scheduler.py`

 * *Files 3% similar despite different names*

```diff
@@ -7,14 +7,15 @@
 from tornado.ioloop import IOLoop
 
 from distributed.dashboard.components.nvml import (
     gpu_doc,
     gpu_memory_doc,
     gpu_utilization_doc,
 )
+from distributed.dashboard.components.rmm import rmm_memory_doc
 from distributed.dashboard.components.scheduler import (
     AggregateAction,
     BandwidthTypes,
     BandwidthWorkers,
     ClusterMemory,
     ComputePerKey,
     Contention,
@@ -111,14 +112,15 @@
     "/individual-aggregate-time-per-action": individual_doc(AggregateAction, 500),
     "/individual-scheduler-system": individual_doc(SystemMonitor, 500),
     "/individual-contention": individual_doc(Contention, 500),
     "/individual-profile": individual_profile_doc,
     "/individual-profile-server": individual_profile_server_doc,
     "/individual-gpu-memory": gpu_memory_doc,
     "/individual-gpu-utilization": gpu_utilization_doc,
+    "/individual-rmm-memory": rmm_memory_doc,
 }
 
 
 @memoize
 def template_variables(scheduler):
     from distributed.diagnostics.nvml import device_get_count
 
@@ -136,15 +138,16 @@
         ],
         "plots": [
             {
                 "url": x.strip("/"),
                 "name": " ".join(x.strip("/").split("-")[1:])
                 .title()
                 .replace("Cpu", "CPU")
-                .replace("Gpu", "GPU"),
+                .replace("Gpu", "GPU")
+                .replace("Rmm", "RMM"),
             }
             for x in applications
             if "individual" in x
         ]
         + [{"url": "hardware", "name": "Hardware"}],
         "jupyter": scheduler.jupyter,
     }
```

### Comparing `distributed-2023.3.2.1/distributed/dashboard/utils.py` & `distributed-2023.4.0/distributed/dashboard/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/dashboard/worker.py` & `distributed-2023.4.0/distributed/dashboard/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/deploy/adaptive.py` & `distributed-2023.4.0/distributed/deploy/adaptive.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/deploy/adaptive_core.py` & `distributed-2023.4.0/distributed/deploy/adaptive_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/deploy/cluster.py` & `distributed-2023.4.0/distributed/deploy/cluster.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/deploy/local.py` & `distributed-2023.4.0/distributed/deploy/local.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/deploy/old_ssh.py` & `distributed-2023.4.0/distributed/deploy/old_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/deploy/spec.py` & `distributed-2023.4.0/distributed/deploy/spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/deploy/ssh.py` & `distributed-2023.4.0/distributed/deploy/ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/deploy/subprocess.py` & `distributed-2023.4.0/distributed/deploy/subprocess.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,9 +1,10 @@
 from __future__ import annotations
 
+import abc
 import asyncio
 import copy
 import json
 import logging
 import math
 from typing import Any
 
@@ -11,94 +12,152 @@
 import toolz
 
 from dask.system import CPU_COUNT
 
 from distributed.compatibility import WINDOWS
 from distributed.deploy.spec import ProcessInterface, SpecCluster
 from distributed.deploy.utils import nprocesses_nthreads
-from distributed.scheduler import Scheduler
 from distributed.worker_memory import parse_memory_limit
 
 logger = logging.getLogger(__name__)
 
 
-class SubprocessWorker(ProcessInterface):
+class Subprocess(ProcessInterface, abc.ABC):
+    process: asyncio.subprocess.Process | None
+
+    def __init__(self):
+        if WINDOWS:
+            # FIXME: distributed#7434
+            raise RuntimeError("Subprocess does not support Windows.")
+        self.process = None
+        super().__init__()
+
+    async def start(self) -> None:
+        await self._start()
+        await super().start()
+
+    @abc.abstractmethod
+    async def _start(self) -> None:
+        """Start the subprocess"""
+
+    async def close(self) -> None:
+        if self.process and self.process.returncode is None:
+            for child in psutil.Process(self.process.pid).children(recursive=True):
+                child.kill()
+            self.process.kill()
+            await self.process.communicate()
+        self.process = None
+        await super().close()
+
+
+class SubprocessScheduler(Subprocess):
+    """A local Dask scheduler running in a dedicated subprocess
+
+    Parameters
+    ----------
+    scheduler_kwargs:
+        Keywords to pass on to the ``Scheduler`` class constructor
+    """
+
+    scheduler_kwargs: dict
+    address: str | None
+
+    def __init__(
+        self,
+        scheduler_kwargs: dict | None = None,
+    ):
+        self.scheduler_kwargs = scheduler_kwargs or {}
+        super().__init__()
+
+    async def _start(self):
+        cmd = [
+            "dask",
+            "spec",
+            "--spec",
+            json.dumps(
+                {"cls": "distributed.Scheduler", "opts": {**self.scheduler_kwargs}}
+            ),
+        ]
+        logger.info(" ".join(cmd))
+        self.process = await asyncio.create_subprocess_exec(
+            *cmd,
+            stderr=asyncio.subprocess.PIPE,
+        )
+
+        while True:
+            line = (await self.process.stderr.readline()).decode()
+            if not line.strip():
+                raise RuntimeError("Scheduler failed to start")
+            logger.info(line.strip())
+            if "Scheduler at" in line:
+                self.address = line.split("Scheduler at:")[1].strip()
+                break
+        logger.debug(line)
+
+
+class SubprocessWorker(Subprocess):
     """A local Dask worker running in a dedicated subprocess
 
     Parameters
     ----------
     scheduler:
         Address of the scheduler
     worker_class:
         Python class to use to create the worker, defaults to 'distributed.Nanny'
     name:
         Name of the worker
     worker_kwargs:
         Keywords to pass on to the ``Worker`` class constructor
     """
 
+    name: str | None
     scheduler: str
     worker_class: str
     worker_kwargs: dict
-    name: str | None
-    process: asyncio.subprocess.Process | None
 
     def __init__(
         self,
         scheduler: str,
         worker_class: str = "distributed.Nanny",
         name: str | None = None,
         worker_kwargs: dict | None = None,
     ) -> None:
-        if WINDOWS:
-            # FIXME: distributed#7434
-            raise RuntimeError("SubprocessWorker does not support Windows.")
+        self.name = name
         self.scheduler = scheduler
         self.worker_class = worker_class
-        self.name = name
         self.worker_kwargs = copy.copy(worker_kwargs or {})
-        self.process = None
         super().__init__()
 
-    async def start(self) -> None:
-        self.process = await asyncio.create_subprocess_exec(
+    async def _start(self) -> None:
+        cmd = [
             "dask",
             "spec",
             self.scheduler,
             "--spec",
-            json.dumps({0: {"cls": self.worker_class, "opts": {**self.worker_kwargs}}}),
-        )
-        await super().start()
-
-    async def close(self) -> None:
-        if self.process and self.process.returncode is None:
-            for child in psutil.Process(self.process.pid).children(recursive=True):
-                child.kill()
-            self.process.kill()
-            await self.process.wait()
-        self.process = None
-        await super().close()
+            json.dumps({"cls": self.worker_class, "opts": {**self.worker_kwargs}}),
+        ]
+        logger.info(" ".join(cmd))
+        self.process = await asyncio.create_subprocess_exec(*cmd)
 
 
 def SubprocessCluster(
     host: str | None = None,
     scheduler_port: int = 0,
     scheduler_kwargs: dict | None = None,
     dashboard_address: str = ":8787",
     worker_class: str = "distributed.Nanny",
     n_workers: int | None = None,
     threads_per_worker: int | None = None,
     worker_kwargs: dict | None = None,
     silence_logs: int = logging.WARN,
     **kwargs: Any,
 ) -> SpecCluster:
-    """Create in-process scheduler and workers running in dedicated subprocesses
+    """Create a scheduler and workers that run in dedicated subprocesses
 
-    This creates a "cluster" of a scheduler running in the current process and
-    workers running in dedicated subprocesses.
+    This creates a "cluster" of a scheduler and workers running in dedicated subprocesses.
 
     .. warning::
 
        This function is experimental
 
     Parameters
     ----------
@@ -174,15 +233,20 @@
             "host": host,
             "nthreads": threads_per_worker,
             "silence_logs": silence_logs,
         },
         worker_kwargs,
     )
 
-    scheduler = {"cls": Scheduler, "options": scheduler_kwargs}
+    scheduler = {
+        "cls": SubprocessScheduler,
+        "options": {
+            "scheduler_kwargs": scheduler_kwargs,
+        },
+    }
     worker = {
         "cls": SubprocessWorker,
         "options": {"worker_class": worker_class, "worker_kwargs": worker_kwargs},
     }
     workers = {i: worker for i in range(n_workers)}
     return SpecCluster(
         workers=workers,
```

### Comparing `distributed-2023.3.2.1/distributed/deploy/utils.py` & `distributed-2023.4.0/distributed/deploy/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/cluster_dump.py` & `distributed-2023.4.0/distributed/diagnostics/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/eventstream.py` & `distributed-2023.4.0/distributed/diagnostics/eventstream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/graph_layout.py` & `distributed-2023.4.0/distributed/diagnostics/graph_layout.py`

 * *Files 0% similar despite different names*

```diff
@@ -42,15 +42,15 @@
                 self.scheduler,
                 tasks=self.scheduler.tasks,
                 dependencies=dependencies,
                 priority=priority,
             )
 
     def update_graph(
-        self, scheduler, dependencies=None, priority=None, tasks=None, **kwargs
+        self, scheduler, *, dependencies=None, priority=None, tasks=None, **kwargs
     ):
         stack = sorted(tasks, key=lambda k: priority.get(k, 0), reverse=True)
         while stack:
             key = stack.pop()
             if key in self.x or key not in scheduler.tasks:
                 continue
             deps = dependencies.get(key, ())
```

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/memory_sampler.py` & `distributed-2023.4.0/distributed/diagnostics/memory_sampler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/nvml.py` & `distributed-2023.4.0/distributed/diagnostics/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/plugin.py` & `distributed-2023.4.0/distributed/diagnostics/plugin.py`

 * *Files 9% similar despite different names*

```diff
@@ -70,19 +70,53 @@
         This runs at the beginning of the Scheduler shutdown process, but after
         workers have been asked to shut down gracefully
         """
 
     def update_graph(
         self,
         scheduler: Scheduler,
+        *,
+        client: str,
         keys: set[str],
-        restrictions: dict[str, float],
+        tasks: list[str],
+        annotations: dict[str, dict[str, Any]],
+        priority: dict[str, tuple[int | float, ...]],
+        dependencies: dict[str, set],
         **kwargs: Any,
     ) -> None:
-        """Run when a new graph / tasks enter the scheduler"""
+        """Run when a new graph / tasks enter the scheduler
+
+        Parameters
+        ----------
+            scheduler:
+                The `Scheduler` instance.
+            client:
+                The unique Client id.
+            keys:
+                The keys the Client is interested in when calling `update_graph`.
+            tasks:
+                The
+            annotations:
+                Fully resolved annotations as applied to the tasks in the format::
+
+                    {
+                        "annotation": {
+                            "key": "value,
+                            ...
+                        },
+                        ...
+                    }
+            priority:
+                Task calculated priorities as assigned to the tasks.
+            dependencies:
+                A mapping that maps a key to its dependencies.
+            **kwargs:
+                It is recommended to allow plugins to accept more parameters to
+                ensure future compatibility.
+        """
 
     def restart(self, scheduler: Scheduler) -> None:
         """Run when the scheduler restarts itself"""
 
     def transition(
         self,
         key: str,
@@ -173,15 +207,16 @@
         """
         Run when the plugin is attached to a worker. This happens when the plugin is registered
         and attached to existing workers, or when a worker is created after the plugin has been
         registered.
         """
 
     def teardown(self, worker):
-        """Run when the worker to which the plugin is attached to is closed"""
+        """Run when the worker to which the plugin is attached is closed, or
+        when the plugin is removed."""
 
     def transition(self, key, start, finish, **kwargs):
         """
         Throughout the lifecycle of a task (see :doc:`Worker State
         <worker-state>`), Workers are instructed by the scheduler to compute
         certain tasks, resulting in transitions in the state of each task. The
         Worker owning the task is then notified of this state transition.
@@ -536,14 +571,95 @@
     async def setup(self, worker):
         response = await worker.upload_file(
             filename=self.filename, data=self.data, load=True
         )
         assert len(self.data) == response["nbytes"]
 
 
+class ForwardLoggingPlugin(WorkerPlugin):
+    """
+    A ``WorkerPlugin`` to forward python logging records from worker to client.
+    See :meth:`Client.forward_logging` for full documentation and usage. Needs
+    to be used in coordination with :meth:`Client.subscribe_topic`, the details
+    of which :meth:`Client.forward_logging` handles for you.
+
+    Parameters
+    ----------
+    logger_name : str
+        The name of the logger to begin forwarding.
+
+    level : str | int
+        Optionally restrict forwarding to ``LogRecord``s of this level or
+        higher, even if the forwarded logger's own level is lower.
+
+    topic : str
+        The name of the topic to which to the worker should log the forwarded log
+        records.
+    """
+
+    def __init__(self, logger_name, level, topic):
+        self.logger_name = logger_name
+        self.level = level
+        self.topic = topic
+        self.handler = None
+
+    def setup(self, worker):
+        self.handler = _ForwardingLogHandler(worker, self.topic, level=self.level)
+        logger = logging.getLogger(self.logger_name)
+        logger.addHandler(self.handler)
+
+    def teardown(self, worker):
+        if self.handler is not None:
+            logger = logging.getLogger(self.logger_name)
+            logger.removeHandler(self.handler)
+
+
+class _ForwardingLogHandler(logging.Handler):
+    """
+    Handler class that gets installed inside workers by
+    :class:`ForwardLoggingPlugin`. Not intended to be instantiated by the user
+    directly.
+
+    In each affected worker, ``ForwardLoggingPlugin`` adds an instance of this
+    handler to one or more loggers (possibly the root logger). Tasks running on
+    the worker may then use the affected logger as normal, with the side effect
+    that any ``LogRecord``s handled by the logger (or by a logger below it in
+    the hierarchy) will be published to the dask client as a
+    ``topic`` event.
+    """
+
+    def __init__(self, worker, topic, level=logging.NOTSET):
+        super().__init__(level)
+        self.worker = worker
+        self.topic = topic
+
+    def prepare_record_attributes(self, record):
+        # Adapted from the CPython standard library's
+        # logging.handlers.SocketHandler.makePickle; see its source at:
+        # https://github.com/python/cpython/blob/main/Lib/logging/handlers.py
+        ei = record.exc_info
+        if ei:
+            # just to get traceback text into record.exc_text ...
+            _ = self.format(record)
+        # If msg or args are objects, they may not be available on the receiving
+        # end. So we convert the msg % args to a string, save it as msg and zap
+        # the args.
+        d = dict(record.__dict__)
+        d["msg"] = record.getMessage()
+        d["args"] = None
+        d["exc_info"] = None
+        # delete 'message' if present: redundant with 'msg'
+        d.pop("message", None)
+        return d
+
+    def emit(self, record):
+        attributes = self.prepare_record_attributes(record)
+        self.worker.log_event(self.topic, attributes)
+
+
 class Environ(NannyPlugin):
     restart = True
 
     def __init__(self, environ: dict | None = None):
         environ = environ or {}
         self.environ = {k: str(v) for k, v in environ.items()}
```

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/progress.py` & `distributed-2023.4.0/distributed/diagnostics/progress.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/progress_stream.py` & `distributed-2023.4.0/distributed/diagnostics/progress_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/progressbar.py` & `distributed-2023.4.0/distributed/diagnostics/progressbar.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/task_stream.py` & `distributed-2023.4.0/distributed/diagnostics/task_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diagnostics/websocket.py` & `distributed-2023.4.0/distributed/diagnostics/websocket.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/diskutils.py` & `distributed-2023.4.0/distributed/diskutils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/distributed-schema.yaml` & `distributed-2023.4.0/distributed/distributed-schema.yaml`

 * *Files 0% similar despite different names*

```diff
@@ -1017,14 +1017,19 @@
             type: object
             properties:
               max-history:
                 type: integer
                 minimum: 0
                 description: |
                   The maximum number of Computations to remember.
+              nframes:
+                type: integer
+                minimum: 0
+                description: |
+                  The number of frames of code to capture, starting from the innermost frame.
               ignore-modules:
                 type: array
                 description: |
                   A list of modules which are ignored when trying to collect the
                   code context when submitting a computation. Accepts regular
                   expressions.
           erred-tasks:
```

### Comparing `distributed-2023.3.2.1/distributed/distributed.yaml` & `distributed-2023.4.0/distributed/distributed.yaml`

 * *Files 0% similar despite different names*

```diff
@@ -266,14 +266,15 @@
     websockets:
       shard: 8MiB
 
   diagnostics:
     nvml: True
     computations:
       max-history: 100
+      nframes: 0
       ignore-modules:
         - distributed
         - dask
         - xarray
         - cudf
         - cuml
         - prefect
```

### Comparing `distributed-2023.3.2.1/distributed/event.py` & `distributed-2023.4.0/distributed/event.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/prometheus.py` & `distributed-2023.4.0/distributed/http/prometheus.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/proxy.py` & `distributed-2023.4.0/distributed/http/proxy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/routing.py` & `distributed-2023.4.0/distributed/http/routing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/scheduler/api.py` & `distributed-2023.4.0/distributed/http/scheduler/api.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/scheduler/info.py` & `distributed-2023.4.0/distributed/http/scheduler/info.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/scheduler/json.py` & `distributed-2023.4.0/distributed/http/scheduler/json.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/scheduler/missing_bokeh.py` & `distributed-2023.4.0/distributed/http/scheduler/missing_bokeh.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,18 +1,18 @@
 from __future__ import annotations
 
 from distributed.http.utils import RequestHandler, redirect
 from distributed.utils import log_errors
-from distributed.versions import MIN_BOKEH_VERSION
+from distributed.versions import BOKEH_REQUIREMENT
 
 
 class MissingBokeh(RequestHandler):
     @log_errors
     def get(self):
         self.write(
-            f"<p>Dask needs bokeh >= {MIN_BOKEH_VERSION}, < 3 for the dashboard.</p>"
-            f"<p>Install with conda: <code>conda install bokeh>={MIN_BOKEH_VERSION},<3</code></p>"
-            f"<p>Install with pip: <code>pip install bokeh>={MIN_BOKEH_VERSION},<3</code></p>"
+            f"<p>Dask needs {BOKEH_REQUIREMENT} for the dashboard.</p>"
+            f"<p>Install with conda: <code>conda install {BOKEH_REQUIREMENT}</code></p>"
+            f"<p>Install with pip: <code>pip install {BOKEH_REQUIREMENT}</code></p>"
         )
 
 
 routes: list[tuple] = [(r"/", redirect("status"), {}), (r"status", MissingBokeh, {})]
```

### Comparing `distributed-2023.3.2.1/distributed/http/scheduler/prometheus/core.py` & `distributed-2023.4.0/distributed/http/scheduler/prometheus/core.py`

 * *Files 2% similar despite different names*

```diff
@@ -48,14 +48,21 @@
         )
         worker_states.add_metric(["saturated"], len(self.server.saturated))
         worker_states.add_metric(
             ["paused_or_retiring"], len(self.server.workers) - len(self.server.running)
         )
         yield worker_states
 
+        if self.server.monitor.monitor_gil_contention:
+            yield CounterMetricFamily(
+                self.build_name("gil_contention"),
+                "GIL contention metric",
+                value=self.server.monitor._cumulative_gil_contention,
+            )
+
         tasks = GaugeMetricFamily(
             self.build_name("tasks"),
             "Number of tasks known by scheduler",
             labels=["state"],
         )
 
         task_counter = toolz.merge_with(
```

### Comparing `distributed-2023.3.2.1/distributed/http/scheduler/prometheus/semaphore.py` & `distributed-2023.4.0/distributed/http/scheduler/prometheus/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/scheduler/prometheus/stealing.py` & `distributed-2023.4.0/distributed/http/scheduler/prometheus/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/css/base.css` & `distributed-2023.4.0/distributed/http/static/css/base.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/css/individual-cluster-map.css` & `distributed-2023.4.0/distributed/http/static/css/individual-cluster-map.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/css/status.css` & `distributed-2023.4.0/distributed/http/static/css/status.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/images/dask-logo.svg` & `distributed-2023.4.0/distributed/http/static/images/dask-logo.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/images/fa-bars.svg` & `distributed-2023.4.0/distributed/http/static/images/fa-bars.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/images/favicon.ico` & `distributed-2023.4.0/distributed/http/static/images/favicon.ico`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/images/jupyter.svg` & `distributed-2023.4.0/distributed/http/static/images/jupyter.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/images/numpy.png` & `distributed-2023.4.0/distributed/http/static/images/numpy.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/images/pandas.png` & `distributed-2023.4.0/distributed/http/static/images/pandas.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/images/python.png` & `distributed-2023.4.0/distributed/http/static/images/python.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/individual-cluster-map.html` & `distributed-2023.4.0/distributed/http/static/individual-cluster-map.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/js/anime.min.js` & `distributed-2023.4.0/distributed/http/static/js/anime.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/js/individual-cluster-map.js` & `distributed-2023.4.0/distributed/http/static/js/individual-cluster-map.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/static/js/reconnecting-websocket.min.js` & `distributed-2023.4.0/distributed/http/static/js/reconnecting-websocket.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/templates/base.html` & `distributed-2023.4.0/distributed/http/templates/base.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/templates/exceptions.html` & `distributed-2023.4.0/distributed/http/templates/exceptions.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/templates/status.html` & `distributed-2023.4.0/distributed/http/templates/status.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/templates/task.html` & `distributed-2023.4.0/distributed/http/templates/task.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/templates/worker-table.html` & `distributed-2023.4.0/distributed/http/templates/worker-table.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/templates/worker.html` & `distributed-2023.4.0/distributed/http/templates/worker.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/utils.py` & `distributed-2023.4.0/distributed/http/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/http/worker/prometheus/core.py` & `distributed-2023.4.0/distributed/http/worker/prometheus/core.py`

 * *Files 2% similar despite different names*

```diff
@@ -55,14 +55,21 @@
             (
                 "Deprecated: This metric has been renamed to transfer_incoming_count.\n"
                 "Number of open fetch requests to other workers"
             ),
             value=ws.transfer_incoming_count,
         )
 
+        if self.server.monitor.monitor_gil_contention:
+            yield CounterMetricFamily(
+                self.build_name("gil_contention"),
+                "GIL contention metric",
+                value=self.server.monitor._cumulative_gil_contention,
+            )
+
         yield GaugeMetricFamily(
             self.build_name("threads"),
             "Number of worker threads",
             value=ws.nthreads,
         )
 
         yield GaugeMetricFamily(
```

### Comparing `distributed-2023.3.2.1/distributed/lock.py` & `distributed-2023.4.0/distributed/lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/metrics.py` & `distributed-2023.4.0/distributed/metrics.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/multi_lock.py` & `distributed-2023.4.0/distributed/multi_lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/nanny.py` & `distributed-2023.4.0/distributed/nanny.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/node.py` & `distributed-2023.4.0/distributed/node.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/objects.py` & `distributed-2023.4.0/distributed/objects.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/preloading.py` & `distributed-2023.4.0/distributed/preloading.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/process.py` & `distributed-2023.4.0/distributed/process.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/proctitle.py` & `distributed-2023.4.0/distributed/proctitle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/profile.py` & `distributed-2023.4.0/distributed/profile.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/__init__.py` & `distributed-2023.4.0/distributed/protocol/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/arrow.py` & `distributed-2023.4.0/distributed/protocol/arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/compression.py` & `distributed-2023.4.0/distributed/protocol/compression.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/core.py` & `distributed-2023.4.0/distributed/protocol/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/cuda.py` & `distributed-2023.4.0/distributed/protocol/cuda.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/cupy.py` & `distributed-2023.4.0/distributed/protocol/cupy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/h5py.py` & `distributed-2023.4.0/distributed/protocol/h5py.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/keras.py` & `distributed-2023.4.0/distributed/protocol/keras.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/netcdf4.py` & `distributed-2023.4.0/distributed/protocol/netcdf4.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/numba.py` & `distributed-2023.4.0/distributed/protocol/numba.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/numpy.py` & `distributed-2023.4.0/distributed/protocol/numpy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/pickle.py` & `distributed-2023.4.0/distributed/protocol/pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/rmm.py` & `distributed-2023.4.0/distributed/protocol/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/scipy.py` & `distributed-2023.4.0/distributed/protocol/scipy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/serialize.py` & `distributed-2023.4.0/distributed/protocol/serialize.py`

 * *Files 1% similar despite different names*

```diff
@@ -338,38 +338,42 @@
             "type-serialized": type(x).__name__,
         }
         if any(compression is not None for compression in compressions):
             headers["compression"] = compressions
         return headers, frames
 
     tb = ""
+    exc = None
 
     for name in serializers:
         dumps, _, wants_context = families[name]
         try:
             header, frames = dumps(x, context=context) if wants_context else dumps(x)
             header["serializer"] = name
             return header, frames
         except NotImplementedError:
             continue
-        except Exception:
+        except Exception as e:
+            exc = e
             tb = traceback.format_exc()
             break
-
-    msg = f"Could not serialize object of type {type(x).__name__}"
+    type_x = type(x)
+    if isinstance(x, (ToPickle, Serialize)):
+        type_x = type(x.data)
+    msg = f"Could not serialize object of type {type_x.__name__}"
     if on_error == "message":
         txt_frames = [msg]
         if tb:
             txt_frames.append(tb[:100000])
 
         frames = [frame.encode() for frame in txt_frames]
 
         return {"serializer": "error"}, frames
     elif on_error == "raise":
-        raise TypeError(msg, str(x)[:10000])
+        raise TypeError(msg, str(x)[:10000]) from exc
     else:  # pragma: nocover
         raise ValueError(f"{on_error=}; expected 'message' or 'raise'")
 
 
 def deserialize(header, frames, deserializers=None):
     """
     Convert serialized header and list of bytestrings back to a Python object
```

### Comparing `distributed-2023.3.2.1/distributed/protocol/sparse.py` & `distributed-2023.4.0/distributed/protocol/sparse.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/torch.py` & `distributed-2023.4.0/distributed/protocol/torch.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/protocol/utils.py` & `distributed-2023.4.0/distributed/protocol/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/publish.py` & `distributed-2023.4.0/distributed/publish.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/pubsub.py` & `distributed-2023.4.0/distributed/pubsub.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/queues.py` & `distributed-2023.4.0/distributed/queues.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/recreate_tasks.py` & `distributed-2023.4.0/distributed/recreate_tasks.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/scheduler.py` & `distributed-2023.4.0/distributed/scheduler.py`

 * *Files 2% similar despite different names*

```diff
@@ -9,18374 +9,18809 @@
 00000080: 6f6f 6c73 0a69 6d70 6f72 7420 6a73 6f6e  ools.import json
 00000090: 0a69 6d70 6f72 7420 6c6f 6767 696e 670a  .import logging.
 000000a0: 696d 706f 7274 206d 6174 680a 696d 706f  import math.impo
 000000b0: 7274 206f 7065 7261 746f 720a 696d 706f  rt operator.impo
 000000c0: 7274 206f 730a 696d 706f 7274 2070 6963  rt os.import pic
 000000d0: 6b6c 650a 696d 706f 7274 2072 616e 646f  kle.import rando
 000000e0: 6d0a 696d 706f 7274 2073 7973 0a69 6d70  m.import sys.imp
-000000f0: 6f72 7420 7575 6964 0a69 6d70 6f72 7420  ort uuid.import 
-00000100: 7761 726e 696e 6773 0a69 6d70 6f72 7420  warnings.import 
-00000110: 7765 616b 7265 660a 6672 6f6d 2063 6f6c  weakref.from col
-00000120: 6c65 6374 696f 6e73 2069 6d70 6f72 7420  lections import 
-00000130: 6465 6661 756c 7464 6963 742c 2064 6571  defaultdict, deq
-00000140: 7565 0a66 726f 6d20 636f 6c6c 6563 7469  ue.from collecti
-00000150: 6f6e 732e 6162 6320 696d 706f 7274 2028  ons.abc import (
-00000160: 0a20 2020 2043 616c 6c61 626c 652c 0a20  .    Callable,. 
-00000170: 2020 2043 6f6c 6c65 6374 696f 6e2c 0a20     Collection,. 
-00000180: 2020 2043 6f6e 7461 696e 6572 2c0a 2020     Container,.  
-00000190: 2020 4861 7368 6162 6c65 2c0a 2020 2020    Hashable,.    
-000001a0: 4974 6572 6162 6c65 2c0a 2020 2020 4974  Iterable,.    It
-000001b0: 6572 6174 6f72 2c0a 2020 2020 4d61 7070  erator,.    Mapp
-000001c0: 696e 672c 0a20 2020 2053 6571 7565 6e63  ing,.    Sequenc
-000001d0: 652c 0a20 2020 2053 6574 2c0a 290a 6672  e,.    Set,.).fr
-000001e0: 6f6d 2063 6f6e 7465 7874 6c69 6220 696d  om contextlib im
-000001f0: 706f 7274 2073 7570 7072 6573 730a 6672  port suppress.fr
-00000200: 6f6d 2066 756e 6374 6f6f 6c73 2069 6d70  om functools imp
-00000210: 6f72 7420 7061 7274 6961 6c0a 6672 6f6d  ort partial.from
-00000220: 206e 756d 6265 7273 2069 6d70 6f72 7420   numbers import 
-00000230: 4e75 6d62 6572 0a66 726f 6d20 7479 7069  Number.from typi
-00000240: 6e67 2069 6d70 6f72 7420 5459 5045 5f43  ng import TYPE_C
-00000250: 4845 434b 494e 472c 2041 6e79 2c20 436c  HECKING, Any, Cl
-00000260: 6173 7356 6172 2c20 4c69 7465 7261 6c2c  assVar, Literal,
-00000270: 204e 616d 6564 5475 706c 652c 2063 6173   NamedTuple, cas
-00000280: 742c 206f 7665 726c 6f61 640a 0a69 6d70  t, overload..imp
-00000290: 6f72 7420 7073 7574 696c 0a66 726f 6d20  ort psutil.from 
-000002a0: 736f 7274 6564 636f 6e74 6169 6e65 7273  sortedcontainers
-000002b0: 2069 6d70 6f72 7420 536f 7274 6564 4469   import SortedDi
-000002c0: 6374 2c20 536f 7274 6564 5365 740a 6672  ct, SortedSet.fr
-000002d0: 6f6d 2074 6c7a 2069 6d70 6f72 7420 280a  om tlz import (.
-000002e0: 2020 2020 6669 7273 742c 0a20 2020 2067      first,.    g
-000002f0: 726f 7570 6279 2c0a 2020 2020 6d65 7267  roupby,.    merg
-00000300: 652c 0a20 2020 206d 6572 6765 5f73 6f72  e,.    merge_sor
-00000310: 7465 642c 0a20 2020 206d 6572 6765 5f77  ted,.    merge_w
-00000320: 6974 682c 0a20 2020 2070 6172 7469 7469  ith,.    partiti
-00000330: 6f6e 2c0a 2020 2020 706c 7563 6b2c 0a20  on,.    pluck,. 
-00000340: 2020 2073 6563 6f6e 642c 0a20 2020 2076     second,.    v
-00000350: 616c 6d61 702c 0a29 0a66 726f 6d20 746f  almap,.).from to
-00000360: 726e 6164 6f2e 696f 6c6f 6f70 2069 6d70  rnado.ioloop imp
-00000370: 6f72 7420 494f 4c6f 6f70 0a0a 696d 706f  ort IOLoop..impo
-00000380: 7274 2064 6173 6b0a 6672 6f6d 2064 6173  rt dask.from das
-00000390: 6b2e 6869 6768 6c65 7665 6c67 7261 7068  k.highlevelgraph
-000003a0: 2069 6d70 6f72 7420 4869 6768 4c65 7665   import HighLeve
-000003b0: 6c47 7261 7068 0a66 726f 6d20 6461 736b  lGraph.from dask
-000003c0: 2e75 7469 6c73 2069 6d70 6f72 7420 280a  .utils import (.
-000003d0: 2020 2020 666f 726d 6174 5f62 7974 6573      format_bytes
-000003e0: 2c0a 2020 2020 666f 726d 6174 5f74 696d  ,.    format_tim
-000003f0: 652c 0a20 2020 206b 6579 5f73 706c 6974  e,.    key_split
-00000400: 2c0a 2020 2020 7061 7273 655f 6279 7465  ,.    parse_byte
-00000410: 732c 0a20 2020 2070 6172 7365 5f74 696d  s,.    parse_tim
-00000420: 6564 656c 7461 2c0a 2020 2020 746d 7066  edelta,.    tmpf
-00000430: 696c 652c 0a29 0a66 726f 6d20 6461 736b  ile,.).from dask
-00000440: 2e77 6964 6765 7473 2069 6d70 6f72 7420  .widgets import 
-00000450: 6765 745f 7465 6d70 6c61 7465 0a0a 6672  get_template..fr
-00000460: 6f6d 2064 6973 7472 6962 7574 6564 2069  om distributed i
-00000470: 6d70 6f72 7420 636c 7573 7465 725f 6475  mport cluster_du
-00000480: 6d70 2c20 7072 656c 6f61 6469 6e67 2c20  mp, preloading, 
-00000490: 7072 6f66 696c 650a 6672 6f6d 2064 6973  profile.from dis
-000004a0: 7472 6962 7574 6564 2069 6d70 6f72 7420  tributed import 
-000004b0: 7665 7273 696f 6e73 2061 7320 7665 7273  versions as vers
-000004c0: 696f 6e5f 6d6f 6475 6c65 0a66 726f 6d20  ion_module.from 
-000004d0: 6469 7374 7269 6275 7465 642e 5f73 746f  distributed._sto
-000004e0: 7269 6573 2069 6d70 6f72 7420 7363 6865  ries import sche
-000004f0: 6475 6c65 725f 7374 6f72 790a 6672 6f6d  duler_story.from
-00000500: 2064 6973 7472 6962 7574 6564 2e61 6374   distributed.act
-00000510: 6976 655f 6d65 6d6f 7279 5f6d 616e 6167  ive_memory_manag
-00000520: 6572 2069 6d70 6f72 7420 4163 7469 7665  er import Active
-00000530: 4d65 6d6f 7279 4d61 6e61 6765 7245 7874  MemoryManagerExt
-00000540: 656e 7369 6f6e 2c20 5265 7469 7265 576f  ension, RetireWo
-00000550: 726b 6572 0a66 726f 6d20 6469 7374 7269  rker.from distri
-00000560: 6275 7465 642e 6261 7463 6865 6420 696d  buted.batched im
-00000570: 706f 7274 2042 6174 6368 6564 5365 6e64  port BatchedSend
-00000580: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-00000590: 642e 636f 6c6c 6563 7469 6f6e 7320 696d  d.collections im
-000005a0: 706f 7274 2048 6561 7053 6574 0a66 726f  port HeapSet.fro
-000005b0: 6d20 6469 7374 7269 6275 7465 642e 636f  m distributed.co
-000005c0: 6d6d 2069 6d70 6f72 7420 280a 2020 2020  mm import (.    
-000005d0: 436f 6d6d 2c0a 2020 2020 436f 6d6d 436c  Comm,.    CommCl
-000005e0: 6f73 6564 4572 726f 722c 0a20 2020 2067  osedError,.    g
-000005f0: 6574 5f61 6464 7265 7373 5f68 6f73 742c  et_address_host,
-00000600: 0a20 2020 206e 6f72 6d61 6c69 7a65 5f61  .    normalize_a
-00000610: 6464 7265 7373 2c0a 2020 2020 7265 736f  ddress,.    reso
-00000620: 6c76 655f 6164 6472 6573 732c 0a20 2020  lve_address,.   
-00000630: 2075 6e70 6172 7365 5f68 6f73 745f 706f   unparse_host_po
-00000640: 7274 2c0a 290a 6672 6f6d 2064 6973 7472  rt,.).from distr
-00000650: 6962 7574 6564 2e63 6f6d 6d2e 6164 6472  ibuted.comm.addr
-00000660: 6573 7369 6e67 2069 6d70 6f72 7420 6164  essing import ad
-00000670: 6472 6573 7365 735f 6672 6f6d 5f75 7365  dresses_from_use
-00000680: 725f 6172 6773 0a66 726f 6d20 6469 7374  r_args.from dist
-00000690: 7269 6275 7465 642e 636f 6d70 6174 6962  ributed.compatib
-000006a0: 696c 6974 7920 696d 706f 7274 2050 6572  ility import Per
-000006b0: 696f 6469 6343 616c 6c62 6163 6b0a 6672  iodicCallback.fr
-000006c0: 6f6d 2064 6973 7472 6962 7574 6564 2e63  om distributed.c
-000006d0: 6f72 6520 696d 706f 7274 2053 7461 7475  ore import Statu
-000006e0: 732c 2063 6c65 616e 5f65 7863 6570 7469  s, clean_excepti
-000006f0: 6f6e 2c20 7270 632c 2073 656e 645f 7265  on, rpc, send_re
-00000700: 6376 0a66 726f 6d20 6469 7374 7269 6275  cv.from distribu
-00000710: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
-00000720: 6d65 6d6f 7279 5f73 616d 706c 6572 2069  memory_sampler i
-00000730: 6d70 6f72 7420 4d65 6d6f 7279 5361 6d70  mport MemorySamp
-00000740: 6c65 7245 7874 656e 7369 6f6e 0a66 726f  lerExtension.fro
-00000750: 6d20 6469 7374 7269 6275 7465 642e 6469  m distributed.di
-00000760: 6167 6e6f 7374 6963 732e 706c 7567 696e  agnostics.plugin
-00000770: 2069 6d70 6f72 7420 5363 6865 6475 6c65   import Schedule
-00000780: 7250 6c75 6769 6e2c 205f 6765 745f 706c  rPlugin, _get_pl
-00000790: 7567 696e 5f6e 616d 650a 6672 6f6d 2064  ugin_name.from d
-000007a0: 6973 7472 6962 7574 6564 2e65 7665 6e74  istributed.event
-000007b0: 2069 6d70 6f72 7420 4576 656e 7445 7874   import EventExt
-000007c0: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
-000007d0: 7269 6275 7465 642e 6874 7470 2069 6d70  ributed.http imp
-000007e0: 6f72 7420 6765 745f 6861 6e64 6c65 7273  ort get_handlers
-000007f0: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-00000800: 642e 6c6f 636b 2069 6d70 6f72 7420 4c6f  d.lock import Lo
-00000810: 636b 4578 7465 6e73 696f 6e0a 6672 6f6d  ckExtension.from
-00000820: 2064 6973 7472 6962 7574 6564 2e6d 6574   distributed.met
-00000830: 7269 6373 2069 6d70 6f72 7420 6d6f 6e6f  rics import mono
-00000840: 746f 6e69 632c 2074 696d 650a 6672 6f6d  tonic, time.from
-00000850: 2064 6973 7472 6962 7574 6564 2e6d 756c   distributed.mul
-00000860: 7469 5f6c 6f63 6b20 696d 706f 7274 204d  ti_lock import M
-00000870: 756c 7469 4c6f 636b 4578 7465 6e73 696f  ultiLockExtensio
-00000880: 6e0a 6672 6f6d 2064 6973 7472 6962 7574  n.from distribut
-00000890: 6564 2e6e 6f64 6520 696d 706f 7274 2053  ed.node import S
-000008a0: 6572 7665 724e 6f64 650a 6672 6f6d 2064  erverNode.from d
-000008b0: 6973 7472 6962 7574 6564 2e70 726f 6374  istributed.proct
-000008c0: 6974 6c65 2069 6d70 6f72 7420 7365 7470  itle import setp
-000008d0: 726f 6374 6974 6c65 0a66 726f 6d20 6469  roctitle.from di
-000008e0: 7374 7269 6275 7465 642e 7072 6f74 6f63  stributed.protoc
-000008f0: 6f6c 2e70 6963 6b6c 6520 696d 706f 7274  ol.pickle import
-00000900: 2064 756d 7073 2c20 6c6f 6164 730a 6672   dumps, loads.fr
-00000910: 6f6d 2064 6973 7472 6962 7574 6564 2e70  om distributed.p
-00000920: 726f 746f 636f 6c2e 7365 7269 616c 697a  rotocol.serializ
-00000930: 6520 696d 706f 7274 2053 6572 6961 6c69  e import Seriali
-00000940: 7a65 642c 2073 6572 6961 6c69 7a65 0a66  zed, serialize.f
-00000950: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00000960: 7075 626c 6973 6820 696d 706f 7274 2050  publish import P
-00000970: 7562 6c69 7368 4578 7465 6e73 696f 6e0a  ublishExtension.
-00000980: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
-00000990: 2e70 7562 7375 6220 696d 706f 7274 2050  .pubsub import P
-000009a0: 7562 5375 6253 6368 6564 756c 6572 4578  ubSubSchedulerEx
-000009b0: 7465 6e73 696f 6e0a 6672 6f6d 2064 6973  tension.from dis
-000009c0: 7472 6962 7574 6564 2e71 7565 7565 7320  tributed.queues 
-000009d0: 696d 706f 7274 2051 7565 7565 4578 7465  import QueueExte
-000009e0: 6e73 696f 6e0a 6672 6f6d 2064 6973 7472  nsion.from distr
-000009f0: 6962 7574 6564 2e72 6563 7265 6174 655f  ibuted.recreate_
-00000a00: 7461 736b 7320 696d 706f 7274 2052 6570  tasks import Rep
-00000a10: 6c61 7954 6173 6b53 6368 6564 756c 6572  layTaskScheduler
-00000a20: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-00000a30: 642e 7365 6375 7269 7479 2069 6d70 6f72  d.security impor
-00000a40: 7420 5365 6375 7269 7479 0a66 726f 6d20  t Security.from 
-00000a50: 6469 7374 7269 6275 7465 642e 7365 6d61  distributed.sema
-00000a60: 7068 6f72 6520 696d 706f 7274 2053 656d  phore import Sem
-00000a70: 6170 686f 7265 4578 7465 6e73 696f 6e0a  aphoreExtension.
-00000a80: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
-00000a90: 2e73 6875 6666 6c65 2069 6d70 6f72 7420  .shuffle import 
-00000aa0: 5368 7566 666c 6553 6368 6564 756c 6572  ShuffleScheduler
-00000ab0: 4578 7465 6e73 696f 6e0a 6672 6f6d 2064  Extension.from d
-00000ac0: 6973 7472 6962 7574 6564 2e73 7465 616c  istributed.steal
-00000ad0: 696e 6720 696d 706f 7274 2057 6f72 6b53  ing import WorkS
-00000ae0: 7465 616c 696e 670a 6672 6f6d 2064 6973  tealing.from dis
-00000af0: 7472 6962 7574 6564 2e75 7469 6c73 2069  tributed.utils i
-00000b00: 6d70 6f72 7420 280a 2020 2020 416c 6c2c  mport (.    All,
-00000b10: 0a20 2020 2054 696d 656f 7574 4572 726f  .    TimeoutErro
-00000b20: 722c 0a20 2020 2065 6d70 7479 5f63 6f6e  r,.    empty_con
-00000b30: 7465 7874 2c0a 2020 2020 666f 726d 6174  text,.    format
-00000b40: 5f64 6173 6862 6f61 7264 5f6c 696e 6b2c  _dashboard_link,
-00000b50: 0a20 2020 2067 6574 5f66 696c 656e 6f5f  .    get_fileno_
-00000b60: 6c69 6d69 742c 0a20 2020 206b 6579 5f73  limit,.    key_s
-00000b70: 706c 6974 5f67 726f 7570 2c0a 2020 2020  plit_group,.    
-00000b80: 6c6f 675f 6572 726f 7273 2c0a 2020 2020  log_errors,.    
-00000b90: 6e6f 5f64 6566 6175 6c74 2c0a 2020 2020  no_default,.    
-00000ba0: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
-00000bb0: 742c 0a20 2020 2076 616c 6964 6174 655f  t,.    validate_
-00000bc0: 6b65 792c 0a20 2020 2077 6169 745f 666f  key,.    wait_fo
-00000bd0: 722c 0a29 0a66 726f 6d20 6469 7374 7269  r,.).from distri
-00000be0: 6275 7465 642e 7574 696c 735f 636f 6d6d  buted.utils_comm
-00000bf0: 2069 6d70 6f72 7420 280a 2020 2020 6761   import (.    ga
-00000c00: 7468 6572 5f66 726f 6d5f 776f 726b 6572  ther_from_worker
-00000c10: 732c 0a20 2020 2072 6574 7279 5f6f 7065  s,.    retry_ope
-00000c20: 7261 7469 6f6e 2c0a 2020 2020 7363 6174  ration,.    scat
-00000c30: 7465 725f 746f 5f77 6f72 6b65 7273 2c0a  ter_to_workers,.
-00000c40: 290a 6672 6f6d 2064 6973 7472 6962 7574  ).from distribut
-00000c50: 6564 2e75 7469 6c73 5f70 6572 6620 696d  ed.utils_perf im
-00000c60: 706f 7274 2064 6973 6162 6c65 5f67 635f  port disable_gc_
-00000c70: 6469 6167 6e6f 7369 732c 2065 6e61 626c  diagnosis, enabl
-00000c80: 655f 6763 5f64 6961 676e 6f73 6973 0a66  e_gc_diagnosis.f
-00000c90: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00000ca0: 7661 7269 6162 6c65 2069 6d70 6f72 7420  variable import 
-00000cb0: 5661 7269 6162 6c65 4578 7465 6e73 696f  VariableExtensio
-00000cc0: 6e0a 0a69 6620 5459 5045 5f43 4845 434b  n..if TYPE_CHECK
-00000cd0: 494e 473a 0a20 2020 2023 2054 4f44 4f20  ING:.    # TODO 
-00000ce0: 696d 706f 7274 2066 726f 6d20 7479 7069  import from typi
-00000cf0: 6e67 2028 7265 7175 6972 6573 2050 7974  ng (requires Pyt
-00000d00: 686f 6e20 3e3d 332e 3130 290a 2020 2020  hon >=3.10).    
-00000d10: 6672 6f6d 2074 7970 696e 675f 6578 7465  from typing_exte
-00000d20: 6e73 696f 6e73 2069 6d70 6f72 7420 5479  nsions import Ty
-00000d30: 7065 416c 6961 730a 0a23 204e 6f74 2074  peAlias..# Not t
-00000d40: 6f20 6265 2063 6f6e 6675 7365 6420 7769  o be confused wi
-00000d50: 7468 2064 6973 7472 6962 7574 6564 2e77  th distributed.w
-00000d60: 6f72 6b65 725f 7374 6174 655f 6d61 6368  orker_state_mach
-00000d70: 696e 652e 5461 736b 5374 6174 6553 7461  ine.TaskStateSta
-00000d80: 7465 0a54 6173 6b53 7461 7465 5374 6174  te.TaskStateStat
-00000d90: 653a 2054 7970 6541 6c69 6173 203d 204c  e: TypeAlias = L
-00000da0: 6974 6572 616c 5b0a 2020 2020 2272 656c  iteral[.    "rel
-00000db0: 6561 7365 6422 2c0a 2020 2020 2277 6169  eased",.    "wai
-00000dc0: 7469 6e67 222c 0a20 2020 2022 6e6f 2d77  ting",.    "no-w
-00000dd0: 6f72 6b65 7222 2c0a 2020 2020 2271 7565  orker",.    "que
-00000de0: 7565 6422 2c0a 2020 2020 2270 726f 6365  ued",.    "proce
-00000df0: 7373 696e 6722 2c0a 2020 2020 226d 656d  ssing",.    "mem
-00000e00: 6f72 7922 2c0a 2020 2020 2265 7272 6564  ory",.    "erred
-00000e10: 222c 0a20 2020 2022 666f 7267 6f74 7465  ",.    "forgotte
-00000e20: 6e22 2c0a 5d0a 0a41 4c4c 5f54 4153 4b5f  n",.]..ALL_TASK_
-00000e30: 5354 4154 4553 3a20 5365 745b 5461 736b  STATES: Set[Task
-00000e40: 5374 6174 6553 7461 7465 5d20 3d20 7365  StateState] = se
-00000e50: 7428 5461 736b 5374 6174 6553 7461 7465  t(TaskStateState
-00000e60: 2e5f 5f61 7267 735f 5f29 2020 2320 7479  .__args__)  # ty
-00000e70: 7065 3a20 6967 6e6f 7265 0a0a 2320 544f  pe: ignore..# TO
-00000e80: 444f 2072 656d 6f76 6520 7175 6f74 6573  DO remove quotes
-00000e90: 2028 7265 7175 6972 6573 2050 7974 686f   (requires Pytho
-00000ea0: 6e20 3e3d 332e 3929 0a23 207b 7461 736b  n >=3.9).# {task
-00000eb0: 206b 6579 202d 3e20 6669 6e69 7368 2073   key -> finish s
-00000ec0: 7461 7465 7d0a 2320 4e6f 7420 746f 2062  tate}.# Not to b
-00000ed0: 6520 636f 6e66 7573 6564 2077 6974 6820  e confused with 
-00000ee0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-00000ef0: 6572 5f73 7461 7465 5f6d 6163 6869 6e65  er_state_machine
-00000f00: 2e52 6563 730a 5265 6373 3a20 5479 7065  .Recs.Recs: Type
-00000f10: 416c 6961 7320 3d20 2264 6963 745b 7374  Alias = "dict[st
-00000f20: 722c 2054 6173 6b53 7461 7465 5374 6174  r, TaskStateStat
-00000f30: 655d 220a 2320 7b63 6c69 656e 7420 6f72  e]".# {client or
-00000f40: 2077 6f72 6b65 7220 6164 6472 6573 733a   worker address:
-00000f50: 205b 7b6f 703a 203c 6b65 793e 2c20 2e2e   [{op: <key>, ..
-00000f60: 2e7d 2c20 2e2e 2e5d 7d0a 4d73 6773 3a20  .}, ...]}.Msgs: 
-00000f70: 5479 7065 416c 6961 7320 3d20 2264 6963  TypeAlias = "dic
-00000f80: 745b 7374 722c 206c 6973 745b 6469 6374  t[str, list[dict
-00000f90: 5b73 7472 2c20 416e 795d 5d5d 220a 2320  [str, Any]]]".# 
-00000fa0: 2872 6563 6f6d 6d65 6e64 6174 696f 6e73  (recommendations
-00000fb0: 2c20 636c 6965 6e74 206d 6573 7361 6765  , client message
-00000fc0: 732c 2077 6f72 6b65 7220 6d65 7373 6167  s, worker messag
-00000fd0: 6573 290a 5265 6373 4d73 6773 3a20 5479  es).RecsMsgs: Ty
-00000fe0: 7065 416c 6961 7320 3d20 2274 7570 6c65  peAlias = "tuple
-00000ff0: 5b52 6563 732c 204d 7367 732c 204d 7367  [Recs, Msgs, Msg
-00001000: 735d 220a 0a6c 6f67 6765 7220 3d20 6c6f  s]"..logger = lo
-00001010: 6767 696e 672e 6765 744c 6f67 6765 7228  gging.getLogger(
-00001020: 5f5f 6e61 6d65 5f5f 290a 4c4f 475f 5044  __name__).LOG_PD
-00001030: 4220 3d20 6461 736b 2e63 6f6e 6669 672e  B = dask.config.
-00001040: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-00001050: 2e61 646d 696e 2e70 6462 2d6f 6e2d 6572  .admin.pdb-on-er
-00001060: 7222 290a 4445 4641 554c 545f 4441 5441  r").DEFAULT_DATA
-00001070: 5f53 495a 4520 3d20 7061 7273 655f 6279  _SIZE = parse_by
-00001080: 7465 7328 0a20 2020 2064 6173 6b2e 636f  tes(.    dask.co
-00001090: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-000010a0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-000010b0: 6465 6661 756c 742d 6461 7461 2d73 697a  default-data-siz
-000010c0: 6522 290a 290a 5354 494d 554c 5553 5f49  e").).STIMULUS_I
-000010d0: 445f 554e 5345 5420 3d20 223c 7374 696d  D_UNSET = "<stim
-000010e0: 756c 7573 5f69 6420 756e 7365 743e 220a  ulus_id unset>".
-000010f0: 0a44 4546 4155 4c54 5f45 5854 454e 5349  .DEFAULT_EXTENSI
-00001100: 4f4e 5320 3d20 7b0a 2020 2020 226c 6f63  ONS = {.    "loc
-00001110: 6b73 223a 204c 6f63 6b45 7874 656e 7369  ks": LockExtensi
-00001120: 6f6e 2c0a 2020 2020 226d 756c 7469 5f6c  on,.    "multi_l
-00001130: 6f63 6b73 223a 204d 756c 7469 4c6f 636b  ocks": MultiLock
-00001140: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
-00001150: 7075 626c 6973 6822 3a20 5075 626c 6973  publish": Publis
-00001160: 6845 7874 656e 7369 6f6e 2c0a 2020 2020  hExtension,.    
-00001170: 2272 6570 6c61 792d 7461 736b 7322 3a20  "replay-tasks": 
-00001180: 5265 706c 6179 5461 736b 5363 6865 6475  ReplayTaskSchedu
-00001190: 6c65 722c 0a20 2020 2022 7175 6575 6573  ler,.    "queues
-000011a0: 223a 2051 7565 7565 4578 7465 6e73 696f  ": QueueExtensio
-000011b0: 6e2c 0a20 2020 2022 7661 7269 6162 6c65  n,.    "variable
-000011c0: 7322 3a20 5661 7269 6162 6c65 4578 7465  s": VariableExte
-000011d0: 6e73 696f 6e2c 0a20 2020 2022 7075 6273  nsion,.    "pubs
-000011e0: 7562 223a 2050 7562 5375 6253 6368 6564  ub": PubSubSched
-000011f0: 756c 6572 4578 7465 6e73 696f 6e2c 0a20  ulerExtension,. 
-00001200: 2020 2022 7365 6d61 7068 6f72 6573 223a     "semaphores":
-00001210: 2053 656d 6170 686f 7265 4578 7465 6e73   SemaphoreExtens
-00001220: 696f 6e2c 0a20 2020 2022 6576 656e 7473  ion,.    "events
-00001230: 223a 2045 7665 6e74 4578 7465 6e73 696f  ": EventExtensio
-00001240: 6e2c 0a20 2020 2022 616d 6d22 3a20 4163  n,.    "amm": Ac
-00001250: 7469 7665 4d65 6d6f 7279 4d61 6e61 6765  tiveMemoryManage
-00001260: 7245 7874 656e 7369 6f6e 2c0a 2020 2020  rExtension,.    
-00001270: 226d 656d 6f72 795f 7361 6d70 6c65 7222  "memory_sampler"
-00001280: 3a20 4d65 6d6f 7279 5361 6d70 6c65 7245  : MemorySamplerE
-00001290: 7874 656e 7369 6f6e 2c0a 2020 2020 2273  xtension,.    "s
-000012a0: 6875 6666 6c65 223a 2053 6875 6666 6c65  huffle": Shuffle
-000012b0: 5363 6865 6475 6c65 7245 7874 656e 7369  SchedulerExtensi
-000012c0: 6f6e 2c0a 2020 2020 2273 7465 616c 696e  on,.    "stealin
-000012d0: 6722 3a20 576f 726b 5374 6561 6c69 6e67  g": WorkStealing
-000012e0: 2c0a 7d0a 0a0a 636c 6173 7320 436c 6965  ,.}...class Clie
-000012f0: 6e74 5374 6174 653a 0a20 2020 2022 2222  ntState:.    """
-00001300: 4120 7369 6d70 6c65 206f 626a 6563 7420  A simple object 
-00001310: 686f 6c64 696e 6720 696e 666f 726d 6174  holding informat
-00001320: 696f 6e20 6162 6f75 7420 6120 636c 6965  ion about a clie
-00001330: 6e74 2e22 2222 0a0a 2020 2020 233a 2041  nt."""..    #: A
-00001340: 2075 6e69 7175 6520 6964 656e 7469 6669   unique identifi
-00001350: 6572 2066 6f72 2074 6869 7320 636c 6965  er for this clie
-00001360: 6e74 2e20 5468 6973 2069 7320 6765 6e65  nt. This is gene
-00001370: 7261 6c6c 7920 616e 206f 7061 7175 650a  rally an opaque.
-00001380: 2020 2020 233a 2073 7472 696e 6720 6765      #: string ge
-00001390: 6e65 7261 7465 6420 6279 2074 6865 2063  nerated by the c
-000013a0: 6c69 656e 7420 6974 7365 6c66 2e0a 2020  lient itself..  
-000013b0: 2020 636c 6965 6e74 5f6b 6579 3a20 7374    client_key: st
-000013c0: 720a 0a20 2020 2023 3a20 4361 6368 6564  r..    #: Cached
-000013d0: 2068 6173 6820 6f66 203a 6174 7472 3a60   hash of :attr:`
-000013e0: 7e43 6c69 656e 7453 7461 7465 2e63 6c69  ~ClientState.cli
-000013f0: 656e 745f 6b65 7960 0a20 2020 205f 6861  ent_key`.    _ha
-00001400: 7368 3a20 696e 740a 0a20 2020 2023 3a20  sh: int..    #: 
-00001410: 4120 7365 7420 6f66 2074 6173 6b73 2074  A set of tasks t
-00001420: 6869 7320 636c 6965 6e74 2077 616e 7473  his client wants
-00001430: 2074 6f20 6265 206b 6570 7420 696e 206d   to be kept in m
-00001440: 656d 6f72 792c 2073 6f20 7468 6174 2069  emory, so that i
-00001450: 7420 6361 6e20 646f 776e 6c6f 6164 0a20  t can download. 
-00001460: 2020 2023 3a20 6974 7320 7265 7375 6c74     #: its result
-00001470: 2077 6865 6e20 6465 7369 7265 642e 2054   when desired. T
-00001480: 6869 7320 6973 2074 6865 2072 6576 6572  his is the rever
-00001490: 7365 206d 6170 7069 6e67 206f 660a 2020  se mapping of.  
-000014a0: 2020 233a 203a 636c 6173 733a 6054 6173    #: :class:`Tas
-000014b0: 6b53 7461 7465 2e77 686f 5f77 616e 7473  kState.who_wants
-000014c0: 602e 2054 6173 6b73 2061 7265 2074 7970  `. Tasks are typ
-000014d0: 6963 616c 6c79 2072 656d 6f76 6564 2066  ically removed f
-000014e0: 726f 6d20 7468 6973 2073 6574 2077 6865  rom this set whe
-000014f0: 6e20 7468 650a 2020 2020 233a 2063 6f72  n the.    #: cor
-00001500: 7265 7370 6f6e 6469 6e67 206f 626a 6563  responding objec
-00001510: 7420 696e 2074 6865 2063 6c69 656e 7427  t in the client'
-00001520: 7320 7370 6163 6520 2866 6f72 2065 7861  s space (for exa
-00001530: 6d70 6c65 2061 2060 6046 7574 7572 6560  mple a ``Future`
-00001540: 6020 6f72 2061 2044 6173 6b0a 2020 2020  ` or a Dask.    
-00001550: 233a 2063 6f6c 6c65 6374 696f 6e29 2067  #: collection) g
-00001560: 6574 7320 6761 7262 6167 652d 636f 6c6c  ets garbage-coll
-00001570: 6563 7465 642e 0a20 2020 2077 616e 7473  ected..    wants
-00001580: 5f77 6861 743a 2073 6574 5b54 6173 6b53  _what: set[TaskS
-00001590: 7461 7465 5d0a 0a20 2020 2023 3a20 5468  tate]..    #: Th
-000015a0: 6520 6c61 7374 2074 696d 6520 7765 2072  e last time we r
-000015b0: 6563 6569 7665 6420 6120 6865 6172 7462  eceived a heartb
-000015c0: 6561 7420 6672 6f6d 2074 6869 7320 636c  eat from this cl
-000015d0: 6965 6e74 2c20 696e 206c 6f63 616c 2073  ient, in local s
-000015e0: 6368 6564 756c 6572 2074 696d 652e 0a20  cheduler time.. 
-000015f0: 2020 206c 6173 745f 7365 656e 3a20 666c     last_seen: fl
-00001600: 6f61 740a 0a20 2020 2023 3a20 4f75 7470  oat..    #: Outp
-00001610: 7574 206f 6620 3a66 756e 633a 6064 6973  ut of :func:`dis
-00001620: 7472 6962 7574 6564 2e76 6572 7369 6f6e  tributed.version
-00001630: 732e 6765 745f 7665 7273 696f 6e73 6020  s.get_versions` 
-00001640: 6f6e 2074 6865 2063 6c69 656e 740a 2020  on the client.  
-00001650: 2020 7665 7273 696f 6e73 3a20 6469 6374    versions: dict
-00001660: 5b73 7472 2c20 416e 795d 0a0a 2020 2020  [str, Any]..    
-00001670: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
-00001680: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
-00001690: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
-000016a0: 6974 5f5f 2873 656c 662c 2063 6c69 656e  it__(self, clien
-000016b0: 743a 2073 7472 2c20 2a2c 2076 6572 7369  t: str, *, versi
-000016c0: 6f6e 733a 2064 6963 745b 7374 722c 2041  ons: dict[str, A
-000016d0: 6e79 5d20 7c20 4e6f 6e65 203d 204e 6f6e  ny] | None = Non
-000016e0: 6529 3a0a 2020 2020 2020 2020 7365 6c66  e):.        self
-000016f0: 2e63 6c69 656e 745f 6b65 7920 3d20 636c  .client_key = cl
-00001700: 6965 6e74 0a20 2020 2020 2020 2073 656c  ient.        sel
-00001710: 662e 5f68 6173 6820 3d20 6861 7368 2863  f._hash = hash(c
-00001720: 6c69 656e 7429 0a20 2020 2020 2020 2073  lient).        s
-00001730: 656c 662e 7761 6e74 735f 7768 6174 203d  elf.wants_what =
-00001740: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
-00001750: 656c 662e 6c61 7374 5f73 6565 6e20 3d20  elf.last_seen = 
-00001760: 7469 6d65 2829 0a20 2020 2020 2020 2073  time().        s
-00001770: 656c 662e 7665 7273 696f 6e73 203d 2076  elf.versions = v
-00001780: 6572 7369 6f6e 7320 6f72 207b 7d0a 0a20  ersions or {}.. 
-00001790: 2020 2064 6566 205f 5f68 6173 685f 5f28     def __hash__(
-000017a0: 7365 6c66 2920 2d3e 2069 6e74 3a0a 2020  self) -> int:.  
-000017b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000017c0: 662e 5f68 6173 680a 0a20 2020 2064 6566  f._hash..    def
-000017d0: 205f 5f65 715f 5f28 7365 6c66 2c20 6f74   __eq__(self, ot
-000017e0: 6865 723a 206f 626a 6563 7429 202d 3e20  her: object) -> 
-000017f0: 626f 6f6c 3a0a 2020 2020 2020 2020 6966  bool:.        if
-00001800: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-00001810: 6f74 6865 722c 2043 6c69 656e 7453 7461  other, ClientSta
-00001820: 7465 293a 0a20 2020 2020 2020 2020 2020  te):.           
-00001830: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
-00001840: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00001850: 662e 636c 6965 6e74 5f6b 6579 203d 3d20  f.client_key == 
-00001860: 6f74 6865 722e 636c 6965 6e74 5f6b 6579  other.client_key
-00001870: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-00001880: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-00001890: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000018a0: 6622 3c43 6c69 656e 7420 7b73 656c 662e  f"<Client {self.
-000018b0: 636c 6965 6e74 5f6b 6579 2172 7d3e 220a  client_key!r}>".
-000018c0: 0a20 2020 2064 6566 205f 5f73 7472 5f5f  .    def __str__
-000018d0: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-000018e0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000018f0: 6c66 2e63 6c69 656e 745f 6b65 790a 0a20  lf.client_key.. 
-00001900: 2020 2064 6566 205f 746f 5f64 6963 745f     def _to_dict_
-00001910: 6e6f 5f6e 6573 7428 7365 6c66 2c20 2a2c  no_nest(self, *,
-00001920: 2065 7863 6c75 6465 3a20 436f 6e74 6169   exclude: Contai
-00001930: 6e65 725b 7374 725d 203d 2028 2929 202d  ner[str] = ()) -
-00001940: 3e20 6469 6374 3a0a 2020 2020 2020 2020  > dict:.        
-00001950: 2222 2244 6963 7469 6f6e 6172 7920 7265  """Dictionary re
-00001960: 7072 6573 656e 7461 7469 6f6e 2066 6f72  presentation for
-00001970: 2064 6562 7567 6769 6e67 2070 7572 706f   debugging purpo
-00001980: 7365 732e 0a20 2020 2020 2020 204e 6f74  ses..        Not
-00001990: 2074 7970 6520 7374 6162 6c65 2061 6e64   type stable and
-000019a0: 206e 6f74 2069 6e74 656e 6465 6420 666f   not intended fo
-000019b0: 7220 726f 756e 6474 7269 7073 2e0a 0a20  r roundtrips... 
-000019c0: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
-000019d0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-000019e0: 0a20 2020 2020 2020 2043 6c69 656e 742e  .        Client.
-000019f0: 6475 6d70 5f63 6c75 7374 6572 5f73 7461  dump_cluster_sta
-00001a00: 7465 0a20 2020 2020 2020 2064 6973 7472  te.        distr
-00001a10: 6962 7574 6564 2e75 7469 6c73 2e72 6563  ibuted.utils.rec
-00001a20: 7572 7369 7665 5f74 6f5f 6469 6374 0a20  ursive_to_dict. 
-00001a30: 2020 2020 2020 2054 6173 6b53 7461 7465         TaskState
-00001a40: 2e5f 746f 5f64 6963 740a 2020 2020 2020  ._to_dict.      
-00001a50: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-00001a60: 7475 726e 2072 6563 7572 7369 7665 5f74  turn recursive_t
-00001a70: 6f5f 6469 6374 280a 2020 2020 2020 2020  o_dict(.        
-00001a80: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00001a90: 2020 2020 2020 6578 636c 7564 653d 7365        exclude=se
-00001aa0: 7428 6578 636c 7564 6529 207c 207b 2276  t(exclude) | {"v
-00001ab0: 6572 7369 6f6e 7322 7d2c 2020 2320 7479  ersions"},  # ty
-00001ac0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-00001ad0: 2020 2020 2020 206d 656d 6265 7273 3d54         members=T
-00001ae0: 7275 652c 0a20 2020 2020 2020 2029 0a0a  rue,.        )..
-00001af0: 0a63 6c61 7373 204d 656d 6f72 7953 7461  .class MemorySta
-00001b00: 7465 3a0a 2020 2020 2222 224d 656d 6f72  te:.    """Memor
-00001b10: 7920 7265 6164 696e 6773 206f 6e20 6120  y readings on a 
-00001b20: 776f 726b 6572 206f 7220 6f6e 2074 6865  worker or on the
-00001b30: 2077 686f 6c65 2063 6c75 7374 6572 2e0a   whole cluster..
-00001b40: 0a20 2020 2053 6565 203a 646f 633a 6077  .    See :doc:`w
-00001b50: 6f72 6b65 722d 6d65 6d6f 7279 602e 0a0a  orker-memory`...
-00001b60: 2020 2020 4174 7472 6962 7574 6573 202f      Attributes /
-00001b70: 2070 726f 7065 7274 6965 733a 0a0a 2020   properties:..  
-00001b80: 2020 6d61 6e61 6765 645f 746f 7461 6c0a    managed_total.
-00001b90: 2020 2020 2020 2020 5375 6d20 6f66 2074          Sum of t
-00001ba0: 6865 206f 7574 7075 7420 6f66 2073 697a  he output of siz
-00001bb0: 656f 6628 2920 666f 7220 616c 6c20 6461  eof() for all da
-00001bc0: 736b 206b 6579 7320 6865 6c64 2062 7920  sk keys held by 
-00001bd0: 7468 6520 776f 726b 6572 2069 6e20 6d65  the worker in me
-00001be0: 6d6f 7279 2c0a 2020 2020 2020 2020 706c  mory,.        pl
-00001bf0: 7573 206e 756d 6265 7220 6f66 2062 7974  us number of byt
-00001c00: 6573 2073 7069 6c6c 6564 2074 6f20 6469  es spilled to di
-00001c10: 736b 0a0a 2020 2020 6d61 6e61 6765 640a  sk..    managed.
-00001c20: 2020 2020 2020 2020 5375 6d20 6f66 2074          Sum of t
-00001c30: 6865 206f 7574 7075 7420 6f66 2073 697a  he output of siz
-00001c40: 656f 6628 2920 666f 7220 7468 6520 6461  eof() for the da
-00001c50: 736b 206b 6579 7320 6865 6c64 2069 6e20  sk keys held in 
-00001c60: 5241 4d2e 204e 6f74 6520 7468 6174 2074  RAM. Note that t
-00001c70: 6869 7320 6d61 790a 2020 2020 2020 2020  his may.        
-00001c80: 6265 2069 6e61 6363 7572 6174 652c 2077  be inaccurate, w
-00001c90: 6869 6368 206d 6179 2063 6175 7365 2069  hich may cause i
-00001ca0: 6e61 6363 7572 6174 6520 756e 6d61 6e61  naccurate unmana
-00001cb0: 6765 6420 6d65 6d6f 7279 2028 7365 6520  ged memory (see 
-00001cc0: 6265 6c6f 7729 2e0a 0a20 2020 2073 7069  below)...    spi
-00001cd0: 6c6c 6564 0a20 2020 2020 2020 204e 756d  lled.        Num
-00001ce0: 6265 7220 6f66 2062 7974 6573 2020 666f  ber of bytes  fo
-00001cf0: 7220 7468 6520 6461 736b 206b 6579 7320  r the dask keys 
-00001d00: 7370 696c 6c65 6420 746f 2074 6865 2068  spilled to the h
-00001d10: 6172 6420 6472 6976 652e 0a20 2020 2020  ard drive..     
-00001d20: 2020 204e 6f74 6520 7468 6174 2074 6869     Note that thi
-00001d30: 7320 6973 2074 6865 2073 697a 6520 6f6e  s is the size on
-00001d40: 2064 6973 6b3b 2073 697a 6520 696e 206d   disk; size in m
-00001d50: 656d 6f72 7920 6d61 7920 6265 2064 6966  emory may be dif
-00001d60: 6665 7265 6e74 2064 7565 2074 6f0a 2020  ferent due to.  
-00001d70: 2020 2020 2020 636f 6d70 7265 7373 696f        compressio
-00001d80: 6e20 616e 6420 696e 6163 6375 7261 6369  n and inaccuraci
-00001d90: 6573 2069 6e20 7369 7a65 6f66 2829 2e20  es in sizeof(). 
-00001da0: 496e 206f 7468 6572 2077 6f72 6473 2c20  In other words, 
-00001db0: 6769 7665 6e20 7468 6520 7361 6d65 206b  given the same k
-00001dc0: 6579 732c 0a20 2020 2020 2020 2027 6d61  eys,.        'ma
-00001dd0: 6e61 6765 6427 2077 696c 6c20 6368 616e  naged' will chan
-00001de0: 6765 2064 6570 656e 6469 6e67 206f 6e20  ge depending on 
-00001df0: 7468 6520 6b65 7973 2062 6569 6e67 2069  the keys being i
-00001e00: 6e20 6d65 6d6f 7279 206f 7220 7370 696c  n memory or spil
-00001e10: 6c65 642e 0a0a 2020 2020 7072 6f63 6573  led...    proces
-00001e20: 730a 2020 2020 2020 2020 546f 7461 6c20  s.        Total 
-00001e30: 5253 5320 6d65 6d6f 7279 206d 6561 7375  RSS memory measu
-00001e40: 7265 6420 6279 2074 6865 204f 5320 6f6e  red by the OS on
-00001e50: 2074 6865 2077 6f72 6b65 7220 7072 6f63   the worker proc
-00001e60: 6573 732e 0a20 2020 2020 2020 2054 6869  ess..        Thi
-00001e70: 7320 6973 2061 6c77 6179 7320 6578 6163  s is always exac
-00001e80: 746c 7920 6571 7561 6c20 746f 206d 616e  tly equal to man
-00001e90: 6167 6564 202b 2075 6e6d 616e 6167 6564  aged + unmanaged
-00001ea0: 2e0a 0a20 2020 2075 6e6d 616e 6167 6564  ...    unmanaged
-00001eb0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-00001ec0: 202d 206d 616e 6167 6564 2e20 5468 6973   - managed. This
-00001ed0: 2069 7320 7468 6520 7375 6d20 6f66 0a0a   is the sum of..
-00001ee0: 2020 2020 2020 2020 2d20 5079 7468 6f6e          - Python
-00001ef0: 2069 6e74 6572 7072 6574 6572 2061 6e64   interpreter and
-00001f00: 206d 6f64 756c 6573 0a20 2020 2020 2020   modules.       
-00001f10: 202d 2067 6c6f 6261 6c20 7661 7269 6162   - global variab
-00001f20: 6c65 730a 2020 2020 2020 2020 2d20 6d65  les.        - me
-00001f30: 6d6f 7279 2074 656d 706f 7261 7269 6c79  mory temporarily
-00001f40: 2061 6c6c 6f63 6174 6564 2062 7920 7468   allocated by th
-00001f50: 6520 6461 736b 2074 6173 6b73 2074 6861  e dask tasks tha
-00001f60: 7420 6172 6520 6375 7272 656e 746c 7920  t are currently 
-00001f70: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-00001f80: 2d20 6d65 6d6f 7279 2066 7261 676d 656e  - memory fragmen
-00001f90: 7461 7469 6f6e 0a20 2020 2020 2020 202d  tation.        -
-00001fa0: 206d 656d 6f72 7920 6c65 616b 730a 2020   memory leaks.  
-00001fb0: 2020 2020 2020 2d20 6d65 6d6f 7279 206e        - memory n
-00001fc0: 6f74 2079 6574 2067 6172 6261 6765 2063  ot yet garbage c
-00001fd0: 6f6c 6c65 6374 6564 0a20 2020 2020 2020  ollected.       
-00001fe0: 202d 206d 656d 6f72 7920 6e6f 7420 7965   - memory not ye
-00001ff0: 7420 6672 6565 2829 2764 2062 7920 7468  t free()'d by th
-00002000: 6520 5079 7468 6f6e 206d 656d 6f72 7920  e Python memory 
-00002010: 6d61 6e61 6765 7220 746f 2074 6865 204f  manager to the O
-00002020: 530a 0a20 2020 2075 6e6d 616e 6167 6564  S..    unmanaged
-00002030: 5f6f 6c64 0a20 2020 2020 2020 204d 696e  _old.        Min
-00002040: 696d 756d 206f 6620 7468 6520 2775 6e6d  imum of the 'unm
-00002050: 616e 6167 6564 2720 6d65 6173 7572 6573  anaged' measures
-00002060: 206f 7665 7220 7468 6520 6c61 7374 0a20   over the last. 
-00002070: 2020 2020 2020 2060 6064 6973 7472 6962         ``distrib
-00002080: 7574 6564 2e6d 656d 6f72 792e 7265 6365  uted.memory.rece
-00002090: 6e74 2d74 6f2d 6f6c 642d 7469 6d65 6060  nt-to-old-time``
-000020a0: 2073 6563 6f6e 6473 0a0a 2020 2020 756e   seconds..    un
-000020b0: 6d61 6e61 6765 645f 7265 6365 6e74 0a20  managed_recent. 
-000020c0: 2020 2020 2020 2075 6e6d 616e 6167 6564         unmanaged
-000020d0: 202d 2075 6e6d 616e 6167 6564 5f6f 6c64   - unmanaged_old
-000020e0: 3b20 696e 206f 7468 6572 2077 6f72 6473  ; in other words
-000020f0: 2070 726f 6365 7373 206d 656d 6f72 7920   process memory 
-00002100: 7468 6174 2068 6173 2062 6565 6e20 7265  that has been re
-00002110: 6365 6e74 6c79 0a20 2020 2020 2020 2061  cently.        a
-00002120: 6c6c 6f63 6174 6564 2062 7574 2069 7320  llocated but is 
-00002130: 6e6f 7420 6163 636f 756e 7465 6420 666f  not accounted fo
-00002140: 7220 6279 2064 6173 6b3b 2068 6f70 6566  r by dask; hopef
-00002150: 756c 6c79 2069 7427 7320 6d6f 7374 6c79  ully it's mostly
-00002160: 2061 2074 656d 706f 7261 7279 0a20 2020   a temporary.   
-00002170: 2020 2020 2073 7069 6b65 2e0a 0a20 2020       spike...   
-00002180: 206f 7074 696d 6973 7469 630a 2020 2020   optimistic.    
-00002190: 2020 2020 6d61 6e61 6765 6420 2b20 756e      managed + un
-000021a0: 6d61 6e61 6765 645f 6f6c 643b 2069 6e20  managed_old; in 
-000021b0: 6f74 6865 7220 776f 7264 7320 7468 6520  other words the 
-000021c0: 6d65 6d6f 7279 2068 656c 6420 6c6f 6e67  memory held long
-000021d0: 2d74 6572 6d20 6279 0a20 2020 2020 2020  -term by.       
-000021e0: 2074 6865 2070 726f 6365 7373 2075 6e64   the process und
-000021f0: 6572 2074 6865 2068 6f70 6566 756c 2061  er the hopeful a
-00002200: 7373 756d 7074 696f 6e20 7468 6174 2061  ssumption that a
-00002210: 6c6c 2075 6e6d 616e 6167 6564 5f72 6563  ll unmanaged_rec
-00002220: 656e 7420 6d65 6d6f 7279 2069 7320 610a  ent memory is a.
-00002230: 2020 2020 2020 2020 7465 6d70 6f72 6172          temporar
-00002240: 7920 7370 696b 650a 2020 2020 2222 220a  y spike.    """.
-00002250: 0a20 2020 2070 726f 6365 7373 3a20 696e  .    process: in
-00002260: 740a 2020 2020 756e 6d61 6e61 6765 645f  t.    unmanaged_
-00002270: 6f6c 643a 2069 6e74 0a20 2020 206d 616e  old: int.    man
-00002280: 6167 6564 3a20 696e 740a 2020 2020 7370  aged: int.    sp
-00002290: 696c 6c65 643a 2069 6e74 0a0a 2020 2020  illed: int..    
-000022a0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
-000022b0: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
-000022c0: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
-000022d0: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
-000022e0: 6c66 2c0a 2020 2020 2020 2020 2a2c 0a20  lf,.        *,. 
-000022f0: 2020 2020 2020 2070 726f 6365 7373 3a20         process: 
-00002300: 696e 742c 0a20 2020 2020 2020 2075 6e6d  int,.        unm
-00002310: 616e 6167 6564 5f6f 6c64 3a20 696e 742c  anaged_old: int,
-00002320: 0a20 2020 2020 2020 206d 616e 6167 6564  .        managed
-00002330: 3a20 696e 742c 0a20 2020 2020 2020 2073  : int,.        s
-00002340: 7069 6c6c 6564 3a20 696e 742c 0a20 2020  pilled: int,.   
-00002350: 2029 3a0a 2020 2020 2020 2020 2320 536f   ):.        # So
-00002360: 6d65 2064 6174 6120 6172 7269 7665 7320  me data arrives 
-00002370: 7769 7468 2074 6865 2068 6561 7274 6265  with the heartbe
-00002380: 6174 2c20 736f 6d65 206f 7468 6572 2061  at, some other a
-00002390: 7272 6976 6573 2069 6e20 7265 616c 7469  rrives in realti
-000023a0: 6d65 2061 7320 7468 650a 2020 2020 2020  me as the.      
-000023b0: 2020 2320 7461 736b 7320 7072 6f67 7265    # tasks progre
-000023c0: 7373 2e20 416c 736f 2c20 7369 7a65 6f66  ss. Also, sizeof
-000023d0: 2829 2069 7320 6e6f 7420 6775 6172 616e  () is not guaran
-000023e0: 7465 6564 2074 6f20 7265 7475 726e 2063  teed to return c
-000023f0: 6f72 7265 6374 2072 6573 756c 7473 2e0a  orrect results..
-00002400: 2020 2020 2020 2020 2320 5468 6973 2063          # This c
-00002410: 616e 2063 6175 7365 2067 6c69 7463 6865  an cause glitche
-00002420: 7320 7768 6572 6520 6120 7061 7274 6961  s where a partia
-00002430: 6c20 6d65 6173 7572 6520 6973 206c 6172  l measure is lar
-00002440: 6765 7220 7468 616e 2074 6865 2077 686f  ger than the who
-00002450: 6c65 2c20 736f 0a20 2020 2020 2020 2023  le, so.        #
-00002460: 2077 6520 6e65 6564 2074 6f20 666f 7263   we need to forc
-00002470: 6520 616c 6c20 6e75 6d62 6572 7320 746f  e all numbers to
-00002480: 2061 6464 2075 7020 6578 6163 746c 7920   add up exactly 
-00002490: 6279 2064 6566 696e 6974 696f 6e2e 0a20  by definition.. 
-000024a0: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
-000024b0: 6573 7320 3d20 7072 6f63 6573 730a 2020  ess = process.  
-000024c0: 2020 2020 2020 7365 6c66 2e6d 616e 6167        self.manag
-000024d0: 6564 203d 206d 696e 2873 656c 662e 7072  ed = min(self.pr
-000024e0: 6f63 6573 732c 206d 616e 6167 6564 290a  ocess, managed).
-000024f0: 2020 2020 2020 2020 7365 6c66 2e73 7069          self.spi
-00002500: 6c6c 6564 203d 2073 7069 6c6c 6564 0a20  lled = spilled. 
-00002510: 2020 2020 2020 2023 2053 7562 7472 6163         # Subtrac
-00002520: 7469 6f6e 7320 6265 7477 6565 6e20 756e  tions between un
-00002530: 7369 676e 6564 2069 6e74 7320 6775 6172  signed ints guar
-00002540: 616e 7465 6564 2062 7920 636f 6e73 7472  anteed by constr
-00002550: 7563 7469 6f6e 2074 6f20 6265 203e 3d20  uction to be >= 
-00002560: 300a 2020 2020 2020 2020 7365 6c66 2e75  0.        self.u
-00002570: 6e6d 616e 6167 6564 5f6f 6c64 203d 206d  nmanaged_old = m
-00002580: 696e 2875 6e6d 616e 6167 6564 5f6f 6c64  in(unmanaged_old
-00002590: 2c20 7072 6f63 6573 7320 2d20 7365 6c66  , process - self
-000025a0: 2e6d 616e 6167 6564 290a 0a20 2020 2040  .managed)..    @
-000025b0: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-000025c0: 2064 6566 2073 756d 282a 696e 666f 733a   def sum(*infos:
-000025d0: 204d 656d 6f72 7953 7461 7465 2920 2d3e   MemoryState) ->
-000025e0: 204d 656d 6f72 7953 7461 7465 3a0a 2020   MemoryState:.  
-000025f0: 2020 2020 2020 7072 6f63 6573 7320 3d20        process = 
-00002600: 300a 2020 2020 2020 2020 756e 6d61 6e61  0.        unmana
-00002610: 6765 645f 6f6c 6420 3d20 300a 2020 2020  ged_old = 0.    
-00002620: 2020 2020 6d61 6e61 6765 6420 3d20 300a      managed = 0.
-00002630: 2020 2020 2020 2020 7370 696c 6c65 6420          spilled 
-00002640: 3d20 300a 2020 2020 2020 2020 666f 7220  = 0.        for 
-00002650: 6d73 2069 6e20 696e 666f 733a 0a20 2020  ms in infos:.   
-00002660: 2020 2020 2020 2020 2070 726f 6365 7373           process
-00002670: 202b 3d20 6d73 2e70 726f 6365 7373 0a20   += ms.process. 
-00002680: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
-00002690: 6167 6564 5f6f 6c64 202b 3d20 6d73 2e75  aged_old += ms.u
-000026a0: 6e6d 616e 6167 6564 5f6f 6c64 0a20 2020  nmanaged_old.   
-000026b0: 2020 2020 2020 2020 2073 7069 6c6c 6564           spilled
-000026c0: 202b 3d20 6d73 2e73 7069 6c6c 6564 0a20   += ms.spilled. 
-000026d0: 2020 2020 2020 2020 2020 206d 616e 6167             manag
-000026e0: 6564 202b 3d20 6d73 2e6d 616e 6167 6564  ed += ms.managed
-000026f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00002700: 4d65 6d6f 7279 5374 6174 6528 0a20 2020  MemoryState(.   
-00002710: 2020 2020 2020 2020 2070 726f 6365 7373           process
-00002720: 3d70 726f 6365 7373 2c0a 2020 2020 2020  =process,.      
-00002730: 2020 2020 2020 756e 6d61 6e61 6765 645f        unmanaged_
-00002740: 6f6c 643d 756e 6d61 6e61 6765 645f 6f6c  old=unmanaged_ol
-00002750: 642c 0a20 2020 2020 2020 2020 2020 206d  d,.            m
-00002760: 616e 6167 6564 3d6d 616e 6167 6564 2c0a  anaged=managed,.
-00002770: 2020 2020 2020 2020 2020 2020 7370 696c              spil
-00002780: 6c65 643d 7370 696c 6c65 642c 0a20 2020  led=spilled,.   
-00002790: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
-000027a0: 7065 7274 790a 2020 2020 6465 6620 6d61  perty.    def ma
-000027b0: 6e61 6765 645f 746f 7461 6c28 7365 6c66  naged_total(self
-000027c0: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-000027d0: 2020 7265 7475 726e 2073 656c 662e 6d61    return self.ma
-000027e0: 6e61 6765 6420 2b20 7365 6c66 2e73 7069  naged + self.spi
-000027f0: 6c6c 6564 0a0a 2020 2020 4070 726f 7065  lled..    @prope
-00002800: 7274 790a 2020 2020 6465 6620 756e 6d61  rty.    def unma
-00002810: 6e61 6765 6428 7365 6c66 2920 2d3e 2069  naged(self) -> i
-00002820: 6e74 3a0a 2020 2020 2020 2020 2320 5468  nt:.        # Th
-00002830: 6973 2069 7320 6e65 7665 7220 6e65 6761  is is never nega
-00002840: 7469 7665 2074 6861 6e6b 7320 746f 205f  tive thanks to _
-00002850: 5f69 6e69 745f 5f0a 2020 2020 2020 2020  _init__.        
-00002860: 7265 7475 726e 2073 656c 662e 7072 6f63  return self.proc
-00002870: 6573 7320 2d20 7365 6c66 2e6d 616e 6167  ess - self.manag
-00002880: 6564 0a0a 2020 2020 4070 726f 7065 7274  ed..    @propert
-00002890: 790a 2020 2020 6465 6620 756e 6d61 6e61  y.    def unmana
-000028a0: 6765 645f 7265 6365 6e74 2873 656c 6629  ged_recent(self)
-000028b0: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-000028c0: 2023 2054 6869 7320 6973 206e 6576 6572   # This is never
-000028d0: 206e 6567 6174 6976 6520 7468 616e 6b73   negative thanks
-000028e0: 2074 6f20 5f5f 696e 6974 5f5f 0a20 2020   to __init__.   
-000028f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00002900: 2e70 726f 6365 7373 202d 2073 656c 662e  .process - self.
-00002910: 6d61 6e61 6765 6420 2d20 7365 6c66 2e75  managed - self.u
-00002920: 6e6d 616e 6167 6564 5f6f 6c64 0a0a 2020  nmanaged_old..  
-00002930: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00002940: 6465 6620 6f70 7469 6d69 7374 6963 2873  def optimistic(s
-00002950: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
-00002960: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00002970: 2e6d 616e 6167 6564 202b 2073 656c 662e  .managed + self.
-00002980: 756e 6d61 6e61 6765 645f 6f6c 640a 0a20  unmanaged_old.. 
-00002990: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-000029a0: 2064 6566 206d 616e 6167 6564 5f69 6e5f   def managed_in_
-000029b0: 6d65 6d6f 7279 2873 656c 6629 202d 3e20  memory(self) -> 
-000029c0: 696e 743a 0a20 2020 2020 2020 2077 6172  int:.        war
-000029d0: 6e69 6e67 732e 7761 726e 2822 6d61 6e61  nings.warn("mana
-000029e0: 6765 645f 696e 5f6d 656d 6f72 7920 6861  ged_in_memory ha
-000029f0: 7320 6265 656e 2072 656e 616d 6564 2074  s been renamed t
-00002a00: 6f20 6d61 6e61 6765 6422 2c20 4675 7475  o managed", Futu
-00002a10: 7265 5761 726e 696e 6729 0a20 2020 2020  reWarning).     
-00002a20: 2020 2072 6574 7572 6e20 7365 6c66 2e6d     return self.m
-00002a30: 616e 6167 6564 0a0a 2020 2020 4070 726f  anaged..    @pro
-00002a40: 7065 7274 790a 2020 2020 6465 6620 6d61  perty.    def ma
-00002a50: 6e61 6765 645f 7370 696c 6c65 6428 7365  naged_spilled(se
-00002a60: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-00002a70: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
-00002a80: 6e28 226d 616e 6167 6564 5f73 7069 6c6c  n("managed_spill
-00002a90: 6564 2068 6173 2062 6565 6e20 7265 6e61  ed has been rena
-00002aa0: 6d65 6420 746f 2073 7069 6c6c 6564 222c  med to spilled",
-00002ab0: 2046 7574 7572 6557 6172 6e69 6e67 290a   FutureWarning).
-00002ac0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00002ad0: 656c 662e 7370 696c 6c65 640a 0a20 2020  elf.spilled..   
-00002ae0: 2064 6566 205f 5f72 6570 725f 5f28 7365   def __repr__(se
-00002af0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
-00002b00: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
-00002b10: 2020 2020 2020 2020 2066 2250 726f 6365           f"Proce
-00002b20: 7373 206d 656d 6f72 7920 2852 5353 2920  ss memory (RSS) 
-00002b30: 203a 207b 666f 726d 6174 5f62 7974 6573   : {format_bytes
-00002b40: 2873 656c 662e 7072 6f63 6573 7329 7d5c  (self.process)}\
-00002b50: 6e22 0a20 2020 2020 2020 2020 2020 2066  n".            f
-00002b60: 2220 202d 206d 616e 6167 6564 2062 7920  "  - managed by 
-00002b70: 4461 736b 2020 203a 207b 666f 726d 6174  Dask   : {format
-00002b80: 5f62 7974 6573 2873 656c 662e 6d61 6e61  _bytes(self.mana
-00002b90: 6765 6429 7d5c 6e22 0a20 2020 2020 2020  ged)}\n".       
-00002ba0: 2020 2020 2066 2220 202d 2075 6e6d 616e       f"  - unman
-00002bb0: 6167 6564 2028 6f6c 6429 2020 203a 207b  aged (old)   : {
-00002bc0: 666f 726d 6174 5f62 7974 6573 2873 656c  format_bytes(sel
-00002bd0: 662e 756e 6d61 6e61 6765 645f 6f6c 6429  f.unmanaged_old)
-00002be0: 7d5c 6e22 0a20 2020 2020 2020 2020 2020  }\n".           
-00002bf0: 2066 2220 202d 2075 6e6d 616e 6167 6564   f"  - unmanaged
-00002c00: 2028 7265 6365 6e74 293a 207b 666f 726d   (recent): {form
-00002c10: 6174 5f62 7974 6573 2873 656c 662e 756e  at_bytes(self.un
-00002c20: 6d61 6e61 6765 645f 7265 6365 6e74 297d  managed_recent)}
-00002c30: 5c6e 220a 2020 2020 2020 2020 2020 2020  \n".            
-00002c40: 6622 5370 696c 6c65 6420 746f 2064 6973  f"Spilled to dis
-00002c50: 6b20 2020 2020 2020 3a20 7b66 6f72 6d61  k       : {forma
-00002c60: 745f 6279 7465 7328 7365 6c66 2e73 7069  t_bytes(self.spi
-00002c70: 6c6c 6564 297d 5c6e 220a 2020 2020 2020  lled)}\n".      
-00002c80: 2020 290a 0a20 2020 2064 6566 205f 746f    )..    def _to
-00002c90: 5f64 6963 7428 7365 6c66 2c20 2a2c 2065  _dict(self, *, e
-00002ca0: 7863 6c75 6465 3a20 436f 6e74 6169 6e65  xclude: Containe
-00002cb0: 725b 7374 725d 203d 2028 2929 202d 3e20  r[str] = ()) -> 
-00002cc0: 6469 6374 3a0a 2020 2020 2020 2020 2222  dict:.        ""
-00002cd0: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
-00002ce0: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
-00002cf0: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
-00002d00: 732e 0a0a 2020 2020 2020 2020 5365 6520  s...        See 
-00002d10: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
-00002d20: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436c  -----.        Cl
-00002d30: 6965 6e74 2e64 756d 705f 636c 7573 7465  ient.dump_cluste
-00002d40: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
-00002d50: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
-00002d60: 732e 7265 6375 7273 6976 655f 746f 5f64  s.recursive_to_d
-00002d70: 6963 740a 2020 2020 2020 2020 2222 220a  ict.        """.
-00002d80: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00002d90: 0a20 2020 2020 2020 2020 2020 206b 3a20  .            k: 
-00002da0: 6765 7461 7474 7228 7365 6c66 2c20 6b29  getattr(self, k)
-00002db0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00002dc0: 206b 2069 6e20 6469 7228 7365 6c66 290a   k in dir(self).
-00002dd0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00002de0: 6f74 206b 2e73 7461 7274 7377 6974 6828  ot k.startswith(
-00002df0: 225f 2229 0a20 2020 2020 2020 2020 2020  "_").           
-00002e00: 2061 6e64 206b 206e 6f74 2069 6e20 7b22   and k not in {"
-00002e10: 7375 6d22 2c20 226d 616e 6167 6564 5f69  sum", "managed_i
-00002e20: 6e5f 6d65 6d6f 7279 222c 2022 6d61 6e61  n_memory", "mana
-00002e30: 6765 645f 7370 696c 6c65 6422 7d0a 2020  ged_spilled"}.  
-00002e40: 2020 2020 2020 7d0a 0a0a 636c 6173 7320        }...class 
-00002e50: 576f 726b 6572 5374 6174 653a 0a20 2020  WorkerState:.   
-00002e60: 2022 2222 4120 7369 6d70 6c65 206f 626a   """A simple obj
-00002e70: 6563 7420 686f 6c64 696e 6720 696e 666f  ect holding info
-00002e80: 726d 6174 696f 6e20 6162 6f75 7420 6120  rmation about a 
-00002e90: 776f 726b 6572 2e0a 0a20 2020 204e 6f74  worker...    Not
-00002ea0: 2074 6f20 6265 2063 6f6e 6675 7365 6420   to be confused 
-00002eb0: 7769 7468 203a 636c 6173 733a 6064 6973  with :class:`dis
-00002ec0: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
-00002ed0: 7374 6174 655f 6d61 6368 696e 652e 576f  state_machine.Wo
-00002ee0: 726b 6572 5374 6174 6560 2e0a 2020 2020  rkerState`..    
-00002ef0: 2222 220a 0a20 2020 2023 3a20 5468 6973  """..    #: This
-00002f00: 2077 6f72 6b65 7227 7320 756e 6971 7565   worker's unique
-00002f10: 206b 6579 2e20 5468 6973 2063 616e 2062   key. This can b
-00002f20: 6520 6974 7320 636f 6e6e 6563 7465 6420  e its connected 
-00002f30: 6164 6472 6573 730a 2020 2020 233a 2028  address.    #: (
-00002f40: 7375 6368 2061 7320 6060 2274 6370 3a2f  such as ``"tcp:/
-00002f50: 2f31 3237 2e30 2e30 2e31 3a38 3839 3122  /127.0.0.1:8891"
-00002f60: 6060 2920 6f72 2061 6e20 616c 6961 7320  ``) or an alias 
-00002f70: 2873 7563 6820 6173 2060 6022 616c 6963  (such as ``"alic
-00002f80: 6522 6060 292e 0a20 2020 2061 6464 7265  e"``)..    addre
-00002f90: 7373 3a20 7374 720a 0a20 2020 2070 6964  ss: str..    pid
-00002fa0: 3a20 696e 740a 2020 2020 6e61 6d65 3a20  : int.    name: 
-00002fb0: 4861 7368 6162 6c65 0a0a 2020 2020 233a  Hashable..    #:
-00002fc0: 2054 6865 206e 756d 6265 7220 6f66 2043   The number of C
-00002fd0: 5055 2074 6872 6561 6473 206d 6164 6520  PU threads made 
-00002fe0: 6176 6169 6c61 626c 6520 6f6e 2074 6869  available on thi
-00002ff0: 7320 776f 726b 6572 0a20 2020 206e 7468  s worker.    nth
-00003000: 7265 6164 733a 2069 6e74 0a0a 2020 2020  reads: int..    
-00003010: 233a 204d 656d 6f72 7920 6176 6169 6c61  #: Memory availa
-00003020: 626c 6520 746f 2074 6865 2077 6f72 6b65  ble to the worke
-00003030: 722c 2069 6e20 6279 7465 730a 2020 2020  r, in bytes.    
-00003040: 6d65 6d6f 7279 5f6c 696d 6974 3a20 696e  memory_limit: in
-00003050: 740a 0a20 2020 206c 6f63 616c 5f64 6972  t..    local_dir
-00003060: 6563 746f 7279 3a20 7374 720a 2020 2020  ectory: str.    
-00003070: 7365 7276 6963 6573 3a20 6469 6374 5b73  services: dict[s
-00003080: 7472 2c20 696e 745d 0a0a 2020 2020 233a  tr, int]..    #:
-00003090: 204f 7574 7075 7420 6f66 203a 6d65 7468   Output of :meth
-000030a0: 3a60 6469 7374 7269 6275 7465 642e 7665  :`distributed.ve
-000030b0: 7273 696f 6e73 2e67 6574 5f76 6572 7369  rsions.get_versi
-000030c0: 6f6e 7360 206f 6e20 7468 6520 776f 726b  ons` on the work
-000030d0: 6572 0a20 2020 2076 6572 7369 6f6e 733a  er.    versions:
-000030e0: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
-000030f0: 0a20 2020 2023 3a20 4164 6472 6573 7320  .    #: Address 
-00003100: 6f66 2074 6865 2061 7373 6f63 6961 7465  of the associate
-00003110: 6420 3a63 6c61 7373 3a60 7e64 6973 7472  d :class:`~distr
-00003120: 6962 7574 6564 2e6e 616e 6e79 2e4e 616e  ibuted.nanny.Nan
-00003130: 6e79 602c 2069 6620 7072 6573 656e 740a  ny`, if present.
-00003140: 2020 2020 6e61 6e6e 793a 2073 7472 0a0a      nanny: str..
-00003150: 2020 2020 233a 2052 6561 642d 6f6e 6c79      #: Read-only
-00003160: 2077 6f72 6b65 7220 7374 6174 7573 2c20   worker status, 
-00003170: 7379 6e63 6564 206f 6e65 2077 6179 2066  synced one way f
-00003180: 726f 6d20 7468 6520 7265 6d6f 7465 2057  rom the remote W
-00003190: 6f72 6b65 7220 6f62 6a65 6374 0a20 2020  orker object.   
-000031a0: 2073 7461 7475 733a 2053 7461 7475 730a   status: Status.
-000031b0: 0a20 2020 2023 3a20 4361 6368 6564 2068  .    #: Cached h
-000031c0: 6173 6820 6f66 203a 6174 7472 3a60 7e57  ash of :attr:`~W
-000031d0: 6f72 6b65 7253 7461 7465 2e61 6464 7265  orkerState.addre
-000031e0: 7373 600a 2020 2020 5f68 6173 683a 2069  ss`.    _hash: i
-000031f0: 6e74 0a0a 2020 2020 233a 2054 6865 2074  nt..    #: The t
-00003200: 6f74 616c 206d 656d 6f72 7920 7369 7a65  otal memory size
-00003210: 2c20 696e 2062 7974 6573 2c20 7573 6564  , in bytes, used
-00003220: 2062 7920 7468 6520 7461 736b 7320 7468   by the tasks th
-00003230: 6973 2077 6f72 6b65 7220 686f 6c64 7320  is worker holds 
-00003240: 696e 206d 656d 6f72 790a 2020 2020 233a  in memory.    #:
-00003250: 2028 692e 652e 2074 6865 2074 6173 6b73   (i.e. the tasks
-00003260: 2069 6e20 7468 6973 2077 6f72 6b65 7227   in this worker'
-00003270: 7320 3a61 7474 723a 607e 576f 726b 6572  s :attr:`~Worker
-00003280: 5374 6174 652e 6861 735f 7768 6174 6029  State.has_what`)
-00003290: 2e0a 2020 2020 6e62 7974 6573 3a20 696e  ..    nbytes: in
-000032a0: 740a 0a20 2020 2023 3a20 576f 726b 6572  t..    #: Worker
-000032b0: 206d 656d 6f72 7920 756e 6b6e 6f77 6e20   memory unknown 
-000032c0: 746f 2074 6865 2077 6f72 6b65 722c 2069  to the worker, i
-000032d0: 6e20 6279 7465 732c 2077 6869 6368 2068  n bytes, which h
-000032e0: 6173 2062 6565 6e20 7468 6572 6520 666f  as been there fo
-000032f0: 7220 6d6f 7265 2074 6861 6e0a 2020 2020  r more than.    
-00003300: 233a 2033 3020 7365 636f 6e64 732e 2053  #: 30 seconds. S
-00003310: 6565 203a 636c 6173 733a 604d 656d 6f72  ee :class:`Memor
-00003320: 7953 7461 7465 602e 0a20 2020 205f 6d65  yState`..    _me
-00003330: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
-00003340: 6c64 3a20 696e 740a 0a20 2020 2023 3a20  ld: int..    #: 
-00003350: 4869 7374 6f72 7920 6f66 2074 6865 206c  History of the l
-00003360: 6173 7420 3330 2073 6563 6f6e 6473 2720  ast 30 seconds' 
-00003370: 776f 7274 6820 6f66 2075 6e6d 616e 6167  worth of unmanag
-00003380: 6564 206d 656d 6f72 792e 2055 7365 6420  ed memory. Used 
-00003390: 746f 2064 6966 6665 7265 6e74 6961 7465  to differentiate
-000033a0: 0a20 2020 2023 3a20 6265 7477 6565 6e20  .    #: between 
-000033b0: 226f 6c64 2220 616e 6420 226e 6577 2220  "old" and "new" 
-000033c0: 756e 6d61 6e61 6765 6420 6d65 6d6f 7279  unmanaged memory
-000033d0: 2e0a 2020 2020 233a 2046 6f72 6d61 743a  ..    #: Format:
-000033e0: 2060 605b 2874 696d 6573 7461 6d70 2c20   ``[(timestamp, 
-000033f0: 6279 7465 7329 2c20 2874 696d 6573 7461  bytes), (timesta
-00003400: 6d70 2c20 6279 7465 7329 2c20 2e2e 2e5d  mp, bytes), ...]
-00003410: 6060 0a20 2020 205f 6d65 6d6f 7279 5f75  ``.    _memory_u
-00003420: 6e6d 616e 6167 6564 5f68 6973 746f 7279  nmanaged_history
-00003430: 3a20 6465 7175 655b 7475 706c 655b 666c  : deque[tuple[fl
-00003440: 6f61 742c 2069 6e74 5d5d 0a0a 2020 2020  oat, int]]..    
-00003450: 6d65 7472 6963 733a 2064 6963 745b 7374  metrics: dict[st
-00003460: 722c 2041 6e79 5d0a 0a20 2020 2023 3a20  r, Any]..    #: 
-00003470: 5468 6520 6c61 7374 2074 696d 6520 7765  The last time we
-00003480: 2072 6563 6569 7665 6420 6120 6865 6172   received a hear
-00003490: 7462 6561 7420 6672 6f6d 2074 6869 7320  tbeat from this 
-000034a0: 776f 726b 6572 2c20 696e 206c 6f63 616c  worker, in local
-000034b0: 2073 6368 6564 756c 6572 2074 696d 652e   scheduler time.
-000034c0: 0a20 2020 206c 6173 745f 7365 656e 3a20  .    last_seen: 
-000034d0: 666c 6f61 740a 0a20 2020 2074 696d 655f  float..    time_
-000034e0: 6465 6c61 793a 2066 6c6f 6174 0a20 2020  delay: float.   
-000034f0: 2062 616e 6477 6964 7468 3a20 666c 6f61   bandwidth: floa
-00003500: 740a 0a20 2020 2023 3a20 4120 7365 7420  t..    #: A set 
-00003510: 6f66 2061 6c6c 2054 6173 6b53 7461 7465  of all TaskState
-00003520: 7320 6f6e 2074 6869 7320 776f 726b 6572  s on this worker
-00003530: 2074 6861 7420 6172 6520 6163 746f 7273   that are actors
-00003540: 2e20 5468 6973 206f 6e6c 7920 696e 636c  . This only incl
-00003550: 7564 6573 2074 686f 7365 0a20 2020 2023  udes those.    #
-00003560: 3a20 6163 746f 7273 2077 686f 7365 2073  : actors whose s
-00003570: 7461 7465 2061 6374 7561 6c6c 7920 6c69  tate actually li
-00003580: 7665 7320 6f6e 2074 6869 7320 776f 726b  ves on this work
-00003590: 6572 2c20 6e6f 7420 6163 746f 7273 2074  er, not actors t
-000035a0: 6f20 7768 6963 6820 7468 6973 2077 6f72  o which this wor
-000035b0: 6b65 720a 2020 2020 233a 2068 6173 2061  ker.    #: has a
-000035c0: 2072 6566 6572 656e 6365 2e0a 2020 2020   reference..    
-000035d0: 6163 746f 7273 3a20 7365 745b 5461 736b  actors: set[Task
-000035e0: 5374 6174 655d 0a0a 2020 2020 233a 2055  State]..    #: U
-000035f0: 6e64 6572 6c79 696e 6720 6461 7461 206f  nderlying data o
-00003600: 6620 3a6d 6574 683a 6057 6f72 6b65 7253  f :meth:`WorkerS
-00003610: 7461 7465 2e68 6173 5f77 6861 7460 0a20  tate.has_what`. 
-00003620: 2020 205f 6861 735f 7768 6174 3a20 6469     _has_what: di
-00003630: 6374 5b54 6173 6b53 7461 7465 2c20 4e6f  ct[TaskState, No
-00003640: 6e65 5d0a 0a20 2020 2023 3a20 4120 7365  ne]..    #: A se
-00003650: 7420 6f66 2074 6173 6b73 2074 6861 7420  t of tasks that 
-00003660: 6861 7665 2062 6565 6e20 7375 626d 6974  have been submit
-00003670: 7465 6420 746f 2074 6869 7320 776f 726b  ted to this work
-00003680: 6572 2e20 4d75 6c74 6970 6c65 2074 6173  er. Multiple tas
-00003690: 6b73 206d 6179 2062 650a 2020 2020 2320  ks may be.    # 
-000036a0: 7375 626d 6974 7465 6420 746f 2061 2077  submitted to a w
-000036b0: 6f72 6b65 7220 696e 2061 6476 616e 6365  orker in advance
-000036c0: 2061 6e64 2074 6865 2077 6f72 6b65 7220   and the worker 
-000036d0: 7769 6c6c 2072 756e 2074 6865 6d20 6576  will run them ev
-000036e0: 656e 7475 616c 6c79 2c0a 2020 2020 2320  entually,.    # 
-000036f0: 6465 7065 6e64 696e 6720 6f6e 2069 7473  depending on its
-00003700: 2065 7865 6375 7469 6f6e 2072 6573 6f75   execution resou
-00003710: 7263 6573 2028 6275 7420 7365 6520 3a64  rces (but see :d
-00003720: 6f63 3a60 776f 726b 2d73 7465 616c 696e  oc:`work-stealin
-00003730: 6760 292e 0a20 2020 2023 3a0a 2020 2020  g`)..    #:.    
-00003740: 233a 2041 6c6c 2074 6865 2074 6173 6b73  #: All the tasks
-00003750: 2068 6572 6520 6172 6520 696e 2074 6865   here are in the
-00003760: 2022 7072 6f63 6573 7369 6e67 2220 7374   "processing" st
-00003770: 6174 652e 0a20 2020 2023 3a20 5468 6973  ate..    #: This
-00003780: 2061 7474 7269 6275 7465 2069 7320 6b65   attribute is ke
-00003790: 7074 2069 6e20 7379 6e63 2077 6974 6820  pt in sync with 
-000037a0: 3a61 7474 723a 6054 6173 6b53 7461 7465  :attr:`TaskState
-000037b0: 2e70 726f 6365 7373 696e 675f 6f6e 602e  .processing_on`.
-000037c0: 0a20 2020 2070 726f 6365 7373 696e 673a  .    processing:
-000037d0: 2073 6574 5b54 6173 6b53 7461 7465 5d0a   set[TaskState].
-000037e0: 0a20 2020 2023 3a20 5275 6e6e 696e 6720  .    #: Running 
-000037f0: 7461 736b 7320 7468 6174 2069 6e76 6f6b  tasks that invok
-00003800: 6564 203a 6675 6e63 3a60 6469 7374 7269  ed :func:`distri
-00003810: 6275 7465 642e 7365 6365 6465 600a 2020  buted.secede`.  
-00003820: 2020 6c6f 6e67 5f72 756e 6e69 6e67 3a20    long_running: 
-00003830: 7365 745b 5461 736b 5374 6174 655d 0a0a  set[TaskState]..
-00003840: 2020 2020 233a 2041 2064 6963 7469 6f6e      #: A diction
-00003850: 6172 7920 6f66 2074 6173 6b73 2074 6861  ary of tasks tha
-00003860: 7420 6172 6520 6375 7272 656e 746c 7920  t are currently 
-00003870: 6265 696e 6720 7275 6e20 6f6e 2074 6869  being run on thi
-00003880: 7320 776f 726b 6572 2e0a 2020 2020 233a  s worker..    #:
-00003890: 2045 6163 6820 7461 736b 2073 7461 7465   Each task state
-000038a0: 2069 7320 6173 736f 6369 6174 6564 2077   is associated w
-000038b0: 6974 6820 7468 6520 6475 7261 7469 6f6e  ith the duration
-000038c0: 2069 6e20 7365 636f 6e64 7320 7768 6963   in seconds whic
-000038d0: 6820 7468 6520 7461 736b 2068 6173 0a20  h the task has. 
-000038e0: 2020 2023 3a20 6265 656e 2072 756e 6e69     #: been runni
-000038f0: 6e67 2e0a 2020 2020 6578 6563 7574 696e  ng..    executin
-00003900: 673a 2064 6963 745b 5461 736b 5374 6174  g: dict[TaskStat
-00003910: 652c 2066 6c6f 6174 5d0a 0a20 2020 2023  e, float]..    #
-00003920: 3a20 5468 6520 6176 6169 6c61 626c 6520  : The available 
-00003930: 7265 736f 7572 6365 7320 6f6e 2074 6869  resources on thi
-00003940: 7320 776f 726b 6572 2c20 652e 672e 2060  s worker, e.g. `
-00003950: 607b 2247 5055 223a 2032 7d60 602e 0a20  `{"GPU": 2}``.. 
-00003960: 2020 2023 3a20 5468 6573 6520 6172 6520     #: These are 
-00003970: 6162 7374 7261 6374 2071 7561 6e74 6974  abstract quantit
-00003980: 6965 7320 7468 6174 2063 6f6e 7374 7261  ies that constra
-00003990: 696e 2063 6572 7461 696e 2074 6173 6b73  in certain tasks
-000039a0: 2066 726f 6d20 7275 6e6e 696e 6720 6174   from running at
-000039b0: 2074 6865 0a20 2020 2023 3a20 7361 6d65   the.    #: same
-000039c0: 2074 696d 6520 6f6e 2074 6869 7320 776f   time on this wo
-000039d0: 726b 6572 2e0a 2020 2020 7265 736f 7572  rker..    resour
-000039e0: 6365 733a 2064 6963 745b 7374 722c 2066  ces: dict[str, f
-000039f0: 6c6f 6174 5d0a 0a20 2020 2023 3a20 5468  loat]..    #: Th
-00003a00: 6520 7375 6d20 6f66 2065 6163 6820 7265  e sum of each re
-00003a10: 736f 7572 6365 2075 7365 6420 6279 2061  source used by a
-00003a20: 6c6c 2074 6173 6b73 2061 6c6c 6f63 6174  ll tasks allocat
-00003a30: 6564 2074 6f20 7468 6973 2077 6f72 6b65  ed to this worke
-00003a40: 722e 0a20 2020 2023 3a20 5468 6520 6e75  r..    #: The nu
-00003a50: 6d62 6572 7320 696e 2074 6869 7320 6469  mbers in this di
-00003a60: 6374 696f 6e61 7279 2063 616e 206f 6e6c  ctionary can onl
-00003a70: 7920 6265 206c 6573 7320 6f72 2065 7175  y be less or equ
-00003a80: 616c 2074 6861 6e20 7468 6f73 6520 696e  al than those in
-00003a90: 2074 6869 730a 2020 2020 233a 2077 6f72   this.    #: wor
-00003aa0: 6b65 7227 7320 3a61 7474 723a 607e 576f  ker's :attr:`~Wo
-00003ab0: 726b 6572 5374 6174 652e 7265 736f 7572  rkerState.resour
-00003ac0: 6365 7360 2e0a 2020 2020 7573 6564 5f72  ces`..    used_r
-00003ad0: 6573 6f75 7263 6573 3a20 6469 6374 5b73  esources: dict[s
-00003ae0: 7472 2c20 666c 6f61 745d 0a0a 2020 2020  tr, float]..    
-00003af0: 233a 2041 7262 6974 7261 7279 2061 6464  #: Arbitrary add
-00003b00: 6974 696f 6e61 6c20 6d65 7461 6461 7461  itional metadata
-00003b10: 2074 6f20 6265 2061 6464 6564 2074 6f20   to be added to 
-00003b20: 3a6d 6574 683a 607e 576f 726b 6572 5374  :meth:`~WorkerSt
-00003b30: 6174 652e 6964 656e 7469 7479 600a 2020  ate.identity`.  
-00003b40: 2020 6578 7472 613a 2064 6963 745b 7374    extra: dict[st
-00003b50: 722c 2041 6e79 5d0a 0a20 2020 2023 2054  r, Any]..    # T
-00003b60: 6865 2075 6e69 7175 6520 7365 7276 6572  he unique server
-00003b70: 2049 4420 7468 6973 2057 6f72 6b65 7253   ID this WorkerS
-00003b80: 7461 7465 2069 7320 7265 6665 7265 6e63  tate is referenc
-00003b90: 696e 670a 2020 2020 7365 7276 6572 5f69  ing.    server_i
-00003ba0: 643a 2073 7472 0a0a 2020 2020 2320 5265  d: str..    # Re
-00003bb0: 6665 7265 6e63 6520 746f 2073 6368 6564  ference to sched
-00003bc0: 756c 6572 2074 6173 6b5f 6772 6f75 7073  uler task_groups
-00003bd0: 0a20 2020 2073 6368 6564 756c 6572 5f72  .    scheduler_r
-00003be0: 6566 3a20 7765 616b 7265 662e 7265 665b  ef: weakref.ref[
-00003bf0: 5363 6865 6475 6c65 7253 7461 7465 5d20  SchedulerState] 
-00003c00: 7c20 4e6f 6e65 0a20 2020 2074 6173 6b5f  | None.    task_
-00003c10: 7072 6566 6978 5f63 6f75 6e74 3a20 6465  prefix_count: de
-00003c20: 6661 756c 7464 6963 745b 7374 722c 2069  faultdict[str, i
-00003c30: 6e74 5d0a 2020 2020 5f6e 6574 776f 726b  nt].    _network
-00003c40: 5f6f 6363 3a20 666c 6f61 740a 2020 2020  _occ: float.    
-00003c50: 5f6f 6363 7570 616e 6379 5f63 6163 6865  _occupancy_cache
-00003c60: 3a20 666c 6f61 7420 7c20 4e6f 6e65 0a0a  : float | None..
-00003c70: 2020 2020 233a 204b 6579 7320 7468 6174      #: Keys that
-00003c80: 206d 6179 206e 6565 6420 746f 2062 6520   may need to be 
-00003c90: 6665 7463 6865 6420 746f 2074 6869 7320  fetched to this 
-00003ca0: 776f 726b 6572 2c20 616e 6420 7468 6520  worker, and the 
-00003cb0: 6e75 6d62 6572 206f 6620 7461 736b 7320  number of tasks 
-00003cc0: 7468 6174 206e 6565 6420 7468 656d 2e0a  that need them..
-00003cd0: 2020 2020 233a 2041 6c6c 2074 6173 6b73      #: All tasks
-00003ce0: 2061 7265 2063 7572 7265 6e74 6c79 2069   are currently i
-00003cf0: 6e20 606d 656d 6f72 7960 206f 6e20 6120  n `memory` on a 
-00003d00: 776f 726b 6572 206f 7468 6572 2074 6861  worker other tha
-00003d10: 6e20 7468 6973 206f 6e65 2e0a 2020 2020  n this one..    
-00003d20: 233a 204d 7563 6820 6c69 6b65 2060 7072  #: Much like `pr
-00003d30: 6f63 6573 7369 6e67 602c 2074 6869 7320  ocessing`, this 
-00003d40: 646f 6573 206e 6f74 2065 7861 6374 6c79  does not exactly
-00003d50: 2072 6566 6c65 6374 2077 6f72 6b65 7220   reflect worker 
-00003d60: 7374 6174 653a 0a20 2020 2023 3a20 6b65  state:.    #: ke
-00003d70: 7973 2068 6572 6520 6d61 7920 6265 2071  ys here may be q
-00003d80: 7565 7565 6420 746f 2066 6574 6368 2c20  ueued to fetch, 
-00003d90: 696e 2066 6c69 6768 742c 206f 7220 616c  in flight, or al
-00003da0: 7265 6164 7920 696e 206d 656d 6f72 790a  ready in memory.
-00003db0: 2020 2020 233a 206f 6e20 7468 6520 776f      #: on the wo
-00003dc0: 726b 6572 2e0a 2020 2020 6e65 6564 735f  rker..    needs_
-00003dd0: 7768 6174 3a20 6469 6374 5b54 6173 6b53  what: dict[TaskS
-00003de0: 7461 7465 2c20 696e 745d 0a0a 2020 2020  tate, int]..    
-00003df0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
-00003e00: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
-00003e10: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
-00003e20: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
-00003e30: 6c66 2c0a 2020 2020 2020 2020 2a2c 0a20  lf,.        *,. 
-00003e40: 2020 2020 2020 2061 6464 7265 7373 3a20         address: 
-00003e50: 7374 722c 0a20 2020 2020 2020 2073 7461  str,.        sta
-00003e60: 7475 733a 2053 7461 7475 732c 0a20 2020  tus: Status,.   
-00003e70: 2020 2020 2070 6964 3a20 696e 742c 0a20       pid: int,. 
-00003e80: 2020 2020 2020 206e 616d 653a 206f 626a         name: obj
-00003e90: 6563 742c 0a20 2020 2020 2020 206e 7468  ect,.        nth
-00003ea0: 7265 6164 733a 2069 6e74 203d 2030 2c0a  reads: int = 0,.
-00003eb0: 2020 2020 2020 2020 6d65 6d6f 7279 5f6c          memory_l
-00003ec0: 696d 6974 3a20 696e 742c 0a20 2020 2020  imit: int,.     
-00003ed0: 2020 206c 6f63 616c 5f64 6972 6563 746f     local_directo
-00003ee0: 7279 3a20 7374 722c 0a20 2020 2020 2020  ry: str,.       
-00003ef0: 206e 616e 6e79 3a20 7374 722c 0a20 2020   nanny: str,.   
-00003f00: 2020 2020 2073 6572 7665 725f 6964 3a20       server_id: 
-00003f10: 7374 722c 0a20 2020 2020 2020 2073 6572  str,.        ser
-00003f20: 7669 6365 733a 2064 6963 745b 7374 722c  vices: dict[str,
-00003f30: 2069 6e74 5d20 7c20 4e6f 6e65 203d 204e   int] | None = N
-00003f40: 6f6e 652c 0a20 2020 2020 2020 2076 6572  one,.        ver
-00003f50: 7369 6f6e 733a 2064 6963 745b 7374 722c  sions: dict[str,
-00003f60: 2041 6e79 5d20 7c20 4e6f 6e65 203d 204e   Any] | None = N
-00003f70: 6f6e 652c 0a20 2020 2020 2020 2065 7874  one,.        ext
-00003f80: 7261 3a20 6469 6374 5b73 7472 2c20 416e  ra: dict[str, An
-00003f90: 795d 207c 204e 6f6e 6520 3d20 4e6f 6e65  y] | None = None
-00003fa0: 2c0a 2020 2020 2020 2020 7363 6865 6475  ,.        schedu
-00003fb0: 6c65 723a 2053 6368 6564 756c 6572 5374  ler: SchedulerSt
-00003fc0: 6174 6520 7c20 4e6f 6e65 203d 204e 6f6e  ate | None = Non
-00003fd0: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
-00003fe0: 2020 7365 6c66 2e73 6572 7665 725f 6964    self.server_id
-00003ff0: 203d 2073 6572 7665 725f 6964 0a20 2020   = server_id.   
-00004000: 2020 2020 2073 656c 662e 6164 6472 6573       self.addres
-00004010: 7320 3d20 6164 6472 6573 730a 2020 2020  s = address.    
-00004020: 2020 2020 7365 6c66 2e70 6964 203d 2070      self.pid = p
-00004030: 6964 0a20 2020 2020 2020 2073 656c 662e  id.        self.
-00004040: 6e61 6d65 203d 206e 616d 650a 2020 2020  name = name.    
-00004050: 2020 2020 7365 6c66 2e6e 7468 7265 6164      self.nthread
-00004060: 7320 3d20 6e74 6872 6561 6473 0a20 2020  s = nthreads.   
-00004070: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
-00004080: 5f6c 696d 6974 203d 206d 656d 6f72 795f  _limit = memory_
-00004090: 6c69 6d69 740a 2020 2020 2020 2020 7365  limit.        se
-000040a0: 6c66 2e6c 6f63 616c 5f64 6972 6563 746f  lf.local_directo
-000040b0: 7279 203d 206c 6f63 616c 5f64 6972 6563  ry = local_direc
-000040c0: 746f 7279 0a20 2020 2020 2020 2073 656c  tory.        sel
-000040d0: 662e 7365 7276 6963 6573 203d 2073 6572  f.services = ser
-000040e0: 7669 6365 7320 6f72 207b 7d0a 2020 2020  vices or {}.    
-000040f0: 2020 2020 7365 6c66 2e76 6572 7369 6f6e      self.version
-00004100: 7320 3d20 7665 7273 696f 6e73 206f 7220  s = versions or 
-00004110: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-00004120: 6e61 6e6e 7920 3d20 6e61 6e6e 790a 2020  nanny = nanny.  
-00004130: 2020 2020 2020 7365 6c66 2e73 7461 7475        self.statu
-00004140: 7320 3d20 7374 6174 7573 0a20 2020 2020  s = status.     
-00004150: 2020 2073 656c 662e 5f68 6173 6820 3d20     self._hash = 
-00004160: 6861 7368 2873 656c 662e 7365 7276 6572  hash(self.server
-00004170: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
-00004180: 662e 6e62 7974 6573 203d 2030 0a20 2020  f.nbytes = 0.   
-00004190: 2020 2020 2073 656c 662e 5f6d 656d 6f72       self._memor
-000041a0: 795f 756e 6d61 6e61 6765 645f 6f6c 6420  y_unmanaged_old 
-000041b0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-000041c0: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
-000041d0: 6564 5f68 6973 746f 7279 203d 2064 6571  ed_history = deq
-000041e0: 7565 2829 0a20 2020 2020 2020 2073 656c  ue().        sel
-000041f0: 662e 6d65 7472 6963 7320 3d20 7b7d 0a20  f.metrics = {}. 
-00004200: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-00004210: 5f73 6565 6e20 3d20 300a 2020 2020 2020  _seen = 0.      
-00004220: 2020 7365 6c66 2e74 696d 655f 6465 6c61    self.time_dela
-00004230: 7920 3d20 300a 2020 2020 2020 2020 7365  y = 0.        se
-00004240: 6c66 2e62 616e 6477 6964 7468 203d 2070  lf.bandwidth = p
-00004250: 6172 7365 5f62 7974 6573 2864 6173 6b2e  arse_bytes(dask.
-00004260: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-00004270: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-00004280: 722e 6261 6e64 7769 6474 6822 2929 0a20  r.bandwidth")). 
-00004290: 2020 2020 2020 2073 656c 662e 6163 746f         self.acto
-000042a0: 7273 203d 2073 6574 2829 0a20 2020 2020  rs = set().     
-000042b0: 2020 2073 656c 662e 5f68 6173 5f77 6861     self._has_wha
-000042c0: 7420 3d20 7b7d 0a20 2020 2020 2020 2073  t = {}.        s
-000042d0: 656c 662e 7072 6f63 6573 7369 6e67 203d  elf.processing =
-000042e0: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
-000042f0: 656c 662e 6c6f 6e67 5f72 756e 6e69 6e67  elf.long_running
-00004300: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-00004310: 2073 656c 662e 6578 6563 7574 696e 6720   self.executing 
-00004320: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-00004330: 662e 7265 736f 7572 6365 7320 3d20 7b7d  f.resources = {}
-00004340: 0a20 2020 2020 2020 2073 656c 662e 7573  .        self.us
-00004350: 6564 5f72 6573 6f75 7263 6573 203d 207b  ed_resources = {
-00004360: 7d0a 2020 2020 2020 2020 7365 6c66 2e65  }.        self.e
-00004370: 7874 7261 203d 2065 7874 7261 206f 7220  xtra = extra or 
-00004380: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-00004390: 7363 6865 6475 6c65 725f 7265 6620 3d20  scheduler_ref = 
-000043a0: 7765 616b 7265 662e 7265 6628 7363 6865  weakref.ref(sche
-000043b0: 6475 6c65 7229 2069 6620 7363 6865 6475  duler) if schedu
-000043c0: 6c65 7220 656c 7365 204e 6f6e 650a 2020  ler else None.  
-000043d0: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-000043e0: 7072 6566 6978 5f63 6f75 6e74 203d 2064  prefix_count = d
-000043f0: 6566 6175 6c74 6469 6374 2869 6e74 290a  efaultdict(int).
-00004400: 2020 2020 2020 2020 7365 6c66 2e6e 6565          self.nee
-00004410: 6473 5f77 6861 7420 3d20 7b7d 0a20 2020  ds_what = {}.   
-00004420: 2020 2020 2073 656c 662e 5f6e 6574 776f       self._netwo
-00004430: 726b 5f6f 6363 203d 2030 0a20 2020 2020  rk_occ = 0.     
-00004440: 2020 2073 656c 662e 5f6f 6363 7570 616e     self._occupan
-00004450: 6379 5f63 6163 6865 203d 204e 6f6e 650a  cy_cache = None.
-00004460: 0a20 2020 2064 6566 205f 5f68 6173 685f  .    def __hash_
-00004470: 5f28 7365 6c66 2920 2d3e 2069 6e74 3a0a  _(self) -> int:.
-00004480: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00004490: 656c 662e 5f68 6173 680a 0a20 2020 2064  elf._hash..    d
-000044a0: 6566 205f 5f65 715f 5f28 7365 6c66 2c20  ef __eq__(self, 
-000044b0: 6f74 6865 723a 206f 626a 6563 7429 202d  other: object) -
-000044c0: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-000044d0: 7265 7475 726e 2069 7369 6e73 7461 6e63  return isinstanc
-000044e0: 6528 6f74 6865 722c 2057 6f72 6b65 7253  e(other, WorkerS
-000044f0: 7461 7465 2920 616e 6420 6f74 6865 722e  tate) and other.
-00004500: 7365 7276 6572 5f69 6420 3d3d 2073 656c  server_id == sel
-00004510: 662e 7365 7276 6572 5f69 640a 0a20 2020  f.server_id..   
-00004520: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00004530: 6566 2068 6173 5f77 6861 7428 7365 6c66  ef has_what(self
-00004540: 2920 2d3e 2053 6574 5b54 6173 6b53 7461  ) -> Set[TaskSta
-00004550: 7465 5d3a 0a20 2020 2020 2020 2022 2222  te]:.        """
-00004560: 416e 2069 6e73 6572 7469 6f6e 2d73 6f72  An insertion-sor
-00004570: 7465 6420 7365 742d 6c69 6b65 206f 6620  ted set-like of 
-00004580: 7461 736b 7320 7768 6963 6820 6375 7272  tasks which curr
-00004590: 656e 746c 7920 7265 7369 6465 206f 6e20  ently reside on 
-000045a0: 7468 6973 2077 6f72 6b65 722e 0a20 2020  this worker..   
-000045b0: 2020 2020 2041 6c6c 2074 6865 2074 6173       All the tas
-000045c0: 6b73 2068 6572 6520 6172 6520 696e 2074  ks here are in t
-000045d0: 6865 2022 6d65 6d6f 7279 2220 7374 6174  he "memory" stat
-000045e0: 652e 0a20 2020 2020 2020 2054 6869 7320  e..        This 
-000045f0: 6973 2074 6865 2072 6576 6572 7365 206d  is the reverse m
-00004600: 6170 7069 6e67 206f 6620 3a61 7474 723a  apping of :attr:
-00004610: 6054 6173 6b53 7461 7465 2e77 686f 5f68  `TaskState.who_h
-00004620: 6173 602e 0a0a 2020 2020 2020 2020 5468  as`...        Th
-00004630: 6973 2069 7320 6120 7265 6164 2d6f 6e6c  is is a read-onl
-00004640: 7920 7075 626c 6963 2061 6363 6573 736f  y public accesso
-00004650: 722e 2054 6865 2064 6174 6120 6973 2069  r. The data is i
-00004660: 6d70 6c65 6d65 6e74 6564 2061 7320 6120  mplemented as a 
-00004670: 6469 6374 2077 6974 686f 7574 0a20 2020  dict without.   
-00004680: 2020 2020 2076 616c 7565 732c 2062 6563       values, bec
-00004690: 6175 7365 2072 6562 616c 616e 6365 2829  ause rebalance()
-000046a0: 2072 656c 6965 7320 6f6e 2064 6963 7473   relies on dicts
-000046b0: 2062 6569 6e67 2069 6e73 6572 7469 6f6e   being insertion
-000046c0: 2d73 6f72 7465 642e 0a20 2020 2020 2020  -sorted..       
-000046d0: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-000046e0: 7572 6e20 7365 6c66 2e5f 6861 735f 7768  urn self._has_wh
-000046f0: 6174 2e6b 6579 7328 290a 0a20 2020 2040  at.keys()..    @
-00004700: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00004710: 2068 6f73 7428 7365 6c66 2920 2d3e 2073   host(self) -> s
-00004720: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-00004730: 726e 2067 6574 5f61 6464 7265 7373 5f68  rn get_address_h
-00004740: 6f73 7428 7365 6c66 2e61 6464 7265 7373  ost(self.address
-00004750: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
-00004760: 0a20 2020 2064 6566 206d 656d 6f72 7928  .    def memory(
-00004770: 7365 6c66 2920 2d3e 204d 656d 6f72 7953  self) -> MemoryS
-00004780: 7461 7465 3a0a 2020 2020 2020 2020 2222  tate:.        ""
-00004790: 2250 6f6c 6973 6865 6420 6d65 6d6f 7279  "Polished memory
-000047a0: 206d 6574 7269 6373 2066 6f72 2074 6865   metrics for the
-000047b0: 2077 6f72 6b65 722e 0a0a 2020 2020 2020   worker...      
-000047c0: 2020 2a2a 4465 7369 676e 206e 6f74 6520    **Design note 
-000047d0: 6f6e 206d 616e 6167 6564 206d 656d 6f72  on managed memor
-000047e0: 792a 2a0a 0a20 2020 2020 2020 2054 6865  y**..        The
-000047f0: 7265 2061 7265 2074 776f 206d 6561 7375  re are two measu
-00004800: 7265 7320 6176 6169 6c61 626c 6520 666f  res available fo
-00004810: 7220 6d61 6e61 6765 6420 6d65 6d6f 7279  r managed memory
-00004820: 3a0a 0a20 2020 2020 2020 202d 2060 6073  :..        - ``s
-00004830: 656c 662e 6e62 7974 6573 6060 0a20 2020  elf.nbytes``.   
-00004840: 2020 2020 202d 2060 6073 656c 662e 6d65       - ``self.me
-00004850: 7472 6963 735b 226d 616e 6167 6564 5f62  trics["managed_b
-00004860: 7974 6573 225d 6060 0a0a 2020 2020 2020  ytes"]``..      
-00004870: 2020 4174 2072 6573 742c 2074 6865 2074    At rest, the t
-00004880: 776f 206e 756d 6265 7273 206d 7573 7420  wo numbers must 
-00004890: 6265 2069 6465 6e74 6963 616c 2e20 486f  be identical. Ho
-000048a0: 7765 7665 722c 2060 6073 656c 662e 6e62  wever, ``self.nb
-000048b0: 7974 6573 6060 2069 730a 2020 2020 2020  ytes`` is.      
-000048c0: 2020 696d 6d65 6469 6174 656c 7920 7570    immediately up
-000048d0: 6461 7465 6420 7468 726f 7567 6820 7468  dated through th
-000048e0: 6520 6261 7463 6865 6420 636f 6d6d 7320  e batched comms 
-000048f0: 6173 2073 6f6f 6e20 6173 2065 6163 6820  as soon as each 
-00004900: 7461 736b 206c 616e 6473 2069 6e0a 2020  task lands in.  
-00004910: 2020 2020 2020 6d65 6d6f 7279 206f 6e20        memory on 
-00004920: 7468 6520 776f 726b 6572 3b20 6060 7365  the worker; ``se
-00004930: 6c66 2e6d 6574 7269 6373 5b22 6d61 6e61  lf.metrics["mana
-00004940: 6765 645f 6279 7465 7322 5d60 6020 696e  ged_bytes"]`` in
-00004950: 7374 6561 6420 6973 2075 7064 6174 6564  stead is updated
-00004960: 2062 790a 2020 2020 2020 2020 7468 6520   by.        the 
-00004970: 6865 6172 7462 6561 742c 2077 6869 6368  heartbeat, which
-00004980: 2063 616e 206c 6167 2073 6576 6572 616c   can lag several
-00004990: 2073 6563 6f6e 6473 2062 6568 696e 642e   seconds behind.
-000049a0: 0a0a 2020 2020 2020 2020 4265 6c6f 7720  ..        Below 
-000049b0: 7765 2061 7265 206d 6978 696e 6720 6c69  we are mixing li
-000049c0: 6b65 6c79 206e 6577 6572 206d 616e 6167  kely newer manag
-000049d0: 6564 206d 656d 6f72 7920 696e 666f 2066  ed memory info f
-000049e0: 726f 6d20 6060 7365 6c66 2e6e 6279 7465  rom ``self.nbyte
-000049f0: 7360 6020 7769 7468 0a20 2020 2020 2020  s`` with.       
-00004a00: 2070 726f 6365 7373 2061 6e64 2073 7069   process and spi
-00004a10: 6c6c 6564 206d 656d 6f72 7920 6672 6f6d  lled memory from
-00004a20: 2074 6865 2068 6561 7274 6265 6174 2e20   the heartbeat. 
-00004a30: 5468 6973 2069 7320 6465 6c69 6265 7261  This is delibera
-00004a40: 7465 2c20 736f 2074 6861 740a 2020 2020  te, so that.    
-00004a50: 2020 2020 6d61 6e61 6765 6420 6d65 6d6f      managed memo
-00004a60: 7279 2074 6f74 616c 2069 7320 7570 6461  ry total is upda
-00004a70: 7465 6420 6d6f 7265 2066 7265 7175 656e  ted more frequen
-00004a80: 746c 792e 0a0a 2020 2020 2020 2020 4d61  tly...        Ma
-00004a90: 6e61 6765 6420 6d65 6d6f 7279 2064 6972  naged memory dir
-00004aa0: 6563 746c 7920 616e 6420 696d 6d65 6469  ectly and immedi
-00004ab0: 6174 656c 7920 636f 6e74 7269 6275 7465  ately contribute
-00004ac0: 7320 746f 206f 7074 696d 6973 7469 6320  s to optimistic 
-00004ad0: 6d65 6d6f 7279 2c20 7768 6963 680a 2020  memory, which.  
-00004ae0: 2020 2020 2020 6973 2069 6e20 7475 726e        is in turn
-00004af0: 2075 7365 6420 696e 2041 6374 6976 6520   used in Active 
-00004b00: 4d65 6d6f 7279 204d 616e 6167 6572 2068  Memory Manager h
-00004b10: 6575 7269 7374 6963 7320 2861 7420 7468  euristics (at th
-00004b20: 6520 6d6f 6d65 6e74 206f 6620 7772 6974  e moment of writ
-00004b30: 696e 673b 0a20 2020 2020 2020 206d 6f72  ing;.        mor
-00004b40: 6520 7573 6573 2077 696c 6c20 6c69 6b65  e uses will like
-00004b50: 6c79 2062 6520 6164 6465 6420 696e 2074  ly be added in t
-00004b60: 6865 2066 7574 7572 6529 2e20 536f 2069  he future). So i
-00004b70: 7427 7320 696d 706f 7274 616e 7420 746f  t's important to
-00004b80: 2068 6176 6520 6974 0a20 2020 2020 2020   have it.       
-00004b90: 2075 7020 746f 2064 6174 653b 206d 7563   up to date; muc
-00004ba0: 6820 6d6f 7265 2074 6861 6e20 6974 2069  h more than it i
-00004bb0: 7320 666f 7220 7072 6f63 6573 7320 6d65  s for process me
-00004bc0: 6d6f 7279 2e0a 0a20 2020 2020 2020 2048  mory...        H
-00004bd0: 6176 696e 6720 7570 2d74 6f2d 6461 7465  aving up-to-date
-00004be0: 206d 616e 6167 6564 206d 656d 6f72 7920   managed memory 
-00004bf0: 696e 666f 2061 7320 736f 6f6e 2061 7320  info as soon as 
-00004c00: 7468 6520 7363 6865 6475 6c65 7220 6c65  the scheduler le
-00004c10: 6172 6e73 2061 626f 7574 0a20 2020 2020  arns about.     
-00004c20: 2020 2074 6173 6b20 636f 6d70 6c65 7469     task completi
-00004c30: 6f6e 2061 6c73 6f20 7375 6273 7461 6e74  on also substant
-00004c40: 6961 6c6c 7920 7369 6d70 6c69 6669 6573  ially simplifies
-00004c50: 2075 6e69 7420 7465 7374 732e 0a0a 2020   unit tests...  
-00004c60: 2020 2020 2020 5468 6520 666c 6970 2073        The flip s
-00004c70: 6964 6520 6f66 2074 6869 7320 6465 7369  ide of this desi
-00004c80: 676e 2069 7320 7468 6174 2069 7420 6d61  gn is that it ma
-00004c90: 7920 6361 7573 6520 736f 6d65 206e 6f69  y cause some noi
-00004ca0: 7365 2069 6e20 7468 650a 2020 2020 2020  se in the.      
-00004cb0: 2020 756e 6d61 6e61 6765 645f 7265 6365    unmanaged_rece
-00004cc0: 6e74 206d 6561 7375 7265 2e20 652e 672e  nt measure. e.g.
-00004cd0: 3a0a 0a20 2020 2020 2020 2031 2e20 4465  :..        1. De
-00004ce0: 6c65 7465 2031 3030 4d42 206f 6620 6d61  lete 100MB of ma
-00004cf0: 6e61 6765 6420 6461 7461 0a20 2020 2020  naged data.     
-00004d00: 2020 2032 2e20 5468 6520 7570 6461 7465     2. The update
-00004d10: 6420 6d61 6e61 6765 6420 6d65 6d6f 7279  d managed memory
-00004d20: 2072 6561 6368 6573 2074 6865 2073 6368   reaches the sch
-00004d30: 6564 756c 6572 2066 6173 7465 7220 7468  eduler faster th
-00004d40: 616e 2074 6865 0a20 2020 2020 2020 2020  an the.         
-00004d50: 2020 7570 6461 7465 6420 7072 6f63 6573    updated proces
-00004d60: 7320 6d65 6d6f 7279 0a20 2020 2020 2020  s memory.       
-00004d70: 2033 2e20 5468 6572 6527 7320 6120 626c   3. There's a bl
-00004d80: 6970 2077 6865 7265 2074 6865 2073 6368  ip where the sch
-00004d90: 6564 756c 6572 2074 6869 6e6b 7320 7468  eduler thinks th
-00004da0: 6174 2074 6865 7265 2773 2061 2073 7564  at there's a sud
-00004db0: 6465 6e20 3130 304d 420a 2020 2020 2020  den 100MB.      
-00004dc0: 2020 2020 2069 6e63 7265 6173 6520 696e       increase in
-00004dd0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
-00004de0: 742c 2073 696e 6365 2070 726f 6365 7373  t, since process
-00004df0: 206d 656d 6f72 7920 6861 736e 2774 2063   memory hasn't c
-00004e00: 6861 6e67 6564 2062 7574 206d 616e 6167  hanged but manag
-00004e10: 6564 0a20 2020 2020 2020 2020 2020 6d65  ed.           me
-00004e20: 6d6f 7279 2068 6173 2064 6563 7265 6173  mory has decreas
-00004e30: 6564 2062 7920 3130 304d 420a 2020 2020  ed by 100MB.    
-00004e40: 2020 2020 342e 2057 6865 6e20 7468 6520      4. When the 
-00004e50: 6865 6172 7462 6561 7420 6172 7269 7665  heartbeat arrive
-00004e60: 732c 2070 726f 6365 7373 206d 656d 6f72  s, process memor
-00004e70: 7920 676f 6573 2064 6f77 6e20 616e 6420  y goes down and 
-00004e80: 736f 2064 6f65 7320 7468 650a 2020 2020  so does the.    
-00004e90: 2020 2020 2020 2075 6e6d 616e 6167 6564         unmanaged
-00004ea0: 5f72 6563 656e 742e 0a0a 2020 2020 2020  _recent...      
-00004eb0: 2020 5468 6973 2069 7320 4f4b 202d 206f    This is OK - o
-00004ec0: 6e65 206f 6620 7468 6520 6d61 696e 2072  ne of the main r
-00004ed0: 6561 736f 6e73 2066 6f72 2074 6865 2075  easons for the u
-00004ee0: 6e6d 616e 6167 6564 5f72 6563 656e 7420  nmanaged_recent 
-00004ef0: 2f20 756e 6d61 6e61 6765 645f 6f6c 640a  / unmanaged_old.
-00004f00: 2020 2020 2020 2020 7370 6c69 7420 6973          split is
-00004f10: 2065 7861 6374 6c79 2074 6f20 636f 6e63   exactly to conc
-00004f20: 656e 7472 6174 6520 616c 6c20 7468 6520  entrate all the 
-00004f30: 6e6f 6973 6520 696e 2075 6e6d 616e 6167  noise in unmanag
-00004f40: 6564 5f72 6563 656e 7420 616e 6420 6578  ed_recent and ex
-00004f50: 636c 7564 6520 6974 0a20 2020 2020 2020  clude it.       
-00004f60: 2066 726f 6d20 6f70 7469 6d69 7374 6963   from optimistic
-00004f70: 206d 656d 6f72 792c 2077 6869 6368 2069   memory, which i
-00004f80: 7320 7573 6564 2066 6f72 2068 6575 7269  s used for heuri
-00004f90: 7374 6963 732e 0a0a 2020 2020 2020 2020  stics...        
-00004fa0: 536f 6d65 7468 696e 6720 7468 6174 2069  Something that i
-00004fb0: 7320 6c65 7373 204f 4b2c 2062 7574 2061  s less OK, but a
-00004fc0: 6c73 6f20 6c65 7373 2066 7265 7175 656e  lso less frequen
-00004fd0: 742c 2069 7320 7468 6174 2074 6865 2073  t, is that the s
-00004fe0: 7564 6465 6e20 6465 6c65 7469 6f6e 0a20  udden deletion. 
-00004ff0: 2020 2020 2020 206f 6620 7370 696c 6c65         of spille
-00005000: 6420 6b65 7973 2077 696c 6c20 6361 7573  d keys will caus
-00005010: 6520 6120 6e65 6761 7469 7665 2062 6c69  e a negative bli
-00005020: 7020 696e 206d 616e 6167 6564 206d 656d  p in managed mem
-00005030: 6f72 793a 0a0a 2020 2020 2020 2020 312e  ory:..        1.
-00005040: 2044 656c 6574 6520 3130 304d 4220 6f66   Delete 100MB of
-00005050: 2073 7069 6c6c 6564 2064 6174 610a 2020   spilled data.  
-00005060: 2020 2020 2020 322e 2054 6865 2075 7064        2. The upd
-00005070: 6174 6564 206d 616e 6167 6564 206d 656d  ated managed mem
-00005080: 6f72 7920 2a74 6f74 616c 2a20 7265 6163  ory *total* reac
-00005090: 6865 7320 7468 6520 7363 6865 6475 6c65  hes the schedule
-000050a0: 7220 6661 7374 6572 2074 6861 6e20 7468  r faster than th
-000050b0: 650a 2020 2020 2020 2020 2020 2075 7064  e.           upd
-000050c0: 6174 6564 2073 7069 6c6c 6564 2070 6f72  ated spilled por
-000050d0: 7469 6f6e 0a20 2020 2020 2020 2033 2e20  tion.        3. 
-000050e0: 5468 6973 2063 6175 7365 7320 7468 6520  This causes the 
-000050f0: 6d61 6e61 6765 6420 6d65 6d6f 7279 2074  managed memory t
-00005100: 6f20 7465 6d70 6f72 6172 696c 7920 706c  o temporarily pl
-00005110: 756d 6d65 7420 616e 6420 6265 2072 6570  ummet and be rep
-00005120: 6c61 6365 6420 6279 0a20 2020 2020 2020  laced by.       
-00005130: 2020 2020 756e 6d61 6e61 6765 645f 7265      unmanaged_re
-00005140: 6365 6e74 2c20 7768 696c 6520 7370 696c  cent, while spil
-00005150: 6c65 6420 6d65 6d6f 7279 2072 656d 6169  led memory remai
-00005160: 6e73 2075 6e61 6c74 6572 6564 0a20 2020  ns unaltered.   
-00005170: 2020 2020 2034 2e20 5768 656e 2074 6865       4. When the
-00005180: 2068 6561 7274 6265 6174 2061 7272 6976   heartbeat arriv
-00005190: 6573 2c20 6d61 6e61 6765 6420 676f 6573  es, managed goes
-000051a0: 2062 6163 6b20 7570 2c20 756e 6d61 6e61   back up, unmana
-000051b0: 6765 645f 7265 6365 6e74 0a20 2020 2020  ged_recent.     
-000051c0: 2020 2020 2020 676f 6573 2062 6163 6b20        goes back 
-000051d0: 646f 776e 2c20 616e 6420 7370 696c 6c65  down, and spille
-000051e0: 6420 676f 6573 2064 6f77 6e20 6279 2031  d goes down by 1
-000051f0: 3030 4d42 2061 7320 6974 2073 686f 756c  00MB as it shoul
-00005200: 6420 6861 7665 2074 6f0a 2020 2020 2020  d have to.      
-00005210: 2020 2020 2062 6567 696e 2077 6974 682e       begin with.
-00005220: 0a0a 2020 2020 2020 2020 3a69 7373 7565  ..        :issue
-00005230: 3a60 3630 3032 6020 7769 6c6c 206c 6574  :`6002` will let
-00005240: 2075 7320 736f 6c76 6520 7468 6973 2e0a   us solve this..
-00005250: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00005260: 2020 2020 7265 7475 726e 204d 656d 6f72      return Memor
-00005270: 7953 7461 7465 280a 2020 2020 2020 2020  yState(.        
-00005280: 2020 2020 7072 6f63 6573 733d 7365 6c66      process=self
-00005290: 2e6d 6574 7269 6373 5b22 6d65 6d6f 7279  .metrics["memory
-000052a0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-000052b0: 6d61 6e61 6765 643d 6d61 7828 302c 2073  managed=max(0, s
-000052c0: 656c 662e 6e62 7974 6573 202d 2073 656c  elf.nbytes - sel
-000052d0: 662e 6d65 7472 6963 735b 2273 7069 6c6c  f.metrics["spill
-000052e0: 6564 5f62 7974 6573 225d 5b22 6d65 6d6f  ed_bytes"]["memo
-000052f0: 7279 225d 292c 0a20 2020 2020 2020 2020  ry"]),.         
-00005300: 2020 2073 7069 6c6c 6564 3d73 656c 662e     spilled=self.
-00005310: 6d65 7472 6963 735b 2273 7069 6c6c 6564  metrics["spilled
-00005320: 5f62 7974 6573 225d 5b22 6469 736b 225d  _bytes"]["disk"]
-00005330: 2c0a 2020 2020 2020 2020 2020 2020 756e  ,.            un
-00005340: 6d61 6e61 6765 645f 6f6c 643d 7365 6c66  managed_old=self
-00005350: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
-00005360: 6564 5f6f 6c64 2c0a 2020 2020 2020 2020  ed_old,.        
-00005370: 290a 0a20 2020 2064 6566 2063 6c65 616e  )..    def clean
-00005380: 2873 656c 6629 202d 3e20 576f 726b 6572  (self) -> Worker
-00005390: 5374 6174 653a 0a20 2020 2020 2020 2022  State:.        "
-000053a0: 2222 5265 7475 726e 2061 2076 6572 7369  ""Return a versi
-000053b0: 6f6e 206f 6620 7468 6973 206f 626a 6563  on of this objec
-000053c0: 7420 7468 6174 2069 7320 6170 7072 6f70  t that is approp
-000053d0: 7269 6174 6520 666f 7220 7365 7269 616c  riate for serial
-000053e0: 697a 6174 696f 6e22 2222 0a20 2020 2020  ization""".     
-000053f0: 2020 2077 7320 3d20 576f 726b 6572 5374     ws = WorkerSt
-00005400: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
-00005410: 2061 6464 7265 7373 3d73 656c 662e 6164   address=self.ad
-00005420: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
-00005430: 2020 2073 7461 7475 733d 7365 6c66 2e73     status=self.s
-00005440: 7461 7475 732c 0a20 2020 2020 2020 2020  tatus,.         
-00005450: 2020 2070 6964 3d73 656c 662e 7069 642c     pid=self.pid,
-00005460: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00005470: 653d 7365 6c66 2e6e 616d 652c 0a20 2020  e=self.name,.   
-00005480: 2020 2020 2020 2020 206e 7468 7265 6164           nthread
-00005490: 733d 7365 6c66 2e6e 7468 7265 6164 732c  s=self.nthreads,
-000054a0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-000054b0: 6f72 795f 6c69 6d69 743d 7365 6c66 2e6d  ory_limit=self.m
-000054c0: 656d 6f72 795f 6c69 6d69 742c 0a20 2020  emory_limit,.   
-000054d0: 2020 2020 2020 2020 206c 6f63 616c 5f64           local_d
-000054e0: 6972 6563 746f 7279 3d73 656c 662e 6c6f  irectory=self.lo
-000054f0: 6361 6c5f 6469 7265 6374 6f72 792c 0a20  cal_directory,. 
-00005500: 2020 2020 2020 2020 2020 2073 6572 7669             servi
-00005510: 6365 733d 7365 6c66 2e73 6572 7669 6365  ces=self.service
-00005520: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
-00005530: 616e 6e79 3d73 656c 662e 6e61 6e6e 792c  anny=self.nanny,
-00005540: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
-00005550: 7261 3d73 656c 662e 6578 7472 612c 0a20  ra=self.extra,. 
-00005560: 2020 2020 2020 2020 2020 2073 6572 7665             serve
-00005570: 725f 6964 3d73 656c 662e 7365 7276 6572  r_id=self.server
-00005580: 5f69 642c 0a20 2020 2020 2020 2029 0a20  _id,.        ). 
-00005590: 2020 2020 2020 2077 732e 5f6f 6363 7570         ws._occup
-000055a0: 616e 6379 5f63 6163 6865 203d 2073 656c  ancy_cache = sel
-000055b0: 662e 6f63 6375 7061 6e63 790a 0a20 2020  f.occupancy..   
-000055c0: 2020 2020 2077 732e 6578 6563 7574 696e       ws.executin
-000055d0: 6720 3d20 7b0a 2020 2020 2020 2020 2020  g = {.          
-000055e0: 2020 7473 2e6b 6579 3a20 6475 7261 7469    ts.key: durati
-000055f0: 6f6e 2066 6f72 2074 732c 2064 7572 6174  on for ts, durat
-00005600: 696f 6e20 696e 2073 656c 662e 6578 6563  ion in self.exec
-00005610: 7574 696e 672e 6974 656d 7328 2920 2023  uting.items()  #
-00005620: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-00005630: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00005640: 7265 7475 726e 2077 730a 0a20 2020 2064  return ws..    d
-00005650: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
-00005660: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-00005670: 2020 6e61 6d65 203d 2066 222c 206e 616d    name = f", nam
-00005680: 653a 207b 7365 6c66 2e6e 616d 657d 2220  e: {self.name}" 
-00005690: 6966 2073 656c 662e 6e61 6d65 2021 3d20  if self.name != 
-000056a0: 7365 6c66 2e61 6464 7265 7373 2065 6c73  self.address els
-000056b0: 6520 2222 0a20 2020 2020 2020 2072 6574  e "".        ret
-000056c0: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
-000056d0: 2020 6622 3c57 6f72 6b65 7253 7461 7465    f"<WorkerState
-000056e0: 207b 7365 6c66 2e61 6464 7265 7373 2172   {self.address!r
-000056f0: 7d7b 6e61 6d65 7d2c 2022 0a20 2020 2020  }{name}, ".     
-00005700: 2020 2020 2020 2066 2273 7461 7475 733a         f"status:
-00005710: 207b 7365 6c66 2e73 7461 7475 732e 6e61   {self.status.na
-00005720: 6d65 7d2c 2022 0a20 2020 2020 2020 2020  me}, ".         
-00005730: 2020 2066 226d 656d 6f72 793a 207b 6c65     f"memory: {le
-00005740: 6e28 7365 6c66 2e68 6173 5f77 6861 7429  n(self.has_what)
-00005750: 7d2c 2022 0a20 2020 2020 2020 2020 2020  }, ".           
-00005760: 2066 2270 726f 6365 7373 696e 673a 207b   f"processing: {
-00005770: 6c65 6e28 7365 6c66 2e70 726f 6365 7373  len(self.process
-00005780: 696e 6729 7d3e 220a 2020 2020 2020 2020  ing)}>".        
-00005790: 290a 0a20 2020 2064 6566 205f 7265 7072  )..    def _repr
-000057a0: 5f68 746d 6c5f 2873 656c 6629 202d 3e20  _html_(self) -> 
-000057b0: 7374 723a 0a20 2020 2020 2020 2072 6574  str:.        ret
-000057c0: 7572 6e20 6765 745f 7465 6d70 6c61 7465  urn get_template
-000057d0: 2822 776f 726b 6572 5f73 7461 7465 2e68  ("worker_state.h
-000057e0: 746d 6c2e 6a32 2229 2e72 656e 6465 7228  tml.j2").render(
-000057f0: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
-00005800: 7265 7373 3d73 656c 662e 6164 6472 6573  ress=self.addres
-00005810: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
-00005820: 616d 653d 7365 6c66 2e6e 616d 652c 0a20  ame=self.name,. 
-00005830: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00005840: 733d 7365 6c66 2e73 7461 7475 732e 6e61  s=self.status.na
-00005850: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00005860: 6861 735f 7768 6174 3d73 656c 662e 6861  has_what=self.ha
-00005870: 735f 7768 6174 2c0a 2020 2020 2020 2020  s_what,.        
-00005880: 2020 2020 7072 6f63 6573 7369 6e67 3d73      processing=s
-00005890: 656c 662e 7072 6f63 6573 7369 6e67 2c0a  elf.processing,.
-000058a0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-000058b0: 6566 2069 6465 6e74 6974 7928 7365 6c66  ef identity(self
-000058c0: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
-000058d0: 6e79 5d3a 0a20 2020 2020 2020 2072 6574  ny]:.        ret
-000058e0: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
-000058f0: 2020 2274 7970 6522 3a20 2257 6f72 6b65    "type": "Worke
-00005900: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
-00005910: 2269 6422 3a20 7365 6c66 2e6e 616d 652c  "id": self.name,
-00005920: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-00005930: 7374 223a 2073 656c 662e 686f 7374 2c0a  st": self.host,.
-00005940: 2020 2020 2020 2020 2020 2020 2272 6573              "res
-00005950: 6f75 7263 6573 223a 2073 656c 662e 7265  ources": self.re
-00005960: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
-00005970: 2020 2020 2022 6c6f 6361 6c5f 6469 7265       "local_dire
-00005980: 6374 6f72 7922 3a20 7365 6c66 2e6c 6f63  ctory": self.loc
-00005990: 616c 5f64 6972 6563 746f 7279 2c0a 2020  al_directory,.  
-000059a0: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
-000059b0: 3a20 7365 6c66 2e6e 616d 652c 0a20 2020  : self.name,.   
-000059c0: 2020 2020 2020 2020 2022 6e74 6872 6561           "nthrea
-000059d0: 6473 223a 2073 656c 662e 6e74 6872 6561  ds": self.nthrea
-000059e0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
-000059f0: 226d 656d 6f72 795f 6c69 6d69 7422 3a20  "memory_limit": 
-00005a00: 7365 6c66 2e6d 656d 6f72 795f 6c69 6d69  self.memory_limi
-00005a10: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
-00005a20: 6c61 7374 5f73 6565 6e22 3a20 7365 6c66  last_seen": self
-00005a30: 2e6c 6173 745f 7365 656e 2c0a 2020 2020  .last_seen,.    
-00005a40: 2020 2020 2020 2020 2273 6572 7669 6365          "service
-00005a50: 7322 3a20 7365 6c66 2e73 6572 7669 6365  s": self.service
-00005a60: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-00005a70: 6d65 7472 6963 7322 3a20 7365 6c66 2e6d  metrics": self.m
-00005a80: 6574 7269 6373 2c0a 2020 2020 2020 2020  etrics,.        
-00005a90: 2020 2020 2273 7461 7475 7322 3a20 7365      "status": se
-00005aa0: 6c66 2e73 7461 7475 732e 6e61 6d65 2c0a  lf.status.name,.
-00005ab0: 2020 2020 2020 2020 2020 2020 226e 616e              "nan
-00005ac0: 6e79 223a 2073 656c 662e 6e61 6e6e 792c  ny": self.nanny,
-00005ad0: 0a20 2020 2020 2020 2020 2020 202a 2a73  .            **s
-00005ae0: 656c 662e 6578 7472 612c 0a20 2020 2020  elf.extra,.     
-00005af0: 2020 207d 0a0a 2020 2020 6465 6620 5f74     }..    def _t
-00005b00: 6f5f 6469 6374 5f6e 6f5f 6e65 7374 2873  o_dict_no_nest(s
-00005b10: 656c 662c 202a 2c20 6578 636c 7564 653a  elf, *, exclude:
-00005b20: 2043 6f6e 7461 696e 6572 5b73 7472 5d20   Container[str] 
-00005b30: 3d20 2829 2920 2d3e 2064 6963 745b 7374  = ()) -> dict[st
-00005b40: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
-00005b50: 2022 2222 4469 6374 696f 6e61 7279 2072   """Dictionary r
-00005b60: 6570 7265 7365 6e74 6174 696f 6e20 666f  epresentation fo
-00005b70: 7220 6465 6275 6767 696e 6720 7075 7270  r debugging purp
-00005b80: 6f73 6573 2e0a 2020 2020 2020 2020 4e6f  oses..        No
-00005b90: 7420 7479 7065 2073 7461 626c 6520 616e  t type stable an
-00005ba0: 6420 6e6f 7420 696e 7465 6e64 6564 2066  d not intended f
-00005bb0: 6f72 2072 6f75 6e64 7472 6970 732e 0a0a  or roundtrips...
-00005bc0: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-00005bd0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00005be0: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
-00005bf0: 2e64 756d 705f 636c 7573 7465 725f 7374  .dump_cluster_st
-00005c00: 6174 650a 2020 2020 2020 2020 6469 7374  ate.        dist
-00005c10: 7269 6275 7465 642e 7574 696c 732e 7265  ributed.utils.re
-00005c20: 6375 7273 6976 655f 746f 5f64 6963 740a  cursive_to_dict.
-00005c30: 2020 2020 2020 2020 5461 736b 5374 6174          TaskStat
-00005c40: 652e 5f74 6f5f 6469 6374 0a20 2020 2020  e._to_dict.     
-00005c50: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00005c60: 6574 7572 6e20 7265 6375 7273 6976 655f  eturn recursive_
-00005c70: 746f 5f64 6963 7428 0a20 2020 2020 2020  to_dict(.       
-00005c80: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00005c90: 2020 2020 2020 2065 7863 6c75 6465 3d73         exclude=s
-00005ca0: 6574 2865 7863 6c75 6465 2920 7c20 7b22  et(exclude) | {"
-00005cb0: 7665 7273 696f 6e73 227d 2c20 2023 2074  versions"},  # t
-00005cc0: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00005cd0: 2020 2020 2020 2020 6d65 6d62 6572 733d          members=
-00005ce0: 5472 7565 2c0a 2020 2020 2020 2020 290a  True,.        ).
-00005cf0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00005d00: 2020 2064 6566 2073 6368 6564 756c 6572     def scheduler
-00005d10: 2873 656c 6629 202d 3e20 5363 6865 6475  (self) -> Schedu
-00005d20: 6c65 7253 7461 7465 3a0a 2020 2020 2020  lerState:.      
-00005d30: 2020 6173 7365 7274 2073 656c 662e 7363    assert self.sc
-00005d40: 6865 6475 6c65 725f 7265 660a 2020 2020  heduler_ref.    
-00005d50: 2020 2020 7320 3d20 7365 6c66 2e73 6368      s = self.sch
-00005d60: 6564 756c 6572 5f72 6566 2829 0a20 2020  eduler_ref().   
-00005d70: 2020 2020 2061 7373 6572 7420 730a 2020       assert s.  
-00005d80: 2020 2020 2020 7265 7475 726e 2073 0a0a        return s..
-00005d90: 2020 2020 6465 6620 6164 645f 746f 5f70      def add_to_p
-00005da0: 726f 6365 7373 696e 6728 7365 6c66 2c20  rocessing(self, 
-00005db0: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
-00005dc0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00005dd0: 2222 2241 7373 6967 6e20 6120 7461 736b  """Assign a task
-00005de0: 2074 6f20 7468 6973 2077 6f72 6b65 7220   to this worker 
-00005df0: 666f 7220 636f 6d70 7574 652e 2222 220a  for compute.""".
-00005e00: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00005e10: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
-00005e20: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00005e30: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
-00005e40: 2073 656c 662e 7072 6f63 6573 7369 6e67   self.processing
-00005e50: 0a0a 2020 2020 2020 2020 7470 203d 2074  ..        tp = t
-00005e60: 732e 7072 6566 6978 0a20 2020 2020 2020  s.prefix.       
-00005e70: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-00005e80: 785f 636f 756e 745b 7470 2e6e 616d 655d  x_count[tp.name]
-00005e90: 202b 3d20 310a 2020 2020 2020 2020 7365   += 1.        se
-00005ea0: 6c66 2e73 6368 6564 756c 6572 2e5f 7461  lf.scheduler._ta
-00005eb0: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
-00005ec0: 676c 6f62 616c 5b74 702e 6e61 6d65 5d20  global[tp.name] 
-00005ed0: 2b3d 2031 0a20 2020 2020 2020 2073 656c  += 1.        sel
-00005ee0: 662e 7072 6f63 6573 7369 6e67 2e61 6464  f.processing.add
-00005ef0: 2874 7329 0a20 2020 2020 2020 2066 6f72  (ts).        for
-00005f00: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-00005f10: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-00005f20: 2020 2020 2069 6620 7365 6c66 206e 6f74       if self not
-00005f30: 2069 6e20 6474 732e 7768 6f5f 6861 733a   in dts.who_has:
-00005f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005f50: 2073 656c 662e 5f69 6e63 5f6e 6565 6473   self._inc_needs
-00005f60: 5f72 6570 6c69 6361 2864 7473 290a 0a20  _replica(dts).. 
-00005f70: 2020 2064 6566 2061 6464 5f74 6f5f 6c6f     def add_to_lo
-00005f80: 6e67 5f72 756e 6e69 6e67 2873 656c 662c  ng_running(self,
-00005f90: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
-00005fa0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00005fb0: 2069 6620 7365 6c66 2e73 6368 6564 756c   if self.schedul
-00005fc0: 6572 2e76 616c 6964 6174 653a 0a20 2020  er.validate:.   
-00005fd0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00005fe0: 7473 2069 6e20 7365 6c66 2e70 726f 6365  ts in self.proce
-00005ff0: 7373 696e 670a 2020 2020 2020 2020 2020  ssing.          
-00006000: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
-00006010: 696e 2073 656c 662e 6c6f 6e67 5f72 756e  in self.long_run
-00006020: 6e69 6e67 0a0a 2020 2020 2020 2020 7365  ning..        se
-00006030: 6c66 2e5f 7265 6d6f 7665 5f66 726f 6d5f  lf._remove_from_
-00006040: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
-00006050: 7428 7473 290a 2020 2020 2020 2020 2320  t(ts).        # 
-00006060: 4361 6e6e 6f74 2072 656d 6f76 6520 6672  Cannot remove fr
-00006070: 6f6d 2070 726f 6365 7373 696e 6720 7369  om processing si
-00006080: 6e63 6520 7765 2772 6520 7573 696e 6720  nce we're using 
-00006090: 7468 6973 2066 6f72 2074 6869 6e67 7320  this for things 
-000060a0: 6c69 6b65 0a20 2020 2020 2020 2023 2069  like.        # i
-000060b0: 646c 656e 6573 7320 6465 7465 6374 696f  dleness detectio
-000060c0: 6e2e 2049 646c 6520 776f 726b 6572 7320  n. Idle workers 
-000060d0: 6172 6520 7479 7069 6361 6c6c 7920 7461  are typically ta
-000060e0: 7267 6574 6564 2066 6f72 0a20 2020 2020  rgeted for.     
-000060f0: 2020 2023 2064 6f77 6e73 6361 6c69 6e67     # downscaling
-00006100: 2062 7574 2077 6520 7368 6f75 6c64 206e   but we should n
-00006110: 6f74 2064 6f77 6e73 6361 6c65 2077 6f72  ot downscale wor
-00006120: 6b65 7273 2077 6974 6820 6c6f 6e67 2072  kers with long r
-00006130: 756e 6e69 6e67 0a20 2020 2020 2020 2023  unning.        #
-00006140: 2074 6173 6b73 0a20 2020 2020 2020 2073   tasks.        s
-00006150: 656c 662e 6c6f 6e67 5f72 756e 6e69 6e67  elf.long_running
-00006160: 2e61 6464 2874 7329 0a0a 2020 2020 6465  .add(ts)..    de
-00006170: 6620 7265 6d6f 7665 5f66 726f 6d5f 7072  f remove_from_pr
-00006180: 6f63 6573 7369 6e67 2873 656c 662c 2074  ocessing(self, t
-00006190: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
-000061a0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-000061b0: 2222 5265 6d6f 7665 2061 2074 6173 6b20  ""Remove a task 
-000061c0: 6672 6f6d 2061 2077 6f72 6b65 7273 2070  from a workers p
-000061d0: 726f 6365 7373 696e 6722 2222 0a20 2020  rocessing""".   
-000061e0: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
-000061f0: 6564 756c 6572 2e76 616c 6964 6174 653a  eduler.validate:
-00006200: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00006210: 6572 7420 7473 2069 6e20 7365 6c66 2e70  ert ts in self.p
-00006220: 726f 6365 7373 696e 670a 0a20 2020 2020  rocessing..     
-00006230: 2020 2069 6620 7473 2069 6e20 7365 6c66     if ts in self
-00006240: 2e6c 6f6e 675f 7275 6e6e 696e 673a 0a20  .long_running:. 
-00006250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006260: 6c6f 6e67 5f72 756e 6e69 6e67 2e64 6973  long_running.dis
-00006270: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
-00006280: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00006290: 2020 2073 656c 662e 5f72 656d 6f76 655f     self._remove_
-000062a0: 6672 6f6d 5f74 6173 6b5f 7072 6566 6978  from_task_prefix
-000062b0: 5f63 6f75 6e74 2874 7329 0a20 2020 2020  _count(ts).     
-000062c0: 2020 2073 656c 662e 7072 6f63 6573 7369     self.processi
-000062d0: 6e67 2e72 656d 6f76 6528 7473 290a 2020  ng.remove(ts).  
-000062e0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-000062f0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-00006300: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00006310: 2064 7473 2069 6e20 7365 6c66 2e6e 6565   dts in self.nee
-00006320: 6473 5f77 6861 743a 0a20 2020 2020 2020  ds_what:.       
-00006330: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
-00006340: 6563 5f6e 6565 6473 5f72 6570 6c69 6361  ec_needs_replica
-00006350: 2864 7473 290a 0a20 2020 2064 6566 205f  (dts)..    def _
-00006360: 7265 6d6f 7665 5f66 726f 6d5f 7461 736b  remove_from_task
-00006370: 5f70 7265 6669 785f 636f 756e 7428 7365  _prefix_count(se
-00006380: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-00006390: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-000063a0: 2020 2020 636f 756e 7420 3d20 7365 6c66      count = self
-000063b0: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
-000063c0: 6e74 5b74 732e 7072 6566 6978 2e6e 616d  nt[ts.prefix.nam
-000063d0: 655d 202d 2031 0a20 2020 2020 2020 2069  e] - 1.        i
-000063e0: 6620 636f 756e 743a 0a20 2020 2020 2020  f count:.       
-000063f0: 2020 2020 2073 656c 662e 7461 736b 5f70       self.task_p
-00006400: 7265 6669 785f 636f 756e 745b 7473 2e70  refix_count[ts.p
-00006410: 7265 6669 782e 6e61 6d65 5d20 3d20 636f  refix.name] = co
-00006420: 756e 740a 2020 2020 2020 2020 656c 7365  unt.        else
-00006430: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-00006440: 6c20 7365 6c66 2e74 6173 6b5f 7072 6566  l self.task_pref
-00006450: 6978 5f63 6f75 6e74 5b74 732e 7072 6566  ix_count[ts.pref
-00006460: 6978 2e6e 616d 655d 0a0a 2020 2020 2020  ix.name]..      
-00006470: 2020 636f 756e 7420 3d20 7365 6c66 2e73    count = self.s
-00006480: 6368 6564 756c 6572 2e5f 7461 736b 5f70  cheduler._task_p
-00006490: 7265 6669 785f 636f 756e 745f 676c 6f62  refix_count_glob
-000064a0: 616c 5b74 732e 7072 6566 6978 2e6e 616d  al[ts.prefix.nam
-000064b0: 655d 202d 2031 0a20 2020 2020 2020 2069  e] - 1.        i
-000064c0: 6620 636f 756e 743a 0a20 2020 2020 2020  f count:.       
-000064d0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-000064e0: 6c65 722e 5f74 6173 6b5f 7072 6566 6978  ler._task_prefix
-000064f0: 5f63 6f75 6e74 5f67 6c6f 6261 6c5b 7473  _count_global[ts
-00006500: 2e70 7265 6669 782e 6e61 6d65 5d20 3d20  .prefix.name] = 
-00006510: 636f 756e 740a 2020 2020 2020 2020 656c  count.        el
-00006520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00006530: 6465 6c20 7365 6c66 2e73 6368 6564 756c  del self.schedul
-00006540: 6572 2e5f 7461 736b 5f70 7265 6669 785f  er._task_prefix_
-00006550: 636f 756e 745f 676c 6f62 616c 5b74 732e  count_global[ts.
-00006560: 7072 6566 6978 2e6e 616d 655d 0a0a 2020  prefix.name]..  
-00006570: 2020 6465 6620 7265 6d6f 7665 5f72 6570    def remove_rep
-00006580: 6c69 6361 2873 656c 662c 2074 733a 2054  lica(self, ts: T
-00006590: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
-000065a0: 653a 0a20 2020 2020 2020 2022 2222 5468  e:.        """Th
-000065b0: 6520 776f 726b 6572 206e 6f20 6c6f 6e67  e worker no long
-000065c0: 6572 2068 6173 2061 2074 6173 6b20 696e  er has a task in
-000065d0: 206d 656d 6f72 7922 2222 0a20 2020 2020   memory""".     
-000065e0: 2020 2069 6620 7365 6c66 2e73 6368 6564     if self.sched
-000065f0: 756c 6572 2e76 616c 6964 6174 653a 0a20  uler.validate:. 
-00006600: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00006610: 7420 7365 6c66 2069 6e20 7473 2e77 686f  t self in ts.who
-00006620: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
-00006630: 2061 7373 6572 7420 7473 2069 6e20 7365   assert ts in se
-00006640: 6c66 2e68 6173 5f77 6861 740a 2020 2020  lf.has_what.    
-00006650: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-00006660: 7320 6e6f 7420 696e 2073 656c 662e 6e65  s not in self.ne
-00006670: 6564 735f 7768 6174 0a0a 2020 2020 2020  eds_what..      
-00006680: 2020 7365 6c66 2e6e 6279 7465 7320 2d3d    self.nbytes -=
-00006690: 2074 732e 6765 745f 6e62 7974 6573 2829   ts.get_nbytes()
-000066a0: 0a20 2020 2020 2020 2064 656c 2073 656c  .        del sel
-000066b0: 662e 5f68 6173 5f77 6861 745b 7473 5d0a  f._has_what[ts].
-000066c0: 2020 2020 2020 2020 7473 2e77 686f 5f68          ts.who_h
-000066d0: 6173 2e72 656d 6f76 6528 7365 6c66 290a  as.remove(self).
-000066e0: 0a20 2020 2064 6566 205f 696e 635f 6e65  .    def _inc_ne
-000066f0: 6564 735f 7265 706c 6963 6128 7365 6c66  eds_replica(self
-00006700: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
-00006710: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00006720: 2020 2222 2241 7373 6967 6e20 6120 7461    """Assign a ta
-00006730: 736b 2066 6574 6368 2074 6f20 7468 6973  sk fetch to this
-00006740: 2077 6f72 6b65 7220 616e 6420 7570 6461   worker and upda
-00006750: 7465 206e 6574 776f 726b 206f 6363 7570  te network occup
-00006760: 616e 6369 6573 2222 220a 2020 2020 2020  ancies""".      
-00006770: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
-00006780: 6c65 722e 7661 6c69 6461 7465 3a0a 2020  ler.validate:.  
-00006790: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000067a0: 2073 656c 6620 6e6f 7420 696e 2074 732e   self not in ts.
-000067b0: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-000067c0: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
-000067d0: 7420 696e 2073 656c 662e 6861 735f 7768  t in self.has_wh
-000067e0: 6174 0a20 2020 2020 2020 2069 6620 7473  at.        if ts
-000067f0: 206e 6f74 2069 6e20 7365 6c66 2e6e 6565   not in self.nee
-00006800: 6473 5f77 6861 743a 0a20 2020 2020 2020  ds_what:.       
-00006810: 2020 2020 2073 656c 662e 6e65 6564 735f       self.needs_
-00006820: 7768 6174 5b74 735d 203d 2031 0a20 2020  what[ts] = 1.   
-00006830: 2020 2020 2020 2020 206e 6279 7465 7320           nbytes 
-00006840: 3d20 7473 2e67 6574 5f6e 6279 7465 7328  = ts.get_nbytes(
-00006850: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00006860: 6c66 2e5f 6e65 7477 6f72 6b5f 6f63 6320  lf._network_occ 
-00006870: 2b3d 206e 6279 7465 730a 2020 2020 2020  += nbytes.      
-00006880: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
-00006890: 756c 6572 2e5f 6e65 7477 6f72 6b5f 6f63  uler._network_oc
-000068a0: 635f 676c 6f62 616c 202b 3d20 6e62 7974  c_global += nbyt
-000068b0: 6573 0a20 2020 2020 2020 2065 6c73 653a  es.        else:
-000068c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000068d0: 662e 6e65 6564 735f 7768 6174 5b74 735d  f.needs_what[ts]
-000068e0: 202b 3d20 310a 0a20 2020 2064 6566 205f   += 1..    def _
-000068f0: 6465 635f 6e65 6564 735f 7265 706c 6963  dec_needs_replic
-00006900: 6128 7365 6c66 2c20 7473 3a20 5461 736b  a(self, ts: Task
-00006910: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00006920: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00006930: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
-00006940: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00006950: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
-00006960: 662e 6e65 6564 735f 7768 6174 0a0a 2020  f.needs_what..  
-00006970: 2020 2020 2020 7365 6c66 2e6e 6565 6473        self.needs
-00006980: 5f77 6861 745b 7473 5d20 2d3d 2031 0a20  _what[ts] -= 1. 
-00006990: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
-000069a0: 6565 6473 5f77 6861 745b 7473 5d20 3d3d  eeds_what[ts] ==
-000069b0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000069c0: 6465 6c20 7365 6c66 2e6e 6565 6473 5f77  del self.needs_w
-000069d0: 6861 745b 7473 5d0a 2020 2020 2020 2020  hat[ts].        
-000069e0: 2020 2020 6e62 7974 6573 203d 2074 732e      nbytes = ts.
-000069f0: 6765 745f 6e62 7974 6573 2829 0a20 2020  get_nbytes().   
-00006a00: 2020 2020 2020 2020 2073 656c 662e 5f6e           self._n
-00006a10: 6574 776f 726b 5f6f 6363 202d 3d20 6e62  etwork_occ -= nb
-00006a20: 7974 6573 0a20 2020 2020 2020 2020 2020  ytes.           
-00006a30: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-00006a40: 5f6e 6574 776f 726b 5f6f 6363 5f67 6c6f  _network_occ_glo
-00006a50: 6261 6c20 2d3d 206e 6279 7465 730a 0a20  bal -= nbytes.. 
-00006a60: 2020 2064 6566 2061 6464 5f72 6570 6c69     def add_repli
-00006a70: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
-00006a80: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
-00006a90: 0a20 2020 2020 2020 2022 2222 5468 6520  .        """The 
-00006aa0: 776f 726b 6572 2061 6371 7569 7265 6420  worker acquired 
-00006ab0: 6120 7265 706c 6963 6120 6f66 2074 6173  a replica of tas
-00006ac0: 6b22 2222 0a20 2020 2020 2020 2069 6620  k""".        if 
-00006ad0: 7365 6c66 2e73 6368 6564 756c 6572 2e76  self.scheduler.v
-00006ae0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00006af0: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
-00006b00: 206e 6f74 2069 6e20 7473 2e77 686f 5f68   not in ts.who_h
-00006b10: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
-00006b20: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
-00006b30: 7365 6c66 2e68 6173 5f77 6861 740a 0a20  self.has_what.. 
-00006b40: 2020 2020 2020 206e 6279 7465 7320 3d20         nbytes = 
-00006b50: 7473 2e67 6574 5f6e 6279 7465 7328 290a  ts.get_nbytes().
-00006b60: 2020 2020 2020 2020 6966 2074 7320 696e          if ts in
-00006b70: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
-00006b80: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-00006b90: 6c20 7365 6c66 2e6e 6565 6473 5f77 6861  l self.needs_wha
-00006ba0: 745b 7473 5d0a 2020 2020 2020 2020 2020  t[ts].          
-00006bb0: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
-00006bc0: 6f63 6320 2d3d 206e 6279 7465 730a 2020  occ -= nbytes.  
-00006bd0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00006be0: 6368 6564 756c 6572 2e5f 6e65 7477 6f72  cheduler._networ
-00006bf0: 6b5f 6f63 635f 676c 6f62 616c 202d 3d20  k_occ_global -= 
-00006c00: 6e62 7974 6573 0a20 2020 2020 2020 2074  nbytes.        t
-00006c10: 732e 7768 6f5f 6861 732e 6164 6428 7365  s.who_has.add(se
-00006c20: 6c66 290a 2020 2020 2020 2020 7365 6c66  lf).        self
-00006c30: 2e6e 6279 7465 7320 2b3d 206e 6279 7465  .nbytes += nbyte
-00006c40: 730a 2020 2020 2020 2020 7365 6c66 2e5f  s.        self._
-00006c50: 6861 735f 7768 6174 5b74 735d 203d 204e  has_what[ts] = N
-00006c60: 6f6e 650a 0a20 2020 2040 7072 6f70 6572  one..    @proper
-00006c70: 7479 0a20 2020 2064 6566 206f 6363 7570  ty.    def occup
-00006c80: 616e 6379 2873 656c 6629 202d 3e20 666c  ancy(self) -> fl
-00006c90: 6f61 743a 0a20 2020 2020 2020 2072 6574  oat:.        ret
-00006ca0: 7572 6e20 7365 6c66 2e5f 6f63 6375 7061  urn self._occupa
-00006cb0: 6e63 795f 6361 6368 6520 6f72 2073 656c  ncy_cache or sel
-00006cc0: 662e 7363 6865 6475 6c65 722e 5f63 616c  f.scheduler._cal
-00006cd0: 635f 6f63 6375 7061 6e63 7928 0a20 2020  c_occupancy(.   
-00006ce0: 2020 2020 2020 2020 2073 656c 662e 7461           self.ta
-00006cf0: 736b 5f70 7265 6669 785f 636f 756e 742c  sk_prefix_count,
-00006d00: 2073 656c 662e 5f6e 6574 776f 726b 5f6f   self._network_o
-00006d10: 6363 0a20 2020 2020 2020 2029 0a0a 0a40  cc.        )...@
-00006d20: 6461 7461 636c 6173 7365 732e 6461 7461  dataclasses.data
-00006d30: 636c 6173 730a 636c 6173 7320 4572 7265  class.class Erre
-00006d40: 6454 6173 6b3a 0a20 2020 2022 2222 4c69  dTask:.    """Li
-00006d50: 6768 7477 6569 6768 7420 7265 7072 6573  ghtweight repres
-00006d60: 656e 7461 7469 6f6e 206f 6620 616e 2065  entation of an e
-00006d70: 7272 6564 2074 6173 6b20 7769 7468 6f75  rred task withou
-00006d80: 7420 616e 7920 6465 7065 6e64 656e 6379  t any dependency
-00006d90: 2069 6e66 6f72 6d61 7469 6f6e 0a20 2020   information.   
-00006da0: 206f 7220 7275 6e73 7065 632e 0a0a 2020   or runspec...  
-00006db0: 2020 5365 6520 616c 736f 0a20 2020 202d    See also.    -
-00006dc0: 2d2d 2d2d 2d2d 2d0a 2020 2020 5461 736b  -------.    Task
-00006dd0: 5374 6174 650a 2020 2020 2222 220a 0a20  State.    """.. 
-00006de0: 2020 206b 6579 3a20 4861 7368 6162 6c65     key: Hashable
-00006df0: 0a20 2020 2074 696d 6573 7461 6d70 3a20  .    timestamp: 
-00006e00: 666c 6f61 740a 2020 2020 6572 7265 645f  float.    erred_
-00006e10: 6f6e 3a20 7365 745b 7374 725d 0a20 2020  on: set[str].   
-00006e20: 2065 7863 6570 7469 6f6e 5f74 6578 743a   exception_text:
-00006e30: 2073 7472 0a20 2020 2074 7261 6365 6261   str.    traceba
-00006e40: 636b 5f74 6578 743a 2073 7472 0a0a 0a63  ck_text: str...c
-00006e50: 6c61 7373 2043 6f6d 7075 7461 7469 6f6e  lass Computation
-00006e60: 3a0a 2020 2020 2222 2243 6f6c 6c65 6374  :.    """Collect
-00006e70: 696f 6e20 7472 6163 6b69 6e67 2061 2073  ion tracking a s
-00006e80: 696e 676c 6520 636f 6d70 7574 6520 6f72  ingle compute or
-00006e90: 2070 6572 7369 7374 2063 616c 6c0a 0a20   persist call.. 
-00006ea0: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-00006eb0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2054 6173  --------.    Tas
-00006ec0: 6b50 7265 6669 780a 2020 2020 5461 736b  kPrefix.    Task
-00006ed0: 4772 6f75 700a 2020 2020 5461 736b 5374  Group.    TaskSt
-00006ee0: 6174 650a 2020 2020 2222 220a 0a20 2020  ate.    """..   
-00006ef0: 2073 7461 7274 3a20 666c 6f61 740a 2020   start: float.  
-00006f00: 2020 6772 6f75 7073 3a20 7365 745b 5461    groups: set[Ta
-00006f10: 736b 4772 6f75 705d 0a20 2020 2063 6f64  skGroup].    cod
-00006f20: 653a 2053 6f72 7465 6453 6574 0a20 2020  e: SortedSet.   
-00006f30: 2069 643a 2075 7569 642e 5555 4944 0a0a   id: uuid.UUID..
-00006f40: 2020 2020 5f5f 736c 6f74 735f 5f20 3d20      __slots__ = 
-00006f50: 7475 706c 6528 5f5f 616e 6e6f 7461 7469  tuple(__annotati
-00006f60: 6f6e 735f 5f29 0a0a 2020 2020 6465 6620  ons__)..    def 
-00006f70: 5f5f 696e 6974 5f5f 2873 656c 6629 3a0a  __init__(self):.
-00006f80: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-00006f90: 7274 203d 2074 696d 6528 290a 2020 2020  rt = time().    
-00006fa0: 2020 2020 7365 6c66 2e67 726f 7570 7320      self.groups 
-00006fb0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00006fc0: 7365 6c66 2e63 6f64 6520 3d20 536f 7274  self.code = Sort
-00006fd0: 6564 5365 7428 290a 2020 2020 2020 2020  edSet().        
-00006fe0: 7365 6c66 2e69 6420 3d20 7575 6964 2e75  self.id = uuid.u
-00006ff0: 7569 6434 2829 0a0a 2020 2020 4070 726f  uid4()..    @pro
-00007000: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
-00007010: 6f70 2873 656c 6629 202d 3e20 666c 6f61  op(self) -> floa
-00007020: 743a 0a20 2020 2020 2020 2069 6620 7365  t:.        if se
-00007030: 6c66 2e67 726f 7570 733a 0a20 2020 2020  lf.groups:.     
-00007040: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
-00007050: 7828 7467 2e73 746f 7020 666f 7220 7467  x(tg.stop for tg
-00007060: 2069 6e20 7365 6c66 2e67 726f 7570 7329   in self.groups)
-00007070: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00007080: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00007090: 6e20 2d31 0a0a 2020 2020 4070 726f 7065  n -1..    @prope
-000070a0: 7274 790a 2020 2020 6465 6620 7374 6174  rty.    def stat
-000070b0: 6573 2873 656c 6629 202d 3e20 6469 6374  es(self) -> dict
-000070c0: 5b54 6173 6b53 7461 7465 5374 6174 652c  [TaskStateState,
-000070d0: 2069 6e74 5d3a 0a20 2020 2020 2020 2072   int]:.        r
-000070e0: 6574 7572 6e20 6d65 7267 655f 7769 7468  eturn merge_with
-000070f0: 2873 756d 2c20 2874 672e 7374 6174 6573  (sum, (tg.states
-00007100: 2066 6f72 2074 6720 696e 2073 656c 662e   for tg in self.
-00007110: 6772 6f75 7073 2929 0a0a 2020 2020 6465  groups))..    de
-00007120: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-00007130: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00007140: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-00007150: 2020 2020 2020 6622 3c43 6f6d 7075 7461        f"<Computa
-00007160: 7469 6f6e 207b 7365 6c66 2e69 647d 3a20  tion {self.id}: 
-00007170: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
-00007180: 2254 6173 6b73 3a20 220a 2020 2020 2020  "Tasks: ".      
-00007190: 2020 2020 2020 2b20 222c 2022 2e6a 6f69        + ", ".joi
-000071a0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-000071b0: 2020 2022 2573 3a20 2564 2220 2520 286b     "%s: %d" % (k
-000071c0: 2c20 7629 2066 6f72 2028 6b2c 2076 2920  , v) for (k, v) 
-000071d0: 696e 2073 6f72 7465 6428 7365 6c66 2e73  in sorted(self.s
-000071e0: 7461 7465 732e 6974 656d 7328 2929 2069  tates.items()) i
-000071f0: 6620 760a 2020 2020 2020 2020 2020 2020  f v.            
-00007200: 290a 2020 2020 2020 2020 2020 2020 2b20  ).            + 
-00007210: 223e 220a 2020 2020 2020 2020 290a 0a20  ">".        ).. 
-00007220: 2020 2064 6566 205f 7265 7072 5f68 746d     def _repr_htm
-00007230: 6c5f 2873 656c 6629 202d 3e20 7374 723a  l_(self) -> str:
-00007240: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00007250: 6765 745f 7465 6d70 6c61 7465 2822 636f  get_template("co
-00007260: 6d70 7574 6174 696f 6e2e 6874 6d6c 2e6a  mputation.html.j
-00007270: 3222 292e 7265 6e64 6572 280a 2020 2020  2").render(.    
-00007280: 2020 2020 2020 2020 6964 3d73 656c 662e          id=self.
-00007290: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-000072a0: 7374 6172 743d 7365 6c66 2e73 7461 7274  start=self.start
-000072b0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-000072c0: 6f70 3d73 656c 662e 7374 6f70 2c0a 2020  op=self.stop,.  
-000072d0: 2020 2020 2020 2020 2020 6772 6f75 7073            groups
-000072e0: 3d73 656c 662e 6772 6f75 7073 2c0a 2020  =self.groups,.  
-000072f0: 2020 2020 2020 2020 2020 7374 6174 6573            states
-00007300: 3d73 656c 662e 7374 6174 6573 2c0a 2020  =self.states,.  
-00007310: 2020 2020 2020 2020 2020 636f 6465 3d73            code=s
-00007320: 656c 662e 636f 6465 2c0a 2020 2020 2020  elf.code,.      
-00007330: 2020 290a 0a0a 636c 6173 7320 5461 736b    )...class Task
-00007340: 5072 6566 6978 3a0a 2020 2020 2222 2243  Prefix:.    """C
-00007350: 6f6c 6c65 6374 696f 6e20 7472 6163 6b69  ollection tracki
-00007360: 6e67 2061 6c6c 2074 6173 6b73 2077 6974  ng all tasks wit
-00007370: 6869 6e20 6120 6772 6f75 700a 0a20 2020  hin a group..   
-00007380: 204b 6579 7320 6f66 7465 6e20 6861 7665   Keys often have
-00007390: 2061 2073 7472 7563 7475 7265 206c 696b   a structure lik
-000073a0: 6520 6060 2822 782d 3132 3322 2c20 3029  e ``("x-123", 0)
-000073b0: 6060 0a20 2020 2041 2067 726f 7570 2074  ``.    A group t
-000073c0: 616b 6573 2074 6865 2066 6972 7374 2073  akes the first s
-000073d0: 6563 7469 6f6e 2c20 6c69 6b65 2060 6022  ection, like ``"
-000073e0: 7822 6060 0a0a 2020 2020 5365 6520 416c  x"``..    See Al
-000073f0: 736f 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a  so.    --------.
-00007400: 2020 2020 5461 736b 4772 6f75 700a 2020      TaskGroup.  
-00007410: 2020 2222 220a 0a20 2020 2023 3a20 5468    """..    #: Th
-00007420: 6520 6e61 6d65 206f 6620 6120 6772 6f75  e name of a grou
-00007430: 7020 6f66 2074 6173 6b73 2e0a 2020 2020  p of tasks..    
-00007440: 233a 2046 6f72 2061 2074 6173 6b20 6c69  #: For a task li
-00007450: 6b65 2060 6028 2278 2d31 3233 222c 2030  ke ``("x-123", 0
-00007460: 2960 6020 7468 6973 2069 7320 7468 6520  )`` this is the 
-00007470: 7465 7874 2060 6022 7822 6060 0a20 2020  text ``"x"``.   
-00007480: 206e 616d 653a 2073 7472 0a0a 2020 2020   name: str..    
-00007490: 233a 2041 6e20 6578 706f 6e65 6e74 6961  #: An exponentia
-000074a0: 6c6c 7920 7765 6967 6874 6564 206d 6f76  lly weighted mov
-000074b0: 696e 6720 6176 6572 6167 6520 6475 7261  ing average dura
-000074c0: 7469 6f6e 206f 6620 616c 6c20 7461 736b  tion of all task
-000074d0: 7320 7769 7468 2074 6869 7320 7072 6566  s with this pref
-000074e0: 6978 0a20 2020 2064 7572 6174 696f 6e5f  ix.    duration_
-000074f0: 6176 6572 6167 653a 2066 6c6f 6174 0a0a  average: float..
-00007500: 2020 2020 233a 204e 756d 6265 7273 206f      #: Numbers o
-00007510: 6620 7469 6d65 7320 6120 7461 736b 2077  f times a task w
-00007520: 6173 206d 6172 6b65 6420 6173 2073 7573  as marked as sus
-00007530: 7069 6369 6f75 7320 7769 7468 2074 6869  picious with thi
-00007540: 7320 7072 6566 6978 0a20 2020 2073 7573  s prefix.    sus
-00007550: 7069 6369 6f75 733a 2069 6e74 0a0a 2020  picious: int..  
-00007560: 2020 233a 2053 746f 7265 2074 696d 696e    #: Store timin
-00007570: 6773 2066 6f72 2065 6163 6820 7072 6566  gs for each pref
-00007580: 6978 2d61 6374 696f 6e0a 2020 2020 616c  ix-action.    al
-00007590: 6c5f 6475 7261 7469 6f6e 733a 2064 6566  l_durations: def
-000075a0: 6175 6c74 6469 6374 5b73 7472 2c20 666c  aultdict[str, fl
-000075b0: 6f61 745d 0a0a 2020 2020 233a 2054 6869  oat]..    #: Thi
-000075c0: 7320 6d65 6173 7572 6573 2074 6865 206d  s measures the m
-000075d0: 6178 696d 756d 2072 6563 6f72 6465 6420  aximum recorded 
-000075e0: 6c69 7665 2065 7865 6375 7469 6f6e 2074  live execution t
-000075f0: 696d 6520 616e 6420 6361 6e20 6265 2075  ime and can be u
-00007600: 7365 6420 746f 0a20 2020 2023 3a20 6465  sed to.    #: de
-00007610: 7465 6374 206f 7574 6c69 6572 730a 2020  tect outliers.  
-00007620: 2020 6d61 785f 6578 6563 5f74 696d 653a    max_exec_time:
-00007630: 2066 6c6f 6174 0a0a 2020 2020 233a 2054   float..    #: T
-00007640: 6173 6b20 6772 6f75 7073 2061 7373 6f63  ask groups assoc
-00007650: 6961 7465 6420 746f 2074 6869 7320 7072  iated to this pr
-00007660: 6566 6978 0a20 2020 2067 726f 7570 733a  efix.    groups:
-00007670: 206c 6973 745b 5461 736b 4772 6f75 705d   list[TaskGroup]
-00007680: 0a0a 2020 2020 233a 2041 6363 756d 756c  ..    #: Accumul
-00007690: 6174 6520 636f 756e 7420 6f66 206e 756d  ate count of num
-000076a0: 6265 7220 6f66 2074 6173 6b73 2069 6e20  ber of tasks in 
-000076b0: 6561 6368 2073 7461 7465 0a20 2020 2073  each state.    s
-000076c0: 7461 7465 5f63 6f75 6e74 733a 2064 6566  tate_counts: def
-000076d0: 6175 6c74 6469 6374 5b54 6173 6b53 7461  aultdict[TaskSta
-000076e0: 7465 5374 6174 652c 2069 6e74 5d0a 0a20  teState, int].. 
-000076f0: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
-00007700: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
-00007710: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
-00007720: 5f69 6e69 745f 5f28 7365 6c66 2c20 6e61  _init__(self, na
-00007730: 6d65 3a20 7374 7229 3a0a 2020 2020 2020  me: str):.      
-00007740: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
-00007750: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
-00007760: 6772 6f75 7073 203d 205b 5d0a 2020 2020  groups = [].    
-00007770: 2020 2020 7365 6c66 2e61 6c6c 5f64 7572      self.all_dur
-00007780: 6174 696f 6e73 203d 2064 6566 6175 6c74  ations = default
-00007790: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
-000077a0: 2020 2020 7365 6c66 2e73 7461 7465 5f63      self.state_c
-000077b0: 6f75 6e74 7320 3d20 6465 6661 756c 7464  ounts = defaultd
-000077c0: 6963 7428 696e 7429 0a20 2020 2020 2020  ict(int).       
-000077d0: 2074 6173 6b5f 6475 7261 7469 6f6e 7320   task_durations 
-000077e0: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
-000077f0: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-00007800: 6368 6564 756c 6572 2e64 6566 6175 6c74  cheduler.default
-00007810: 2d74 6173 6b2d 6475 7261 7469 6f6e 7322  -task-durations"
-00007820: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
-00007830: 662e 6e61 6d65 2069 6e20 7461 736b 5f64  f.name in task_d
-00007840: 7572 6174 696f 6e73 3a0a 2020 2020 2020  urations:.      
-00007850: 2020 2020 2020 7365 6c66 2e64 7572 6174        self.durat
-00007860: 696f 6e5f 6176 6572 6167 6520 3d20 7061  ion_average = pa
-00007870: 7273 655f 7469 6d65 6465 6c74 6128 7461  rse_timedelta(ta
-00007880: 736b 5f64 7572 6174 696f 6e73 5b73 656c  sk_durations[sel
-00007890: 662e 6e61 6d65 5d29 0a20 2020 2020 2020  f.name]).       
-000078a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000078b0: 2020 2073 656c 662e 6475 7261 7469 6f6e     self.duration
-000078c0: 5f61 7665 7261 6765 203d 202d 310a 2020  _average = -1.  
-000078d0: 2020 2020 2020 7365 6c66 2e6d 6178 5f65        self.max_e
-000078e0: 7865 635f 7469 6d65 203d 202d 310a 2020  xec_time = -1.  
-000078f0: 2020 2020 2020 7365 6c66 2e73 7573 7069        self.suspi
-00007900: 6369 6f75 7320 3d20 300a 0a20 2020 2064  cious = 0..    d
-00007910: 6566 2061 6464 5f65 7865 635f 7469 6d65  ef add_exec_time
-00007920: 2873 656c 662c 2064 7572 6174 696f 6e3a  (self, duration:
-00007930: 2066 6c6f 6174 2920 2d3e 204e 6f6e 653a   float) -> None:
-00007940: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
-00007950: 785f 6578 6563 5f74 696d 6520 3d20 6d61  x_exec_time = ma
-00007960: 7828 6475 7261 7469 6f6e 2c20 7365 6c66  x(duration, self
-00007970: 2e6d 6178 5f65 7865 635f 7469 6d65 290a  .max_exec_time).
-00007980: 2020 2020 2020 2020 6966 2064 7572 6174          if durat
-00007990: 696f 6e20 3e20 3220 2a20 7365 6c66 2e64  ion > 2 * self.d
-000079a0: 7572 6174 696f 6e5f 6176 6572 6167 653a  uration_average:
-000079b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000079c0: 662e 6475 7261 7469 6f6e 5f61 7665 7261  f.duration_avera
-000079d0: 6765 203d 202d 310a 0a20 2020 2064 6566  ge = -1..    def
-000079e0: 2061 6464 5f64 7572 6174 696f 6e28 7365   add_duration(se
-000079f0: 6c66 2c20 6163 7469 6f6e 3a20 7374 722c  lf, action: str,
-00007a00: 2073 7461 7274 3a20 666c 6f61 742c 2073   start: float, s
-00007a10: 746f 703a 2066 6c6f 6174 2920 2d3e 204e  top: float) -> N
-00007a20: 6f6e 653a 0a20 2020 2020 2020 2064 7572  one:.        dur
-00007a30: 6174 696f 6e20 3d20 7374 6f70 202d 2073  ation = stop - s
-00007a40: 7461 7274 0a20 2020 2020 2020 2073 656c  tart.        sel
-00007a50: 662e 616c 6c5f 6475 7261 7469 6f6e 735b  f.all_durations[
-00007a60: 6163 7469 6f6e 5d20 2b3d 2064 7572 6174  action] += durat
-00007a70: 696f 6e0a 2020 2020 2020 2020 6966 2061  ion.        if a
-00007a80: 6374 696f 6e20 3d3d 2022 636f 6d70 7574  ction == "comput
-00007a90: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
-00007aa0: 6f6c 6420 3d20 7365 6c66 2e64 7572 6174  old = self.durat
-00007ab0: 696f 6e5f 6176 6572 6167 650a 2020 2020  ion_average.    
-00007ac0: 2020 2020 2020 2020 6966 206f 6c64 203c          if old <
-00007ad0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00007ae0: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
-00007af0: 6e5f 6176 6572 6167 6520 3d20 6475 7261  n_average = dura
-00007b00: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00007b10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00007b20: 2020 2020 2020 2073 656c 662e 6475 7261         self.dura
-00007b30: 7469 6f6e 5f61 7665 7261 6765 203d 2030  tion_average = 0
-00007b40: 2e35 202a 2064 7572 6174 696f 6e20 2b20  .5 * duration + 
-00007b50: 302e 3520 2a20 6f6c 640a 0a20 2020 2040  0.5 * old..    @
-00007b60: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00007b70: 2073 7461 7465 7328 7365 6c66 2920 2d3e   states(self) ->
-00007b80: 2064 6963 745b 7374 722c 2069 6e74 5d3a   dict[str, int]:
-00007b90: 0a20 2020 2020 2020 2022 2222 5468 6520  .        """The 
-00007ba0: 6e75 6d62 6572 206f 6620 7461 736b 7320  number of tasks 
-00007bb0: 696e 2065 6163 6820 7374 6174 652c 0a20  in each state,. 
-00007bc0: 2020 2020 2020 206c 696b 6520 6060 7b22         like ``{"
-00007bd0: 6d65 6d6f 7279 223a 2031 302c 2022 7072  memory": 10, "pr
-00007be0: 6f63 6573 7369 6e67 223a 2033 2c20 2272  ocessing": 3, "r
-00007bf0: 656c 6561 7365 6422 3a20 342c 202e 2e2e  eleased": 4, ...
-00007c00: 7d60 600a 2020 2020 2020 2020 2222 220a  }``.        """.
-00007c10: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-00007c20: 6572 6765 5f77 6974 6828 7375 6d2c 205b  erge_with(sum, [
-00007c30: 7467 2e73 7461 7465 7320 666f 7220 7467  tg.states for tg
-00007c40: 2069 6e20 7365 6c66 2e67 726f 7570 735d   in self.groups]
-00007c50: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
-00007c60: 0a20 2020 2064 6566 2061 6374 6976 6528  .    def active(
-00007c70: 7365 6c66 2920 2d3e 206c 6973 745b 5461  self) -> list[Ta
-00007c80: 736b 4772 6f75 705d 3a0a 2020 2020 2020  skGroup]:.      
-00007c90: 2020 7265 7475 726e 205b 0a20 2020 2020    return [.     
-00007ca0: 2020 2020 2020 2074 670a 2020 2020 2020         tg.      
-00007cb0: 2020 2020 2020 666f 7220 7467 2069 6e20        for tg in 
-00007cc0: 7365 6c66 2e67 726f 7570 730a 2020 2020  self.groups.    
-00007cd0: 2020 2020 2020 2020 6966 2061 6e79 286b          if any(k
-00007ce0: 2021 3d20 2266 6f72 676f 7474 656e 2220   != "forgotten" 
-00007cf0: 616e 6420 7620 213d 2030 2066 6f72 206b  and v != 0 for k
-00007d00: 2c20 7620 696e 2074 672e 7374 6174 6573  , v in tg.states
-00007d10: 2e69 7465 6d73 2829 290a 2020 2020 2020  .items()).      
-00007d20: 2020 5d0a 0a20 2020 2040 7072 6f70 6572    ]..    @proper
-00007d30: 7479 0a20 2020 2064 6566 2061 6374 6976  ty.    def activ
-00007d40: 655f 7374 6174 6573 2873 656c 6629 202d  e_states(self) -
-00007d50: 3e20 6469 6374 5b73 7472 2c20 696e 745d  > dict[str, int]
-00007d60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00007d70: 206d 6572 6765 5f77 6974 6828 7375 6d2c   merge_with(sum,
-00007d80: 205b 7467 2e73 7461 7465 7320 666f 7220   [tg.states for 
-00007d90: 7467 2069 6e20 7365 6c66 2e61 6374 6976  tg in self.activ
-00007da0: 655d 290a 0a20 2020 2064 6566 205f 5f72  e])..    def __r
-00007db0: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
-00007dc0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-00007dd0: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
-00007de0: 2022 3c22 0a20 2020 2020 2020 2020 2020   "<".           
-00007df0: 202b 2073 656c 662e 6e61 6d65 0a20 2020   + self.name.   
-00007e00: 2020 2020 2020 2020 202b 2022 3a20 220a           + ": ".
-00007e10: 2020 2020 2020 2020 2020 2020 2b20 222c              + ",
-00007e20: 2022 2e6a 6f69 6e28 0a20 2020 2020 2020   ".join(.       
-00007e30: 2020 2020 2020 2020 2022 2573 3a20 2564           "%s: %d
-00007e40: 2220 2520 286b 2c20 7629 2066 6f72 2028  " % (k, v) for (
-00007e50: 6b2c 2076 2920 696e 2073 6f72 7465 6428  k, v) in sorted(
-00007e60: 7365 6c66 2e73 7461 7465 732e 6974 656d  self.states.item
-00007e70: 7328 2929 2069 6620 760a 2020 2020 2020  s()) if v.      
-00007e80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00007e90: 2020 2020 2b20 223e 220a 2020 2020 2020      + ">".      
-00007ea0: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
-00007eb0: 7479 0a20 2020 2064 6566 206e 6279 7465  ty.    def nbyte
-00007ec0: 735f 746f 7461 6c28 7365 6c66 2920 2d3e  s_total(self) ->
-00007ed0: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
-00007ee0: 7475 726e 2073 756d 2874 672e 6e62 7974  turn sum(tg.nbyt
-00007ef0: 6573 5f74 6f74 616c 2066 6f72 2074 6720  es_total for tg 
-00007f00: 696e 2073 656c 662e 6772 6f75 7073 290a  in self.groups).
-00007f10: 0a20 2020 2064 6566 205f 5f6c 656e 5f5f  .    def __len__
-00007f20: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
-00007f30: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-00007f40: 6d28 6d61 7028 6c65 6e2c 2073 656c 662e  m(map(len, self.
-00007f50: 6772 6f75 7073 2929 0a0a 2020 2020 4070  groups))..    @p
-00007f60: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00007f70: 6475 7261 7469 6f6e 2873 656c 6629 202d  duration(self) -
-00007f80: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
-00007f90: 2072 6574 7572 6e20 7375 6d28 7467 2e64   return sum(tg.d
-00007fa0: 7572 6174 696f 6e20 666f 7220 7467 2069  uration for tg i
-00007fb0: 6e20 7365 6c66 2e67 726f 7570 7329 0a0a  n self.groups)..
-00007fc0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00007fd0: 2020 6465 6620 7479 7065 7328 7365 6c66    def types(self
-00007fe0: 2920 2d3e 2073 6574 5b73 7472 5d3a 0a20  ) -> set[str]:. 
-00007ff0: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
-00008000: 7970 2066 6f72 2074 6720 696e 2073 656c  yp for tg in sel
-00008010: 662e 6772 6f75 7073 2066 6f72 2074 7970  f.groups for typ
-00008020: 2069 6e20 7467 2e74 7970 6573 7d0a 0a0a   in tg.types}...
-00008030: 636c 6173 7320 5461 736b 4772 6f75 703a  class TaskGroup:
-00008040: 0a20 2020 2022 2222 436f 6c6c 6563 7469  .    """Collecti
-00008050: 6f6e 2074 7261 636b 696e 6720 616c 6c20  on tracking all 
-00008060: 7461 736b 7320 7769 7468 696e 2061 2067  tasks within a g
-00008070: 726f 7570 0a0a 2020 2020 4b65 7973 206f  roup..    Keys o
-00008080: 6674 656e 2068 6176 6520 6120 7374 7275  ften have a stru
-00008090: 6374 7572 6520 6c69 6b65 2060 6028 2278  cture like ``("x
-000080a0: 2d31 3233 222c 2030 2960 600a 2020 2020  -123", 0)``.    
-000080b0: 4120 6772 6f75 7020 7461 6b65 7320 7468  A group takes th
-000080c0: 6520 6669 7273 7420 7365 6374 696f 6e2c  e first section,
-000080d0: 206c 696b 6520 6060 2278 2d31 3233 2260   like ``"x-123"`
-000080e0: 600a 0a20 2020 2053 6565 2061 6c73 6f0a  `..    See also.
-000080f0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-00008100: 2054 6173 6b50 7265 6669 780a 2020 2020   TaskPrefix.    
-00008110: 2222 220a 0a20 2020 2023 3a20 5468 6520  """..    #: The 
-00008120: 6e61 6d65 206f 6620 6120 6772 6f75 7020  name of a group 
-00008130: 6f66 2074 6173 6b73 2e0a 2020 2020 233a  of tasks..    #:
-00008140: 2046 6f72 2061 2074 6173 6b20 6c69 6b65   For a task like
-00008150: 2060 6028 2278 2d31 3233 222c 2030 2960   ``("x-123", 0)`
-00008160: 6020 7468 6973 2069 7320 7468 6520 7465  ` this is the te
-00008170: 7874 2060 6022 782d 3132 3322 6060 0a20  xt ``"x-123"``. 
-00008180: 2020 206e 616d 653a 2073 7472 0a0a 2020     name: str..  
-00008190: 2020 233a 2054 6865 206e 756d 6265 7220    #: The number 
-000081a0: 6f66 2074 6173 6b73 2069 6e20 6561 6368  of tasks in each
-000081b0: 2073 7461 7465 2c0a 2020 2020 233a 206c   state,.    #: l
-000081c0: 696b 6520 6060 7b22 6d65 6d6f 7279 223a  ike ``{"memory":
-000081d0: 2031 302c 2022 7072 6f63 6573 7369 6e67   10, "processing
-000081e0: 223a 2033 2c20 2272 656c 6561 7365 6422  ": 3, "released"
-000081f0: 3a20 342c 202e 2e2e 7d60 600a 2020 2020  : 4, ...}``.    
-00008200: 7374 6174 6573 3a20 6469 6374 5b54 6173  states: dict[Tas
-00008210: 6b53 7461 7465 5374 6174 652c 2069 6e74  kStateState, int
-00008220: 5d0a 0a20 2020 2023 3a20 5468 6520 6f74  ]..    #: The ot
-00008230: 6865 7220 5461 736b 4772 6f75 7073 206f  her TaskGroups o
-00008240: 6e20 7768 6963 6820 7468 6973 206f 6e65  n which this one
-00008250: 2064 6570 656e 6473 0a20 2020 2064 6570   depends.    dep
-00008260: 656e 6465 6e63 6965 733a 2073 6574 5b54  endencies: set[T
-00008270: 6173 6b47 726f 7570 5d0a 0a20 2020 2023  askGroup]..    #
-00008280: 3a20 5468 6520 746f 7461 6c20 6e75 6d62  : The total numb
-00008290: 6572 206f 6620 6279 7465 7320 7468 6174  er of bytes that
-000082a0: 2074 6869 7320 7461 736b 2067 726f 7570   this task group
-000082b0: 2068 6173 2070 726f 6475 6365 640a 2020   has produced.  
-000082c0: 2020 6e62 7974 6573 5f74 6f74 616c 3a20    nbytes_total: 
-000082d0: 696e 740a 0a20 2020 2023 3a20 5468 6520  int..    #: The 
-000082e0: 746f 7461 6c20 616d 6f75 6e74 206f 6620  total amount of 
-000082f0: 7469 6d65 2073 7065 6e74 206f 6e20 616c  time spent on al
-00008300: 6c20 7461 736b 7320 696e 2074 6869 7320  l tasks in this 
-00008310: 5461 736b 4772 6f75 700a 2020 2020 6475  TaskGroup.    du
-00008320: 7261 7469 6f6e 3a20 666c 6f61 740a 0a20  ration: float.. 
-00008330: 2020 2023 3a20 5468 6520 7265 7375 6c74     #: The result
-00008340: 2074 7970 6573 206f 6620 7468 6973 2054   types of this T
-00008350: 6173 6b47 726f 7570 0a20 2020 2074 7970  askGroup.    typ
-00008360: 6573 3a20 7365 745b 7374 725d 0a0a 2020  es: set[str]..  
-00008370: 2020 233a 2054 6865 2077 6f72 6b65 7220    #: The worker 
-00008380: 6d6f 7374 2072 6563 656e 746c 7920 6173  most recently as
-00008390: 7369 676e 6564 2061 2074 6173 6b20 6672  signed a task fr
-000083a0: 6f6d 2074 6869 7320 6772 6f75 702c 206f  om this group, o
-000083b0: 7220 4e6f 6e65 2077 6865 6e20 7468 6520  r None when the 
-000083c0: 6772 6f75 700a 2020 2020 233a 2069 7320  group.    #: is 
-000083d0: 6e6f 7420 6964 656e 7469 6669 6564 2074  not identified t
-000083e0: 6f20 6265 2072 6f6f 742d 6c69 6b65 2062  o be root-like b
-000083f0: 7920 6053 6368 6564 756c 6572 5374 6174  y `SchedulerStat
-00008400: 652e 6465 6369 6465 5f77 6f72 6b65 7260  e.decide_worker`
-00008410: 2e0a 2020 2020 6c61 7374 5f77 6f72 6b65  ..    last_worke
-00008420: 723a 2057 6f72 6b65 7253 7461 7465 207c  r: WorkerState |
-00008430: 204e 6f6e 650a 0a20 2020 2023 3a20 4966   None..    #: If
-00008440: 2060 6c61 7374 5f77 6f72 6b65 7260 2069   `last_worker` i
-00008450: 7320 6e6f 7420 4e6f 6e65 2c20 7468 6520  s not None, the 
-00008460: 6e75 6d62 6572 206f 6620 7469 6d65 7320  number of times 
-00008470: 7468 6174 2077 6f72 6b65 7220 7368 6f75  that worker shou
-00008480: 6c64 2062 6520 6173 7369 676e 6564 0a20  ld be assigned. 
-00008490: 2020 2023 3a20 7375 6273 6571 7565 6e74     #: subsequent
-000084a0: 2074 6173 6b73 2075 6e74 696c 2061 206e   tasks until a n
-000084b0: 6577 2077 6f72 6b65 7220 6973 2063 686f  ew worker is cho
-000084c0: 7365 6e2e 0a20 2020 206c 6173 745f 776f  sen..    last_wo
-000084d0: 726b 6572 5f74 6173 6b73 5f6c 6566 743a  rker_tasks_left:
-000084e0: 2069 6e74 0a0a 2020 2020 7072 6566 6978   int..    prefix
-000084f0: 3a20 5461 736b 5072 6566 6978 207c 204e  : TaskPrefix | N
-00008500: 6f6e 650a 2020 2020 7374 6172 743a 2066  one.    start: f
-00008510: 6c6f 6174 0a20 2020 2073 746f 703a 2066  loat.    stop: f
-00008520: 6c6f 6174 0a20 2020 2061 6c6c 5f64 7572  loat.    all_dur
-00008530: 6174 696f 6e73 3a20 6465 6661 756c 7464  ations: defaultd
-00008540: 6963 745b 7374 722c 2066 6c6f 6174 5d0a  ict[str, float].
-00008550: 0a20 2020 205f 5f73 6c6f 7473 5f5f 203d  .    __slots__ =
-00008560: 2074 7570 6c65 285f 5f61 6e6e 6f74 6174   tuple(__annotat
-00008570: 696f 6e73 5f5f 290a 0a20 2020 2064 6566  ions__)..    def
-00008580: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00008590: 6e61 6d65 3a20 7374 7229 3a0a 2020 2020  name: str):.    
-000085a0: 2020 2020 7365 6c66 2e6e 616d 6520 3d20      self.name = 
-000085b0: 6e61 6d65 0a20 2020 2020 2020 2073 656c  name.        sel
-000085c0: 662e 7072 6566 6978 203d 204e 6f6e 650a  f.prefix = None.
-000085d0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-000085e0: 7465 7320 3d20 6469 6374 2e66 726f 6d6b  tes = dict.fromk
-000085f0: 6579 7328 414c 4c5f 5441 534b 5f53 5441  eys(ALL_TASK_STA
-00008600: 5445 532c 2030 290a 2020 2020 2020 2020  TES, 0).        
-00008610: 7365 6c66 2e64 6570 656e 6465 6e63 6965  self.dependencie
-00008620: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
-00008630: 2020 7365 6c66 2e6e 6279 7465 735f 746f    self.nbytes_to
-00008640: 7461 6c20 3d20 300a 2020 2020 2020 2020  tal = 0.        
-00008650: 7365 6c66 2e64 7572 6174 696f 6e20 3d20  self.duration = 
-00008660: 300a 2020 2020 2020 2020 7365 6c66 2e74  0.        self.t
-00008670: 7970 6573 203d 2073 6574 2829 0a20 2020  ypes = set().   
-00008680: 2020 2020 2073 656c 662e 7374 6172 7420       self.start 
-00008690: 3d20 302e 300a 2020 2020 2020 2020 7365  = 0.0.        se
-000086a0: 6c66 2e73 746f 7020 3d20 302e 300a 2020  lf.stop = 0.0.  
-000086b0: 2020 2020 2020 7365 6c66 2e61 6c6c 5f64        self.all_d
-000086c0: 7572 6174 696f 6e73 203d 2064 6566 6175  urations = defau
-000086d0: 6c74 6469 6374 2866 6c6f 6174 290a 2020  ltdict(float).  
-000086e0: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
-000086f0: 776f 726b 6572 203d 204e 6f6e 650a 2020  worker = None.  
-00008700: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
-00008710: 776f 726b 6572 5f74 6173 6b73 5f6c 6566  worker_tasks_lef
-00008720: 7420 3d20 300a 0a20 2020 2064 6566 2061  t = 0..    def a
-00008730: 6464 5f64 7572 6174 696f 6e28 7365 6c66  dd_duration(self
-00008740: 2c20 6163 7469 6f6e 3a20 7374 722c 2073  , action: str, s
-00008750: 7461 7274 3a20 666c 6f61 742c 2073 746f  tart: float, sto
-00008760: 703a 2066 6c6f 6174 2920 2d3e 204e 6f6e  p: float) -> Non
-00008770: 653a 0a20 2020 2020 2020 2064 7572 6174  e:.        durat
-00008780: 696f 6e20 3d20 7374 6f70 202d 2073 7461  ion = stop - sta
-00008790: 7274 0a20 2020 2020 2020 2073 656c 662e  rt.        self.
-000087a0: 616c 6c5f 6475 7261 7469 6f6e 735b 6163  all_durations[ac
-000087b0: 7469 6f6e 5d20 2b3d 2064 7572 6174 696f  tion] += duratio
-000087c0: 6e0a 2020 2020 2020 2020 6966 2061 6374  n.        if act
-000087d0: 696f 6e20 3d3d 2022 636f 6d70 7574 6522  ion == "compute"
-000087e0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000087f0: 2073 656c 662e 7374 6f70 203c 2073 746f   self.stop < sto
-00008800: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-00008810: 2020 2073 656c 662e 7374 6f70 203d 2073     self.stop = s
-00008820: 746f 700a 2020 2020 2020 2020 2020 2020  top.            
-00008830: 7365 6c66 2e73 7461 7274 203d 2073 656c  self.start = sel
-00008840: 662e 7374 6172 7420 6f72 2073 7461 7274  f.start or start
-00008850: 0a20 2020 2020 2020 2073 656c 662e 6475  .        self.du
-00008860: 7261 7469 6f6e 202b 3d20 6475 7261 7469  ration += durati
-00008870: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-00008880: 7420 7365 6c66 2e70 7265 6669 7820 6973  t self.prefix is
-00008890: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
-000088a0: 2020 7365 6c66 2e70 7265 6669 782e 6164    self.prefix.ad
-000088b0: 645f 6475 7261 7469 6f6e 2861 6374 696f  d_duration(actio
-000088c0: 6e2c 2073 7461 7274 2c20 7374 6f70 290a  n, start, stop).
-000088d0: 0a20 2020 2064 6566 2061 6464 2873 656c  .    def add(sel
-000088e0: 662c 206f 7468 6572 3a20 5461 736b 5374  f, other: TaskSt
-000088f0: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-00008900: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
-00008910: 735b 6f74 6865 722e 7374 6174 655d 202b  s[other.state] +
-00008920: 3d20 310a 2020 2020 2020 2020 6f74 6865  = 1.        othe
-00008930: 722e 6772 6f75 7020 3d20 7365 6c66 0a0a  r.group = self..
-00008940: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
-00008950: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-00008960: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
-00008970: 2020 2020 2020 2020 2020 2020 223c 220a              "<".
-00008980: 2020 2020 2020 2020 2020 2020 2b20 2873              + (s
-00008990: 656c 662e 6e61 6d65 206f 7220 226e 6f2d  elf.name or "no-
-000089a0: 6772 6f75 7022 290a 2020 2020 2020 2020  group").        
-000089b0: 2020 2020 2b20 223a 2022 0a20 2020 2020      + ": ".     
-000089c0: 2020 2020 2020 202b 2022 2c20 222e 6a6f         + ", ".jo
-000089d0: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
-000089e0: 2020 2020 2225 733a 2025 6422 2025 2028      "%s: %d" % (
-000089f0: 6b2c 2076 2920 666f 7220 286b 2c20 7629  k, v) for (k, v)
-00008a00: 2069 6e20 736f 7274 6564 2873 656c 662e   in sorted(self.
-00008a10: 7374 6174 6573 2e69 7465 6d73 2829 2920  states.items()) 
-00008a20: 6966 2076 0a20 2020 2020 2020 2020 2020  if v.           
-00008a30: 2029 0a20 2020 2020 2020 2020 2020 202b   ).            +
-00008a40: 2022 3e22 0a20 2020 2020 2020 2029 0a0a   ">".        )..
-00008a50: 2020 2020 6465 6620 5f5f 6c65 6e5f 5f28      def __len__(
-00008a60: 7365 6c66 2920 2d3e 2069 6e74 3a0a 2020  self) -> int:.  
-00008a70: 2020 2020 2020 7265 7475 726e 2073 756d        return sum
-00008a80: 2873 656c 662e 7374 6174 6573 2e76 616c  (self.states.val
-00008a90: 7565 7328 2929 0a0a 2020 2020 6465 6620  ues())..    def 
-00008aa0: 5f74 6f5f 6469 6374 5f6e 6f5f 6e65 7374  _to_dict_no_nest
-00008ab0: 2873 656c 662c 202a 2c20 6578 636c 7564  (self, *, exclud
-00008ac0: 653a 2043 6f6e 7461 696e 6572 5b73 7472  e: Container[str
-00008ad0: 5d20 3d20 2829 2920 2d3e 2064 6963 745b  ] = ()) -> dict[
-00008ae0: 7374 722c 2041 6e79 5d3a 0a20 2020 2020  str, Any]:.     
-00008af0: 2020 2022 2222 4469 6374 696f 6e61 7279     """Dictionary
-00008b00: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
-00008b10: 666f 7220 6465 6275 6767 696e 6720 7075  for debugging pu
-00008b20: 7270 6f73 6573 2e0a 2020 2020 2020 2020  rposes..        
-00008b30: 4e6f 7420 7479 7065 2073 7461 626c 6520  Not type stable 
-00008b40: 616e 6420 6e6f 7420 696e 7465 6e64 6564  and not intended
-00008b50: 2066 6f72 2072 6f75 6e64 7472 6970 732e   for roundtrips.
-00008b60: 0a0a 2020 2020 2020 2020 5365 6520 616c  ..        See al
-00008b70: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-00008b80: 2d2d 2d0a 2020 2020 2020 2020 436c 6965  ---.        Clie
-00008b90: 6e74 2e64 756d 705f 636c 7573 7465 725f  nt.dump_cluster_
-00008ba0: 7374 6174 650a 2020 2020 2020 2020 6469  state.        di
-00008bb0: 7374 7269 6275 7465 642e 7574 696c 732e  stributed.utils.
-00008bc0: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
-00008bd0: 740a 2020 2020 2020 2020 5461 736b 5374  t.        TaskSt
-00008be0: 6174 652e 5f74 6f5f 6469 6374 0a20 2020  ate._to_dict.   
-00008bf0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00008c00: 2072 6574 7572 6e20 7265 6375 7273 6976   return recursiv
-00008c10: 655f 746f 5f64 6963 7428 7365 6c66 2c20  e_to_dict(self, 
-00008c20: 6578 636c 7564 653d 6578 636c 7564 652c  exclude=exclude,
-00008c30: 206d 656d 6265 7273 3d54 7275 6529 0a0a   members=True)..
-00008c40: 0a63 6c61 7373 2054 6173 6b53 7461 7465  .class TaskState
-00008c50: 3a0a 2020 2020 2222 2241 2073 696d 706c  :.    """A simpl
-00008c60: 6520 6f62 6a65 6374 2068 6f6c 6469 6e67  e object holding
-00008c70: 2069 6e66 6f72 6d61 7469 6f6e 2061 626f   information abo
-00008c80: 7574 2061 2074 6173 6b2e 0a0a 2020 2020  ut a task...    
-00008c90: 4e6f 7420 746f 2062 6520 636f 6e66 7573  Not to be confus
-00008ca0: 6564 2077 6974 6820 3a63 6c61 7373 3a60  ed with :class:`
-00008cb0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-00008cc0: 6572 5f73 7461 7465 5f6d 6163 6869 6e65  er_state_machine
-00008cd0: 2e54 6173 6b53 7461 7465 602c 2077 6869  .TaskState`, whi
-00008ce0: 6368 0a20 2020 2068 6f6c 6473 2073 696d  ch.    holds sim
-00008cf0: 696c 6172 2069 6e66 6f72 6d61 7469 6f6e  ilar information
-00008d00: 206f 6e20 7468 6520 576f 726b 6572 2073   on the Worker s
-00008d10: 6964 652e 0a20 2020 2022 2222 0a0a 2020  ide..    """..  
-00008d20: 2020 233a 2054 6865 206b 6579 2069 7320    #: The key is 
-00008d30: 7468 6520 756e 6971 7565 2069 6465 6e74  the unique ident
-00008d40: 6966 6965 7220 6f66 2061 2074 6173 6b2c  ifier of a task,
-00008d50: 2067 656e 6572 616c 6c79 2066 6f72 6d65   generally forme
-00008d60: 6420 6672 6f6d 2074 6865 206e 616d 6520  d from the name 
-00008d70: 6f66 2074 6865 0a20 2020 2023 3a20 6675  of the.    #: fu
-00008d80: 6e63 7469 6f6e 2c20 666f 6c6c 6f77 6564  nction, followed
-00008d90: 2062 7920 6120 6861 7368 206f 6620 7468   by a hash of th
-00008da0: 6520 6675 6e63 7469 6f6e 2061 6e64 2061  e function and a
-00008db0: 7267 756d 656e 7473 2c20 6c69 6b65 0a20  rguments, like. 
-00008dc0: 2020 2023 3a20 6060 2769 6e63 2d61 6233     #: ``'inc-ab3
-00008dd0: 3163 3031 3034 3434 3937 3730 3034 6436  1c010444977004d6
-00008de0: 3536 3631 3064 3264 3432 3165 6327 6060  56610d2d421ec'``
-00008df0: 2e0a 2020 2020 6b65 793a 2073 7472 0a0a  ..    key: str..
-00008e00: 2020 2020 233a 2054 6865 2062 726f 6164      #: The broad
-00008e10: 2063 6c61 7373 206f 6620 7461 736b 7320   class of tasks 
-00008e20: 746f 2077 6869 6368 2074 6869 7320 7461  to which this ta
-00008e30: 736b 2062 656c 6f6e 6773 206c 696b 6520  sk belongs like 
-00008e40: 2269 6e63 2220 6f72 2022 7265 6164 5f63  "inc" or "read_c
-00008e50: 7376 220a 2020 2020 7072 6566 6978 3a20  sv".    prefix: 
-00008e60: 5461 736b 5072 6566 6978 0a0a 2020 2020  TaskPrefix..    
-00008e70: 233a 2041 2073 7065 6369 6669 6361 7469  #: A specificati
-00008e80: 6f6e 206f 6620 686f 7720 746f 2072 756e  on of how to run
-00008e90: 2074 6865 2074 6173 6b2e 2020 5468 6520   the task.  The 
-00008ea0: 7479 7065 2061 6e64 206d 6561 6e69 6e67  type and meaning
-00008eb0: 206f 6620 7468 6973 2076 616c 7565 2069   of this value i
-00008ec0: 730a 2020 2020 233a 206f 7061 7175 6520  s.    #: opaque 
-00008ed0: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
-00008ee0: 2c20 6173 2069 7420 6973 206f 6e6c 7920  , as it is only 
-00008ef0: 696e 7465 7270 7265 7465 6420 6279 2074  interpreted by t
-00008f00: 6865 2077 6f72 6b65 7220 746f 2077 6869  he worker to whi
-00008f10: 6368 2074 6865 0a20 2020 2023 3a20 7461  ch the.    #: ta
-00008f20: 736b 2069 7320 7365 6e74 2066 6f72 2065  sk is sent for e
-00008f30: 7865 6375 7469 6e67 2e0a 2020 2020 233a  xecuting..    #:
-00008f40: 0a20 2020 2023 3a20 4173 2061 2073 7065  .    #: As a spe
-00008f50: 6369 616c 2063 6173 652c 2074 6869 7320  cial case, this 
-00008f60: 6174 7472 6962 7574 6520 6d61 7920 616c  attribute may al
-00008f70: 736f 2062 6520 6060 4e6f 6e65 6060 2c20  so be ``None``, 
-00008f80: 696e 2077 6869 6368 2063 6173 6520 7468  in which case th
-00008f90: 6520 7461 736b 2069 730a 2020 2020 233a  e task is.    #:
-00008fa0: 2022 7075 7265 2064 6174 6122 2028 7375   "pure data" (su
-00008fb0: 6368 2061 732c 2066 6f72 2065 7861 6d70  ch as, for examp
-00008fc0: 6c65 2c20 6120 7069 6563 6520 6f66 2064  le, a piece of d
-00008fd0: 6174 6120 6c6f 6164 6564 2069 6e20 7468  ata loaded in th
-00008fe0: 6520 7363 6865 6475 6c65 7220 7573 696e  e scheduler usin
-00008ff0: 670a 2020 2020 233a 203a 6d65 7468 3a60  g.    #: :meth:`
-00009000: 436c 6965 6e74 2e73 6361 7474 6572 6029  Client.scatter`)
-00009010: 2e20 2041 2022 7075 7265 2064 6174 6122  .  A "pure data"
-00009020: 2074 6173 6b20 6361 6e6e 6f74 2062 6520   task cannot be 
-00009030: 636f 6d70 7574 6564 2061 6761 696e 2069  computed again i
-00009040: 6620 6974 730a 2020 2020 233a 2076 616c  f its.    #: val
-00009050: 7565 2069 7320 6c6f 7374 2e0a 2020 2020  ue is lost..    
-00009060: 7275 6e5f 7370 6563 3a20 6f62 6a65 6374  run_spec: object
-00009070: 0a0a 2020 2020 233a 2054 6865 2070 7269  ..    #: The pri
-00009080: 6f72 6974 7920 7072 6f76 6964 6573 2065  ority provides e
-00009090: 6163 6820 7461 736b 2077 6974 6820 6120  ach task with a 
-000090a0: 7265 6c61 7469 7665 2072 616e 6b69 6e67  relative ranking
-000090b0: 2077 6869 6368 2069 7320 7573 6564 2074   which is used t
-000090c0: 6f20 6272 6561 6b0a 2020 2020 233a 2074  o break.    #: t
-000090d0: 6965 7320 7768 656e 206d 616e 7920 7461  ies when many ta
-000090e0: 736b 7320 6172 6520 6265 696e 6720 636f  sks are being co
-000090f0: 6e73 6964 6572 6564 2066 6f72 2065 7865  nsidered for exe
-00009100: 6375 7469 6f6e 2e0a 2020 2020 233a 0a20  cution..    #:. 
-00009110: 2020 2023 3a20 5468 6973 2072 616e 6b69     #: This ranki
-00009120: 6e67 2069 7320 6765 6e65 7261 6c6c 7920  ng is generally 
-00009130: 6120 322d 6974 656d 2074 7570 6c65 2e20  a 2-item tuple. 
-00009140: 2054 6865 2066 6972 7374 2028 616e 6420   The first (and 
-00009150: 646f 6d69 6e61 6e74 2920 6974 656d 0a20  dominant) item. 
-00009160: 2020 2023 3a20 636f 7272 6573 706f 6e64     #: correspond
-00009170: 7320 746f 2077 6865 6e20 6974 2077 6173  s to when it was
-00009180: 2073 7562 6d69 7474 6564 2e20 2047 656e   submitted.  Gen
-00009190: 6572 616c 6c79 2c20 6561 726c 6965 7220  erally, earlier 
-000091a0: 7461 736b 7320 7461 6b65 2070 7265 6365  tasks take prece
-000091b0: 6465 6e63 652e 0a20 2020 2023 3a20 5468  dence..    #: Th
-000091c0: 6520 7365 636f 6e64 2069 7465 6d20 6973  e second item is
-000091d0: 2064 6574 6572 6d69 6e65 6420 6279 2074   determined by t
-000091e0: 6865 2063 6c69 656e 742c 2061 6e64 2069  he client, and i
-000091f0: 7320 6120 7761 7920 746f 2070 7269 6f72  s a way to prior
-00009200: 6974 697a 6520 7461 736b 730a 2020 2020  itize tasks.    
-00009210: 233a 2077 6974 6869 6e20 6120 6c61 7267  #: within a larg
-00009220: 6520 6772 6170 6820 7468 6174 206d 6179  e graph that may
-00009230: 2062 6520 696d 706f 7274 616e 742c 2073   be important, s
-00009240: 7563 6820 6173 2069 6620 7468 6579 2061  uch as if they a
-00009250: 7265 206f 6e20 7468 6520 6372 6974 6963  re on the critic
-00009260: 616c 0a20 2020 2023 3a20 7061 7468 2c20  al.    #: path, 
-00009270: 6f72 2067 6f6f 6420 746f 2072 756e 2069  or good to run i
-00009280: 6e20 6f72 6465 7220 746f 2072 656c 6561  n order to relea
-00009290: 7365 206d 616e 7920 6465 7065 6e64 656e  se many dependen
-000092a0: 6369 6573 2e20 2054 6869 7320 6973 2065  cies.  This is e
-000092b0: 7870 6c61 696e 6564 0a20 2020 2023 3a20  xplained.    #: 
-000092c0: 6675 7274 6865 7220 696e 203a 646f 633a  further in :doc:
-000092d0: 6053 6368 6564 756c 696e 6720 506f 6c69  `Scheduling Poli
-000092e0: 6379 203c 7363 6865 6475 6c69 6e67 2d70  cy <scheduling-p
-000092f0: 6f6c 6963 6965 733e 602e 0a20 2020 2070  olicies>`..    p
-00009300: 7269 6f72 6974 793a 2074 7570 6c65 5b69  riority: tuple[i
-00009310: 6e74 2c20 2e2e 2e5d 0a0a 2020 2020 2320  nt, ...]..    # 
-00009320: 4174 7472 6962 7574 6520 756e 6465 726c  Attribute underl
-00009330: 7969 6e67 2074 6865 2073 7461 7465 2070  ying the state p
-00009340: 726f 7065 7274 790a 2020 2020 5f73 7461  roperty.    _sta
-00009350: 7465 3a20 5461 736b 5374 6174 6553 7461  te: TaskStateSta
-00009360: 7465 0a0a 2020 2020 233a 2054 6865 2073  te..    #: The s
-00009370: 6574 206f 6620 7461 736b 7320 7468 6973  et of tasks this
-00009380: 2074 6173 6b20 6465 7065 6e64 7320 6f6e   task depends on
-00009390: 2066 6f72 2070 726f 7065 7220 6578 6563   for proper exec
-000093a0: 7574 696f 6e2e 204f 6e6c 7920 7461 736b  ution. Only task
-000093b0: 7320 7374 696c 6c0a 2020 2020 233a 2061  s still.    #: a
-000093c0: 6c69 7665 2061 7265 206c 6973 7465 6420  live are listed 
-000093d0: 696e 2074 6869 7320 7365 742e 2049 662c  in this set. If,
-000093e0: 2066 6f72 2077 6861 7465 7665 7220 7265   for whatever re
-000093f0: 6173 6f6e 2c20 7468 6973 2074 6173 6b20  ason, this task 
-00009400: 616c 736f 2064 6570 656e 6473 206f 6e0a  also depends on.
-00009410: 2020 2020 233a 2061 2066 6f72 676f 7474      #: a forgott
-00009420: 656e 2074 6173 6b2c 2074 6865 203a 6174  en task, the :at
-00009430: 7472 3a60 6861 735f 6c6f 7374 5f64 6570  tr:`has_lost_dep
-00009440: 656e 6465 6e63 6965 7360 2066 6c61 6720  endencies` flag 
-00009450: 6973 2073 6574 2e0a 2020 2020 233a 0a20  is set..    #:. 
-00009460: 2020 2023 3a20 4120 7461 736b 2063 616e     #: A task can
-00009470: 206f 6e6c 7920 6265 2065 7865 6375 7465   only be execute
-00009480: 6420 6f6e 6365 2061 6c6c 2069 7473 2064  d once all its d
-00009490: 6570 656e 6465 6e63 6965 7320 6861 7665  ependencies have
-000094a0: 2061 6c72 6561 6479 2062 6565 6e0a 2020   already been.  
-000094b0: 2020 233a 2073 7563 6365 7373 6675 6c6c    #: successfull
-000094c0: 7920 6578 6563 7574 6564 2061 6e64 2068  y executed and h
-000094d0: 6176 6520 7468 6569 7220 7265 7375 6c74  ave their result
-000094e0: 2073 746f 7265 6420 6f6e 2061 7420 6c65   stored on at le
-000094f0: 6173 7420 6f6e 6520 776f 726b 6572 2e20  ast one worker. 
-00009500: 5468 6973 0a20 2020 2023 3a20 6973 2074  This.    #: is t
-00009510: 7261 636b 6564 2062 7920 7072 6f67 7265  racked by progre
-00009520: 7373 6976 656c 7920 6472 6169 6e69 6e67  ssively draining
-00009530: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
-00009540: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
-00009550: 2064 6570 656e 6465 6e63 6965 733a 2073   dependencies: s
-00009560: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
-00009570: 2020 2023 3a20 5468 6520 7365 7420 6f66     #: The set of
-00009580: 2074 6173 6b73 2077 6869 6368 2064 6570   tasks which dep
-00009590: 656e 6420 6f6e 2074 6869 7320 7461 736b  end on this task
-000095a0: 2e20 204f 6e6c 7920 7461 736b 7320 7374  .  Only tasks st
-000095b0: 696c 6c20 616c 6976 6520 6172 6520 6c69  ill alive are li
-000095c0: 7374 6564 2069 6e0a 2020 2020 233a 2074  sted in.    #: t
-000095d0: 6869 7320 7365 742e 2054 6869 7320 6973  his set. This is
-000095e0: 2074 6865 2072 6576 6572 7365 206d 6170   the reverse map
-000095f0: 7069 6e67 206f 6620 3a61 7474 723a 6064  ping of :attr:`d
-00009600: 6570 656e 6465 6e63 6965 7360 2e0a 2020  ependencies`..  
-00009610: 2020 6465 7065 6e64 656e 7473 3a20 7365    dependents: se
-00009620: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
-00009630: 2020 233a 2057 6865 7468 6572 2061 6e79    #: Whether any
-00009640: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
-00009650: 6369 6573 206f 6620 7468 6973 2074 6173  cies of this tas
-00009660: 6b20 6861 7320 6265 656e 2066 6f72 676f  k has been forgo
-00009670: 7474 656e 2e20 466f 7220 6d65 6d6f 7279  tten. For memory
-00009680: 0a20 2020 2023 3a20 636f 6e73 756d 7074  .    #: consumpt
-00009690: 696f 6e20 7265 6173 6f6e 732c 2066 6f72  ion reasons, for
-000096a0: 676f 7474 656e 2074 6173 6b73 2061 7265  gotten tasks are
-000096b0: 206e 6f74 206b 6570 7420 696e 206d 656d   not kept in mem
-000096c0: 6f72 7920 6576 656e 2074 686f 7567 6820  ory even though 
-000096d0: 7468 6579 206d 6179 0a20 2020 2023 3a20  they may.    #: 
-000096e0: 6861 7665 2064 6570 656e 6465 6e74 2074  have dependent t
-000096f0: 6173 6b73 2e20 2057 6865 6e20 6120 7461  asks.  When a ta
-00009700: 736b 2069 7320 666f 7267 6f74 7465 6e2c  sk is forgotten,
-00009710: 2074 6865 7265 666f 7265 2c20 6561 6368   therefore, each
-00009720: 206f 6620 6974 730a 2020 2020 233a 2064   of its.    #: d
-00009730: 6570 656e 6465 6e74 7320 6861 7320 7468  ependents has th
-00009740: 6569 7220 3a61 7474 723a 6068 6173 5f6c  eir :attr:`has_l
-00009750: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-00009760: 6020 6174 7472 6962 7574 6520 7365 7420  ` attribute set 
-00009770: 746f 2060 6054 7275 6560 602e 0a20 2020  to ``True``..   
-00009780: 2023 3a0a 2020 2020 233a 2049 6620 3a61   #:.    #: If :a
-00009790: 7474 723a 6068 6173 5f6c 6f73 745f 6465  ttr:`has_lost_de
-000097a0: 7065 6e64 656e 6369 6573 6020 6973 2074  pendencies` is t
-000097b0: 7275 652c 2074 6869 7320 7461 736b 2063  rue, this task c
-000097c0: 616e 6e6f 7420 676f 2069 6e74 6f20 7468  annot go into th
-000097d0: 650a 2020 2020 233a 2022 7072 6f63 6573  e.    #: "proces
-000097e0: 7369 6e67 2220 7374 6174 6520 616e 796d  sing" state anym
-000097f0: 6f72 652e 0a20 2020 2068 6173 5f6c 6f73  ore..    has_los
-00009800: 745f 6465 7065 6e64 656e 6369 6573 3a20  t_dependencies: 
-00009810: 626f 6f6c 0a0a 2020 2020 233a 2054 6865  bool..    #: The
-00009820: 2073 6574 206f 6620 7461 736b 7320 7468   set of tasks th
-00009830: 6973 2074 6173 6b20 6973 2077 6169 7469  is task is waiti
-00009840: 6e67 206f 6e20 2a62 6566 6f72 652a 2069  ng on *before* i
-00009850: 7420 6361 6e20 6265 2065 7865 6375 7465  t can be execute
-00009860: 642e 2054 6869 7320 6973 0a20 2020 2023  d. This is.    #
-00009870: 3a20 616c 7761 7973 2061 2073 7562 7365  : always a subse
-00009880: 7420 6f66 203a 6174 7472 3a60 6465 7065  t of :attr:`depe
-00009890: 6e64 656e 6369 6573 602e 2020 4561 6368  ndencies`.  Each
-000098a0: 2074 696d 6520 6f6e 6520 6f66 2074 6865   time one of the
-000098b0: 2064 6570 656e 6465 6e63 6965 7320 6861   dependencies ha
-000098c0: 730a 2020 2020 233a 2066 696e 6973 6865  s.    #: finishe
-000098d0: 6420 7072 6f63 6573 7369 6e67 2c20 6974  d processing, it
-000098e0: 2069 7320 7265 6d6f 7665 6420 6672 6f6d   is removed from
-000098f0: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
-00009900: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
-00009910: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
-00009920: 3a61 7474 723a 6077 6169 7469 6e67 5f6f  :attr:`waiting_o
-00009930: 6e60 2062 6563 6f6d 6573 2065 6d70 7479  n` becomes empty
-00009940: 2c20 7468 6973 2074 6173 6b20 6361 6e20  , this task can 
-00009950: 6d6f 7665 2066 726f 6d20 7468 6520 2277  move from the "w
-00009960: 6169 7469 6e67 220a 2020 2020 233a 2073  aiting".    #: s
-00009970: 7461 7465 2074 6f20 7468 6520 2270 726f  tate to the "pro
-00009980: 6365 7373 696e 6722 2073 7461 7465 2028  cessing" state (
-00009990: 756e 6c65 7373 206f 6e65 206f 6620 7468  unless one of th
-000099a0: 6520 6465 7065 6e64 656e 6369 6573 2065  e dependencies e
-000099b0: 7272 6f72 6564 206f 7574 2c20 696e 0a20  rrored out, in. 
-000099c0: 2020 2023 3a20 7768 6963 6820 6361 7365     #: which case
-000099d0: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
-000099e0: 7374 6561 6420 6d61 726b 6564 2022 6572  stead marked "er
-000099f0: 7265 6422 292e 0a20 2020 2077 6169 7469  red")..    waiti
-00009a00: 6e67 5f6f 6e3a 2073 6574 5b54 6173 6b53  ng_on: set[TaskS
-00009a10: 7461 7465 5d0a 0a20 2020 2023 3a20 5468  tate]..    #: Th
-00009a20: 6520 7365 7420 6f66 2074 6173 6b73 2077  e set of tasks w
-00009a30: 6869 6368 206e 6565 6420 7468 6973 2074  hich need this t
-00009a40: 6173 6b20 746f 2072 656d 6169 6e20 616c  ask to remain al
-00009a50: 6976 652e 2020 5468 6973 2069 7320 616c  ive.  This is al
-00009a60: 7761 7973 2061 2073 7562 7365 740a 2020  ways a subset.  
-00009a70: 2020 233a 206f 6620 3a61 7474 723a 6064    #: of :attr:`d
-00009a80: 6570 656e 6465 6e74 7360 2e20 2045 6163  ependents`.  Eac
-00009a90: 6820 7469 6d65 206f 6e65 206f 6620 7468  h time one of th
-00009aa0: 6520 6465 7065 6e64 656e 7473 2068 6173  e dependents has
-00009ab0: 2066 696e 6973 6865 6420 7072 6f63 6573   finished proces
-00009ac0: 7369 6e67 2c0a 2020 2020 233a 2069 7420  sing,.    #: it 
-00009ad0: 6973 2072 656d 6f76 6564 2066 726f 6d20  is removed from 
-00009ae0: 7468 6520 3a61 7474 723a 6077 6169 7465  the :attr:`waite
-00009af0: 7273 6020 7365 742e 0a20 2020 2023 3a0a  rs` set..    #:.
-00009b00: 2020 2020 233a 204f 6e63 6520 626f 7468      #: Once both
-00009b10: 203a 6174 7472 3a60 7761 6974 6572 7360   :attr:`waiters`
-00009b20: 2061 6e64 203a 6174 7472 3a60 7768 6f5f   and :attr:`who_
-00009b30: 7761 6e74 7360 2062 6563 6f6d 6520 656d  wants` become em
-00009b40: 7074 792c 2074 6869 7320 7461 736b 2063  pty, this task c
-00009b50: 616e 2062 650a 2020 2020 233a 2072 656c  an be.    #: rel
-00009b60: 6561 7365 6420 2869 6620 6974 2068 6173  eased (if it has
-00009b70: 2061 206e 6f6e 2d65 6d70 7479 203a 6174   a non-empty :at
-00009b80: 7472 3a60 7275 6e5f 7370 6563 6029 206f  tr:`run_spec`) o
-00009b90: 7220 666f 7267 6f74 7465 6e20 286f 7468  r forgotten (oth
-00009ba0: 6572 7769 7365 2920 6279 2074 6865 0a20  erwise) by the. 
-00009bb0: 2020 2023 3a20 7363 6865 6475 6c65 722c     #: scheduler,
-00009bc0: 2061 6e64 2062 7920 616e 7920 776f 726b   and by any work
-00009bd0: 6572 7320 696e 203a 6174 7472 3a60 7768  ers in :attr:`wh
-00009be0: 6f5f 6861 7360 2e0a 2020 2020 233a 0a20  o_has`..    #:. 
-00009bf0: 2020 2023 3a20 2e2e 206e 6f74 653a 3a0a     #: .. note::.
-00009c00: 2020 2020 233a 2020 2020 436f 756e 7465      #:    Counte
-00009c10: 722d 696e 7475 6974 6976 656c 792c 203a  r-intuitively, :
-00009c20: 6174 7472 3a60 7761 6974 696e 675f 6f6e  attr:`waiting_on
-00009c30: 6020 616e 6420 3a61 7474 723a 6077 6169  ` and :attr:`wai
-00009c40: 7465 7273 6020 6172 6520 6e6f 7420 7265  ters` are not re
-00009c50: 7665 7273 650a 2020 2020 233a 2020 2020  verse.    #:    
-00009c60: 6d61 7070 696e 6773 206f 6620 6561 6368  mappings of each
-00009c70: 206f 7468 6572 2e0a 2020 2020 7761 6974   other..    wait
-00009c80: 6572 733a 2073 6574 5b54 6173 6b53 7461  ers: set[TaskSta
-00009c90: 7465 5d0a 0a20 2020 2023 3a20 5468 6520  te]..    #: The 
-00009ca0: 7365 7420 6f66 2063 6c69 656e 7473 2077  set of clients w
-00009cb0: 686f 2077 616e 7420 7468 6520 7265 7375  ho want the resu
-00009cc0: 6c74 206f 6620 7468 6973 2074 6173 6b20  lt of this task 
-00009cd0: 746f 2072 656d 6169 6e20 616c 6976 652e  to remain alive.
-00009ce0: 0a20 2020 2023 3a20 5468 6973 2069 7320  .    #: This is 
-00009cf0: 7468 6520 7265 7665 7273 6520 6d61 7070  the reverse mapp
-00009d00: 696e 6720 6f66 203a 6174 7472 3a60 436c  ing of :attr:`Cl
-00009d10: 6965 6e74 5374 6174 652e 7761 6e74 735f  ientState.wants_
-00009d20: 7768 6174 602e 0a20 2020 2023 3a0a 2020  what`..    #:.  
-00009d30: 2020 233a 2057 6865 6e20 6120 636c 6965    #: When a clie
-00009d40: 6e74 2073 7562 6d69 7473 2061 2067 7261  nt submits a gra
-00009d50: 7068 2074 6f20 7468 6520 7363 6865 6475  ph to the schedu
-00009d60: 6c65 7220 6974 2061 6c73 6f20 7370 6563  ler it also spec
-00009d70: 6966 6965 7320 7768 6963 6820 6f75 7470  ifies which outp
-00009d80: 7574 0a20 2020 2023 3a20 7461 736b 7320  ut.    #: tasks 
-00009d90: 6974 2064 6573 6972 6573 2c20 7375 6368  it desires, such
-00009da0: 2074 6861 7420 7468 6569 7220 7265 7375   that their resu
-00009db0: 6c74 7320 6172 6520 6e6f 7420 7265 6c65  lts are not rele
-00009dc0: 6173 6564 2066 726f 6d20 6d65 6d6f 7279  ased from memory
-00009dd0: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
-00009de0: 4f6e 6365 2061 2074 6173 6b20 6861 7320  Once a task has 
-00009df0: 6669 6e69 7368 6564 2065 7865 6375 7469  finished executi
-00009e00: 6e67 2028 692e 652e 206d 6f76 6573 2069  ng (i.e. moves i
-00009e10: 6e74 6f20 7468 6520 226d 656d 6f72 7922  nto the "memory"
-00009e20: 206f 7220 2265 7272 6564 220a 2020 2020   or "erred".    
-00009e30: 233a 2073 7461 7465 292c 2074 6865 2063  #: state), the c
-00009e40: 6c69 656e 7473 2069 6e20 3a61 7474 723a  lients in :attr:
-00009e50: 6077 686f 5f77 616e 7473 6020 6172 6520  `who_wants` are 
-00009e60: 6e6f 7469 6669 6564 2e0a 2020 2020 233a  notified..    #:
-00009e70: 0a20 2020 2023 3a20 4f6e 6365 2062 6f74  .    #: Once bot
-00009e80: 6820 3a61 7474 723a 6077 6169 7465 7273  h :attr:`waiters
-00009e90: 6020 616e 6420 3a61 7474 723a 6077 686f  ` and :attr:`who
-00009ea0: 5f77 616e 7473 6020 6265 636f 6d65 2065  _wants` become e
-00009eb0: 6d70 7479 2c20 7468 6973 2074 6173 6b20  mpty, this task 
-00009ec0: 6361 6e20 6265 0a20 2020 2023 3a20 7265  can be.    #: re
-00009ed0: 6c65 6173 6564 2028 6966 2069 7420 6861  leased (if it ha
-00009ee0: 7320 6120 6e6f 6e2d 656d 7074 7920 3a61  s a non-empty :a
-00009ef0: 7474 723a 6072 756e 5f73 7065 6360 2920  ttr:`run_spec`) 
-00009f00: 6f72 2066 6f72 676f 7474 656e 2028 6f74  or forgotten (ot
-00009f10: 6865 7277 6973 6529 2062 7920 7468 650a  herwise) by the.
-00009f20: 2020 2020 233a 2073 6368 6564 756c 6572      #: scheduler
-00009f30: 2c20 616e 6420 6279 2061 6e79 2077 6f72  , and by any wor
-00009f40: 6b65 7273 2069 6e20 3a61 7474 723a 6077  kers in :attr:`w
-00009f50: 686f 5f68 6173 602e 0a20 2020 2077 686f  ho_has`..    who
-00009f60: 5f77 616e 7473 3a20 7365 745b 436c 6965  _wants: set[Clie
-00009f70: 6e74 5374 6174 655d 0a0a 2020 2020 233a  ntState]..    #:
-00009f80: 2054 6865 2073 6574 206f 6620 776f 726b   The set of work
-00009f90: 6572 7320 7768 6f20 6861 7665 2074 6869  ers who have thi
-00009fa0: 7320 7461 736b 2773 2072 6573 756c 7420  s task's result 
-00009fb0: 696e 206d 656d 6f72 792e 2049 7420 6973  in memory. It is
-00009fc0: 206e 6f6e 2d65 6d70 7479 2069 6666 2074   non-empty iff t
-00009fd0: 6865 0a20 2020 2023 3a20 7461 736b 2069  he.    #: task i
-00009fe0: 7320 696e 2074 6865 2022 6d65 6d6f 7279  s in the "memory
-00009ff0: 2220 7374 6174 652e 2020 5468 6572 6520  " state.  There 
-0000a000: 6361 6e20 6265 206d 6f72 6520 7468 616e  can be more than
-0000a010: 206f 6e65 2077 6f72 6b65 7220 696e 2074   one worker in t
-0000a020: 6869 7320 7365 7420 6966 2c0a 2020 2020  his set if,.    
-0000a030: 233a 2066 6f72 2065 7861 6d70 6c65 2c20  #: for example, 
-0000a040: 3a6d 6574 683a 6043 6c69 656e 742e 7363  :meth:`Client.sc
-0000a050: 6174 7465 7260 206f 7220 3a6d 6574 683a  atter` or :meth:
-0000a060: 6043 6c69 656e 742e 7265 706c 6963 6174  `Client.replicat
-0000a070: 6560 2077 6173 2075 7365 642e 0a20 2020  e` was used..   
-0000a080: 2023 3a0a 2020 2020 233a 2054 6869 7320   #:.    #: This 
-0000a090: 6973 2074 6865 2072 6576 6572 7365 206d  is the reverse m
-0000a0a0: 6170 7069 6e67 206f 6620 3a61 7474 723a  apping of :attr:
-0000a0b0: 6057 6f72 6b65 7253 7461 7465 2e68 6173  `WorkerState.has
-0000a0c0: 5f77 6861 7460 2e0a 2020 2020 7768 6f5f  _what`..    who_
-0000a0d0: 6861 733a 2073 6574 5b57 6f72 6b65 7253  has: set[WorkerS
-0000a0e0: 7461 7465 5d0a 0a20 2020 2023 3a20 4966  tate]..    #: If
-0000a0f0: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
-0000a100: 2074 6865 2022 7072 6f63 6573 7369 6e67   the "processing
-0000a110: 2220 7374 6174 652c 2077 6869 6368 2077  " state, which w
-0000a120: 6f72 6b65 7220 6973 2063 7572 7265 6e74  orker is current
-0000a130: 6c79 2070 726f 6365 7373 696e 670a 2020  ly processing.  
-0000a140: 2020 233a 2069 742e 2054 6869 7320 6174    #: it. This at
-0000a150: 7472 6962 7574 6520 6973 206b 6570 7420  tribute is kept 
-0000a160: 696e 2073 796e 6320 7769 7468 203a 6174  in sync with :at
-0000a170: 7472 3a60 576f 726b 6572 5374 6174 652e  tr:`WorkerState.
-0000a180: 7072 6f63 6573 7369 6e67 602e 0a20 2020  processing`..   
-0000a190: 2070 726f 6365 7373 696e 675f 6f6e 3a20   processing_on: 
-0000a1a0: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
-0000a1b0: 6e65 0a0a 2020 2020 233a 2054 6865 206e  ne..    #: The n
-0000a1c0: 756d 6265 7220 6f66 2074 696d 6573 2074  umber of times t
-0000a1d0: 6869 7320 7461 736b 2063 616e 2061 7574  his task can aut
-0000a1e0: 6f6d 6174 6963 616c 6c79 2062 6520 7265  omatically be re
-0000a1f0: 7472 6965 6420 696e 2063 6173 6520 6f66  tried in case of
-0000a200: 2066 6169 6c75 7265 2e0a 2020 2020 233a   failure..    #:
-0000a210: 2049 6620 6120 7461 736b 2066 6169 6c73   If a task fails
-0000a220: 2065 7865 6375 7469 6e67 2028 7468 6520   executing (the 
-0000a230: 776f 726b 6572 2072 6574 7572 6e73 2077  worker returns w
-0000a240: 6974 6820 616e 2065 7272 6f72 292c 2069  ith an error), i
-0000a250: 7473 203a 6174 7472 3a60 7265 7472 6965  ts :attr:`retrie
-0000a260: 7360 0a20 2020 2023 3a20 6174 7472 6962  s`.    #: attrib
-0000a270: 7574 6520 6973 2063 6865 636b 6564 2e20  ute is checked. 
-0000a280: 4966 2069 7420 6973 2065 7175 616c 2074  If it is equal t
-0000a290: 6f20 302c 2074 6865 2074 6173 6b20 6973  o 0, the task is
-0000a2a0: 206d 6172 6b65 6420 2265 7272 6564 222e   marked "erred".
-0000a2b0: 2049 6620 6974 2069 730a 2020 2020 233a   If it is.    #:
-0000a2c0: 2067 7265 6174 6572 2074 6861 6e20 302c   greater than 0,
-0000a2d0: 2074 6865 203a 6174 7472 3a60 7265 7472   the :attr:`retr
-0000a2e0: 6965 7360 2061 7474 7269 6275 7465 2069  ies` attribute i
-0000a2f0: 7320 6465 6372 656d 656e 7465 6420 616e  s decremented an
-0000a300: 6420 6578 6563 7574 696f 6e20 6973 0a20  d execution is. 
-0000a310: 2020 2023 3a20 6174 7465 6d70 7465 6420     #: attempted 
-0000a320: 6167 6169 6e2e 0a20 2020 2072 6574 7269  again..    retri
-0000a330: 6573 3a20 696e 740a 0a20 2020 2023 3a20  es: int..    #: 
-0000a340: 5468 6520 6e75 6d62 6572 206f 6620 6279  The number of by
-0000a350: 7465 732c 2061 7320 6465 7465 726d 696e  tes, as determin
-0000a360: 6564 2062 7920 6060 7369 7a65 6f66 6060  ed by ``sizeof``
-0000a370: 2c20 6f66 2074 6865 2072 6573 756c 7420  , of the result 
-0000a380: 6f66 2061 2066 696e 6973 6865 640a 2020  of a finished.  
-0000a390: 2020 233a 2074 6173 6b2e 2054 6869 7320    #: task. This 
-0000a3a0: 6e75 6d62 6572 2069 7320 7573 6564 2066  number is used f
-0000a3b0: 6f72 2064 6961 676e 6f73 7469 6373 2061  or diagnostics a
-0000a3c0: 6e64 2074 6f20 6865 6c70 2070 7269 6f72  nd to help prior
-0000a3d0: 6974 697a 6520 776f 726b 2e0a 2020 2020  itize work..    
-0000a3e0: 233a 2053 6574 2074 6f20 2d31 2066 6f72  #: Set to -1 for
-0000a3f0: 2075 6e66 696e 6973 6865 6420 7461 736b   unfinished task
-0000a400: 732e 0a20 2020 206e 6279 7465 733a 2069  s..    nbytes: i
-0000a410: 6e74 0a0a 2020 2020 233a 2054 6865 2074  nt..    #: The t
-0000a420: 7970 6520 6f66 2074 6865 206f 626a 6563  ype of the objec
-0000a430: 7420 6173 2061 2073 7472 696e 672e 204f  t as a string. O
-0000a440: 6e6c 7920 7072 6573 656e 7420 666f 7220  nly present for 
-0000a450: 7461 736b 7320 7468 6174 2068 6176 6520  tasks that have 
-0000a460: 6265 656e 0a20 2020 2023 3a20 636f 6d70  been.    #: comp
-0000a470: 7574 6564 2e0a 2020 2020 7479 7065 3a20  uted..    type: 
-0000a480: 7374 720a 0a20 2020 2023 3a20 4966 2074  str..    #: If t
-0000a490: 6869 7320 7461 736b 2066 6169 6c65 6420  his task failed 
-0000a4a0: 6578 6563 7574 696e 672c 2074 6865 2065  executing, the e
-0000a4b0: 7863 6570 7469 6f6e 206f 626a 6563 7420  xception object 
-0000a4c0: 6973 2073 746f 7265 6420 6865 7265 2e0a  is stored here..
-0000a4d0: 2020 2020 6578 6365 7074 696f 6e3a 2053      exception: S
-0000a4e0: 6572 6961 6c69 7a65 6420 7c20 4e6f 6e65  erialized | None
-0000a4f0: 0a0a 2020 2020 233a 2049 6620 7468 6973  ..    #: If this
-0000a500: 2074 6173 6b20 6661 696c 6564 2065 7865   task failed exe
-0000a510: 6375 7469 6e67 2c20 7468 6520 7472 6163  cuting, the trac
-0000a520: 6562 6163 6b20 6f62 6a65 6374 2069 7320  eback object is 
-0000a530: 7374 6f72 6564 2068 6572 652e 0a20 2020  stored here..   
-0000a540: 2074 7261 6365 6261 636b 3a20 5365 7269   traceback: Seri
-0000a550: 616c 697a 6564 207c 204e 6f6e 650a 0a20  alized | None.. 
-0000a560: 2020 2023 3a20 7374 7269 6e67 2072 6570     #: string rep
-0000a570: 7265 7365 6e74 6174 696f 6e20 6f66 2065  resentation of e
-0000a580: 7863 6570 7469 6f6e 0a20 2020 2065 7863  xception.    exc
-0000a590: 6570 7469 6f6e 5f74 6578 743a 2073 7472  eption_text: str
-0000a5a0: 0a0a 2020 2020 233a 2073 7472 696e 6720  ..    #: string 
-0000a5b0: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
-0000a5c0: 6620 7472 6163 6562 6163 6b0a 2020 2020  f traceback.    
-0000a5d0: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
-0000a5e0: 7374 720a 0a20 2020 2023 3a20 4966 2074  str..    #: If t
-0000a5f0: 6869 7320 7461 736b 206f 7220 6f6e 6520  his task or one 
-0000a600: 6f66 2069 7473 2064 6570 656e 6465 6e63  of its dependenc
-0000a610: 6965 7320 6661 696c 6564 2065 7865 6375  ies failed execu
-0000a620: 7469 6e67 2c20 7468 6520 6661 696c 6564  ting, the failed
-0000a630: 2074 6173 6b20 6973 0a20 2020 2023 3a20   task is.    #: 
-0000a640: 7374 6f72 6564 2068 6572 6520 2870 6f73  stored here (pos
-0000a650: 7369 626c 7920 6974 7365 6c66 292e 0a20  sibly itself).. 
-0000a660: 2020 2065 7863 6570 7469 6f6e 5f62 6c61     exception_bla
-0000a670: 6d65 3a20 5461 736b 5374 6174 6520 7c20  me: TaskState | 
-0000a680: 4e6f 6e65 0a0a 2020 2020 233a 2057 6f72  None..    #: Wor
-0000a690: 6b65 7220 6164 6472 6573 7365 7320 6f6e  ker addresses on
-0000a6a0: 2077 6869 6368 2065 7272 6f72 7320 6170   which errors ap
-0000a6b0: 7065 6172 6564 2c20 6361 7573 696e 6720  peared, causing 
-0000a6c0: 7468 6973 2074 6173 6b20 746f 2062 6520  this task to be 
-0000a6d0: 696e 2061 6e20 6572 726f 720a 2020 2020  in an error.    
-0000a6e0: 233a 2073 7461 7465 2e0a 2020 2020 6572  #: state..    er
-0000a6f0: 7265 645f 6f6e 3a20 7365 745b 7374 725d  red_on: set[str]
-0000a700: 0a0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
-0000a710: 6265 7220 6f66 2074 696d 6573 2074 6869  ber of times thi
-0000a720: 7320 7461 736b 2068 6173 2062 6565 6e20  s task has been 
-0000a730: 696e 766f 6c76 6564 2069 6e20 6120 776f  involved in a wo
-0000a740: 726b 6572 2064 6561 7468 2e0a 2020 2020  rker death..    
-0000a750: 233a 0a20 2020 2023 3a20 536f 6d65 2074  #:.    #: Some t
-0000a760: 6173 6b73 206d 6179 2063 6175 7365 2077  asks may cause w
-0000a770: 6f72 6b65 7273 2074 6f20 6469 6520 2873  orkers to die (s
-0000a780: 7563 6820 6173 2063 616c 6c69 6e67 2060  uch as calling `
-0000a790: 606f 732e 5f65 7869 7428 3029 6060 292e  `os._exit(0)``).
-0000a7a0: 2057 6865 6e20 610a 2020 2020 233a 2077   When a.    #: w
-0000a7b0: 6f72 6b65 7220 6469 6573 2c20 616c 6c20  orker dies, all 
-0000a7c0: 6f66 2074 6865 2074 6173 6b73 206f 6e20  of the tasks on 
-0000a7d0: 7468 6174 2077 6f72 6b65 7220 6172 6520  that worker are 
-0000a7e0: 7265 6173 7369 676e 6564 2074 6f20 6f74  reassigned to ot
-0000a7f0: 6865 7273 2e20 5468 6973 0a20 2020 2023  hers. This.    #
-0000a800: 3a20 636f 6d62 696e 6174 696f 6e20 6f66  : combination of
-0000a810: 2062 6568 6176 696f 7273 2063 616e 2063   behaviors can c
-0000a820: 6175 7365 2061 2062 6164 2074 6173 6b20  ause a bad task 
-0000a830: 746f 2063 6174 6173 7472 6f70 6869 6361  to catastrophica
-0000a840: 6c6c 7920 6465 7374 726f 7920 616c 6c0a  lly destroy all.
-0000a850: 2020 2020 233a 2077 6f72 6b65 7273 206f      #: workers o
-0000a860: 6e20 7468 6520 636c 7573 7465 722c 206f  n the cluster, o
-0000a870: 6e65 2061 6674 6572 2061 6e6f 7468 6572  ne after another
-0000a880: 2e20 5768 656e 6576 6572 2061 2077 6f72  . Whenever a wor
-0000a890: 6b65 7220 6469 6573 2c20 7765 206d 6172  ker dies, we mar
-0000a8a0: 6b20 6561 6368 0a20 2020 2023 3a20 7461  k each.    #: ta
-0000a8b0: 736b 2063 7572 7265 6e74 6c79 2070 726f  sk currently pro
-0000a8c0: 6365 7373 696e 6720 6f6e 2074 6861 7420  cessing on that 
-0000a8d0: 776f 726b 6572 2028 6173 2072 6563 6f72  worker (as recor
-0000a8e0: 6465 6420 6279 0a20 2020 2023 3a20 3a61  ded by.    #: :a
-0000a8f0: 7474 723a 6057 6f72 6b65 7253 7461 7465  ttr:`WorkerState
-0000a900: 2e70 726f 6365 7373 696e 6760 2920 6173  .processing`) as
-0000a910: 2073 7573 7069 6369 6f75 732e 2049 6620   suspicious. If 
-0000a920: 6120 7461 736b 2069 7320 696e 766f 6c76  a task is involv
-0000a930: 6564 2069 6e20 7468 7265 650a 2020 2020  ed in three.    
-0000a940: 233a 2064 6561 7468 7320 286f 7220 736f  #: deaths (or so
-0000a950: 6d65 206f 7468 6572 2066 6978 6564 2063  me other fixed c
-0000a960: 6f6e 7374 616e 7429 2074 6865 6e20 7765  onstant) then we
-0000a970: 206d 6172 6b20 7468 6520 7461 736b 2061   mark the task a
-0000a980: 7320 6060 6572 7265 6460 602e 0a20 2020  s ``erred``..   
-0000a990: 2073 7573 7069 6369 6f75 733a 2069 6e74   suspicious: int
-0000a9a0: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
-0000a9b0: 6620 686f 7374 6e61 6d65 7320 7768 6572  f hostnames wher
-0000a9c0: 6520 7468 6973 2074 6173 6b20 6361 6e20  e this task can 
-0000a9d0: 6265 2072 756e 2028 6f72 2060 604e 6f6e  be run (or ``Non
-0000a9e0: 6560 6020 6966 2065 6d70 7479 292e 2055  e`` if empty). U
-0000a9f0: 7375 616c 6c79 0a20 2020 2023 3a20 7468  sually.    #: th
-0000aa00: 6973 2069 7320 656d 7074 7920 756e 6c65  is is empty unle
-0000aa10: 7373 2074 6865 2074 6173 6b20 6861 7320  ss the task has 
-0000aa20: 6265 656e 2073 7065 6369 6669 6361 6c6c  been specificall
-0000aa30: 7920 7265 7374 7269 6374 6564 2074 6f20  y restricted to 
-0000aa40: 6f6e 6c79 2072 756e 206f 6e0a 2020 2020  only run on.    
-0000aa50: 233a 2063 6572 7461 696e 2068 6f73 7473  #: certain hosts
-0000aa60: 2e20 4120 686f 7374 6e61 6d65 206d 6179  . A hostname may
-0000aa70: 2063 6f72 7265 7370 6f6e 6420 746f 206f   correspond to o
-0000aa80: 6e65 206f 7220 7365 7665 7261 6c20 636f  ne or several co
-0000aa90: 6e6e 6563 7465 6420 776f 726b 6572 732e  nnected workers.
-0000aaa0: 0a20 2020 2068 6f73 745f 7265 7374 7269  .    host_restri
-0000aab0: 6374 696f 6e73 3a20 7365 745b 7374 725d  ctions: set[str]
-0000aac0: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
-0000aad0: 6620 636f 6d70 6c65 7465 2077 6f72 6b65  f complete worke
-0000aae0: 7220 6164 6472 6573 7365 7320 7768 6572  r addresses wher
-0000aaf0: 6520 7468 6973 2063 616e 2062 6520 7275  e this can be ru
-0000ab00: 6e20 286f 7220 6060 4e6f 6e65 6060 2069  n (or ``None`` i
-0000ab10: 6620 656d 7074 7929 2e0a 2020 2020 233a  f empty)..    #:
-0000ab20: 2055 7375 616c 6c79 2074 6869 7320 6973   Usually this is
-0000ab30: 2065 6d70 7479 2075 6e6c 6573 7320 7468   empty unless th
-0000ab40: 6520 7461 736b 2068 6173 2062 6565 6e20  e task has been 
-0000ab50: 7370 6563 6966 6963 616c 6c79 2072 6573  specifically res
-0000ab60: 7472 6963 7465 6420 746f 206f 6e6c 790a  tricted to only.
-0000ab70: 2020 2020 233a 2072 756e 206f 6e20 6365      #: run on ce
-0000ab80: 7274 6169 6e20 776f 726b 6572 732e 0a20  rtain workers.. 
-0000ab90: 2020 2023 3a20 4e6f 7465 2074 6869 7320     #: Note this 
-0000aba0: 6973 2074 7261 636b 696e 6720 776f 726b  is tracking work
-0000abb0: 6572 2061 6464 7265 7373 6573 2c20 6e6f  er addresses, no
-0000abc0: 7420 776f 726b 6572 2073 7461 7465 732c  t worker states,
-0000abd0: 2073 696e 6365 2074 6865 2073 7065 6369   since the speci
-0000abe0: 6669 630a 2020 2020 233a 2077 6f72 6b65  fic.    #: worke
-0000abf0: 7273 206d 6179 206e 6f74 2062 6520 636f  rs may not be co
-0000ac00: 6e6e 6563 7465 6420 6174 2074 6869 7320  nnected at this 
-0000ac10: 7469 6d65 2e0a 2020 2020 776f 726b 6572  time..    worker
-0000ac20: 5f72 6573 7472 6963 7469 6f6e 733a 2073  _restrictions: s
-0000ac30: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
-0000ac40: 5265 736f 7572 6365 7320 7265 7175 6972  Resources requir
-0000ac50: 6564 2062 7920 7468 6973 2074 6173 6b2c  ed by this task,
-0000ac60: 2073 7563 6820 6173 2060 607b 2767 7075   such as ``{'gpu
-0000ac70: 273a 2031 7d60 6020 6f72 2060 607b 276d  ': 1}`` or ``{'m
-0000ac80: 656d 6f72 7927 3a20 3165 397d 6060 0a20  emory': 1e9}``. 
-0000ac90: 2020 2023 3a20 5468 6573 6520 6172 6520     #: These are 
-0000aca0: 7573 6572 2d64 6566 696e 6564 206e 616d  user-defined nam
-0000acb0: 6573 2061 6e64 2061 7265 206d 6174 6368  es and are match
-0000acc0: 6564 2061 6761 696e 7374 2074 6865 203a  ed against the :
-0000acd0: 2063 6f6e 7465 6e74 7320 6f66 2065 6163   contents of eac
-0000ace0: 680a 2020 2020 233a 203a 6174 7472 3a60  h.    #: :attr:`
-0000acf0: 576f 726b 6572 5374 6174 652e 7265 736f  WorkerState.reso
-0000ad00: 7572 6365 7360 2064 6963 7469 6f6e 6172  urces` dictionar
-0000ad10: 792e 0a20 2020 2072 6573 6f75 7263 655f  y..    resource_
-0000ad20: 7265 7374 7269 6374 696f 6e73 3a20 6469  restrictions: di
-0000ad30: 6374 5b73 7472 2c20 666c 6f61 745d 0a0a  ct[str, float]..
-0000ad40: 2020 2020 233a 2046 616c 7365 0a20 2020      #: False.   
-0000ad50: 2023 3a20 2020 2020 4561 6368 206f 6620   #:     Each of 
-0000ad60: 3a61 7474 723a 6068 6f73 745f 7265 7374  :attr:`host_rest
-0000ad70: 7269 6374 696f 6e73 602c 203a 6174 7472  rictions`, :attr
-0000ad80: 3a60 776f 726b 6572 5f72 6573 7472 6963  :`worker_restric
-0000ad90: 7469 6f6e 7360 2061 6e64 0a20 2020 2023  tions` and.    #
-0000ada0: 3a20 2020 2020 3a61 7474 723a 6072 6573  :     :attr:`res
-0000adb0: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-0000adc0: 6e73 6020 6973 2061 2068 6172 6420 636f  ns` is a hard co
-0000add0: 6e73 7472 6169 6e74 3a20 6966 206e 6f20  nstraint: if no 
-0000ade0: 776f 726b 6572 2069 7320 6176 6169 6c61  worker is availa
-0000adf0: 626c 650a 2020 2020 233a 2020 2020 2073  ble.    #:     s
-0000ae00: 6174 6973 6679 696e 6720 7468 6f73 6520  atisfying those 
-0000ae10: 7265 7374 7269 6374 696f 6e73 2c20 7468  restrictions, th
-0000ae20: 6520 7461 736b 2063 616e 6e6f 7420 676f  e task cannot go
-0000ae30: 2069 6e74 6f20 7468 6520 2270 726f 6365   into the "proce
-0000ae40: 7373 696e 6722 2073 7461 7465 0a20 2020  ssing" state.   
-0000ae50: 2023 3a20 2020 2020 616e 6420 7769 6c6c   #:     and will
-0000ae60: 2069 6e73 7465 6164 2067 6f20 696e 746f   instead go into
-0000ae70: 2074 6865 2022 6e6f 2d77 6f72 6b65 7222   the "no-worker"
-0000ae80: 2073 7461 7465 2e0a 2020 2020 233a 2054   state..    #: T
-0000ae90: 7275 650a 2020 2020 233a 2020 2020 2054  rue.    #:     T
-0000aea0: 6865 2061 626f 7665 2072 6573 7472 6963  he above restric
-0000aeb0: 7469 6f6e 7320 6172 6520 6d65 7265 2070  tions are mere p
-0000aec0: 7265 6665 7265 6e63 6573 3a20 6966 206e  references: if n
-0000aed0: 6f20 776f 726b 6572 2069 7320 6176 6169  o worker is avai
-0000aee0: 6c61 626c 650a 2020 2020 233a 2020 2020  lable.    #:    
-0000aef0: 2073 6174 6973 6679 696e 6720 7468 6f73   satisfying thos
-0000af00: 6520 7265 7374 7269 6374 696f 6e73 2c20  e restrictions, 
-0000af10: 7468 6520 7461 736b 2063 616e 2073 7469  the task can sti
-0000af20: 6c6c 2067 6f20 696e 746f 2074 6865 0a20  ll go into the. 
-0000af30: 2020 2023 3a20 2020 2020 2270 726f 6365     #:     "proce
-0000af40: 7373 696e 6722 2073 7461 7465 2061 6e64  ssing" state and
-0000af50: 2062 6520 7365 6e74 2066 6f72 2065 7865   be sent for exe
-0000af60: 6375 7469 6f6e 2074 6f20 616e 6f74 6865  cution to anothe
-0000af70: 7220 636f 6e6e 6563 7465 6420 776f 726b  r connected work
-0000af80: 6572 2e0a 2020 2020 6c6f 6f73 655f 7265  er..    loose_re
-0000af90: 7374 7269 6374 696f 6e73 3a20 626f 6f6c  strictions: bool
-0000afa0: 0a0a 2020 2020 233a 2057 6865 7468 6572  ..    #: Whether
-0000afb0: 2074 6869 7320 7461 736b 2069 7320 616e   this task is an
-0000afc0: 2041 6374 6f72 0a20 2020 2061 6374 6f72   Actor.    actor
-0000afd0: 3a20 626f 6f6c 0a0a 2020 2020 233a 2054  : bool..    #: T
-0000afe0: 6865 2067 726f 7570 206f 6620 7461 736b  he group of task
-0000aff0: 7320 746f 2077 6869 6368 2074 6869 7320  s to which this 
-0000b000: 6f6e 6520 6265 6c6f 6e67 730a 2020 2020  one belongs.    
-0000b010: 6772 6f75 703a 2054 6173 6b47 726f 7570  group: TaskGroup
-0000b020: 0a0a 2020 2020 233a 2053 616d 6520 6173  ..    #: Same as
-0000b030: 206f 6620 6772 6f75 702e 6e61 6d65 0a20   of group.name. 
-0000b040: 2020 2067 726f 7570 5f6b 6579 3a20 7374     group_key: st
-0000b050: 720a 0a20 2020 2023 3a20 4d65 7461 6461  r..    #: Metada
-0000b060: 7461 2072 656c 6174 6564 2074 6f20 7461  ta related to ta
-0000b070: 736b 0a20 2020 206d 6574 6164 6174 613a  sk.    metadata:
-0000b080: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
-0000b090: 0a20 2020 2023 3a20 5461 736b 2061 6e6e  .    #: Task ann
-0000b0a0: 6f74 6174 696f 6e73 0a20 2020 2061 6e6e  otations.    ann
-0000b0b0: 6f74 6174 696f 6e73 3a20 6469 6374 5b73  otations: dict[s
-0000b0c0: 7472 2c20 416e 795d 0a0a 2020 2020 233a  tr, Any]..    #:
-0000b0d0: 2054 6865 2075 6e69 7175 6520 6964 656e   The unique iden
-0000b0e0: 7469 6669 6572 206f 6620 6120 7370 6563  tifier of a spec
-0000b0f0: 6966 6963 2065 7865 6375 7469 6f6e 206f  ific execution o
-0000b100: 6620 6120 7461 736b 2e20 5468 6973 2069  f a task. This i
-0000b110: 6465 6e74 6966 6965 720a 2020 2020 233a  dentifier.    #:
-0000b120: 2069 7320 7573 6564 2074 6f20 7369 676e   is used to sign
-0000b130: 2061 2074 6173 6b20 7375 6368 2074 6861   a task such tha
-0000b140: 7420 7468 6520 6173 7369 676e 6564 2077  t the assigned w
-0000b150: 6f72 6b65 7220 6973 2065 7870 6563 7465  orker is expecte
-0000b160: 6420 746f 2072 6574 7572 6e0a 2020 2020  d to return.    
-0000b170: 233a 2074 6865 2073 616d 6520 6964 656e  #: the same iden
-0000b180: 7469 6669 6572 2069 6e20 7468 6520 7461  tifier in the ta
-0000b190: 736b 2d66 696e 6973 6865 6420 6d65 7373  sk-finished mess
-0000b1a0: 6167 652e 2054 6869 7320 6973 2075 7365  age. This is use
-0000b1b0: 6420 746f 2063 6f72 7265 6c61 7465 0a20  d to correlate. 
-0000b1c0: 2020 2023 3a20 7265 7370 6f6e 7365 732e     #: responses.
-0000b1d0: 0a20 2020 2023 3a20 4f6e 6c79 2074 6865  .    #: Only the
-0000b1e0: 206d 6f73 7420 7265 6365 6e74 6c79 2061   most recently a
-0000b1f0: 7373 6967 6e65 6420 776f 726b 6572 2069  ssigned worker i
-0000b200: 7320 7472 7573 7465 642e 2041 6c6c 206f  s trusted. All o
-0000b210: 7468 6572 2072 6573 756c 7473 2077 696c  ther results wil
-0000b220: 6c0a 2020 2020 233a 2062 6520 7265 6a65  l.    #: be reje
-0000b230: 6374 6564 2e0a 2020 2020 7275 6e5f 6964  cted..    run_id
-0000b240: 3a20 696e 7420 7c20 4e6f 6e65 0a0a 2020  : int | None..  
-0000b250: 2020 233a 2043 6163 6865 6420 6861 7368    #: Cached hash
-0000b260: 206f 6620 3a61 7474 723a 607e 5461 736b   of :attr:`~Task
-0000b270: 5374 6174 652e 636c 6965 6e74 5f6b 6579  State.client_key
-0000b280: 600a 2020 2020 5f68 6173 683a 2069 6e74  `.    _hash: int
-0000b290: 0a0a 2020 2020 2320 5375 7070 6f72 7420  ..    # Support 
-0000b2a0: 666f 7220 7765 616b 7265 6673 2074 6f20  for weakrefs to 
-0000b2b0: 6120 636c 6173 7320 7769 7468 205f 5f73  a class with __s
-0000b2c0: 6c6f 7473 5f5f 0a20 2020 205f 5f77 6561  lots__.    __wea
-0000b2d0: 6b72 6566 5f5f 3a20 416e 7920 3d20 4e6f  kref__: Any = No
-0000b2e0: 6e65 0a20 2020 205f 5f73 6c6f 7473 5f5f  ne.    __slots__
-0000b2f0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
-0000b300: 6174 696f 6e73 5f5f 290a 0a20 2020 2023  ations__)..    #
-0000b310: 3a20 476c 6f62 616c 2069 7465 7261 746f  : Global iterato
-0000b320: 7220 7573 6564 2074 6f20 6372 6561 7465  r used to create
-0000b330: 2075 6e69 7175 6520 7461 736b 2072 756e   unique task run
-0000b340: 2049 4473 0a20 2020 205f 7275 6e5f 6964   IDs.    _run_id
-0000b350: 5f69 7465 7261 746f 723a 2043 6c61 7373  _iterator: Class
-0000b360: 5661 725b 6974 6572 746f 6f6c 732e 636f  Var[itertools.co
-0000b370: 756e 745d 203d 2069 7465 7274 6f6f 6c73  unt] = itertools
-0000b380: 2e63 6f75 6e74 2829 0a0a 2020 2020 2320  .count()..    # 
-0000b390: 496e 7374 616e 6365 7320 6e6f 7420 7061  Instances not pa
-0000b3a0: 7274 206f 6620 736c 6f74 7320 7369 6e63  rt of slots sinc
-0000b3b0: 6520 636c 6173 7320 7661 7269 6162 6c65  e class variable
-0000b3c0: 0a20 2020 205f 696e 7374 616e 6365 733a  .    _instances:
-0000b3d0: 2043 6c61 7373 5661 725b 7765 616b 7265   ClassVar[weakre
-0000b3e0: 662e 5765 616b 5365 745b 5461 736b 5374  f.WeakSet[TaskSt
-0000b3f0: 6174 655d 5d20 3d20 7765 616b 7265 662e  ate]] = weakref.
-0000b400: 5765 616b 5365 7428 290a 0a20 2020 2064  WeakSet()..    d
-0000b410: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
-0000b420: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0000b430: 2020 206b 6579 3a20 7374 722c 0a20 2020     key: str,.   
-0000b440: 2020 2020 2072 756e 5f73 7065 633a 206f       run_spec: o
-0000b450: 626a 6563 742c 0a20 2020 2020 2020 2073  bject,.        s
-0000b460: 7461 7465 3a20 5461 736b 5374 6174 6553  tate: TaskStateS
-0000b470: 7461 7465 2c0a 2020 2020 293a 0a20 2020  tate,.    ):.   
-0000b480: 2020 2020 2073 656c 662e 6b65 7920 3d20       self.key = 
-0000b490: 6b65 790a 2020 2020 2020 2020 7365 6c66  key.        self
-0000b4a0: 2e5f 6861 7368 203d 2068 6173 6828 6b65  ._hash = hash(ke
-0000b4b0: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
-0000b4c0: 7275 6e5f 7370 6563 203d 2072 756e 5f73  run_spec = run_s
-0000b4d0: 7065 630a 2020 2020 2020 2020 7365 6c66  pec.        self
-0000b4e0: 2e5f 7374 6174 6520 3d20 7374 6174 650a  ._state = state.
-0000b4f0: 2020 2020 2020 2020 7365 6c66 2e65 7863          self.exc
-0000b500: 6570 7469 6f6e 203d 204e 6f6e 650a 2020  eption = None.  
-0000b510: 2020 2020 2020 7365 6c66 2e65 7863 6570        self.excep
-0000b520: 7469 6f6e 5f62 6c61 6d65 203d 204e 6f6e  tion_blame = Non
-0000b530: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
-0000b540: 7261 6365 6261 636b 203d 204e 6f6e 650a  raceback = None.
-0000b550: 2020 2020 2020 2020 7365 6c66 2e65 7863          self.exc
-0000b560: 6570 7469 6f6e 5f74 6578 7420 3d20 2222  eption_text = ""
-0000b570: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
-0000b580: 6163 6562 6163 6b5f 7465 7874 203d 2022  aceback_text = "
-0000b590: 220a 2020 2020 2020 2020 7365 6c66 2e73  ".        self.s
-0000b5a0: 7573 7069 6369 6f75 7320 3d20 300a 2020  uspicious = 0.  
-0000b5b0: 2020 2020 2020 7365 6c66 2e72 6574 7269        self.retri
-0000b5c0: 6573 203d 2030 0a20 2020 2020 2020 2073  es = 0.        s
-0000b5d0: 656c 662e 6e62 7974 6573 203d 202d 310a  elf.nbytes = -1.
-0000b5e0: 2020 2020 2020 2020 7365 6c66 2e70 7269          self.pri
-0000b5f0: 6f72 6974 7920 3d20 4e6f 6e65 2020 2320  ority = None  # 
-0000b600: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-0000b610: 2020 2020 2073 656c 662e 7768 6f5f 7761       self.who_wa
-0000b620: 6e74 7320 3d20 7365 7428 290a 2020 2020  nts = set().    
-0000b630: 2020 2020 7365 6c66 2e64 6570 656e 6465      self.depende
-0000b640: 6e63 6965 7320 3d20 7365 7428 290a 2020  ncies = set().  
-0000b650: 2020 2020 2020 7365 6c66 2e64 6570 656e        self.depen
-0000b660: 6465 6e74 7320 3d20 7365 7428 290a 2020  dents = set().  
-0000b670: 2020 2020 2020 7365 6c66 2e77 6169 7469        self.waiti
-0000b680: 6e67 5f6f 6e20 3d20 7365 7428 290a 2020  ng_on = set().  
-0000b690: 2020 2020 2020 7365 6c66 2e77 6169 7465        self.waite
-0000b6a0: 7273 203d 2073 6574 2829 0a20 2020 2020  rs = set().     
-0000b6b0: 2020 2073 656c 662e 7768 6f5f 6861 7320     self.who_has 
-0000b6c0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-0000b6d0: 7365 6c66 2e70 726f 6365 7373 696e 675f  self.processing_
-0000b6e0: 6f6e 203d 204e 6f6e 650a 2020 2020 2020  on = None.      
-0000b6f0: 2020 7365 6c66 2e68 6173 5f6c 6f73 745f    self.has_lost_
-0000b700: 6465 7065 6e64 656e 6369 6573 203d 2046  dependencies = F
-0000b710: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
-0000b720: 662e 686f 7374 5f72 6573 7472 6963 7469  f.host_restricti
-0000b730: 6f6e 7320 3d20 4e6f 6e65 2020 2320 7479  ons = None  # ty
-0000b740: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-0000b750: 2020 2073 656c 662e 776f 726b 6572 5f72     self.worker_r
-0000b760: 6573 7472 6963 7469 6f6e 7320 3d20 4e6f  estrictions = No
-0000b770: 6e65 2020 2320 7479 7065 3a20 6967 6e6f  ne  # type: igno
-0000b780: 7265 0a20 2020 2020 2020 2073 656c 662e  re.        self.
-0000b790: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
-0000b7a0: 7469 6f6e 7320 3d20 7b7d 0a20 2020 2020  tions = {}.     
-0000b7b0: 2020 2073 656c 662e 6c6f 6f73 655f 7265     self.loose_re
-0000b7c0: 7374 7269 6374 696f 6e73 203d 2046 616c  strictions = Fal
-0000b7d0: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
-0000b7e0: 6163 746f 7220 3d20 4661 6c73 650a 2020  actor = False.  
-0000b7f0: 2020 2020 2020 7365 6c66 2e70 7265 6669        self.prefi
-0000b800: 7820 3d20 4e6f 6e65 2020 2320 7479 7065  x = None  # type
-0000b810: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-0000b820: 2073 656c 662e 7479 7065 203d 204e 6f6e   self.type = Non
-0000b830: 6520 2023 2074 7970 653a 2069 676e 6f72  e  # type: ignor
-0000b840: 650a 2020 2020 2020 2020 7365 6c66 2e67  e.        self.g
-0000b850: 726f 7570 5f6b 6579 203d 206b 6579 5f73  roup_key = key_s
-0000b860: 706c 6974 5f67 726f 7570 286b 6579 290a  plit_group(key).
-0000b870: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
-0000b880: 7570 203d 204e 6f6e 6520 2023 2074 7970  up = None  # typ
-0000b890: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-0000b8a0: 2020 7365 6c66 2e6d 6574 6164 6174 6120    self.metadata 
-0000b8b0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-0000b8c0: 662e 616e 6e6f 7461 7469 6f6e 7320 3d20  f.annotations = 
-0000b8d0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-0000b8e0: 6572 7265 645f 6f6e 203d 2073 6574 2829  erred_on = set()
-0000b8f0: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
-0000b900: 6e5f 6964 203d 204e 6f6e 650a 2020 2020  n_id = None.    
-0000b910: 2020 2020 5461 736b 5374 6174 652e 5f69      TaskState._i
-0000b920: 6e73 7461 6e63 6573 2e61 6464 2873 656c  nstances.add(sel
-0000b930: 6629 0a0a 2020 2020 6465 6620 5f5f 6861  f)..    def __ha
-0000b940: 7368 5f5f 2873 656c 6629 202d 3e20 696e  sh__(self) -> in
-0000b950: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
-0000b960: 6e20 7365 6c66 2e5f 6861 7368 0a0a 2020  n self._hash..  
-0000b970: 2020 6465 6620 5f5f 6571 5f5f 2873 656c    def __eq__(sel
-0000b980: 662c 206f 7468 6572 3a20 6f62 6a65 6374  f, other: object
-0000b990: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-0000b9a0: 2020 2072 6574 7572 6e20 6973 696e 7374     return isinst
-0000b9b0: 616e 6365 286f 7468 6572 2c20 5461 736b  ance(other, Task
-0000b9c0: 5374 6174 6529 2061 6e64 2073 656c 662e  State) and self.
-0000b9d0: 6b65 7920 3d3d 206f 7468 6572 2e6b 6579  key == other.key
-0000b9e0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-0000b9f0: 2020 2020 6465 6620 7374 6174 6528 7365      def state(se
-0000ba00: 6c66 2920 2d3e 2054 6173 6b53 7461 7465  lf) -> TaskState
-0000ba10: 5374 6174 653a 0a20 2020 2020 2020 2022  State:.        "
-0000ba20: 2222 5468 6973 2074 6173 6b27 7320 6375  ""This task's cu
-0000ba30: 7272 656e 7420 7374 6174 652e 2020 5661  rrent state.  Va
-0000ba40: 6c69 6420 7374 6174 6573 2061 7265 2060  lid states are `
-0000ba50: 6072 656c 6561 7365 6460 602c 2060 6077  `released``, ``w
-0000ba60: 6169 7469 6e67 6060 2c0a 2020 2020 2020  aiting``,.      
-0000ba70: 2020 6060 6e6f 2d77 6f72 6b65 7260 602c    ``no-worker``,
-0000ba80: 2060 6070 726f 6365 7373 696e 6760 602c   ``processing``,
-0000ba90: 2060 606d 656d 6f72 7960 602c 2060 6065   ``memory``, ``e
-0000baa0: 7272 6564 6060 2061 6e64 2060 6066 6f72  rred`` and ``for
-0000bab0: 676f 7474 656e 6060 2e20 2049 6620 6974  gotten``.  If it
-0000bac0: 0a20 2020 2020 2020 2069 7320 6060 666f  .        is ``fo
-0000bad0: 7267 6f74 7465 6e60 602c 2074 6865 2074  rgotten``, the t
-0000bae0: 6173 6b20 6973 6e27 7420 7374 6f72 6564  ask isn't stored
-0000baf0: 2069 6e20 7468 6520 6060 7461 736b 7360   in the ``tasks`
-0000bb00: 6020 6469 6374 696f 6e61 7279 2061 6e79  ` dictionary any
-0000bb10: 6d6f 7265 2061 6e64 0a20 2020 2020 2020  more and.       
-0000bb20: 2077 696c 6c20 7072 6f62 6162 6c79 2064   will probably d
-0000bb30: 6973 6170 7065 6172 2073 6f6f 6e20 6672  isappear soon fr
-0000bb40: 6f6d 206d 656d 6f72 792e 0a20 2020 2020  om memory..     
-0000bb50: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-0000bb60: 6574 7572 6e20 7365 6c66 2e5f 7374 6174  eturn self._stat
-0000bb70: 650a 0a20 2020 2040 7374 6174 652e 7365  e..    @state.se
-0000bb80: 7474 6572 0a20 2020 2064 6566 2073 7461  tter.    def sta
-0000bb90: 7465 2873 656c 662c 2076 616c 7565 3a20  te(self, value: 
-0000bba0: 5461 736b 5374 6174 6553 7461 7465 2920  TaskStateState) 
-0000bbb0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0000bbc0: 2073 656c 662e 6772 6f75 702e 7374 6174   self.group.stat
-0000bbd0: 6573 5b73 656c 662e 5f73 7461 7465 5d20  es[self._state] 
-0000bbe0: 2d3d 2031 0a20 2020 2020 2020 2073 656c  -= 1.        sel
-0000bbf0: 662e 6772 6f75 702e 7374 6174 6573 5b76  f.group.states[v
-0000bc00: 616c 7565 5d20 2b3d 2031 0a20 2020 2020  alue] += 1.     
-0000bc10: 2020 2073 656c 662e 5f73 7461 7465 203d     self._state =
-0000bc20: 2076 616c 7565 0a20 2020 2020 2020 2073   value.        s
-0000bc30: 656c 662e 7072 6566 6978 2e73 7461 7465  elf.prefix.state
-0000bc40: 5f63 6f75 6e74 735b 7661 6c75 655d 202b  _counts[value] +
-0000bc50: 3d20 310a 0a20 2020 2064 6566 2061 6464  = 1..    def add
-0000bc60: 5f64 6570 656e 6465 6e63 7928 7365 6c66  _dependency(self
-0000bc70: 2c20 6f74 6865 723a 2054 6173 6b53 7461  , other: TaskSta
-0000bc80: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-0000bc90: 2020 2020 2022 2222 4164 6420 616e 6f74       """Add anot
-0000bca0: 6865 7220 7461 736b 2061 7320 6120 6465  her task as a de
-0000bcb0: 7065 6e64 656e 6379 206f 6620 7468 6973  pendency of this
-0000bcc0: 2074 6173 6b22 2222 0a20 2020 2020 2020   task""".       
-0000bcd0: 2073 656c 662e 6465 7065 6e64 656e 6369   self.dependenci
-0000bce0: 6573 2e61 6464 286f 7468 6572 290a 2020  es.add(other).  
-0000bcf0: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
-0000bd00: 2e64 6570 656e 6465 6e63 6965 732e 6164  .dependencies.ad
-0000bd10: 6428 6f74 6865 722e 6772 6f75 7029 0a20  d(other.group). 
-0000bd20: 2020 2020 2020 206f 7468 6572 2e64 6570         other.dep
-0000bd30: 656e 6465 6e74 732e 6164 6428 7365 6c66  endents.add(self
-0000bd40: 290a 0a20 2020 2064 6566 2067 6574 5f6e  )..    def get_n
-0000bd50: 6279 7465 7328 7365 6c66 2920 2d3e 2069  bytes(self) -> i
-0000bd60: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
-0000bd70: 726e 2073 656c 662e 6e62 7974 6573 2069  rn self.nbytes i
-0000bd80: 6620 7365 6c66 2e6e 6279 7465 7320 3e3d  f self.nbytes >=
-0000bd90: 2030 2065 6c73 6520 4445 4641 554c 545f   0 else DEFAULT_
-0000bda0: 4441 5441 5f53 495a 450a 0a20 2020 2064  DATA_SIZE..    d
-0000bdb0: 6566 2073 6574 5f6e 6279 7465 7328 7365  ef set_nbytes(se
-0000bdc0: 6c66 2c20 6e62 7974 6573 3a20 696e 7429  lf, nbytes: int)
-0000bdd0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0000bde0: 2020 6469 6666 203d 206e 6279 7465 730a    diff = nbytes.
-0000bdf0: 2020 2020 2020 2020 6f6c 645f 6e62 7974          old_nbyt
-0000be00: 6573 203d 2073 656c 662e 6e62 7974 6573  es = self.nbytes
-0000be10: 0a20 2020 2020 2020 2069 6620 6f6c 645f  .        if old_
-0000be20: 6e62 7974 6573 203e 3d20 303a 0a20 2020  nbytes >= 0:.   
-0000be30: 2020 2020 2020 2020 2064 6966 6620 2d3d           diff -=
-0000be40: 206f 6c64 5f6e 6279 7465 730a 2020 2020   old_nbytes.    
-0000be50: 2020 2020 7365 6c66 2e67 726f 7570 2e6e      self.group.n
-0000be60: 6279 7465 735f 746f 7461 6c20 2b3d 2064  bytes_total += d
-0000be70: 6966 660a 2020 2020 2020 2020 666f 7220  iff.        for 
-0000be80: 7773 2069 6e20 7365 6c66 2e77 686f 5f68  ws in self.who_h
-0000be90: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-0000bea0: 7773 2e6e 6279 7465 7320 2b3d 2064 6966  ws.nbytes += dif
-0000beb0: 660a 2020 2020 2020 2020 7365 6c66 2e6e  f.        self.n
-0000bec0: 6279 7465 7320 3d20 6e62 7974 6573 0a0a  bytes = nbytes..
-0000bed0: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
-0000bee0: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-0000bef0: 2020 2020 2020 2072 6574 7572 6e20 6622         return f"
-0000bf00: 3c54 6173 6b53 7461 7465 207b 7365 6c66  <TaskState {self
-0000bf10: 2e6b 6579 2172 7d20 7b73 656c 662e 5f73  .key!r} {self._s
-0000bf20: 7461 7465 7d3e 220a 0a20 2020 2064 6566  tate}>"..    def
-0000bf30: 205f 7265 7072 5f68 746d 6c5f 2873 656c   _repr_html_(sel
-0000bf40: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
-0000bf50: 2020 2072 6574 7572 6e20 6765 745f 7465     return get_te
-0000bf60: 6d70 6c61 7465 2822 7461 736b 5f73 7461  mplate("task_sta
-0000bf70: 7465 2e68 746d 6c2e 6a32 2229 2e72 656e  te.html.j2").ren
-0000bf80: 6465 7228 0a20 2020 2020 2020 2020 2020  der(.           
-0000bf90: 2073 7461 7465 3d73 656c 662e 7374 6174   state=self.stat
-0000bfa0: 652c 0a20 2020 2020 2020 2020 2020 206e  e,.            n
-0000bfb0: 6279 7465 733d 7365 6c66 2e6e 6279 7465  bytes=self.nbyte
-0000bfc0: 732c 0a20 2020 2020 2020 2020 2020 206b  s,.            k
-0000bfd0: 6579 3d73 656c 662e 6b65 792c 0a20 2020  ey=self.key,.   
-0000bfe0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0000bff0: 7661 6c69 6461 7465 2873 656c 6629 202d  validate(self) -
-0000c000: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0000c010: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000c020: 2066 6f72 2063 7320 696e 2073 656c 662e   for cs in self.
-0000c030: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
-0000c040: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000c050: 7420 6973 696e 7374 616e 6365 2863 732c  t isinstance(cs,
-0000c060: 2043 6c69 656e 7453 7461 7465 292c 2028   ClientState), (
-0000c070: 7265 7072 2863 7329 2c20 7365 6c66 2e77  repr(cs), self.w
-0000c080: 686f 5f77 616e 7473 290a 2020 2020 2020  ho_wants).      
-0000c090: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-0000c0a0: 7365 6c66 2e77 686f 5f68 6173 3a0a 2020  self.who_has:.  
-0000c0b0: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0000c0c0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0000c0d0: 7773 2c20 576f 726b 6572 5374 6174 6529  ws, WorkerState)
-0000c0e0: 2c20 2872 6570 7228 7773 292c 2073 656c  , (repr(ws), sel
-0000c0f0: 662e 7768 6f5f 6861 7329 0a20 2020 2020  f.who_has).     
-0000c100: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
-0000c110: 2073 656c 662e 6465 7065 6e64 656e 6369   self.dependenci
-0000c120: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0000c130: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000c140: 7461 6e63 6528 7473 2c20 5461 736b 5374  tance(ts, TaskSt
-0000c150: 6174 6529 2c20 2872 6570 7228 7473 292c  ate), (repr(ts),
-0000c160: 2073 656c 662e 6465 7065 6e64 656e 6369   self.dependenci
-0000c170: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+000000f0: 6f72 7420 7465 7874 7772 6170 0a69 6d70  ort textwrap.imp
+00000100: 6f72 7420 7575 6964 0a69 6d70 6f72 7420  ort uuid.import 
+00000110: 7761 726e 696e 6773 0a69 6d70 6f72 7420  warnings.import 
+00000120: 7765 616b 7265 660a 6672 6f6d 2063 6f6c  weakref.from col
+00000130: 6c65 6374 696f 6e73 2069 6d70 6f72 7420  lections import 
+00000140: 6465 6661 756c 7464 6963 742c 2064 6571  defaultdict, deq
+00000150: 7565 0a66 726f 6d20 636f 6c6c 6563 7469  ue.from collecti
+00000160: 6f6e 732e 6162 6320 696d 706f 7274 2028  ons.abc import (
+00000170: 0a20 2020 2043 616c 6c61 626c 652c 0a20  .    Callable,. 
+00000180: 2020 2043 6f6c 6c65 6374 696f 6e2c 0a20     Collection,. 
+00000190: 2020 2043 6f6e 7461 696e 6572 2c0a 2020     Container,.  
+000001a0: 2020 4861 7368 6162 6c65 2c0a 2020 2020    Hashable,.    
+000001b0: 4974 6572 6162 6c65 2c0a 2020 2020 4974  Iterable,.    It
+000001c0: 6572 6174 6f72 2c0a 2020 2020 4d61 7070  erator,.    Mapp
+000001d0: 696e 672c 0a20 2020 2053 6571 7565 6e63  ing,.    Sequenc
+000001e0: 652c 0a20 2020 2053 6574 2c0a 290a 6672  e,.    Set,.).fr
+000001f0: 6f6d 2063 6f6e 7465 7874 6c69 6220 696d  om contextlib im
+00000200: 706f 7274 2073 7570 7072 6573 730a 6672  port suppress.fr
+00000210: 6f6d 2066 756e 6374 6f6f 6c73 2069 6d70  om functools imp
+00000220: 6f72 7420 7061 7274 6961 6c0a 6672 6f6d  ort partial.from
+00000230: 2074 7970 696e 6720 696d 706f 7274 2054   typing import T
+00000240: 5950 455f 4348 4543 4b49 4e47 2c20 416e  YPE_CHECKING, An
+00000250: 792c 2043 6c61 7373 5661 722c 204c 6974  y, ClassVar, Lit
+00000260: 6572 616c 2c20 4e61 6d65 6454 7570 6c65  eral, NamedTuple
+00000270: 2c20 6361 7374 2c20 6f76 6572 6c6f 6164  , cast, overload
+00000280: 0a0a 696d 706f 7274 2070 7375 7469 6c0a  ..import psutil.
+00000290: 6672 6f6d 2073 6f72 7465 6463 6f6e 7461  from sortedconta
+000002a0: 696e 6572 7320 696d 706f 7274 2053 6f72  iners import Sor
+000002b0: 7465 6444 6963 742c 2053 6f72 7465 6453  tedDict, SortedS
+000002c0: 6574 0a66 726f 6d20 746c 7a20 696d 706f  et.from tlz impo
+000002d0: 7274 2028 0a20 2020 2066 6972 7374 2c0a  rt (.    first,.
+000002e0: 2020 2020 6772 6f75 7062 792c 0a20 2020      groupby,.   
+000002f0: 206d 6572 6765 2c0a 2020 2020 6d65 7267   merge,.    merg
+00000300: 655f 736f 7274 6564 2c0a 2020 2020 6d65  e_sorted,.    me
+00000310: 7267 655f 7769 7468 2c0a 2020 2020 7061  rge_with,.    pa
+00000320: 7274 6974 696f 6e2c 0a20 2020 2070 6c75  rtition,.    plu
+00000330: 636b 2c0a 2020 2020 7365 636f 6e64 2c0a  ck,.    second,.
+00000340: 2020 2020 7661 6c6d 6170 2c0a 290a 6672      valmap,.).fr
+00000350: 6f6d 2074 6f72 6e61 646f 2e69 6f6c 6f6f  om tornado.ioloo
+00000360: 7020 696d 706f 7274 2049 4f4c 6f6f 700a  p import IOLoop.
+00000370: 0a69 6d70 6f72 7420 6461 736b 0a69 6d70  .import dask.imp
+00000380: 6f72 7420 6461 736b 2e75 7469 6c73 0a66  ort dask.utils.f
+00000390: 726f 6d20 6461 736b 2e63 6f72 6520 696d  rom dask.core im
+000003a0: 706f 7274 2067 6574 5f64 6570 730a 6672  port get_deps.fr
+000003b0: 6f6d 2064 6173 6b2e 7574 696c 7320 696d  om dask.utils im
+000003c0: 706f 7274 2028 0a20 2020 2066 6f72 6d61  port (.    forma
+000003d0: 745f 6279 7465 732c 0a20 2020 2066 6f72  t_bytes,.    for
+000003e0: 6d61 745f 7469 6d65 2c0a 2020 2020 6b65  mat_time,.    ke
+000003f0: 795f 7370 6c69 742c 0a20 2020 2070 6172  y_split,.    par
+00000400: 7365 5f62 7974 6573 2c0a 2020 2020 7061  se_bytes,.    pa
+00000410: 7273 655f 7469 6d65 6465 6c74 612c 0a20  rse_timedelta,. 
+00000420: 2020 2073 7472 696e 6769 6679 2c0a 2020     stringify,.  
+00000430: 2020 746d 7066 696c 652c 0a29 0a66 726f    tmpfile,.).fro
+00000440: 6d20 6461 736b 2e77 6964 6765 7473 2069  m dask.widgets i
+00000450: 6d70 6f72 7420 6765 745f 7465 6d70 6c61  mport get_templa
+00000460: 7465 0a0a 6672 6f6d 2064 6973 7472 6962  te..from distrib
+00000470: 7574 6564 2069 6d70 6f72 7420 636c 7573  uted import clus
+00000480: 7465 725f 6475 6d70 2c20 7072 656c 6f61  ter_dump, preloa
+00000490: 6469 6e67 2c20 7072 6f66 696c 650a 6672  ding, profile.fr
+000004a0: 6f6d 2064 6973 7472 6962 7574 6564 2069  om distributed i
+000004b0: 6d70 6f72 7420 7665 7273 696f 6e73 2061  mport versions a
+000004c0: 7320 7665 7273 696f 6e5f 6d6f 6475 6c65  s version_module
+000004d0: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+000004e0: 642e 5f73 746f 7269 6573 2069 6d70 6f72  d._stories impor
+000004f0: 7420 7363 6865 6475 6c65 725f 7374 6f72  t scheduler_stor
+00000500: 790a 6672 6f6d 2064 6973 7472 6962 7574  y.from distribut
+00000510: 6564 2e61 6374 6976 655f 6d65 6d6f 7279  ed.active_memory
+00000520: 5f6d 616e 6167 6572 2069 6d70 6f72 7420  _manager import 
+00000530: 4163 7469 7665 4d65 6d6f 7279 4d61 6e61  ActiveMemoryMana
+00000540: 6765 7245 7874 656e 7369 6f6e 2c20 5265  gerExtension, Re
+00000550: 7469 7265 576f 726b 6572 0a66 726f 6d20  tireWorker.from 
+00000560: 6469 7374 7269 6275 7465 642e 6261 7463  distributed.batc
+00000570: 6865 6420 696d 706f 7274 2042 6174 6368  hed import Batch
+00000580: 6564 5365 6e64 0a66 726f 6d20 6469 7374  edSend.from dist
+00000590: 7269 6275 7465 642e 636f 6c6c 6563 7469  ributed.collecti
+000005a0: 6f6e 7320 696d 706f 7274 2048 6561 7053  ons import HeapS
+000005b0: 6574 0a66 726f 6d20 6469 7374 7269 6275  et.from distribu
+000005c0: 7465 642e 636f 6d6d 2069 6d70 6f72 7420  ted.comm import 
+000005d0: 280a 2020 2020 436f 6d6d 2c0a 2020 2020  (.    Comm,.    
+000005e0: 436f 6d6d 436c 6f73 6564 4572 726f 722c  CommClosedError,
+000005f0: 0a20 2020 2067 6574 5f61 6464 7265 7373  .    get_address
+00000600: 5f68 6f73 742c 0a20 2020 206e 6f72 6d61  _host,.    norma
+00000610: 6c69 7a65 5f61 6464 7265 7373 2c0a 2020  lize_address,.  
+00000620: 2020 7265 736f 6c76 655f 6164 6472 6573    resolve_addres
+00000630: 732c 0a20 2020 2075 6e70 6172 7365 5f68  s,.    unparse_h
+00000640: 6f73 745f 706f 7274 2c0a 290a 6672 6f6d  ost_port,.).from
+00000650: 2064 6973 7472 6962 7574 6564 2e63 6f6d   distributed.com
+00000660: 6d2e 6164 6472 6573 7369 6e67 2069 6d70  m.addressing imp
+00000670: 6f72 7420 6164 6472 6573 7365 735f 6672  ort addresses_fr
+00000680: 6f6d 5f75 7365 725f 6172 6773 0a66 726f  om_user_args.fro
+00000690: 6d20 6469 7374 7269 6275 7465 642e 636f  m distributed.co
+000006a0: 6d70 6174 6962 696c 6974 7920 696d 706f  mpatibility impo
+000006b0: 7274 2050 6572 696f 6469 6343 616c 6c62  rt PeriodicCallb
+000006c0: 6163 6b0a 6672 6f6d 2064 6973 7472 6962  ack.from distrib
+000006d0: 7574 6564 2e63 6f72 6520 696d 706f 7274  uted.core import
+000006e0: 2053 7461 7475 732c 2063 6c65 616e 5f65   Status, clean_e
+000006f0: 7863 6570 7469 6f6e 2c20 6572 726f 725f  xception, error_
+00000700: 6d65 7373 6167 652c 2072 7063 2c20 7365  message, rpc, se
+00000710: 6e64 5f72 6563 760a 6672 6f6d 2064 6973  nd_recv.from dis
+00000720: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
+00000730: 7469 6373 2e6d 656d 6f72 795f 7361 6d70  tics.memory_samp
+00000740: 6c65 7220 696d 706f 7274 204d 656d 6f72  ler import Memor
+00000750: 7953 616d 706c 6572 4578 7465 6e73 696f  ySamplerExtensio
+00000760: 6e0a 6672 6f6d 2064 6973 7472 6962 7574  n.from distribut
+00000770: 6564 2e64 6961 676e 6f73 7469 6373 2e70  ed.diagnostics.p
+00000780: 6c75 6769 6e20 696d 706f 7274 2053 6368  lugin import Sch
+00000790: 6564 756c 6572 506c 7567 696e 2c20 5f67  edulerPlugin, _g
+000007a0: 6574 5f70 6c75 6769 6e5f 6e61 6d65 0a66  et_plugin_name.f
+000007b0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+000007c0: 6576 656e 7420 696d 706f 7274 2045 7665  event import Eve
+000007d0: 6e74 4578 7465 6e73 696f 6e0a 6672 6f6d  ntExtension.from
+000007e0: 2064 6973 7472 6962 7574 6564 2e68 7474   distributed.htt
+000007f0: 7020 696d 706f 7274 2067 6574 5f68 616e  p import get_han
+00000800: 646c 6572 730a 6672 6f6d 2064 6973 7472  dlers.from distr
+00000810: 6962 7574 6564 2e6c 6f63 6b20 696d 706f  ibuted.lock impo
+00000820: 7274 204c 6f63 6b45 7874 656e 7369 6f6e  rt LockExtension
+00000830: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+00000840: 642e 6d65 7472 6963 7320 696d 706f 7274  d.metrics import
+00000850: 206d 6f6e 6f74 6f6e 6963 2c20 7469 6d65   monotonic, time
+00000860: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+00000870: 642e 6d75 6c74 695f 6c6f 636b 2069 6d70  d.multi_lock imp
+00000880: 6f72 7420 4d75 6c74 694c 6f63 6b45 7874  ort MultiLockExt
+00000890: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
+000008a0: 7269 6275 7465 642e 6e6f 6465 2069 6d70  ributed.node imp
+000008b0: 6f72 7420 5365 7276 6572 4e6f 6465 0a66  ort ServerNode.f
+000008c0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+000008d0: 7072 6f63 7469 746c 6520 696d 706f 7274  proctitle import
+000008e0: 2073 6574 7072 6f63 7469 746c 650a 6672   setproctitle.fr
+000008f0: 6f6d 2064 6973 7472 6962 7574 6564 2e70  om distributed.p
+00000900: 726f 746f 636f 6c2e 7069 636b 6c65 2069  rotocol.pickle i
+00000910: 6d70 6f72 7420 6475 6d70 732c 206c 6f61  mport dumps, loa
+00000920: 6473 0a66 726f 6d20 6469 7374 7269 6275  ds.from distribu
+00000930: 7465 642e 7072 6f74 6f63 6f6c 2e73 6572  ted.protocol.ser
+00000940: 6961 6c69 7a65 2069 6d70 6f72 7420 5365  ialize import Se
+00000950: 7269 616c 697a 6564 2c20 546f 5069 636b  rialized, ToPick
+00000960: 6c65 2c20 7365 7269 616c 697a 650a 6672  le, serialize.fr
+00000970: 6f6d 2064 6973 7472 6962 7574 6564 2e70  om distributed.p
+00000980: 7562 6c69 7368 2069 6d70 6f72 7420 5075  ublish import Pu
+00000990: 626c 6973 6845 7874 656e 7369 6f6e 0a66  blishExtension.f
+000009a0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+000009b0: 7075 6273 7562 2069 6d70 6f72 7420 5075  pubsub import Pu
+000009c0: 6253 7562 5363 6865 6475 6c65 7245 7874  bSubSchedulerExt
+000009d0: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
+000009e0: 7269 6275 7465 642e 7175 6575 6573 2069  ributed.queues i
+000009f0: 6d70 6f72 7420 5175 6575 6545 7874 656e  mport QueueExten
+00000a00: 7369 6f6e 0a66 726f 6d20 6469 7374 7269  sion.from distri
+00000a10: 6275 7465 642e 7265 6372 6561 7465 5f74  buted.recreate_t
+00000a20: 6173 6b73 2069 6d70 6f72 7420 5265 706c  asks import Repl
+00000a30: 6179 5461 736b 5363 6865 6475 6c65 720a  ayTaskScheduler.
+00000a40: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
+00000a50: 2e73 6563 7572 6974 7920 696d 706f 7274  .security import
+00000a60: 2053 6563 7572 6974 790a 6672 6f6d 2064   Security.from d
+00000a70: 6973 7472 6962 7574 6564 2e73 656d 6170  istributed.semap
+00000a80: 686f 7265 2069 6d70 6f72 7420 5365 6d61  hore import Sema
+00000a90: 7068 6f72 6545 7874 656e 7369 6f6e 0a66  phoreExtension.f
+00000aa0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+00000ab0: 7368 7566 666c 6520 696d 706f 7274 2053  shuffle import S
+00000ac0: 6875 6666 6c65 5363 6865 6475 6c65 7245  huffleSchedulerE
+00000ad0: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
+00000ae0: 7374 7269 6275 7465 642e 7374 6561 6c69  stributed.steali
+00000af0: 6e67 2069 6d70 6f72 7420 576f 726b 5374  ng import WorkSt
+00000b00: 6561 6c69 6e67 0a66 726f 6d20 6469 7374  ealing.from dist
+00000b10: 7269 6275 7465 642e 7574 696c 7320 696d  ributed.utils im
+00000b20: 706f 7274 2028 0a20 2020 2041 6c6c 2c0a  port (.    All,.
+00000b30: 2020 2020 5469 6d65 6f75 7445 7272 6f72      TimeoutError
+00000b40: 2c0a 2020 2020 656d 7074 795f 636f 6e74  ,.    empty_cont
+00000b50: 6578 742c 0a20 2020 2066 6f72 6d61 745f  ext,.    format_
+00000b60: 6461 7368 626f 6172 645f 6c69 6e6b 2c0a  dashboard_link,.
+00000b70: 2020 2020 6765 745f 6669 6c65 6e6f 5f6c      get_fileno_l
+00000b80: 696d 6974 2c0a 2020 2020 6b65 795f 7370  imit,.    key_sp
+00000b90: 6c69 745f 6772 6f75 702c 0a20 2020 206c  lit_group,.    l
+00000ba0: 6f67 5f65 7272 6f72 732c 0a20 2020 206e  og_errors,.    n
+00000bb0: 6f5f 6465 6661 756c 742c 0a20 2020 2072  o_default,.    r
+00000bc0: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
+00000bd0: 2c0a 2020 2020 7661 6c69 6461 7465 5f6b  ,.    validate_k
+00000be0: 6579 2c0a 2020 2020 7761 6974 5f66 6f72  ey,.    wait_for
+00000bf0: 2c0a 290a 6672 6f6d 2064 6973 7472 6962  ,.).from distrib
+00000c00: 7574 6564 2e75 7469 6c73 5f63 6f6d 6d20  uted.utils_comm 
+00000c10: 696d 706f 7274 2028 0a20 2020 2067 6174  import (.    gat
+00000c20: 6865 725f 6672 6f6d 5f77 6f72 6b65 7273  her_from_workers
+00000c30: 2c0a 2020 2020 7265 7472 795f 6f70 6572  ,.    retry_oper
+00000c40: 6174 696f 6e2c 0a20 2020 2073 6361 7474  ation,.    scatt
+00000c50: 6572 5f74 6f5f 776f 726b 6572 732c 0a20  er_to_workers,. 
+00000c60: 2020 2075 6e70 6163 6b5f 7265 6d6f 7465     unpack_remote
+00000c70: 6461 7461 2c0a 290a 6672 6f6d 2064 6973  data,.).from dis
+00000c80: 7472 6962 7574 6564 2e75 7469 6c73 5f70  tributed.utils_p
+00000c90: 6572 6620 696d 706f 7274 2064 6973 6162  erf import disab
+00000ca0: 6c65 5f67 635f 6469 6167 6e6f 7369 732c  le_gc_diagnosis,
+00000cb0: 2065 6e61 626c 655f 6763 5f64 6961 676e   enable_gc_diagn
+00000cc0: 6f73 6973 0a66 726f 6d20 6469 7374 7269  osis.from distri
+00000cd0: 6275 7465 642e 7661 7269 6162 6c65 2069  buted.variable i
+00000ce0: 6d70 6f72 7420 5661 7269 6162 6c65 4578  mport VariableEx
+00000cf0: 7465 6e73 696f 6e0a 0a69 6620 5459 5045  tension..if TYPE
+00000d00: 5f43 4845 434b 494e 473a 0a20 2020 2023  _CHECKING:.    #
+00000d10: 2054 4f44 4f20 696d 706f 7274 2066 726f   TODO import fro
+00000d20: 6d20 7479 7069 6e67 2028 7265 7175 6972  m typing (requir
+00000d30: 6573 2050 7974 686f 6e20 3e3d 332e 3130  es Python >=3.10
+00000d40: 290a 2020 2020 6672 6f6d 2074 7970 696e  ).    from typin
+00000d50: 675f 6578 7465 6e73 696f 6e73 2069 6d70  g_extensions imp
+00000d60: 6f72 7420 5479 7065 416c 6961 730a 0a20  ort TypeAlias.. 
+00000d70: 2020 2066 726f 6d20 6461 736b 2e68 6967     from dask.hig
+00000d80: 686c 6576 656c 6772 6170 6820 696d 706f  hlevelgraph impo
+00000d90: 7274 2048 6967 684c 6576 656c 4772 6170  rt HighLevelGrap
+00000da0: 680a 0a23 204e 6f74 2074 6f20 6265 2063  h..# Not to be c
+00000db0: 6f6e 6675 7365 6420 7769 7468 2064 6973  onfused with dis
+00000dc0: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
+00000dd0: 7374 6174 655f 6d61 6368 696e 652e 5461  state_machine.Ta
+00000de0: 736b 5374 6174 6553 7461 7465 0a54 6173  skStateState.Tas
+00000df0: 6b53 7461 7465 5374 6174 653a 2054 7970  kStateState: Typ
+00000e00: 6541 6c69 6173 203d 204c 6974 6572 616c  eAlias = Literal
+00000e10: 5b0a 2020 2020 2272 656c 6561 7365 6422  [.    "released"
+00000e20: 2c0a 2020 2020 2277 6169 7469 6e67 222c  ,.    "waiting",
+00000e30: 0a20 2020 2022 6e6f 2d77 6f72 6b65 7222  .    "no-worker"
+00000e40: 2c0a 2020 2020 2271 7565 7565 6422 2c0a  ,.    "queued",.
+00000e50: 2020 2020 2270 726f 6365 7373 696e 6722      "processing"
+00000e60: 2c0a 2020 2020 226d 656d 6f72 7922 2c0a  ,.    "memory",.
+00000e70: 2020 2020 2265 7272 6564 222c 0a20 2020      "erred",.   
+00000e80: 2022 666f 7267 6f74 7465 6e22 2c0a 5d0a   "forgotten",.].
+00000e90: 0a41 4c4c 5f54 4153 4b5f 5354 4154 4553  .ALL_TASK_STATES
+00000ea0: 3a20 5365 745b 5461 736b 5374 6174 6553  : Set[TaskStateS
+00000eb0: 7461 7465 5d20 3d20 7365 7428 5461 736b  tate] = set(Task
+00000ec0: 5374 6174 6553 7461 7465 2e5f 5f61 7267  StateState.__arg
+00000ed0: 735f 5f29 2020 2320 7479 7065 3a20 6967  s__)  # type: ig
+00000ee0: 6e6f 7265 0a0a 2320 544f 444f 2072 656d  nore..# TODO rem
+00000ef0: 6f76 6520 7175 6f74 6573 2028 7265 7175  ove quotes (requ
+00000f00: 6972 6573 2050 7974 686f 6e20 3e3d 332e  ires Python >=3.
+00000f10: 3929 0a23 207b 7461 736b 206b 6579 202d  9).# {task key -
+00000f20: 3e20 6669 6e69 7368 2073 7461 7465 7d0a  > finish state}.
+00000f30: 2320 4e6f 7420 746f 2062 6520 636f 6e66  # Not to be conf
+00000f40: 7573 6564 2077 6974 6820 6469 7374 7269  used with distri
+00000f50: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+00000f60: 7465 5f6d 6163 6869 6e65 2e52 6563 730a  te_machine.Recs.
+00000f70: 5265 6373 3a20 5479 7065 416c 6961 7320  Recs: TypeAlias 
+00000f80: 3d20 2264 6963 745b 7374 722c 2054 6173  = "dict[str, Tas
+00000f90: 6b53 7461 7465 5374 6174 655d 220a 2320  kStateState]".# 
+00000fa0: 7b63 6c69 656e 7420 6f72 2077 6f72 6b65  {client or worke
+00000fb0: 7220 6164 6472 6573 733a 205b 7b6f 703a  r address: [{op:
+00000fc0: 203c 6b65 793e 2c20 2e2e 2e7d 2c20 2e2e   <key>, ...}, ..
+00000fd0: 2e5d 7d0a 4d73 6773 3a20 5479 7065 416c  .]}.Msgs: TypeAl
+00000fe0: 6961 7320 3d20 2264 6963 745b 7374 722c  ias = "dict[str,
+00000ff0: 206c 6973 745b 6469 6374 5b73 7472 2c20   list[dict[str, 
+00001000: 416e 795d 5d5d 220a 2320 2872 6563 6f6d  Any]]]".# (recom
+00001010: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
+00001020: 6e74 206d 6573 7361 6765 732c 2077 6f72  nt messages, wor
+00001030: 6b65 7220 6d65 7373 6167 6573 290a 5265  ker messages).Re
+00001040: 6373 4d73 6773 3a20 5479 7065 416c 6961  csMsgs: TypeAlia
+00001050: 7320 3d20 2274 7570 6c65 5b52 6563 732c  s = "tuple[Recs,
+00001060: 204d 7367 732c 204d 7367 735d 220a 0a6c   Msgs, Msgs]"..l
+00001070: 6f67 6765 7220 3d20 6c6f 6767 696e 672e  ogger = logging.
+00001080: 6765 744c 6f67 6765 7228 5f5f 6e61 6d65  getLogger(__name
+00001090: 5f5f 290a 4c4f 475f 5044 4220 3d20 6461  __).LOG_PDB = da
+000010a0: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+000010b0: 6973 7472 6962 7574 6564 2e61 646d 696e  istributed.admin
+000010c0: 2e70 6462 2d6f 6e2d 6572 7222 290a 4445  .pdb-on-err").DE
+000010d0: 4641 554c 545f 4441 5441 5f53 495a 4520  FAULT_DATA_SIZE 
+000010e0: 3d20 7061 7273 655f 6279 7465 7328 0a20  = parse_bytes(. 
+000010f0: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
+00001100: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+00001110: 7363 6865 6475 6c65 722e 6465 6661 756c  scheduler.defaul
+00001120: 742d 6461 7461 2d73 697a 6522 290a 290a  t-data-size").).
+00001130: 5354 494d 554c 5553 5f49 445f 554e 5345  STIMULUS_ID_UNSE
+00001140: 5420 3d20 223c 7374 696d 756c 7573 5f69  T = "<stimulus_i
+00001150: 6420 756e 7365 743e 220a 0a44 4546 4155  d unset>"..DEFAU
+00001160: 4c54 5f45 5854 454e 5349 4f4e 5320 3d20  LT_EXTENSIONS = 
+00001170: 7b0a 2020 2020 226c 6f63 6b73 223a 204c  {.    "locks": L
+00001180: 6f63 6b45 7874 656e 7369 6f6e 2c0a 2020  ockExtension,.  
+00001190: 2020 226d 756c 7469 5f6c 6f63 6b73 223a    "multi_locks":
+000011a0: 204d 756c 7469 4c6f 636b 4578 7465 6e73   MultiLockExtens
+000011b0: 696f 6e2c 0a20 2020 2022 7075 626c 6973  ion,.    "publis
+000011c0: 6822 3a20 5075 626c 6973 6845 7874 656e  h": PublishExten
+000011d0: 7369 6f6e 2c0a 2020 2020 2272 6570 6c61  sion,.    "repla
+000011e0: 792d 7461 736b 7322 3a20 5265 706c 6179  y-tasks": Replay
+000011f0: 5461 736b 5363 6865 6475 6c65 722c 0a20  TaskScheduler,. 
+00001200: 2020 2022 7175 6575 6573 223a 2051 7565     "queues": Que
+00001210: 7565 4578 7465 6e73 696f 6e2c 0a20 2020  ueExtension,.   
+00001220: 2022 7661 7269 6162 6c65 7322 3a20 5661   "variables": Va
+00001230: 7269 6162 6c65 4578 7465 6e73 696f 6e2c  riableExtension,
+00001240: 0a20 2020 2022 7075 6273 7562 223a 2050  .    "pubsub": P
+00001250: 7562 5375 6253 6368 6564 756c 6572 4578  ubSubSchedulerEx
+00001260: 7465 6e73 696f 6e2c 0a20 2020 2022 7365  tension,.    "se
+00001270: 6d61 7068 6f72 6573 223a 2053 656d 6170  maphores": Semap
+00001280: 686f 7265 4578 7465 6e73 696f 6e2c 0a20  horeExtension,. 
+00001290: 2020 2022 6576 656e 7473 223a 2045 7665     "events": Eve
+000012a0: 6e74 4578 7465 6e73 696f 6e2c 0a20 2020  ntExtension,.   
+000012b0: 2022 616d 6d22 3a20 4163 7469 7665 4d65   "amm": ActiveMe
+000012c0: 6d6f 7279 4d61 6e61 6765 7245 7874 656e  moryManagerExten
+000012d0: 7369 6f6e 2c0a 2020 2020 226d 656d 6f72  sion,.    "memor
+000012e0: 795f 7361 6d70 6c65 7222 3a20 4d65 6d6f  y_sampler": Memo
+000012f0: 7279 5361 6d70 6c65 7245 7874 656e 7369  rySamplerExtensi
+00001300: 6f6e 2c0a 2020 2020 2273 6875 6666 6c65  on,.    "shuffle
+00001310: 223a 2053 6875 6666 6c65 5363 6865 6475  ": ShuffleSchedu
+00001320: 6c65 7245 7874 656e 7369 6f6e 2c0a 2020  lerExtension,.  
+00001330: 2020 2273 7465 616c 696e 6722 3a20 576f    "stealing": Wo
+00001340: 726b 5374 6561 6c69 6e67 2c0a 7d0a 0a0a  rkStealing,.}...
+00001350: 636c 6173 7320 436c 6965 6e74 5374 6174  class ClientStat
+00001360: 653a 0a20 2020 2022 2222 4120 7369 6d70  e:.    """A simp
+00001370: 6c65 206f 626a 6563 7420 686f 6c64 696e  le object holdin
+00001380: 6720 696e 666f 726d 6174 696f 6e20 6162  g information ab
+00001390: 6f75 7420 6120 636c 6965 6e74 2e22 2222  out a client."""
+000013a0: 0a0a 2020 2020 233a 2041 2075 6e69 7175  ..    #: A uniqu
+000013b0: 6520 6964 656e 7469 6669 6572 2066 6f72  e identifier for
+000013c0: 2074 6869 7320 636c 6965 6e74 2e20 5468   this client. Th
+000013d0: 6973 2069 7320 6765 6e65 7261 6c6c 7920  is is generally 
+000013e0: 616e 206f 7061 7175 650a 2020 2020 233a  an opaque.    #:
+000013f0: 2073 7472 696e 6720 6765 6e65 7261 7465   string generate
+00001400: 6420 6279 2074 6865 2063 6c69 656e 7420  d by the client 
+00001410: 6974 7365 6c66 2e0a 2020 2020 636c 6965  itself..    clie
+00001420: 6e74 5f6b 6579 3a20 7374 720a 0a20 2020  nt_key: str..   
+00001430: 2023 3a20 4361 6368 6564 2068 6173 6820   #: Cached hash 
+00001440: 6f66 203a 6174 7472 3a60 7e43 6c69 656e  of :attr:`~Clien
+00001450: 7453 7461 7465 2e63 6c69 656e 745f 6b65  tState.client_ke
+00001460: 7960 0a20 2020 205f 6861 7368 3a20 696e  y`.    _hash: in
+00001470: 740a 0a20 2020 2023 3a20 4120 7365 7420  t..    #: A set 
+00001480: 6f66 2074 6173 6b73 2074 6869 7320 636c  of tasks this cl
+00001490: 6965 6e74 2077 616e 7473 2074 6f20 6265  ient wants to be
+000014a0: 206b 6570 7420 696e 206d 656d 6f72 792c   kept in memory,
+000014b0: 2073 6f20 7468 6174 2069 7420 6361 6e20   so that it can 
+000014c0: 646f 776e 6c6f 6164 0a20 2020 2023 3a20  download.    #: 
+000014d0: 6974 7320 7265 7375 6c74 2077 6865 6e20  its result when 
+000014e0: 6465 7369 7265 642e 2054 6869 7320 6973  desired. This is
+000014f0: 2074 6865 2072 6576 6572 7365 206d 6170   the reverse map
+00001500: 7069 6e67 206f 660a 2020 2020 233a 203a  ping of.    #: :
+00001510: 636c 6173 733a 6054 6173 6b53 7461 7465  class:`TaskState
+00001520: 2e77 686f 5f77 616e 7473 602e 2054 6173  .who_wants`. Tas
+00001530: 6b73 2061 7265 2074 7970 6963 616c 6c79  ks are typically
+00001540: 2072 656d 6f76 6564 2066 726f 6d20 7468   removed from th
+00001550: 6973 2073 6574 2077 6865 6e20 7468 650a  is set when the.
+00001560: 2020 2020 233a 2063 6f72 7265 7370 6f6e      #: correspon
+00001570: 6469 6e67 206f 626a 6563 7420 696e 2074  ding object in t
+00001580: 6865 2063 6c69 656e 7427 7320 7370 6163  he client's spac
+00001590: 6520 2866 6f72 2065 7861 6d70 6c65 2061  e (for example a
+000015a0: 2060 6046 7574 7572 6560 6020 6f72 2061   ``Future`` or a
+000015b0: 2044 6173 6b0a 2020 2020 233a 2063 6f6c   Dask.    #: col
+000015c0: 6c65 6374 696f 6e29 2067 6574 7320 6761  lection) gets ga
+000015d0: 7262 6167 652d 636f 6c6c 6563 7465 642e  rbage-collected.
+000015e0: 0a20 2020 2077 616e 7473 5f77 6861 743a  .    wants_what:
+000015f0: 2073 6574 5b54 6173 6b53 7461 7465 5d0a   set[TaskState].
+00001600: 0a20 2020 2023 3a20 5468 6520 6c61 7374  .    #: The last
+00001610: 2074 696d 6520 7765 2072 6563 6569 7665   time we receive
+00001620: 6420 6120 6865 6172 7462 6561 7420 6672  d a heartbeat fr
+00001630: 6f6d 2074 6869 7320 636c 6965 6e74 2c20  om this client, 
+00001640: 696e 206c 6f63 616c 2073 6368 6564 756c  in local schedul
+00001650: 6572 2074 696d 652e 0a20 2020 206c 6173  er time..    las
+00001660: 745f 7365 656e 3a20 666c 6f61 740a 0a20  t_seen: float.. 
+00001670: 2020 2023 3a20 4f75 7470 7574 206f 6620     #: Output of 
+00001680: 3a66 756e 633a 6064 6973 7472 6962 7574  :func:`distribut
+00001690: 6564 2e76 6572 7369 6f6e 732e 6765 745f  ed.versions.get_
+000016a0: 7665 7273 696f 6e73 6020 6f6e 2074 6865  versions` on the
+000016b0: 2063 6c69 656e 740a 2020 2020 7665 7273   client.    vers
+000016c0: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
+000016d0: 416e 795d 0a0a 2020 2020 5f5f 736c 6f74  Any]..    __slot
+000016e0: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
+000016f0: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
+00001700: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00001710: 656c 662c 2063 6c69 656e 743a 2073 7472  elf, client: str
+00001720: 2c20 2a2c 2076 6572 7369 6f6e 733a 2064  , *, versions: d
+00001730: 6963 745b 7374 722c 2041 6e79 5d20 7c20  ict[str, Any] | 
+00001740: 4e6f 6e65 203d 204e 6f6e 6529 3a0a 2020  None = None):.  
+00001750: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00001760: 745f 6b65 7920 3d20 636c 6965 6e74 0a20  t_key = client. 
+00001770: 2020 2020 2020 2073 656c 662e 5f68 6173         self._has
+00001780: 6820 3d20 6861 7368 2863 6c69 656e 7429  h = hash(client)
+00001790: 0a20 2020 2020 2020 2073 656c 662e 7761  .        self.wa
+000017a0: 6e74 735f 7768 6174 203d 2073 6574 2829  nts_what = set()
+000017b0: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
+000017c0: 7374 5f73 6565 6e20 3d20 7469 6d65 2829  st_seen = time()
+000017d0: 0a20 2020 2020 2020 2073 656c 662e 7665  .        self.ve
+000017e0: 7273 696f 6e73 203d 2076 6572 7369 6f6e  rsions = version
+000017f0: 7320 6f72 207b 7d0a 0a20 2020 2064 6566  s or {}..    def
+00001800: 205f 5f68 6173 685f 5f28 7365 6c66 2920   __hash__(self) 
+00001810: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
+00001820: 7265 7475 726e 2073 656c 662e 5f68 6173  return self._has
+00001830: 680a 0a20 2020 2064 6566 205f 5f65 715f  h..    def __eq_
+00001840: 5f28 7365 6c66 2c20 6f74 6865 723a 206f  _(self, other: o
+00001850: 626a 6563 7429 202d 3e20 626f 6f6c 3a0a  bject) -> bool:.
+00001860: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+00001870: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
+00001880: 2043 6c69 656e 7453 7461 7465 293a 0a20   ClientState):. 
+00001890: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000018a0: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
+000018b0: 7265 7475 726e 2073 656c 662e 636c 6965  return self.clie
+000018c0: 6e74 5f6b 6579 203d 3d20 6f74 6865 722e  nt_key == other.
+000018d0: 636c 6965 6e74 5f6b 6579 0a0a 2020 2020  client_key..    
+000018e0: 6465 6620 5f5f 7265 7072 5f5f 2873 656c  def __repr__(sel
+000018f0: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
+00001900: 2020 2072 6574 7572 6e20 6622 3c43 6c69     return f"<Cli
+00001910: 656e 7420 7b73 656c 662e 636c 6965 6e74  ent {self.client
+00001920: 5f6b 6579 2172 7d3e 220a 0a20 2020 2064  _key!r}>"..    d
+00001930: 6566 205f 5f73 7472 5f5f 2873 656c 6629  ef __str__(self)
+00001940: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00001950: 2072 6574 7572 6e20 7365 6c66 2e63 6c69   return self.cli
+00001960: 656e 745f 6b65 790a 0a20 2020 2064 6566  ent_key..    def
+00001970: 205f 746f 5f64 6963 745f 6e6f 5f6e 6573   _to_dict_no_nes
+00001980: 7428 7365 6c66 2c20 2a2c 2065 7863 6c75  t(self, *, exclu
+00001990: 6465 3a20 436f 6e74 6169 6e65 725b 7374  de: Container[st
+000019a0: 725d 203d 2028 2929 202d 3e20 6469 6374  r] = ()) -> dict
+000019b0: 3a0a 2020 2020 2020 2020 2222 2244 6963  :.        """Dic
+000019c0: 7469 6f6e 6172 7920 7265 7072 6573 656e  tionary represen
+000019d0: 7461 7469 6f6e 2066 6f72 2064 6562 7567  tation for debug
+000019e0: 6769 6e67 2070 7572 706f 7365 732e 0a20  ging purposes.. 
+000019f0: 2020 2020 2020 204e 6f74 2074 7970 6520         Not type 
+00001a00: 7374 6162 6c65 2061 6e64 206e 6f74 2069  stable and not i
+00001a10: 6e74 656e 6465 6420 666f 7220 726f 756e  ntended for roun
+00001a20: 6474 7269 7073 2e0a 0a20 2020 2020 2020  dtrips...       
+00001a30: 2053 6565 2061 6c73 6f0a 2020 2020 2020   See also.      
+00001a40: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
+00001a50: 2020 2043 6c69 656e 742e 6475 6d70 5f63     Client.dump_c
+00001a60: 6c75 7374 6572 5f73 7461 7465 0a20 2020  luster_state.   
+00001a70: 2020 2020 2064 6973 7472 6962 7574 6564       distributed
+00001a80: 2e75 7469 6c73 2e72 6563 7572 7369 7665  .utils.recursive
+00001a90: 5f74 6f5f 6469 6374 0a20 2020 2020 2020  _to_dict.       
+00001aa0: 2054 6173 6b53 7461 7465 2e5f 746f 5f64   TaskState._to_d
+00001ab0: 6963 740a 2020 2020 2020 2020 2222 220a  ict.        """.
+00001ac0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00001ad0: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
+00001ae0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00001af0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+00001b00: 6578 636c 7564 653d 7365 7428 6578 636c  exclude=set(excl
+00001b10: 7564 6529 207c 207b 2276 6572 7369 6f6e  ude) | {"version
+00001b20: 7322 7d2c 2020 2320 7479 7065 3a20 6967  s"},  # type: ig
+00001b30: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
+00001b40: 206d 656d 6265 7273 3d54 7275 652c 0a20   members=True,. 
+00001b50: 2020 2020 2020 2029 0a0a 0a63 6c61 7373         )...class
+00001b60: 204d 656d 6f72 7953 7461 7465 3a0a 2020   MemoryState:.  
+00001b70: 2020 2222 224d 656d 6f72 7920 7265 6164    """Memory read
+00001b80: 696e 6773 206f 6e20 6120 776f 726b 6572  ings on a worker
+00001b90: 206f 7220 6f6e 2074 6865 2077 686f 6c65   or on the whole
+00001ba0: 2063 6c75 7374 6572 2e0a 0a20 2020 2053   cluster...    S
+00001bb0: 6565 203a 646f 633a 6077 6f72 6b65 722d  ee :doc:`worker-
+00001bc0: 6d65 6d6f 7279 602e 0a0a 2020 2020 4174  memory`...    At
+00001bd0: 7472 6962 7574 6573 202f 2070 726f 7065  tributes / prope
+00001be0: 7274 6965 733a 0a0a 2020 2020 6d61 6e61  rties:..    mana
+00001bf0: 6765 645f 746f 7461 6c0a 2020 2020 2020  ged_total.      
+00001c00: 2020 5375 6d20 6f66 2074 6865 206f 7574    Sum of the out
+00001c10: 7075 7420 6f66 2073 697a 656f 6628 2920  put of sizeof() 
+00001c20: 666f 7220 616c 6c20 6461 736b 206b 6579  for all dask key
+00001c30: 7320 6865 6c64 2062 7920 7468 6520 776f  s held by the wo
+00001c40: 726b 6572 2069 6e20 6d65 6d6f 7279 2c0a  rker in memory,.
+00001c50: 2020 2020 2020 2020 706c 7573 206e 756d          plus num
+00001c60: 6265 7220 6f66 2062 7974 6573 2073 7069  ber of bytes spi
+00001c70: 6c6c 6564 2074 6f20 6469 736b 0a0a 2020  lled to disk..  
+00001c80: 2020 6d61 6e61 6765 640a 2020 2020 2020    managed.      
+00001c90: 2020 5375 6d20 6f66 2074 6865 206f 7574    Sum of the out
+00001ca0: 7075 7420 6f66 2073 697a 656f 6628 2920  put of sizeof() 
+00001cb0: 666f 7220 7468 6520 6461 736b 206b 6579  for the dask key
+00001cc0: 7320 6865 6c64 2069 6e20 5241 4d2e 204e  s held in RAM. N
+00001cd0: 6f74 6520 7468 6174 2074 6869 7320 6d61  ote that this ma
+00001ce0: 790a 2020 2020 2020 2020 6265 2069 6e61  y.        be ina
+00001cf0: 6363 7572 6174 652c 2077 6869 6368 206d  ccurate, which m
+00001d00: 6179 2063 6175 7365 2069 6e61 6363 7572  ay cause inaccur
+00001d10: 6174 6520 756e 6d61 6e61 6765 6420 6d65  ate unmanaged me
+00001d20: 6d6f 7279 2028 7365 6520 6265 6c6f 7729  mory (see below)
+00001d30: 2e0a 0a20 2020 2073 7069 6c6c 6564 0a20  ...    spilled. 
+00001d40: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
+00001d50: 2062 7974 6573 2020 666f 7220 7468 6520   bytes  for the 
+00001d60: 6461 736b 206b 6579 7320 7370 696c 6c65  dask keys spille
+00001d70: 6420 746f 2074 6865 2068 6172 6420 6472  d to the hard dr
+00001d80: 6976 652e 0a20 2020 2020 2020 204e 6f74  ive..        Not
+00001d90: 6520 7468 6174 2074 6869 7320 6973 2074  e that this is t
+00001da0: 6865 2073 697a 6520 6f6e 2064 6973 6b3b  he size on disk;
+00001db0: 2073 697a 6520 696e 206d 656d 6f72 7920   size in memory 
+00001dc0: 6d61 7920 6265 2064 6966 6665 7265 6e74  may be different
+00001dd0: 2064 7565 2074 6f0a 2020 2020 2020 2020   due to.        
+00001de0: 636f 6d70 7265 7373 696f 6e20 616e 6420  compression and 
+00001df0: 696e 6163 6375 7261 6369 6573 2069 6e20  inaccuracies in 
+00001e00: 7369 7a65 6f66 2829 2e20 496e 206f 7468  sizeof(). In oth
+00001e10: 6572 2077 6f72 6473 2c20 6769 7665 6e20  er words, given 
+00001e20: 7468 6520 7361 6d65 206b 6579 732c 0a20  the same keys,. 
+00001e30: 2020 2020 2020 2027 6d61 6e61 6765 6427         'managed'
+00001e40: 2077 696c 6c20 6368 616e 6765 2064 6570   will change dep
+00001e50: 656e 6469 6e67 206f 6e20 7468 6520 6b65  ending on the ke
+00001e60: 7973 2062 6569 6e67 2069 6e20 6d65 6d6f  ys being in memo
+00001e70: 7279 206f 7220 7370 696c 6c65 642e 0a0a  ry or spilled...
+00001e80: 2020 2020 7072 6f63 6573 730a 2020 2020      process.    
+00001e90: 2020 2020 546f 7461 6c20 5253 5320 6d65      Total RSS me
+00001ea0: 6d6f 7279 206d 6561 7375 7265 6420 6279  mory measured by
+00001eb0: 2074 6865 204f 5320 6f6e 2074 6865 2077   the OS on the w
+00001ec0: 6f72 6b65 7220 7072 6f63 6573 732e 0a20  orker process.. 
+00001ed0: 2020 2020 2020 2054 6869 7320 6973 2061         This is a
+00001ee0: 6c77 6179 7320 6578 6163 746c 7920 6571  lways exactly eq
+00001ef0: 7561 6c20 746f 206d 616e 6167 6564 202b  ual to managed +
+00001f00: 2075 6e6d 616e 6167 6564 2e0a 0a20 2020   unmanaged...   
+00001f10: 2075 6e6d 616e 6167 6564 0a20 2020 2020   unmanaged.     
+00001f20: 2020 2070 726f 6365 7373 202d 206d 616e     process - man
+00001f30: 6167 6564 2e20 5468 6973 2069 7320 7468  aged. This is th
+00001f40: 6520 7375 6d20 6f66 0a0a 2020 2020 2020  e sum of..      
+00001f50: 2020 2d20 5079 7468 6f6e 2069 6e74 6572    - Python inter
+00001f60: 7072 6574 6572 2061 6e64 206d 6f64 756c  preter and modul
+00001f70: 6573 0a20 2020 2020 2020 202d 2067 6c6f  es.        - glo
+00001f80: 6261 6c20 7661 7269 6162 6c65 730a 2020  bal variables.  
+00001f90: 2020 2020 2020 2d20 6d65 6d6f 7279 2074        - memory t
+00001fa0: 656d 706f 7261 7269 6c79 2061 6c6c 6f63  emporarily alloc
+00001fb0: 6174 6564 2062 7920 7468 6520 6461 736b  ated by the dask
+00001fc0: 2074 6173 6b73 2074 6861 7420 6172 6520   tasks that are 
+00001fd0: 6375 7272 656e 746c 7920 7275 6e6e 696e  currently runnin
+00001fe0: 670a 2020 2020 2020 2020 2d20 6d65 6d6f  g.        - memo
+00001ff0: 7279 2066 7261 676d 656e 7461 7469 6f6e  ry fragmentation
+00002000: 0a20 2020 2020 2020 202d 206d 656d 6f72  .        - memor
+00002010: 7920 6c65 616b 730a 2020 2020 2020 2020  y leaks.        
+00002020: 2d20 6d65 6d6f 7279 206e 6f74 2079 6574  - memory not yet
+00002030: 2067 6172 6261 6765 2063 6f6c 6c65 6374   garbage collect
+00002040: 6564 0a20 2020 2020 2020 202d 206d 656d  ed.        - mem
+00002050: 6f72 7920 6e6f 7420 7965 7420 6672 6565  ory not yet free
+00002060: 2829 2764 2062 7920 7468 6520 5079 7468  ()'d by the Pyth
+00002070: 6f6e 206d 656d 6f72 7920 6d61 6e61 6765  on memory manage
+00002080: 7220 746f 2074 6865 204f 530a 0a20 2020  r to the OS..   
+00002090: 2075 6e6d 616e 6167 6564 5f6f 6c64 0a20   unmanaged_old. 
+000020a0: 2020 2020 2020 204d 696e 696d 756d 206f         Minimum o
+000020b0: 6620 7468 6520 2775 6e6d 616e 6167 6564  f the 'unmanaged
+000020c0: 2720 6d65 6173 7572 6573 206f 7665 7220  ' measures over 
+000020d0: 7468 6520 6c61 7374 0a20 2020 2020 2020  the last.       
+000020e0: 2060 6064 6973 7472 6962 7574 6564 2e6d   ``distributed.m
+000020f0: 656d 6f72 792e 7265 6365 6e74 2d74 6f2d  emory.recent-to-
+00002100: 6f6c 642d 7469 6d65 6060 2073 6563 6f6e  old-time`` secon
+00002110: 6473 0a0a 2020 2020 756e 6d61 6e61 6765  ds..    unmanage
+00002120: 645f 7265 6365 6e74 0a20 2020 2020 2020  d_recent.       
+00002130: 2075 6e6d 616e 6167 6564 202d 2075 6e6d   unmanaged - unm
+00002140: 616e 6167 6564 5f6f 6c64 3b20 696e 206f  anaged_old; in o
+00002150: 7468 6572 2077 6f72 6473 2070 726f 6365  ther words proce
+00002160: 7373 206d 656d 6f72 7920 7468 6174 2068  ss memory that h
+00002170: 6173 2062 6565 6e20 7265 6365 6e74 6c79  as been recently
+00002180: 0a20 2020 2020 2020 2061 6c6c 6f63 6174  .        allocat
+00002190: 6564 2062 7574 2069 7320 6e6f 7420 6163  ed but is not ac
+000021a0: 636f 756e 7465 6420 666f 7220 6279 2064  counted for by d
+000021b0: 6173 6b3b 2068 6f70 6566 756c 6c79 2069  ask; hopefully i
+000021c0: 7427 7320 6d6f 7374 6c79 2061 2074 656d  t's mostly a tem
+000021d0: 706f 7261 7279 0a20 2020 2020 2020 2073  porary.        s
+000021e0: 7069 6b65 2e0a 0a20 2020 206f 7074 696d  pike...    optim
+000021f0: 6973 7469 630a 2020 2020 2020 2020 6d61  istic.        ma
+00002200: 6e61 6765 6420 2b20 756e 6d61 6e61 6765  naged + unmanage
+00002210: 645f 6f6c 643b 2069 6e20 6f74 6865 7220  d_old; in other 
+00002220: 776f 7264 7320 7468 6520 6d65 6d6f 7279  words the memory
+00002230: 2068 656c 6420 6c6f 6e67 2d74 6572 6d20   held long-term 
+00002240: 6279 0a20 2020 2020 2020 2074 6865 2070  by.        the p
+00002250: 726f 6365 7373 2075 6e64 6572 2074 6865  rocess under the
+00002260: 2068 6f70 6566 756c 2061 7373 756d 7074   hopeful assumpt
+00002270: 696f 6e20 7468 6174 2061 6c6c 2075 6e6d  ion that all unm
+00002280: 616e 6167 6564 5f72 6563 656e 7420 6d65  anaged_recent me
+00002290: 6d6f 7279 2069 7320 610a 2020 2020 2020  mory is a.      
+000022a0: 2020 7465 6d70 6f72 6172 7920 7370 696b    temporary spik
+000022b0: 650a 2020 2020 2222 220a 0a20 2020 2070  e.    """..    p
+000022c0: 726f 6365 7373 3a20 696e 740a 2020 2020  rocess: int.    
+000022d0: 756e 6d61 6e61 6765 645f 6f6c 643a 2069  unmanaged_old: i
+000022e0: 6e74 0a20 2020 206d 616e 6167 6564 3a20  nt.    managed: 
+000022f0: 696e 740a 2020 2020 7370 696c 6c65 643a  int.    spilled:
+00002300: 2069 6e74 0a0a 2020 2020 5f5f 736c 6f74   int..    __slot
+00002310: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
+00002320: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
+00002330: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
+00002340: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00002350: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00002360: 2070 726f 6365 7373 3a20 696e 742c 0a20   process: int,. 
+00002370: 2020 2020 2020 2075 6e6d 616e 6167 6564         unmanaged
+00002380: 5f6f 6c64 3a20 696e 742c 0a20 2020 2020  _old: int,.     
+00002390: 2020 206d 616e 6167 6564 3a20 696e 742c     managed: int,
+000023a0: 0a20 2020 2020 2020 2073 7069 6c6c 6564  .        spilled
+000023b0: 3a20 696e 742c 0a20 2020 2029 3a0a 2020  : int,.    ):.  
+000023c0: 2020 2020 2020 2320 536f 6d65 2064 6174        # Some dat
+000023d0: 6120 6172 7269 7665 7320 7769 7468 2074  a arrives with t
+000023e0: 6865 2068 6561 7274 6265 6174 2c20 736f  he heartbeat, so
+000023f0: 6d65 206f 7468 6572 2061 7272 6976 6573  me other arrives
+00002400: 2069 6e20 7265 616c 7469 6d65 2061 7320   in realtime as 
+00002410: 7468 650a 2020 2020 2020 2020 2320 7461  the.        # ta
+00002420: 736b 7320 7072 6f67 7265 7373 2e20 416c  sks progress. Al
+00002430: 736f 2c20 7369 7a65 6f66 2829 2069 7320  so, sizeof() is 
+00002440: 6e6f 7420 6775 6172 616e 7465 6564 2074  not guaranteed t
+00002450: 6f20 7265 7475 726e 2063 6f72 7265 6374  o return correct
+00002460: 2072 6573 756c 7473 2e0a 2020 2020 2020   results..      
+00002470: 2020 2320 5468 6973 2063 616e 2063 6175    # This can cau
+00002480: 7365 2067 6c69 7463 6865 7320 7768 6572  se glitches wher
+00002490: 6520 6120 7061 7274 6961 6c20 6d65 6173  e a partial meas
+000024a0: 7572 6520 6973 206c 6172 6765 7220 7468  ure is larger th
+000024b0: 616e 2074 6865 2077 686f 6c65 2c20 736f  an the whole, so
+000024c0: 0a20 2020 2020 2020 2023 2077 6520 6e65  .        # we ne
+000024d0: 6564 2074 6f20 666f 7263 6520 616c 6c20  ed to force all 
+000024e0: 6e75 6d62 6572 7320 746f 2061 6464 2075  numbers to add u
+000024f0: 7020 6578 6163 746c 7920 6279 2064 6566  p exactly by def
+00002500: 696e 6974 696f 6e2e 0a20 2020 2020 2020  inition..       
+00002510: 2073 656c 662e 7072 6f63 6573 7320 3d20   self.process = 
+00002520: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
+00002530: 7365 6c66 2e6d 616e 6167 6564 203d 206d  self.managed = m
+00002540: 696e 2873 656c 662e 7072 6f63 6573 732c  in(self.process,
+00002550: 206d 616e 6167 6564 290a 2020 2020 2020   managed).      
+00002560: 2020 7365 6c66 2e73 7069 6c6c 6564 203d    self.spilled =
+00002570: 2073 7069 6c6c 6564 0a20 2020 2020 2020   spilled.       
+00002580: 2023 2053 7562 7472 6163 7469 6f6e 7320   # Subtractions 
+00002590: 6265 7477 6565 6e20 756e 7369 676e 6564  between unsigned
+000025a0: 2069 6e74 7320 6775 6172 616e 7465 6564   ints guaranteed
+000025b0: 2062 7920 636f 6e73 7472 7563 7469 6f6e   by construction
+000025c0: 2074 6f20 6265 203e 3d20 300a 2020 2020   to be >= 0.    
+000025d0: 2020 2020 7365 6c66 2e75 6e6d 616e 6167      self.unmanag
+000025e0: 6564 5f6f 6c64 203d 206d 696e 2875 6e6d  ed_old = min(unm
+000025f0: 616e 6167 6564 5f6f 6c64 2c20 7072 6f63  anaged_old, proc
+00002600: 6573 7320 2d20 7365 6c66 2e6d 616e 6167  ess - self.manag
+00002610: 6564 290a 0a20 2020 2040 7374 6174 6963  ed)..    @static
+00002620: 6d65 7468 6f64 0a20 2020 2064 6566 2073  method.    def s
+00002630: 756d 282a 696e 666f 733a 204d 656d 6f72  um(*infos: Memor
+00002640: 7953 7461 7465 2920 2d3e 204d 656d 6f72  yState) -> Memor
+00002650: 7953 7461 7465 3a0a 2020 2020 2020 2020  yState:.        
+00002660: 7072 6f63 6573 7320 3d20 300a 2020 2020  process = 0.    
+00002670: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
+00002680: 6420 3d20 300a 2020 2020 2020 2020 6d61  d = 0.        ma
+00002690: 6e61 6765 6420 3d20 300a 2020 2020 2020  naged = 0.      
+000026a0: 2020 7370 696c 6c65 6420 3d20 300a 2020    spilled = 0.  
+000026b0: 2020 2020 2020 666f 7220 6d73 2069 6e20        for ms in 
+000026c0: 696e 666f 733a 0a20 2020 2020 2020 2020  infos:.         
+000026d0: 2020 2070 726f 6365 7373 202b 3d20 6d73     process += ms
+000026e0: 2e70 726f 6365 7373 0a20 2020 2020 2020  .process.       
+000026f0: 2020 2020 2075 6e6d 616e 6167 6564 5f6f       unmanaged_o
+00002700: 6c64 202b 3d20 6d73 2e75 6e6d 616e 6167  ld += ms.unmanag
+00002710: 6564 5f6f 6c64 0a20 2020 2020 2020 2020  ed_old.         
+00002720: 2020 2073 7069 6c6c 6564 202b 3d20 6d73     spilled += ms
+00002730: 2e73 7069 6c6c 6564 0a20 2020 2020 2020  .spilled.       
+00002740: 2020 2020 206d 616e 6167 6564 202b 3d20       managed += 
+00002750: 6d73 2e6d 616e 6167 6564 0a20 2020 2020  ms.managed.     
+00002760: 2020 2072 6574 7572 6e20 4d65 6d6f 7279     return Memory
+00002770: 5374 6174 6528 0a20 2020 2020 2020 2020  State(.         
+00002780: 2020 2070 726f 6365 7373 3d70 726f 6365     process=proce
+00002790: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+000027a0: 756e 6d61 6e61 6765 645f 6f6c 643d 756e  unmanaged_old=un
+000027b0: 6d61 6e61 6765 645f 6f6c 642c 0a20 2020  managed_old,.   
+000027c0: 2020 2020 2020 2020 206d 616e 6167 6564           managed
+000027d0: 3d6d 616e 6167 6564 2c0a 2020 2020 2020  =managed,.      
+000027e0: 2020 2020 2020 7370 696c 6c65 643d 7370        spilled=sp
+000027f0: 696c 6c65 642c 0a20 2020 2020 2020 2029  illed,.        )
+00002800: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00002810: 2020 2020 6465 6620 6d61 6e61 6765 645f      def managed_
+00002820: 746f 7461 6c28 7365 6c66 2920 2d3e 2069  total(self) -> i
+00002830: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
+00002840: 726e 2073 656c 662e 6d61 6e61 6765 6420  rn self.managed 
+00002850: 2b20 7365 6c66 2e73 7069 6c6c 6564 0a0a  + self.spilled..
+00002860: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00002870: 2020 6465 6620 756e 6d61 6e61 6765 6428    def unmanaged(
+00002880: 7365 6c66 2920 2d3e 2069 6e74 3a0a 2020  self) -> int:.  
+00002890: 2020 2020 2020 2320 5468 6973 2069 7320        # This is 
+000028a0: 6e65 7665 7220 6e65 6761 7469 7665 2074  never negative t
+000028b0: 6861 6e6b 7320 746f 205f 5f69 6e69 745f  hanks to __init_
+000028c0: 5f0a 2020 2020 2020 2020 7265 7475 726e  _.        return
+000028d0: 2073 656c 662e 7072 6f63 6573 7320 2d20   self.process - 
+000028e0: 7365 6c66 2e6d 616e 6167 6564 0a0a 2020  self.managed..  
+000028f0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00002900: 6465 6620 756e 6d61 6e61 6765 645f 7265  def unmanaged_re
+00002910: 6365 6e74 2873 656c 6629 202d 3e20 696e  cent(self) -> in
+00002920: 743a 0a20 2020 2020 2020 2023 2054 6869  t:.        # Thi
+00002930: 7320 6973 206e 6576 6572 206e 6567 6174  s is never negat
+00002940: 6976 6520 7468 616e 6b73 2074 6f20 5f5f  ive thanks to __
+00002950: 696e 6974 5f5f 0a20 2020 2020 2020 2072  init__.        r
+00002960: 6574 7572 6e20 7365 6c66 2e70 726f 6365  eturn self.proce
+00002970: 7373 202d 2073 656c 662e 6d61 6e61 6765  ss - self.manage
+00002980: 6420 2d20 7365 6c66 2e75 6e6d 616e 6167  d - self.unmanag
+00002990: 6564 5f6f 6c64 0a0a 2020 2020 4070 726f  ed_old..    @pro
+000029a0: 7065 7274 790a 2020 2020 6465 6620 6f70  perty.    def op
+000029b0: 7469 6d69 7374 6963 2873 656c 6629 202d  timistic(self) -
+000029c0: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
+000029d0: 6574 7572 6e20 7365 6c66 2e6d 616e 6167  eturn self.manag
+000029e0: 6564 202b 2073 656c 662e 756e 6d61 6e61  ed + self.unmana
+000029f0: 6765 645f 6f6c 640a 0a20 2020 2040 7072  ged_old..    @pr
+00002a00: 6f70 6572 7479 0a20 2020 2064 6566 206d  operty.    def m
+00002a10: 616e 6167 6564 5f69 6e5f 6d65 6d6f 7279  anaged_in_memory
+00002a20: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
+00002a30: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
+00002a40: 7761 726e 2822 6d61 6e61 6765 645f 696e  warn("managed_in
+00002a50: 5f6d 656d 6f72 7920 6861 7320 6265 656e  _memory has been
+00002a60: 2072 656e 616d 6564 2074 6f20 6d61 6e61   renamed to mana
+00002a70: 6765 6422 2c20 4675 7475 7265 5761 726e  ged", FutureWarn
+00002a80: 696e 6729 0a20 2020 2020 2020 2072 6574  ing).        ret
+00002a90: 7572 6e20 7365 6c66 2e6d 616e 6167 6564  urn self.managed
+00002aa0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00002ab0: 2020 2020 6465 6620 6d61 6e61 6765 645f      def managed_
+00002ac0: 7370 696c 6c65 6428 7365 6c66 2920 2d3e  spilled(self) ->
+00002ad0: 2069 6e74 3a0a 2020 2020 2020 2020 7761   int:.        wa
+00002ae0: 726e 696e 6773 2e77 6172 6e28 226d 616e  rnings.warn("man
+00002af0: 6167 6564 5f73 7069 6c6c 6564 2068 6173  aged_spilled has
+00002b00: 2062 6565 6e20 7265 6e61 6d65 6420 746f   been renamed to
+00002b10: 2073 7069 6c6c 6564 222c 2046 7574 7572   spilled", Futur
+00002b20: 6557 6172 6e69 6e67 290a 2020 2020 2020  eWarning).      
+00002b30: 2020 7265 7475 726e 2073 656c 662e 7370    return self.sp
+00002b40: 696c 6c65 640a 0a20 2020 2064 6566 205f  illed..    def _
+00002b50: 5f72 6570 725f 5f28 7365 6c66 2920 2d3e  _repr__(self) ->
+00002b60: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
+00002b70: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+00002b80: 2020 2066 2250 726f 6365 7373 206d 656d     f"Process mem
+00002b90: 6f72 7920 2852 5353 2920 203a 207b 666f  ory (RSS)  : {fo
+00002ba0: 726d 6174 5f62 7974 6573 2873 656c 662e  rmat_bytes(self.
+00002bb0: 7072 6f63 6573 7329 7d5c 6e22 0a20 2020  process)}\n".   
+00002bc0: 2020 2020 2020 2020 2066 2220 202d 206d           f"  - m
+00002bd0: 616e 6167 6564 2062 7920 4461 736b 2020  anaged by Dask  
+00002be0: 203a 207b 666f 726d 6174 5f62 7974 6573   : {format_bytes
+00002bf0: 2873 656c 662e 6d61 6e61 6765 6429 7d5c  (self.managed)}\
+00002c00: 6e22 0a20 2020 2020 2020 2020 2020 2066  n".            f
+00002c10: 2220 202d 2075 6e6d 616e 6167 6564 2028  "  - unmanaged (
+00002c20: 6f6c 6429 2020 203a 207b 666f 726d 6174  old)   : {format
+00002c30: 5f62 7974 6573 2873 656c 662e 756e 6d61  _bytes(self.unma
+00002c40: 6e61 6765 645f 6f6c 6429 7d5c 6e22 0a20  naged_old)}\n". 
+00002c50: 2020 2020 2020 2020 2020 2066 2220 202d             f"  -
+00002c60: 2075 6e6d 616e 6167 6564 2028 7265 6365   unmanaged (rece
+00002c70: 6e74 293a 207b 666f 726d 6174 5f62 7974  nt): {format_byt
+00002c80: 6573 2873 656c 662e 756e 6d61 6e61 6765  es(self.unmanage
+00002c90: 645f 7265 6365 6e74 297d 5c6e 220a 2020  d_recent)}\n".  
+00002ca0: 2020 2020 2020 2020 2020 6622 5370 696c            f"Spil
+00002cb0: 6c65 6420 746f 2064 6973 6b20 2020 2020  led to disk     
+00002cc0: 2020 3a20 7b66 6f72 6d61 745f 6279 7465    : {format_byte
+00002cd0: 7328 7365 6c66 2e73 7069 6c6c 6564 297d  s(self.spilled)}
+00002ce0: 5c6e 220a 2020 2020 2020 2020 290a 0a20  \n".        ).. 
+00002cf0: 2020 2064 6566 205f 746f 5f64 6963 7428     def _to_dict(
+00002d00: 7365 6c66 2c20 2a2c 2065 7863 6c75 6465  self, *, exclude
+00002d10: 3a20 436f 6e74 6169 6e65 725b 7374 725d  : Container[str]
+00002d20: 203d 2028 2929 202d 3e20 6469 6374 3a0a   = ()) -> dict:.
+00002d30: 2020 2020 2020 2020 2222 2244 6963 7469          """Dicti
+00002d40: 6f6e 6172 7920 7265 7072 6573 656e 7461  onary representa
+00002d50: 7469 6f6e 2066 6f72 2064 6562 7567 6769  tion for debuggi
+00002d60: 6e67 2070 7572 706f 7365 732e 0a0a 2020  ng purposes...  
+00002d70: 2020 2020 2020 5365 6520 616c 736f 0a20        See also. 
+00002d80: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+00002d90: 2020 2020 2020 2020 436c 6965 6e74 2e64          Client.d
+00002da0: 756d 705f 636c 7573 7465 725f 7374 6174  ump_cluster_stat
+00002db0: 650a 2020 2020 2020 2020 6469 7374 7269  e.        distri
+00002dc0: 6275 7465 642e 7574 696c 732e 7265 6375  buted.utils.recu
+00002dd0: 7273 6976 655f 746f 5f64 6963 740a 2020  rsive_to_dict.  
+00002de0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00002df0: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
+00002e00: 2020 2020 2020 206b 3a20 6765 7461 7474         k: getatt
+00002e10: 7228 7365 6c66 2c20 6b29 0a20 2020 2020  r(self, k).     
+00002e20: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
+00002e30: 6469 7228 7365 6c66 290a 2020 2020 2020  dir(self).      
+00002e40: 2020 2020 2020 6966 206e 6f74 206b 2e73        if not k.s
+00002e50: 7461 7274 7377 6974 6828 225f 2229 0a20  tartswith("_"). 
+00002e60: 2020 2020 2020 2020 2020 2061 6e64 206b             and k
+00002e70: 206e 6f74 2069 6e20 7b22 7375 6d22 2c20   not in {"sum", 
+00002e80: 226d 616e 6167 6564 5f69 6e5f 6d65 6d6f  "managed_in_memo
+00002e90: 7279 222c 2022 6d61 6e61 6765 645f 7370  ry", "managed_sp
+00002ea0: 696c 6c65 6422 7d0a 2020 2020 2020 2020  illed"}.        
+00002eb0: 7d0a 0a0a 636c 6173 7320 576f 726b 6572  }...class Worker
+00002ec0: 5374 6174 653a 0a20 2020 2022 2222 4120  State:.    """A 
+00002ed0: 7369 6d70 6c65 206f 626a 6563 7420 686f  simple object ho
+00002ee0: 6c64 696e 6720 696e 666f 726d 6174 696f  lding informatio
+00002ef0: 6e20 6162 6f75 7420 6120 776f 726b 6572  n about a worker
+00002f00: 2e0a 0a20 2020 204e 6f74 2074 6f20 6265  ...    Not to be
+00002f10: 2063 6f6e 6675 7365 6420 7769 7468 203a   confused with :
+00002f20: 636c 6173 733a 6064 6973 7472 6962 7574  class:`distribut
+00002f30: 6564 2e77 6f72 6b65 725f 7374 6174 655f  ed.worker_state_
+00002f40: 6d61 6368 696e 652e 576f 726b 6572 5374  machine.WorkerSt
+00002f50: 6174 6560 2e0a 2020 2020 2222 220a 0a20  ate`..    """.. 
+00002f60: 2020 2023 3a20 5468 6973 2077 6f72 6b65     #: This worke
+00002f70: 7227 7320 756e 6971 7565 206b 6579 2e20  r's unique key. 
+00002f80: 5468 6973 2063 616e 2062 6520 6974 7320  This can be its 
+00002f90: 636f 6e6e 6563 7465 6420 6164 6472 6573  connected addres
+00002fa0: 730a 2020 2020 233a 2028 7375 6368 2061  s.    #: (such a
+00002fb0: 7320 6060 2274 6370 3a2f 2f31 3237 2e30  s ``"tcp://127.0
+00002fc0: 2e30 2e31 3a38 3839 3122 6060 2920 6f72  .0.1:8891"``) or
+00002fd0: 2061 6e20 616c 6961 7320 2873 7563 6820   an alias (such 
+00002fe0: 6173 2060 6022 616c 6963 6522 6060 292e  as ``"alice"``).
+00002ff0: 0a20 2020 2061 6464 7265 7373 3a20 7374  .    address: st
+00003000: 720a 0a20 2020 2070 6964 3a20 696e 740a  r..    pid: int.
+00003010: 2020 2020 6e61 6d65 3a20 4861 7368 6162      name: Hashab
+00003020: 6c65 0a0a 2020 2020 233a 2054 6865 206e  le..    #: The n
+00003030: 756d 6265 7220 6f66 2043 5055 2074 6872  umber of CPU thr
+00003040: 6561 6473 206d 6164 6520 6176 6169 6c61  eads made availa
+00003050: 626c 6520 6f6e 2074 6869 7320 776f 726b  ble on this work
+00003060: 6572 0a20 2020 206e 7468 7265 6164 733a  er.    nthreads:
+00003070: 2069 6e74 0a0a 2020 2020 233a 204d 656d   int..    #: Mem
+00003080: 6f72 7920 6176 6169 6c61 626c 6520 746f  ory available to
+00003090: 2074 6865 2077 6f72 6b65 722c 2069 6e20   the worker, in 
+000030a0: 6279 7465 730a 2020 2020 6d65 6d6f 7279  bytes.    memory
+000030b0: 5f6c 696d 6974 3a20 696e 740a 0a20 2020  _limit: int..   
+000030c0: 206c 6f63 616c 5f64 6972 6563 746f 7279   local_directory
+000030d0: 3a20 7374 720a 2020 2020 7365 7276 6963  : str.    servic
+000030e0: 6573 3a20 6469 6374 5b73 7472 2c20 696e  es: dict[str, in
+000030f0: 745d 0a0a 2020 2020 233a 204f 7574 7075  t]..    #: Outpu
+00003100: 7420 6f66 203a 6d65 7468 3a60 6469 7374  t of :meth:`dist
+00003110: 7269 6275 7465 642e 7665 7273 696f 6e73  ributed.versions
+00003120: 2e67 6574 5f76 6572 7369 6f6e 7360 206f  .get_versions` o
+00003130: 6e20 7468 6520 776f 726b 6572 0a20 2020  n the worker.   
+00003140: 2076 6572 7369 6f6e 733a 2064 6963 745b   versions: dict[
+00003150: 7374 722c 2041 6e79 5d0a 0a20 2020 2023  str, Any]..    #
+00003160: 3a20 4164 6472 6573 7320 6f66 2074 6865  : Address of the
+00003170: 2061 7373 6f63 6961 7465 6420 3a63 6c61   associated :cla
+00003180: 7373 3a60 7e64 6973 7472 6962 7574 6564  ss:`~distributed
+00003190: 2e6e 616e 6e79 2e4e 616e 6e79 602c 2069  .nanny.Nanny`, i
+000031a0: 6620 7072 6573 656e 740a 2020 2020 6e61  f present.    na
+000031b0: 6e6e 793a 2073 7472 0a0a 2020 2020 233a  nny: str..    #:
+000031c0: 2052 6561 642d 6f6e 6c79 2077 6f72 6b65   Read-only worke
+000031d0: 7220 7374 6174 7573 2c20 7379 6e63 6564  r status, synced
+000031e0: 206f 6e65 2077 6179 2066 726f 6d20 7468   one way from th
+000031f0: 6520 7265 6d6f 7465 2057 6f72 6b65 7220  e remote Worker 
+00003200: 6f62 6a65 6374 0a20 2020 2073 7461 7475  object.    statu
+00003210: 733a 2053 7461 7475 730a 0a20 2020 2023  s: Status..    #
+00003220: 3a20 4361 6368 6564 2068 6173 6820 6f66  : Cached hash of
+00003230: 203a 6174 7472 3a60 7e57 6f72 6b65 7253   :attr:`~WorkerS
+00003240: 7461 7465 2e61 6464 7265 7373 600a 2020  tate.address`.  
+00003250: 2020 5f68 6173 683a 2069 6e74 0a0a 2020    _hash: int..  
+00003260: 2020 233a 2054 6865 2074 6f74 616c 206d    #: The total m
+00003270: 656d 6f72 7920 7369 7a65 2c20 696e 2062  emory size, in b
+00003280: 7974 6573 2c20 7573 6564 2062 7920 7468  ytes, used by th
+00003290: 6520 7461 736b 7320 7468 6973 2077 6f72  e tasks this wor
+000032a0: 6b65 7220 686f 6c64 7320 696e 206d 656d  ker holds in mem
+000032b0: 6f72 790a 2020 2020 233a 2028 692e 652e  ory.    #: (i.e.
+000032c0: 2074 6865 2074 6173 6b73 2069 6e20 7468   the tasks in th
+000032d0: 6973 2077 6f72 6b65 7227 7320 3a61 7474  is worker's :att
+000032e0: 723a 607e 576f 726b 6572 5374 6174 652e  r:`~WorkerState.
+000032f0: 6861 735f 7768 6174 6029 2e0a 2020 2020  has_what`)..    
+00003300: 6e62 7974 6573 3a20 696e 740a 0a20 2020  nbytes: int..   
+00003310: 2023 3a20 576f 726b 6572 206d 656d 6f72   #: Worker memor
+00003320: 7920 756e 6b6e 6f77 6e20 746f 2074 6865  y unknown to the
+00003330: 2077 6f72 6b65 722c 2069 6e20 6279 7465   worker, in byte
+00003340: 732c 2077 6869 6368 2068 6173 2062 6565  s, which has bee
+00003350: 6e20 7468 6572 6520 666f 7220 6d6f 7265  n there for more
+00003360: 2074 6861 6e0a 2020 2020 233a 2033 3020   than.    #: 30 
+00003370: 7365 636f 6e64 732e 2053 6565 203a 636c  seconds. See :cl
+00003380: 6173 733a 604d 656d 6f72 7953 7461 7465  ass:`MemoryState
+00003390: 602e 0a20 2020 205f 6d65 6d6f 7279 5f75  `..    _memory_u
+000033a0: 6e6d 616e 6167 6564 5f6f 6c64 3a20 696e  nmanaged_old: in
+000033b0: 740a 0a20 2020 2023 3a20 4869 7374 6f72  t..    #: Histor
+000033c0: 7920 6f66 2074 6865 206c 6173 7420 3330  y of the last 30
+000033d0: 2073 6563 6f6e 6473 2720 776f 7274 6820   seconds' worth 
+000033e0: 6f66 2075 6e6d 616e 6167 6564 206d 656d  of unmanaged mem
+000033f0: 6f72 792e 2055 7365 6420 746f 2064 6966  ory. Used to dif
+00003400: 6665 7265 6e74 6961 7465 0a20 2020 2023  ferentiate.    #
+00003410: 3a20 6265 7477 6565 6e20 226f 6c64 2220  : between "old" 
+00003420: 616e 6420 226e 6577 2220 756e 6d61 6e61  and "new" unmana
+00003430: 6765 6420 6d65 6d6f 7279 2e0a 2020 2020  ged memory..    
+00003440: 233a 2046 6f72 6d61 743a 2060 605b 2874  #: Format: ``[(t
+00003450: 696d 6573 7461 6d70 2c20 6279 7465 7329  imestamp, bytes)
+00003460: 2c20 2874 696d 6573 7461 6d70 2c20 6279  , (timestamp, by
+00003470: 7465 7329 2c20 2e2e 2e5d 6060 0a20 2020  tes), ...]``.   
+00003480: 205f 6d65 6d6f 7279 5f75 6e6d 616e 6167   _memory_unmanag
+00003490: 6564 5f68 6973 746f 7279 3a20 6465 7175  ed_history: dequ
+000034a0: 655b 7475 706c 655b 666c 6f61 742c 2069  e[tuple[float, i
+000034b0: 6e74 5d5d 0a0a 2020 2020 6d65 7472 6963  nt]]..    metric
+000034c0: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
+000034d0: 5d0a 0a20 2020 2023 3a20 5468 6520 6c61  ]..    #: The la
+000034e0: 7374 2074 696d 6520 7765 2072 6563 6569  st time we recei
+000034f0: 7665 6420 6120 6865 6172 7462 6561 7420  ved a heartbeat 
+00003500: 6672 6f6d 2074 6869 7320 776f 726b 6572  from this worker
+00003510: 2c20 696e 206c 6f63 616c 2073 6368 6564  , in local sched
+00003520: 756c 6572 2074 696d 652e 0a20 2020 206c  uler time..    l
+00003530: 6173 745f 7365 656e 3a20 666c 6f61 740a  ast_seen: float.
+00003540: 0a20 2020 2074 696d 655f 6465 6c61 793a  .    time_delay:
+00003550: 2066 6c6f 6174 0a20 2020 2062 616e 6477   float.    bandw
+00003560: 6964 7468 3a20 666c 6f61 740a 0a20 2020  idth: float..   
+00003570: 2023 3a20 4120 7365 7420 6f66 2061 6c6c   #: A set of all
+00003580: 2054 6173 6b53 7461 7465 7320 6f6e 2074   TaskStates on t
+00003590: 6869 7320 776f 726b 6572 2074 6861 7420  his worker that 
+000035a0: 6172 6520 6163 746f 7273 2e20 5468 6973  are actors. This
+000035b0: 206f 6e6c 7920 696e 636c 7564 6573 2074   only includes t
+000035c0: 686f 7365 0a20 2020 2023 3a20 6163 746f  hose.    #: acto
+000035d0: 7273 2077 686f 7365 2073 7461 7465 2061  rs whose state a
+000035e0: 6374 7561 6c6c 7920 6c69 7665 7320 6f6e  ctually lives on
+000035f0: 2074 6869 7320 776f 726b 6572 2c20 6e6f   this worker, no
+00003600: 7420 6163 746f 7273 2074 6f20 7768 6963  t actors to whic
+00003610: 6820 7468 6973 2077 6f72 6b65 720a 2020  h this worker.  
+00003620: 2020 233a 2068 6173 2061 2072 6566 6572    #: has a refer
+00003630: 656e 6365 2e0a 2020 2020 6163 746f 7273  ence..    actors
+00003640: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
+00003650: 0a0a 2020 2020 233a 2055 6e64 6572 6c79  ..    #: Underly
+00003660: 696e 6720 6461 7461 206f 6620 3a6d 6574  ing data of :met
+00003670: 683a 6057 6f72 6b65 7253 7461 7465 2e68  h:`WorkerState.h
+00003680: 6173 5f77 6861 7460 0a20 2020 205f 6861  as_what`.    _ha
+00003690: 735f 7768 6174 3a20 6469 6374 5b54 6173  s_what: dict[Tas
+000036a0: 6b53 7461 7465 2c20 4e6f 6e65 5d0a 0a20  kState, None].. 
+000036b0: 2020 2023 3a20 4120 7365 7420 6f66 2074     #: A set of t
+000036c0: 6173 6b73 2074 6861 7420 6861 7665 2062  asks that have b
+000036d0: 6565 6e20 7375 626d 6974 7465 6420 746f  een submitted to
+000036e0: 2074 6869 7320 776f 726b 6572 2e20 4d75   this worker. Mu
+000036f0: 6c74 6970 6c65 2074 6173 6b73 206d 6179  ltiple tasks may
+00003700: 2062 650a 2020 2020 2320 7375 626d 6974   be.    # submit
+00003710: 7465 6420 746f 2061 2077 6f72 6b65 7220  ted to a worker 
+00003720: 696e 2061 6476 616e 6365 2061 6e64 2074  in advance and t
+00003730: 6865 2077 6f72 6b65 7220 7769 6c6c 2072  he worker will r
+00003740: 756e 2074 6865 6d20 6576 656e 7475 616c  un them eventual
+00003750: 6c79 2c0a 2020 2020 2320 6465 7065 6e64  ly,.    # depend
+00003760: 696e 6720 6f6e 2069 7473 2065 7865 6375  ing on its execu
+00003770: 7469 6f6e 2072 6573 6f75 7263 6573 2028  tion resources (
+00003780: 6275 7420 7365 6520 3a64 6f63 3a60 776f  but see :doc:`wo
+00003790: 726b 2d73 7465 616c 696e 6760 292e 0a20  rk-stealing`).. 
+000037a0: 2020 2023 3a0a 2020 2020 233a 2041 6c6c     #:.    #: All
+000037b0: 2074 6865 2074 6173 6b73 2068 6572 6520   the tasks here 
+000037c0: 6172 6520 696e 2074 6865 2022 7072 6f63  are in the "proc
+000037d0: 6573 7369 6e67 2220 7374 6174 652e 0a20  essing" state.. 
+000037e0: 2020 2023 3a20 5468 6973 2061 7474 7269     #: This attri
+000037f0: 6275 7465 2069 7320 6b65 7074 2069 6e20  bute is kept in 
+00003800: 7379 6e63 2077 6974 6820 3a61 7474 723a  sync with :attr:
+00003810: 6054 6173 6b53 7461 7465 2e70 726f 6365  `TaskState.proce
+00003820: 7373 696e 675f 6f6e 602e 0a20 2020 2070  ssing_on`..    p
+00003830: 726f 6365 7373 696e 673a 2073 6574 5b54  rocessing: set[T
+00003840: 6173 6b53 7461 7465 5d0a 0a20 2020 2023  askState]..    #
+00003850: 3a20 5275 6e6e 696e 6720 7461 736b 7320  : Running tasks 
+00003860: 7468 6174 2069 6e76 6f6b 6564 203a 6675  that invoked :fu
+00003870: 6e63 3a60 6469 7374 7269 6275 7465 642e  nc:`distributed.
+00003880: 7365 6365 6465 600a 2020 2020 6c6f 6e67  secede`.    long
+00003890: 5f72 756e 6e69 6e67 3a20 7365 745b 5461  _running: set[Ta
+000038a0: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
+000038b0: 2041 2064 6963 7469 6f6e 6172 7920 6f66   A dictionary of
+000038c0: 2074 6173 6b73 2074 6861 7420 6172 6520   tasks that are 
+000038d0: 6375 7272 656e 746c 7920 6265 696e 6720  currently being 
+000038e0: 7275 6e20 6f6e 2074 6869 7320 776f 726b  run on this work
+000038f0: 6572 2e0a 2020 2020 233a 2045 6163 6820  er..    #: Each 
+00003900: 7461 736b 2073 7461 7465 2069 7320 6173  task state is as
+00003910: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
+00003920: 6520 6475 7261 7469 6f6e 2069 6e20 7365  e duration in se
+00003930: 636f 6e64 7320 7768 6963 6820 7468 6520  conds which the 
+00003940: 7461 736b 2068 6173 0a20 2020 2023 3a20  task has.    #: 
+00003950: 6265 656e 2072 756e 6e69 6e67 2e0a 2020  been running..  
+00003960: 2020 6578 6563 7574 696e 673a 2064 6963    executing: dic
+00003970: 745b 5461 736b 5374 6174 652c 2066 6c6f  t[TaskState, flo
+00003980: 6174 5d0a 0a20 2020 2023 3a20 5468 6520  at]..    #: The 
+00003990: 6176 6169 6c61 626c 6520 7265 736f 7572  available resour
+000039a0: 6365 7320 6f6e 2074 6869 7320 776f 726b  ces on this work
+000039b0: 6572 2c20 652e 672e 2060 607b 2247 5055  er, e.g. ``{"GPU
+000039c0: 223a 2032 7d60 602e 0a20 2020 2023 3a20  ": 2}``..    #: 
+000039d0: 5468 6573 6520 6172 6520 6162 7374 7261  These are abstra
+000039e0: 6374 2071 7561 6e74 6974 6965 7320 7468  ct quantities th
+000039f0: 6174 2063 6f6e 7374 7261 696e 2063 6572  at constrain cer
+00003a00: 7461 696e 2074 6173 6b73 2066 726f 6d20  tain tasks from 
+00003a10: 7275 6e6e 696e 6720 6174 2074 6865 0a20  running at the. 
+00003a20: 2020 2023 3a20 7361 6d65 2074 696d 6520     #: same time 
+00003a30: 6f6e 2074 6869 7320 776f 726b 6572 2e0a  on this worker..
+00003a40: 2020 2020 7265 736f 7572 6365 733a 2064      resources: d
+00003a50: 6963 745b 7374 722c 2066 6c6f 6174 5d0a  ict[str, float].
+00003a60: 0a20 2020 2023 3a20 5468 6520 7375 6d20  .    #: The sum 
+00003a70: 6f66 2065 6163 6820 7265 736f 7572 6365  of each resource
+00003a80: 2075 7365 6420 6279 2061 6c6c 2074 6173   used by all tas
+00003a90: 6b73 2061 6c6c 6f63 6174 6564 2074 6f20  ks allocated to 
+00003aa0: 7468 6973 2077 6f72 6b65 722e 0a20 2020  this worker..   
+00003ab0: 2023 3a20 5468 6520 6e75 6d62 6572 7320   #: The numbers 
+00003ac0: 696e 2074 6869 7320 6469 6374 696f 6e61  in this dictiona
+00003ad0: 7279 2063 616e 206f 6e6c 7920 6265 206c  ry can only be l
+00003ae0: 6573 7320 6f72 2065 7175 616c 2074 6861  ess or equal tha
+00003af0: 6e20 7468 6f73 6520 696e 2074 6869 730a  n those in this.
+00003b00: 2020 2020 233a 2077 6f72 6b65 7227 7320      #: worker's 
+00003b10: 3a61 7474 723a 607e 576f 726b 6572 5374  :attr:`~WorkerSt
+00003b20: 6174 652e 7265 736f 7572 6365 7360 2e0a  ate.resources`..
+00003b30: 2020 2020 7573 6564 5f72 6573 6f75 7263      used_resourc
+00003b40: 6573 3a20 6469 6374 5b73 7472 2c20 666c  es: dict[str, fl
+00003b50: 6f61 745d 0a0a 2020 2020 233a 2041 7262  oat]..    #: Arb
+00003b60: 6974 7261 7279 2061 6464 6974 696f 6e61  itrary additiona
+00003b70: 6c20 6d65 7461 6461 7461 2074 6f20 6265  l metadata to be
+00003b80: 2061 6464 6564 2074 6f20 3a6d 6574 683a   added to :meth:
+00003b90: 607e 576f 726b 6572 5374 6174 652e 6964  `~WorkerState.id
+00003ba0: 656e 7469 7479 600a 2020 2020 6578 7472  entity`.    extr
+00003bb0: 613a 2064 6963 745b 7374 722c 2041 6e79  a: dict[str, Any
+00003bc0: 5d0a 0a20 2020 2023 2054 6865 2075 6e69  ]..    # The uni
+00003bd0: 7175 6520 7365 7276 6572 2049 4420 7468  que server ID th
+00003be0: 6973 2057 6f72 6b65 7253 7461 7465 2069  is WorkerState i
+00003bf0: 7320 7265 6665 7265 6e63 696e 670a 2020  s referencing.  
+00003c00: 2020 7365 7276 6572 5f69 643a 2073 7472    server_id: str
+00003c10: 0a0a 2020 2020 2320 5265 6665 7265 6e63  ..    # Referenc
+00003c20: 6520 746f 2073 6368 6564 756c 6572 2074  e to scheduler t
+00003c30: 6173 6b5f 6772 6f75 7073 0a20 2020 2073  ask_groups.    s
+00003c40: 6368 6564 756c 6572 5f72 6566 3a20 7765  cheduler_ref: we
+00003c50: 616b 7265 662e 7265 665b 5363 6865 6475  akref.ref[Schedu
+00003c60: 6c65 7253 7461 7465 5d20 7c20 4e6f 6e65  lerState] | None
+00003c70: 0a20 2020 2074 6173 6b5f 7072 6566 6978  .    task_prefix
+00003c80: 5f63 6f75 6e74 3a20 6465 6661 756c 7464  _count: defaultd
+00003c90: 6963 745b 7374 722c 2069 6e74 5d0a 2020  ict[str, int].  
+00003ca0: 2020 5f6e 6574 776f 726b 5f6f 6363 3a20    _network_occ: 
+00003cb0: 666c 6f61 740a 2020 2020 5f6f 6363 7570  float.    _occup
+00003cc0: 616e 6379 5f63 6163 6865 3a20 666c 6f61  ancy_cache: floa
+00003cd0: 7420 7c20 4e6f 6e65 0a0a 2020 2020 233a  t | None..    #:
+00003ce0: 204b 6579 7320 7468 6174 206d 6179 206e   Keys that may n
+00003cf0: 6565 6420 746f 2062 6520 6665 7463 6865  eed to be fetche
+00003d00: 6420 746f 2074 6869 7320 776f 726b 6572  d to this worker
+00003d10: 2c20 616e 6420 7468 6520 6e75 6d62 6572  , and the number
+00003d20: 206f 6620 7461 736b 7320 7468 6174 206e   of tasks that n
+00003d30: 6565 6420 7468 656d 2e0a 2020 2020 233a  eed them..    #:
+00003d40: 2041 6c6c 2074 6173 6b73 2061 7265 2063   All tasks are c
+00003d50: 7572 7265 6e74 6c79 2069 6e20 606d 656d  urrently in `mem
+00003d60: 6f72 7960 206f 6e20 6120 776f 726b 6572  ory` on a worker
+00003d70: 206f 7468 6572 2074 6861 6e20 7468 6973   other than this
+00003d80: 206f 6e65 2e0a 2020 2020 233a 204d 7563   one..    #: Muc
+00003d90: 6820 6c69 6b65 2060 7072 6f63 6573 7369  h like `processi
+00003da0: 6e67 602c 2074 6869 7320 646f 6573 206e  ng`, this does n
+00003db0: 6f74 2065 7861 6374 6c79 2072 6566 6c65  ot exactly refle
+00003dc0: 6374 2077 6f72 6b65 7220 7374 6174 653a  ct worker state:
+00003dd0: 0a20 2020 2023 3a20 6b65 7973 2068 6572  .    #: keys her
+00003de0: 6520 6d61 7920 6265 2071 7565 7565 6420  e may be queued 
+00003df0: 746f 2066 6574 6368 2c20 696e 2066 6c69  to fetch, in fli
+00003e00: 6768 742c 206f 7220 616c 7265 6164 7920  ght, or already 
+00003e10: 696e 206d 656d 6f72 790a 2020 2020 233a  in memory.    #:
+00003e20: 206f 6e20 7468 6520 776f 726b 6572 2e0a   on the worker..
+00003e30: 2020 2020 6e65 6564 735f 7768 6174 3a20      needs_what: 
+00003e40: 6469 6374 5b54 6173 6b53 7461 7465 2c20  dict[TaskState, 
+00003e50: 696e 745d 0a0a 2020 2020 5f5f 736c 6f74  int]..    __slot
+00003e60: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
+00003e70: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
+00003e80: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
+00003e90: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00003ea0: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00003eb0: 2061 6464 7265 7373 3a20 7374 722c 0a20   address: str,. 
+00003ec0: 2020 2020 2020 2073 7461 7475 733a 2053         status: S
+00003ed0: 7461 7475 732c 0a20 2020 2020 2020 2070  tatus,.        p
+00003ee0: 6964 3a20 696e 742c 0a20 2020 2020 2020  id: int,.       
+00003ef0: 206e 616d 653a 206f 626a 6563 742c 0a20   name: object,. 
+00003f00: 2020 2020 2020 206e 7468 7265 6164 733a         nthreads:
+00003f10: 2069 6e74 203d 2030 2c0a 2020 2020 2020   int = 0,.      
+00003f20: 2020 6d65 6d6f 7279 5f6c 696d 6974 3a20    memory_limit: 
+00003f30: 696e 742c 0a20 2020 2020 2020 206c 6f63  int,.        loc
+00003f40: 616c 5f64 6972 6563 746f 7279 3a20 7374  al_directory: st
+00003f50: 722c 0a20 2020 2020 2020 206e 616e 6e79  r,.        nanny
+00003f60: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
+00003f70: 6572 7665 725f 6964 3a20 7374 722c 0a20  erver_id: str,. 
+00003f80: 2020 2020 2020 2073 6572 7669 6365 733a         services:
+00003f90: 2064 6963 745b 7374 722c 2069 6e74 5d20   dict[str, int] 
+00003fa0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00003fb0: 2020 2020 2020 2076 6572 7369 6f6e 733a         versions:
+00003fc0: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
+00003fd0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00003fe0: 2020 2020 2020 2065 7874 7261 3a20 6469         extra: di
+00003ff0: 6374 5b73 7472 2c20 416e 795d 207c 204e  ct[str, Any] | N
+00004000: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00004010: 2020 2020 7363 6865 6475 6c65 723a 2053      scheduler: S
+00004020: 6368 6564 756c 6572 5374 6174 6520 7c20  chedulerState | 
+00004030: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00004040: 2029 3a0a 2020 2020 2020 2020 7365 6c66   ):.        self
+00004050: 2e73 6572 7665 725f 6964 203d 2073 6572  .server_id = ser
+00004060: 7665 725f 6964 0a20 2020 2020 2020 2073  ver_id.        s
+00004070: 656c 662e 6164 6472 6573 7320 3d20 6164  elf.address = ad
+00004080: 6472 6573 730a 2020 2020 2020 2020 7365  dress.        se
+00004090: 6c66 2e70 6964 203d 2070 6964 0a20 2020  lf.pid = pid.   
+000040a0: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
+000040b0: 206e 616d 650a 2020 2020 2020 2020 7365   name.        se
+000040c0: 6c66 2e6e 7468 7265 6164 7320 3d20 6e74  lf.nthreads = nt
+000040d0: 6872 6561 6473 0a20 2020 2020 2020 2073  hreads.        s
+000040e0: 656c 662e 6d65 6d6f 7279 5f6c 696d 6974  elf.memory_limit
+000040f0: 203d 206d 656d 6f72 795f 6c69 6d69 740a   = memory_limit.
+00004100: 2020 2020 2020 2020 7365 6c66 2e6c 6f63          self.loc
+00004110: 616c 5f64 6972 6563 746f 7279 203d 206c  al_directory = l
+00004120: 6f63 616c 5f64 6972 6563 746f 7279 0a20  ocal_directory. 
+00004130: 2020 2020 2020 2073 656c 662e 7365 7276         self.serv
+00004140: 6963 6573 203d 2073 6572 7669 6365 7320  ices = services 
+00004150: 6f72 207b 7d0a 2020 2020 2020 2020 7365  or {}.        se
+00004160: 6c66 2e76 6572 7369 6f6e 7320 3d20 7665  lf.versions = ve
+00004170: 7273 696f 6e73 206f 7220 7b7d 0a20 2020  rsions or {}.   
+00004180: 2020 2020 2073 656c 662e 6e61 6e6e 7920       self.nanny 
+00004190: 3d20 6e61 6e6e 790a 2020 2020 2020 2020  = nanny.        
+000041a0: 7365 6c66 2e73 7461 7475 7320 3d20 7374  self.status = st
+000041b0: 6174 7573 0a20 2020 2020 2020 2073 656c  atus.        sel
+000041c0: 662e 5f68 6173 6820 3d20 6861 7368 2873  f._hash = hash(s
+000041d0: 656c 662e 7365 7276 6572 5f69 6429 0a20  elf.server_id). 
+000041e0: 2020 2020 2020 2073 656c 662e 6e62 7974         self.nbyt
+000041f0: 6573 203d 2030 0a20 2020 2020 2020 2073  es = 0.        s
+00004200: 656c 662e 5f6d 656d 6f72 795f 756e 6d61  elf._memory_unma
+00004210: 6e61 6765 645f 6f6c 6420 3d20 300a 2020  naged_old = 0.  
+00004220: 2020 2020 2020 7365 6c66 2e5f 6d65 6d6f        self._memo
+00004230: 7279 5f75 6e6d 616e 6167 6564 5f68 6973  ry_unmanaged_his
+00004240: 746f 7279 203d 2064 6571 7565 2829 0a20  tory = deque(). 
+00004250: 2020 2020 2020 2073 656c 662e 6d65 7472         self.metr
+00004260: 6963 7320 3d20 7b7d 0a20 2020 2020 2020  ics = {}.       
+00004270: 2073 656c 662e 6c61 7374 5f73 6565 6e20   self.last_seen 
+00004280: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+00004290: 2e74 696d 655f 6465 6c61 7920 3d20 300a  .time_delay = 0.
+000042a0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+000042b0: 6477 6964 7468 203d 2070 6172 7365 5f62  dwidth = parse_b
+000042c0: 7974 6573 2864 6173 6b2e 636f 6e66 6967  ytes(dask.config
+000042d0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+000042e0: 642e 7363 6865 6475 6c65 722e 6261 6e64  d.scheduler.band
+000042f0: 7769 6474 6822 2929 0a20 2020 2020 2020  width")).       
+00004300: 2073 656c 662e 6163 746f 7273 203d 2073   self.actors = s
+00004310: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+00004320: 662e 5f68 6173 5f77 6861 7420 3d20 7b7d  f._has_what = {}
+00004330: 0a20 2020 2020 2020 2073 656c 662e 7072  .        self.pr
+00004340: 6f63 6573 7369 6e67 203d 2073 6574 2829  ocessing = set()
+00004350: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+00004360: 6e67 5f72 756e 6e69 6e67 203d 2073 6574  ng_running = set
+00004370: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00004380: 6578 6563 7574 696e 6720 3d20 7b7d 0a20  executing = {}. 
+00004390: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
+000043a0: 7572 6365 7320 3d20 7b7d 0a20 2020 2020  urces = {}.     
+000043b0: 2020 2073 656c 662e 7573 6564 5f72 6573     self.used_res
+000043c0: 6f75 7263 6573 203d 207b 7d0a 2020 2020  ources = {}.    
+000043d0: 2020 2020 7365 6c66 2e65 7874 7261 203d      self.extra =
+000043e0: 2065 7874 7261 206f 7220 7b7d 0a20 2020   extra or {}.   
+000043f0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+00004400: 6c65 725f 7265 6620 3d20 7765 616b 7265  ler_ref = weakre
+00004410: 662e 7265 6628 7363 6865 6475 6c65 7229  f.ref(scheduler)
+00004420: 2069 6620 7363 6865 6475 6c65 7220 656c   if scheduler el
+00004430: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+00004440: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
+00004450: 5f63 6f75 6e74 203d 2064 6566 6175 6c74  _count = default
+00004460: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
+00004470: 2020 7365 6c66 2e6e 6565 6473 5f77 6861    self.needs_wha
+00004480: 7420 3d20 7b7d 0a20 2020 2020 2020 2073  t = {}.        s
+00004490: 656c 662e 5f6e 6574 776f 726b 5f6f 6363  elf._network_occ
+000044a0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+000044b0: 662e 5f6f 6363 7570 616e 6379 5f63 6163  f._occupancy_cac
+000044c0: 6865 203d 204e 6f6e 650a 0a20 2020 2064  he = None..    d
+000044d0: 6566 205f 5f68 6173 685f 5f28 7365 6c66  ef __hash__(self
+000044e0: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
+000044f0: 2020 7265 7475 726e 2073 656c 662e 5f68    return self._h
+00004500: 6173 680a 0a20 2020 2064 6566 205f 5f65  ash..    def __e
+00004510: 715f 5f28 7365 6c66 2c20 6f74 6865 723a  q__(self, other:
+00004520: 206f 626a 6563 7429 202d 3e20 626f 6f6c   object) -> bool
+00004530: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00004540: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
+00004550: 722c 2057 6f72 6b65 7253 7461 7465 2920  r, WorkerState) 
+00004560: 616e 6420 6f74 6865 722e 7365 7276 6572  and other.server
+00004570: 5f69 6420 3d3d 2073 656c 662e 7365 7276  _id == self.serv
+00004580: 6572 5f69 640a 0a20 2020 2040 7072 6f70  er_id..    @prop
+00004590: 6572 7479 0a20 2020 2064 6566 2068 6173  erty.    def has
+000045a0: 5f77 6861 7428 7365 6c66 2920 2d3e 2053  _what(self) -> S
+000045b0: 6574 5b54 6173 6b53 7461 7465 5d3a 0a20  et[TaskState]:. 
+000045c0: 2020 2020 2020 2022 2222 416e 2069 6e73         """An ins
+000045d0: 6572 7469 6f6e 2d73 6f72 7465 6420 7365  ertion-sorted se
+000045e0: 742d 6c69 6b65 206f 6620 7461 736b 7320  t-like of tasks 
+000045f0: 7768 6963 6820 6375 7272 656e 746c 7920  which currently 
+00004600: 7265 7369 6465 206f 6e20 7468 6973 2077  reside on this w
+00004610: 6f72 6b65 722e 0a20 2020 2020 2020 2041  orker..        A
+00004620: 6c6c 2074 6865 2074 6173 6b73 2068 6572  ll the tasks her
+00004630: 6520 6172 6520 696e 2074 6865 2022 6d65  e are in the "me
+00004640: 6d6f 7279 2220 7374 6174 652e 0a20 2020  mory" state..   
+00004650: 2020 2020 2054 6869 7320 6973 2074 6865       This is the
+00004660: 2072 6576 6572 7365 206d 6170 7069 6e67   reverse mapping
+00004670: 206f 6620 3a61 7474 723a 6054 6173 6b53   of :attr:`TaskS
+00004680: 7461 7465 2e77 686f 5f68 6173 602e 0a0a  tate.who_has`...
+00004690: 2020 2020 2020 2020 5468 6973 2069 7320          This is 
+000046a0: 6120 7265 6164 2d6f 6e6c 7920 7075 626c  a read-only publ
+000046b0: 6963 2061 6363 6573 736f 722e 2054 6865  ic accessor. The
+000046c0: 2064 6174 6120 6973 2069 6d70 6c65 6d65   data is impleme
+000046d0: 6e74 6564 2061 7320 6120 6469 6374 2077  nted as a dict w
+000046e0: 6974 686f 7574 0a20 2020 2020 2020 2076  ithout.        v
+000046f0: 616c 7565 732c 2062 6563 6175 7365 2072  alues, because r
+00004700: 6562 616c 616e 6365 2829 2072 656c 6965  ebalance() relie
+00004710: 7320 6f6e 2064 6963 7473 2062 6569 6e67  s on dicts being
+00004720: 2069 6e73 6572 7469 6f6e 2d73 6f72 7465   insertion-sorte
+00004730: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
+00004740: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00004750: 6c66 2e5f 6861 735f 7768 6174 2e6b 6579  lf._has_what.key
+00004760: 7328 290a 0a20 2020 2040 7072 6f70 6572  s()..    @proper
+00004770: 7479 0a20 2020 2064 6566 2068 6f73 7428  ty.    def host(
+00004780: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
+00004790: 2020 2020 2020 7265 7475 726e 2067 6574        return get
+000047a0: 5f61 6464 7265 7373 5f68 6f73 7428 7365  _address_host(se
+000047b0: 6c66 2e61 6464 7265 7373 290a 0a20 2020  lf.address)..   
+000047c0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+000047d0: 6566 206d 656d 6f72 7928 7365 6c66 2920  ef memory(self) 
+000047e0: 2d3e 204d 656d 6f72 7953 7461 7465 3a0a  -> MemoryState:.
+000047f0: 2020 2020 2020 2020 2222 2250 6f6c 6973          """Polis
+00004800: 6865 6420 6d65 6d6f 7279 206d 6574 7269  hed memory metri
+00004810: 6373 2066 6f72 2074 6865 2077 6f72 6b65  cs for the worke
+00004820: 722e 0a0a 2020 2020 2020 2020 2a2a 4465  r...        **De
+00004830: 7369 676e 206e 6f74 6520 6f6e 206d 616e  sign note on man
+00004840: 6167 6564 206d 656d 6f72 792a 2a0a 0a20  aged memory**.. 
+00004850: 2020 2020 2020 2054 6865 7265 2061 7265         There are
+00004860: 2074 776f 206d 6561 7375 7265 7320 6176   two measures av
+00004870: 6169 6c61 626c 6520 666f 7220 6d61 6e61  ailable for mana
+00004880: 6765 6420 6d65 6d6f 7279 3a0a 0a20 2020  ged memory:..   
+00004890: 2020 2020 202d 2060 6073 656c 662e 6e62       - ``self.nb
+000048a0: 7974 6573 6060 0a20 2020 2020 2020 202d  ytes``.        -
+000048b0: 2060 6073 656c 662e 6d65 7472 6963 735b   ``self.metrics[
+000048c0: 226d 616e 6167 6564 5f62 7974 6573 225d  "managed_bytes"]
+000048d0: 6060 0a0a 2020 2020 2020 2020 4174 2072  ``..        At r
+000048e0: 6573 742c 2074 6865 2074 776f 206e 756d  est, the two num
+000048f0: 6265 7273 206d 7573 7420 6265 2069 6465  bers must be ide
+00004900: 6e74 6963 616c 2e20 486f 7765 7665 722c  ntical. However,
+00004910: 2060 6073 656c 662e 6e62 7974 6573 6060   ``self.nbytes``
+00004920: 2069 730a 2020 2020 2020 2020 696d 6d65   is.        imme
+00004930: 6469 6174 656c 7920 7570 6461 7465 6420  diately updated 
+00004940: 7468 726f 7567 6820 7468 6520 6261 7463  through the batc
+00004950: 6865 6420 636f 6d6d 7320 6173 2073 6f6f  hed comms as soo
+00004960: 6e20 6173 2065 6163 6820 7461 736b 206c  n as each task l
+00004970: 616e 6473 2069 6e0a 2020 2020 2020 2020  ands in.        
+00004980: 6d65 6d6f 7279 206f 6e20 7468 6520 776f  memory on the wo
+00004990: 726b 6572 3b20 6060 7365 6c66 2e6d 6574  rker; ``self.met
+000049a0: 7269 6373 5b22 6d61 6e61 6765 645f 6279  rics["managed_by
+000049b0: 7465 7322 5d60 6020 696e 7374 6561 6420  tes"]`` instead 
+000049c0: 6973 2075 7064 6174 6564 2062 790a 2020  is updated by.  
+000049d0: 2020 2020 2020 7468 6520 6865 6172 7462        the heartb
+000049e0: 6561 742c 2077 6869 6368 2063 616e 206c  eat, which can l
+000049f0: 6167 2073 6576 6572 616c 2073 6563 6f6e  ag several secon
+00004a00: 6473 2062 6568 696e 642e 0a0a 2020 2020  ds behind...    
+00004a10: 2020 2020 4265 6c6f 7720 7765 2061 7265      Below we are
+00004a20: 206d 6978 696e 6720 6c69 6b65 6c79 206e   mixing likely n
+00004a30: 6577 6572 206d 616e 6167 6564 206d 656d  ewer managed mem
+00004a40: 6f72 7920 696e 666f 2066 726f 6d20 6060  ory info from ``
+00004a50: 7365 6c66 2e6e 6279 7465 7360 6020 7769  self.nbytes`` wi
+00004a60: 7468 0a20 2020 2020 2020 2070 726f 6365  th.        proce
+00004a70: 7373 2061 6e64 2073 7069 6c6c 6564 206d  ss and spilled m
+00004a80: 656d 6f72 7920 6672 6f6d 2074 6865 2068  emory from the h
+00004a90: 6561 7274 6265 6174 2e20 5468 6973 2069  eartbeat. This i
+00004aa0: 7320 6465 6c69 6265 7261 7465 2c20 736f  s deliberate, so
+00004ab0: 2074 6861 740a 2020 2020 2020 2020 6d61   that.        ma
+00004ac0: 6e61 6765 6420 6d65 6d6f 7279 2074 6f74  naged memory tot
+00004ad0: 616c 2069 7320 7570 6461 7465 6420 6d6f  al is updated mo
+00004ae0: 7265 2066 7265 7175 656e 746c 792e 0a0a  re frequently...
+00004af0: 2020 2020 2020 2020 4d61 6e61 6765 6420          Managed 
+00004b00: 6d65 6d6f 7279 2064 6972 6563 746c 7920  memory directly 
+00004b10: 616e 6420 696d 6d65 6469 6174 656c 7920  and immediately 
+00004b20: 636f 6e74 7269 6275 7465 7320 746f 206f  contributes to o
+00004b30: 7074 696d 6973 7469 6320 6d65 6d6f 7279  ptimistic memory
+00004b40: 2c20 7768 6963 680a 2020 2020 2020 2020  , which.        
+00004b50: 6973 2069 6e20 7475 726e 2075 7365 6420  is in turn used 
+00004b60: 696e 2041 6374 6976 6520 4d65 6d6f 7279  in Active Memory
+00004b70: 204d 616e 6167 6572 2068 6575 7269 7374   Manager heurist
+00004b80: 6963 7320 2861 7420 7468 6520 6d6f 6d65  ics (at the mome
+00004b90: 6e74 206f 6620 7772 6974 696e 673b 0a20  nt of writing;. 
+00004ba0: 2020 2020 2020 206d 6f72 6520 7573 6573         more uses
+00004bb0: 2077 696c 6c20 6c69 6b65 6c79 2062 6520   will likely be 
+00004bc0: 6164 6465 6420 696e 2074 6865 2066 7574  added in the fut
+00004bd0: 7572 6529 2e20 536f 2069 7427 7320 696d  ure). So it's im
+00004be0: 706f 7274 616e 7420 746f 2068 6176 6520  portant to have 
+00004bf0: 6974 0a20 2020 2020 2020 2075 7020 746f  it.        up to
+00004c00: 2064 6174 653b 206d 7563 6820 6d6f 7265   date; much more
+00004c10: 2074 6861 6e20 6974 2069 7320 666f 7220   than it is for 
+00004c20: 7072 6f63 6573 7320 6d65 6d6f 7279 2e0a  process memory..
+00004c30: 0a20 2020 2020 2020 2048 6176 696e 6720  .        Having 
+00004c40: 7570 2d74 6f2d 6461 7465 206d 616e 6167  up-to-date manag
+00004c50: 6564 206d 656d 6f72 7920 696e 666f 2061  ed memory info a
+00004c60: 7320 736f 6f6e 2061 7320 7468 6520 7363  s soon as the sc
+00004c70: 6865 6475 6c65 7220 6c65 6172 6e73 2061  heduler learns a
+00004c80: 626f 7574 0a20 2020 2020 2020 2074 6173  bout.        tas
+00004c90: 6b20 636f 6d70 6c65 7469 6f6e 2061 6c73  k completion als
+00004ca0: 6f20 7375 6273 7461 6e74 6961 6c6c 7920  o substantially 
+00004cb0: 7369 6d70 6c69 6669 6573 2075 6e69 7420  simplifies unit 
+00004cc0: 7465 7374 732e 0a0a 2020 2020 2020 2020  tests...        
+00004cd0: 5468 6520 666c 6970 2073 6964 6520 6f66  The flip side of
+00004ce0: 2074 6869 7320 6465 7369 676e 2069 7320   this design is 
+00004cf0: 7468 6174 2069 7420 6d61 7920 6361 7573  that it may caus
+00004d00: 6520 736f 6d65 206e 6f69 7365 2069 6e20  e some noise in 
+00004d10: 7468 650a 2020 2020 2020 2020 756e 6d61  the.        unma
+00004d20: 6e61 6765 645f 7265 6365 6e74 206d 6561  naged_recent mea
+00004d30: 7375 7265 2e20 652e 672e 3a0a 0a20 2020  sure. e.g.:..   
+00004d40: 2020 2020 2031 2e20 4465 6c65 7465 2031       1. Delete 1
+00004d50: 3030 4d42 206f 6620 6d61 6e61 6765 6420  00MB of managed 
+00004d60: 6461 7461 0a20 2020 2020 2020 2032 2e20  data.        2. 
+00004d70: 5468 6520 7570 6461 7465 6420 6d61 6e61  The updated mana
+00004d80: 6765 6420 6d65 6d6f 7279 2072 6561 6368  ged memory reach
+00004d90: 6573 2074 6865 2073 6368 6564 756c 6572  es the scheduler
+00004da0: 2066 6173 7465 7220 7468 616e 2074 6865   faster than the
+00004db0: 0a20 2020 2020 2020 2020 2020 7570 6461  .           upda
+00004dc0: 7465 6420 7072 6f63 6573 7320 6d65 6d6f  ted process memo
+00004dd0: 7279 0a20 2020 2020 2020 2033 2e20 5468  ry.        3. Th
+00004de0: 6572 6527 7320 6120 626c 6970 2077 6865  ere's a blip whe
+00004df0: 7265 2074 6865 2073 6368 6564 756c 6572  re the scheduler
+00004e00: 2074 6869 6e6b 7320 7468 6174 2074 6865   thinks that the
+00004e10: 7265 2773 2061 2073 7564 6465 6e20 3130  re's a sudden 10
+00004e20: 304d 420a 2020 2020 2020 2020 2020 2069  0MB.           i
+00004e30: 6e63 7265 6173 6520 696e 2075 6e6d 616e  ncrease in unman
+00004e40: 6167 6564 5f72 6563 656e 742c 2073 696e  aged_recent, sin
+00004e50: 6365 2070 726f 6365 7373 206d 656d 6f72  ce process memor
+00004e60: 7920 6861 736e 2774 2063 6861 6e67 6564  y hasn't changed
+00004e70: 2062 7574 206d 616e 6167 6564 0a20 2020   but managed.   
+00004e80: 2020 2020 2020 2020 6d65 6d6f 7279 2068          memory h
+00004e90: 6173 2064 6563 7265 6173 6564 2062 7920  as decreased by 
+00004ea0: 3130 304d 420a 2020 2020 2020 2020 342e  100MB.        4.
+00004eb0: 2057 6865 6e20 7468 6520 6865 6172 7462   When the heartb
+00004ec0: 6561 7420 6172 7269 7665 732c 2070 726f  eat arrives, pro
+00004ed0: 6365 7373 206d 656d 6f72 7920 676f 6573  cess memory goes
+00004ee0: 2064 6f77 6e20 616e 6420 736f 2064 6f65   down and so doe
+00004ef0: 7320 7468 650a 2020 2020 2020 2020 2020  s the.          
+00004f00: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
+00004f10: 742e 0a0a 2020 2020 2020 2020 5468 6973  t...        This
+00004f20: 2069 7320 4f4b 202d 206f 6e65 206f 6620   is OK - one of 
+00004f30: 7468 6520 6d61 696e 2072 6561 736f 6e73  the main reasons
+00004f40: 2066 6f72 2074 6865 2075 6e6d 616e 6167   for the unmanag
+00004f50: 6564 5f72 6563 656e 7420 2f20 756e 6d61  ed_recent / unma
+00004f60: 6e61 6765 645f 6f6c 640a 2020 2020 2020  naged_old.      
+00004f70: 2020 7370 6c69 7420 6973 2065 7861 6374    split is exact
+00004f80: 6c79 2074 6f20 636f 6e63 656e 7472 6174  ly to concentrat
+00004f90: 6520 616c 6c20 7468 6520 6e6f 6973 6520  e all the noise 
+00004fa0: 696e 2075 6e6d 616e 6167 6564 5f72 6563  in unmanaged_rec
+00004fb0: 656e 7420 616e 6420 6578 636c 7564 6520  ent and exclude 
+00004fc0: 6974 0a20 2020 2020 2020 2066 726f 6d20  it.        from 
+00004fd0: 6f70 7469 6d69 7374 6963 206d 656d 6f72  optimistic memor
+00004fe0: 792c 2077 6869 6368 2069 7320 7573 6564  y, which is used
+00004ff0: 2066 6f72 2068 6575 7269 7374 6963 732e   for heuristics.
+00005000: 0a0a 2020 2020 2020 2020 536f 6d65 7468  ..        Someth
+00005010: 696e 6720 7468 6174 2069 7320 6c65 7373  ing that is less
+00005020: 204f 4b2c 2062 7574 2061 6c73 6f20 6c65   OK, but also le
+00005030: 7373 2066 7265 7175 656e 742c 2069 7320  ss frequent, is 
+00005040: 7468 6174 2074 6865 2073 7564 6465 6e20  that the sudden 
+00005050: 6465 6c65 7469 6f6e 0a20 2020 2020 2020  deletion.       
+00005060: 206f 6620 7370 696c 6c65 6420 6b65 7973   of spilled keys
+00005070: 2077 696c 6c20 6361 7573 6520 6120 6e65   will cause a ne
+00005080: 6761 7469 7665 2062 6c69 7020 696e 206d  gative blip in m
+00005090: 616e 6167 6564 206d 656d 6f72 793a 0a0a  anaged memory:..
+000050a0: 2020 2020 2020 2020 312e 2044 656c 6574          1. Delet
+000050b0: 6520 3130 304d 4220 6f66 2073 7069 6c6c  e 100MB of spill
+000050c0: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
+000050d0: 322e 2054 6865 2075 7064 6174 6564 206d  2. The updated m
+000050e0: 616e 6167 6564 206d 656d 6f72 7920 2a74  anaged memory *t
+000050f0: 6f74 616c 2a20 7265 6163 6865 7320 7468  otal* reaches th
+00005100: 6520 7363 6865 6475 6c65 7220 6661 7374  e scheduler fast
+00005110: 6572 2074 6861 6e20 7468 650a 2020 2020  er than the.    
+00005120: 2020 2020 2020 2075 7064 6174 6564 2073         updated s
+00005130: 7069 6c6c 6564 2070 6f72 7469 6f6e 0a20  pilled portion. 
+00005140: 2020 2020 2020 2033 2e20 5468 6973 2063         3. This c
+00005150: 6175 7365 7320 7468 6520 6d61 6e61 6765  auses the manage
+00005160: 6420 6d65 6d6f 7279 2074 6f20 7465 6d70  d memory to temp
+00005170: 6f72 6172 696c 7920 706c 756d 6d65 7420  orarily plummet 
+00005180: 616e 6420 6265 2072 6570 6c61 6365 6420  and be replaced 
+00005190: 6279 0a20 2020 2020 2020 2020 2020 756e  by.           un
+000051a0: 6d61 6e61 6765 645f 7265 6365 6e74 2c20  managed_recent, 
+000051b0: 7768 696c 6520 7370 696c 6c65 6420 6d65  while spilled me
+000051c0: 6d6f 7279 2072 656d 6169 6e73 2075 6e61  mory remains una
+000051d0: 6c74 6572 6564 0a20 2020 2020 2020 2034  ltered.        4
+000051e0: 2e20 5768 656e 2074 6865 2068 6561 7274  . When the heart
+000051f0: 6265 6174 2061 7272 6976 6573 2c20 6d61  beat arrives, ma
+00005200: 6e61 6765 6420 676f 6573 2062 6163 6b20  naged goes back 
+00005210: 7570 2c20 756e 6d61 6e61 6765 645f 7265  up, unmanaged_re
+00005220: 6365 6e74 0a20 2020 2020 2020 2020 2020  cent.           
+00005230: 676f 6573 2062 6163 6b20 646f 776e 2c20  goes back down, 
+00005240: 616e 6420 7370 696c 6c65 6420 676f 6573  and spilled goes
+00005250: 2064 6f77 6e20 6279 2031 3030 4d42 2061   down by 100MB a
+00005260: 7320 6974 2073 686f 756c 6420 6861 7665  s it should have
+00005270: 2074 6f0a 2020 2020 2020 2020 2020 2062   to.           b
+00005280: 6567 696e 2077 6974 682e 0a0a 2020 2020  egin with...    
+00005290: 2020 2020 3a69 7373 7565 3a60 3630 3032      :issue:`6002
+000052a0: 6020 7769 6c6c 206c 6574 2075 7320 736f  ` will let us so
+000052b0: 6c76 6520 7468 6973 2e0a 2020 2020 2020  lve this..      
+000052c0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+000052d0: 7475 726e 204d 656d 6f72 7953 7461 7465  turn MemoryState
+000052e0: 280a 2020 2020 2020 2020 2020 2020 7072  (.            pr
+000052f0: 6f63 6573 733d 7365 6c66 2e6d 6574 7269  ocess=self.metri
+00005300: 6373 5b22 6d65 6d6f 7279 225d 2c0a 2020  cs["memory"],.  
+00005310: 2020 2020 2020 2020 2020 6d61 6e61 6765            manage
+00005320: 643d 6d61 7828 302c 2073 656c 662e 6e62  d=max(0, self.nb
+00005330: 7974 6573 202d 2073 656c 662e 6d65 7472  ytes - self.metr
+00005340: 6963 735b 2273 7069 6c6c 6564 5f62 7974  ics["spilled_byt
+00005350: 6573 225d 5b22 6d65 6d6f 7279 225d 292c  es"]["memory"]),
+00005360: 0a20 2020 2020 2020 2020 2020 2073 7069  .            spi
+00005370: 6c6c 6564 3d73 656c 662e 6d65 7472 6963  lled=self.metric
+00005380: 735b 2273 7069 6c6c 6564 5f62 7974 6573  s["spilled_bytes
+00005390: 225d 5b22 6469 736b 225d 2c0a 2020 2020  "]["disk"],.    
+000053a0: 2020 2020 2020 2020 756e 6d61 6e61 6765          unmanage
+000053b0: 645f 6f6c 643d 7365 6c66 2e5f 6d65 6d6f  d_old=self._memo
+000053c0: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
+000053d0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+000053e0: 2064 6566 2063 6c65 616e 2873 656c 6629   def clean(self)
+000053f0: 202d 3e20 576f 726b 6572 5374 6174 653a   -> WorkerState:
+00005400: 0a20 2020 2020 2020 2022 2222 5265 7475  .        """Retu
+00005410: 726e 2061 2076 6572 7369 6f6e 206f 6620  rn a version of 
+00005420: 7468 6973 206f 626a 6563 7420 7468 6174  this object that
+00005430: 2069 7320 6170 7072 6f70 7269 6174 6520   is appropriate 
+00005440: 666f 7220 7365 7269 616c 697a 6174 696f  for serializatio
+00005450: 6e22 2222 0a20 2020 2020 2020 2077 7320  n""".        ws 
+00005460: 3d20 576f 726b 6572 5374 6174 6528 0a20  = WorkerState(. 
+00005470: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+00005480: 7373 3d73 656c 662e 6164 6472 6573 732c  ss=self.address,
+00005490: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+000054a0: 7475 733d 7365 6c66 2e73 7461 7475 732c  tus=self.status,
+000054b0: 0a20 2020 2020 2020 2020 2020 2070 6964  .            pid
+000054c0: 3d73 656c 662e 7069 642c 0a20 2020 2020  =self.pid,.     
+000054d0: 2020 2020 2020 206e 616d 653d 7365 6c66         name=self
+000054e0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+000054f0: 2020 206e 7468 7265 6164 733d 7365 6c66     nthreads=self
+00005500: 2e6e 7468 7265 6164 732c 0a20 2020 2020  .nthreads,.     
+00005510: 2020 2020 2020 206d 656d 6f72 795f 6c69         memory_li
+00005520: 6d69 743d 7365 6c66 2e6d 656d 6f72 795f  mit=self.memory_
+00005530: 6c69 6d69 742c 0a20 2020 2020 2020 2020  limit,.         
+00005540: 2020 206c 6f63 616c 5f64 6972 6563 746f     local_directo
+00005550: 7279 3d73 656c 662e 6c6f 6361 6c5f 6469  ry=self.local_di
+00005560: 7265 6374 6f72 792c 0a20 2020 2020 2020  rectory,.       
+00005570: 2020 2020 2073 6572 7669 6365 733d 7365       services=se
+00005580: 6c66 2e73 6572 7669 6365 732c 0a20 2020  lf.services,.   
+00005590: 2020 2020 2020 2020 206e 616e 6e79 3d73           nanny=s
+000055a0: 656c 662e 6e61 6e6e 792c 0a20 2020 2020  elf.nanny,.     
+000055b0: 2020 2020 2020 2065 7874 7261 3d73 656c         extra=sel
+000055c0: 662e 6578 7472 612c 0a20 2020 2020 2020  f.extra,.       
+000055d0: 2020 2020 2073 6572 7665 725f 6964 3d73       server_id=s
+000055e0: 656c 662e 7365 7276 6572 5f69 642c 0a20  elf.server_id,. 
+000055f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00005600: 2077 732e 5f6f 6363 7570 616e 6379 5f63   ws._occupancy_c
+00005610: 6163 6865 203d 2073 656c 662e 6f63 6375  ache = self.occu
+00005620: 7061 6e63 790a 0a20 2020 2020 2020 2077  pancy..        w
+00005630: 732e 6578 6563 7574 696e 6720 3d20 7b0a  s.executing = {.
+00005640: 2020 2020 2020 2020 2020 2020 7473 2e6b              ts.k
+00005650: 6579 3a20 6475 7261 7469 6f6e 2066 6f72  ey: duration for
+00005660: 2074 732c 2064 7572 6174 696f 6e20 696e   ts, duration in
+00005670: 2073 656c 662e 6578 6563 7574 696e 672e   self.executing.
+00005680: 6974 656d 7328 2920 2023 2074 7970 653a  items()  # type:
+00005690: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+000056a0: 7d0a 2020 2020 2020 2020 7265 7475 726e  }.        return
+000056b0: 2077 730a 0a20 2020 2064 6566 205f 5f72   ws..    def __r
+000056c0: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
+000056d0: 7472 3a0a 2020 2020 2020 2020 6e61 6d65  tr:.        name
+000056e0: 203d 2066 222c 206e 616d 653a 207b 7365   = f", name: {se
+000056f0: 6c66 2e6e 616d 657d 2220 6966 2073 656c  lf.name}" if sel
+00005700: 662e 6e61 6d65 2021 3d20 7365 6c66 2e61  f.name != self.a
+00005710: 6464 7265 7373 2065 6c73 6520 2222 0a20  ddress else "". 
+00005720: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
+00005730: 2020 2020 2020 2020 2020 2020 6622 3c57              f"<W
+00005740: 6f72 6b65 7253 7461 7465 207b 7365 6c66  orkerState {self
+00005750: 2e61 6464 7265 7373 2172 7d7b 6e61 6d65  .address!r}{name
+00005760: 7d2c 2022 0a20 2020 2020 2020 2020 2020  }, ".           
+00005770: 2066 2273 7461 7475 733a 207b 7365 6c66   f"status: {self
+00005780: 2e73 7461 7475 732e 6e61 6d65 7d2c 2022  .status.name}, "
+00005790: 0a20 2020 2020 2020 2020 2020 2066 226d  .            f"m
+000057a0: 656d 6f72 793a 207b 6c65 6e28 7365 6c66  emory: {len(self
+000057b0: 2e68 6173 5f77 6861 7429 7d2c 2022 0a20  .has_what)}, ". 
+000057c0: 2020 2020 2020 2020 2020 2066 2270 726f             f"pro
+000057d0: 6365 7373 696e 673a 207b 6c65 6e28 7365  cessing: {len(se
+000057e0: 6c66 2e70 726f 6365 7373 696e 6729 7d3e  lf.processing)}>
+000057f0: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
+00005800: 2064 6566 205f 7265 7072 5f68 746d 6c5f   def _repr_html_
+00005810: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+00005820: 2020 2020 2020 2072 6574 7572 6e20 6765         return ge
+00005830: 745f 7465 6d70 6c61 7465 2822 776f 726b  t_template("work
+00005840: 6572 5f73 7461 7465 2e68 746d 6c2e 6a32  er_state.html.j2
+00005850: 2229 2e72 656e 6465 7228 0a20 2020 2020  ").render(.     
+00005860: 2020 2020 2020 2061 6464 7265 7373 3d73         address=s
+00005870: 656c 662e 6164 6472 6573 732c 0a20 2020  elf.address,.   
+00005880: 2020 2020 2020 2020 206e 616d 653d 7365           name=se
+00005890: 6c66 2e6e 616d 652c 0a20 2020 2020 2020  lf.name,.       
+000058a0: 2020 2020 2073 7461 7475 733d 7365 6c66       status=self
+000058b0: 2e73 7461 7475 732e 6e61 6d65 2c0a 2020  .status.name,.  
+000058c0: 2020 2020 2020 2020 2020 6861 735f 7768            has_wh
+000058d0: 6174 3d73 656c 662e 6861 735f 7768 6174  at=self.has_what
+000058e0: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+000058f0: 6f63 6573 7369 6e67 3d73 656c 662e 7072  ocessing=self.pr
+00005900: 6f63 6573 7369 6e67 2c0a 2020 2020 2020  ocessing,.      
+00005910: 2020 290a 0a20 2020 2064 6566 2069 6465    )..    def ide
+00005920: 6e74 6974 7928 7365 6c66 2920 2d3e 2064  ntity(self) -> d
+00005930: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+00005940: 2020 2020 2020 2072 6574 7572 6e20 7b0a         return {.
+00005950: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
+00005960: 6522 3a20 2257 6f72 6b65 7222 2c0a 2020  e": "Worker",.  
+00005970: 2020 2020 2020 2020 2020 2269 6422 3a20            "id": 
+00005980: 7365 6c66 2e6e 616d 652c 0a20 2020 2020  self.name,.     
+00005990: 2020 2020 2020 2022 686f 7374 223a 2073         "host": s
+000059a0: 656c 662e 686f 7374 2c0a 2020 2020 2020  elf.host,.      
+000059b0: 2020 2020 2020 2272 6573 6f75 7263 6573        "resources
+000059c0: 223a 2073 656c 662e 7265 736f 7572 6365  ": self.resource
+000059d0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+000059e0: 6c6f 6361 6c5f 6469 7265 6374 6f72 7922  local_directory"
+000059f0: 3a20 7365 6c66 2e6c 6f63 616c 5f64 6972  : self.local_dir
+00005a00: 6563 746f 7279 2c0a 2020 2020 2020 2020  ectory,.        
+00005a10: 2020 2020 226e 616d 6522 3a20 7365 6c66      "name": self
+00005a20: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+00005a30: 2020 2022 6e74 6872 6561 6473 223a 2073     "nthreads": s
+00005a40: 656c 662e 6e74 6872 6561 6473 2c0a 2020  elf.nthreads,.  
+00005a50: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00005a60: 795f 6c69 6d69 7422 3a20 7365 6c66 2e6d  y_limit": self.m
+00005a70: 656d 6f72 795f 6c69 6d69 742c 0a20 2020  emory_limit,.   
+00005a80: 2020 2020 2020 2020 2022 6c61 7374 5f73           "last_s
+00005a90: 6565 6e22 3a20 7365 6c66 2e6c 6173 745f  een": self.last_
+00005aa0: 7365 656e 2c0a 2020 2020 2020 2020 2020  seen,.          
+00005ab0: 2020 2273 6572 7669 6365 7322 3a20 7365    "services": se
+00005ac0: 6c66 2e73 6572 7669 6365 732c 0a20 2020  lf.services,.   
+00005ad0: 2020 2020 2020 2020 2022 6d65 7472 6963           "metric
+00005ae0: 7322 3a20 7365 6c66 2e6d 6574 7269 6373  s": self.metrics
+00005af0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+00005b00: 7461 7475 7322 3a20 7365 6c66 2e73 7461  tatus": self.sta
+00005b10: 7475 732e 6e61 6d65 2c0a 2020 2020 2020  tus.name,.      
+00005b20: 2020 2020 2020 226e 616e 6e79 223a 2073        "nanny": s
+00005b30: 656c 662e 6e61 6e6e 792c 0a20 2020 2020  elf.nanny,.     
+00005b40: 2020 2020 2020 202a 2a73 656c 662e 6578         **self.ex
+00005b50: 7472 612c 0a20 2020 2020 2020 207d 0a0a  tra,.        }..
+00005b60: 2020 2020 6465 6620 5f74 6f5f 6469 6374      def _to_dict
+00005b70: 5f6e 6f5f 6e65 7374 2873 656c 662c 202a  _no_nest(self, *
+00005b80: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
+00005b90: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
+00005ba0: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
+00005bb0: 5d3a 0a20 2020 2020 2020 2022 2222 4469  ]:.        """Di
+00005bc0: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
+00005bd0: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
+00005be0: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
+00005bf0: 2020 2020 2020 2020 4e6f 7420 7479 7065          Not type
+00005c00: 2073 7461 626c 6520 616e 6420 6e6f 7420   stable and not 
+00005c10: 696e 7465 6e64 6564 2066 6f72 2072 6f75  intended for rou
+00005c20: 6e64 7472 6970 732e 0a0a 2020 2020 2020  ndtrips...      
+00005c30: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+00005c40: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00005c50: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
+00005c60: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
+00005c70: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
+00005c80: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
+00005c90: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
+00005ca0: 2020 5461 736b 5374 6174 652e 5f74 6f5f    TaskState._to_
+00005cb0: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
+00005cc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00005cd0: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
+00005ce0: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
+00005cf0: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
+00005d00: 2065 7863 6c75 6465 3d73 6574 2865 7863   exclude=set(exc
+00005d10: 6c75 6465 2920 7c20 7b22 7665 7273 696f  lude) | {"versio
+00005d20: 6e73 227d 2c20 2023 2074 7970 653a 2069  ns"},  # type: i
+00005d30: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
+00005d40: 2020 6d65 6d62 6572 733d 5472 7565 2c0a    members=True,.
+00005d50: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+00005d60: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00005d70: 2073 6368 6564 756c 6572 2873 656c 6629   scheduler(self)
+00005d80: 202d 3e20 5363 6865 6475 6c65 7253 7461   -> SchedulerSta
+00005d90: 7465 3a0a 2020 2020 2020 2020 6173 7365  te:.        asse
+00005da0: 7274 2073 656c 662e 7363 6865 6475 6c65  rt self.schedule
+00005db0: 725f 7265 660a 2020 2020 2020 2020 7320  r_ref.        s 
+00005dc0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+00005dd0: 5f72 6566 2829 0a20 2020 2020 2020 2061  _ref().        a
+00005de0: 7373 6572 7420 730a 2020 2020 2020 2020  ssert s.        
+00005df0: 7265 7475 726e 2073 0a0a 2020 2020 6465  return s..    de
+00005e00: 6620 6164 645f 746f 5f70 726f 6365 7373  f add_to_process
+00005e10: 696e 6728 7365 6c66 2c20 7473 3a20 5461  ing(self, ts: Ta
+00005e20: 736b 5374 6174 6529 202d 3e20 4e6f 6e65  skState) -> None
+00005e30: 3a0a 2020 2020 2020 2020 2222 2241 7373  :.        """Ass
+00005e40: 6967 6e20 6120 7461 736b 2074 6f20 7468  ign a task to th
+00005e50: 6973 2077 6f72 6b65 7220 666f 7220 636f  is worker for co
+00005e60: 6d70 7574 652e 2222 220a 2020 2020 2020  mpute.""".      
+00005e70: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
+00005e80: 6c65 722e 7661 6c69 6461 7465 3a0a 2020  ler.validate:.  
+00005e90: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00005ea0: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
+00005eb0: 7072 6f63 6573 7369 6e67 0a0a 2020 2020  processing..    
+00005ec0: 2020 2020 7470 203d 2074 732e 7072 6566      tp = ts.pref
+00005ed0: 6978 0a20 2020 2020 2020 2073 656c 662e  ix.        self.
+00005ee0: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
+00005ef0: 745b 7470 2e6e 616d 655d 202b 3d20 310a  t[tp.name] += 1.
+00005f00: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+00005f10: 6564 756c 6572 2e5f 7461 736b 5f70 7265  eduler._task_pre
+00005f20: 6669 785f 636f 756e 745f 676c 6f62 616c  fix_count_global
+00005f30: 5b74 702e 6e61 6d65 5d20 2b3d 2031 0a20  [tp.name] += 1. 
+00005f40: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
+00005f50: 6573 7369 6e67 2e61 6464 2874 7329 0a20  essing.add(ts). 
+00005f60: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
+00005f70: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+00005f80: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+00005f90: 6620 7365 6c66 206e 6f74 2069 6e20 6474  f self not in dt
+00005fa0: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
+00005fb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00005fc0: 5f69 6e63 5f6e 6565 6473 5f72 6570 6c69  _inc_needs_repli
+00005fd0: 6361 2864 7473 290a 0a20 2020 2064 6566  ca(dts)..    def
+00005fe0: 2061 6464 5f74 6f5f 6c6f 6e67 5f72 756e   add_to_long_run
+00005ff0: 6e69 6e67 2873 656c 662c 2074 733a 2054  ning(self, ts: T
+00006000: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+00006010: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
+00006020: 6c66 2e73 6368 6564 756c 6572 2e76 616c  lf.scheduler.val
+00006030: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+00006040: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+00006050: 7365 6c66 2e70 726f 6365 7373 696e 670a  self.processing.
+00006060: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00006070: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
+00006080: 662e 6c6f 6e67 5f72 756e 6e69 6e67 0a0a  f.long_running..
+00006090: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
+000060a0: 6d6f 7665 5f66 726f 6d5f 7461 736b 5f70  move_from_task_p
+000060b0: 7265 6669 785f 636f 756e 7428 7473 290a  refix_count(ts).
+000060c0: 2020 2020 2020 2020 2320 4361 6e6e 6f74          # Cannot
+000060d0: 2072 656d 6f76 6520 6672 6f6d 2070 726f   remove from pro
+000060e0: 6365 7373 696e 6720 7369 6e63 6520 7765  cessing since we
+000060f0: 2772 6520 7573 696e 6720 7468 6973 2066  're using this f
+00006100: 6f72 2074 6869 6e67 7320 6c69 6b65 0a20  or things like. 
+00006110: 2020 2020 2020 2023 2069 646c 656e 6573         # idlenes
+00006120: 7320 6465 7465 6374 696f 6e2e 2049 646c  s detection. Idl
+00006130: 6520 776f 726b 6572 7320 6172 6520 7479  e workers are ty
+00006140: 7069 6361 6c6c 7920 7461 7267 6574 6564  pically targeted
+00006150: 2066 6f72 0a20 2020 2020 2020 2023 2064   for.        # d
+00006160: 6f77 6e73 6361 6c69 6e67 2062 7574 2077  ownscaling but w
+00006170: 6520 7368 6f75 6c64 206e 6f74 2064 6f77  e should not dow
+00006180: 6e73 6361 6c65 2077 6f72 6b65 7273 2077  nscale workers w
+00006190: 6974 6820 6c6f 6e67 2072 756e 6e69 6e67  ith long running
+000061a0: 0a20 2020 2020 2020 2023 2074 6173 6b73  .        # tasks
+000061b0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+000061c0: 6e67 5f72 756e 6e69 6e67 2e61 6464 2874  ng_running.add(t
+000061d0: 7329 0a0a 2020 2020 6465 6620 7265 6d6f  s)..    def remo
+000061e0: 7665 5f66 726f 6d5f 7072 6f63 6573 7369  ve_from_processi
+000061f0: 6e67 2873 656c 662c 2074 733a 2054 6173  ng(self, ts: Tas
+00006200: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
+00006210: 0a20 2020 2020 2020 2022 2222 5265 6d6f  .        """Remo
+00006220: 7665 2061 2074 6173 6b20 6672 6f6d 2061  ve a task from a
+00006230: 2077 6f72 6b65 7273 2070 726f 6365 7373   workers process
+00006240: 696e 6722 2222 0a20 2020 2020 2020 2069  ing""".        i
+00006250: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
+00006260: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00006270: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00006280: 2069 6e20 7365 6c66 2e70 726f 6365 7373   in self.process
+00006290: 696e 670a 0a20 2020 2020 2020 2069 6620  ing..        if 
+000062a0: 7473 2069 6e20 7365 6c66 2e6c 6f6e 675f  ts in self.long_
+000062b0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+000062c0: 2020 2020 2073 656c 662e 6c6f 6e67 5f72       self.long_r
+000062d0: 756e 6e69 6e67 2e64 6973 6361 7264 2874  unning.discard(t
+000062e0: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
+000062f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006300: 662e 5f72 656d 6f76 655f 6672 6f6d 5f74  f._remove_from_t
+00006310: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+00006320: 2874 7329 0a20 2020 2020 2020 2073 656c  (ts).        sel
+00006330: 662e 7072 6f63 6573 7369 6e67 2e72 656d  f.processing.rem
+00006340: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
+00006350: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+00006360: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+00006370: 2020 2020 2020 2020 6966 2064 7473 2069          if dts i
+00006380: 6e20 7365 6c66 2e6e 6565 6473 5f77 6861  n self.needs_wha
+00006390: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000063a0: 2020 2073 656c 662e 5f64 6563 5f6e 6565     self._dec_nee
+000063b0: 6473 5f72 6570 6c69 6361 2864 7473 290a  ds_replica(dts).
+000063c0: 0a20 2020 2064 6566 205f 7265 6d6f 7665  .    def _remove
+000063d0: 5f66 726f 6d5f 7461 736b 5f70 7265 6669  _from_task_prefi
+000063e0: 785f 636f 756e 7428 7365 6c66 2c20 7473  x_count(self, ts
+000063f0: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+00006400: 4e6f 6e65 3a0a 2020 2020 2020 2020 636f  None:.        co
+00006410: 756e 7420 3d20 7365 6c66 2e74 6173 6b5f  unt = self.task_
+00006420: 7072 6566 6978 5f63 6f75 6e74 5b74 732e  prefix_count[ts.
+00006430: 7072 6566 6978 2e6e 616d 655d 202d 2031  prefix.name] - 1
+00006440: 0a20 2020 2020 2020 2069 6620 636f 756e  .        if coun
+00006450: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+00006460: 656c 662e 7461 736b 5f70 7265 6669 785f  elf.task_prefix_
+00006470: 636f 756e 745b 7473 2e70 7265 6669 782e  count[ts.prefix.
+00006480: 6e61 6d65 5d20 3d20 636f 756e 740a 2020  name] = count.  
+00006490: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000064a0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+000064b0: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
+000064c0: 6e74 5b74 732e 7072 6566 6978 2e6e 616d  nt[ts.prefix.nam
+000064d0: 655d 0a0a 2020 2020 2020 2020 636f 756e  e]..        coun
+000064e0: 7420 3d20 7365 6c66 2e73 6368 6564 756c  t = self.schedul
+000064f0: 6572 2e5f 7461 736b 5f70 7265 6669 785f  er._task_prefix_
+00006500: 636f 756e 745f 676c 6f62 616c 5b74 732e  count_global[ts.
+00006510: 7072 6566 6978 2e6e 616d 655d 202d 2031  prefix.name] - 1
+00006520: 0a20 2020 2020 2020 2069 6620 636f 756e  .        if coun
+00006530: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+00006540: 656c 662e 7363 6865 6475 6c65 722e 5f74  elf.scheduler._t
+00006550: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+00006560: 5f67 6c6f 6261 6c5b 7473 2e70 7265 6669  _global[ts.prefi
+00006570: 782e 6e61 6d65 5d20 3d20 636f 756e 740a  x.name] = count.
+00006580: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00006590: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
+000065a0: 6c66 2e73 6368 6564 756c 6572 2e5f 7461  lf.scheduler._ta
+000065b0: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
+000065c0: 676c 6f62 616c 5b74 732e 7072 6566 6978  global[ts.prefix
+000065d0: 2e6e 616d 655d 0a0a 2020 2020 6465 6620  .name]..    def 
+000065e0: 7265 6d6f 7665 5f72 6570 6c69 6361 2873  remove_replica(s
+000065f0: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+00006600: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
+00006610: 2020 2020 2022 2222 5468 6520 776f 726b       """The work
+00006620: 6572 206e 6f20 6c6f 6e67 6572 2068 6173  er no longer has
+00006630: 2061 2074 6173 6b20 696e 206d 656d 6f72   a task in memor
+00006640: 7922 2222 0a20 2020 2020 2020 2069 6620  y""".        if 
+00006650: 7365 6c66 2e73 6368 6564 756c 6572 2e76  self.scheduler.v
+00006660: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00006670: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+00006680: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
+00006690: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000066a0: 7420 7473 2069 6e20 7365 6c66 2e68 6173  t ts in self.has
+000066b0: 5f77 6861 740a 2020 2020 2020 2020 2020  _what.          
+000066c0: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+000066d0: 696e 2073 656c 662e 6e65 6564 735f 7768  in self.needs_wh
+000066e0: 6174 0a0a 2020 2020 2020 2020 7365 6c66  at..        self
+000066f0: 2e6e 6279 7465 7320 2d3d 2074 732e 6765  .nbytes -= ts.ge
+00006700: 745f 6e62 7974 6573 2829 0a20 2020 2020  t_nbytes().     
+00006710: 2020 2064 656c 2073 656c 662e 5f68 6173     del self._has
+00006720: 5f77 6861 745b 7473 5d0a 2020 2020 2020  _what[ts].      
+00006730: 2020 7473 2e77 686f 5f68 6173 2e72 656d    ts.who_has.rem
+00006740: 6f76 6528 7365 6c66 290a 0a20 2020 2064  ove(self)..    d
+00006750: 6566 205f 696e 635f 6e65 6564 735f 7265  ef _inc_needs_re
+00006760: 706c 6963 6128 7365 6c66 2c20 7473 3a20  plica(self, ts: 
+00006770: 5461 736b 5374 6174 6529 202d 3e20 4e6f  TaskState) -> No
+00006780: 6e65 3a0a 2020 2020 2020 2020 2222 2241  ne:.        """A
+00006790: 7373 6967 6e20 6120 7461 736b 2066 6574  ssign a task fet
+000067a0: 6368 2074 6f20 7468 6973 2077 6f72 6b65  ch to this worke
+000067b0: 7220 616e 6420 7570 6461 7465 206e 6574  r and update net
+000067c0: 776f 726b 206f 6363 7570 616e 6369 6573  work occupancies
+000067d0: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+000067e0: 656c 662e 7363 6865 6475 6c65 722e 7661  elf.scheduler.va
+000067f0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+00006800: 2020 2020 6173 7365 7274 2073 656c 6620      assert self 
+00006810: 6e6f 7420 696e 2074 732e 7768 6f5f 6861  not in ts.who_ha
+00006820: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00006830: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+00006840: 656c 662e 6861 735f 7768 6174 0a20 2020  elf.has_what.   
+00006850: 2020 2020 2069 6620 7473 206e 6f74 2069       if ts not i
+00006860: 6e20 7365 6c66 2e6e 6565 6473 5f77 6861  n self.needs_wha
+00006870: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+00006880: 656c 662e 6e65 6564 735f 7768 6174 5b74  elf.needs_what[t
+00006890: 735d 203d 2031 0a20 2020 2020 2020 2020  s] = 1.         
+000068a0: 2020 206e 6279 7465 7320 3d20 7473 2e67     nbytes = ts.g
+000068b0: 6574 5f6e 6279 7465 7328 290a 2020 2020  et_nbytes().    
+000068c0: 2020 2020 2020 2020 7365 6c66 2e5f 6e65          self._ne
+000068d0: 7477 6f72 6b5f 6f63 6320 2b3d 206e 6279  twork_occ += nby
+000068e0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+000068f0: 7365 6c66 2e73 6368 6564 756c 6572 2e5f  self.scheduler._
+00006900: 6e65 7477 6f72 6b5f 6f63 635f 676c 6f62  network_occ_glob
+00006910: 616c 202b 3d20 6e62 7974 6573 0a20 2020  al += nbytes.   
+00006920: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00006930: 2020 2020 2020 2073 656c 662e 6e65 6564         self.need
+00006940: 735f 7768 6174 5b74 735d 202b 3d20 310a  s_what[ts] += 1.
+00006950: 0a20 2020 2064 6566 205f 6465 635f 6e65  .    def _dec_ne
+00006960: 6564 735f 7265 706c 6963 6128 7365 6c66  eds_replica(self
+00006970: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+00006980: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00006990: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
+000069a0: 6c65 722e 7661 6c69 6461 7465 3a0a 2020  ler.validate:.  
+000069b0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000069c0: 2074 7320 696e 2073 656c 662e 6e65 6564   ts in self.need
+000069d0: 735f 7768 6174 0a0a 2020 2020 2020 2020  s_what..        
+000069e0: 7365 6c66 2e6e 6565 6473 5f77 6861 745b  self.needs_what[
+000069f0: 7473 5d20 2d3d 2031 0a20 2020 2020 2020  ts] -= 1.       
+00006a00: 2069 6620 7365 6c66 2e6e 6565 6473 5f77   if self.needs_w
+00006a10: 6861 745b 7473 5d20 3d3d 2030 3a0a 2020  hat[ts] == 0:.  
+00006a20: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
+00006a30: 6c66 2e6e 6565 6473 5f77 6861 745b 7473  lf.needs_what[ts
+00006a40: 5d0a 2020 2020 2020 2020 2020 2020 6e62  ].            nb
+00006a50: 7974 6573 203d 2074 732e 6765 745f 6e62  ytes = ts.get_nb
+00006a60: 7974 6573 2829 0a20 2020 2020 2020 2020  ytes().         
+00006a70: 2020 2073 656c 662e 5f6e 6574 776f 726b     self._network
+00006a80: 5f6f 6363 202d 3d20 6e62 7974 6573 0a20  _occ -= nbytes. 
+00006a90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00006aa0: 7363 6865 6475 6c65 722e 5f6e 6574 776f  scheduler._netwo
+00006ab0: 726b 5f6f 6363 5f67 6c6f 6261 6c20 2d3d  rk_occ_global -=
+00006ac0: 206e 6279 7465 730a 0a20 2020 2064 6566   nbytes..    def
+00006ad0: 2061 6464 5f72 6570 6c69 6361 2873 656c   add_replica(sel
+00006ae0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+00006af0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00006b00: 2020 2022 2222 5468 6520 776f 726b 6572     """The worker
+00006b10: 2061 6371 7569 7265 6420 6120 7265 706c   acquired a repl
+00006b20: 6963 6120 6f66 2074 6173 6b22 2222 0a20  ica of task""". 
+00006b30: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00006b40: 6368 6564 756c 6572 2e76 616c 6964 6174  cheduler.validat
+00006b50: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00006b60: 7373 6572 7420 7365 6c66 206e 6f74 2069  ssert self not i
+00006b70: 6e20 7473 2e77 686f 5f68 6173 0a20 2020  n ts.who_has.   
+00006b80: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00006b90: 7473 206e 6f74 2069 6e20 7365 6c66 2e68  ts not in self.h
+00006ba0: 6173 5f77 6861 740a 0a20 2020 2020 2020  as_what..       
+00006bb0: 206e 6279 7465 7320 3d20 7473 2e67 6574   nbytes = ts.get
+00006bc0: 5f6e 6279 7465 7328 290a 2020 2020 2020  _nbytes().      
+00006bd0: 2020 6966 2074 7320 696e 2073 656c 662e    if ts in self.
+00006be0: 6e65 6564 735f 7768 6174 3a0a 2020 2020  needs_what:.    
+00006bf0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+00006c00: 2e6e 6565 6473 5f77 6861 745b 7473 5d0a  .needs_what[ts].
+00006c10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006c20: 2e5f 6e65 7477 6f72 6b5f 6f63 6320 2d3d  ._network_occ -=
+00006c30: 206e 6279 7465 730a 2020 2020 2020 2020   nbytes.        
+00006c40: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
+00006c50: 6572 2e5f 6e65 7477 6f72 6b5f 6f63 635f  er._network_occ_
+00006c60: 676c 6f62 616c 202d 3d20 6e62 7974 6573  global -= nbytes
+00006c70: 0a20 2020 2020 2020 2074 732e 7768 6f5f  .        ts.who_
+00006c80: 6861 732e 6164 6428 7365 6c66 290a 2020  has.add(self).  
+00006c90: 2020 2020 2020 7365 6c66 2e6e 6279 7465        self.nbyte
+00006ca0: 7320 2b3d 206e 6279 7465 730a 2020 2020  s += nbytes.    
+00006cb0: 2020 2020 7365 6c66 2e5f 6861 735f 7768      self._has_wh
+00006cc0: 6174 5b74 735d 203d 204e 6f6e 650a 0a20  at[ts] = None.. 
+00006cd0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00006ce0: 2064 6566 206f 6363 7570 616e 6379 2873   def occupancy(s
+00006cf0: 656c 6629 202d 3e20 666c 6f61 743a 0a20  elf) -> float:. 
+00006d00: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00006d10: 6c66 2e5f 6f63 6375 7061 6e63 795f 6361  lf._occupancy_ca
+00006d20: 6368 6520 6f72 2073 656c 662e 7363 6865  che or self.sche
+00006d30: 6475 6c65 722e 5f63 616c 635f 6f63 6375  duler._calc_occu
+00006d40: 7061 6e63 7928 0a20 2020 2020 2020 2020  pancy(.         
+00006d50: 2020 2073 656c 662e 7461 736b 5f70 7265     self.task_pre
+00006d60: 6669 785f 636f 756e 742c 2073 656c 662e  fix_count, self.
+00006d70: 5f6e 6574 776f 726b 5f6f 6363 0a20 2020  _network_occ.   
+00006d80: 2020 2020 2029 0a0a 0a40 6461 7461 636c       )...@datacl
+00006d90: 6173 7365 732e 6461 7461 636c 6173 730a  asses.dataclass.
+00006da0: 636c 6173 7320 4572 7265 6454 6173 6b3a  class ErredTask:
+00006db0: 0a20 2020 2022 2222 4c69 6768 7477 6569  .    """Lightwei
+00006dc0: 6768 7420 7265 7072 6573 656e 7461 7469  ght representati
+00006dd0: 6f6e 206f 6620 616e 2065 7272 6564 2074  on of an erred t
+00006de0: 6173 6b20 7769 7468 6f75 7420 616e 7920  ask without any 
+00006df0: 6465 7065 6e64 656e 6379 2069 6e66 6f72  dependency infor
+00006e00: 6d61 7469 6f6e 0a20 2020 206f 7220 7275  mation.    or ru
+00006e10: 6e73 7065 632e 0a0a 2020 2020 5365 6520  nspec...    See 
+00006e20: 616c 736f 0a20 2020 202d 2d2d 2d2d 2d2d  also.    -------
+00006e30: 2d0a 2020 2020 5461 736b 5374 6174 650a  -.    TaskState.
+00006e40: 2020 2020 2222 220a 0a20 2020 206b 6579      """..    key
+00006e50: 3a20 4861 7368 6162 6c65 0a20 2020 2074  : Hashable.    t
+00006e60: 696d 6573 7461 6d70 3a20 666c 6f61 740a  imestamp: float.
+00006e70: 2020 2020 6572 7265 645f 6f6e 3a20 7365      erred_on: se
+00006e80: 745b 7374 725d 0a20 2020 2065 7863 6570  t[str].    excep
+00006e90: 7469 6f6e 5f74 6578 743a 2073 7472 0a20  tion_text: str. 
+00006ea0: 2020 2074 7261 6365 6261 636b 5f74 6578     traceback_tex
+00006eb0: 743a 2073 7472 0a0a 0a63 6c61 7373 2043  t: str...class C
+00006ec0: 6f6d 7075 7461 7469 6f6e 3a0a 2020 2020  omputation:.    
+00006ed0: 2222 2243 6f6c 6c65 6374 696f 6e20 7472  """Collection tr
+00006ee0: 6163 6b69 6e67 2061 2073 696e 676c 6520  acking a single 
+00006ef0: 636f 6d70 7574 6520 6f72 2070 6572 7369  compute or persi
+00006f00: 7374 2063 616c 6c0a 0a20 2020 2053 6565  st call..    See
+00006f10: 2061 6c73 6f0a 2020 2020 2d2d 2d2d 2d2d   also.    ------
+00006f20: 2d2d 0a20 2020 2054 6173 6b50 7265 6669  --.    TaskPrefi
+00006f30: 780a 2020 2020 5461 736b 4772 6f75 700a  x.    TaskGroup.
+00006f40: 2020 2020 5461 736b 5374 6174 650a 2020      TaskState.  
+00006f50: 2020 2222 220a 0a20 2020 2073 7461 7274    """..    start
+00006f60: 3a20 666c 6f61 740a 2020 2020 6772 6f75  : float.    grou
+00006f70: 7073 3a20 7365 745b 5461 736b 4772 6f75  ps: set[TaskGrou
+00006f80: 705d 0a20 2020 2063 6f64 653a 2053 6f72  p].    code: Sor
+00006f90: 7465 6453 6574 0a20 2020 2069 643a 2075  tedSet.    id: u
+00006fa0: 7569 642e 5555 4944 0a20 2020 2061 6e6e  uid.UUID.    ann
+00006fb0: 6f74 6174 696f 6e73 3a20 6469 6374 0a0a  otations: dict..
+00006fc0: 2020 2020 5f5f 736c 6f74 735f 5f20 3d20      __slots__ = 
+00006fd0: 7475 706c 6528 5f5f 616e 6e6f 7461 7469  tuple(__annotati
+00006fe0: 6f6e 735f 5f29 0a0a 2020 2020 6465 6620  ons__)..    def 
+00006ff0: 5f5f 696e 6974 5f5f 2873 656c 6629 3a0a  __init__(self):.
+00007000: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+00007010: 7274 203d 2074 696d 6528 290a 2020 2020  rt = time().    
+00007020: 2020 2020 7365 6c66 2e67 726f 7570 7320      self.groups 
+00007030: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00007040: 7365 6c66 2e63 6f64 6520 3d20 536f 7274  self.code = Sort
+00007050: 6564 5365 7428 290a 2020 2020 2020 2020  edSet().        
+00007060: 7365 6c66 2e69 6420 3d20 7575 6964 2e75  self.id = uuid.u
+00007070: 7569 6434 2829 0a20 2020 2020 2020 2073  uid4().        s
+00007080: 656c 662e 616e 6e6f 7461 7469 6f6e 7320  elf.annotations 
+00007090: 3d20 7b7d 0a0a 2020 2020 4070 726f 7065  = {}..    @prope
+000070a0: 7274 790a 2020 2020 6465 6620 7374 6f70  rty.    def stop
+000070b0: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
+000070c0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000070d0: 2e67 726f 7570 733a 0a20 2020 2020 2020  .groups:.       
+000070e0: 2020 2020 2072 6574 7572 6e20 6d61 7828       return max(
+000070f0: 7467 2e73 746f 7020 666f 7220 7467 2069  tg.stop for tg i
+00007100: 6e20 7365 6c66 2e67 726f 7570 7329 0a20  n self.groups). 
+00007110: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00007120: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00007130: 2d31 0a0a 2020 2020 4070 726f 7065 7274  -1..    @propert
+00007140: 790a 2020 2020 6465 6620 7374 6174 6573  y.    def states
+00007150: 2873 656c 6629 202d 3e20 6469 6374 5b54  (self) -> dict[T
+00007160: 6173 6b53 7461 7465 5374 6174 652c 2069  askStateState, i
+00007170: 6e74 5d3a 0a20 2020 2020 2020 2072 6574  nt]:.        ret
+00007180: 7572 6e20 6d65 7267 655f 7769 7468 2873  urn merge_with(s
+00007190: 756d 2c20 2874 672e 7374 6174 6573 2066  um, (tg.states f
+000071a0: 6f72 2074 6720 696e 2073 656c 662e 6772  or tg in self.gr
+000071b0: 6f75 7073 2929 0a0a 2020 2020 6465 6620  oups))..    def 
+000071c0: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+000071d0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+000071e0: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+000071f0: 2020 2020 6622 3c43 6f6d 7075 7461 7469      f"<Computati
+00007200: 6f6e 207b 7365 6c66 2e69 647d 3a20 220a  on {self.id}: ".
+00007210: 2020 2020 2020 2020 2020 2020 2b20 2254              + "T
+00007220: 6173 6b73 3a20 220a 2020 2020 2020 2020  asks: ".        
+00007230: 2020 2020 2b20 222c 2022 2e6a 6f69 6e28      + ", ".join(
+00007240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007250: 2022 2573 3a20 2564 2220 2520 286b 2c20   "%s: %d" % (k, 
+00007260: 7629 2066 6f72 2028 6b2c 2076 2920 696e  v) for (k, v) in
+00007270: 2073 6f72 7465 6428 7365 6c66 2e73 7461   sorted(self.sta
+00007280: 7465 732e 6974 656d 7328 2929 2069 6620  tes.items()) if 
+00007290: 760a 2020 2020 2020 2020 2020 2020 290a  v.            ).
+000072a0: 2020 2020 2020 2020 2020 2020 2b20 223e              + ">
+000072b0: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
+000072c0: 2064 6566 205f 7265 7072 5f68 746d 6c5f   def _repr_html_
+000072d0: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+000072e0: 2020 2020 2020 2072 6574 7572 6e20 6765         return ge
+000072f0: 745f 7465 6d70 6c61 7465 2822 636f 6d70  t_template("comp
+00007300: 7574 6174 696f 6e2e 6874 6d6c 2e6a 3222  utation.html.j2"
+00007310: 292e 7265 6e64 6572 280a 2020 2020 2020  ).render(.      
+00007320: 2020 2020 2020 6964 3d73 656c 662e 6964        id=self.id
+00007330: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+00007340: 6172 743d 7365 6c66 2e73 7461 7274 2c0a  art=self.start,.
+00007350: 2020 2020 2020 2020 2020 2020 7374 6f70              stop
+00007360: 3d73 656c 662e 7374 6f70 2c0a 2020 2020  =self.stop,.    
+00007370: 2020 2020 2020 2020 6772 6f75 7073 3d73          groups=s
+00007380: 656c 662e 6772 6f75 7073 2c0a 2020 2020  elf.groups,.    
+00007390: 2020 2020 2020 2020 7374 6174 6573 3d73          states=s
+000073a0: 656c 662e 7374 6174 6573 2c0a 2020 2020  elf.states,.    
+000073b0: 2020 2020 2020 2020 636f 6465 3d73 656c          code=sel
+000073c0: 662e 636f 6465 2c0a 2020 2020 2020 2020  f.code,.        
+000073d0: 290a 0a0a 636c 6173 7320 5461 736b 5072  )...class TaskPr
+000073e0: 6566 6978 3a0a 2020 2020 2222 2243 6f6c  efix:.    """Col
+000073f0: 6c65 6374 696f 6e20 7472 6163 6b69 6e67  lection tracking
+00007400: 2061 6c6c 2074 6173 6b73 2077 6974 6869   all tasks withi
+00007410: 6e20 6120 6772 6f75 700a 0a20 2020 204b  n a group..    K
+00007420: 6579 7320 6f66 7465 6e20 6861 7665 2061  eys often have a
+00007430: 2073 7472 7563 7475 7265 206c 696b 6520   structure like 
+00007440: 6060 2822 782d 3132 3322 2c20 3029 6060  ``("x-123", 0)``
+00007450: 0a20 2020 2041 2067 726f 7570 2074 616b  .    A group tak
+00007460: 6573 2074 6865 2066 6972 7374 2073 6563  es the first sec
+00007470: 7469 6f6e 2c20 6c69 6b65 2060 6022 7822  tion, like ``"x"
+00007480: 6060 0a0a 2020 2020 5365 6520 416c 736f  ``..    See Also
+00007490: 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a 2020  .    --------.  
+000074a0: 2020 5461 736b 4772 6f75 700a 2020 2020    TaskGroup.    
+000074b0: 2222 220a 0a20 2020 2023 3a20 5468 6520  """..    #: The 
+000074c0: 6e61 6d65 206f 6620 6120 6772 6f75 7020  name of a group 
+000074d0: 6f66 2074 6173 6b73 2e0a 2020 2020 233a  of tasks..    #:
+000074e0: 2046 6f72 2061 2074 6173 6b20 6c69 6b65   For a task like
+000074f0: 2060 6028 2278 2d31 3233 222c 2030 2960   ``("x-123", 0)`
+00007500: 6020 7468 6973 2069 7320 7468 6520 7465  ` this is the te
+00007510: 7874 2060 6022 7822 6060 0a20 2020 206e  xt ``"x"``.    n
+00007520: 616d 653a 2073 7472 0a0a 2020 2020 233a  ame: str..    #:
+00007530: 2041 6e20 6578 706f 6e65 6e74 6961 6c6c   An exponentiall
+00007540: 7920 7765 6967 6874 6564 206d 6f76 696e  y weighted movin
+00007550: 6720 6176 6572 6167 6520 6475 7261 7469  g average durati
+00007560: 6f6e 206f 6620 616c 6c20 7461 736b 7320  on of all tasks 
+00007570: 7769 7468 2074 6869 7320 7072 6566 6978  with this prefix
+00007580: 0a20 2020 2064 7572 6174 696f 6e5f 6176  .    duration_av
+00007590: 6572 6167 653a 2066 6c6f 6174 0a0a 2020  erage: float..  
+000075a0: 2020 233a 204e 756d 6265 7273 206f 6620    #: Numbers of 
+000075b0: 7469 6d65 7320 6120 7461 736b 2077 6173  times a task was
+000075c0: 206d 6172 6b65 6420 6173 2073 7573 7069   marked as suspi
+000075d0: 6369 6f75 7320 7769 7468 2074 6869 7320  cious with this 
+000075e0: 7072 6566 6978 0a20 2020 2073 7573 7069  prefix.    suspi
+000075f0: 6369 6f75 733a 2069 6e74 0a0a 2020 2020  cious: int..    
+00007600: 233a 2053 746f 7265 2074 696d 696e 6773  #: Store timings
+00007610: 2066 6f72 2065 6163 6820 7072 6566 6978   for each prefix
+00007620: 2d61 6374 696f 6e0a 2020 2020 616c 6c5f  -action.    all_
+00007630: 6475 7261 7469 6f6e 733a 2064 6566 6175  durations: defau
+00007640: 6c74 6469 6374 5b73 7472 2c20 666c 6f61  ltdict[str, floa
+00007650: 745d 0a0a 2020 2020 233a 2054 6869 7320  t]..    #: This 
+00007660: 6d65 6173 7572 6573 2074 6865 206d 6178  measures the max
+00007670: 696d 756d 2072 6563 6f72 6465 6420 6c69  imum recorded li
+00007680: 7665 2065 7865 6375 7469 6f6e 2074 696d  ve execution tim
+00007690: 6520 616e 6420 6361 6e20 6265 2075 7365  e and can be use
+000076a0: 6420 746f 0a20 2020 2023 3a20 6465 7465  d to.    #: dete
+000076b0: 6374 206f 7574 6c69 6572 730a 2020 2020  ct outliers.    
+000076c0: 6d61 785f 6578 6563 5f74 696d 653a 2066  max_exec_time: f
+000076d0: 6c6f 6174 0a0a 2020 2020 233a 2054 6173  loat..    #: Tas
+000076e0: 6b20 6772 6f75 7073 2061 7373 6f63 6961  k groups associa
+000076f0: 7465 6420 746f 2074 6869 7320 7072 6566  ted to this pref
+00007700: 6978 0a20 2020 2067 726f 7570 733a 206c  ix.    groups: l
+00007710: 6973 745b 5461 736b 4772 6f75 705d 0a0a  ist[TaskGroup]..
+00007720: 2020 2020 233a 2041 6363 756d 756c 6174      #: Accumulat
+00007730: 6520 636f 756e 7420 6f66 206e 756d 6265  e count of numbe
+00007740: 7220 6f66 2074 6173 6b73 2069 6e20 6561  r of tasks in ea
+00007750: 6368 2073 7461 7465 0a20 2020 2073 7461  ch state.    sta
+00007760: 7465 5f63 6f75 6e74 733a 2064 6566 6175  te_counts: defau
+00007770: 6c74 6469 6374 5b54 6173 6b53 7461 7465  ltdict[TaskState
+00007780: 5374 6174 652c 2069 6e74 5d0a 0a20 2020  State, int]..   
+00007790: 205f 5f73 6c6f 7473 5f5f 203d 2074 7570   __slots__ = tup
+000077a0: 6c65 285f 5f61 6e6e 6f74 6174 696f 6e73  le(__annotations
+000077b0: 5f5f 290a 0a20 2020 2064 6566 205f 5f69  __)..    def __i
+000077c0: 6e69 745f 5f28 7365 6c66 2c20 6e61 6d65  nit__(self, name
+000077d0: 3a20 7374 7229 3a0a 2020 2020 2020 2020  : str):.        
+000077e0: 7365 6c66 2e6e 616d 6520 3d20 6e61 6d65  self.name = name
+000077f0: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
+00007800: 6f75 7073 203d 205b 5d0a 2020 2020 2020  oups = [].      
+00007810: 2020 7365 6c66 2e61 6c6c 5f64 7572 6174    self.all_durat
+00007820: 696f 6e73 203d 2064 6566 6175 6c74 6469  ions = defaultdi
+00007830: 6374 2866 6c6f 6174 290a 2020 2020 2020  ct(float).      
+00007840: 2020 7365 6c66 2e73 7461 7465 5f63 6f75    self.state_cou
+00007850: 6e74 7320 3d20 6465 6661 756c 7464 6963  nts = defaultdic
+00007860: 7428 696e 7429 0a20 2020 2020 2020 2074  t(int).        t
+00007870: 6173 6b5f 6475 7261 7469 6f6e 7320 3d20  ask_durations = 
+00007880: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+00007890: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
+000078a0: 6564 756c 6572 2e64 6566 6175 6c74 2d74  eduler.default-t
+000078b0: 6173 6b2d 6475 7261 7469 6f6e 7322 290a  ask-durations").
+000078c0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000078d0: 6e61 6d65 2069 6e20 7461 736b 5f64 7572  name in task_dur
+000078e0: 6174 696f 6e73 3a0a 2020 2020 2020 2020  ations:.        
+000078f0: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
+00007900: 6e5f 6176 6572 6167 6520 3d20 7061 7273  n_average = pars
+00007910: 655f 7469 6d65 6465 6c74 6128 7461 736b  e_timedelta(task
+00007920: 5f64 7572 6174 696f 6e73 5b73 656c 662e  _durations[self.
+00007930: 6e61 6d65 5d29 0a20 2020 2020 2020 2065  name]).        e
+00007940: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007950: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
+00007960: 7665 7261 6765 203d 202d 310a 2020 2020  verage = -1.    
+00007970: 2020 2020 7365 6c66 2e6d 6178 5f65 7865      self.max_exe
+00007980: 635f 7469 6d65 203d 202d 310a 2020 2020  c_time = -1.    
+00007990: 2020 2020 7365 6c66 2e73 7573 7069 6369      self.suspici
+000079a0: 6f75 7320 3d20 300a 0a20 2020 2064 6566  ous = 0..    def
+000079b0: 2061 6464 5f65 7865 635f 7469 6d65 2873   add_exec_time(s
+000079c0: 656c 662c 2064 7572 6174 696f 6e3a 2066  elf, duration: f
+000079d0: 6c6f 6174 2920 2d3e 204e 6f6e 653a 0a20  loat) -> None:. 
+000079e0: 2020 2020 2020 2073 656c 662e 6d61 785f         self.max_
+000079f0: 6578 6563 5f74 696d 6520 3d20 6d61 7828  exec_time = max(
+00007a00: 6475 7261 7469 6f6e 2c20 7365 6c66 2e6d  duration, self.m
+00007a10: 6178 5f65 7865 635f 7469 6d65 290a 2020  ax_exec_time).  
+00007a20: 2020 2020 2020 6966 2064 7572 6174 696f        if duratio
+00007a30: 6e20 3e20 3220 2a20 7365 6c66 2e64 7572  n > 2 * self.dur
+00007a40: 6174 696f 6e5f 6176 6572 6167 653a 0a20  ation_average:. 
+00007a50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00007a60: 6475 7261 7469 6f6e 5f61 7665 7261 6765  duration_average
+00007a70: 203d 202d 310a 0a20 2020 2064 6566 2061   = -1..    def a
+00007a80: 6464 5f64 7572 6174 696f 6e28 7365 6c66  dd_duration(self
+00007a90: 2c20 6163 7469 6f6e 3a20 7374 722c 2073  , action: str, s
+00007aa0: 7461 7274 3a20 666c 6f61 742c 2073 746f  tart: float, sto
+00007ab0: 703a 2066 6c6f 6174 2920 2d3e 204e 6f6e  p: float) -> Non
+00007ac0: 653a 0a20 2020 2020 2020 2064 7572 6174  e:.        durat
+00007ad0: 696f 6e20 3d20 7374 6f70 202d 2073 7461  ion = stop - sta
+00007ae0: 7274 0a20 2020 2020 2020 2073 656c 662e  rt.        self.
+00007af0: 616c 6c5f 6475 7261 7469 6f6e 735b 6163  all_durations[ac
+00007b00: 7469 6f6e 5d20 2b3d 2064 7572 6174 696f  tion] += duratio
+00007b10: 6e0a 2020 2020 2020 2020 6966 2061 6374  n.        if act
+00007b20: 696f 6e20 3d3d 2022 636f 6d70 7574 6522  ion == "compute"
+00007b30: 3a0a 2020 2020 2020 2020 2020 2020 6f6c  :.            ol
+00007b40: 6420 3d20 7365 6c66 2e64 7572 6174 696f  d = self.duratio
+00007b50: 6e5f 6176 6572 6167 650a 2020 2020 2020  n_average.      
+00007b60: 2020 2020 2020 6966 206f 6c64 203c 2030        if old < 0
+00007b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007b80: 2020 7365 6c66 2e64 7572 6174 696f 6e5f    self.duration_
+00007b90: 6176 6572 6167 6520 3d20 6475 7261 7469  average = durati
+00007ba0: 6f6e 0a20 2020 2020 2020 2020 2020 2065  on.            e
+00007bb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007bc0: 2020 2020 2073 656c 662e 6475 7261 7469       self.durati
+00007bd0: 6f6e 5f61 7665 7261 6765 203d 2030 2e35  on_average = 0.5
+00007be0: 202a 2064 7572 6174 696f 6e20 2b20 302e   * duration + 0.
+00007bf0: 3520 2a20 6f6c 640a 0a20 2020 2040 7072  5 * old..    @pr
+00007c00: 6f70 6572 7479 0a20 2020 2064 6566 2073  operty.    def s
+00007c10: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
+00007c20: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
+00007c30: 2020 2020 2020 2022 2222 5468 6520 6e75         """The nu
+00007c40: 6d62 6572 206f 6620 7461 736b 7320 696e  mber of tasks in
+00007c50: 2065 6163 6820 7374 6174 652c 0a20 2020   each state,.   
+00007c60: 2020 2020 206c 696b 6520 6060 7b22 6d65       like ``{"me
+00007c70: 6d6f 7279 223a 2031 302c 2022 7072 6f63  mory": 10, "proc
+00007c80: 6573 7369 6e67 223a 2033 2c20 2272 656c  essing": 3, "rel
+00007c90: 6561 7365 6422 3a20 342c 202e 2e2e 7d60  eased": 4, ...}`
+00007ca0: 600a 2020 2020 2020 2020 2222 220a 2020  `.        """.  
+00007cb0: 2020 2020 2020 7265 7475 726e 206d 6572        return mer
+00007cc0: 6765 5f77 6974 6828 7375 6d2c 205b 7467  ge_with(sum, [tg
+00007cd0: 2e73 7461 7465 7320 666f 7220 7467 2069  .states for tg i
+00007ce0: 6e20 7365 6c66 2e67 726f 7570 735d 290a  n self.groups]).
+00007cf0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00007d00: 2020 2064 6566 2061 6374 6976 6528 7365     def active(se
+00007d10: 6c66 2920 2d3e 206c 6973 745b 5461 736b  lf) -> list[Task
+00007d20: 4772 6f75 705d 3a0a 2020 2020 2020 2020  Group]:.        
+00007d30: 7265 7475 726e 205b 0a20 2020 2020 2020  return [.       
+00007d40: 2020 2020 2074 670a 2020 2020 2020 2020       tg.        
+00007d50: 2020 2020 666f 7220 7467 2069 6e20 7365      for tg in se
+00007d60: 6c66 2e67 726f 7570 730a 2020 2020 2020  lf.groups.      
+00007d70: 2020 2020 2020 6966 2061 6e79 286b 2021        if any(k !
+00007d80: 3d20 2266 6f72 676f 7474 656e 2220 616e  = "forgotten" an
+00007d90: 6420 7620 213d 2030 2066 6f72 206b 2c20  d v != 0 for k, 
+00007da0: 7620 696e 2074 672e 7374 6174 6573 2e69  v in tg.states.i
+00007db0: 7465 6d73 2829 290a 2020 2020 2020 2020  tems()).        
+00007dc0: 5d0a 0a20 2020 2040 7072 6f70 6572 7479  ]..    @property
+00007dd0: 0a20 2020 2064 6566 2061 6374 6976 655f  .    def active_
+00007de0: 7374 6174 6573 2873 656c 6629 202d 3e20  states(self) -> 
+00007df0: 6469 6374 5b73 7472 2c20 696e 745d 3a0a  dict[str, int]:.
+00007e00: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+00007e10: 6572 6765 5f77 6974 6828 7375 6d2c 205b  erge_with(sum, [
+00007e20: 7467 2e73 7461 7465 7320 666f 7220 7467  tg.states for tg
+00007e30: 2069 6e20 7365 6c66 2e61 6374 6976 655d   in self.active]
+00007e40: 290a 0a20 2020 2064 6566 205f 5f72 6570  )..    def __rep
+00007e50: 725f 5f28 7365 6c66 2920 2d3e 2073 7472  r__(self) -> str
+00007e60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00007e70: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
+00007e80: 3c22 0a20 2020 2020 2020 2020 2020 202b  <".            +
+00007e90: 2073 656c 662e 6e61 6d65 0a20 2020 2020   self.name.     
+00007ea0: 2020 2020 2020 202b 2022 3a20 220a 2020         + ": ".  
+00007eb0: 2020 2020 2020 2020 2020 2b20 222c 2022            + ", "
+00007ec0: 2e6a 6f69 6e28 0a20 2020 2020 2020 2020  .join(.         
+00007ed0: 2020 2020 2020 2022 2573 3a20 2564 2220         "%s: %d" 
+00007ee0: 2520 286b 2c20 7629 2066 6f72 2028 6b2c  % (k, v) for (k,
+00007ef0: 2076 2920 696e 2073 6f72 7465 6428 7365   v) in sorted(se
+00007f00: 6c66 2e73 7461 7465 732e 6974 656d 7328  lf.states.items(
+00007f10: 2929 2069 6620 760a 2020 2020 2020 2020  )) if v.        
+00007f20: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00007f30: 2020 2b20 223e 220a 2020 2020 2020 2020    + ">".        
+00007f40: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+00007f50: 0a20 2020 2064 6566 206e 6279 7465 735f  .    def nbytes_
+00007f60: 746f 7461 6c28 7365 6c66 2920 2d3e 2069  total(self) -> i
+00007f70: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
+00007f80: 726e 2073 756d 2874 672e 6e62 7974 6573  rn sum(tg.nbytes
+00007f90: 5f74 6f74 616c 2066 6f72 2074 6720 696e  _total for tg in
+00007fa0: 2073 656c 662e 6772 6f75 7073 290a 0a20   self.groups).. 
+00007fb0: 2020 2064 6566 205f 5f6c 656e 5f5f 2873     def __len__(s
+00007fc0: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
+00007fd0: 2020 2020 2072 6574 7572 6e20 7375 6d28       return sum(
+00007fe0: 6d61 7028 6c65 6e2c 2073 656c 662e 6772  map(len, self.gr
+00007ff0: 6f75 7073 2929 0a0a 2020 2020 4070 726f  oups))..    @pro
+00008000: 7065 7274 790a 2020 2020 6465 6620 6475  perty.    def du
+00008010: 7261 7469 6f6e 2873 656c 6629 202d 3e20  ration(self) -> 
+00008020: 666c 6f61 743a 0a20 2020 2020 2020 2072  float:.        r
+00008030: 6574 7572 6e20 7375 6d28 7467 2e64 7572  eturn sum(tg.dur
+00008040: 6174 696f 6e20 666f 7220 7467 2069 6e20  ation for tg in 
+00008050: 7365 6c66 2e67 726f 7570 7329 0a0a 2020  self.groups)..  
+00008060: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00008070: 6465 6620 7479 7065 7328 7365 6c66 2920  def types(self) 
+00008080: 2d3e 2073 6574 5b73 7472 5d3a 0a20 2020  -> set[str]:.   
+00008090: 2020 2020 2072 6574 7572 6e20 7b74 7970       return {typ
+000080a0: 2066 6f72 2074 6720 696e 2073 656c 662e   for tg in self.
+000080b0: 6772 6f75 7073 2066 6f72 2074 7970 2069  groups for typ i
+000080c0: 6e20 7467 2e74 7970 6573 7d0a 0a0a 636c  n tg.types}...cl
+000080d0: 6173 7320 5461 736b 4772 6f75 703a 0a20  ass TaskGroup:. 
+000080e0: 2020 2022 2222 436f 6c6c 6563 7469 6f6e     """Collection
+000080f0: 2074 7261 636b 696e 6720 616c 6c20 7461   tracking all ta
+00008100: 736b 7320 7769 7468 696e 2061 2067 726f  sks within a gro
+00008110: 7570 0a0a 2020 2020 4b65 7973 206f 6674  up..    Keys oft
+00008120: 656e 2068 6176 6520 6120 7374 7275 6374  en have a struct
+00008130: 7572 6520 6c69 6b65 2060 6028 2278 2d31  ure like ``("x-1
+00008140: 3233 222c 2030 2960 600a 2020 2020 4120  23", 0)``.    A 
+00008150: 6772 6f75 7020 7461 6b65 7320 7468 6520  group takes the 
+00008160: 6669 7273 7420 7365 6374 696f 6e2c 206c  first section, l
+00008170: 696b 6520 6060 2278 2d31 3233 2260 600a  ike ``"x-123"``.
+00008180: 0a20 2020 2053 6565 2061 6c73 6f0a 2020  .    See also.  
+00008190: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2054    --------.    T
+000081a0: 6173 6b50 7265 6669 780a 2020 2020 2222  askPrefix.    ""
+000081b0: 220a 0a20 2020 2023 3a20 5468 6520 6e61  "..    #: The na
+000081c0: 6d65 206f 6620 6120 6772 6f75 7020 6f66  me of a group of
+000081d0: 2074 6173 6b73 2e0a 2020 2020 233a 2046   tasks..    #: F
+000081e0: 6f72 2061 2074 6173 6b20 6c69 6b65 2060  or a task like `
+000081f0: 6028 2278 2d31 3233 222c 2030 2960 6020  `("x-123", 0)`` 
+00008200: 7468 6973 2069 7320 7468 6520 7465 7874  this is the text
+00008210: 2060 6022 782d 3132 3322 6060 0a20 2020   ``"x-123"``.   
+00008220: 206e 616d 653a 2073 7472 0a0a 2020 2020   name: str..    
+00008230: 233a 2054 6865 206e 756d 6265 7220 6f66  #: The number of
+00008240: 2074 6173 6b73 2069 6e20 6561 6368 2073   tasks in each s
+00008250: 7461 7465 2c0a 2020 2020 233a 206c 696b  tate,.    #: lik
+00008260: 6520 6060 7b22 6d65 6d6f 7279 223a 2031  e ``{"memory": 1
+00008270: 302c 2022 7072 6f63 6573 7369 6e67 223a  0, "processing":
+00008280: 2033 2c20 2272 656c 6561 7365 6422 3a20   3, "released": 
+00008290: 342c 202e 2e2e 7d60 600a 2020 2020 7374  4, ...}``.    st
+000082a0: 6174 6573 3a20 6469 6374 5b54 6173 6b53  ates: dict[TaskS
+000082b0: 7461 7465 5374 6174 652c 2069 6e74 5d0a  tateState, int].
+000082c0: 0a20 2020 2023 3a20 5468 6520 6f74 6865  .    #: The othe
+000082d0: 7220 5461 736b 4772 6f75 7073 206f 6e20  r TaskGroups on 
+000082e0: 7768 6963 6820 7468 6973 206f 6e65 2064  which this one d
+000082f0: 6570 656e 6473 0a20 2020 2064 6570 656e  epends.    depen
+00008300: 6465 6e63 6965 733a 2073 6574 5b54 6173  dencies: set[Tas
+00008310: 6b47 726f 7570 5d0a 0a20 2020 2023 3a20  kGroup]..    #: 
+00008320: 5468 6520 746f 7461 6c20 6e75 6d62 6572  The total number
+00008330: 206f 6620 6279 7465 7320 7468 6174 2074   of bytes that t
+00008340: 6869 7320 7461 736b 2067 726f 7570 2068  his task group h
+00008350: 6173 2070 726f 6475 6365 640a 2020 2020  as produced.    
+00008360: 6e62 7974 6573 5f74 6f74 616c 3a20 696e  nbytes_total: in
+00008370: 740a 0a20 2020 2023 3a20 5468 6520 746f  t..    #: The to
+00008380: 7461 6c20 616d 6f75 6e74 206f 6620 7469  tal amount of ti
+00008390: 6d65 2073 7065 6e74 206f 6e20 616c 6c20  me spent on all 
+000083a0: 7461 736b 7320 696e 2074 6869 7320 5461  tasks in this Ta
+000083b0: 736b 4772 6f75 700a 2020 2020 6475 7261  skGroup.    dura
+000083c0: 7469 6f6e 3a20 666c 6f61 740a 0a20 2020  tion: float..   
+000083d0: 2023 3a20 5468 6520 7265 7375 6c74 2074   #: The result t
+000083e0: 7970 6573 206f 6620 7468 6973 2054 6173  ypes of this Tas
+000083f0: 6b47 726f 7570 0a20 2020 2074 7970 6573  kGroup.    types
+00008400: 3a20 7365 745b 7374 725d 0a0a 2020 2020  : set[str]..    
+00008410: 233a 2054 6865 2077 6f72 6b65 7220 6d6f  #: The worker mo
+00008420: 7374 2072 6563 656e 746c 7920 6173 7369  st recently assi
+00008430: 676e 6564 2061 2074 6173 6b20 6672 6f6d  gned a task from
+00008440: 2074 6869 7320 6772 6f75 702c 206f 7220   this group, or 
+00008450: 4e6f 6e65 2077 6865 6e20 7468 6520 6772  None when the gr
+00008460: 6f75 700a 2020 2020 233a 2069 7320 6e6f  oup.    #: is no
+00008470: 7420 6964 656e 7469 6669 6564 2074 6f20  t identified to 
+00008480: 6265 2072 6f6f 742d 6c69 6b65 2062 7920  be root-like by 
+00008490: 6053 6368 6564 756c 6572 5374 6174 652e  `SchedulerState.
+000084a0: 6465 6369 6465 5f77 6f72 6b65 7260 2e0a  decide_worker`..
+000084b0: 2020 2020 6c61 7374 5f77 6f72 6b65 723a      last_worker:
+000084c0: 2057 6f72 6b65 7253 7461 7465 207c 204e   WorkerState | N
+000084d0: 6f6e 650a 0a20 2020 2023 3a20 4966 2060  one..    #: If `
+000084e0: 6c61 7374 5f77 6f72 6b65 7260 2069 7320  last_worker` is 
+000084f0: 6e6f 7420 4e6f 6e65 2c20 7468 6520 6e75  not None, the nu
+00008500: 6d62 6572 206f 6620 7469 6d65 7320 7468  mber of times th
+00008510: 6174 2077 6f72 6b65 7220 7368 6f75 6c64  at worker should
+00008520: 2062 6520 6173 7369 676e 6564 0a20 2020   be assigned.   
+00008530: 2023 3a20 7375 6273 6571 7565 6e74 2074   #: subsequent t
+00008540: 6173 6b73 2075 6e74 696c 2061 206e 6577  asks until a new
+00008550: 2077 6f72 6b65 7220 6973 2063 686f 7365   worker is chose
+00008560: 6e2e 0a20 2020 206c 6173 745f 776f 726b  n..    last_work
+00008570: 6572 5f74 6173 6b73 5f6c 6566 743a 2069  er_tasks_left: i
+00008580: 6e74 0a0a 2020 2020 7072 6566 6978 3a20  nt..    prefix: 
+00008590: 5461 736b 5072 6566 6978 207c 204e 6f6e  TaskPrefix | Non
+000085a0: 650a 2020 2020 7374 6172 743a 2066 6c6f  e.    start: flo
+000085b0: 6174 0a20 2020 2073 746f 703a 2066 6c6f  at.    stop: flo
+000085c0: 6174 0a20 2020 2061 6c6c 5f64 7572 6174  at.    all_durat
+000085d0: 696f 6e73 3a20 6465 6661 756c 7464 6963  ions: defaultdic
+000085e0: 745b 7374 722c 2066 6c6f 6174 5d0a 0a20  t[str, float].. 
+000085f0: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
+00008600: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
+00008610: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
+00008620: 5f69 6e69 745f 5f28 7365 6c66 2c20 6e61  _init__(self, na
+00008630: 6d65 3a20 7374 7229 3a0a 2020 2020 2020  me: str):.      
+00008640: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
+00008650: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
+00008660: 7072 6566 6978 203d 204e 6f6e 650a 2020  prefix = None.  
+00008670: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
+00008680: 7320 3d20 6469 6374 2e66 726f 6d6b 6579  s = dict.fromkey
+00008690: 7328 414c 4c5f 5441 534b 5f53 5441 5445  s(ALL_TASK_STATE
+000086a0: 532c 2030 290a 2020 2020 2020 2020 7365  S, 0).        se
+000086b0: 6c66 2e64 6570 656e 6465 6e63 6965 7320  lf.dependencies 
+000086c0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+000086d0: 7365 6c66 2e6e 6279 7465 735f 746f 7461  self.nbytes_tota
+000086e0: 6c20 3d20 300a 2020 2020 2020 2020 7365  l = 0.        se
+000086f0: 6c66 2e64 7572 6174 696f 6e20 3d20 300a  lf.duration = 0.
+00008700: 2020 2020 2020 2020 7365 6c66 2e74 7970          self.typ
+00008710: 6573 203d 2073 6574 2829 0a20 2020 2020  es = set().     
+00008720: 2020 2073 656c 662e 7374 6172 7420 3d20     self.start = 
+00008730: 302e 300a 2020 2020 2020 2020 7365 6c66  0.0.        self
+00008740: 2e73 746f 7020 3d20 302e 300a 2020 2020  .stop = 0.0.    
+00008750: 2020 2020 7365 6c66 2e61 6c6c 5f64 7572      self.all_dur
+00008760: 6174 696f 6e73 203d 2064 6566 6175 6c74  ations = default
+00008770: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
+00008780: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
+00008790: 726b 6572 203d 204e 6f6e 650a 2020 2020  rker = None.    
+000087a0: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
+000087b0: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
+000087c0: 3d20 300a 0a20 2020 2064 6566 2061 6464  = 0..    def add
+000087d0: 5f64 7572 6174 696f 6e28 7365 6c66 2c20  _duration(self, 
+000087e0: 6163 7469 6f6e 3a20 7374 722c 2073 7461  action: str, sta
+000087f0: 7274 3a20 666c 6f61 742c 2073 746f 703a  rt: float, stop:
+00008800: 2066 6c6f 6174 2920 2d3e 204e 6f6e 653a   float) -> None:
+00008810: 0a20 2020 2020 2020 2064 7572 6174 696f  .        duratio
+00008820: 6e20 3d20 7374 6f70 202d 2073 7461 7274  n = stop - start
+00008830: 0a20 2020 2020 2020 2073 656c 662e 616c  .        self.al
+00008840: 6c5f 6475 7261 7469 6f6e 735b 6163 7469  l_durations[acti
+00008850: 6f6e 5d20 2b3d 2064 7572 6174 696f 6e0a  on] += duration.
+00008860: 2020 2020 2020 2020 6966 2061 6374 696f          if actio
+00008870: 6e20 3d3d 2022 636f 6d70 7574 6522 3a0a  n == "compute":.
+00008880: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00008890: 656c 662e 7374 6f70 203c 2073 746f 703a  elf.stop < stop:
+000088a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000088b0: 2073 656c 662e 7374 6f70 203d 2073 746f   self.stop = sto
+000088c0: 700a 2020 2020 2020 2020 2020 2020 7365  p.            se
+000088d0: 6c66 2e73 7461 7274 203d 2073 656c 662e  lf.start = self.
+000088e0: 7374 6172 7420 6f72 2073 7461 7274 0a20  start or start. 
+000088f0: 2020 2020 2020 2073 656c 662e 6475 7261         self.dura
+00008900: 7469 6f6e 202b 3d20 6475 7261 7469 6f6e  tion += duration
+00008910: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00008920: 7365 6c66 2e70 7265 6669 7820 6973 206e  self.prefix is n
+00008930: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+00008940: 7365 6c66 2e70 7265 6669 782e 6164 645f  self.prefix.add_
+00008950: 6475 7261 7469 6f6e 2861 6374 696f 6e2c  duration(action,
+00008960: 2073 7461 7274 2c20 7374 6f70 290a 0a20   start, stop).. 
+00008970: 2020 2064 6566 2061 6464 2873 656c 662c     def add(self,
+00008980: 206f 7468 6572 3a20 5461 736b 5374 6174   other: TaskStat
+00008990: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+000089a0: 2020 2020 7365 6c66 2e73 7461 7465 735b      self.states[
+000089b0: 6f74 6865 722e 7374 6174 655d 202b 3d20  other.state] += 
+000089c0: 310a 2020 2020 2020 2020 6f74 6865 722e  1.        other.
+000089d0: 6772 6f75 7020 3d20 7365 6c66 0a0a 2020  group = self..  
+000089e0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+000089f0: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+00008a00: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
+00008a10: 2020 2020 2020 2020 2020 223c 220a 2020            "<".  
+00008a20: 2020 2020 2020 2020 2020 2b20 2873 656c            + (sel
+00008a30: 662e 6e61 6d65 206f 7220 226e 6f2d 6772  f.name or "no-gr
+00008a40: 6f75 7022 290a 2020 2020 2020 2020 2020  oup").          
+00008a50: 2020 2b20 223a 2022 0a20 2020 2020 2020    + ": ".       
+00008a60: 2020 2020 202b 2022 2c20 222e 6a6f 696e       + ", ".join
+00008a70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00008a80: 2020 2225 733a 2025 6422 2025 2028 6b2c    "%s: %d" % (k,
+00008a90: 2076 2920 666f 7220 286b 2c20 7629 2069   v) for (k, v) i
+00008aa0: 6e20 736f 7274 6564 2873 656c 662e 7374  n sorted(self.st
+00008ab0: 6174 6573 2e69 7465 6d73 2829 2920 6966  ates.items()) if
+00008ac0: 2076 0a20 2020 2020 2020 2020 2020 2029   v.            )
+00008ad0: 0a20 2020 2020 2020 2020 2020 202b 2022  .            + "
+00008ae0: 3e22 0a20 2020 2020 2020 2029 0a0a 2020  >".        )..  
+00008af0: 2020 6465 6620 5f5f 6c65 6e5f 5f28 7365    def __len__(se
+00008b00: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+00008b10: 2020 2020 7265 7475 726e 2073 756d 2873      return sum(s
+00008b20: 656c 662e 7374 6174 6573 2e76 616c 7565  elf.states.value
+00008b30: 7328 2929 0a0a 2020 2020 6465 6620 5f74  s())..    def _t
+00008b40: 6f5f 6469 6374 5f6e 6f5f 6e65 7374 2873  o_dict_no_nest(s
+00008b50: 656c 662c 202a 2c20 6578 636c 7564 653a  elf, *, exclude:
+00008b60: 2043 6f6e 7461 696e 6572 5b73 7472 5d20   Container[str] 
+00008b70: 3d20 2829 2920 2d3e 2064 6963 745b 7374  = ()) -> dict[st
+00008b80: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
+00008b90: 2022 2222 4469 6374 696f 6e61 7279 2072   """Dictionary r
+00008ba0: 6570 7265 7365 6e74 6174 696f 6e20 666f  epresentation fo
+00008bb0: 7220 6465 6275 6767 696e 6720 7075 7270  r debugging purp
+00008bc0: 6f73 6573 2e0a 2020 2020 2020 2020 4e6f  oses..        No
+00008bd0: 7420 7479 7065 2073 7461 626c 6520 616e  t type stable an
+00008be0: 6420 6e6f 7420 696e 7465 6e64 6564 2066  d not intended f
+00008bf0: 6f72 2072 6f75 6e64 7472 6970 732e 0a0a  or roundtrips...
+00008c00: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+00008c10: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00008c20: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
+00008c30: 2e64 756d 705f 636c 7573 7465 725f 7374  .dump_cluster_st
+00008c40: 6174 650a 2020 2020 2020 2020 6469 7374  ate.        dist
+00008c50: 7269 6275 7465 642e 7574 696c 732e 7265  ributed.utils.re
+00008c60: 6375 7273 6976 655f 746f 5f64 6963 740a  cursive_to_dict.
+00008c70: 2020 2020 2020 2020 5461 736b 5374 6174          TaskStat
+00008c80: 652e 5f74 6f5f 6469 6374 0a20 2020 2020  e._to_dict.     
+00008c90: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00008ca0: 6574 7572 6e20 7265 6375 7273 6976 655f  eturn recursive_
+00008cb0: 746f 5f64 6963 7428 7365 6c66 2c20 6578  to_dict(self, ex
+00008cc0: 636c 7564 653d 6578 636c 7564 652c 206d  clude=exclude, m
+00008cd0: 656d 6265 7273 3d54 7275 6529 0a0a 0a63  embers=True)...c
+00008ce0: 6c61 7373 2054 6173 6b53 7461 7465 3a0a  lass TaskState:.
+00008cf0: 2020 2020 2222 2241 2073 696d 706c 6520      """A simple 
+00008d00: 6f62 6a65 6374 2068 6f6c 6469 6e67 2069  object holding i
+00008d10: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+00008d20: 2061 2074 6173 6b2e 0a0a 2020 2020 4e6f   a task...    No
+00008d30: 7420 746f 2062 6520 636f 6e66 7573 6564  t to be confused
+00008d40: 2077 6974 6820 3a63 6c61 7373 3a60 6469   with :class:`di
+00008d50: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
+00008d60: 5f73 7461 7465 5f6d 6163 6869 6e65 2e54  _state_machine.T
+00008d70: 6173 6b53 7461 7465 602c 2077 6869 6368  askState`, which
+00008d80: 0a20 2020 2068 6f6c 6473 2073 696d 696c  .    holds simil
+00008d90: 6172 2069 6e66 6f72 6d61 7469 6f6e 206f  ar information o
+00008da0: 6e20 7468 6520 576f 726b 6572 2073 6964  n the Worker sid
+00008db0: 652e 0a20 2020 2022 2222 0a0a 2020 2020  e..    """..    
+00008dc0: 233a 2054 6865 206b 6579 2069 7320 7468  #: The key is th
+00008dd0: 6520 756e 6971 7565 2069 6465 6e74 6966  e unique identif
+00008de0: 6965 7220 6f66 2061 2074 6173 6b2c 2067  ier of a task, g
+00008df0: 656e 6572 616c 6c79 2066 6f72 6d65 6420  enerally formed 
+00008e00: 6672 6f6d 2074 6865 206e 616d 6520 6f66  from the name of
+00008e10: 2074 6865 0a20 2020 2023 3a20 6675 6e63   the.    #: func
+00008e20: 7469 6f6e 2c20 666f 6c6c 6f77 6564 2062  tion, followed b
+00008e30: 7920 6120 6861 7368 206f 6620 7468 6520  y a hash of the 
+00008e40: 6675 6e63 7469 6f6e 2061 6e64 2061 7267  function and arg
+00008e50: 756d 656e 7473 2c20 6c69 6b65 0a20 2020  uments, like.   
+00008e60: 2023 3a20 6060 2769 6e63 2d61 6233 3163   #: ``'inc-ab31c
+00008e70: 3031 3034 3434 3937 3730 3034 6436 3536  010444977004d656
+00008e80: 3631 3064 3264 3432 3165 6327 6060 2e0a  610d2d421ec'``..
+00008e90: 2020 2020 6b65 793a 2073 7472 0a0a 2020      key: str..  
+00008ea0: 2020 233a 2054 6865 2062 726f 6164 2063    #: The broad c
+00008eb0: 6c61 7373 206f 6620 7461 736b 7320 746f  lass of tasks to
+00008ec0: 2077 6869 6368 2074 6869 7320 7461 736b   which this task
+00008ed0: 2062 656c 6f6e 6773 206c 696b 6520 2269   belongs like "i
+00008ee0: 6e63 2220 6f72 2022 7265 6164 5f63 7376  nc" or "read_csv
+00008ef0: 220a 2020 2020 7072 6566 6978 3a20 5461  ".    prefix: Ta
+00008f00: 736b 5072 6566 6978 0a0a 2020 2020 233a  skPrefix..    #:
+00008f10: 2041 2073 7065 6369 6669 6361 7469 6f6e   A specification
+00008f20: 206f 6620 686f 7720 746f 2072 756e 2074   of how to run t
+00008f30: 6865 2074 6173 6b2e 2020 5468 6520 7479  he task.  The ty
+00008f40: 7065 2061 6e64 206d 6561 6e69 6e67 206f  pe and meaning o
+00008f50: 6620 7468 6973 2076 616c 7565 2069 730a  f this value is.
+00008f60: 2020 2020 233a 206f 7061 7175 6520 746f      #: opaque to
+00008f70: 2074 6865 2073 6368 6564 756c 6572 2c20   the scheduler, 
+00008f80: 6173 2069 7420 6973 206f 6e6c 7920 696e  as it is only in
+00008f90: 7465 7270 7265 7465 6420 6279 2074 6865  terpreted by the
+00008fa0: 2077 6f72 6b65 7220 746f 2077 6869 6368   worker to which
+00008fb0: 2074 6865 0a20 2020 2023 3a20 7461 736b   the.    #: task
+00008fc0: 2069 7320 7365 6e74 2066 6f72 2065 7865   is sent for exe
+00008fd0: 6375 7469 6e67 2e0a 2020 2020 233a 0a20  cuting..    #:. 
+00008fe0: 2020 2023 3a20 4173 2061 2073 7065 6369     #: As a speci
+00008ff0: 616c 2063 6173 652c 2074 6869 7320 6174  al case, this at
+00009000: 7472 6962 7574 6520 6d61 7920 616c 736f  tribute may also
+00009010: 2062 6520 6060 4e6f 6e65 6060 2c20 696e   be ``None``, in
+00009020: 2077 6869 6368 2063 6173 6520 7468 6520   which case the 
+00009030: 7461 736b 2069 730a 2020 2020 233a 2022  task is.    #: "
+00009040: 7075 7265 2064 6174 6122 2028 7375 6368  pure data" (such
+00009050: 2061 732c 2066 6f72 2065 7861 6d70 6c65   as, for example
+00009060: 2c20 6120 7069 6563 6520 6f66 2064 6174  , a piece of dat
+00009070: 6120 6c6f 6164 6564 2069 6e20 7468 6520  a loaded in the 
+00009080: 7363 6865 6475 6c65 7220 7573 696e 670a  scheduler using.
+00009090: 2020 2020 233a 203a 6d65 7468 3a60 436c      #: :meth:`Cl
+000090a0: 6965 6e74 2e73 6361 7474 6572 6029 2e20  ient.scatter`). 
+000090b0: 2041 2022 7075 7265 2064 6174 6122 2074   A "pure data" t
+000090c0: 6173 6b20 6361 6e6e 6f74 2062 6520 636f  ask cannot be co
+000090d0: 6d70 7574 6564 2061 6761 696e 2069 6620  mputed again if 
+000090e0: 6974 730a 2020 2020 233a 2076 616c 7565  its.    #: value
+000090f0: 2069 7320 6c6f 7374 2e0a 2020 2020 7275   is lost..    ru
+00009100: 6e5f 7370 6563 3a20 6f62 6a65 6374 0a0a  n_spec: object..
+00009110: 2020 2020 233a 2054 6865 2070 7269 6f72      #: The prior
+00009120: 6974 7920 7072 6f76 6964 6573 2065 6163  ity provides eac
+00009130: 6820 7461 736b 2077 6974 6820 6120 7265  h task with a re
+00009140: 6c61 7469 7665 2072 616e 6b69 6e67 2077  lative ranking w
+00009150: 6869 6368 2069 7320 7573 6564 2074 6f20  hich is used to 
+00009160: 6272 6561 6b0a 2020 2020 233a 2074 6965  break.    #: tie
+00009170: 7320 7768 656e 206d 616e 7920 7461 736b  s when many task
+00009180: 7320 6172 6520 6265 696e 6720 636f 6e73  s are being cons
+00009190: 6964 6572 6564 2066 6f72 2065 7865 6375  idered for execu
+000091a0: 7469 6f6e 2e0a 2020 2020 233a 0a20 2020  tion..    #:.   
+000091b0: 2023 3a20 5468 6973 2072 616e 6b69 6e67   #: This ranking
+000091c0: 2069 7320 6765 6e65 7261 6c6c 7920 6120   is generally a 
+000091d0: 322d 6974 656d 2074 7570 6c65 2e20 2054  2-item tuple.  T
+000091e0: 6865 2066 6972 7374 2028 616e 6420 646f  he first (and do
+000091f0: 6d69 6e61 6e74 2920 6974 656d 0a20 2020  minant) item.   
+00009200: 2023 3a20 636f 7272 6573 706f 6e64 7320   #: corresponds 
+00009210: 746f 2077 6865 6e20 6974 2077 6173 2073  to when it was s
+00009220: 7562 6d69 7474 6564 2e20 2047 656e 6572  ubmitted.  Gener
+00009230: 616c 6c79 2c20 6561 726c 6965 7220 7461  ally, earlier ta
+00009240: 736b 7320 7461 6b65 2070 7265 6365 6465  sks take precede
+00009250: 6e63 652e 0a20 2020 2023 3a20 5468 6520  nce..    #: The 
+00009260: 7365 636f 6e64 2069 7465 6d20 6973 2064  second item is d
+00009270: 6574 6572 6d69 6e65 6420 6279 2074 6865  etermined by the
+00009280: 2063 6c69 656e 742c 2061 6e64 2069 7320   client, and is 
+00009290: 6120 7761 7920 746f 2070 7269 6f72 6974  a way to priorit
+000092a0: 697a 6520 7461 736b 730a 2020 2020 233a  ize tasks.    #:
+000092b0: 2077 6974 6869 6e20 6120 6c61 7267 6520   within a large 
+000092c0: 6772 6170 6820 7468 6174 206d 6179 2062  graph that may b
+000092d0: 6520 696d 706f 7274 616e 742c 2073 7563  e important, suc
+000092e0: 6820 6173 2069 6620 7468 6579 2061 7265  h as if they are
+000092f0: 206f 6e20 7468 6520 6372 6974 6963 616c   on the critical
+00009300: 0a20 2020 2023 3a20 7061 7468 2c20 6f72  .    #: path, or
+00009310: 2067 6f6f 6420 746f 2072 756e 2069 6e20   good to run in 
+00009320: 6f72 6465 7220 746f 2072 656c 6561 7365  order to release
+00009330: 206d 616e 7920 6465 7065 6e64 656e 6369   many dependenci
+00009340: 6573 2e20 2054 6869 7320 6973 2065 7870  es.  This is exp
+00009350: 6c61 696e 6564 0a20 2020 2023 3a20 6675  lained.    #: fu
+00009360: 7274 6865 7220 696e 203a 646f 633a 6053  rther in :doc:`S
+00009370: 6368 6564 756c 696e 6720 506f 6c69 6379  cheduling Policy
+00009380: 203c 7363 6865 6475 6c69 6e67 2d70 6f6c   <scheduling-pol
+00009390: 6963 6965 733e 602e 0a20 2020 2070 7269  icies>`..    pri
+000093a0: 6f72 6974 793a 2074 7570 6c65 5b66 6c6f  ority: tuple[flo
+000093b0: 6174 2c20 2e2e 2e5d 207c 204e 6f6e 650a  at, ...] | None.
+000093c0: 0a20 2020 2023 2041 7474 7269 6275 7465  .    # Attribute
+000093d0: 2075 6e64 6572 6c79 696e 6720 7468 6520   underlying the 
+000093e0: 7374 6174 6520 7072 6f70 6572 7479 0a20  state property. 
+000093f0: 2020 205f 7374 6174 653a 2054 6173 6b53     _state: TaskS
+00009400: 7461 7465 5374 6174 650a 0a20 2020 2023  tateState..    #
+00009410: 3a20 5468 6520 7365 7420 6f66 2074 6173  : The set of tas
+00009420: 6b73 2074 6869 7320 7461 736b 2064 6570  ks this task dep
+00009430: 656e 6473 206f 6e20 666f 7220 7072 6f70  ends on for prop
+00009440: 6572 2065 7865 6375 7469 6f6e 2e20 4f6e  er execution. On
+00009450: 6c79 2074 6173 6b73 2073 7469 6c6c 0a20  ly tasks still. 
+00009460: 2020 2023 3a20 616c 6976 6520 6172 6520     #: alive are 
+00009470: 6c69 7374 6564 2069 6e20 7468 6973 2073  listed in this s
+00009480: 6574 2e20 4966 2c20 666f 7220 7768 6174  et. If, for what
+00009490: 6576 6572 2072 6561 736f 6e2c 2074 6869  ever reason, thi
+000094a0: 7320 7461 736b 2061 6c73 6f20 6465 7065  s task also depe
+000094b0: 6e64 7320 6f6e 0a20 2020 2023 3a20 6120  nds on.    #: a 
+000094c0: 666f 7267 6f74 7465 6e20 7461 736b 2c20  forgotten task, 
+000094d0: 7468 6520 3a61 7474 723a 6068 6173 5f6c  the :attr:`has_l
+000094e0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+000094f0: 6020 666c 6167 2069 7320 7365 742e 0a20  ` flag is set.. 
+00009500: 2020 2023 3a0a 2020 2020 233a 2041 2074     #:.    #: A t
+00009510: 6173 6b20 6361 6e20 6f6e 6c79 2062 6520  ask can only be 
+00009520: 6578 6563 7574 6564 206f 6e63 6520 616c  executed once al
+00009530: 6c20 6974 7320 6465 7065 6e64 656e 6369  l its dependenci
+00009540: 6573 2068 6176 6520 616c 7265 6164 7920  es have already 
+00009550: 6265 656e 0a20 2020 2023 3a20 7375 6363  been.    #: succ
+00009560: 6573 7366 756c 6c79 2065 7865 6375 7465  essfully execute
+00009570: 6420 616e 6420 6861 7665 2074 6865 6972  d and have their
+00009580: 2072 6573 756c 7420 7374 6f72 6564 206f   result stored o
+00009590: 6e20 6174 206c 6561 7374 206f 6e65 2077  n at least one w
+000095a0: 6f72 6b65 722e 2054 6869 730a 2020 2020  orker. This.    
+000095b0: 233a 2069 7320 7472 6163 6b65 6420 6279  #: is tracked by
+000095c0: 2070 726f 6772 6573 7369 7665 6c79 2064   progressively d
+000095d0: 7261 696e 696e 6720 7468 6520 3a61 7474  raining the :att
+000095e0: 723a 6077 6169 7469 6e67 5f6f 6e60 2073  r:`waiting_on` s
+000095f0: 6574 2e0a 2020 2020 6465 7065 6e64 656e  et..    dependen
+00009600: 6369 6573 3a20 7365 745b 5461 736b 5374  cies: set[TaskSt
+00009610: 6174 655d 0a0a 2020 2020 233a 2054 6865  ate]..    #: The
+00009620: 2073 6574 206f 6620 7461 736b 7320 7768   set of tasks wh
+00009630: 6963 6820 6465 7065 6e64 206f 6e20 7468  ich depend on th
+00009640: 6973 2074 6173 6b2e 2020 4f6e 6c79 2074  is task.  Only t
+00009650: 6173 6b73 2073 7469 6c6c 2061 6c69 7665  asks still alive
+00009660: 2061 7265 206c 6973 7465 6420 696e 0a20   are listed in. 
+00009670: 2020 2023 3a20 7468 6973 2073 6574 2e20     #: this set. 
+00009680: 5468 6973 2069 7320 7468 6520 7265 7665  This is the reve
+00009690: 7273 6520 6d61 7070 696e 6720 6f66 203a  rse mapping of :
+000096a0: 6174 7472 3a60 6465 7065 6e64 656e 6369  attr:`dependenci
+000096b0: 6573 602e 0a20 2020 2064 6570 656e 6465  es`..    depende
+000096c0: 6e74 733a 2073 6574 5b54 6173 6b53 7461  nts: set[TaskSta
+000096d0: 7465 5d0a 0a20 2020 2023 3a20 5768 6574  te]..    #: Whet
+000096e0: 6865 7220 616e 7920 6f66 2074 6865 2064  her any of the d
+000096f0: 6570 656e 6465 6e63 6965 7320 6f66 2074  ependencies of t
+00009700: 6869 7320 7461 736b 2068 6173 2062 6565  his task has bee
+00009710: 6e20 666f 7267 6f74 7465 6e2e 2046 6f72  n forgotten. For
+00009720: 206d 656d 6f72 790a 2020 2020 233a 2063   memory.    #: c
+00009730: 6f6e 7375 6d70 7469 6f6e 2072 6561 736f  onsumption reaso
+00009740: 6e73 2c20 666f 7267 6f74 7465 6e20 7461  ns, forgotten ta
+00009750: 736b 7320 6172 6520 6e6f 7420 6b65 7074  sks are not kept
+00009760: 2069 6e20 6d65 6d6f 7279 2065 7665 6e20   in memory even 
+00009770: 7468 6f75 6768 2074 6865 7920 6d61 790a  though they may.
+00009780: 2020 2020 233a 2068 6176 6520 6465 7065      #: have depe
+00009790: 6e64 656e 7420 7461 736b 732e 2020 5768  ndent tasks.  Wh
+000097a0: 656e 2061 2074 6173 6b20 6973 2066 6f72  en a task is for
+000097b0: 676f 7474 656e 2c20 7468 6572 6566 6f72  gotten, therefor
+000097c0: 652c 2065 6163 6820 6f66 2069 7473 0a20  e, each of its. 
+000097d0: 2020 2023 3a20 6465 7065 6e64 656e 7473     #: dependents
+000097e0: 2068 6173 2074 6865 6972 203a 6174 7472   has their :attr
+000097f0: 3a60 6861 735f 6c6f 7374 5f64 6570 656e  :`has_lost_depen
+00009800: 6465 6e63 6965 7360 2061 7474 7269 6275  dencies` attribu
+00009810: 7465 2073 6574 2074 6f20 6060 5472 7565  te set to ``True
+00009820: 6060 2e0a 2020 2020 233a 0a20 2020 2023  ``..    #:.    #
+00009830: 3a20 4966 203a 6174 7472 3a60 6861 735f  : If :attr:`has_
+00009840: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
+00009850: 7360 2069 7320 7472 7565 2c20 7468 6973  s` is true, this
+00009860: 2074 6173 6b20 6361 6e6e 6f74 2067 6f20   task cannot go 
+00009870: 696e 746f 2074 6865 0a20 2020 2023 3a20  into the.    #: 
+00009880: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
+00009890: 7465 2061 6e79 6d6f 7265 2e0a 2020 2020  te anymore..    
+000098a0: 6861 735f 6c6f 7374 5f64 6570 656e 6465  has_lost_depende
+000098b0: 6e63 6965 733a 2062 6f6f 6c0a 0a20 2020  ncies: bool..   
+000098c0: 2023 3a20 5468 6520 7365 7420 6f66 2074   #: The set of t
+000098d0: 6173 6b73 2074 6869 7320 7461 736b 2069  asks this task i
+000098e0: 7320 7761 6974 696e 6720 6f6e 202a 6265  s waiting on *be
+000098f0: 666f 7265 2a20 6974 2063 616e 2062 6520  fore* it can be 
+00009900: 6578 6563 7574 6564 2e20 5468 6973 2069  executed. This i
+00009910: 730a 2020 2020 233a 2061 6c77 6179 7320  s.    #: always 
+00009920: 6120 7375 6273 6574 206f 6620 3a61 7474  a subset of :att
+00009930: 723a 6064 6570 656e 6465 6e63 6965 7360  r:`dependencies`
+00009940: 2e20 2045 6163 6820 7469 6d65 206f 6e65  .  Each time one
+00009950: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
+00009960: 6369 6573 2068 6173 0a20 2020 2023 3a20  cies has.    #: 
+00009970: 6669 6e69 7368 6564 2070 726f 6365 7373  finished process
+00009980: 696e 672c 2069 7420 6973 2072 656d 6f76  ing, it is remov
+00009990: 6564 2066 726f 6d20 7468 6520 3a61 7474  ed from the :att
+000099a0: 723a 6077 6169 7469 6e67 5f6f 6e60 2073  r:`waiting_on` s
+000099b0: 6574 2e0a 2020 2020 233a 0a20 2020 2023  et..    #:.    #
+000099c0: 3a20 4f6e 6365 203a 6174 7472 3a60 7761  : Once :attr:`wa
+000099d0: 6974 696e 675f 6f6e 6020 6265 636f 6d65  iting_on` become
+000099e0: 7320 656d 7074 792c 2074 6869 7320 7461  s empty, this ta
+000099f0: 736b 2063 616e 206d 6f76 6520 6672 6f6d  sk can move from
+00009a00: 2074 6865 2022 7761 6974 696e 6722 0a20   the "waiting". 
+00009a10: 2020 2023 3a20 7374 6174 6520 746f 2074     #: state to t
+00009a20: 6865 2022 7072 6f63 6573 7369 6e67 2220  he "processing" 
+00009a30: 7374 6174 6520 2875 6e6c 6573 7320 6f6e  state (unless on
+00009a40: 6520 6f66 2074 6865 2064 6570 656e 6465  e of the depende
+00009a50: 6e63 6965 7320 6572 726f 7265 6420 6f75  ncies errored ou
+00009a60: 742c 2069 6e0a 2020 2020 233a 2077 6869  t, in.    #: whi
+00009a70: 6368 2063 6173 6520 7468 6973 2074 6173  ch case this tas
+00009a80: 6b20 6973 2069 6e73 7465 6164 206d 6172  k is instead mar
+00009a90: 6b65 6420 2265 7272 6564 2229 2e0a 2020  ked "erred")..  
+00009aa0: 2020 7761 6974 696e 675f 6f6e 3a20 7365    waiting_on: se
+00009ab0: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
+00009ac0: 2020 233a 2054 6865 2073 6574 206f 6620    #: The set of 
+00009ad0: 7461 736b 7320 7768 6963 6820 6e65 6564  tasks which need
+00009ae0: 2074 6869 7320 7461 736b 2074 6f20 7265   this task to re
+00009af0: 6d61 696e 2061 6c69 7665 2e20 2054 6869  main alive.  Thi
+00009b00: 7320 6973 2061 6c77 6179 7320 6120 7375  s is always a su
+00009b10: 6273 6574 0a20 2020 2023 3a20 6f66 203a  bset.    #: of :
+00009b20: 6174 7472 3a60 6465 7065 6e64 656e 7473  attr:`dependents
+00009b30: 602e 2020 4561 6368 2074 696d 6520 6f6e  `.  Each time on
+00009b40: 6520 6f66 2074 6865 2064 6570 656e 6465  e of the depende
+00009b50: 6e74 7320 6861 7320 6669 6e69 7368 6564  nts has finished
+00009b60: 2070 726f 6365 7373 696e 672c 0a20 2020   processing,.   
+00009b70: 2023 3a20 6974 2069 7320 7265 6d6f 7665   #: it is remove
+00009b80: 6420 6672 6f6d 2074 6865 203a 6174 7472  d from the :attr
+00009b90: 3a60 7761 6974 6572 7360 2073 6574 2e0a  :`waiters` set..
+00009ba0: 2020 2020 233a 0a20 2020 2023 3a20 4f6e      #:.    #: On
+00009bb0: 6365 2062 6f74 6820 3a61 7474 723a 6077  ce both :attr:`w
+00009bc0: 6169 7465 7273 6020 616e 6420 3a61 7474  aiters` and :att
+00009bd0: 723a 6077 686f 5f77 616e 7473 6020 6265  r:`who_wants` be
+00009be0: 636f 6d65 2065 6d70 7479 2c20 7468 6973  come empty, this
+00009bf0: 2074 6173 6b20 6361 6e20 6265 0a20 2020   task can be.   
+00009c00: 2023 3a20 7265 6c65 6173 6564 2028 6966   #: released (if
+00009c10: 2069 7420 6861 7320 6120 6e6f 6e2d 656d   it has a non-em
+00009c20: 7074 7920 3a61 7474 723a 6072 756e 5f73  pty :attr:`run_s
+00009c30: 7065 6360 2920 6f72 2066 6f72 676f 7474  pec`) or forgott
+00009c40: 656e 2028 6f74 6865 7277 6973 6529 2062  en (otherwise) b
+00009c50: 7920 7468 650a 2020 2020 233a 2073 6368  y the.    #: sch
+00009c60: 6564 756c 6572 2c20 616e 6420 6279 2061  eduler, and by a
+00009c70: 6e79 2077 6f72 6b65 7273 2069 6e20 3a61  ny workers in :a
+00009c80: 7474 723a 6077 686f 5f68 6173 602e 0a20  ttr:`who_has`.. 
+00009c90: 2020 2023 3a0a 2020 2020 233a 202e 2e20     #:.    #: .. 
+00009ca0: 6e6f 7465 3a3a 0a20 2020 2023 3a20 2020  note::.    #:   
+00009cb0: 2043 6f75 6e74 6572 2d69 6e74 7569 7469   Counter-intuiti
+00009cc0: 7665 6c79 2c20 3a61 7474 723a 6077 6169  vely, :attr:`wai
+00009cd0: 7469 6e67 5f6f 6e60 2061 6e64 203a 6174  ting_on` and :at
+00009ce0: 7472 3a60 7761 6974 6572 7360 2061 7265  tr:`waiters` are
+00009cf0: 206e 6f74 2072 6576 6572 7365 0a20 2020   not reverse.   
+00009d00: 2023 3a20 2020 206d 6170 7069 6e67 7320   #:    mappings 
+00009d10: 6f66 2065 6163 6820 6f74 6865 722e 0a20  of each other.. 
+00009d20: 2020 2077 6169 7465 7273 3a20 7365 745b     waiters: set[
+00009d30: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
+00009d40: 233a 2054 6865 2073 6574 206f 6620 636c  #: The set of cl
+00009d50: 6965 6e74 7320 7768 6f20 7761 6e74 2074  ients who want t
+00009d60: 6865 2072 6573 756c 7420 6f66 2074 6869  he result of thi
+00009d70: 7320 7461 736b 2074 6f20 7265 6d61 696e  s task to remain
+00009d80: 2061 6c69 7665 2e0a 2020 2020 233a 2054   alive..    #: T
+00009d90: 6869 7320 6973 2074 6865 2072 6576 6572  his is the rever
+00009da0: 7365 206d 6170 7069 6e67 206f 6620 3a61  se mapping of :a
+00009db0: 7474 723a 6043 6c69 656e 7453 7461 7465  ttr:`ClientState
+00009dc0: 2e77 616e 7473 5f77 6861 7460 2e0a 2020  .wants_what`..  
+00009dd0: 2020 233a 0a20 2020 2023 3a20 5768 656e    #:.    #: When
+00009de0: 2061 2063 6c69 656e 7420 7375 626d 6974   a client submit
+00009df0: 7320 6120 6772 6170 6820 746f 2074 6865  s a graph to the
+00009e00: 2073 6368 6564 756c 6572 2069 7420 616c   scheduler it al
+00009e10: 736f 2073 7065 6369 6669 6573 2077 6869  so specifies whi
+00009e20: 6368 206f 7574 7075 740a 2020 2020 233a  ch output.    #:
+00009e30: 2074 6173 6b73 2069 7420 6465 7369 7265   tasks it desire
+00009e40: 732c 2073 7563 6820 7468 6174 2074 6865  s, such that the
+00009e50: 6972 2072 6573 756c 7473 2061 7265 206e  ir results are n
+00009e60: 6f74 2072 656c 6561 7365 6420 6672 6f6d  ot released from
+00009e70: 206d 656d 6f72 792e 0a20 2020 2023 3a0a   memory..    #:.
+00009e80: 2020 2020 233a 204f 6e63 6520 6120 7461      #: Once a ta
+00009e90: 736b 2068 6173 2066 696e 6973 6865 6420  sk has finished 
+00009ea0: 6578 6563 7574 696e 6720 2869 2e65 2e20  executing (i.e. 
+00009eb0: 6d6f 7665 7320 696e 746f 2074 6865 2022  moves into the "
+00009ec0: 6d65 6d6f 7279 2220 6f72 2022 6572 7265  memory" or "erre
+00009ed0: 6422 0a20 2020 2023 3a20 7374 6174 6529  d".    #: state)
+00009ee0: 2c20 7468 6520 636c 6965 6e74 7320 696e  , the clients in
+00009ef0: 203a 6174 7472 3a60 7768 6f5f 7761 6e74   :attr:`who_want
+00009f00: 7360 2061 7265 206e 6f74 6966 6965 642e  s` are notified.
+00009f10: 0a20 2020 2023 3a0a 2020 2020 233a 204f  .    #:.    #: O
+00009f20: 6e63 6520 626f 7468 203a 6174 7472 3a60  nce both :attr:`
+00009f30: 7761 6974 6572 7360 2061 6e64 203a 6174  waiters` and :at
+00009f40: 7472 3a60 7768 6f5f 7761 6e74 7360 2062  tr:`who_wants` b
+00009f50: 6563 6f6d 6520 656d 7074 792c 2074 6869  ecome empty, thi
+00009f60: 7320 7461 736b 2063 616e 2062 650a 2020  s task can be.  
+00009f70: 2020 233a 2072 656c 6561 7365 6420 2869    #: released (i
+00009f80: 6620 6974 2068 6173 2061 206e 6f6e 2d65  f it has a non-e
+00009f90: 6d70 7479 203a 6174 7472 3a60 7275 6e5f  mpty :attr:`run_
+00009fa0: 7370 6563 6029 206f 7220 666f 7267 6f74  spec`) or forgot
+00009fb0: 7465 6e20 286f 7468 6572 7769 7365 2920  ten (otherwise) 
+00009fc0: 6279 2074 6865 0a20 2020 2023 3a20 7363  by the.    #: sc
+00009fd0: 6865 6475 6c65 722c 2061 6e64 2062 7920  heduler, and by 
+00009fe0: 616e 7920 776f 726b 6572 7320 696e 203a  any workers in :
+00009ff0: 6174 7472 3a60 7768 6f5f 6861 7360 2e0a  attr:`who_has`..
+0000a000: 2020 2020 7768 6f5f 7761 6e74 733a 2073      who_wants: s
+0000a010: 6574 5b43 6c69 656e 7453 7461 7465 5d0a  et[ClientState].
+0000a020: 0a20 2020 2023 3a20 5468 6520 7365 7420  .    #: The set 
+0000a030: 6f66 2077 6f72 6b65 7273 2077 686f 2068  of workers who h
+0000a040: 6176 6520 7468 6973 2074 6173 6b27 7320  ave this task's 
+0000a050: 7265 7375 6c74 2069 6e20 6d65 6d6f 7279  result in memory
+0000a060: 2e20 4974 2069 7320 6e6f 6e2d 656d 7074  . It is non-empt
+0000a070: 7920 6966 6620 7468 650a 2020 2020 233a  y iff the.    #:
+0000a080: 2074 6173 6b20 6973 2069 6e20 7468 6520   task is in the 
+0000a090: 226d 656d 6f72 7922 2073 7461 7465 2e20  "memory" state. 
+0000a0a0: 2054 6865 7265 2063 616e 2062 6520 6d6f   There can be mo
+0000a0b0: 7265 2074 6861 6e20 6f6e 6520 776f 726b  re than one work
+0000a0c0: 6572 2069 6e20 7468 6973 2073 6574 2069  er in this set i
+0000a0d0: 662c 0a20 2020 2023 3a20 666f 7220 6578  f,.    #: for ex
+0000a0e0: 616d 706c 652c 203a 6d65 7468 3a60 436c  ample, :meth:`Cl
+0000a0f0: 6965 6e74 2e73 6361 7474 6572 6020 6f72  ient.scatter` or
+0000a100: 203a 6d65 7468 3a60 436c 6965 6e74 2e72   :meth:`Client.r
+0000a110: 6570 6c69 6361 7465 6020 7761 7320 7573  eplicate` was us
+0000a120: 6564 2e0a 2020 2020 233a 0a20 2020 2023  ed..    #:.    #
+0000a130: 3a20 5468 6973 2069 7320 7468 6520 7265  : This is the re
+0000a140: 7665 7273 6520 6d61 7070 696e 6720 6f66  verse mapping of
+0000a150: 203a 6174 7472 3a60 576f 726b 6572 5374   :attr:`WorkerSt
+0000a160: 6174 652e 6861 735f 7768 6174 602e 0a20  ate.has_what`.. 
+0000a170: 2020 2077 686f 5f68 6173 3a20 7365 745b     who_has: set[
+0000a180: 576f 726b 6572 5374 6174 655d 0a0a 2020  WorkerState]..  
+0000a190: 2020 233a 2049 6620 7468 6973 2074 6173    #: If this tas
+0000a1a0: 6b20 6973 2069 6e20 7468 6520 2270 726f  k is in the "pro
+0000a1b0: 6365 7373 696e 6722 2073 7461 7465 2c20  cessing" state, 
+0000a1c0: 7768 6963 6820 776f 726b 6572 2069 7320  which worker is 
+0000a1d0: 6375 7272 656e 746c 7920 7072 6f63 6573  currently proces
+0000a1e0: 7369 6e67 0a20 2020 2023 3a20 6974 2e20  sing.    #: it. 
+0000a1f0: 5468 6973 2061 7474 7269 6275 7465 2069  This attribute i
+0000a200: 7320 6b65 7074 2069 6e20 7379 6e63 2077  s kept in sync w
+0000a210: 6974 6820 3a61 7474 723a 6057 6f72 6b65  ith :attr:`Worke
+0000a220: 7253 7461 7465 2e70 726f 6365 7373 696e  rState.processin
+0000a230: 6760 2e0a 2020 2020 7072 6f63 6573 7369  g`..    processi
+0000a240: 6e67 5f6f 6e3a 2057 6f72 6b65 7253 7461  ng_on: WorkerSta
+0000a250: 7465 207c 204e 6f6e 650a 0a20 2020 2023  te | None..    #
+0000a260: 3a20 5468 6520 6e75 6d62 6572 206f 6620  : The number of 
+0000a270: 7469 6d65 7320 7468 6973 2074 6173 6b20  times this task 
+0000a280: 6361 6e20 6175 746f 6d61 7469 6361 6c6c  can automaticall
+0000a290: 7920 6265 2072 6574 7269 6564 2069 6e20  y be retried in 
+0000a2a0: 6361 7365 206f 6620 6661 696c 7572 652e  case of failure.
+0000a2b0: 0a20 2020 2023 3a20 4966 2061 2074 6173  .    #: If a tas
+0000a2c0: 6b20 6661 696c 7320 6578 6563 7574 696e  k fails executin
+0000a2d0: 6720 2874 6865 2077 6f72 6b65 7220 7265  g (the worker re
+0000a2e0: 7475 726e 7320 7769 7468 2061 6e20 6572  turns with an er
+0000a2f0: 726f 7229 2c20 6974 7320 3a61 7474 723a  ror), its :attr:
+0000a300: 6072 6574 7269 6573 600a 2020 2020 233a  `retries`.    #:
+0000a310: 2061 7474 7269 6275 7465 2069 7320 6368   attribute is ch
+0000a320: 6563 6b65 642e 2049 6620 6974 2069 7320  ecked. If it is 
+0000a330: 6571 7561 6c20 746f 2030 2c20 7468 6520  equal to 0, the 
+0000a340: 7461 736b 2069 7320 6d61 726b 6564 2022  task is marked "
+0000a350: 6572 7265 6422 2e20 4966 2069 7420 6973  erred". If it is
+0000a360: 0a20 2020 2023 3a20 6772 6561 7465 7220  .    #: greater 
+0000a370: 7468 616e 2030 2c20 7468 6520 3a61 7474  than 0, the :att
+0000a380: 723a 6072 6574 7269 6573 6020 6174 7472  r:`retries` attr
+0000a390: 6962 7574 6520 6973 2064 6563 7265 6d65  ibute is decreme
+0000a3a0: 6e74 6564 2061 6e64 2065 7865 6375 7469  nted and executi
+0000a3b0: 6f6e 2069 730a 2020 2020 233a 2061 7474  on is.    #: att
+0000a3c0: 656d 7074 6564 2061 6761 696e 2e0a 2020  empted again..  
+0000a3d0: 2020 7265 7472 6965 733a 2069 6e74 0a0a    retries: int..
+0000a3e0: 2020 2020 233a 2054 6865 206e 756d 6265      #: The numbe
+0000a3f0: 7220 6f66 2062 7974 6573 2c20 6173 2064  r of bytes, as d
+0000a400: 6574 6572 6d69 6e65 6420 6279 2060 6073  etermined by ``s
+0000a410: 697a 656f 6660 602c 206f 6620 7468 6520  izeof``, of the 
+0000a420: 7265 7375 6c74 206f 6620 6120 6669 6e69  result of a fini
+0000a430: 7368 6564 0a20 2020 2023 3a20 7461 736b  shed.    #: task
+0000a440: 2e20 5468 6973 206e 756d 6265 7220 6973  . This number is
+0000a450: 2075 7365 6420 666f 7220 6469 6167 6e6f   used for diagno
+0000a460: 7374 6963 7320 616e 6420 746f 2068 656c  stics and to hel
+0000a470: 7020 7072 696f 7269 7469 7a65 2077 6f72  p prioritize wor
+0000a480: 6b2e 0a20 2020 2023 3a20 5365 7420 746f  k..    #: Set to
+0000a490: 202d 3120 666f 7220 756e 6669 6e69 7368   -1 for unfinish
+0000a4a0: 6564 2074 6173 6b73 2e0a 2020 2020 6e62  ed tasks..    nb
+0000a4b0: 7974 6573 3a20 696e 740a 0a20 2020 2023  ytes: int..    #
+0000a4c0: 3a20 5468 6520 7479 7065 206f 6620 7468  : The type of th
+0000a4d0: 6520 6f62 6a65 6374 2061 7320 6120 7374  e object as a st
+0000a4e0: 7269 6e67 2e20 4f6e 6c79 2070 7265 7365  ring. Only prese
+0000a4f0: 6e74 2066 6f72 2074 6173 6b73 2074 6861  nt for tasks tha
+0000a500: 7420 6861 7665 2062 6565 6e0a 2020 2020  t have been.    
+0000a510: 233a 2063 6f6d 7075 7465 642e 0a20 2020  #: computed..   
+0000a520: 2074 7970 653a 2073 7472 0a0a 2020 2020   type: str..    
+0000a530: 233a 2049 6620 7468 6973 2074 6173 6b20  #: If this task 
+0000a540: 6661 696c 6564 2065 7865 6375 7469 6e67  failed executing
+0000a550: 2c20 7468 6520 6578 6365 7074 696f 6e20  , the exception 
+0000a560: 6f62 6a65 6374 2069 7320 7374 6f72 6564  object is stored
+0000a570: 2068 6572 652e 0a20 2020 2065 7863 6570   here..    excep
+0000a580: 7469 6f6e 3a20 5365 7269 616c 697a 6564  tion: Serialized
+0000a590: 207c 204e 6f6e 650a 0a20 2020 2023 3a20   | None..    #: 
+0000a5a0: 4966 2074 6869 7320 7461 736b 2066 6169  If this task fai
+0000a5b0: 6c65 6420 6578 6563 7574 696e 672c 2074  led executing, t
+0000a5c0: 6865 2074 7261 6365 6261 636b 206f 626a  he traceback obj
+0000a5d0: 6563 7420 6973 2073 746f 7265 6420 6865  ect is stored he
+0000a5e0: 7265 2e0a 2020 2020 7472 6163 6562 6163  re..    tracebac
+0000a5f0: 6b3a 2053 6572 6961 6c69 7a65 6420 7c20  k: Serialized | 
+0000a600: 4e6f 6e65 0a0a 2020 2020 233a 2073 7472  None..    #: str
+0000a610: 696e 6720 7265 7072 6573 656e 7461 7469  ing representati
+0000a620: 6f6e 206f 6620 6578 6365 7074 696f 6e0a  on of exception.
+0000a630: 2020 2020 6578 6365 7074 696f 6e5f 7465      exception_te
+0000a640: 7874 3a20 7374 720a 0a20 2020 2023 3a20  xt: str..    #: 
+0000a650: 7374 7269 6e67 2072 6570 7265 7365 6e74  string represent
+0000a660: 6174 696f 6e20 6f66 2074 7261 6365 6261  ation of traceba
+0000a670: 636b 0a20 2020 2074 7261 6365 6261 636b  ck.    traceback
+0000a680: 5f74 6578 743a 2073 7472 0a0a 2020 2020  _text: str..    
+0000a690: 233a 2049 6620 7468 6973 2074 6173 6b20  #: If this task 
+0000a6a0: 6f72 206f 6e65 206f 6620 6974 7320 6465  or one of its de
+0000a6b0: 7065 6e64 656e 6369 6573 2066 6169 6c65  pendencies faile
+0000a6c0: 6420 6578 6563 7574 696e 672c 2074 6865  d executing, the
+0000a6d0: 2066 6169 6c65 6420 7461 736b 2069 730a   failed task is.
+0000a6e0: 2020 2020 233a 2073 746f 7265 6420 6865      #: stored he
+0000a6f0: 7265 2028 706f 7373 6962 6c79 2069 7473  re (possibly its
+0000a700: 656c 6629 2e0a 2020 2020 6578 6365 7074  elf)..    except
+0000a710: 696f 6e5f 626c 616d 653a 2054 6173 6b53  ion_blame: TaskS
+0000a720: 7461 7465 207c 204e 6f6e 650a 0a20 2020  tate | None..   
+0000a730: 2023 3a20 576f 726b 6572 2061 6464 7265   #: Worker addre
+0000a740: 7373 6573 206f 6e20 7768 6963 6820 6572  sses on which er
+0000a750: 726f 7273 2061 7070 6561 7265 642c 2063  rors appeared, c
+0000a760: 6175 7369 6e67 2074 6869 7320 7461 736b  ausing this task
+0000a770: 2074 6f20 6265 2069 6e20 616e 2065 7272   to be in an err
+0000a780: 6f72 0a20 2020 2023 3a20 7374 6174 652e  or.    #: state.
+0000a790: 0a20 2020 2065 7272 6564 5f6f 6e3a 2073  .    erred_on: s
+0000a7a0: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
+0000a7b0: 5468 6520 6e75 6d62 6572 206f 6620 7469  The number of ti
+0000a7c0: 6d65 7320 7468 6973 2074 6173 6b20 6861  mes this task ha
+0000a7d0: 7320 6265 656e 2069 6e76 6f6c 7665 6420  s been involved 
+0000a7e0: 696e 2061 2077 6f72 6b65 7220 6465 6174  in a worker deat
+0000a7f0: 682e 0a20 2020 2023 3a0a 2020 2020 233a  h..    #:.    #:
+0000a800: 2053 6f6d 6520 7461 736b 7320 6d61 7920   Some tasks may 
+0000a810: 6361 7573 6520 776f 726b 6572 7320 746f  cause workers to
+0000a820: 2064 6965 2028 7375 6368 2061 7320 6361   die (such as ca
+0000a830: 6c6c 696e 6720 6060 6f73 2e5f 6578 6974  lling ``os._exit
+0000a840: 2830 2960 6029 2e20 5768 656e 2061 0a20  (0)``). When a. 
+0000a850: 2020 2023 3a20 776f 726b 6572 2064 6965     #: worker die
+0000a860: 732c 2061 6c6c 206f 6620 7468 6520 7461  s, all of the ta
+0000a870: 736b 7320 6f6e 2074 6861 7420 776f 726b  sks on that work
+0000a880: 6572 2061 7265 2072 6561 7373 6967 6e65  er are reassigne
+0000a890: 6420 746f 206f 7468 6572 732e 2054 6869  d to others. Thi
+0000a8a0: 730a 2020 2020 233a 2063 6f6d 6269 6e61  s.    #: combina
+0000a8b0: 7469 6f6e 206f 6620 6265 6861 7669 6f72  tion of behavior
+0000a8c0: 7320 6361 6e20 6361 7573 6520 6120 6261  s can cause a ba
+0000a8d0: 6420 7461 736b 2074 6f20 6361 7461 7374  d task to catast
+0000a8e0: 726f 7068 6963 616c 6c79 2064 6573 7472  rophically destr
+0000a8f0: 6f79 2061 6c6c 0a20 2020 2023 3a20 776f  oy all.    #: wo
+0000a900: 726b 6572 7320 6f6e 2074 6865 2063 6c75  rkers on the clu
+0000a910: 7374 6572 2c20 6f6e 6520 6166 7465 7220  ster, one after 
+0000a920: 616e 6f74 6865 722e 2057 6865 6e65 7665  another. Wheneve
+0000a930: 7220 6120 776f 726b 6572 2064 6965 732c  r a worker dies,
+0000a940: 2077 6520 6d61 726b 2065 6163 680a 2020   we mark each.  
+0000a950: 2020 233a 2074 6173 6b20 6375 7272 656e    #: task curren
+0000a960: 746c 7920 7072 6f63 6573 7369 6e67 206f  tly processing o
+0000a970: 6e20 7468 6174 2077 6f72 6b65 7220 2861  n that worker (a
+0000a980: 7320 7265 636f 7264 6564 2062 790a 2020  s recorded by.  
+0000a990: 2020 233a 203a 6174 7472 3a60 576f 726b    #: :attr:`Work
+0000a9a0: 6572 5374 6174 652e 7072 6f63 6573 7369  erState.processi
+0000a9b0: 6e67 6029 2061 7320 7375 7370 6963 696f  ng`) as suspicio
+0000a9c0: 7573 2e20 4966 2061 2074 6173 6b20 6973  us. If a task is
+0000a9d0: 2069 6e76 6f6c 7665 6420 696e 2074 6872   involved in thr
+0000a9e0: 6565 0a20 2020 2023 3a20 6465 6174 6873  ee.    #: deaths
+0000a9f0: 2028 6f72 2073 6f6d 6520 6f74 6865 7220   (or some other 
+0000aa00: 6669 7865 6420 636f 6e73 7461 6e74 2920  fixed constant) 
+0000aa10: 7468 656e 2077 6520 6d61 726b 2074 6865  then we mark the
+0000aa20: 2074 6173 6b20 6173 2060 6065 7272 6564   task as ``erred
+0000aa30: 6060 2e0a 2020 2020 7375 7370 6963 696f  ``..    suspicio
+0000aa40: 7573 3a20 696e 740a 0a20 2020 2023 3a20  us: int..    #: 
+0000aa50: 4120 7365 7420 6f66 2068 6f73 746e 616d  A set of hostnam
+0000aa60: 6573 2077 6865 7265 2074 6869 7320 7461  es where this ta
+0000aa70: 736b 2063 616e 2062 6520 7275 6e20 286f  sk can be run (o
+0000aa80: 7220 6060 4e6f 6e65 6060 2069 6620 656d  r ``None`` if em
+0000aa90: 7074 7929 2e20 5573 7561 6c6c 790a 2020  pty). Usually.  
+0000aaa0: 2020 233a 2074 6869 7320 6973 2065 6d70    #: this is emp
+0000aab0: 7479 2075 6e6c 6573 7320 7468 6520 7461  ty unless the ta
+0000aac0: 736b 2068 6173 2062 6565 6e20 7370 6563  sk has been spec
+0000aad0: 6966 6963 616c 6c79 2072 6573 7472 6963  ifically restric
+0000aae0: 7465 6420 746f 206f 6e6c 7920 7275 6e20  ted to only run 
+0000aaf0: 6f6e 0a20 2020 2023 3a20 6365 7274 6169  on.    #: certai
+0000ab00: 6e20 686f 7374 732e 2041 2068 6f73 746e  n hosts. A hostn
+0000ab10: 616d 6520 6d61 7920 636f 7272 6573 706f  ame may correspo
+0000ab20: 6e64 2074 6f20 6f6e 6520 6f72 2073 6576  nd to one or sev
+0000ab30: 6572 616c 2063 6f6e 6e65 6374 6564 2077  eral connected w
+0000ab40: 6f72 6b65 7273 2e0a 2020 2020 686f 7374  orkers..    host
+0000ab50: 5f72 6573 7472 6963 7469 6f6e 733a 2073  _restrictions: s
+0000ab60: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
+0000ab70: 4120 7365 7420 6f66 2063 6f6d 706c 6574  A set of complet
+0000ab80: 6520 776f 726b 6572 2061 6464 7265 7373  e worker address
+0000ab90: 6573 2077 6865 7265 2074 6869 7320 6361  es where this ca
+0000aba0: 6e20 6265 2072 756e 2028 6f72 2060 604e  n be run (or ``N
+0000abb0: 6f6e 6560 6020 6966 2065 6d70 7479 292e  one`` if empty).
+0000abc0: 0a20 2020 2023 3a20 5573 7561 6c6c 7920  .    #: Usually 
+0000abd0: 7468 6973 2069 7320 656d 7074 7920 756e  this is empty un
+0000abe0: 6c65 7373 2074 6865 2074 6173 6b20 6861  less the task ha
+0000abf0: 7320 6265 656e 2073 7065 6369 6669 6361  s been specifica
+0000ac00: 6c6c 7920 7265 7374 7269 6374 6564 2074  lly restricted t
+0000ac10: 6f20 6f6e 6c79 0a20 2020 2023 3a20 7275  o only.    #: ru
+0000ac20: 6e20 6f6e 2063 6572 7461 696e 2077 6f72  n on certain wor
+0000ac30: 6b65 7273 2e0a 2020 2020 233a 204e 6f74  kers..    #: Not
+0000ac40: 6520 7468 6973 2069 7320 7472 6163 6b69  e this is tracki
+0000ac50: 6e67 2077 6f72 6b65 7220 6164 6472 6573  ng worker addres
+0000ac60: 7365 732c 206e 6f74 2077 6f72 6b65 7220  ses, not worker 
+0000ac70: 7374 6174 6573 2c20 7369 6e63 6520 7468  states, since th
+0000ac80: 6520 7370 6563 6966 6963 0a20 2020 2023  e specific.    #
+0000ac90: 3a20 776f 726b 6572 7320 6d61 7920 6e6f  : workers may no
+0000aca0: 7420 6265 2063 6f6e 6e65 6374 6564 2061  t be connected a
+0000acb0: 7420 7468 6973 2074 696d 652e 0a20 2020  t this time..   
+0000acc0: 2077 6f72 6b65 725f 7265 7374 7269 6374   worker_restrict
+0000acd0: 696f 6e73 3a20 7365 745b 7374 725d 0a0a  ions: set[str]..
+0000ace0: 2020 2020 233a 2052 6573 6f75 7263 6573      #: Resources
+0000acf0: 2072 6571 7569 7265 6420 6279 2074 6869   required by thi
+0000ad00: 7320 7461 736b 2c20 7375 6368 2061 7320  s task, such as 
+0000ad10: 6060 7b27 6770 7527 3a20 317d 6060 206f  ``{'gpu': 1}`` o
+0000ad20: 7220 6060 7b27 6d65 6d6f 7279 273a 2031  r ``{'memory': 1
+0000ad30: 6539 7d60 600a 2020 2020 233a 2054 6865  e9}``.    #: The
+0000ad40: 7365 2061 7265 2075 7365 722d 6465 6669  se are user-defi
+0000ad50: 6e65 6420 6e61 6d65 7320 616e 6420 6172  ned names and ar
+0000ad60: 6520 6d61 7463 6865 6420 6167 6169 6e73  e matched agains
+0000ad70: 7420 7468 6520 3a20 636f 6e74 656e 7473  t the : contents
+0000ad80: 206f 6620 6561 6368 0a20 2020 2023 3a20   of each.    #: 
+0000ad90: 3a61 7474 723a 6057 6f72 6b65 7253 7461  :attr:`WorkerSta
+0000ada0: 7465 2e72 6573 6f75 7263 6573 6020 6469  te.resources` di
+0000adb0: 6374 696f 6e61 7279 2e0a 2020 2020 7265  ctionary..    re
+0000adc0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
+0000add0: 6f6e 733a 2064 6963 745b 7374 722c 2066  ons: dict[str, f
+0000ade0: 6c6f 6174 5d0a 0a20 2020 2023 3a20 4661  loat]..    #: Fa
+0000adf0: 6c73 650a 2020 2020 233a 2020 2020 2045  lse.    #:     E
+0000ae00: 6163 6820 6f66 203a 6174 7472 3a60 686f  ach of :attr:`ho
+0000ae10: 7374 5f72 6573 7472 6963 7469 6f6e 7360  st_restrictions`
+0000ae20: 2c20 3a61 7474 723a 6077 6f72 6b65 725f  , :attr:`worker_
+0000ae30: 7265 7374 7269 6374 696f 6e73 6020 616e  restrictions` an
+0000ae40: 640a 2020 2020 233a 2020 2020 203a 6174  d.    #:     :at
+0000ae50: 7472 3a60 7265 736f 7572 6365 5f72 6573  tr:`resource_res
+0000ae60: 7472 6963 7469 6f6e 7360 2069 7320 6120  trictions` is a 
+0000ae70: 6861 7264 2063 6f6e 7374 7261 696e 743a  hard constraint:
+0000ae80: 2069 6620 6e6f 2077 6f72 6b65 7220 6973   if no worker is
+0000ae90: 2061 7661 696c 6162 6c65 0a20 2020 2023   available.    #
+0000aea0: 3a20 2020 2020 7361 7469 7366 7969 6e67  :     satisfying
+0000aeb0: 2074 686f 7365 2072 6573 7472 6963 7469   those restricti
+0000aec0: 6f6e 732c 2074 6865 2074 6173 6b20 6361  ons, the task ca
+0000aed0: 6e6e 6f74 2067 6f20 696e 746f 2074 6865  nnot go into the
+0000aee0: 2022 7072 6f63 6573 7369 6e67 2220 7374   "processing" st
+0000aef0: 6174 650a 2020 2020 233a 2020 2020 2061  ate.    #:     a
+0000af00: 6e64 2077 696c 6c20 696e 7374 6561 6420  nd will instead 
+0000af10: 676f 2069 6e74 6f20 7468 6520 226e 6f2d  go into the "no-
+0000af20: 776f 726b 6572 2220 7374 6174 652e 0a20  worker" state.. 
+0000af30: 2020 2023 3a20 5472 7565 0a20 2020 2023     #: True.    #
+0000af40: 3a20 2020 2020 5468 6520 6162 6f76 6520  :     The above 
+0000af50: 7265 7374 7269 6374 696f 6e73 2061 7265  restrictions are
+0000af60: 206d 6572 6520 7072 6566 6572 656e 6365   mere preference
+0000af70: 733a 2069 6620 6e6f 2077 6f72 6b65 7220  s: if no worker 
+0000af80: 6973 2061 7661 696c 6162 6c65 0a20 2020  is available.   
+0000af90: 2023 3a20 2020 2020 7361 7469 7366 7969   #:     satisfyi
+0000afa0: 6e67 2074 686f 7365 2072 6573 7472 6963  ng those restric
+0000afb0: 7469 6f6e 732c 2074 6865 2074 6173 6b20  tions, the task 
+0000afc0: 6361 6e20 7374 696c 6c20 676f 2069 6e74  can still go int
+0000afd0: 6f20 7468 650a 2020 2020 233a 2020 2020  o the.    #:    
+0000afe0: 2022 7072 6f63 6573 7369 6e67 2220 7374   "processing" st
+0000aff0: 6174 6520 616e 6420 6265 2073 656e 7420  ate and be sent 
+0000b000: 666f 7220 6578 6563 7574 696f 6e20 746f  for execution to
+0000b010: 2061 6e6f 7468 6572 2063 6f6e 6e65 6374   another connect
+0000b020: 6564 2077 6f72 6b65 722e 0a20 2020 206c  ed worker..    l
+0000b030: 6f6f 7365 5f72 6573 7472 6963 7469 6f6e  oose_restriction
+0000b040: 733a 2062 6f6f 6c0a 0a20 2020 2023 3a20  s: bool..    #: 
+0000b050: 5768 6574 6865 7220 7468 6973 2074 6173  Whether this tas
+0000b060: 6b20 6973 2061 6e20 4163 746f 720a 2020  k is an Actor.  
+0000b070: 2020 6163 746f 723a 2062 6f6f 6c0a 0a20    actor: bool.. 
+0000b080: 2020 2023 3a20 5468 6520 6772 6f75 7020     #: The group 
+0000b090: 6f66 2074 6173 6b73 2074 6f20 7768 6963  of tasks to whic
+0000b0a0: 6820 7468 6973 206f 6e65 2062 656c 6f6e  h this one belon
+0000b0b0: 6773 0a20 2020 2067 726f 7570 3a20 5461  gs.    group: Ta
+0000b0c0: 736b 4772 6f75 700a 0a20 2020 2023 3a20  skGroup..    #: 
+0000b0d0: 5361 6d65 2061 7320 6f66 2067 726f 7570  Same as of group
+0000b0e0: 2e6e 616d 650a 2020 2020 6772 6f75 705f  .name.    group_
+0000b0f0: 6b65 793a 2073 7472 0a0a 2020 2020 233a  key: str..    #:
+0000b100: 204d 6574 6164 6174 6120 7265 6c61 7465   Metadata relate
+0000b110: 6420 746f 2074 6173 6b0a 2020 2020 6d65  d to task.    me
+0000b120: 7461 6461 7461 3a20 6469 6374 5b73 7472  tadata: dict[str
+0000b130: 2c20 416e 795d 0a0a 2020 2020 233a 2054  , Any]..    #: T
+0000b140: 6173 6b20 616e 6e6f 7461 7469 6f6e 730a  ask annotations.
+0000b150: 2020 2020 616e 6e6f 7461 7469 6f6e 733a      annotations:
+0000b160: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
+0000b170: 0a20 2020 2023 3a20 5468 6520 756e 6971  .    #: The uniq
+0000b180: 7565 2069 6465 6e74 6966 6965 7220 6f66  ue identifier of
+0000b190: 2061 2073 7065 6369 6669 6320 6578 6563   a specific exec
+0000b1a0: 7574 696f 6e20 6f66 2061 2074 6173 6b2e  ution of a task.
+0000b1b0: 2054 6869 7320 6964 656e 7469 6669 6572   This identifier
+0000b1c0: 0a20 2020 2023 3a20 6973 2075 7365 6420  .    #: is used 
+0000b1d0: 746f 2073 6967 6e20 6120 7461 736b 2073  to sign a task s
+0000b1e0: 7563 6820 7468 6174 2074 6865 2061 7373  uch that the ass
+0000b1f0: 6967 6e65 6420 776f 726b 6572 2069 7320  igned worker is 
+0000b200: 6578 7065 6374 6564 2074 6f20 7265 7475  expected to retu
+0000b210: 726e 0a20 2020 2023 3a20 7468 6520 7361  rn.    #: the sa
+0000b220: 6d65 2069 6465 6e74 6966 6965 7220 696e  me identifier in
+0000b230: 2074 6865 2074 6173 6b2d 6669 6e69 7368   the task-finish
+0000b240: 6564 206d 6573 7361 6765 2e20 5468 6973  ed message. This
+0000b250: 2069 7320 7573 6564 2074 6f20 636f 7272   is used to corr
+0000b260: 656c 6174 650a 2020 2020 233a 2072 6573  elate.    #: res
+0000b270: 706f 6e73 6573 2e0a 2020 2020 233a 204f  ponses..    #: O
+0000b280: 6e6c 7920 7468 6520 6d6f 7374 2072 6563  nly the most rec
+0000b290: 656e 746c 7920 6173 7369 676e 6564 2077  ently assigned w
+0000b2a0: 6f72 6b65 7220 6973 2074 7275 7374 6564  orker is trusted
+0000b2b0: 2e20 416c 6c20 6f74 6865 7220 7265 7375  . All other resu
+0000b2c0: 6c74 7320 7769 6c6c 0a20 2020 2023 3a20  lts will.    #: 
+0000b2d0: 6265 2072 656a 6563 7465 642e 0a20 2020  be rejected..   
+0000b2e0: 2072 756e 5f69 643a 2069 6e74 207c 204e   run_id: int | N
+0000b2f0: 6f6e 650a 0a20 2020 2023 3a20 4361 6368  one..    #: Cach
+0000b300: 6564 2068 6173 6820 6f66 203a 6174 7472  ed hash of :attr
+0000b310: 3a60 7e54 6173 6b53 7461 7465 2e63 6c69  :`~TaskState.cli
+0000b320: 656e 745f 6b65 7960 0a20 2020 205f 6861  ent_key`.    _ha
+0000b330: 7368 3a20 696e 740a 0a20 2020 2023 2053  sh: int..    # S
+0000b340: 7570 706f 7274 2066 6f72 2077 6561 6b72  upport for weakr
+0000b350: 6566 7320 746f 2061 2063 6c61 7373 2077  efs to a class w
+0000b360: 6974 6820 5f5f 736c 6f74 735f 5f0a 2020  ith __slots__.  
+0000b370: 2020 5f5f 7765 616b 7265 665f 5f3a 2041    __weakref__: A
+0000b380: 6e79 203d 204e 6f6e 650a 2020 2020 5f5f  ny = None.    __
+0000b390: 736c 6f74 735f 5f20 3d20 7475 706c 6528  slots__ = tuple(
+0000b3a0: 5f5f 616e 6e6f 7461 7469 6f6e 735f 5f29  __annotations__)
+0000b3b0: 0a0a 2020 2020 233a 2047 6c6f 6261 6c20  ..    #: Global 
+0000b3c0: 6974 6572 6174 6f72 2075 7365 6420 746f  iterator used to
+0000b3d0: 2063 7265 6174 6520 756e 6971 7565 2074   create unique t
+0000b3e0: 6173 6b20 7275 6e20 4944 730a 2020 2020  ask run IDs.    
+0000b3f0: 5f72 756e 5f69 645f 6974 6572 6174 6f72  _run_id_iterator
+0000b400: 3a20 436c 6173 7356 6172 5b69 7465 7274  : ClassVar[itert
+0000b410: 6f6f 6c73 2e63 6f75 6e74 5d20 3d20 6974  ools.count] = it
+0000b420: 6572 746f 6f6c 732e 636f 756e 7428 290a  ertools.count().
+0000b430: 0a20 2020 2023 2049 6e73 7461 6e63 6573  .    # Instances
+0000b440: 206e 6f74 2070 6172 7420 6f66 2073 6c6f   not part of slo
+0000b450: 7473 2073 696e 6365 2063 6c61 7373 2076  ts since class v
+0000b460: 6172 6961 626c 650a 2020 2020 5f69 6e73  ariable.    _ins
+0000b470: 7461 6e63 6573 3a20 436c 6173 7356 6172  tances: ClassVar
+0000b480: 5b77 6561 6b72 6566 2e57 6561 6b53 6574  [weakref.WeakSet
+0000b490: 5b54 6173 6b53 7461 7465 5d5d 203d 2077  [TaskState]] = w
+0000b4a0: 6561 6b72 6566 2e57 6561 6b53 6574 2829  eakref.WeakSet()
+0000b4b0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+0000b4c0: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
+0000b4d0: 2c0a 2020 2020 2020 2020 6b65 793a 2073  ,.        key: s
+0000b4e0: 7472 2c0a 2020 2020 2020 2020 7275 6e5f  tr,.        run_
+0000b4f0: 7370 6563 3a20 6f62 6a65 6374 2c0a 2020  spec: object,.  
+0000b500: 2020 2020 2020 7374 6174 653a 2054 6173        state: Tas
+0000b510: 6b53 7461 7465 5374 6174 652c 0a20 2020  kStateState,.   
+0000b520: 2029 3a0a 2020 2020 2020 2020 7365 6c66   ):.        self
+0000b530: 2e6b 6579 203d 206b 6579 0a20 2020 2020  .key = key.     
+0000b540: 2020 2073 656c 662e 5f68 6173 6820 3d20     self._hash = 
+0000b550: 6861 7368 286b 6579 290a 2020 2020 2020  hash(key).      
+0000b560: 2020 7365 6c66 2e72 756e 5f73 7065 6320    self.run_spec 
+0000b570: 3d20 7275 6e5f 7370 6563 0a20 2020 2020  = run_spec.     
+0000b580: 2020 2073 656c 662e 5f73 7461 7465 203d     self._state =
+0000b590: 2073 7461 7465 0a20 2020 2020 2020 2073   state.        s
+0000b5a0: 656c 662e 6578 6365 7074 696f 6e20 3d20  elf.exception = 
+0000b5b0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+0000b5c0: 662e 6578 6365 7074 696f 6e5f 626c 616d  f.exception_blam
+0000b5d0: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
+0000b5e0: 2073 656c 662e 7472 6163 6562 6163 6b20   self.traceback 
+0000b5f0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+0000b600: 656c 662e 6578 6365 7074 696f 6e5f 7465  elf.exception_te
+0000b610: 7874 203d 2022 220a 2020 2020 2020 2020  xt = "".        
+0000b620: 7365 6c66 2e74 7261 6365 6261 636b 5f74  self.traceback_t
+0000b630: 6578 7420 3d20 2222 0a20 2020 2020 2020  ext = "".       
+0000b640: 2073 656c 662e 7375 7370 6963 696f 7573   self.suspicious
+0000b650: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0000b660: 662e 7265 7472 6965 7320 3d20 300a 2020  f.retries = 0.  
+0000b670: 2020 2020 2020 7365 6c66 2e6e 6279 7465        self.nbyte
+0000b680: 7320 3d20 2d31 0a20 2020 2020 2020 2073  s = -1.        s
+0000b690: 656c 662e 7072 696f 7269 7479 203d 204e  elf.priority = N
+0000b6a0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0000b6b0: 2e77 686f 5f77 616e 7473 203d 2073 6574  .who_wants = set
+0000b6c0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0000b6d0: 6465 7065 6e64 656e 6369 6573 203d 2073  dependencies = s
+0000b6e0: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+0000b6f0: 662e 6465 7065 6e64 656e 7473 203d 2073  f.dependents = s
+0000b700: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+0000b710: 662e 7761 6974 696e 675f 6f6e 203d 2073  f.waiting_on = s
+0000b720: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+0000b730: 662e 7761 6974 6572 7320 3d20 7365 7428  f.waiters = set(
+0000b740: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+0000b750: 686f 5f68 6173 203d 2073 6574 2829 0a20  ho_has = set(). 
+0000b760: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
+0000b770: 6573 7369 6e67 5f6f 6e20 3d20 4e6f 6e65  essing_on = None
+0000b780: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+0000b790: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
+0000b7a0: 6965 7320 3d20 4661 6c73 650a 2020 2020  ies = False.    
+0000b7b0: 2020 2020 7365 6c66 2e68 6f73 745f 7265      self.host_re
+0000b7c0: 7374 7269 6374 696f 6e73 203d 2073 6574  strictions = set
+0000b7d0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0000b7e0: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
+0000b7f0: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
+0000b800: 2020 2020 7365 6c66 2e72 6573 6f75 7263      self.resourc
+0000b810: 655f 7265 7374 7269 6374 696f 6e73 203d  e_restrictions =
+0000b820: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+0000b830: 2e6c 6f6f 7365 5f72 6573 7472 6963 7469  .loose_restricti
+0000b840: 6f6e 7320 3d20 4661 6c73 650a 2020 2020  ons = False.    
+0000b850: 2020 2020 7365 6c66 2e61 6374 6f72 203d      self.actor =
+0000b860: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
+0000b870: 656c 662e 7072 6566 6978 203d 204e 6f6e  elf.prefix = Non
+0000b880: 6520 2023 2074 7970 653a 2069 676e 6f72  e  # type: ignor
+0000b890: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
+0000b8a0: 7970 6520 3d20 4e6f 6e65 2020 2320 7479  ype = None  # ty
+0000b8b0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+0000b8c0: 2020 2073 656c 662e 6772 6f75 705f 6b65     self.group_ke
+0000b8d0: 7920 3d20 6b65 795f 7370 6c69 745f 6772  y = key_split_gr
+0000b8e0: 6f75 7028 6b65 7929 0a20 2020 2020 2020  oup(key).       
+0000b8f0: 2073 656c 662e 6772 6f75 7020 3d20 4e6f   self.group = No
+0000b900: 6e65 2020 2320 7479 7065 3a20 6967 6e6f  ne  # type: igno
+0000b910: 7265 0a20 2020 2020 2020 2073 656c 662e  re.        self.
+0000b920: 6d65 7461 6461 7461 203d 207b 7d0a 2020  metadata = {}.  
+0000b930: 2020 2020 2020 7365 6c66 2e61 6e6e 6f74        self.annot
+0000b940: 6174 696f 6e73 203d 207b 7d0a 2020 2020  ations = {}.    
+0000b950: 2020 2020 7365 6c66 2e65 7272 6564 5f6f      self.erred_o
+0000b960: 6e20 3d20 7365 7428 290a 2020 2020 2020  n = set().      
+0000b970: 2020 7365 6c66 2e72 756e 5f69 6420 3d20    self.run_id = 
+0000b980: 4e6f 6e65 0a20 2020 2020 2020 2054 6173  None.        Tas
+0000b990: 6b53 7461 7465 2e5f 696e 7374 616e 6365  kState._instance
+0000b9a0: 732e 6164 6428 7365 6c66 290a 0a20 2020  s.add(self)..   
+0000b9b0: 2064 6566 205f 5f68 6173 685f 5f28 7365   def __hash__(se
+0000b9c0: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+0000b9d0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000b9e0: 5f68 6173 680a 0a20 2020 2064 6566 205f  _hash..    def _
+0000b9f0: 5f65 715f 5f28 7365 6c66 2c20 6f74 6865  _eq__(self, othe
+0000ba00: 723a 206f 626a 6563 7429 202d 3e20 626f  r: object) -> bo
+0000ba10: 6f6c 3a0a 2020 2020 2020 2020 7265 7475  ol:.        retu
+0000ba20: 726e 2069 7369 6e73 7461 6e63 6528 6f74  rn isinstance(ot
+0000ba30: 6865 722c 2054 6173 6b53 7461 7465 2920  her, TaskState) 
+0000ba40: 616e 6420 7365 6c66 2e6b 6579 203d 3d20  and self.key == 
+0000ba50: 6f74 6865 722e 6b65 790a 0a20 2020 2040  other.key..    @
+0000ba60: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0000ba70: 2073 7461 7465 2873 656c 6629 202d 3e20   state(self) -> 
+0000ba80: 5461 736b 5374 6174 6553 7461 7465 3a0a  TaskStateState:.
+0000ba90: 2020 2020 2020 2020 2222 2254 6869 7320          """This 
+0000baa0: 7461 736b 2773 2063 7572 7265 6e74 2073  task's current s
+0000bab0: 7461 7465 2e20 2056 616c 6964 2073 7461  tate.  Valid sta
+0000bac0: 7465 7320 6172 6520 6060 7265 6c65 6173  tes are ``releas
+0000bad0: 6564 6060 2c20 6060 7761 6974 696e 6760  ed``, ``waiting`
+0000bae0: 602c 0a20 2020 2020 2020 2060 606e 6f2d  `,.        ``no-
+0000baf0: 776f 726b 6572 6060 2c20 6060 7072 6f63  worker``, ``proc
+0000bb00: 6573 7369 6e67 6060 2c20 6060 6d65 6d6f  essing``, ``memo
+0000bb10: 7279 6060 2c20 6060 6572 7265 6460 6020  ry``, ``erred`` 
+0000bb20: 616e 6420 6060 666f 7267 6f74 7465 6e60  and ``forgotten`
+0000bb30: 602e 2020 4966 2069 740a 2020 2020 2020  `.  If it.      
+0000bb40: 2020 6973 2060 6066 6f72 676f 7474 656e    is ``forgotten
+0000bb50: 6060 2c20 7468 6520 7461 736b 2069 736e  ``, the task isn
+0000bb60: 2774 2073 746f 7265 6420 696e 2074 6865  't stored in the
+0000bb70: 2060 6074 6173 6b73 6060 2064 6963 7469   ``tasks`` dicti
+0000bb80: 6f6e 6172 7920 616e 796d 6f72 6520 616e  onary anymore an
+0000bb90: 640a 2020 2020 2020 2020 7769 6c6c 2070  d.        will p
+0000bba0: 726f 6261 626c 7920 6469 7361 7070 6561  robably disappea
+0000bbb0: 7220 736f 6f6e 2066 726f 6d20 6d65 6d6f  r soon from memo
+0000bbc0: 7279 2e0a 2020 2020 2020 2020 2222 220a  ry..        """.
+0000bbd0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000bbe0: 656c 662e 5f73 7461 7465 0a0a 2020 2020  elf._state..    
+0000bbf0: 4073 7461 7465 2e73 6574 7465 720a 2020  @state.setter.  
+0000bc00: 2020 6465 6620 7374 6174 6528 7365 6c66    def state(self
+0000bc10: 2c20 7661 6c75 653a 2054 6173 6b53 7461  , value: TaskSta
+0000bc20: 7465 5374 6174 6529 202d 3e20 4e6f 6e65  teState) -> None
+0000bc30: 3a0a 2020 2020 2020 2020 7365 6c66 2e67  :.        self.g
+0000bc40: 726f 7570 2e73 7461 7465 735b 7365 6c66  roup.states[self
+0000bc50: 2e5f 7374 6174 655d 202d 3d20 310a 2020  ._state] -= 1.  
+0000bc60: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
+0000bc70: 2e73 7461 7465 735b 7661 6c75 655d 202b  .states[value] +
+0000bc80: 3d20 310a 2020 2020 2020 2020 7365 6c66  = 1.        self
+0000bc90: 2e5f 7374 6174 6520 3d20 7661 6c75 650a  ._state = value.
+0000bca0: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
+0000bcb0: 6669 782e 7374 6174 655f 636f 756e 7473  fix.state_counts
+0000bcc0: 5b76 616c 7565 5d20 2b3d 2031 0a0a 2020  [value] += 1..  
+0000bcd0: 2020 6465 6620 6164 645f 6465 7065 6e64    def add_depend
+0000bce0: 656e 6379 2873 656c 662c 206f 7468 6572  ency(self, other
+0000bcf0: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+0000bd00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0000bd10: 2241 6464 2061 6e6f 7468 6572 2074 6173  "Add another tas
+0000bd20: 6b20 6173 2061 2064 6570 656e 6465 6e63  k as a dependenc
+0000bd30: 7920 6f66 2074 6869 7320 7461 736b 2222  y of this task""
+0000bd40: 220a 2020 2020 2020 2020 7365 6c66 2e64  ".        self.d
+0000bd50: 6570 656e 6465 6e63 6965 732e 6164 6428  ependencies.add(
+0000bd60: 6f74 6865 7229 0a20 2020 2020 2020 2073  other).        s
+0000bd70: 656c 662e 6772 6f75 702e 6465 7065 6e64  elf.group.depend
+0000bd80: 656e 6369 6573 2e61 6464 286f 7468 6572  encies.add(other
+0000bd90: 2e67 726f 7570 290a 2020 2020 2020 2020  .group).        
+0000bda0: 6f74 6865 722e 6465 7065 6e64 656e 7473  other.dependents
+0000bdb0: 2e61 6464 2873 656c 6629 0a0a 2020 2020  .add(self)..    
+0000bdc0: 6465 6620 6765 745f 6e62 7974 6573 2873  def get_nbytes(s
+0000bdd0: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
+0000bde0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000bdf0: 2e6e 6279 7465 7320 6966 2073 656c 662e  .nbytes if self.
+0000be00: 6e62 7974 6573 203e 3d20 3020 656c 7365  nbytes >= 0 else
+0000be10: 2044 4546 4155 4c54 5f44 4154 415f 5349   DEFAULT_DATA_SI
+0000be20: 5a45 0a0a 2020 2020 6465 6620 7365 745f  ZE..    def set_
+0000be30: 6e62 7974 6573 2873 656c 662c 206e 6279  nbytes(self, nby
+0000be40: 7465 733a 2069 6e74 2920 2d3e 204e 6f6e  tes: int) -> Non
+0000be50: 653a 0a20 2020 2020 2020 2064 6966 6620  e:.        diff 
+0000be60: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
+0000be70: 206f 6c64 5f6e 6279 7465 7320 3d20 7365   old_nbytes = se
+0000be80: 6c66 2e6e 6279 7465 730a 2020 2020 2020  lf.nbytes.      
+0000be90: 2020 6966 206f 6c64 5f6e 6279 7465 7320    if old_nbytes 
+0000bea0: 3e3d 2030 3a0a 2020 2020 2020 2020 2020  >= 0:.          
+0000beb0: 2020 6469 6666 202d 3d20 6f6c 645f 6e62    diff -= old_nb
+0000bec0: 7974 6573 0a20 2020 2020 2020 2073 656c  ytes.        sel
+0000bed0: 662e 6772 6f75 702e 6e62 7974 6573 5f74  f.group.nbytes_t
+0000bee0: 6f74 616c 202b 3d20 6469 6666 0a20 2020  otal += diff.   
+0000bef0: 2020 2020 2066 6f72 2077 7320 696e 2073       for ws in s
+0000bf00: 656c 662e 7768 6f5f 6861 733a 0a20 2020  elf.who_has:.   
+0000bf10: 2020 2020 2020 2020 2077 732e 6e62 7974           ws.nbyt
+0000bf20: 6573 202b 3d20 6469 6666 0a20 2020 2020  es += diff.     
+0000bf30: 2020 2073 656c 662e 6e62 7974 6573 203d     self.nbytes =
+0000bf40: 206e 6279 7465 730a 0a20 2020 2064 6566   nbytes..    def
+0000bf50: 205f 5f72 6570 725f 5f28 7365 6c66 2920   __repr__(self) 
+0000bf60: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+0000bf70: 7265 7475 726e 2066 223c 5461 736b 5374  return f"<TaskSt
+0000bf80: 6174 6520 7b73 656c 662e 6b65 7921 727d  ate {self.key!r}
+0000bf90: 207b 7365 6c66 2e5f 7374 6174 657d 3e22   {self._state}>"
+0000bfa0: 0a0a 2020 2020 6465 6620 5f72 6570 725f  ..    def _repr_
+0000bfb0: 6874 6d6c 5f28 7365 6c66 2920 2d3e 2073  html_(self) -> s
+0000bfc0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+0000bfd0: 726e 2067 6574 5f74 656d 706c 6174 6528  rn get_template(
+0000bfe0: 2274 6173 6b5f 7374 6174 652e 6874 6d6c  "task_state.html
+0000bff0: 2e6a 3222 292e 7265 6e64 6572 280a 2020  .j2").render(.  
+0000c000: 2020 2020 2020 2020 2020 7374 6174 653d            state=
+0000c010: 7365 6c66 2e73 7461 7465 2c0a 2020 2020  self.state,.    
+0000c020: 2020 2020 2020 2020 6e62 7974 6573 3d73          nbytes=s
+0000c030: 656c 662e 6e62 7974 6573 2c0a 2020 2020  elf.nbytes,.    
+0000c040: 2020 2020 2020 2020 6b65 793d 7365 6c66          key=self
+0000c050: 2e6b 6579 2c0a 2020 2020 2020 2020 290a  .key,.        ).
+0000c060: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
+0000c070: 6528 7365 6c66 2920 2d3e 204e 6f6e 653a  e(self) -> None:
+0000c080: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0000c090: 2020 2020 2020 2020 2020 666f 7220 6373            for cs
+0000c0a0: 2069 6e20 7365 6c66 2e77 686f 5f77 616e   in self.who_wan
+0000c0b0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0000c0c0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0000c0d0: 7461 6e63 6528 6373 2c20 436c 6965 6e74  tance(cs, Client
+0000c0e0: 5374 6174 6529 2c20 2872 6570 7228 6373  State), (repr(cs
+0000c0f0: 292c 2073 656c 662e 7768 6f5f 7761 6e74  ), self.who_want
+0000c100: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
+0000c110: 6f72 2077 7320 696e 2073 656c 662e 7768  or ws in self.wh
+0000c120: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+0000c130: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+0000c140: 696e 7374 616e 6365 2877 732c 2057 6f72  instance(ws, Wor
+0000c150: 6b65 7253 7461 7465 292c 2028 7265 7072  kerState), (repr
+0000c160: 2877 7329 2c20 7365 6c66 2e77 686f 5f68  (ws), self.who_h
+0000c170: 6173 290a 2020 2020 2020 2020 2020 2020  as).            
 0000c180: 666f 7220 7473 2069 6e20 7365 6c66 2e64  for ts in self.d
-0000c190: 6570 656e 6465 6e74 733a 0a20 2020 2020  ependents:.     
-0000c1a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000c1b0: 7420 6973 696e 7374 616e 6365 2874 732c  t isinstance(ts,
-0000c1c0: 2054 6173 6b53 7461 7465 292c 2028 7265   TaskState), (re
-0000c1d0: 7072 2874 7329 2c20 7365 6c66 2e64 6570  pr(ts), self.dep
-0000c1e0: 656e 6465 6e74 7329 0a20 2020 2020 2020  endents).       
-0000c1f0: 2020 2020 2076 616c 6964 6174 655f 7461       validate_ta
-0000c200: 736b 5f73 7461 7465 2873 656c 6629 0a20  sk_state(self). 
-0000c210: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0000c220: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-0000c230: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0000c240: 2e65 7863 6570 7469 6f6e 2865 290a 2020  .exception(e).  
-0000c250: 2020 2020 2020 2020 2020 6966 204c 4f47            if LOG
-0000c260: 5f50 4442 3a0a 2020 2020 2020 2020 2020  _PDB:.          
-0000c270: 2020 2020 2020 696d 706f 7274 2070 6462        import pdb
-0000c280: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000c290: 2020 7064 622e 7365 745f 7472 6163 6528    pdb.set_trace(
-0000c2a0: 290a 0a20 2020 2064 6566 2067 6574 5f6e  )..    def get_n
-0000c2b0: 6279 7465 735f 6465 7073 2873 656c 6629  bytes_deps(self)
-0000c2c0: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-0000c2d0: 2072 6574 7572 6e20 7375 6d28 7473 2e67   return sum(ts.g
-0000c2e0: 6574 5f6e 6279 7465 7328 2920 666f 7220  et_nbytes() for 
-0000c2f0: 7473 2069 6e20 7365 6c66 2e64 6570 656e  ts in self.depen
-0000c300: 6465 6e63 6965 7329 0a0a 2020 2020 6465  dencies)..    de
-0000c310: 6620 5f74 6f5f 6469 6374 5f6e 6f5f 6e65  f _to_dict_no_ne
-0000c320: 7374 2873 656c 662c 202a 2c20 6578 636c  st(self, *, excl
-0000c330: 7564 653a 2043 6f6e 7461 696e 6572 5b73  ude: Container[s
-0000c340: 7472 5d20 3d20 2829 2920 2d3e 2064 6963  tr] = ()) -> dic
-0000c350: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
-0000c360: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
-0000c370: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
-0000c380: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
-0000c390: 7075 7270 6f73 6573 2e0a 2020 2020 2020  purposes..      
-0000c3a0: 2020 4e6f 7420 7479 7065 2073 7461 626c    Not type stabl
-0000c3b0: 6520 616e 6420 6e6f 7420 696e 7465 6e64  e and not intend
-0000c3c0: 6564 2066 6f72 2072 6f75 6e64 7472 6970  ed for roundtrip
-0000c3d0: 732e 0a0a 2020 2020 2020 2020 5365 6520  s...        See 
-0000c3e0: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
-0000c3f0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436c  -----.        Cl
-0000c400: 6965 6e74 2e64 756d 705f 636c 7573 7465  ient.dump_cluste
-0000c410: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
-0000c420: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
-0000c430: 732e 7265 6375 7273 6976 655f 746f 5f64  s.recursive_to_d
-0000c440: 6963 740a 0a20 2020 2020 2020 204e 6f74  ict..        Not
-0000c450: 6573 0a20 2020 2020 2020 202d 2d2d 2d2d  es.        -----
-0000c460: 0a20 2020 2020 2020 2054 6869 7320 636c  .        This cl
-0000c470: 6173 7320 7573 6573 2060 605f 746f 5f64  ass uses ``_to_d
-0000c480: 6963 745f 6e6f 5f6e 6573 7460 6020 696e  ict_no_nest`` in
-0000c490: 7374 6561 6420 6f66 2060 605f 746f 5f64  stead of ``_to_d
-0000c4a0: 6963 7460 602e 0a20 2020 2020 2020 2057  ict``..        W
-0000c4b0: 6865 6e20 6120 7461 736b 2072 6566 6572  hen a task refer
-0000c4c0: 656e 6365 7320 616e 6f74 6865 7220 7461  ences another ta
-0000c4d0: 736b 2c20 6f72 2077 6865 6e20 6120 576f  sk, or when a Wo
-0000c4e0: 726b 6572 5374 6174 652e 7461 736b 7320  rkerState.tasks 
-0000c4f0: 636f 6e74 6169 6e73 2074 6173 6b73 2c0a  contains tasks,.
-0000c500: 2020 2020 2020 2020 7468 6973 206d 6574          this met
-0000c510: 686f 6420 6973 206e 6f74 2065 7865 6375  hod is not execu
-0000c520: 7465 6420 666f 7220 7468 6520 696e 6e65  ted for the inne
-0000c530: 7220 7461 736b 2c20 6576 656e 2069 6620  r task, even if 
-0000c540: 7468 6520 696e 6e65 7220 7461 736b 2077  the inner task w
-0000c550: 6173 206e 6576 6572 0a20 2020 2020 2020  as never.       
-0000c560: 2073 6565 6e20 6265 666f 7265 3b20 796f   seen before; yo
-0000c570: 7520 6765 7420 6120 7265 7072 2069 6e73  u get a repr ins
-0000c580: 7465 6164 2e20 416c 6c20 7461 736b 7320  tead. All tasks 
-0000c590: 7368 6f75 6c64 206e 6561 746c 7920 6170  should neatly ap
-0000c5a0: 7065 6172 2075 6e64 6572 0a20 2020 2020  pear under.     
-0000c5b0: 2020 2053 6368 6564 756c 6572 2e74 6173     Scheduler.tas
-0000c5c0: 6b73 2e20 5468 6973 2061 6c73 6f20 7072  ks. This also pr
-0000c5d0: 6576 656e 7473 2061 2052 6563 7572 7369  events a Recursi
-0000c5e0: 6f6e 4572 726f 7220 6475 7269 6e67 2070  onError during p
-0000c5f0: 6172 7469 6375 6c61 726c 7920 6865 6176  articularly heav
-0000c600: 790a 2020 2020 2020 2020 6c6f 6164 732c  y.        loads,
-0000c610: 2077 6869 6368 2068 6176 6520 6265 656e   which have been
-0000c620: 206f 6273 6572 7665 6420 746f 2068 6170   observed to hap
-0000c630: 7065 6e20 7768 656e 6576 6572 2074 6865  pen whenever the
-0000c640: 7265 2773 2061 6e20 6163 7963 6c69 6320  re's an acyclic 
-0000c650: 6465 7065 6e64 656e 6379 0a20 2020 2020  dependency.     
-0000c660: 2020 2063 6861 696e 206f 6620 7e32 3030     chain of ~200
-0000c670: 2b20 7461 736b 732e 0a20 2020 2020 2020  + tasks..       
-0000c680: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-0000c690: 7572 6e20 7265 6375 7273 6976 655f 746f  urn recursive_to
-0000c6a0: 5f64 6963 7428 7365 6c66 2c20 6578 636c  _dict(self, excl
-0000c6b0: 7564 653d 6578 636c 7564 652c 206d 656d  ude=exclude, mem
-0000c6c0: 6265 7273 3d54 7275 6529 0a0a 0a63 6c61  bers=True)...cla
-0000c6d0: 7373 2054 7261 6e73 6974 696f 6e28 4e61  ss Transition(Na
-0000c6e0: 6d65 6454 7570 6c65 293a 0a20 2020 2022  medTuple):.    "
-0000c6f0: 2222 416e 2065 6e74 7279 2069 6e20 3a61  ""An entry in :a
-0000c700: 7474 723a 6053 6368 6564 756c 6572 5374  ttr:`SchedulerSt
-0000c710: 6174 652e 7472 616e 7369 7469 6f6e 5f6c  ate.transition_l
-0000c720: 6f67 6022 2222 0a0a 2020 2020 6b65 793a  og`"""..    key:
-0000c730: 2073 7472 0a20 2020 2073 7461 7274 3a20   str.    start: 
-0000c740: 5461 736b 5374 6174 6553 7461 7465 0a20  TaskStateState. 
-0000c750: 2020 2066 696e 6973 683a 2054 6173 6b53     finish: TaskS
-0000c760: 7461 7465 5374 6174 650a 2020 2020 7265  tateState.    re
-0000c770: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-0000c780: 6563 730a 2020 2020 7374 696d 756c 7573  ecs.    stimulus
-0000c790: 5f69 643a 2073 7472 0a20 2020 2074 696d  _id: str.    tim
-0000c7a0: 6573 7461 6d70 3a20 666c 6f61 740a 0a0a  estamp: float...
-0000c7b0: 636c 6173 7320 5363 6865 6475 6c65 7253  class SchedulerS
-0000c7c0: 7461 7465 3a0a 2020 2020 2222 2255 6e64  tate:.    """Und
-0000c7d0: 6572 6c79 696e 6720 7461 736b 2073 7461  erlying task sta
-0000c7e0: 7465 206f 6620 6479 6e61 6d69 6320 7363  te of dynamic sc
-0000c7f0: 6865 6475 6c65 720a 0a20 2020 2054 7261  heduler..    Tra
-0000c800: 636b 7320 7468 6520 6375 7272 656e 7420  cks the current 
-0000c810: 7374 6174 6520 6f66 2077 6f72 6b65 7273  state of workers
-0000c820: 2c20 6461 7461 2c20 616e 6420 636f 6d70  , data, and comp
-0000c830: 7574 6174 696f 6e73 2e0a 0a20 2020 2048  utations...    H
-0000c840: 616e 646c 6573 2074 7261 6e73 6974 696f  andles transitio
-0000c850: 6e73 2062 6574 7765 656e 2064 6966 6665  ns between diffe
-0000c860: 7265 6e74 2074 6173 6b20 7374 6174 6573  rent task states
-0000c870: 2e20 4e6f 7469 6669 6573 2074 6865 0a20  . Notifies the. 
-0000c880: 2020 2053 6368 6564 756c 6572 206f 6620     Scheduler of 
-0000c890: 6368 616e 6765 7320 6279 206d 6573 7361  changes by messa
-0000c8a0: 6769 6e67 2070 6173 7369 6e67 2074 6872  ging passing thr
-0000c8b0: 6f75 6768 2051 7565 7565 732c 2077 6869  ough Queues, whi
-0000c8c0: 6368 2074 6865 0a20 2020 2053 6368 6564  ch the.    Sched
-0000c8d0: 756c 6572 206c 6973 7465 6e73 2074 6f20  uler listens to 
-0000c8e0: 7265 7370 6f6e 6473 2061 6363 6f72 6469  responds accordi
-0000c8f0: 6e67 6c79 2e0a 0a20 2020 2041 6c6c 2065  ngly...    All e
-0000c900: 7665 6e74 7320 6172 6520 6861 6e64 6c65  vents are handle
-0000c910: 6420 7175 6963 6b6c 792c 2069 6e20 6c69  d quickly, in li
-0000c920: 6e65 6172 2074 696d 6520 7769 7468 2072  near time with r
-0000c930: 6573 7065 6374 2074 6f20 7468 6569 720a  espect to their.
-0000c940: 2020 2020 696e 7075 7420 2877 6869 6368      input (which
-0000c950: 2069 7320 6f66 7465 6e20 6f66 2063 6f6e   is often of con
-0000c960: 7374 616e 7420 7369 7a65 2920 616e 6420  stant size) and 
-0000c970: 6765 6e65 7261 6c6c 7920 7769 7468 696e  generally within
-0000c980: 2061 0a20 2020 206d 696c 6c69 7365 636f   a.    milliseco
-0000c990: 6e64 2e0a 0a20 2020 2055 7365 7273 2074  nd...    Users t
-0000c9a0: 7970 6963 616c 6c79 2064 6f20 6e6f 7420  ypically do not 
-0000c9b0: 696e 7465 7261 6374 2077 6974 6820 6060  interact with ``
-0000c9c0: 5472 616e 7369 7469 6f6e 7360 6020 6469  Transitions`` di
-0000c9d0: 7265 6374 6c79 2e20 496e 7374 6561 640a  rectly. Instead.
-0000c9e0: 2020 2020 7573 6572 7320 696e 7465 7261      users intera
-0000c9f0: 6374 2077 6974 6820 7468 6520 6060 436c  ct with the ``Cl
-0000ca00: 6965 6e74 6060 2c20 7768 6963 6820 696e  ient``, which in
-0000ca10: 2074 7572 6e20 656e 6761 6765 7320 7468   turn engages th
-0000ca20: 650a 2020 2020 6060 5363 6865 6475 6c65  e.    ``Schedule
-0000ca30: 7260 6020 6166 6665 6374 696e 6720 6469  r`` affecting di
-0000ca40: 6666 6572 656e 7420 7472 616e 7369 7469  fferent transiti
-0000ca50: 6f6e 7320 6865 7265 2075 6e64 6572 2d74  ons here under-t
-0000ca60: 6865 2d68 6f6f 642e 2049 6e0a 2020 2020  he-hood. In.    
-0000ca70: 7468 6520 6261 636b 6772 6f75 6e64 2060  the background `
-0000ca80: 6057 6f72 6b65 7260 6073 2061 6c73 6f20  `Worker``s also 
-0000ca90: 656e 6761 6765 2077 6974 6820 7468 6520  engage with the 
-0000caa0: 6060 5363 6865 6475 6c65 7260 600a 2020  ``Scheduler``.  
-0000cab0: 2020 6166 6665 6374 696e 6720 7468 6573    affecting thes
-0000cac0: 6520 7374 6174 6520 7472 616e 7369 7469  e state transiti
-0000cad0: 6f6e 7320 6173 2077 656c 6c2e 0a20 2020  ons as well..   
-0000cae0: 2022 2222 0a0a 2020 2020 6261 6e64 7769   """..    bandwi
-0000caf0: 6474 683a 2069 6e74 0a0a 2020 2020 233a  dth: int..    #:
-0000cb00: 2043 6c69 656e 7473 2063 7572 7265 6e74   Clients current
-0000cb10: 6c79 2063 6f6e 6e65 6374 6564 2074 6f20  ly connected to 
-0000cb20: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
-0000cb30: 2020 636c 6965 6e74 733a 2064 6963 745b    clients: dict[
-0000cb40: 7374 722c 2043 6c69 656e 7453 7461 7465  str, ClientState
-0000cb50: 5d0a 0a20 2020 2065 7874 656e 7369 6f6e  ]..    extension
-0000cb60: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
-0000cb70: 5d20 2023 2054 4f44 4f20 7772 6974 6520  ]  # TODO write 
-0000cb80: 6120 7363 6865 6475 6c65 7220 6578 7465  a scheduler exte
-0000cb90: 6e73 696f 6e20 5072 6f74 6f63 6f6c 0a20  nsion Protocol. 
-0000cba0: 2020 2070 6c75 6769 6e73 3a20 6469 6374     plugins: dict
-0000cbb0: 5b73 7472 2c20 5363 6865 6475 6c65 7250  [str, SchedulerP
-0000cbc0: 6c75 6769 6e5d 0a20 2020 2068 6f73 745f  lugin].    host_
-0000cbd0: 696e 666f 3a20 6469 6374 5b73 7472 2c20  info: dict[str, 
-0000cbe0: 6469 6374 5b73 7472 2c20 416e 795d 5d0a  dict[str, Any]].
-0000cbf0: 0a20 2020 2023 3a20 4966 2054 7275 652c  .    #: If True,
-0000cc00: 2065 6e61 626c 6520 6578 7065 6e73 6976   enable expensiv
-0000cc10: 6520 696e 7465 726e 616c 2063 6f6e 7369  e internal consi
-0000cc20: 7374 656e 6379 2063 6865 636b 2e0a 2020  stency check..  
-0000cc30: 2020 233a 2054 7970 6963 616c 6c79 2064    #: Typically d
-0000cc40: 6973 6162 6c65 6420 696e 2070 726f 6475  isabled in produ
-0000cc50: 6374 696f 6e2e 0a20 2020 2076 616c 6964  ction..    valid
-0000cc60: 6174 653a 2062 6f6f 6c0a 0a20 2020 2023  ate: bool..    #
-0000cc70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cc80: 2323 2323 2323 0a20 2020 2023 2057 6f72  ######.    # Wor
-0000cc90: 6b65 7273 2d72 656c 6174 6564 2073 7461  kers-related sta
-0000cca0: 7465 0a20 2020 2023 2323 2323 2323 2323  te.    #########
-0000ccb0: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-0000ccc0: 2020 2020 233a 2057 6f72 6b65 7273 2063      #: Workers c
-0000ccd0: 7572 7265 6e74 6c79 2063 6f6e 6e65 6374  urrently connect
-0000cce0: 6564 2074 6f20 7468 6520 7363 6865 6475  ed to the schedu
-0000ccf0: 6c65 720a 2020 2020 233a 2028 6163 7475  ler.    #: (actu
-0000cd00: 616c 6c79 2061 2053 6f72 7465 6444 6963  ally a SortedDic
-0000cd10: 742c 2062 7574 2074 6865 2073 6f72 7465  t, but the sorte
-0000cd20: 6463 6f6e 7461 696e 6572 7320 7061 636b  dcontainers pack
-0000cd30: 6167 6520 6973 6e27 7420 616e 6e6f 7461  age isn't annota
-0000cd40: 7465 6429 0a20 2020 2077 6f72 6b65 7273  ted).    workers
-0000cd50: 3a20 6469 6374 5b73 7472 2c20 576f 726b  : dict[str, Work
-0000cd60: 6572 5374 6174 655d 0a20 2020 2023 3a20  erState].    #: 
-0000cd70: 576f 726b 6572 207b 6e61 6d65 3a20 6164  Worker {name: ad
-0000cd80: 6472 6573 737d 0a20 2020 2061 6c69 6173  dress}.    alias
-0000cd90: 6573 3a20 6469 6374 5b48 6173 6861 626c  es: dict[Hashabl
-0000cda0: 652c 2073 7472 5d0a 2020 2020 233a 2057  e, str].    #: W
-0000cdb0: 6f72 6b65 7273 2074 6861 7420 6172 6520  orkers that are 
-0000cdc0: 6375 7272 656e 746c 7920 696e 2072 756e  currently in run
-0000cdd0: 6e69 6e67 2073 7461 7465 0a20 2020 2072  ning state.    r
-0000cde0: 756e 6e69 6e67 3a20 7365 745b 576f 726b  unning: set[Work
-0000cdf0: 6572 5374 6174 655d 0a20 2020 2023 3a20  erState].    #: 
-0000ce00: 576f 726b 6572 7320 7468 6174 2061 7265  Workers that are
-0000ce10: 2063 7572 7265 6e74 6c79 2069 6e20 7275   currently in ru
-0000ce20: 6e6e 696e 6720 7374 6174 6520 616e 6420  nning state and 
-0000ce30: 6e6f 7420 6675 6c6c 7920 7574 696c 697a  not fully utiliz
-0000ce40: 6564 0a20 2020 2023 3a20 4465 6669 6e69  ed.    #: Defini
-0000ce50: 7469 6f6e 2062 6173 6564 206f 6e20 6f63  tion based on oc
-0000ce60: 6375 7061 6e63 790a 2020 2020 233a 2028  cupancy.    #: (
-0000ce70: 6163 7475 616c 6c79 2061 2053 6f72 7465  actually a Sorte
-0000ce80: 6444 6963 742c 2062 7574 2074 6865 2073  dDict, but the s
-0000ce90: 6f72 7465 6463 6f6e 7461 696e 6572 7320  ortedcontainers 
-0000cea0: 7061 636b 6167 6520 6973 6e27 7420 616e  package isn't an
-0000ceb0: 6e6f 7461 7465 6429 0a20 2020 2069 646c  notated).    idl
-0000cec0: 653a 2064 6963 745b 7374 722c 2057 6f72  e: dict[str, Wor
-0000ced0: 6b65 7253 7461 7465 5d0a 2020 2020 233a  kerState].    #:
-0000cee0: 2053 696d 696c 6172 2074 6f20 6069 646c   Similar to `idl
-0000cef0: 6560 0a20 2020 2023 3a20 4465 6669 6e69  e`.    #: Defini
-0000cf00: 7469 6f6e 2062 6173 6564 206f 6e20 6173  tion based on as
-0000cf10: 7369 676e 6564 2074 6173 6b73 0a20 2020  signed tasks.   
-0000cf20: 2069 646c 655f 7461 736b 5f63 6f75 6e74   idle_task_count
-0000cf30: 3a20 7365 745b 576f 726b 6572 5374 6174  : set[WorkerStat
-0000cf40: 655d 0a20 2020 2023 3a20 576f 726b 6572  e].    #: Worker
-0000cf50: 7320 7468 6174 2061 7265 2066 756c 6c79  s that are fully
-0000cf60: 2075 7469 6c69 7a65 642e 204d 6179 2069   utilized. May i
-0000cf70: 6e63 6c75 6465 206e 6f6e 2d72 756e 6e69  nclude non-runni
-0000cf80: 6e67 2077 6f72 6b65 7273 2e0a 2020 2020  ng workers..    
-0000cf90: 7361 7475 7261 7465 643a 2073 6574 5b57  saturated: set[W
-0000cfa0: 6f72 6b65 7253 7461 7465 5d0a 2020 2020  orkerState].    
-0000cfb0: 746f 7461 6c5f 6e74 6872 6561 6473 3a20  total_nthreads: 
-0000cfc0: 696e 740a 2020 2020 233a 2043 6c75 7374  int.    #: Clust
-0000cfd0: 6572 2d77 6964 6520 7265 736f 7572 6365  er-wide resource
-0000cfe0: 732e 207b 7265 736f 7572 6365 206e 616d  s. {resource nam
-0000cff0: 653a 207b 776f 726b 6572 2061 6464 7265  e: {worker addre
-0000d000: 7373 3a20 616d 6f75 6e74 7d7d 0a20 2020  ss: amount}}.   
-0000d010: 2072 6573 6f75 7263 6573 3a20 6469 6374   resources: dict
-0000d020: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
-0000d030: 666c 6f61 745d 5d0a 0a20 2020 2023 2323  float]]..    ###
-0000d040: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d050: 2323 0a20 2020 2023 2054 6173 6b73 2d72  ##.    # Tasks-r
-0000d060: 656c 6174 6564 2073 7461 7465 0a20 2020  elated state.   
-0000d070: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-0000d080: 2323 2323 2323 0a0a 2020 2020 233a 2054  ######..    #: T
-0000d090: 6f74 616c 206e 756d 6265 7220 6f66 2074  otal number of t
-0000d0a0: 6173 6b73 2065 7665 7220 7072 6f63 6573  asks ever proces
-0000d0b0: 7365 640a 2020 2020 6e5f 7461 736b 733a  sed.    n_tasks:
-0000d0c0: 2069 6e74 0a0a 2020 2020 233a 2041 6c6c   int..    #: All
-0000d0d0: 2074 6173 6b73 2063 7572 7265 6e74 6c79   tasks currently
-0000d0e0: 206b 6e6f 776e 2074 6f20 7468 6520 7363   known to the sc
-0000d0f0: 6865 6475 6c65 720a 2020 2020 7461 736b  heduler.    task
-0000d100: 733a 2064 6963 745b 7374 722c 2054 6173  s: dict[str, Tas
-0000d110: 6b53 7461 7465 5d0a 0a20 2020 2023 3a20  kState]..    #: 
-0000d120: 5461 736b 7320 696e 2074 6865 2022 7175  Tasks in the "qu
-0000d130: 6575 6564 2220 7374 6174 652c 206f 7264  eued" state, ord
-0000d140: 6572 6564 2062 7920 7072 696f 7269 7479  ered by priority
-0000d150: 0a20 2020 2071 7565 7565 643a 2048 6561  .    queued: Hea
-0000d160: 7053 6574 5b54 6173 6b53 7461 7465 5d0a  pSet[TaskState].
-0000d170: 0a20 2020 2023 3a20 5461 736b 7320 696e  .    #: Tasks in
-0000d180: 2074 6865 2022 6e6f 2d77 6f72 6b65 7222   the "no-worker"
-0000d190: 2073 7461 7465 0a20 2020 2075 6e72 756e   state.    unrun
-0000d1a0: 6e61 626c 653a 2073 6574 5b54 6173 6b53  nable: set[TaskS
-0000d1b0: 7461 7465 5d0a 0a20 2020 2023 3a20 5375  tate]..    #: Su
-0000d1c0: 6273 6574 206f 6620 7461 736b 7320 7468  bset of tasks th
-0000d1d0: 6174 2065 7869 7374 2069 6e20 6d65 6d6f  at exist in memo
-0000d1e0: 7279 206f 6e20 6d6f 7265 2074 6861 6e20  ry on more than 
-0000d1f0: 6f6e 6520 776f 726b 6572 0a20 2020 2072  one worker.    r
-0000d200: 6570 6c69 6361 7465 645f 7461 736b 733a  eplicated_tasks:
-0000d210: 2073 6574 5b54 6173 6b53 7461 7465 5d0a   set[TaskState].
-0000d220: 0a20 2020 2075 6e6b 6e6f 776e 5f64 7572  .    unknown_dur
-0000d230: 6174 696f 6e73 3a20 6469 6374 5b73 7472  ations: dict[str
-0000d240: 2c20 7365 745b 5461 736b 5374 6174 655d  , set[TaskState]
-0000d250: 5d0a 2020 2020 7461 736b 5f67 726f 7570  ].    task_group
-0000d260: 733a 2064 6963 745b 7374 722c 2054 6173  s: dict[str, Tas
-0000d270: 6b47 726f 7570 5d0a 2020 2020 7461 736b  kGroup].    task
-0000d280: 5f70 7265 6669 7865 733a 2064 6963 745b  _prefixes: dict[
-0000d290: 7374 722c 2054 6173 6b50 7265 6669 785d  str, TaskPrefix]
-0000d2a0: 0a20 2020 2074 6173 6b5f 6d65 7461 6461  .    task_metada
-0000d2b0: 7461 3a20 6469 6374 5b73 7472 2c20 416e  ta: dict[str, An
-0000d2c0: 795d 0a0a 2020 2020 2323 2323 2323 2323  y]..    ########
-0000d2d0: 230a 2020 2020 2320 4869 7374 6f72 790a  #.    # History.
-0000d2e0: 2020 2020 2323 2323 2323 2323 230a 0a20      #########.. 
-0000d2f0: 2020 2023 3a20 4869 7374 6f72 7920 6f66     #: History of
-0000d300: 2063 6f6d 7075 7461 7469 6f6e 732e 0a20   computations.. 
-0000d310: 2020 2023 3a20 5468 6520 6c65 6e67 7468     #: The length
-0000d320: 2063 616e 2062 6520 7477 6561 6b65 6420   can be tweaked 
-0000d330: 7468 726f 7567 680a 2020 2020 233a 2064  through.    #: d
-0000d340: 6973 7472 6962 7574 6564 2e64 6961 676e  istributed.diagn
-0000d350: 6f73 7469 6373 2e63 6f6d 7075 7461 7469  ostics.computati
-0000d360: 6f6e 732e 6d61 782d 6869 7374 6f72 790a  ons.max-history.
-0000d370: 2020 2020 636f 6d70 7574 6174 696f 6e73      computations
-0000d380: 3a20 6465 7175 655b 436f 6d70 7574 6174  : deque[Computat
-0000d390: 696f 6e5d 0a0a 2020 2020 233a 2048 6973  ion]..    #: His
-0000d3a0: 746f 7279 206f 6620 6572 7265 6420 7461  tory of erred ta
-0000d3b0: 736b 732e 0a20 2020 2023 3a20 5468 6520  sks..    #: The 
-0000d3c0: 6c65 6e67 7468 2063 616e 2062 6520 7477  length can be tw
-0000d3d0: 6561 6b65 6420 7468 726f 7567 680a 2020  eaked through.  
-0000d3e0: 2020 233a 2064 6973 7472 6962 7574 6564    #: distributed
-0000d3f0: 2e64 6961 676e 6f73 7469 6373 2e65 7272  .diagnostics.err
-0000d400: 6564 2d74 6173 6b73 2e6d 6178 2d68 6973  ed-tasks.max-his
-0000d410: 746f 7279 0a20 2020 2065 7272 6564 5f74  tory.    erred_t
-0000d420: 6173 6b73 3a20 6465 7175 655b 4572 7265  asks: deque[Erre
-0000d430: 6454 6173 6b5d 0a0a 2020 2020 233a 2048  dTask]..    #: H
-0000d440: 6973 746f 7279 206f 6620 7461 736b 2073  istory of task s
-0000d450: 7461 7465 2074 7261 6e73 6974 696f 6e73  tate transitions
-0000d460: 2e0a 2020 2020 233a 2054 6865 206c 656e  ..    #: The len
-0000d470: 6774 6820 6361 6e20 6265 2074 7765 616b  gth can be tweak
-0000d480: 6564 2074 6872 6f75 6768 0a20 2020 2023  ed through.    #
-0000d490: 3a20 6469 7374 7269 6275 7465 642e 7363  : distributed.sc
-0000d4a0: 6865 6475 6c65 722e 7472 616e 7369 7469  heduler.transiti
-0000d4b0: 6f6e 2d6c 6f67 2d6c 656e 6774 680a 2020  on-log-length.  
-0000d4c0: 2020 7472 616e 7369 7469 6f6e 5f6c 6f67    transition_log
-0000d4d0: 3a20 6465 7175 655b 5472 616e 7369 7469  : deque[Transiti
-0000d4e0: 6f6e 5d0a 0a20 2020 2023 3a20 546f 7461  on]..    #: Tota
-0000d4f0: 6c20 6e75 6d62 6572 206f 6620 7472 616e  l number of tran
-0000d500: 7369 7469 6f6e 7320 7369 6e63 6520 7468  sitions since th
-0000d510: 6520 636c 7573 7465 7220 7761 7320 7374  e cluster was st
-0000d520: 6172 7465 640a 2020 2020 7472 616e 7369  arted.    transi
-0000d530: 7469 6f6e 5f63 6f75 6e74 6572 3a20 696e  tion_counter: in
-0000d540: 740a 0a20 2020 2023 3a20 546f 7461 6c20  t..    #: Total 
-0000d550: 6e75 6d62 6572 206f 6620 7472 616e 7369  number of transi
-0000d560: 7469 6f6e 7320 6173 206f 6620 7468 6520  tions as of the 
-0000d570: 7072 6576 696f 7573 2063 616c 6c20 746f  previous call to
-0000d580: 2063 6865 636b 5f69 646c 6528 290a 2020   check_idle().  
-0000d590: 2020 5f69 646c 655f 7472 616e 7369 7469    _idle_transiti
-0000d5a0: 6f6e 5f63 6f75 6e74 6572 3a20 696e 740a  on_counter: int.
-0000d5b0: 0a20 2020 2023 3a20 5261 6973 6520 616e  .    #: Raise an
-0000d5c0: 2065 7272 6f72 2069 6620 7468 6520 3a61   error if the :a
-0000d5d0: 7474 723a 6074 7261 6e73 6974 696f 6e5f  ttr:`transition_
-0000d5e0: 636f 756e 7465 7260 2065 7665 7220 7265  counter` ever re
-0000d5f0: 6163 6865 7320 7468 6973 2076 616c 7565  aches this value
-0000d600: 2e0a 2020 2020 233a 2054 6869 7320 6973  ..    #: This is
-0000d610: 206d 6561 6e74 2066 6f72 2064 6562 7567   meant for debug
-0000d620: 6769 6e67 206f 6e6c 792c 2074 6f20 6361  ging only, to ca
-0000d630: 7463 6820 696e 6669 6e69 7465 2072 6563  tch infinite rec
-0000d640: 7572 7369 6f6e 206c 6f6f 7073 2e0a 2020  ursion loops..  
-0000d650: 2020 233a 2049 6e20 7072 6f64 7563 7469    #: In producti
-0000d660: 6f6e 2c20 6974 2073 686f 756c 6420 616c  on, it should al
-0000d670: 7761 7973 2062 6520 7365 7420 746f 2046  ways be set to F
-0000d680: 616c 7365 2e0a 2020 2020 7472 616e 7369  alse..    transi
-0000d690: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
-0000d6a0: 3a20 696e 7420 7c20 4c69 7465 7261 6c5b  : int | Literal[
-0000d6b0: 4661 6c73 655d 0a0a 2020 2020 5f74 6173  False]..    _tas
-0000d6c0: 6b5f 7072 6566 6978 5f63 6f75 6e74 5f67  k_prefix_count_g
-0000d6d0: 6c6f 6261 6c3a 2064 6566 6175 6c74 6469  lobal: defaultdi
-0000d6e0: 6374 5b73 7472 2c20 696e 745d 0a20 2020  ct[str, int].   
-0000d6f0: 205f 6e65 7477 6f72 6b5f 6f63 635f 676c   _network_occ_gl
-0000d700: 6f62 616c 3a20 666c 6f61 740a 2020 2020  obal: float.    
-0000d710: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d720: 2323 2323 2323 0a20 2020 2023 2043 6163  ######.    # Cac
-0000d730: 6865 6420 636f 6e66 6967 7572 6174 696f  hed configuratio
-0000d740: 6e0a 2020 2020 2323 2323 2323 2323 2323  n.    ##########
-0000d750: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
-0000d760: 2020 233a 2064 6973 7472 6962 7574 6564    #: distributed
-0000d770: 2e73 6368 6564 756c 6572 2e75 6e6b 6e6f  .scheduler.unkno
-0000d780: 776e 2d74 6173 6b2d 6475 7261 7469 6f6e  wn-task-duration
-0000d790: 0a20 2020 2055 4e4b 4e4f 574e 5f54 4153  .    UNKNOWN_TAS
-0000d7a0: 4b5f 4455 5241 5449 4f4e 3a20 666c 6f61  K_DURATION: floa
-0000d7b0: 740a 2020 2020 233a 2064 6973 7472 6962  t.    #: distrib
-0000d7c0: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-0000d7d0: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
-0000d7e0: 2d74 696d 650a 2020 2020 4d45 4d4f 5259  -time.    MEMORY
-0000d7f0: 5f52 4543 454e 545f 544f 5f4f 4c44 5f54  _RECENT_TO_OLD_T
-0000d800: 494d 453a 2066 6c6f 6174 0a20 2020 2023  IME: float.    #
-0000d810: 3a20 6469 7374 7269 6275 7465 642e 776f  : distributed.wo
-0000d820: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
-0000d830: 6c61 6e63 652e 6d65 6173 7572 650a 2020  lance.measure.  
-0000d840: 2020 4d45 4d4f 5259 5f52 4542 414c 414e    MEMORY_REBALAN
-0000d850: 4345 5f4d 4541 5355 5245 3a20 7374 720a  CE_MEASURE: str.
-0000d860: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
-0000d870: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-0000d880: 2e72 6562 616c 616e 6365 2e73 656e 6465  .rebalance.sende
-0000d890: 722d 6d69 6e0a 2020 2020 4d45 4d4f 5259  r-min.    MEMORY
-0000d8a0: 5f52 4542 414c 414e 4345 5f53 454e 4445  _REBALANCE_SENDE
-0000d8b0: 525f 4d49 4e3a 2066 6c6f 6174 0a20 2020  R_MIN: float.   
-0000d8c0: 2023 3a20 6469 7374 7269 6275 7465 642e   #: distributed.
-0000d8d0: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
-0000d8e0: 6261 6c61 6e63 652e 7265 6369 7069 656e  balance.recipien
-0000d8f0: 742d 6d61 780a 2020 2020 4d45 4d4f 5259  t-max.    MEMORY
-0000d900: 5f52 4542 414c 414e 4345 5f52 4543 4950  _REBALANCE_RECIP
-0000d910: 4945 4e54 5f4d 4158 3a20 666c 6f61 740a  IENT_MAX: float.
-0000d920: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
-0000d930: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-0000d940: 2e72 6562 616c 616e 6365 2e73 656e 6465  .rebalance.sende
-0000d950: 722d 7265 6369 7069 656e 742d 6761 7020  r-recipient-gap 
-0000d960: 2f20 320a 2020 2020 4d45 4d4f 5259 5f52  / 2.    MEMORY_R
-0000d970: 4542 414c 414e 4345 5f48 414c 465f 4741  EBALANCE_HALF_GA
-0000d980: 503a 2066 6c6f 6174 0a20 2020 2023 3a20  P: float.    #: 
-0000d990: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-0000d9a0: 6475 6c65 722e 776f 726b 6572 2d73 6174  duler.worker-sat
-0000d9b0: 7572 6174 696f 6e0a 2020 2020 574f 524b  uration.    WORK
-0000d9c0: 4552 5f53 4154 5552 4154 494f 4e3a 2066  ER_SATURATION: f
-0000d9d0: 6c6f 6174 0a0a 2020 2020 5f5f 736c 6f74  loat..    __slot
-0000d9e0: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
-0000d9f0: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
-0000da00: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
-0000da10: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-0000da20: 2020 2020 2020 616c 6961 7365 733a 2064        aliases: d
-0000da30: 6963 745b 4861 7368 6162 6c65 2c20 7374  ict[Hashable, st
-0000da40: 725d 2c0a 2020 2020 2020 2020 636c 6965  r],.        clie
-0000da50: 6e74 733a 2064 6963 745b 7374 722c 2043  nts: dict[str, C
-0000da60: 6c69 656e 7453 7461 7465 5d2c 0a20 2020  lientState],.   
-0000da70: 2020 2020 2077 6f72 6b65 7273 3a20 536f       workers: So
-0000da80: 7274 6564 4469 6374 5b73 7472 2c20 576f  rtedDict[str, Wo
-0000da90: 726b 6572 5374 6174 655d 2c0a 2020 2020  rkerState],.    
-0000daa0: 2020 2020 686f 7374 5f69 6e66 6f3a 2064      host_info: d
-0000dab0: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
-0000dac0: 722c 2041 6e79 5d5d 2c0a 2020 2020 2020  r, Any]],.      
-0000dad0: 2020 7265 736f 7572 6365 733a 2064 6963    resources: dic
-0000dae0: 745b 7374 722c 2064 6963 745b 7374 722c  t[str, dict[str,
-0000daf0: 2066 6c6f 6174 5d5d 2c0a 2020 2020 2020   float]],.      
-0000db00: 2020 7461 736b 733a 2064 6963 745b 7374    tasks: dict[st
-0000db10: 722c 2054 6173 6b53 7461 7465 5d2c 0a20  r, TaskState],. 
-0000db20: 2020 2020 2020 2075 6e72 756e 6e61 626c         unrunnabl
-0000db30: 653a 2073 6574 5b54 6173 6b53 7461 7465  e: set[TaskState
-0000db40: 5d2c 0a20 2020 2020 2020 2071 7565 7565  ],.        queue
-0000db50: 643a 2048 6561 7053 6574 5b54 6173 6b53  d: HeapSet[TaskS
-0000db60: 7461 7465 5d2c 0a20 2020 2020 2020 2076  tate],.        v
-0000db70: 616c 6964 6174 653a 2062 6f6f 6c2c 0a20  alidate: bool,. 
-0000db80: 2020 2020 2020 2070 6c75 6769 6e73 3a20         plugins: 
-0000db90: 4974 6572 6162 6c65 5b53 6368 6564 756c  Iterable[Schedul
-0000dba0: 6572 506c 7567 696e 5d20 3d20 2829 2c0a  erPlugin] = (),.
-0000dbb0: 2020 2020 2020 2020 7472 616e 7369 7469          transiti
-0000dbc0: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 3a20  on_counter_max: 
-0000dbd0: 696e 7420 7c20 4c69 7465 7261 6c5b 4661  int | Literal[Fa
-0000dbe0: 6c73 655d 203d 2046 616c 7365 2c0a 2020  lse] = False,.  
-0000dbf0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0000dc00: 416e 792c 2020 2320 5061 7373 6564 2076  Any,  # Passed v
-0000dc10: 6572 6261 7469 6d20 746f 2053 6572 7665  erbatim to Serve
-0000dc20: 722e 5f5f 696e 6974 5f5f 2829 0a20 2020  r.__init__().   
-0000dc30: 2029 3a0a 2020 2020 2020 2020 6c6f 6767   ):.        logg
-0000dc40: 6572 2e69 6e66 6f28 2253 7461 7465 2073  er.info("State s
-0000dc50: 7461 7274 2229 0a20 2020 2020 2020 2073  tart").        s
-0000dc60: 656c 662e 616c 6961 7365 7320 3d20 616c  elf.aliases = al
-0000dc70: 6961 7365 730a 2020 2020 2020 2020 7365  iases.        se
-0000dc80: 6c66 2e62 616e 6477 6964 7468 203d 2070  lf.bandwidth = p
-0000dc90: 6172 7365 5f62 7974 6573 2864 6173 6b2e  arse_bytes(dask.
-0000dca0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-0000dcb0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0000dcc0: 722e 6261 6e64 7769 6474 6822 2929 0a20  r.bandwidth")). 
-0000dcd0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0000dce0: 6e74 7320 3d20 636c 6965 6e74 730a 2020  nts = clients.  
-0000dcf0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0000dd00: 7473 5b22 6669 7265 2d61 6e64 2d66 6f72  ts["fire-and-for
-0000dd10: 6765 7422 5d20 3d20 436c 6965 6e74 5374  get"] = ClientSt
-0000dd20: 6174 6528 2266 6972 652d 616e 642d 666f  ate("fire-and-fo
-0000dd30: 7267 6574 2229 0a20 2020 2020 2020 2073  rget").        s
-0000dd40: 656c 662e 6578 7465 6e73 696f 6e73 203d  elf.extensions =
-0000dd50: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-0000dd60: 2e68 6f73 745f 696e 666f 203d 2068 6f73  .host_info = hos
-0000dd70: 745f 696e 666f 0a20 2020 2020 2020 2073  t_info.        s
-0000dd80: 656c 662e 6964 6c65 203d 2053 6f72 7465  elf.idle = Sorte
-0000dd90: 6444 6963 7428 290a 2020 2020 2020 2020  dDict().        
-0000dda0: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-0000ddb0: 6f75 6e74 203d 2073 6574 2829 0a20 2020  ount = set().   
-0000ddc0: 2020 2020 2073 656c 662e 6e5f 7461 736b       self.n_task
-0000ddd0: 7320 3d20 300a 2020 2020 2020 2020 7365  s = 0.        se
-0000dde0: 6c66 2e72 6573 6f75 7263 6573 203d 2072  lf.resources = r
-0000ddf0: 6573 6f75 7263 6573 0a20 2020 2020 2020  esources.       
-0000de00: 2073 656c 662e 7361 7475 7261 7465 6420   self.saturated 
-0000de10: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-0000de20: 7365 6c66 2e74 6173 6b73 203d 2074 6173  self.tasks = tas
-0000de30: 6b73 0a20 2020 2020 2020 2073 656c 662e  ks.        self.
-0000de40: 7265 706c 6963 6174 6564 5f74 6173 6b73  replicated_tasks
-0000de50: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0000de60: 2074 7320 666f 7220 7473 2069 6e20 7365   ts for ts in se
-0000de70: 6c66 2e74 6173 6b73 2e76 616c 7565 7328  lf.tasks.values(
-0000de80: 2920 6966 206c 656e 2874 732e 7768 6f5f  ) if len(ts.who_
-0000de90: 6861 7329 203e 2031 0a20 2020 2020 2020  has) > 1.       
-0000dea0: 207d 0a20 2020 2020 2020 2073 656c 662e   }.        self.
-0000deb0: 636f 6d70 7574 6174 696f 6e73 203d 2064  computations = d
-0000dec0: 6571 7565 280a 2020 2020 2020 2020 2020  eque(.          
-0000ded0: 2020 6d61 786c 656e 3d64 6173 6b2e 636f    maxlen=dask.co
-0000dee0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-0000def0: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
-0000df00: 732e 636f 6d70 7574 6174 696f 6e73 2e6d  s.computations.m
-0000df10: 6178 2d68 6973 746f 7279 2229 0a20 2020  ax-history").   
-0000df20: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0000df30: 656c 662e 6572 7265 645f 7461 736b 7320  elf.erred_tasks 
-0000df40: 3d20 6465 7175 6528 0a20 2020 2020 2020  = deque(.       
-0000df50: 2020 2020 206d 6178 6c65 6e3d 6461 736b       maxlen=dask
-0000df60: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0000df70: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
-0000df80: 7469 6373 2e65 7272 6564 2d74 6173 6b73  tics.erred-tasks
-0000df90: 2e6d 6178 2d68 6973 746f 7279 2229 0a20  .max-history"). 
-0000dfa0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000dfb0: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-0000dfc0: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
-0000dfd0: 656c 662e 7461 736b 5f70 7265 6669 7865  elf.task_prefixe
-0000dfe0: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
-0000dff0: 656c 662e 7461 736b 5f6d 6574 6164 6174  elf.task_metadat
-0000e000: 6120 3d20 7b7d 0a20 2020 2020 2020 2073  a = {}.        s
-0000e010: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
-0000e020: 6473 203d 2030 0a20 2020 2020 2020 2073  ds = 0.        s
-0000e030: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
-0000e040: 7469 6f6e 7320 3d20 7b7d 0a20 2020 2020  tions = {}.     
-0000e050: 2020 2073 656c 662e 7175 6575 6564 203d     self.queued =
-0000e060: 2071 7565 7565 640a 2020 2020 2020 2020   queued.        
-0000e070: 7365 6c66 2e75 6e72 756e 6e61 626c 6520  self.unrunnable 
-0000e080: 3d20 756e 7275 6e6e 6162 6c65 0a20 2020  = unrunnable.   
-0000e090: 2020 2020 2073 656c 662e 7661 6c69 6461       self.valida
-0000e0a0: 7465 203d 2076 616c 6964 6174 650a 2020  te = validate.  
-0000e0b0: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-0000e0c0: 7273 203d 2077 6f72 6b65 7273 0a20 2020  rs = workers.   
-0000e0d0: 2020 2020 2073 656c 662e 5f74 6173 6b5f       self._task_
-0000e0e0: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
-0000e0f0: 6261 6c20 3d20 6465 6661 756c 7464 6963  bal = defaultdic
-0000e100: 7428 696e 7429 0a20 2020 2020 2020 2073  t(int).        s
-0000e110: 656c 662e 5f6e 6574 776f 726b 5f6f 6363  elf._network_occ
-0000e120: 5f67 6c6f 6261 6c20 3d20 302e 300a 2020  _global = 0.0.  
-0000e130: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
-0000e140: 6e67 203d 207b 0a20 2020 2020 2020 2020  ng = {.         
-0000e150: 2020 2077 7320 666f 7220 7773 2069 6e20     ws for ws in 
-0000e160: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-0000e170: 7565 7328 2920 6966 2077 732e 7374 6174  ues() if ws.stat
-0000e180: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
-0000e190: 6e69 6e67 0a20 2020 2020 2020 207d 0a20  ning.        }. 
-0000e1a0: 2020 2020 2020 2073 656c 662e 706c 7567         self.plug
-0000e1b0: 696e 7320 3d20 7b7d 2069 6620 6e6f 7420  ins = {} if not 
-0000e1c0: 706c 7567 696e 7320 656c 7365 207b 5f67  plugins else {_g
-0000e1d0: 6574 5f70 6c75 6769 6e5f 6e61 6d65 2870  et_plugin_name(p
-0000e1e0: 293a 2070 2066 6f72 2070 2069 6e20 706c  ): p for p in pl
-0000e1f0: 7567 696e 737d 0a0a 2020 2020 2020 2020  ugins}..        
-0000e200: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
-0000e210: 6c6f 6720 3d20 6465 7175 6528 0a20 2020  log = deque(.   
-0000e220: 2020 2020 2020 2020 206d 6178 6c65 6e3d           maxlen=
-0000e230: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0000e240: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-0000e250: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
-0000e260: 6e2d 6c6f 672d 6c65 6e67 7468 2229 0a20  n-log-length"). 
-0000e270: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000e280: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-0000e290: 5f63 6f75 6e74 6572 203d 2030 0a20 2020  _counter = 0.   
-0000e2a0: 2020 2020 2073 656c 662e 5f69 646c 655f       self._idle_
-0000e2b0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-0000e2c0: 6572 203d 2030 0a20 2020 2020 2020 2073  er = 0.        s
-0000e2d0: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
-0000e2e0: 6f75 6e74 6572 5f6d 6178 203d 2074 7261  ounter_max = tra
-0000e2f0: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
-0000e300: 6d61 780a 0a20 2020 2020 2020 2023 2056  max..        # V
-0000e310: 6172 6961 626c 6573 2066 726f 6d20 6461  ariables from da
-0000e320: 736b 2e63 6f6e 6669 672c 2063 6163 6865  sk.config, cache
-0000e330: 6420 6279 205f 5f69 6e69 745f 5f20 666f  d by __init__ fo
-0000e340: 7220 7065 7266 6f72 6d61 6e63 650a 2020  r performance.  
-0000e350: 2020 2020 2020 7365 6c66 2e55 4e4b 4e4f        self.UNKNO
-0000e360: 574e 5f54 4153 4b5f 4455 5241 5449 4f4e  WN_TASK_DURATION
-0000e370: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
-0000e380: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
-0000e390: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0000e3a0: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-0000e3b0: 6564 756c 6572 2e75 6e6b 6e6f 776e 2d74  eduler.unknown-t
-0000e3c0: 6173 6b2d 6475 7261 7469 6f6e 2229 0a20  ask-duration"). 
-0000e3d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000e3e0: 2073 656c 662e 4d45 4d4f 5259 5f52 4543   self.MEMORY_REC
-0000e3f0: 454e 545f 544f 5f4f 4c44 5f54 494d 4520  ENT_TO_OLD_TIME 
-0000e400: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
-0000e410: 6128 0a20 2020 2020 2020 2020 2020 2064  a(.            d
-0000e420: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-0000e430: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-0000e440: 6572 2e6d 656d 6f72 792e 7265 6365 6e74  er.memory.recent
-0000e450: 2d74 6f2d 6f6c 642d 7469 6d65 2229 0a20  -to-old-time"). 
-0000e460: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000e470: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
-0000e480: 414c 414e 4345 5f4d 4541 5355 5245 203d  ALANCE_MEASURE =
-0000e490: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
-0000e4a0: 280a 2020 2020 2020 2020 2020 2020 2264  (.            "d
-0000e4b0: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-0000e4c0: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
-0000e4d0: 6365 2e6d 6561 7375 7265 220a 2020 2020  ce.measure".    
-0000e4e0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0000e4f0: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
-0000e500: 4e43 455f 5345 4e44 4552 5f4d 494e 203d  NCE_SENDER_MIN =
-0000e510: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
-0000e520: 280a 2020 2020 2020 2020 2020 2020 2264  (.            "d
-0000e530: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-0000e540: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
-0000e550: 6365 2e73 656e 6465 722d 6d69 6e22 0a20  ce.sender-min". 
-0000e560: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000e570: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
-0000e580: 414c 414e 4345 5f52 4543 4950 4945 4e54  ALANCE_RECIPIENT
-0000e590: 5f4d 4158 203d 2064 6173 6b2e 636f 6e66  _MAX = dask.conf
-0000e5a0: 6967 2e67 6574 280a 2020 2020 2020 2020  ig.get(.        
-0000e5b0: 2020 2020 2264 6973 7472 6962 7574 6564      "distributed
-0000e5c0: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
-0000e5d0: 6562 616c 616e 6365 2e72 6563 6970 6965  ebalance.recipie
-0000e5e0: 6e74 2d6d 6178 220a 2020 2020 2020 2020  nt-max".        
-0000e5f0: 290a 2020 2020 2020 2020 7365 6c66 2e4d  ).        self.M
-0000e600: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
-0000e610: 4841 4c46 5f47 4150 203d 2028 0a20 2020  HALF_GAP = (.   
-0000e620: 2020 2020 2020 2020 2064 6173 6b2e 636f           dask.co
-0000e630: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-0000e640: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-0000e650: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
-0000e660: 6e64 6572 2d72 6563 6970 6965 6e74 2d67  nder-recipient-g
-0000e670: 6170 2229 0a20 2020 2020 2020 2020 2020  ap").           
-0000e680: 202f 2032 2e30 0a20 2020 2020 2020 2029   / 2.0.        )
-0000e690: 0a0a 2020 2020 2020 2020 7365 6c66 2e57  ..        self.W
-0000e6a0: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
-0000e6b0: 203d 2064 6173 6b2e 636f 6e66 6967 2e67   = dask.config.g
-0000e6c0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-0000e6d0: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-0000e6e0: 6564 756c 6572 2e77 6f72 6b65 722d 7361  eduler.worker-sa
-0000e6f0: 7475 7261 7469 6f6e 220a 2020 2020 2020  turation".      
-0000e700: 2020 290a 2020 2020 2020 2020 6966 2073    ).        if s
-0000e710: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
-0000e720: 4154 494f 4e20 3d3d 2022 696e 6622 3a0a  ATION == "inf":.
-0000e730: 2020 2020 2020 2020 2020 2020 2320 5370              # Sp
-0000e740: 6563 6961 6c20 6361 7365 206e 6563 6573  ecial case neces
-0000e750: 7361 7279 2062 6563 6175 7365 2074 6865  sary because the
-0000e760: 7265 2773 206e 6f20 7761 7920 746f 2070  re's no way to p
-0000e770: 6172 7365 2061 2066 6c6f 6174 2069 6e66  arse a float inf
-0000e780: 696e 6974 790a 2020 2020 2020 2020 2020  inity.          
-0000e790: 2020 2320 6672 6f6d 2061 2044 4153 4b5f    # from a DASK_
-0000e7a0: 2a20 656e 7669 726f 6e6d 656e 7420 7661  * environment va
-0000e7b0: 7269 6162 6c65 0a20 2020 2020 2020 2020  riable.         
-0000e7c0: 2020 2073 656c 662e 574f 524b 4552 5f53     self.WORKER_S
-0000e7d0: 4154 5552 4154 494f 4e20 3d20 6d61 7468  ATURATION = math
-0000e7e0: 2e69 6e66 0a20 2020 2020 2020 2069 6620  .inf.        if 
-0000e7f0: 280a 2020 2020 2020 2020 2020 2020 6e6f  (.            no
-0000e800: 7420 6973 696e 7374 616e 6365 2873 656c  t isinstance(sel
-0000e810: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
-0000e820: 494f 4e2c 2028 696e 742c 2066 6c6f 6174  ION, (int, float
-0000e830: 2929 0a20 2020 2020 2020 2020 2020 206f  )).            o
-0000e840: 7220 7365 6c66 2e57 4f52 4b45 525f 5341  r self.WORKER_SA
-0000e850: 5455 5241 5449 4f4e 203c 3d20 300a 2020  TURATION <= 0.  
-0000e860: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-0000e870: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0000e880: 4572 726f 7228 2020 2320 7072 6167 6d61  Error(  # pragma
-0000e890: 3a20 6e6f 636f 7665 720a 2020 2020 2020  : nocover.      
-0000e8a0: 2020 2020 2020 2020 2020 2260 6469 7374            "`dist
-0000e8b0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0000e8c0: 722e 776f 726b 6572 2d73 6174 7572 6174  r.worker-saturat
-0000e8d0: 696f 6e60 206d 7573 7420 6265 2061 2066  ion` must be a f
-0000e8e0: 6c6f 6174 203e 2030 3b20 676f 7420 220a  loat > 0; got ".
-0000e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e900: 2b20 7265 7072 2873 656c 662e 574f 524b  + repr(self.WORK
-0000e910: 4552 5f53 4154 5552 4154 494f 4e29 0a20  ER_SATURATION). 
-0000e920: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0000e930: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-0000e940: 6465 6620 6d65 6d6f 7279 2873 656c 6629  def memory(self)
-0000e950: 202d 3e20 4d65 6d6f 7279 5374 6174 653a   -> MemoryState:
-0000e960: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000e970: 4d65 6d6f 7279 5374 6174 652e 7375 6d28  MemoryState.sum(
-0000e980: 2a28 772e 6d65 6d6f 7279 2066 6f72 2077  *(w.memory for w
-0000e990: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0000e9a0: 2e76 616c 7565 7328 2929 290a 0a20 2020  .values()))..   
-0000e9b0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-0000e9c0: 6566 205f 5f70 6469 6374 5f5f 2873 656c  ef __pdict__(sel
-0000e9d0: 6629 202d 3e20 6469 6374 5b73 7472 2c20  f) -> dict[str, 
-0000e9e0: 416e 795d 3a0a 2020 2020 2020 2020 7265  Any]:.        re
-0000e9f0: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
-0000ea00: 2020 2022 6261 6e64 7769 6474 6822 3a20     "bandwidth": 
-0000ea10: 7365 6c66 2e62 616e 6477 6964 7468 2c0a  self.bandwidth,.
-0000ea20: 2020 2020 2020 2020 2020 2020 2272 6573              "res
-0000ea30: 6f75 7263 6573 223a 2073 656c 662e 7265  ources": self.re
-0000ea40: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
-0000ea50: 2020 2020 2022 7361 7475 7261 7465 6422       "saturated"
-0000ea60: 3a20 7365 6c66 2e73 6174 7572 6174 6564  : self.saturated
-0000ea70: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
-0000ea80: 6e72 756e 6e61 626c 6522 3a20 7365 6c66  nrunnable": self
-0000ea90: 2e75 6e72 756e 6e61 626c 652c 0a20 2020  .unrunnable,.   
-0000eaa0: 2020 2020 2020 2020 2022 7175 6575 6564           "queued
-0000eab0: 223a 2073 656c 662e 7175 6575 6564 2c0a  ": self.queued,.
-0000eac0: 2020 2020 2020 2020 2020 2020 226e 5f74              "n_t
-0000ead0: 6173 6b73 223a 2073 656c 662e 6e5f 7461  asks": self.n_ta
-0000eae0: 736b 732c 0a20 2020 2020 2020 2020 2020  sks,.           
-0000eaf0: 2022 756e 6b6e 6f77 6e5f 6475 7261 7469   "unknown_durati
-0000eb00: 6f6e 7322 3a20 7365 6c66 2e75 6e6b 6e6f  ons": self.unkno
-0000eb10: 776e 5f64 7572 6174 696f 6e73 2c0a 2020  wn_durations,.  
-0000eb20: 2020 2020 2020 2020 2020 2276 616c 6964            "valid
-0000eb30: 6174 6522 3a20 7365 6c66 2e76 616c 6964  ate": self.valid
-0000eb40: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
-0000eb50: 2022 7461 736b 7322 3a20 7365 6c66 2e74   "tasks": self.t
-0000eb60: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-0000eb70: 2020 2274 6173 6b5f 6772 6f75 7073 223a    "task_groups":
-0000eb80: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-0000eb90: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0000eba0: 7461 736b 5f70 7265 6669 7865 7322 3a20  task_prefixes": 
-0000ebb0: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
-0000ebc0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0000ebd0: 2274 6f74 616c 5f6e 7468 7265 6164 7322  "total_nthreads"
-0000ebe0: 3a20 7365 6c66 2e74 6f74 616c 5f6e 7468  : self.total_nth
-0000ebf0: 7265 6164 732c 0a20 2020 2020 2020 2020  reads,.         
-0000ec00: 2020 2022 746f 7461 6c5f 6f63 6375 7061     "total_occupa
-0000ec10: 6e63 7922 3a20 7365 6c66 2e74 6f74 616c  ncy": self.total
-0000ec20: 5f6f 6363 7570 616e 6379 2c0a 2020 2020  _occupancy,.    
-0000ec30: 2020 2020 2020 2020 2265 7272 6564 5f74          "erred_t
-0000ec40: 6173 6b73 223a 2073 656c 662e 6572 7265  asks": self.erre
-0000ec50: 645f 7461 736b 732c 0a20 2020 2020 2020  d_tasks,.       
-0000ec60: 2020 2020 2022 6578 7465 6e73 696f 6e73       "extensions
-0000ec70: 223a 2073 656c 662e 6578 7465 6e73 696f  ": self.extensio
-0000ec80: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-0000ec90: 2263 6c69 656e 7473 223a 2073 656c 662e  "clients": self.
-0000eca0: 636c 6965 6e74 732c 0a20 2020 2020 2020  clients,.       
-0000ecb0: 2020 2020 2022 776f 726b 6572 7322 3a20       "workers": 
-0000ecc0: 7365 6c66 2e77 6f72 6b65 7273 2c0a 2020  self.workers,.  
-0000ecd0: 2020 2020 2020 2020 2020 2269 646c 6522            "idle"
-0000ece0: 3a20 7365 6c66 2e69 646c 652c 0a20 2020  : self.idle,.   
-0000ecf0: 2020 2020 2020 2020 2022 686f 7374 5f69           "host_i
-0000ed00: 6e66 6f22 3a20 7365 6c66 2e68 6f73 745f  nfo": self.host_
-0000ed10: 696e 666f 2c0a 2020 2020 2020 2020 7d0a  info,.        }.
-0000ed20: 0a20 2020 2064 6566 206e 6577 5f74 6173  .    def new_tas
-0000ed30: 6b28 0a20 2020 2020 2020 2073 656c 662c  k(.        self,
-0000ed40: 0a20 2020 2020 2020 206b 6579 3a20 7374  .        key: st
-0000ed50: 722c 0a20 2020 2020 2020 2073 7065 633a  r,.        spec:
-0000ed60: 206f 626a 6563 742c 0a20 2020 2020 2020   object,.       
-0000ed70: 2073 7461 7465 3a20 5461 736b 5374 6174   state: TaskStat
-0000ed80: 6553 7461 7465 2c0a 2020 2020 2020 2020  eState,.        
-0000ed90: 636f 6d70 7574 6174 696f 6e3a 2043 6f6d  computation: Com
-0000eda0: 7075 7461 7469 6f6e 207c 204e 6f6e 6520  putation | None 
-0000edb0: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
-0000edc0: 2054 6173 6b53 7461 7465 3a0a 2020 2020   TaskState:.    
-0000edd0: 2020 2020 2222 2243 7265 6174 6520 6120      """Create a 
-0000ede0: 6e65 7720 7461 736b 2c20 616e 6420 6173  new task, and as
-0000edf0: 736f 6369 6174 6564 2073 7461 7465 7322  sociated states"
-0000ee00: 2222 0a20 2020 2020 2020 2074 7320 3d20  "".        ts = 
-0000ee10: 5461 736b 5374 6174 6528 6b65 792c 2073  TaskState(key, s
-0000ee20: 7065 632c 2073 7461 7465 290a 0a20 2020  pec, state)..   
-0000ee30: 2020 2020 2070 7265 6669 785f 6b65 7920       prefix_key 
-0000ee40: 3d20 6b65 795f 7370 6c69 7428 6b65 7929  = key_split(key)
-0000ee50: 0a20 2020 2020 2020 2074 7020 3d20 7365  .        tp = se
-0000ee60: 6c66 2e74 6173 6b5f 7072 6566 6978 6573  lf.task_prefixes
-0000ee70: 2e67 6574 2870 7265 6669 785f 6b65 7929  .get(prefix_key)
-0000ee80: 0a20 2020 2020 2020 2069 6620 7470 2069  .        if tp i
-0000ee90: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000eea0: 2020 2020 7365 6c66 2e74 6173 6b5f 7072      self.task_pr
-0000eeb0: 6566 6978 6573 5b70 7265 6669 785f 6b65  efixes[prefix_ke
-0000eec0: 795d 203d 2074 7020 3d20 5461 736b 5072  y] = tp = TaskPr
-0000eed0: 6566 6978 2870 7265 6669 785f 6b65 7929  efix(prefix_key)
-0000eee0: 0a20 2020 2020 2020 2074 732e 7072 6566  .        ts.pref
-0000eef0: 6978 203d 2074 700a 0a20 2020 2020 2020  ix = tp..       
-0000ef00: 2067 726f 7570 5f6b 6579 203d 2074 732e   group_key = ts.
-0000ef10: 6772 6f75 705f 6b65 790a 2020 2020 2020  group_key.      
-0000ef20: 2020 7467 203d 2073 656c 662e 7461 736b    tg = self.task
-0000ef30: 5f67 726f 7570 732e 6765 7428 6772 6f75  _groups.get(grou
-0000ef40: 705f 6b65 7929 0a20 2020 2020 2020 2069  p_key).        i
-0000ef50: 6620 7467 2069 7320 4e6f 6e65 3a0a 2020  f tg is None:.  
-0000ef60: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-0000ef70: 6173 6b5f 6772 6f75 7073 5b67 726f 7570  ask_groups[group
-0000ef80: 5f6b 6579 5d20 3d20 7467 203d 2054 6173  _key] = tg = Tas
-0000ef90: 6b47 726f 7570 2867 726f 7570 5f6b 6579  kGroup(group_key
-0000efa0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000efb0: 2063 6f6d 7075 7461 7469 6f6e 3a0a 2020   computation:.  
-0000efc0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0000efd0: 6d70 7574 6174 696f 6e2e 6772 6f75 7073  mputation.groups
-0000efe0: 2e61 6464 2874 6729 0a20 2020 2020 2020  .add(tg).       
-0000eff0: 2020 2020 2074 672e 7072 6566 6978 203d       tg.prefix =
-0000f000: 2074 700a 2020 2020 2020 2020 2020 2020   tp.            
-0000f010: 7470 2e67 726f 7570 732e 6170 7065 6e64  tp.groups.append
-0000f020: 2874 6729 0a20 2020 2020 2020 2074 672e  (tg).        tg.
-0000f030: 6164 6428 7473 290a 0a20 2020 2020 2020  add(ts)..       
-0000f040: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-0000f050: 203d 2074 730a 0a20 2020 2020 2020 2072   = ts..        r
-0000f060: 6574 7572 6e20 7473 0a0a 2020 2020 6465  eturn ts..    de
-0000f070: 6620 5f63 6c65 6172 5f74 6173 6b5f 7374  f _clear_task_st
-0000f080: 6174 6528 7365 6c66 2920 2d3e 204e 6f6e  ate(self) -> Non
-0000f090: 653a 0a20 2020 2020 2020 206c 6f67 6765  e:.        logge
-0000f0a0: 722e 6465 6275 6728 2243 6c65 6172 2074  r.debug("Clear t
-0000f0b0: 6173 6b20 7374 6174 6522 290a 2020 2020  ask state").    
-0000f0c0: 2020 2020 666f 7220 636f 6c6c 6563 7469      for collecti
-0000f0d0: 6f6e 2069 6e20 280a 2020 2020 2020 2020  on in (.        
-0000f0e0: 2020 2020 7365 6c66 2e75 6e72 756e 6e61      self.unrunna
-0000f0f0: 626c 652c 0a20 2020 2020 2020 2020 2020  ble,.           
-0000f100: 2073 656c 662e 6572 7265 645f 7461 736b   self.erred_task
-0000f110: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
-0000f120: 656c 662e 636f 6d70 7574 6174 696f 6e73  elf.computations
-0000f130: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-0000f140: 6c66 2e74 6173 6b5f 7072 6566 6978 6573  lf.task_prefixes
-0000f150: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-0000f160: 6c66 2e74 6173 6b5f 6772 6f75 7073 2c0a  lf.task_groups,.
-0000f170: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000f180: 2e74 6173 6b5f 6d65 7461 6461 7461 2c0a  .task_metadata,.
-0000f190: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000f1a0: 2e75 6e6b 6e6f 776e 5f64 7572 6174 696f  .unknown_duratio
-0000f1b0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-0000f1c0: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
-0000f1d0: 7461 736b 732c 0a20 2020 2020 2020 2029  tasks,.        )
-0000f1e0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-0000f1f0: 6c6c 6563 7469 6f6e 2e63 6c65 6172 2829  llection.clear()
-0000f200: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-0000f210: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-0000f220: 2020 2020 6465 6620 746f 7461 6c5f 6f63      def total_oc
-0000f230: 6375 7061 6e63 7928 7365 6c66 2920 2d3e  cupancy(self) ->
-0000f240: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
-0000f250: 7265 7475 726e 2073 656c 662e 5f63 616c  return self._cal
-0000f260: 635f 6f63 6375 7061 6e63 7928 0a20 2020  c_occupancy(.   
-0000f270: 2020 2020 2020 2020 2073 656c 662e 5f74           self._t
-0000f280: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-0000f290: 5f67 6c6f 6261 6c2c 0a20 2020 2020 2020  _global,.       
-0000f2a0: 2020 2020 2073 656c 662e 5f6e 6574 776f       self._netwo
-0000f2b0: 726b 5f6f 6363 5f67 6c6f 6261 6c2c 0a20  rk_occ_global,. 
-0000f2c0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-0000f2d0: 6620 5f63 616c 635f 6f63 6375 7061 6e63  f _calc_occupanc
-0000f2e0: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
-0000f2f0: 0a20 2020 2020 2020 2074 6173 6b5f 7072  .        task_pr
-0000f300: 6566 6978 5f63 6f75 6e74 3a20 6469 6374  efix_count: dict
-0000f310: 5b73 7472 2c20 696e 745d 2c0a 2020 2020  [str, int],.    
-0000f320: 2020 2020 6e65 7477 6f72 6b5f 6f63 633a      network_occ:
-0000f330: 2066 6c6f 6174 2c0a 2020 2020 2920 2d3e   float,.    ) ->
-0000f340: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
-0000f350: 7265 7320 3d20 302e 300a 2020 2020 2020  res = 0.0.      
-0000f360: 2020 666f 7220 7072 6566 6978 5f6e 616d    for prefix_nam
-0000f370: 652c 2063 6f75 6e74 2069 6e20 7461 736b  e, count in task
-0000f380: 5f70 7265 6669 785f 636f 756e 742e 6974  _prefix_count.it
-0000f390: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-0000f3a0: 2020 2023 2054 4f44 4f3a 2044 6561 6c20     # TODO: Deal 
-0000f3b0: 7769 7468 2075 6e6b 6e6f 776e 2074 6173  with unknown tas
-0000f3c0: 6b73 2062 6574 7465 720a 2020 2020 2020  ks better.      
-0000f3d0: 2020 2020 2020 7072 6566 6978 203d 2073        prefix = s
-0000f3e0: 656c 662e 7461 736b 5f70 7265 6669 7865  elf.task_prefixe
-0000f3f0: 735b 7072 6566 6978 5f6e 616d 655d 0a20  s[prefix_name]. 
-0000f400: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000f410: 7420 7072 6566 6978 2069 7320 6e6f 7420  t prefix is not 
-0000f420: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0000f430: 2064 7572 6174 696f 6e20 3d20 7072 6566   duration = pref
-0000f440: 6978 2e64 7572 6174 696f 6e5f 6176 6572  ix.duration_aver
-0000f450: 6167 650a 2020 2020 2020 2020 2020 2020  age.            
-0000f460: 6966 2064 7572 6174 696f 6e20 3c20 303a  if duration < 0:
-0000f470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f480: 2069 6620 7072 6566 6978 2e6d 6178 5f65   if prefix.max_e
-0000f490: 7865 635f 7469 6d65 203e 2030 3a0a 2020  xec_time > 0:.  
-0000f4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4b0: 2020 6475 7261 7469 6f6e 203d 2032 202a    duration = 2 *
-0000f4c0: 2070 7265 6669 782e 6d61 785f 6578 6563   prefix.max_exec
-0000f4d0: 5f74 696d 650a 2020 2020 2020 2020 2020  _time.          
-0000f4e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f500: 6475 7261 7469 6f6e 203d 2073 656c 662e  duration = self.
-0000f510: 554e 4b4e 4f57 4e5f 5441 534b 5f44 5552  UNKNOWN_TASK_DUR
-0000f520: 4154 494f 4e0a 2020 2020 2020 2020 2020  ATION.          
-0000f530: 2020 7265 7320 2b3d 2064 7572 6174 696f    res += duratio
-0000f540: 6e20 2a20 636f 756e 740a 2020 2020 2020  n * count.      
-0000f550: 2020 6f63 6320 3d20 7265 7320 2b20 6e65    occ = res + ne
-0000f560: 7477 6f72 6b5f 6f63 6320 2f20 7365 6c66  twork_occ / self
-0000f570: 2e62 616e 6477 6964 7468 0a20 2020 2020  .bandwidth.     
-0000f580: 2020 2061 7373 6572 7420 6f63 6320 3e3d     assert occ >=
-0000f590: 2030 2c20 6f63 630a 2020 2020 2020 2020   0, occ.        
-0000f5a0: 7265 7475 726e 206f 6363 0a0a 2020 2020  return occ..    
-0000f5b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000f5c0: 2323 2323 230a 2020 2020 2320 5374 6174  #####.    # Stat
-0000f5d0: 6520 5472 616e 7369 7469 6f6e 7320 230a  e Transitions #.
-0000f5e0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-0000f5f0: 2323 2323 2323 2323 230a 0a20 2020 2064  #########..    d
-0000f600: 6566 205f 7472 616e 7369 7469 6f6e 280a  ef _transition(.
-0000f610: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
-0000f620: 793a 2073 7472 2c20 6669 6e69 7368 3a20  y: str, finish: 
-0000f630: 5461 736b 5374 6174 6553 7461 7465 2c20  TaskStateState, 
-0000f640: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-0000f650: 2c20 2a2a 6b77 6172 6773 3a20 416e 790a  , **kwargs: Any.
-0000f660: 2020 2020 2920 2d3e 2052 6563 734d 7367      ) -> RecsMsg
-0000f670: 733a 0a20 2020 2020 2020 2022 2222 5472  s:.        """Tr
-0000f680: 616e 7369 7469 6f6e 2061 206b 6579 2066  ansition a key f
-0000f690: 726f 6d20 6974 7320 6375 7272 656e 7420  rom its current 
-0000f6a0: 7374 6174 6520 746f 2074 6865 2066 696e  state to the fin
-0000f6b0: 6973 6820 7374 6174 650a 0a20 2020 2020  ish state..     
-0000f6c0: 2020 2045 7861 6d70 6c65 730a 2020 2020     Examples.    
-0000f6d0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-0000f6e0: 2020 2020 203e 3e3e 2073 656c 662e 5f74       >>> self._t
-0000f6f0: 7261 6e73 6974 696f 6e28 2778 272c 2027  ransition('x', '
-0000f700: 7761 6974 696e 6727 290a 2020 2020 2020  waiting').      
-0000f710: 2020 7b27 7827 3a20 2770 726f 6365 7373    {'x': 'process
-0000f720: 696e 6727 7d2c 207b 7d2c 207b 7d0a 0a20  ing'}, {}, {}.. 
-0000f730: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
-0000f740: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
-0000f750: 2020 2020 2020 2054 7570 6c65 206f 663a         Tuple of:
-0000f760: 0a0a 2020 2020 2020 2020 2d20 4469 6374  ..        - Dict
-0000f770: 696f 6e61 7279 206f 6620 7265 636f 6d6d  ionary of recomm
-0000f780: 656e 6461 7469 6f6e 7320 666f 7220 6675  endations for fu
-0000f790: 7475 7265 2074 7261 6e73 6974 696f 6e73  ture transitions
-0000f7a0: 207b 6b65 793a 206e 6577 2073 7461 7465   {key: new state
-0000f7b0: 7d0a 2020 2020 2020 2020 2d20 4d65 7373  }.        - Mess
-0000f7c0: 6167 6573 2074 6f20 636c 6965 6e74 7320  ages to clients 
-0000f7d0: 7b63 6c69 656e 7420 6164 6472 6573 733a  {client address:
-0000f7e0: 205b 6d73 672c 206d 7367 2c20 2e2e 2e5d   [msg, msg, ...]
-0000f7f0: 7d0a 2020 2020 2020 2020 2d20 4d65 7373  }.        - Mess
-0000f800: 6167 6573 2074 6f20 776f 726b 6572 7320  ages to workers 
-0000f810: 7b77 6f72 6b65 7220 6164 6472 6573 733a  {worker address:
-0000f820: 205b 6d73 672c 206d 7367 2c20 2e2e 2e5d   [msg, msg, ...]
-0000f830: 7d0a 0a20 2020 2020 2020 2053 6565 2041  }..        See A
-0000f840: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-0000f850: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-0000f860: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
-0000f870: 6e73 203a 2074 7261 6e73 6974 6976 6520  ns : transitive 
-0000f880: 7665 7273 696f 6e20 6f66 2074 6869 7320  version of this 
-0000f890: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
-0000f8a0: 2022 2222 0a20 2020 2020 2020 2074 7279   """.        try
-0000f8b0: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
-0000f8c0: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-0000f8d0: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
-0000f8e0: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
-0000f8f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f900: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-0000f910: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-0000f920: 7374 6172 7420 3d20 7473 2e5f 7374 6174  start = ts._stat
-0000f930: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-0000f940: 2073 7461 7274 203d 3d20 6669 6e69 7368   start == finish
-0000f950: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f960: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-0000f970: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
-0000f980: 2023 204e 6f74 6573 3a0a 2020 2020 2020   # Notes:.      
-0000f990: 2020 2020 2020 2320 2d20 696e 2063 6173        # - in cas
-0000f9a0: 6520 6f66 2074 7261 6e73 6974 696f 6e20  e of transition 
-0000f9b0: 7468 726f 7567 6820 7265 6c65 6173 6564  through released
-0000f9c0: 2c20 7468 6973 2063 6f75 6e74 6572 2069  , this counter i
-0000f9d0: 7320 696e 6372 656d 656e 7465 6420 6279  s incremented by
-0000f9e0: 2032 0a20 2020 2020 2020 2020 2020 2023   2.            #
-0000f9f0: 202d 2074 6869 7320 696e 6372 6561 7365   - this increase
-0000fa00: 2068 6170 7065 6e73 2062 6566 6f72 6520   happens before 
-0000fa10: 7468 6520 6163 7475 616c 2074 7261 6e73  the actual trans
-0000fa20: 6974 696f 6e73 2c20 736f 2074 6861 7420  itions, so that 
-0000fa30: 6974 2063 616e 0a20 2020 2020 2020 2020  it can.         
-0000fa40: 2020 2023 2020 2063 6174 6368 2070 6f74     #   catch pot
-0000fa50: 656e 7469 616c 2069 6e66 696e 6974 6520  ential infinite 
-0000fa60: 7265 6375 7273 696f 6e73 0a20 2020 2020  recursions.     
-0000fa70: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
-0000fa80: 7369 7469 6f6e 5f63 6f75 6e74 6572 202b  sition_counter +
-0000fa90: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-0000faa0: 6966 2073 656c 662e 7472 616e 7369 7469  if self.transiti
-0000fab0: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 3a0a  on_counter_max:.
-0000fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fad0: 6173 7365 7274 2073 656c 662e 7472 616e  assert self.tran
-0000fae0: 7369 7469 6f6e 5f63 6f75 6e74 6572 203c  sition_counter <
-0000faf0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-0000fb00: 5f63 6f75 6e74 6572 5f6d 6178 0a0a 2020  _counter_max..  
-0000fb10: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0000fb20: 656e 6461 7469 6f6e 733a 2064 6963 7420  endations: dict 
-0000fb30: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
-0000fb40: 2077 6f72 6b65 725f 6d73 6773 3a20 6469   worker_msgs: di
-0000fb50: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
-0000fb60: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
-0000fb70: 2064 6963 7420 3d20 7b7d 0a0a 2020 2020   dict = {}..    
-0000fb80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000fb90: 706c 7567 696e 733a 0a20 2020 2020 2020  plugins:.       
-0000fba0: 2020 2020 2020 2020 2064 6570 656e 6465           depende
-0000fbb0: 6e74 7320 3d20 7365 7428 7473 2e64 6570  nts = set(ts.dep
-0000fbc0: 656e 6465 6e74 7329 0a20 2020 2020 2020  endents).       
-0000fbd0: 2020 2020 2020 2020 2064 6570 656e 6465           depende
-0000fbe0: 6e63 6965 7320 3d20 7365 7428 7473 2e64  ncies = set(ts.d
-0000fbf0: 6570 656e 6465 6e63 6965 7329 0a0a 2020  ependencies)..  
-0000fc00: 2020 2020 2020 2020 2020 6675 6e63 203d            func =
-0000fc10: 2073 656c 662e 5f54 5241 4e53 4954 494f   self._TRANSITIO
-0000fc20: 4e53 5f54 4142 4c45 2e67 6574 2828 7374  NS_TABLE.get((st
-0000fc30: 6172 742c 2066 696e 6973 6829 290a 2020  art, finish)).  
-0000fc40: 2020 2020 2020 2020 2020 6966 2066 756e            if fun
-0000fc50: 6320 6973 206e 6f74 204e 6f6e 653a 0a20  c is not None:. 
-0000fc60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000fc70: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-0000fc80: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-0000fc90: 6b65 725f 6d73 6773 203d 2066 756e 6328  ker_msgs = func(
-0000fca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fcb0: 2020 2020 2073 656c 662c 206b 6579 2c20       self, key, 
-0000fcc0: 7374 696d 756c 7573 5f69 642c 202a 2a6b  stimulus_id, **k
-0000fcd0: 7761 7267 730a 2020 2020 2020 2020 2020  wargs.          
-0000fce0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000fcf0: 2020 2020 2065 6c69 6620 2272 656c 6561       elif "relea
-0000fd00: 7365 6422 206e 6f74 2069 6e20 2873 7461  sed" not in (sta
-0000fd10: 7274 2c20 6669 6e69 7368 293a 0a20 2020  rt, finish):.   
-0000fd20: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0000fd30: 6572 7420 6e6f 7420 6b77 6172 6773 2c20  ert not kwargs, 
-0000fd40: 286b 7761 7267 732c 2073 7461 7274 2c20  (kwargs, start, 
-0000fd50: 6669 6e69 7368 290a 2020 2020 2020 2020  finish).        
-0000fd60: 2020 2020 2020 2020 615f 7265 6373 2c20          a_recs, 
-0000fd70: 615f 636d 7367 732c 2061 5f77 6d73 6773  a_cmsgs, a_wmsgs
-0000fd80: 203d 2073 656c 662e 5f74 7261 6e73 6974   = self._transit
-0000fd90: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-0000fda0: 2020 2020 2020 2020 206b 6579 2c20 2272           key, "r
-0000fdb0: 656c 6561 7365 6422 2c20 7374 696d 756c  eleased", stimul
-0000fdc0: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
-0000fdd0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000fde0: 2020 2020 2020 2020 2076 203d 2061 5f72           v = a_r
-0000fdf0: 6563 732e 6765 7428 6b65 792c 2066 696e  ecs.get(key, fin
-0000fe00: 6973 6829 0a20 2020 2020 2020 2020 2020  ish).           
-0000fe10: 2020 2020 2066 756e 6320 3d20 7365 6c66       func = self
-0000fe20: 2e5f 5452 414e 5349 5449 4f4e 535f 5441  ._TRANSITIONS_TA
-0000fe30: 424c 455b 2272 656c 6561 7365 6422 2c20  BLE["released", 
-0000fe40: 765d 0a20 2020 2020 2020 2020 2020 2020  v].             
-0000fe50: 2020 2062 5f72 6563 732c 2062 5f63 6d73     b_recs, b_cms
-0000fe60: 6773 2c20 625f 776d 7367 7320 3d20 6675  gs, b_wmsgs = fu
-0000fe70: 6e63 2873 656c 662c 206b 6579 2c20 7374  nc(self, key, st
-0000fe80: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-0000fe90: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0000fea0: 6d6d 656e 6461 7469 6f6e 732e 7570 6461  mmendations.upda
-0000feb0: 7465 2861 5f72 6563 7329 0a20 2020 2020  te(a_recs).     
-0000fec0: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-0000fed0: 2c20 6e65 775f 6d73 6773 2069 6e20 615f  , new_msgs in a_
-0000fee0: 636d 7367 732e 6974 656d 7328 293a 0a20  cmsgs.items():. 
-0000fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff00: 2020 2063 6c69 656e 745f 6d73 6773 2e73     client_msgs.s
-0000ff10: 6574 6465 6661 756c 7428 632c 205b 5d29  etdefault(c, [])
-0000ff20: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
-0000ff30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000ff40: 2020 666f 7220 772c 206e 6577 5f6d 7367    for w, new_msg
-0000ff50: 7320 696e 2061 5f77 6d73 6773 2e69 7465  s in a_wmsgs.ite
-0000ff60: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0000ff70: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-0000ff80: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
-0000ff90: 2877 2c20 5b5d 292e 6578 7465 6e64 286e  (w, []).extend(n
-0000ffa0: 6577 5f6d 7367 7329 0a0a 2020 2020 2020  ew_msgs)..      
-0000ffb0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0000ffc0: 656e 6461 7469 6f6e 732e 7570 6461 7465  endations.update
-0000ffd0: 2862 5f72 6563 7329 0a20 2020 2020 2020  (b_recs).       
-0000ffe0: 2020 2020 2020 2020 2066 6f72 2063 2c20           for c, 
-0000fff0: 6e65 775f 6d73 6773 2069 6e20 625f 636d  new_msgs in b_cm
-00010000: 7367 732e 6974 656d 7328 293a 0a20 2020  sgs.items():.   
-00010010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010020: 2063 6c69 656e 745f 6d73 6773 2e73 6574   client_msgs.set
-00010030: 6465 6661 756c 7428 632c 205b 5d29 2e65  default(c, []).e
-00010040: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
-00010050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010060: 666f 7220 772c 206e 6577 5f6d 7367 7320  for w, new_msgs 
-00010070: 696e 2062 5f77 6d73 6773 2e69 7465 6d73  in b_wmsgs.items
-00010080: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00010090: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-000100a0: 7367 732e 7365 7464 6566 6175 6c74 2877  sgs.setdefault(w
-000100b0: 2c20 5b5d 292e 6578 7465 6e64 286e 6577  , []).extend(new
-000100c0: 5f6d 7367 7329 0a0a 2020 2020 2020 2020  _msgs)..        
-000100d0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
-000100e0: 2272 656c 6561 7365 6422 0a20 2020 2020  "released".     
-000100f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00010100: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00010110: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-00010120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010130: 2020 2020 2066 2249 6d70 6f73 7369 626c       f"Impossibl
-00010140: 6520 7472 616e 7369 7469 6f6e 2066 726f  e transition fro
-00010150: 6d20 7b73 7461 7274 7d20 746f 207b 6669  m {start} to {fi
-00010160: 6e69 7368 7d20 666f 7220 7b6b 6579 2172  nish} for {key!r
-00010170: 7d3a 2022 0a20 2020 2020 2020 2020 2020  }: ".           
-00010180: 2020 2020 2020 2020 2066 227b 7374 696d           f"{stim
-00010190: 756c 7573 5f69 643d 7d2c 207b 6b77 6172  ulus_id=}, {kwar
-000101a0: 6773 3d7d 2c20 7374 6f72 793d 7b73 656c  gs=}, story={sel
-000101b0: 662e 7374 6f72 7928 7473 297d 220a 2020  f.story(ts)}".  
-000101c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000101d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000101e0: 6e6f 7420 7374 696d 756c 7573 5f69 643a  not stimulus_id:
-000101f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010200: 2073 7469 6d75 6c75 735f 6964 203d 2053   stimulus_id = S
-00010210: 5449 4d55 4c55 535f 4944 5f55 4e53 4554  TIMULUS_ID_UNSET
-00010220: 0a0a 2020 2020 2020 2020 2020 2020 6163  ..            ac
-00010230: 7475 616c 5f66 696e 6973 6820 3d20 7473  tual_finish = ts
-00010240: 2e5f 7374 6174 650a 2020 2020 2020 2020  ._state.        
-00010250: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
-00010260: 696f 6e5f 6c6f 672e 6170 7065 6e64 280a  ion_log.append(.
-00010270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010280: 5472 616e 7369 7469 6f6e 280a 2020 2020  Transition(.    
-00010290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102a0: 6b65 792c 2073 7461 7274 2c20 6163 7475  key, start, actu
-000102b0: 616c 5f66 696e 6973 682c 2072 6563 6f6d  al_finish, recom
-000102c0: 6d65 6e64 6174 696f 6e73 2c20 7374 696d  mendations, stim
-000102d0: 756c 7573 5f69 642c 2074 696d 6528 290a  ulus_id, time().
-000102e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102f0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-00010300: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00010310: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00010320: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00010330: 2073 7469 6d75 6c75 735f 6964 203d 3d20   stimulus_id == 
-00010340: 5354 494d 554c 5553 5f49 445f 554e 5345  STIMULUS_ID_UNSE
-00010350: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
-00010360: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
-00010370: 7469 6d65 4572 726f 7228 0a20 2020 2020  timeError(.     
-00010380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010390: 2020 2022 7374 696d 756c 7573 5f69 6420     "stimulus_id 
-000103a0: 6e6f 7420 7365 7420 6475 7269 6e67 2053  not set during S
-000103b0: 6368 6564 756c 6572 2074 7261 6e73 6974  cheduler transit
-000103c0: 696f 6e22 0a20 2020 2020 2020 2020 2020  ion".           
-000103d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000103e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-000103f0: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-00010400: 2020 2020 2020 2020 2020 2020 2022 5472               "Tr
-00010410: 616e 7369 7469 6f6e 6564 2025 7220 2573  ansitioned %r %s
-00010420: 2d3e 2573 2028 6163 7475 616c 3a20 2573  ->%s (actual: %s
-00010430: 292e 2020 436f 6e73 6571 7565 6e63 653a  ).  Consequence:
-00010440: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
-00010450: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
-00010460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010470: 2020 2073 7461 7274 2c0a 2020 2020 2020     start,.      
-00010480: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00010490: 6e69 7368 2c0a 2020 2020 2020 2020 2020  nish,.          
-000104a0: 2020 2020 2020 2020 2020 6163 7475 616c            actual
-000104b0: 5f66 696e 6973 682c 0a20 2020 2020 2020  _finish,.       
-000104c0: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-000104d0: 7428 7265 636f 6d6d 656e 6461 7469 6f6e  t(recommendation
-000104e0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-000104f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00010500: 2020 6966 2073 656c 662e 706c 7567 696e    if self.plugin
-00010510: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00010520: 2020 2023 2054 656d 706f 7261 7269 6c79     # Temporarily
-00010530: 2070 7574 2062 6163 6b20 666f 7267 6f74   put back forgot
-00010540: 7465 6e20 6b65 7920 666f 7220 706c 7567  ten key for plug
-00010550: 696e 2074 6f20 7265 7472 6965 7665 2069  in to retrieve i
-00010560: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00010570: 2020 6966 2074 732e 5f73 7461 7465 203d    if ts._state =
-00010580: 3d20 2266 6f72 676f 7474 656e 223a 0a20  = "forgotten":. 
-00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105a0: 2020 2074 732e 6465 7065 6e64 656e 7473     ts.dependents
-000105b0: 203d 2064 6570 656e 6465 6e74 730a 2020   = dependents.  
-000105c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105d0: 2020 7473 2e64 6570 656e 6465 6e63 6965    ts.dependencie
-000105e0: 7320 3d20 6465 7065 6e64 656e 6369 6573  s = dependencies
-000105f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010600: 2020 2020 2073 656c 662e 7461 736b 735b       self.tasks[
-00010610: 7473 2e6b 6579 5d20 3d20 7473 0a20 2020  ts.key] = ts.   
-00010620: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00010630: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
-00010640: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
-00010650: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
-00010660: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00010670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010680: 2020 2020 2020 2020 2070 6c75 6769 6e2e           plugin.
-00010690: 7472 616e 7369 7469 6f6e 286b 6579 2c20  transition(key, 
-000106a0: 7374 6172 742c 2061 6374 7561 6c5f 6669  start, actual_fi
-000106b0: 6e69 7368 2c20 2a2a 6b77 6172 6773 290a  nish, **kwargs).
-000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106d0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000106e0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-000106f0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00010700: 6767 6572 2e69 6e66 6f28 2250 6c75 6769  gger.info("Plugi
-00010710: 6e20 6661 696c 6564 2077 6974 6820 6578  n failed with ex
-00010720: 6365 7074 696f 6e22 2c20 6578 635f 696e  ception", exc_in
-00010730: 666f 3d54 7275 6529 0a20 2020 2020 2020  fo=True).       
-00010740: 2020 2020 2020 2020 2069 6620 7473 2e73           if ts.s
-00010750: 7461 7465 203d 3d20 2266 6f72 676f 7474  tate == "forgott
-00010760: 656e 223a 0a20 2020 2020 2020 2020 2020  en":.           
-00010770: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
-00010780: 662e 7461 736b 735b 7473 2e6b 6579 5d0a  f.tasks[ts.key].
-00010790: 0a20 2020 2020 2020 2020 2020 2074 6720  .            tg 
-000107a0: 3d20 7473 2e67 726f 7570 0a20 2020 2020  = ts.group.     
-000107b0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-000107c0: 7465 203d 3d20 2266 6f72 676f 7474 656e  te == "forgotten
-000107d0: 2220 616e 6420 7467 2e6e 616d 6520 696e  " and tg.name in
-000107e0: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-000107f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00010800: 2020 2023 2052 656d 6f76 6520 5461 736b     # Remove Task
-00010810: 4772 6f75 7020 6966 2061 6c6c 2074 6173  Group if all tas
-00010820: 6b73 2061 7265 2069 6e20 7468 6520 666f  ks are in the fo
-00010830: 7267 6f74 7465 6e20 7374 6174 650a 2020  rgotten state.  
-00010840: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00010850: 2061 6c6c 2876 203d 3d20 3020 6f72 206b   all(v == 0 or k
-00010860: 203d 3d20 2266 6f72 676f 7474 656e 2220   == "forgotten" 
-00010870: 666f 7220 6b2c 2076 2069 6e20 7467 2e73  for k, v in tg.s
-00010880: 7461 7465 732e 6974 656d 7328 2929 3a0a  tates.items()):.
-00010890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108a0: 2020 2020 7473 2e70 7265 6669 782e 6772      ts.prefix.gr
-000108b0: 6f75 7073 2e72 656d 6f76 6528 7467 290a  oups.remove(tg).
-000108c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108d0: 2020 2020 6465 6c20 7365 6c66 2e74 6173      del self.tas
-000108e0: 6b5f 6772 6f75 7073 5b74 672e 6e61 6d65  k_groups[tg.name
-000108f0: 5d0a 0a20 2020 2020 2020 2020 2020 2072  ]..            r
-00010900: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-00010910: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
-00010920: 6773 2c20 776f 726b 6572 5f6d 7367 730a  gs, worker_msgs.
-00010930: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00010940: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-00010950: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
-00010960: 6570 7469 6f6e 2822 4572 726f 7220 7472  eption("Error tr
-00010970: 616e 7369 7469 6f6e 696e 6720 2572 2066  ansitioning %r f
-00010980: 726f 6d20 2572 2074 6f20 2572 222c 206b  rom %r to %r", k
-00010990: 6579 2c20 7374 6172 742c 2066 696e 6973  ey, start, finis
-000109a0: 6829 0a20 2020 2020 2020 2020 2020 2069  h).            i
-000109b0: 6620 4c4f 475f 5044 423a 0a20 2020 2020  f LOG_PDB:.     
-000109c0: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
-000109d0: 7420 7064 620a 0a20 2020 2020 2020 2020  t pdb..         
-000109e0: 2020 2020 2020 2070 6462 2e73 6574 5f74         pdb.set_t
-000109f0: 7261 6365 2829 0a20 2020 2020 2020 2020  race().         
-00010a00: 2020 2072 6169 7365 0a0a 2020 2020 6465     raise..    de
-00010a10: 6620 5f74 7261 6e73 6974 696f 6e73 280a  f _transitions(.
-00010a20: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00010a30: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00010a40: 7469 6f6e 733a 2052 6563 732c 0a20 2020  tions: Recs,.   
-00010a50: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-00010a60: 3a20 4d73 6773 2c0a 2020 2020 2020 2020  : Msgs,.        
-00010a70: 776f 726b 6572 5f6d 7367 733a 204d 7367  worker_msgs: Msg
-00010a80: 732c 0a20 2020 2020 2020 2073 7469 6d75  s,.        stimu
-00010a90: 6c75 735f 6964 3a20 7374 722c 0a20 2020  lus_id: str,.   
-00010aa0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00010ab0: 2020 2020 2222 2250 726f 6365 7373 2074      """Process t
-00010ac0: 7261 6e73 6974 696f 6e73 2075 6e74 696c  ransitions until
-00010ad0: 206e 6f6e 6520 6172 6520 6c65 6674 0a0a   none are left..
-00010ae0: 2020 2020 2020 2020 5468 6973 2069 6e63          This inc
-00010af0: 6c75 6465 7320 6665 6564 6261 636b 2066  ludes feedback f
-00010b00: 726f 6d20 7072 6576 696f 7573 2074 7261  rom previous tra
-00010b10: 6e73 6974 696f 6e73 2061 6e64 2063 6f6e  nsitions and con
-00010b20: 7469 6e75 6573 2075 6e74 696c 2077 650a  tinues until we.
-00010b30: 2020 2020 2020 2020 7265 6163 6820 6120          reach a 
-00010b40: 7374 6561 6479 2073 7461 7465 0a20 2020  steady state.   
-00010b50: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00010b60: 206b 6579 733a 2073 6574 5b73 7472 5d20   keys: set[str] 
-00010b70: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00010b80: 7265 636f 6d6d 656e 6461 7469 6f6e 7320  recommendations 
-00010b90: 3d20 7265 636f 6d6d 656e 6461 7469 6f6e  = recommendation
-00010ba0: 732e 636f 7079 2829 0a0a 2020 2020 2020  s.copy()..      
-00010bb0: 2020 7768 696c 6520 7265 636f 6d6d 656e    while recommen
-00010bc0: 6461 7469 6f6e 733a 0a20 2020 2020 2020  dations:.       
-00010bd0: 2020 2020 206b 6579 2c20 6669 6e69 7368       key, finish
-00010be0: 203d 2072 6563 6f6d 6d65 6e64 6174 696f   = recommendatio
-00010bf0: 6e73 2e70 6f70 6974 656d 2829 0a20 2020  ns.popitem().   
-00010c00: 2020 2020 2020 2020 206b 6579 732e 6164           keys.ad
-00010c10: 6428 6b65 7929 0a0a 2020 2020 2020 2020  d(key)..        
-00010c20: 2020 2020 6e65 775f 7265 6373 2c20 6e65      new_recs, ne
-00010c30: 775f 636d 7367 732c 206e 6577 5f77 6d73  w_cmsgs, new_wms
-00010c40: 6773 203d 2073 656c 662e 5f74 7261 6e73  gs = self._trans
-00010c50: 6974 696f 6e28 6b65 792c 2066 696e 6973  ition(key, finis
-00010c60: 682c 2073 7469 6d75 6c75 735f 6964 290a  h, stimulus_id).
-00010c70: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-00010c80: 6f6d 6d65 6e64 6174 696f 6e73 2e75 7064  ommendations.upd
-00010c90: 6174 6528 6e65 775f 7265 6373 290a 2020  ate(new_recs).  
-00010ca0: 2020 2020 2020 2020 2020 666f 7220 632c            for c,
-00010cb0: 206e 6577 5f6d 7367 7320 696e 206e 6577   new_msgs in new
-00010cc0: 5f63 6d73 6773 2e69 7465 6d73 2829 3a0a  _cmsgs.items():.
-00010cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ce0: 636c 6965 6e74 5f6d 7367 732e 7365 7464  client_msgs.setd
-00010cf0: 6566 6175 6c74 2863 2c20 5b5d 292e 6578  efault(c, []).ex
-00010d00: 7465 6e64 286e 6577 5f6d 7367 7329 0a20  tend(new_msgs). 
-00010d10: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-00010d20: 2c20 6e65 775f 6d73 6773 2069 6e20 6e65  , new_msgs in ne
-00010d30: 775f 776d 7367 732e 6974 656d 7328 293a  w_wmsgs.items():
-00010d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010d50: 2077 6f72 6b65 725f 6d73 6773 2e73 6574   worker_msgs.set
-00010d60: 6465 6661 756c 7428 772c 205b 5d29 2e65  default(w, []).e
-00010d70: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
-00010d80: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00010d90: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00010da0: 2020 2020 2020 2023 2046 4958 4d45 2064         # FIXME d
-00010db0: 6f77 6e63 6173 7420 616e 7469 7061 7474  owncast antipatt
-00010dc0: 6572 6e0a 2020 2020 2020 2020 2020 2020  ern.            
-00010dd0: 7363 6865 6475 6c65 7220 3d20 6361 7374  scheduler = cast
-00010de0: 2853 6368 6564 756c 6572 2c20 7365 6c66  (Scheduler, self
-00010df0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-00010e00: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
-00010e10: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010e20: 6368 6564 756c 6572 2e76 616c 6964 6174  cheduler.validat
-00010e30: 655f 6b65 7928 6b65 7929 0a0a 2020 2020  e_key(key)..    
-00010e40: 6465 6620 7472 616e 7369 7469 6f6e 5f72  def transition_r
-00010e50: 656c 6561 7365 645f 7761 6974 696e 6728  eleased_waiting(
-00010e60: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-00010e70: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00010e80: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-00010e90: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00010ea0: 2e74 6173 6b73 5b6b 6579 5d0a 0a20 2020  .tasks[key]..   
-00010eb0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00010ec0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00010ed0: 2020 2061 7373 6572 7420 7473 2e72 756e     assert ts.run
-00010ee0: 5f73 7065 630a 2020 2020 2020 2020 2020  _spec.          
-00010ef0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00010f00: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
-00010f10: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00010f20: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
-00010f30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00010f40: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-00010f50: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-00010f60: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-00010f70: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-00010f80: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00010f90: 6572 7420 6474 732e 7374 6174 6520 6e6f  ert dts.state no
-00010fa0: 7420 696e 207b 2266 6f72 676f 7474 656e  t in {"forgotten
-00010fb0: 222c 2022 6572 7265 6422 7d0a 0a20 2020  ", "erred"}..   
-00010fc0: 2020 2020 2069 6620 7473 2e68 6173 5f6c       if ts.has_l
-00010fd0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-00010fe0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00010ff0: 7475 726e 207b 6b65 793a 2022 666f 7267  turn {key: "forg
-00011000: 6f74 7465 6e22 7d2c 207b 7d2c 207b 7d0a  otten"}, {}, {}.
-00011010: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
-00011020: 6520 3d20 2277 6169 7469 6e67 220a 0a20  e = "waiting".. 
-00011030: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00011040: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
-00011050: 7d0a 0a20 2020 2020 2020 2066 6f72 2064  }..        for d
-00011060: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-00011070: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
-00011080: 2020 2069 6620 6e6f 7420 6474 732e 7768     if not dts.wh
-00011090: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
-000110a0: 2020 2020 2020 2074 732e 7761 6974 696e         ts.waitin
-000110b0: 675f 6f6e 2e61 6464 2864 7473 290a 2020  g_on.add(dts).  
-000110c0: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
-000110d0: 2e73 7461 7465 203d 3d20 2272 656c 6561  .state == "relea
-000110e0: 7365 6422 3a0a 2020 2020 2020 2020 2020  sed":.          
-000110f0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00011100: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-00011110: 2022 7761 6974 696e 6722 0a20 2020 2020   "waiting".     
-00011120: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00011130: 2020 2020 2020 2020 2020 2020 2064 7473               dts
-00011140: 2e77 6169 7465 7273 2e61 6464 2874 7329  .waiters.add(ts)
-00011150: 0a0a 2020 2020 2020 2020 7473 2e77 6169  ..        ts.wai
-00011160: 7465 7273 203d 207b 6474 7320 666f 7220  ters = {dts for 
-00011170: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-00011180: 656e 7473 2069 6620 6474 732e 7374 6174  ents if dts.stat
-00011190: 6520 3d3d 2022 7761 6974 696e 6722 7d0a  e == "waiting"}.
-000111a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000111b0: 7473 2e77 6169 7469 6e67 5f6f 6e3a 0a20  ts.waiting_on:. 
-000111c0: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
-000111d0: 453a 2077 6169 7469 6e67 2d3e 7072 6f63  E: waiting->proc
-000111e0: 6573 7369 6e67 2077 696c 6c20 7365 6e64  essing will send
-000111f0: 2074 6173 6b73 2074 6f20 7175 6575 6564   tasks to queued
-00011200: 206f 7220 6e6f 2d77 6f72 6b65 7220 6173   or no-worker as
-00011210: 0a20 2020 2020 2020 2020 2020 2023 206e  .            # n
-00011220: 6563 6573 7361 7279 0a20 2020 2020 2020  ecessary.       
-00011230: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00011240: 696f 6e73 5b6b 6579 5d20 3d20 2270 726f  ions[key] = "pro
-00011250: 6365 7373 696e 6722 0a0a 2020 2020 2020  cessing"..      
-00011260: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
-00011270: 6e64 6174 696f 6e73 2c20 7b7d 2c20 7b7d  ndations, {}, {}
-00011280: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-00011290: 7469 6f6e 5f6e 6f5f 776f 726b 6572 5f70  tion_no_worker_p
-000112a0: 726f 6365 7373 696e 6728 7365 6c66 2c20  rocessing(self, 
-000112b0: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
-000112c0: 7573 5f69 643a 2073 7472 2920 2d3e 2052  us_id: str) -> R
-000112d0: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
-000112e0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-000112f0: 5b6b 6579 5d0a 2020 2020 2020 2020 776f  [key].        wo
-00011300: 726b 6572 5f6d 7367 733a 204d 7367 7320  rker_msgs: Msgs 
-00011310: 3d20 7b7d 0a0a 2020 2020 2020 2020 6966  = {}..        if
-00011320: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-00011330: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00011340: 7274 206e 6f74 2074 732e 6163 746f 722c  rt not ts.actor,
-00011350: 2066 2241 6374 6f72 7320 6361 6e27 7420   f"Actors can't 
-00011360: 6265 2069 6e20 606e 6f2d 776f 726b 6572  be in `no-worker
-00011370: 603a 207b 7473 7d22 0a20 2020 2020 2020  `: {ts}".       
-00011380: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
-00011390: 6e20 7365 6c66 2e75 6e72 756e 6e61 626c  n self.unrunnabl
-000113a0: 650a 0a20 2020 2020 2020 2069 6620 7773  e..        if ws
-000113b0: 203a 3d20 7365 6c66 2e64 6563 6964 655f   := self.decide_
-000113c0: 776f 726b 6572 5f6e 6f6e 5f72 6f6f 7469  worker_non_rooti
-000113d0: 7368 2874 7329 3a0a 2020 2020 2020 2020  sh(ts):.        
-000113e0: 2020 2020 7365 6c66 2e75 6e72 756e 6e61      self.unrunna
-000113f0: 626c 652e 6469 7363 6172 6428 7473 290a  ble.discard(ts).
-00011400: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00011410: 6572 5f6d 7367 7320 3d20 7365 6c66 2e5f  er_msgs = self._
-00011420: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
-00011430: 6728 7473 2c20 7773 290a 2020 2020 2020  g(ts, ws).      
-00011440: 2020 2320 4966 206e 6f20 776f 726b 6572    # If no worker
-00011450: 2c20 7461 736b 206a 7573 7420 7374 6179  , task just stay
-00011460: 7320 696e 2060 6e6f 2d77 6f72 6b65 7260  s in `no-worker`
-00011470: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00011480: 207b 7d2c 207b 7d2c 2077 6f72 6b65 725f   {}, {}, worker_
-00011490: 6d73 6773 0a0a 2020 2020 6465 6620 6465  msgs..    def de
-000114a0: 6369 6465 5f77 6f72 6b65 725f 726f 6f74  cide_worker_root
-000114b0: 6973 685f 7175 6575 696e 675f 6469 7361  ish_queuing_disa
-000114c0: 626c 6564 280a 2020 2020 2020 2020 7365  bled(.        se
-000114d0: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-000114e0: 650a 2020 2020 2920 2d3e 2057 6f72 6b65  e.    ) -> Worke
-000114f0: 7253 7461 7465 207c 204e 6f6e 653a 0a20  rState | None:. 
-00011500: 2020 2020 2020 2022 2222 5069 636b 2061         """Pick a
-00011510: 2077 6f72 6b65 7220 666f 7220 6120 7275   worker for a ru
-00011520: 6e6e 6162 6c65 2072 6f6f 742d 6973 6820  nnable root-ish 
-00011530: 7461 736b 2c20 7769 7468 6f75 7420 7175  task, without qu
-00011540: 6575 696e 672e 0a0a 2020 2020 2020 2020  euing...        
-00011550: 5468 6973 2061 7474 656d 7074 7320 746f  This attempts to
-00011560: 2073 6368 6564 756c 6520 7369 626c 696e   schedule siblin
-00011570: 6720 7461 736b 7320 6f6e 2074 6865 2073  g tasks on the s
-00011580: 616d 6520 776f 726b 6572 2c20 7265 6475  ame worker, redu
-00011590: 6369 6e67 2066 7574 7572 6520 6461 7461  cing future data
-000115a0: 0a20 2020 2020 2020 2074 7261 6e73 6665  .        transfe
-000115b0: 722e 2049 7420 646f 6573 206e 6f74 2063  r. It does not c
-000115c0: 6f6e 7369 6465 7220 7468 6520 6c6f 6361  onsider the loca
-000115d0: 7469 6f6e 206f 6620 6465 7065 6e64 656e  tion of dependen
-000115e0: 6369 6573 2c20 7369 6e63 6520 7468 6579  cies, since they
-000115f0: 276c 6c20 656e 640a 2020 2020 2020 2020  'll end.        
-00011600: 7570 206f 6e20 6576 6572 7920 776f 726b  up on every work
-00011610: 6572 2061 6e79 7761 792e 0a0a 2020 2020  er anyway...    
-00011620: 2020 2020 4974 2061 7373 756d 6573 2069      It assumes i
-00011630: 7427 7320 6265 696e 6720 6361 6c6c 6564  t's being called
-00011640: 206f 6e20 6120 6261 7463 6820 6f66 2074   on a batch of t
-00011650: 6173 6b73 2069 6e20 7072 696f 7269 7479  asks in priority
-00011660: 206f 7264 6572 2c20 616e 640a 2020 2020   order, and.    
-00011670: 2020 2020 6d61 696e 7461 696e 7320 7374      maintains st
-00011680: 6174 6520 696e 2060 5363 6865 6475 6c65  ate in `Schedule
-00011690: 7253 7461 7465 2e6c 6173 745f 726f 6f74  rState.last_root
-000116a0: 5f77 6f72 6b65 7260 2061 6e64 0a20 2020  _worker` and.   
-000116b0: 2020 2020 2060 5363 6865 6475 6c65 7253       `SchedulerS
-000116c0: 7461 7465 2e6c 6173 745f 726f 6f74 5f77  tate.last_root_w
-000116d0: 6f72 6b65 725f 7461 736b 735f 6c65 6674  orker_tasks_left
-000116e0: 6020 746f 2061 6368 6965 7665 2074 6869  ` to achieve thi
-000116f0: 732e 0a0a 2020 2020 2020 2020 5468 6973  s...        This
-00011700: 2077 696c 6c20 7365 6e64 2065 7665 7279   will send every
-00011710: 2072 756e 6e61 626c 6520 7461 736b 2074   runnable task t
-00011720: 6f20 6120 776f 726b 6572 2c20 6f66 7465  o a worker, ofte
-00011730: 6e20 6361 7573 696e 6720 726f 6f74 2074  n causing root t
-00011740: 6173 6b0a 2020 2020 2020 2020 6f76 6572  ask.        over
-00011750: 7072 6f64 7563 7469 6f6e 2e0a 0a20 2020  production...   
-00011760: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
-00011770: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
-00011780: 2020 2020 2077 733a 2057 6f72 6b65 7253       ws: WorkerS
-00011790: 7461 7465 207c 204e 6f6e 650a 2020 2020  tate | None.    
-000117a0: 2020 2020 2020 2020 5468 6520 776f 726b          The work
-000117b0: 6572 2074 6f20 6173 7369 676e 2074 6865  er to assign the
-000117c0: 2074 6173 6b20 746f 2e20 4966 2074 6865   task to. If the
-000117d0: 7265 2061 7265 206e 6f20 776f 726b 6572  re are no worker
-000117e0: 7320 696e 2074 6865 2063 6c75 7374 6572  s in the cluster
-000117f0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00011800: 7475 726e 7320 4e6f 6e65 2c20 696e 2077  turns None, in w
-00011810: 6869 6368 2063 6173 6520 7468 6520 7461  hich case the ta
-00011820: 736b 2073 686f 756c 6420 6265 2074 7261  sk should be tra
-00011830: 6e73 6974 696f 6e65 6420 746f 0a20 2020  nsitioned to.   
-00011840: 2020 2020 2020 2020 2060 606e 6f2d 776f           ``no-wo
-00011850: 726b 6572 6060 2e0a 2020 2020 2020 2020  rker``..        
-00011860: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-00011870: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00011880: 2020 2020 2020 2020 2020 2320 5365 6520            # See 
-00011890: 726f 6f74 2d69 7368 2d6e 6573 7320 6e6f  root-ish-ness no
-000118a0: 7465 2062 656c 6f77 2069 6e20 6064 6563  te below in `dec
-000118b0: 6964 655f 776f 726b 6572 5f72 6f6f 7469  ide_worker_rooti
-000118c0: 7368 5f71 7565 7569 6e67 5f65 6e61 626c  sh_queuing_enabl
-000118d0: 6564 600a 2020 2020 2020 2020 2020 2020  ed`.            
-000118e0: 6173 7365 7274 206d 6174 682e 6973 696e  assert math.isin
-000118f0: 6628 7365 6c66 2e57 4f52 4b45 525f 5341  f(self.WORKER_SA
-00011900: 5455 5241 5449 4f4e 290a 0a20 2020 2020  TURATION)..     
-00011910: 2020 2070 6f6f 6c20 3d20 7365 6c66 2e69     pool = self.i
-00011920: 646c 652e 7661 6c75 6573 2829 2069 6620  dle.values() if 
-00011930: 7365 6c66 2e69 646c 6520 656c 7365 2073  self.idle else s
-00011940: 656c 662e 7275 6e6e 696e 670a 2020 2020  elf.running.    
-00011950: 2020 2020 6966 206e 6f74 2070 6f6f 6c3a      if not pool:
-00011960: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00011970: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
-00011980: 2020 7467 203d 2074 732e 6772 6f75 700a    tg = ts.group.
-00011990: 2020 2020 2020 2020 6c77 7320 3d20 7467          lws = tg
-000119a0: 2e6c 6173 745f 776f 726b 6572 0a20 2020  .last_worker.   
-000119b0: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
-000119c0: 2020 2020 2020 6c77 730a 2020 2020 2020        lws.      
-000119d0: 2020 2020 2020 616e 6420 7467 2e6c 6173        and tg.las
-000119e0: 745f 776f 726b 6572 5f74 6173 6b73 5f6c  t_worker_tasks_l
-000119f0: 6566 740a 2020 2020 2020 2020 2020 2020  eft.            
-00011a00: 616e 6420 6c77 732e 7374 6174 7573 203d  and lws.status =
-00011a10: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-00011a20: 0a20 2020 2020 2020 2020 2020 2061 6e64  .            and
-00011a30: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
-00011a40: 7428 6c77 732e 6164 6472 6573 7329 2069  t(lws.address) i
-00011a50: 7320 6c77 730a 2020 2020 2020 2020 293a  s lws.        ):
-00011a60: 0a20 2020 2020 2020 2020 2020 2077 7320  .            ws 
-00011a70: 3d20 6c77 730a 2020 2020 2020 2020 656c  = lws.        el
-00011a80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00011a90: 2320 4c61 7374 2d75 7365 6420 776f 726b  # Last-used work
-00011aa0: 6572 2069 7320 6675 6c6c 2c20 756e 6b6e  er is full, unkn
-00011ab0: 6f77 6e2c 2072 6574 6972 696e 672c 206f  own, retiring, o
-00011ac0: 7220 7061 7573 6564 3b0a 2020 2020 2020  r paused;.      
-00011ad0: 2020 2020 2020 2320 7069 636b 2061 206e        # pick a n
-00011ae0: 6577 2077 6f72 6b65 7220 666f 7220 7468  ew worker for th
-00011af0: 6520 6e65 7874 2066 6577 2074 6173 6b73  e next few tasks
-00011b00: 0a20 2020 2020 2020 2020 2020 2077 7320  .            ws 
-00011b10: 3d20 6d69 6e28 706f 6f6c 2c20 6b65 793d  = min(pool, key=
-00011b20: 7061 7274 6961 6c28 7365 6c66 2e77 6f72  partial(self.wor
-00011b30: 6b65 725f 6f62 6a65 6374 6976 652c 2074  ker_objective, t
-00011b40: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-00011b50: 7467 2e6c 6173 745f 776f 726b 6572 5f74  tg.last_worker_t
-00011b60: 6173 6b73 5f6c 6566 7420 3d20 6d61 7468  asks_left = math
-00011b70: 2e66 6c6f 6f72 280a 2020 2020 2020 2020  .floor(.        
-00011b80: 2020 2020 2020 2020 286c 656e 2874 6729          (len(tg)
-00011b90: 202f 2073 656c 662e 746f 7461 6c5f 6e74   / self.total_nt
-00011ba0: 6872 6561 6473 2920 2a20 7773 2e6e 7468  hreads) * ws.nth
-00011bb0: 7265 6164 730a 2020 2020 2020 2020 2020  reads.          
-00011bc0: 2020 290a 0a20 2020 2020 2020 2023 2052    )..        # R
-00011bd0: 6563 6f72 6420 606c 6173 745f 776f 726b  ecord `last_work
-00011be0: 6572 602c 206f 7220 636c 6561 7220 6974  er`, or clear it
-00011bf0: 206f 6e20 7468 6520 6669 6e61 6c20 7461   on the final ta
-00011c00: 736b 0a20 2020 2020 2020 2074 672e 6c61  sk.        tg.la
-00011c10: 7374 5f77 6f72 6b65 7220 3d20 280a 2020  st_worker = (.  
-00011c20: 2020 2020 2020 2020 2020 7773 2069 6620            ws if 
-00011c30: 7467 2e73 7461 7465 735b 2272 656c 6561  tg.states["relea
-00011c40: 7365 6422 5d20 2b20 7467 2e73 7461 7465  sed"] + tg.state
-00011c50: 735b 2277 6169 7469 6e67 225d 203e 2031  s["waiting"] > 1
-00011c60: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
-00011c70: 2020 2029 0a20 2020 2020 2020 2074 672e     ).        tg.
-00011c80: 6c61 7374 5f77 6f72 6b65 725f 7461 736b  last_worker_task
-00011c90: 735f 6c65 6674 202d 3d20 310a 0a20 2020  s_left -= 1..   
-00011ca0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00011cb0: 6964 6174 6520 616e 6420 7773 2069 7320  idate and ws is 
-00011cc0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00011cd0: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-00011ce0: 662e 776f 726b 6572 732e 6765 7428 7773  f.workers.get(ws
-00011cf0: 2e61 6464 7265 7373 2920 6973 2077 730a  .address) is ws.
-00011d00: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00011d10: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
-00011d20: 6e6e 696e 672c 2028 7773 2c20 7365 6c66  nning, (ws, self
-00011d30: 2e72 756e 6e69 6e67 290a 0a20 2020 2020  .running)..     
-00011d40: 2020 2072 6574 7572 6e20 7773 0a0a 2020     return ws..  
-00011d50: 2020 6465 6620 6465 6369 6465 5f77 6f72    def decide_wor
-00011d60: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
-00011d70: 696e 675f 656e 6162 6c65 6428 7365 6c66  ing_enabled(self
-00011d80: 2920 2d3e 2057 6f72 6b65 7253 7461 7465  ) -> WorkerState
-00011d90: 207c 204e 6f6e 653a 0a20 2020 2020 2020   | None:.       
-00011da0: 2022 2222 5069 636b 2061 2077 6f72 6b65   """Pick a worke
-00011db0: 7220 666f 7220 6120 7275 6e6e 6162 6c65  r for a runnable
-00011dc0: 2072 6f6f 742d 6973 6820 7461 736b 2c20   root-ish task, 
-00011dd0: 6966 206e 6f74 2061 6c6c 2061 7265 2062  if not all are b
-00011de0: 7573 792e 0a0a 2020 2020 2020 2020 5069  usy...        Pi
-00011df0: 636b 7320 7468 6520 6c65 6173 742d 6275  cks the least-bu
-00011e00: 7379 2077 6f72 6b65 7220 6f75 7420 6f66  sy worker out of
-00011e10: 2074 6865 2060 6069 646c 6560 6020 776f   the ``idle`` wo
-00011e20: 726b 6572 7320 2869 646c 6520 776f 726b  rkers (idle work
-00011e30: 6572 7320 6861 7665 2066 6577 6572 0a20  ers have fewer. 
-00011e40: 2020 2020 2020 2074 6173 6b73 2072 756e         tasks run
-00011e50: 6e69 6e67 2074 6861 6e20 7468 7265 6164  ning than thread
-00011e60: 732c 2061 7320 7365 7420 6279 2060 6064  s, as set by ``d
-00011e70: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-00011e80: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
-00011e90: 7261 7469 6f6e 6060 292e 0a20 2020 2020  ration``)..     
-00011ea0: 2020 2049 7420 646f 6573 206e 6f74 2063     It does not c
-00011eb0: 6f6e 7369 6465 7220 7468 6520 6c6f 6361  onsider the loca
-00011ec0: 7469 6f6e 206f 6620 6465 7065 6e64 656e  tion of dependen
-00011ed0: 6369 6573 2c20 7369 6e63 6520 7468 6579  cies, since they
-00011ee0: 276c 6c20 656e 6420 7570 206f 6e20 6576  'll end up on ev
-00011ef0: 6572 790a 2020 2020 2020 2020 776f 726b  ery.        work
-00011f00: 6572 2061 6e79 7761 792e 0a0a 2020 2020  er anyway...    
-00011f10: 2020 2020 4966 2061 6c6c 2077 6f72 6b65      If all worke
-00011f20: 7273 2061 7265 2066 756c 6c2c 2072 6574  rs are full, ret
-00011f30: 7572 6e73 204e 6f6e 652c 206d 6561 6e69  urns None, meani
-00011f40: 6e67 2074 6865 2074 6173 6b20 7368 6f75  ng the task shou
-00011f50: 6c64 2074 7261 6e73 6974 696f 6e20 746f  ld transition to
-00011f60: 0a20 2020 2020 2020 2060 6071 7565 7565  .        ``queue
-00011f70: 6460 602e 2054 6865 2073 6368 6564 756c  d``. The schedul
-00011f80: 6572 2077 696c 6c20 7761 6974 2074 6f20  er will wait to 
-00011f90: 7365 6e64 2069 7420 746f 2061 2077 6f72  send it to a wor
-00011fa0: 6b65 7220 756e 7469 6c20 6120 7468 7265  ker until a thre
-00011fb0: 6164 206f 7065 6e73 0a20 2020 2020 2020  ad opens.       
-00011fc0: 2075 702e 2054 6869 7320 656e 7375 7265   up. This ensure
-00011fd0: 7320 7468 6174 2064 6f77 6e73 7472 6561  s that downstrea
-00011fe0: 6d20 7461 736b 7320 616c 7761 7973 2072  m tasks always r
-00011ff0: 756e 2062 6566 6f72 6520 6e65 7720 726f  un before new ro
-00012000: 6f74 2074 6173 6b73 2061 7265 0a20 2020  ot tasks are.   
-00012010: 2020 2020 2073 7461 7274 6564 2e0a 0a20       started... 
-00012020: 2020 2020 2020 2054 6869 7320 646f 6573         This does
-00012030: 206e 6f74 2074 7279 2074 6f20 7363 6865   not try to sche
-00012040: 6475 6c65 2073 6962 6c69 6e67 2074 6173  dule sibling tas
-00012050: 6b73 206f 6e20 7468 6520 7361 6d65 2077  ks on the same w
-00012060: 6f72 6b65 723b 2069 6e20 6661 6374 2c20  orker; in fact, 
-00012070: 6974 0a20 2020 2020 2020 2075 7375 616c  it.        usual
-00012080: 6c79 2064 6f65 7320 7468 6520 6f70 706f  ly does the oppo
-00012090: 7369 7465 2e20 4576 656e 2074 686f 7567  site. Even thoug
-000120a0: 6820 7468 6973 2069 6e63 7265 6173 6573  h this increases
-000120b0: 2073 7562 7365 7175 656e 7420 6461 7461   subsequent data
-000120c0: 2074 7261 6e73 6665 722c 0a20 2020 2020   transfer,.     
-000120d0: 2020 2069 7420 7479 7069 6361 6c6c 7920     it typically 
-000120e0: 7265 6475 6365 7320 6f76 6572 616c 6c20  reduces overall 
-000120f0: 6d65 6d6f 7279 2075 7365 2062 7920 656c  memory use by el
-00012100: 696d 696e 6174 696e 6720 726f 6f74 2074  iminating root t
-00012110: 6173 6b20 6f76 6572 7072 6f64 7563 7469  ask overproducti
-00012120: 6f6e 2e0a 0a20 2020 2020 2020 2052 6574  on...        Ret
-00012130: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
-00012140: 2d2d 2d2d 0a20 2020 2020 2020 2077 733a  ----.        ws:
-00012150: 2057 6f72 6b65 7253 7461 7465 207c 204e   WorkerState | N
-00012160: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00012170: 5468 6520 776f 726b 6572 2074 6f20 6173  The worker to as
-00012180: 7369 676e 2074 6865 2074 6173 6b20 746f  sign the task to
-00012190: 2e20 4966 2074 6865 7265 2061 7265 206e  . If there are n
-000121a0: 6f20 6964 6c65 2077 6f72 6b65 7273 2c20  o idle workers, 
-000121b0: 7265 7475 726e 730a 2020 2020 2020 2020  returns.        
-000121c0: 2020 2020 4e6f 6e65 2c20 696e 2077 6869      None, in whi
-000121d0: 6368 2063 6173 6520 7468 6520 7461 736b  ch case the task
-000121e0: 2073 686f 756c 6420 6265 2074 7261 6e73   should be trans
-000121f0: 6974 696f 6e65 6420 746f 2060 6071 7565  itioned to ``que
-00012200: 7565 6460 602e 0a0a 2020 2020 2020 2020  ued``...        
-00012210: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-00012220: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00012230: 2020 2020 2020 2020 2020 2320 5765 2064            # We d
-00012240: 6f6e 2774 2060 6173 7365 7274 2073 656c  on't `assert sel
-00012250: 662e 6973 5f72 6f6f 7469 7368 2874 7329  f.is_rootish(ts)
-00012260: 6020 6865 7265 2c20 6265 6361 7573 6520  ` here, because 
-00012270: 7468 6174 2063 6865 636b 2069 730a 2020  that check is.  
-00012280: 2020 2020 2020 2020 2020 2320 6465 7065            # depe
-00012290: 6e64 656e 7420 6f6e 2063 6c75 7374 6572  ndent on cluster
-000122a0: 2073 697a 652e 2049 7427 7320 706f 7373   size. It's poss
-000122b0: 6962 6c65 2061 2074 6173 6b20 6c6f 6f6b  ible a task look
-000122c0: 6564 2072 6f6f 742d 6973 6820 7768 656e  ed root-ish when
-000122d0: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
-000122e0: 2320 7761 7320 7175 6575 6564 2c20 6275  # was queued, bu
-000122f0: 7420 7468 6520 636c 7573 7465 7220 6861  t the cluster ha
-00012300: 7320 7369 6e63 6520 7363 616c 6564 2075  s since scaled u
-00012310: 7020 616e 6420 6974 206e 6f20 6c6f 6e67  p and it no long
-00012320: 6572 2064 6f65 7320 7768 656e 0a20 2020  er does when.   
-00012330: 2020 2020 2020 2020 2023 2063 6f6d 696e           # comin
-00012340: 6720 6f75 7420 6f66 2074 6865 2071 7565  g out of the que
-00012350: 7565 2e20 4966 2060 6973 5f72 6f6f 7469  ue. If `is_rooti
-00012360: 7368 6020 6368 616e 6765 7320 746f 2061  sh` changes to a
-00012370: 2073 7461 7469 6320 6465 6669 6e69 7469   static definiti
-00012380: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00012390: 2320 7468 656e 2061 6464 2074 6861 7420  # then add that 
-000123a0: 6173 7365 7274 696f 6e20 6865 7265 2028  assertion here (
-000123b0: 616e 6420 6163 7475 616c 6c79 2070 6173  and actually pas
-000123c0: 7320 696e 2074 6865 2074 6173 6b29 2e0a  s in the task)..
-000123d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000123e0: 7274 206e 6f74 206d 6174 682e 6973 696e  rt not math.isin
-000123f0: 6628 7365 6c66 2e57 4f52 4b45 525f 5341  f(self.WORKER_SA
-00012400: 5455 5241 5449 4f4e 290a 0a20 2020 2020  TURATION)..     
-00012410: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
-00012420: 646c 655f 7461 736b 5f63 6f75 6e74 3a0a  dle_task_count:.
-00012430: 2020 2020 2020 2020 2020 2020 2320 416c              # Al
-00012440: 6c20 776f 726b 6572 7320 6275 7379 3f20  l workers busy? 
-00012450: 5461 736b 2067 6574 732f 7374 6179 7320  Task gets/stays 
-00012460: 7175 6575 6564 2e0a 2020 2020 2020 2020  queued..        
-00012470: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-00012480: 0a20 2020 2020 2020 2023 204a 7573 7420  .        # Just 
-00012490: 7069 636b 2074 6865 206c 6561 7374 2062  pick the least b
-000124a0: 7573 7920 776f 726b 6572 2e0a 2020 2020  usy worker..    
-000124b0: 2020 2020 2320 4e4f 5445 3a20 7468 6973      # NOTE: this
-000124c0: 2077 696c 6c20 6c65 6164 2074 6f20 776f   will lead to wo
-000124d0: 7273 742d 6361 7365 2073 6368 6564 756c  rst-case schedul
-000124e0: 696e 6720 7769 7468 2072 6567 6172 6473  ing with regards
-000124f0: 2074 6f20 636f 2d61 7373 6967 6e6d 656e   to co-assignmen
-00012500: 742e 0a20 2020 2020 2020 2077 7320 3d20  t..        ws = 
-00012510: 6d69 6e28 0a20 2020 2020 2020 2020 2020  min(.           
-00012520: 2073 656c 662e 6964 6c65 5f74 6173 6b5f   self.idle_task_
-00012530: 636f 756e 742c 0a20 2020 2020 2020 2020  count,.         
-00012540: 2020 206b 6579 3d6c 616d 6264 6120 7773     key=lambda ws
-00012550: 3a20 6c65 6e28 7773 2e70 726f 6365 7373  : len(ws.process
-00012560: 696e 6729 202f 2077 732e 6e74 6872 6561  ing) / ws.nthrea
-00012570: 6473 2c0a 2020 2020 2020 2020 290a 2020  ds,.        ).  
-00012580: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-00012590: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-000125a0: 2020 2020 6173 7365 7274 206e 6f74 205f      assert not _
-000125b0: 776f 726b 6572 5f66 756c 6c28 7773 2c20  worker_full(ws, 
-000125c0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
-000125d0: 5241 5449 4f4e 292c 2028 0a20 2020 2020  RATION), (.     
-000125e0: 2020 2020 2020 2020 2020 2077 732c 0a20             ws,. 
-000125f0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00012600: 7461 736b 5f73 6c6f 7473 5f61 7661 696c  task_slots_avail
-00012610: 6162 6c65 2877 732c 2073 656c 662e 574f  able(ws, self.WO
-00012620: 524b 4552 5f53 4154 5552 4154 494f 4e29  RKER_SATURATION)
-00012630: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00012640: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00012650: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
-00012660: 6e6e 696e 672c 2028 7773 2c20 7365 6c66  nning, (ws, self
-00012670: 2e72 756e 6e69 6e67 290a 0a20 2020 2020  .running)..     
-00012680: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00012690: 6174 6520 616e 6420 7773 2069 7320 6e6f  ate and ws is no
-000126a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000126b0: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-000126c0: 776f 726b 6572 732e 6765 7428 7773 2e61  workers.get(ws.a
-000126d0: 6464 7265 7373 2920 6973 2077 730a 2020  ddress) is ws.  
-000126e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000126f0: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
-00012700: 696e 672c 2028 7773 2c20 7365 6c66 2e72  ing, (ws, self.r
-00012710: 756e 6e69 6e67 290a 0a20 2020 2020 2020  unning)..       
-00012720: 2072 6574 7572 6e20 7773 0a0a 2020 2020   return ws..    
-00012730: 6465 6620 6465 6369 6465 5f77 6f72 6b65  def decide_worke
-00012740: 725f 6e6f 6e5f 726f 6f74 6973 6828 7365  r_non_rootish(se
-00012750: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-00012760: 6529 202d 3e20 576f 726b 6572 5374 6174  e) -> WorkerStat
-00012770: 6520 7c20 4e6f 6e65 3a0a 2020 2020 2020  e | None:.      
-00012780: 2020 2222 2250 6963 6b20 6120 776f 726b    """Pick a work
-00012790: 6572 2066 6f72 2061 2072 756e 6e61 626c  er for a runnabl
-000127a0: 6520 6e6f 6e2d 726f 6f74 2074 6173 6b2c  e non-root task,
-000127b0: 2063 6f6e 7369 6465 7269 6e67 2064 6570   considering dep
-000127c0: 656e 6465 6e63 6965 7320 616e 640a 2020  endencies and.  
-000127d0: 2020 2020 2020 7265 7374 7269 6374 696f        restrictio
-000127e0: 6e73 2e0a 0a20 2020 2020 2020 204f 7574  ns...        Out
-000127f0: 206f 6620 656c 6967 6962 6c65 2077 6f72   of eligible wor
-00012800: 6b65 7273 2068 6f6c 6469 6e67 2064 6570  kers holding dep
-00012810: 656e 6465 6e63 6965 7320 6f66 2060 6074  endencies of ``t
-00012820: 7360 602c 2073 656c 6563 7473 2074 6865  s``, selects the
-00012830: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
-00012840: 7768 6572 652c 2063 6f6e 7369 6465 7269  where, consideri
-00012850: 6e67 2077 6f72 6b65 7220 6261 636b 6c6f  ng worker backlo
-00012860: 6e67 2061 6e64 2064 6174 612d 7472 616e  ng and data-tran
-00012870: 7366 6572 2063 6f73 7473 2c20 7468 6520  sfer costs, the 
-00012880: 7461 736b 2069 730a 2020 2020 2020 2020  task is.        
-00012890: 6573 7469 6d61 7465 6420 746f 2073 7461  estimated to sta
-000128a0: 7274 2072 756e 6e69 6e67 2074 6865 2073  rt running the s
-000128b0: 6f6f 6e65 7374 2e0a 0a20 2020 2020 2020  oonest...       
-000128c0: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
-000128d0: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
-000128e0: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
-000128f0: 207c 204e 6f6e 650a 2020 2020 2020 2020   | None.        
-00012900: 2020 2020 5468 6520 776f 726b 6572 2074      The worker t
-00012910: 6f20 6173 7369 676e 2074 6865 2074 6173  o assign the tas
-00012920: 6b20 746f 2e20 4966 206e 6f20 776f 726b  k to. If no work
-00012930: 6572 7320 7361 7469 7366 7920 7468 6520  ers satisfy the 
-00012940: 7265 7374 7269 6374 696f 6e73 206f 660a  restrictions of.
-00012950: 2020 2020 2020 2020 2020 2020 6060 7473              ``ts
-00012960: 6060 206f 7220 7468 6572 6520 6172 6520  `` or there are 
-00012970: 6e6f 2072 756e 6e69 6e67 2077 6f72 6b65  no running worke
-00012980: 7273 2c20 7265 7475 726e 7320 4e6f 6e65  rs, returns None
-00012990: 2c20 696e 2077 6869 6368 2063 6173 6520  , in which case 
-000129a0: 7468 6520 7461 736b 0a20 2020 2020 2020  the task.       
-000129b0: 2020 2020 2073 686f 756c 6420 6265 2074       should be t
-000129c0: 7261 6e73 6974 696f 6e65 6420 746f 2060  ransitioned to `
-000129d0: 606e 6f2d 776f 726b 6572 6060 2e0a 2020  `no-worker``..  
-000129e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000129f0: 2020 6966 206e 6f74 2073 656c 662e 7275    if not self.ru
-00012a00: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-00012a10: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-00012a20: 2020 2020 2020 2020 7661 6c69 645f 776f          valid_wo
-00012a30: 726b 6572 7320 3d20 7365 6c66 2e76 616c  rkers = self.val
-00012a40: 6964 5f77 6f72 6b65 7273 2874 7329 0a20  id_workers(ts). 
-00012a50: 2020 2020 2020 2069 6620 7661 6c69 645f         if valid_
-00012a60: 776f 726b 6572 7320 6973 204e 6f6e 6520  workers is None 
-00012a70: 616e 6420 6c65 6e28 7365 6c66 2e72 756e  and len(self.run
-00012a80: 6e69 6e67 2920 3c20 6c65 6e28 7365 6c66  ning) < len(self
-00012a90: 2e77 6f72 6b65 7273 293a 0a20 2020 2020  .workers):.     
-00012aa0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00012ab0: 6c66 2e72 756e 6e69 6e67 3a0a 2020 2020  lf.running:.    
-00012ac0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012ad0: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
-00012ae0: 2020 2020 2023 2049 6620 7468 6572 6520       # If there 
-00012af0: 7765 7265 206e 6f20 7265 7374 7269 6374  were no restrict
-00012b00: 696f 6e73 2c20 6076 616c 6964 5f77 6f72  ions, `valid_wor
-00012b10: 6b65 7273 2829 6020 6469 646e 2774 2073  kers()` didn't s
-00012b20: 7562 7365 7420 6279 0a20 2020 2020 2020  ubset by.       
-00012b30: 2020 2020 2023 2060 7275 6e6e 696e 6760       # `running`
-00012b40: 2e0a 2020 2020 2020 2020 2020 2020 7661  ..            va
-00012b50: 6c69 645f 776f 726b 6572 7320 3d20 7365  lid_workers = se
-00012b60: 6c66 2e72 756e 6e69 6e67 0a0a 2020 2020  lf.running..    
-00012b70: 2020 2020 6966 2074 732e 6465 7065 6e64      if ts.depend
-00012b80: 656e 6369 6573 206f 7220 7661 6c69 645f  encies or valid_
-00012b90: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-00012ba0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00012bb0: 2077 7320 3d20 6465 6369 6465 5f77 6f72   ws = decide_wor
-00012bc0: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
-00012bd0: 2020 2020 2074 732c 0a20 2020 2020 2020       ts,.       
-00012be0: 2020 2020 2020 2020 2073 656c 662e 7275           self.ru
-00012bf0: 6e6e 696e 672c 0a20 2020 2020 2020 2020  nning,.         
-00012c00: 2020 2020 2020 2076 616c 6964 5f77 6f72         valid_wor
-00012c10: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
-00012c20: 2020 2020 2020 7061 7274 6961 6c28 7365        partial(se
-00012c30: 6c66 2e77 6f72 6b65 725f 6f62 6a65 6374  lf.worker_object
-00012c40: 6976 652c 2074 7329 2c0a 2020 2020 2020  ive, ts),.      
-00012c50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00012c60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00012c70: 2020 2320 544f 444f 2069 6620 6069 735f    # TODO if `is_
-00012c80: 726f 6f74 6973 6860 2077 6f75 6c64 2061  rootish` would a
-00012c90: 6c77 6179 7320 7265 7475 726e 2054 7275  lways return Tru
-00012ca0: 6520 666f 7220 7461 736b 7320 7769 7468  e for tasks with
-00012cb0: 6f75 740a 2020 2020 2020 2020 2020 2020  out.            
-00012cc0: 2320 6465 7065 6e64 656e 6369 6573 2c20  # dependencies, 
-00012cd0: 7765 2063 6f75 6c64 2072 656d 6f76 6520  we could remove 
-00012ce0: 616c 6c20 7468 6973 206c 6f67 6963 2e20  all this logic. 
-00012cf0: 5468 6520 726f 6f74 6973 6820 6173 7369  The rootish assi
-00012d00: 676e 6d65 6e74 206c 6f67 6963 0a20 2020  gnment logic.   
-00012d10: 2020 2020 2020 2020 2023 2077 6f75 6c64           # would
-00012d20: 2062 6568 6176 6520 6d6f 7265 206f 7220   behave more or 
-00012d30: 6c65 7373 2074 6865 2073 616d 6520 6173  less the same as
-00012d40: 2074 6869 732c 206d 6179 6265 2077 6974   this, maybe wit
-00012d50: 686f 7574 2067 7561 7261 6e74 6565 640a  hout guaranteed.
-00012d60: 2020 2020 2020 2020 2020 2020 2320 726f              # ro
-00012d70: 756e 642d 726f 6269 6e20 7468 6f75 6768  und-robin though
-00012d80: 3f20 5468 6973 2070 6174 6820 6973 206f  ? This path is o
-00012d90: 6e6c 7920 7265 6163 6861 626c 6520 7768  nly reachable wh
-00012da0: 656e 2060 7473 6020 646f 6573 6e27 7420  en `ts` doesn't 
-00012db0: 6861 7665 0a20 2020 2020 2020 2020 2020  have.           
-00012dc0: 2023 2064 6570 656e 6465 6e63 6965 732c   # dependencies,
-00012dd0: 2062 7574 2069 7473 2067 726f 7570 2069   but its group i
-00012de0: 7320 616c 736f 2073 6d61 6c6c 6572 2074  s also smaller t
-00012df0: 6861 6e20 7468 6520 636c 7573 7465 722e  han the cluster.
-00012e00: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00012e10: 4661 7374 7061 7468 2077 6865 6e20 7468  Fastpath when th
-00012e20: 6572 6520 6172 6520 6e6f 2072 656c 6174  ere are no relat
-00012e30: 6564 2074 6173 6b73 206f 7220 7265 7374  ed tasks or rest
-00012e40: 7269 6374 696f 6e73 0a20 2020 2020 2020  rictions.       
-00012e50: 2020 2020 2077 6f72 6b65 725f 706f 6f6c       worker_pool
-00012e60: 203d 2073 656c 662e 6964 6c65 206f 7220   = self.idle or 
-00012e70: 7365 6c66 2e77 6f72 6b65 7273 0a20 2020  self.workers.   
-00012e80: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
-00012e90: 2069 646c 6520 616e 6420 776f 726b 6572   idle and worker
-00012ea0: 7320 6172 6520 536f 7274 6564 4469 6374  s are SortedDict
-00012eb0: 2773 2064 6563 6c61 7265 6420 6173 2064  's declared as d
-00012ec0: 6963 7473 0a20 2020 2020 2020 2020 2020  icts.           
-00012ed0: 2023 2020 2020 2020 2062 6563 6175 7365   #       because
-00012ee0: 2073 6f72 7465 6463 6f6e 7461 696e 6572   sortedcontainer
-00012ef0: 7320 6973 206e 6f74 2061 6e6e 6f74 6174  s is not annotat
-00012f00: 6564 0a20 2020 2020 2020 2020 2020 2077  ed.            w
-00012f10: 705f 7661 6c73 203d 2063 6173 7428 2253  p_vals = cast("S
-00012f20: 6571 7565 6e63 655b 576f 726b 6572 5374  equence[WorkerSt
-00012f30: 6174 655d 222c 2077 6f72 6b65 725f 706f  ate]", worker_po
-00012f40: 6f6c 2e76 616c 7565 7328 2929 0a20 2020  ol.values()).   
-00012f50: 2020 2020 2020 2020 206e 5f77 6f72 6b65           n_worke
-00012f60: 7273 203d 206c 656e 2877 705f 7661 6c73  rs = len(wp_vals
-00012f70: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00012f80: 206e 5f77 6f72 6b65 7273 203c 2032 303a   n_workers < 20:
-00012f90: 2020 2320 736d 6172 7420 6275 7420 6c69    # smart but li
-00012fa0: 6e65 6172 2069 6e20 736d 616c 6c20 6361  near in small ca
-00012fb0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00012fc0: 2020 2077 7320 3d20 6d69 6e28 7770 5f76     ws = min(wp_v
-00012fd0: 616c 732c 206b 6579 3d6f 7065 7261 746f  als, key=operato
-00012fe0: 722e 6174 7472 6765 7474 6572 2822 6f63  r.attrgetter("oc
-00012ff0: 6375 7061 6e63 7922 2929 0a20 2020 2020  cupancy")).     
-00013000: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00013010: 7420 7773 0a20 2020 2020 2020 2020 2020  t ws.           
-00013020: 2020 2020 2069 6620 7773 2e6f 6363 7570       if ws.occup
-00013030: 616e 6379 203d 3d20 303a 0a20 2020 2020  ancy == 0:.     
-00013040: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00013050: 2073 7065 6369 616c 2063 6173 6520 746f   special case to
-00013060: 2075 7365 2072 6f75 6e64 2d72 6f62 696e   use round-robin
-00013070: 3b20 6c69 6e65 6172 2073 6561 7263 680a  ; linear search.
-00013080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013090: 2020 2020 2320 666f 7220 6e65 7874 2077      # for next w
-000130a0: 6f72 6b65 7220 7769 7468 207a 6572 6f20  orker with zero 
-000130b0: 6f63 6375 7061 6e63 7920 286f 7220 6a75  occupancy (or ju
-000130c0: 7374 0a20 2020 2020 2020 2020 2020 2020  st.             
-000130d0: 2020 2020 2020 2023 206c 616e 6420 6261         # land ba
-000130e0: 636b 2077 6865 7265 2077 6520 7374 6172  ck where we star
-000130f0: 7465 6429 2e0a 2020 2020 2020 2020 2020  ted)..          
-00013100: 2020 2020 2020 2020 2020 7374 6172 7420            start 
-00013110: 3d20 7365 6c66 2e6e 5f74 6173 6b73 2025  = self.n_tasks %
-00013120: 206e 5f77 6f72 6b65 7273 0a20 2020 2020   n_workers.     
-00013130: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013140: 6f72 2069 2069 6e20 7261 6e67 6528 6e5f  or i in range(n_
-00013150: 776f 726b 6572 7329 3a0a 2020 2020 2020  workers):.      
-00013160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013170: 2020 7770 5f69 203d 2077 705f 7661 6c73    wp_i = wp_vals
-00013180: 5b28 6920 2b20 7374 6172 7429 2025 206e  [(i + start) % n
-00013190: 5f77 6f72 6b65 7273 5d0a 2020 2020 2020  _workers].      
-000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131b0: 2020 6966 2077 705f 692e 6f63 6375 7061    if wp_i.occupa
-000131c0: 6e63 7920 3d3d 2030 3a0a 2020 2020 2020  ncy == 0:.      
-000131d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131e0: 2020 2020 2020 7773 203d 2077 705f 690a        ws = wp_i.
-000131f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013200: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00013210: 6b0a 2020 2020 2020 2020 2020 2020 656c  k.            el
-00013220: 7365 3a20 2023 2064 756d 6220 6275 7420  se:  # dumb but 
-00013230: 6661 7374 2069 6e20 6c61 7267 6520 6361  fast in large ca
-00013240: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00013250: 2020 2077 7320 3d20 7770 5f76 616c 735b     ws = wp_vals[
-00013260: 7365 6c66 2e6e 5f74 6173 6b73 2025 206e  self.n_tasks % n
-00013270: 5f77 6f72 6b65 7273 5d0a 0a20 2020 2020  _workers]..     
-00013280: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00013290: 6174 6520 616e 6420 7773 2069 7320 6e6f  ate and ws is no
-000132a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000132b0: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-000132c0: 776f 726b 6572 732e 6765 7428 7773 2e61  workers.get(ws.a
-000132d0: 6464 7265 7373 2920 6973 2077 730a 2020  ddress) is ws.  
-000132e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000132f0: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
-00013300: 696e 672c 2028 7773 2c20 7365 6c66 2e72  ing, (ws, self.r
-00013310: 756e 6e69 6e67 290a 0a20 2020 2020 2020  unning)..       
-00013320: 2072 6574 7572 6e20 7773 0a0a 2020 2020   return ws..    
-00013330: 6465 6620 7472 616e 7369 7469 6f6e 5f77  def transition_w
-00013340: 6169 7469 6e67 5f70 726f 6365 7373 696e  aiting_processin
-00013350: 6728 7365 6c66 2c20 6b65 793a 2073 7472  g(self, key: str
-00013360: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00013370: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
-00013380: 0a20 2020 2020 2020 2022 2222 506f 7373  .        """Poss
-00013390: 6962 6c79 2073 6368 6564 756c 6520 6120  ibly schedule a 
-000133a0: 7265 6164 7920 7461 736b 2e20 5468 6973  ready task. This
-000133b0: 2069 7320 7468 6520 7072 696d 6172 7920   is the primary 
-000133c0: 6469 7370 6174 6368 2066 6f72 2072 6561  dispatch for rea
-000133d0: 6479 2074 6173 6b73 2e0a 0a20 2020 2020  dy tasks...     
-000133e0: 2020 2049 6620 7468 6572 6527 7320 6e6f     If there's no
-000133f0: 2061 7070 726f 7072 6961 7465 2077 6f72   appropriate wor
-00013400: 6b65 7220 666f 7220 7468 6520 7461 736b  ker for the task
-00013410: 2028 6275 7420 7468 6520 7461 736b 2069   (but the task i
-00013420: 7320 6f74 6865 7277 6973 650a 2020 2020  s otherwise.    
-00013430: 2020 2020 7275 6e6e 6162 6c65 292c 2069      runnable), i
-00013440: 7420 7769 6c6c 2062 6520 7265 636f 6d6d  t will be recomm
-00013450: 656e 6465 6420 746f 2060 606e 6f2d 776f  ended to ``no-wo
-00013460: 726b 6572 6060 206f 7220 6060 7175 6575  rker`` or ``queu
-00013470: 6564 6060 2e0a 2020 2020 2020 2020 2222  ed``..        ""
-00013480: 220a 2020 2020 2020 2020 7473 203d 2073  ".        ts = s
-00013490: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
-000134a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000134b0: 6973 5f72 6f6f 7469 7368 2874 7329 3a0a  is_rootish(ts):.
-000134c0: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
-000134d0: 5445 3a20 6861 7669 6e67 2074 776f 2072  TE: having two r
-000134e0: 6f6f 742d 6973 6820 6d65 7468 6f64 7320  oot-ish methods 
-000134f0: 6973 2074 656d 706f 7261 7279 2e20 5768  is temporary. Wh
-00013500: 656e 2074 6865 2066 6561 7475 7265 2066  en the feature f
-00013510: 6c61 6720 6973 0a20 2020 2020 2020 2020  lag is.         
-00013520: 2020 2023 2072 656d 6f76 6564 2c20 7468     # removed, th
-00013530: 6572 6520 7368 6f75 6c64 206f 6e6c 7920  ere should only 
-00013540: 6265 206f 6e65 2c20 7768 6963 6820 636f  be one, which co
-00013550: 6d62 696e 6573 2063 6f2d 6173 7369 676e  mbines co-assign
-00013560: 6d65 6e74 2061 6e64 0a20 2020 2020 2020  ment and.       
-00013570: 2020 2020 2023 2071 7565 7569 6e67 2e20       # queuing. 
-00013580: 4576 656e 7475 616c 6c79 2c20 7370 6563  Eventually, spec
-00013590: 6961 6c2d 6361 7369 6e67 2072 6f6f 7420  ial-casing root 
-000135a0: 7461 736b 7320 6d69 6768 7420 6265 2072  tasks might be r
-000135b0: 656d 6f76 6564 2065 6e74 6972 656c 792c  emoved entirely,
-000135c0: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
-000135d0: 6974 6820 6265 7474 6572 2068 6575 7269  ith better heuri
-000135e0: 7374 6963 732e 0a20 2020 2020 2020 2020  stics..         
-000135f0: 2020 2069 6620 6d61 7468 2e69 7369 6e66     if math.isinf
-00013600: 2873 656c 662e 574f 524b 4552 5f53 4154  (self.WORKER_SAT
-00013610: 5552 4154 494f 4e29 3a0a 2020 2020 2020  URATION):.      
-00013620: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00013630: 2028 7773 203a 3d20 7365 6c66 2e64 6563   (ws := self.dec
-00013640: 6964 655f 776f 726b 6572 5f72 6f6f 7469  ide_worker_rooti
-00013650: 7368 5f71 7565 7569 6e67 5f64 6973 6162  sh_queuing_disab
-00013660: 6c65 6428 7473 2929 3a0a 2020 2020 2020  led(ts)):.      
-00013670: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00013680: 7475 726e 207b 7473 2e6b 6579 3a20 226e  turn {ts.key: "n
-00013690: 6f2d 776f 726b 6572 227d 2c20 7b7d 2c20  o-worker"}, {}, 
-000136a0: 7b7d 0a20 2020 2020 2020 2020 2020 2065  {}.            e
-000136b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000136c0: 2020 2020 2069 6620 6e6f 7420 2877 7320       if not (ws 
-000136d0: 3a3d 2073 656c 662e 6465 6369 6465 5f77  := self.decide_w
-000136e0: 6f72 6b65 725f 726f 6f74 6973 685f 7175  orker_rootish_qu
-000136f0: 6575 696e 675f 656e 6162 6c65 6428 2929  euing_enabled())
-00013700: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013710: 2020 2020 2020 7265 7475 726e 207b 7473        return {ts
-00013720: 2e6b 6579 3a20 2271 7565 7565 6422 7d2c  .key: "queued"},
-00013730: 207b 7d2c 207b 7d0a 2020 2020 2020 2020   {}, {}.        
-00013740: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00013750: 2020 6966 206e 6f74 2028 7773 203a 3d20    if not (ws := 
-00013760: 7365 6c66 2e64 6563 6964 655f 776f 726b  self.decide_work
-00013770: 6572 5f6e 6f6e 5f72 6f6f 7469 7368 2874  er_non_rootish(t
-00013780: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
-00013790: 2020 2020 2072 6574 7572 6e20 7b74 732e       return {ts.
-000137a0: 6b65 793a 2022 6e6f 2d77 6f72 6b65 7222  key: "no-worker"
-000137b0: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2020  }, {}, {}..     
-000137c0: 2020 2077 6f72 6b65 725f 6d73 6773 203d     worker_msgs =
-000137d0: 2073 656c 662e 5f61 6464 5f74 6f5f 7072   self._add_to_pr
-000137e0: 6f63 6573 7369 6e67 2874 732c 2077 7329  ocessing(ts, ws)
-000137f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00013800: 7b7d 2c20 7b7d 2c20 776f 726b 6572 5f6d  {}, {}, worker_m
-00013810: 7367 730a 0a20 2020 2064 6566 2074 7261  sgs..    def tra
-00013820: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
-00013830: 6d65 6d6f 7279 280a 2020 2020 2020 2020  memory(.        
-00013840: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
-00013850: 793a 2073 7472 2c0a 2020 2020 2020 2020  y: str,.        
-00013860: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00013870: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-00013880: 2020 2020 206e 6279 7465 733a 2069 6e74       nbytes: int
-00013890: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-000138a0: 2020 2020 2020 2020 7479 7065 3a20 6279          type: by
-000138b0: 7465 7320 7c20 4e6f 6e65 203d 204e 6f6e  tes | None = Non
-000138c0: 652c 0a20 2020 2020 2020 2074 7970 656e  e,.        typen
-000138d0: 616d 653a 2073 7472 207c 204e 6f6e 6520  ame: str | None 
-000138e0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-000138f0: 776f 726b 6572 3a20 7374 722c 0a20 2020  worker: str,.   
-00013900: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
-00013910: 6e79 2c0a 2020 2020 2920 2d3e 2052 6563  ny,.    ) -> Rec
-00013920: 734d 7367 733a 0a20 2020 2020 2020 2022  sMsgs:.        "
-00013930: 2222 5468 6973 2074 7261 6e73 6974 696f  ""This transitio
-00013940: 6e20 6578 636c 7573 6976 656c 7920 6861  n exclusively ha
-00013950: 7070 656e 7320 696e 2061 2072 6163 6520  ppens in a race 
-00013960: 636f 6e64 6974 696f 6e20 7768 6572 6520  condition where 
-00013970: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
-00013980: 2020 2020 2020 6265 6c69 6576 6573 2074        believes t
-00013990: 6861 7420 7468 6520 6f6e 6c79 2063 6f70  hat the only cop
-000139a0: 7920 6f66 2061 2064 6570 656e 6465 6e63  y of a dependenc
-000139b0: 7920 7461 736b 2068 6173 206a 7573 7420  y task has just 
-000139c0: 6265 656e 206c 6f73 742c 2073 6f20 6974  been lost, so it
-000139d0: 0a20 2020 2020 2020 2074 7261 6e73 6974  .        transit
-000139e0: 696f 6e73 2061 6c6c 2064 6570 656e 6465  ions all depende
-000139f0: 6e74 7320 6261 636b 2074 6f20 7761 6974  nts back to wait
-00013a00: 696e 672c 2062 7574 2061 6374 7561 6c6c  ing, but actuall
-00013a10: 7920 6120 7265 706c 6963 6120 6861 7320  y a replica has 
-00013a20: 616c 7265 6164 790a 2020 2020 2020 2020  already.        
-00013a30: 6265 656e 2061 6371 7569 7265 6420 6279  been acquired by
-00013a40: 2061 2077 6f72 6b65 7220 636f 6d70 7574   a worker comput
-00013a50: 696e 6720 7468 6520 6465 7065 6e64 656e  ing the dependen
-00013a60: 6379 202d 2074 6865 2073 6368 6564 756c  cy - the schedul
-00013a70: 6572 206a 7573 7420 646f 6573 6e27 740a  er just doesn't.
-00013a80: 2020 2020 2020 2020 6b6e 6f77 2079 6574          know yet
-00013a90: 202d 2061 6e64 2074 6865 2065 7865 6375   - and the execu
-00013aa0: 7469 6f6e 2066 696e 6973 6865 7320 6265  tion finishes be
-00013ab0: 666f 7265 2074 6865 2063 616e 6365 6c6c  fore the cancell
-00013ac0: 6174 696f 6e20 6d65 7373 6167 6520 6672  ation message fr
-00013ad0: 6f6d 2074 6865 0a20 2020 2020 2020 2073  om the.        s
-00013ae0: 6368 6564 756c 6572 2068 6173 2061 2063  cheduler has a c
-00013af0: 6861 6e63 6520 746f 2072 6561 6368 2074  hance to reach t
-00013b00: 6865 2077 6f72 6b65 722e 2053 686f 7274  he worker. Short
-00013b10: 6c79 2c20 7468 6520 6361 6e63 656c 6c61  ly, the cancella
-00013b20: 7469 6f6e 2072 6571 7565 7374 0a20 2020  tion request.   
-00013b30: 2020 2020 2077 696c 6c20 7265 6163 6820       will reach 
-00013b40: 7468 6520 776f 726b 6572 2c20 7468 7573  the worker, thus
-00013b50: 2064 656c 6574 696e 6720 7468 6520 6461   deleting the da
-00013b60: 7461 2066 726f 6d20 6d65 6d6f 7279 2e0a  ta from memory..
-00013b70: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00013b80: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00013b90: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
-00013ba0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00013bb0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00013bc0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-00013bd0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-00013be0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-00013bf0: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-00013c00: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00013c10: 7473 2e73 7461 7465 203d 3d20 2277 6169  ts.state == "wai
-00013c20: 7469 6e67 220a 0a20 2020 2020 2020 2072  ting"..        r
-00013c30: 6574 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d  eturn {}, {}, {}
-00013c40: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-00013c50: 7469 6f6e 5f70 726f 6365 7373 696e 675f  tion_processing_
-00013c60: 6d65 6d6f 7279 280a 2020 2020 2020 2020  memory(.        
-00013c70: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
-00013c80: 793a 2073 7472 2c0a 2020 2020 2020 2020  y: str,.        
-00013c90: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00013ca0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-00013cb0: 2020 2020 206e 6279 7465 733a 2069 6e74       nbytes: int
-00013cc0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00013cd0: 2020 2020 2020 2020 7479 7065 3a20 6279          type: by
-00013ce0: 7465 7320 7c20 4e6f 6e65 203d 204e 6f6e  tes | None = Non
-00013cf0: 652c 0a20 2020 2020 2020 2074 7970 656e  e,.        typen
-00013d00: 616d 653a 2073 7472 207c 204e 6f6e 6520  ame: str | None 
-00013d10: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00013d20: 776f 726b 6572 3a20 7374 722c 0a20 2020  worker: str,.   
-00013d30: 2020 2020 2073 7461 7274 7374 6f70 733a       startstops:
-00013d40: 206c 6973 745b 6469 6374 5d20 7c20 4e6f   list[dict] | No
-00013d50: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00013d60: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
-00013d70: 2c0a 2020 2020 2920 2d3e 2052 6563 734d  ,.    ) -> RecsM
-00013d80: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00013d90: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00013da0: 5d0a 0a20 2020 2020 2020 2061 7373 6572  ]..        asser
-00013db0: 7420 776f 726b 6572 0a20 2020 2020 2020  t worker.       
-00013dc0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00013dd0: 6365 2877 6f72 6b65 722c 2073 7472 290a  ce(worker, str).
-00013de0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00013df0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00013e00: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00013e10: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
-00013e20: 2020 2020 2020 2020 2020 2077 7373 203d             wss =
-00013e30: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00013e40: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-00013e50: 7365 7274 2077 7373 0a20 2020 2020 2020  sert wss.       
-00013e60: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
-00013e70: 6e20 7773 732e 7072 6f63 6573 7369 6e67  n wss.processing
-00013e80: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-00013e90: 2077 7373 0a20 2020 2020 2020 2020 2020   wss.           
-00013ea0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00013eb0: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
-00013ec0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00013ed0: 2074 732e 7768 6f5f 6861 732c 2028 7473   ts.who_has, (ts
-00013ee0: 2c20 7473 2e77 686f 5f68 6173 290a 2020  , ts.who_has).  
-00013ef0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00013f00: 206e 6f74 2074 732e 6578 6365 7074 696f   not ts.exceptio
-00013f10: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
-00013f20: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
-00013f30: 6174 6520 3d3d 2022 7072 6f63 6573 7369  ate == "processi
-00013f40: 6e67 220a 0a20 2020 2020 2020 2077 7320  ng"..        ws 
-00013f50: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
-00013f60: 6574 2877 6f72 6b65 7229 0a20 2020 2020  et(worker).     
-00013f70: 2020 2069 6620 7773 2069 7320 4e6f 6e65     if ws is None
-00013f80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00013f90: 7475 726e 207b 6b65 793a 2022 7265 6c65  turn {key: "rele
-00013fa0: 6173 6564 227d 2c20 7b7d 2c20 7b7d 0a0a  ased"}, {}, {}..
-00013fb0: 2020 2020 2020 2020 6966 2077 7320 213d          if ws !=
-00013fc0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00013fd0: 6e3a 2020 2320 7072 6167 6d61 3a20 6e6f  n:  # pragma: no
-00013fe0: 636f 7665 720a 2020 2020 2020 2020 2020  cover.          
-00013ff0: 2020 6173 7365 7274 2074 732e 7072 6f63    assert ts.proc
-00014000: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
-00014010: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00014020: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
-00014030: 2020 2020 2020 2020 2020 6622 5461 736b            f"Task
-00014040: 207b 7473 2e6b 6579 2172 7d20 7472 616e   {ts.key!r} tran
-00014050: 7369 7469 6f6e 6564 2066 726f 6d20 7072  sitioned from pr
-00014060: 6f63 6573 7369 6e67 2074 6f20 6d65 6d6f  ocessing to memo
-00014070: 7279 206f 6e20 776f 726b 6572 2022 0a20  ry on worker ". 
-00014080: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014090: 227b 7773 7d2c 2077 6869 6c65 2069 7420  "{ws}, while it 
-000140a0: 7761 7320 6578 7065 6374 6564 2066 726f  was expected fro
-000140b0: 6d20 7b74 732e 7072 6f63 6573 7369 6e67  m {ts.processing
-000140c0: 5f6f 6e7d 2e20 5468 6973 2073 686f 756c  _on}. This shoul
-000140d0: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
-000140e0: 2020 2020 6622 6265 2069 6d70 6f73 7369      f"be impossi
-000140f0: 626c 652e 207b 7374 696d 756c 7573 5f69  ble. {stimulus_i
-00014100: 643d 7d2c 2073 746f 7279 3d7b 7365 6c66  d=}, story={self
-00014110: 2e73 746f 7279 2874 7329 7d22 0a20 2020  .story(ts)}".   
-00014120: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00014130: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-00014140: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014150: 230a 2020 2020 2020 2020 2320 5570 6461  #.        # Upda
-00014160: 7465 2054 696d 696e 6720 496e 666f 726d  te Timing Inform
-00014170: 6174 696f 6e20 230a 2020 2020 2020 2020  ation #.        
-00014180: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014190: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-000141a0: 2020 2020 2020 6966 2073 7461 7274 7374        if startst
-000141b0: 6f70 733a 0a20 2020 2020 2020 2020 2020  ops:.           
-000141c0: 2066 6f72 2073 7461 7274 7374 6f70 2069   for startstop i
-000141d0: 6e20 7374 6172 7473 746f 7073 3a0a 2020  n startstops:.  
-000141e0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-000141f0: 2e67 726f 7570 2e61 6464 5f64 7572 6174  .group.add_durat
-00014200: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-00014210: 2020 2020 2020 2020 2073 746f 703d 7374           stop=st
-00014220: 6172 7473 746f 705b 2273 746f 7022 5d2c  artstop["stop"],
-00014230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014240: 2020 2020 2073 7461 7274 3d73 7461 7274       start=start
-00014250: 7374 6f70 5b22 7374 6172 7422 5d2c 0a20  stop["start"],. 
-00014260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014270: 2020 2061 6374 696f 6e3d 7374 6172 7473     action=starts
-00014280: 746f 705b 2261 6374 696f 6e22 5d2c 0a20  top["action"],. 
-00014290: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000142a0: 0a0a 2020 2020 2020 2020 7320 3d20 7365  ..        s = se
-000142b0: 6c66 2e75 6e6b 6e6f 776e 5f64 7572 6174  lf.unknown_durat
-000142c0: 696f 6e73 2e70 6f70 2874 732e 7072 6566  ions.pop(ts.pref
-000142d0: 6978 2e6e 616d 652c 2073 6574 2829 290a  ix.name, set()).
-000142e0: 2020 2020 2020 2020 7374 6561 6c20 3d20          steal = 
-000142f0: 7365 6c66 2e65 7874 656e 7369 6f6e 732e  self.extensions.
-00014300: 6765 7428 2273 7465 616c 696e 6722 290a  get("stealing").
-00014310: 2020 2020 2020 2020 6966 2073 7465 616c          if steal
-00014320: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00014330: 7220 7474 7320 696e 2073 3a0a 2020 2020  r tts in s:.    
-00014340: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00014350: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00014360: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014370: 2020 2020 2020 7374 6561 6c2e 7265 6361        steal.reca
-00014380: 6c63 756c 6174 655f 636f 7374 2874 7473  lculate_cost(tts
-00014390: 290a 0a20 2020 2020 2020 2023 2323 2323  )..        #####
-000143a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000143b0: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-000143c0: 2320 5570 6461 7465 2053 7461 7465 2049  # Update State I
-000143d0: 6e66 6f72 6d61 7469 6f6e 2023 0a20 2020  nformation #.   
-000143e0: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
-000143f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014400: 230a 2020 2020 2020 2020 6966 206e 6279  #.        if nby
-00014410: 7465 7320 6973 206e 6f74 204e 6f6e 653a  tes is not None:
-00014420: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
-00014430: 7365 745f 6e62 7974 6573 286e 6279 7465  set_nbytes(nbyte
-00014440: 7329 0a0a 2020 2020 2020 2020 7365 6c66  s)..        self
-00014450: 2e5f 6578 6974 5f70 726f 6365 7373 696e  ._exit_processin
-00014460: 675f 636f 6d6d 6f6e 2874 7329 0a0a 2020  g_common(ts)..  
-00014470: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00014480: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
-00014490: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
-000144a0: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
-000144b0: 2020 2020 2020 2020 7365 6c66 2e5f 6164          self._ad
-000144c0: 645f 746f 5f6d 656d 6f72 7928 0a20 2020  d_to_memory(.   
-000144d0: 2020 2020 2020 2020 2074 732c 2077 732c           ts, ws,
-000144e0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000144f0: 2c20 636c 6965 6e74 5f6d 7367 732c 2074  , client_msgs, t
-00014500: 7970 653d 7479 7065 2c20 7479 7065 6e61  ype=type, typena
-00014510: 6d65 3d74 7970 656e 616d 650a 2020 2020  me=typename.    
-00014520: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
-00014530: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-00014540: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00014550: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-00014560: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-00014570: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00014580: 7473 2e77 6169 7469 6e67 5f6f 6e0a 0a20  ts.waiting_on.. 
-00014590: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-000145a0: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
-000145b0: 6c69 656e 745f 6d73 6773 2c20 7b7d 0a0a  lient_msgs, {}..
-000145c0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
-000145d0: 6f6e 5f6d 656d 6f72 795f 7265 6c65 6173  on_memory_releas
-000145e0: 6564 280a 2020 2020 2020 2020 7365 6c66  ed(.        self
-000145f0: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
-00014600: 756c 7573 5f69 643a 2073 7472 2c20 2a2c  ulus_id: str, *,
-00014610: 2073 6166 653a 2062 6f6f 6c20 3d20 4661   safe: bool = Fa
-00014620: 6c73 650a 2020 2020 2920 2d3e 2052 6563  lse.    ) -> Rec
-00014630: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
-00014640: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00014650: 6579 5d0a 0a20 2020 2020 2020 2069 6620  ey]..        if 
-00014660: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-00014670: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014680: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00014690: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-000146a0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-000146b0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-000146c0: 2020 2020 2020 2020 6966 2073 6166 653a          if safe:
-000146d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000146e0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-000146f0: 6169 7465 7273 0a0a 2020 2020 2020 2020  aiters..        
-00014700: 6966 2074 732e 6163 746f 723a 0a20 2020  if ts.actor:.   
-00014710: 2020 2020 2020 2020 2066 6f72 2077 7320           for ws 
-00014720: 696e 2074 732e 7768 6f5f 6861 733a 0a20  in ts.who_has:. 
-00014730: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00014740: 732e 6163 746f 7273 2e64 6973 6361 7264  s.actors.discard
-00014750: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-00014760: 2069 6620 7473 2e77 686f 5f77 616e 7473   if ts.who_wants
-00014770: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014780: 2020 7473 2e65 7863 6570 7469 6f6e 5f62    ts.exception_b
-00014790: 6c61 6d65 203d 2074 730a 2020 2020 2020  lame = ts.      
-000147a0: 2020 2020 2020 2020 2020 7473 2e65 7863            ts.exc
-000147b0: 6570 7469 6f6e 203d 2053 6572 6961 6c69  eption = Seriali
-000147c0: 7a65 6428 0a20 2020 2020 2020 2020 2020  zed(.           
-000147d0: 2020 2020 2020 2020 202a 7365 7269 616c           *serial
-000147e0: 697a 6528 5661 6c75 6545 7272 6f72 2822  ize(ValueError("
-000147f0: 576f 726b 6572 2068 6f6c 6469 6e67 2041  Worker holding A
-00014800: 6374 6f72 2077 6173 206c 6f73 7422 2929  ctor was lost"))
-00014810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014820: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00014830: 2020 2072 6574 7572 6e20 7b74 732e 6b65     return {ts.ke
-00014840: 793a 2022 6572 7265 6422 7d2c 207b 7d2c  y: "erred"}, {},
-00014850: 207b 7d20 2023 2064 6f6e 2774 2074 7279   {}  # don't try
-00014860: 2074 6f20 7265 6372 6561 7465 0a0a 2020   to recreate..  
-00014870: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00014880: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
-00014890: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
-000148a0: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
-000148b0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-000148c0: 7367 733a 204d 7367 7320 3d20 7b7d 0a0a  sgs: Msgs = {}..
-000148d0: 2020 2020 2020 2020 2320 5858 5820 6661          # XXX fa
-000148e0: 6374 6f72 2074 6869 7320 6f75 743f 0a20  ctor this out?. 
-000148f0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-00014900: 6720 3d20 7b0a 2020 2020 2020 2020 2020  g = {.          
-00014910: 2020 226f 7022 3a20 2266 7265 652d 6b65    "op": "free-ke
-00014920: 7973 222c 0a20 2020 2020 2020 2020 2020  ys",.           
-00014930: 2022 6b65 7973 223a 205b 6b65 795d 2c0a   "keys": [key],.
-00014940: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-00014950: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-00014960: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-00014970: 7d0a 2020 2020 2020 2020 666f 7220 7773  }.        for ws
-00014980: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
-00014990: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000149a0: 6572 5f6d 7367 735b 7773 2e61 6464 7265  er_msgs[ws.addre
-000149b0: 7373 5d20 3d20 5b77 6f72 6b65 725f 6d73  ss] = [worker_ms
-000149c0: 675d 0a20 2020 2020 2020 2073 656c 662e  g].        self.
-000149d0: 7265 6d6f 7665 5f61 6c6c 5f72 6570 6c69  remove_all_repli
-000149e0: 6361 7328 7473 290a 0a20 2020 2020 2020  cas(ts)..       
-000149f0: 2074 732e 7374 6174 6520 3d20 2272 656c   ts.state = "rel
-00014a00: 6561 7365 6422 0a0a 2020 2020 2020 2020  eased"..        
-00014a10: 7265 706f 7274 5f6d 7367 203d 207b 226f  report_msg = {"o
-00014a20: 7022 3a20 226c 6f73 742d 6461 7461 222c  p": "lost-data",
-00014a30: 2022 6b65 7922 3a20 6b65 797d 0a20 2020   "key": key}.   
-00014a40: 2020 2020 2066 6f72 2063 7320 696e 2074       for cs in t
-00014a50: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
-00014a60: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
-00014a70: 6d73 6773 5b63 732e 636c 6965 6e74 5f6b  msgs[cs.client_k
-00014a80: 6579 5d20 3d20 5b72 6570 6f72 745f 6d73  ey] = [report_ms
-00014a90: 675d 0a0a 2020 2020 2020 2020 6966 206e  g]..        if n
-00014aa0: 6f74 2074 732e 7275 6e5f 7370 6563 3a20  ot ts.run_spec: 
-00014ab0: 2023 2070 7572 6520 6461 7461 0a20 2020   # pure data.   
-00014ac0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-00014ad0: 6e64 6174 696f 6e73 5b6b 6579 5d20 3d20  ndations[key] = 
-00014ae0: 2266 6f72 676f 7474 656e 220a 2020 2020  "forgotten".    
-00014af0: 2020 2020 656c 6966 2074 732e 6861 735f      elif ts.has_
-00014b00: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
-00014b10: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00014b20: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
-00014b30: 6579 5d20 3d20 2266 6f72 676f 7474 656e  ey] = "forgotten
-00014b40: 220a 2020 2020 2020 2020 656c 6966 2074  ".        elif t
-00014b50: 732e 7768 6f5f 7761 6e74 7320 6f72 2074  s.who_wants or t
-00014b60: 732e 7761 6974 6572 733a 0a20 2020 2020  s.waiters:.     
-00014b70: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00014b80: 6174 696f 6e73 5b6b 6579 5d20 3d20 2277  ations[key] = "w
-00014b90: 6169 7469 6e67 220a 0a20 2020 2020 2020  aiting"..       
-00014ba0: 2066 6f72 2064 7473 2069 6e20 7473 2e77   for dts in ts.w
-00014bb0: 6169 7465 7273 3a0a 2020 2020 2020 2020  aiters:.        
-00014bc0: 2020 2020 6966 2064 7473 2e73 7461 7465      if dts.state
-00014bd0: 2069 6e20 2822 6e6f 2d77 6f72 6b65 7222   in ("no-worker"
-00014be0: 2c20 2270 726f 6365 7373 696e 6722 293a  , "processing"):
-00014bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014c00: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00014c10: 5b64 7473 2e6b 6579 5d20 3d20 2277 6169  [dts.key] = "wai
-00014c20: 7469 6e67 220a 2020 2020 2020 2020 2020  ting".          
-00014c30: 2020 656c 6966 2064 7473 2e73 7461 7465    elif dts.state
-00014c40: 203d 3d20 2277 6169 7469 6e67 223a 0a20   == "waiting":. 
-00014c50: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00014c60: 7473 2e77 6169 7469 6e67 5f6f 6e2e 6164  ts.waiting_on.ad
-00014c70: 6428 7473 290a 0a20 2020 2020 2020 2069  d(ts)..        i
-00014c80: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-00014c90: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00014ca0: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
-00014cb0: 6e67 5f6f 6e0a 0a20 2020 2020 2020 2072  ng_on..        r
-00014cc0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-00014cd0: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
-00014ce0: 6773 2c20 776f 726b 6572 5f6d 7367 730a  gs, worker_msgs.
-00014cf0: 0a20 2020 2064 6566 2074 7261 6e73 6974  .    def transit
-00014d00: 696f 6e5f 7265 6c65 6173 6564 5f65 7272  ion_released_err
-00014d10: 6564 2873 656c 662c 206b 6579 3a20 7374  ed(self, key: st
-00014d20: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
-00014d30: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
-00014d40: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
-00014d50: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
-00014d60: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00014d70: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
-00014d80: 7d0a 2020 2020 2020 2020 636c 6965 6e74  }.        client
-00014d90: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
-00014da0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00014db0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-00014dc0: 2020 2020 2020 2020 7769 7468 206c 6f67          with log
-00014dd0: 5f65 7272 6f72 7328 7064 623d 4c4f 475f  _errors(pdb=LOG_
-00014de0: 5044 4229 3a0a 2020 2020 2020 2020 2020  PDB):.          
-00014df0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00014e00: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
-00014e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e20: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
-00014e30: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
-00014e40: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00014e50: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
+0000c190: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+0000c1a0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0000c1b0: 6572 7420 6973 696e 7374 616e 6365 2874  ert isinstance(t
+0000c1c0: 732c 2054 6173 6b53 7461 7465 292c 2028  s, TaskState), (
+0000c1d0: 7265 7072 2874 7329 2c20 7365 6c66 2e64  repr(ts), self.d
+0000c1e0: 6570 656e 6465 6e63 6965 7329 0a20 2020  ependencies).   
+0000c1f0: 2020 2020 2020 2020 2066 6f72 2074 7320           for ts 
+0000c200: 696e 2073 656c 662e 6465 7065 6e64 656e  in self.dependen
+0000c210: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0000c220: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0000c230: 7461 6e63 6528 7473 2c20 5461 736b 5374  tance(ts, TaskSt
+0000c240: 6174 6529 2c20 2872 6570 7228 7473 292c  ate), (repr(ts),
+0000c250: 2073 656c 662e 6465 7065 6e64 656e 7473   self.dependents
+0000c260: 290a 2020 2020 2020 2020 2020 2020 7661  ).            va
+0000c270: 6c69 6461 7465 5f74 6173 6b5f 7374 6174  lidate_task_stat
+0000c280: 6528 7365 6c66 290a 2020 2020 2020 2020  e(self).        
+0000c290: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+0000c2a0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0000c2b0: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+0000c2c0: 696f 6e28 6529 0a20 2020 2020 2020 2020  ion(e).         
+0000c2d0: 2020 2069 6620 4c4f 475f 5044 423a 0a20     if LOG_PDB:. 
+0000c2e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c2f0: 6d70 6f72 7420 7064 620a 0a20 2020 2020  mport pdb..     
+0000c300: 2020 2020 2020 2020 2020 2070 6462 2e73             pdb.s
+0000c310: 6574 5f74 7261 6365 2829 0a0a 2020 2020  et_trace()..    
+0000c320: 6465 6620 6765 745f 6e62 7974 6573 5f64  def get_nbytes_d
+0000c330: 6570 7328 7365 6c66 2920 2d3e 2069 6e74  eps(self) -> int
+0000c340: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000c350: 2073 756d 2874 732e 6765 745f 6e62 7974   sum(ts.get_nbyt
+0000c360: 6573 2829 2066 6f72 2074 7320 696e 2073  es() for ts in s
+0000c370: 656c 662e 6465 7065 6e64 656e 6369 6573  elf.dependencies
+0000c380: 290a 0a20 2020 2064 6566 205f 746f 5f64  )..    def _to_d
+0000c390: 6963 745f 6e6f 5f6e 6573 7428 7365 6c66  ict_no_nest(self
+0000c3a0: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
+0000c3b0: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
+0000c3c0: 2929 202d 3e20 6469 6374 5b73 7472 2c20  )) -> dict[str, 
+0000c3d0: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
+0000c3e0: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
+0000c3f0: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
+0000c400: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
+0000c410: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
+0000c420: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
+0000c430: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
+0000c440: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
+0000c450: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
+0000c460: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+0000c470: 2020 2020 2020 2043 6c69 656e 742e 6475         Client.du
+0000c480: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
+0000c490: 0a20 2020 2020 2020 2064 6973 7472 6962  .        distrib
+0000c4a0: 7574 6564 2e75 7469 6c73 2e72 6563 7572  uted.utils.recur
+0000c4b0: 7369 7665 5f74 6f5f 6469 6374 0a0a 2020  sive_to_dict..  
+0000c4c0: 2020 2020 2020 4e6f 7465 730a 2020 2020        Notes.    
+0000c4d0: 2020 2020 2d2d 2d2d 2d0a 2020 2020 2020      -----.      
+0000c4e0: 2020 5468 6973 2063 6c61 7373 2075 7365    This class use
+0000c4f0: 7320 6060 5f74 6f5f 6469 6374 5f6e 6f5f  s ``_to_dict_no_
+0000c500: 6e65 7374 6060 2069 6e73 7465 6164 206f  nest`` instead o
+0000c510: 6620 6060 5f74 6f5f 6469 6374 6060 2e0a  f ``_to_dict``..
+0000c520: 2020 2020 2020 2020 5768 656e 2061 2074          When a t
+0000c530: 6173 6b20 7265 6665 7265 6e63 6573 2061  ask references a
+0000c540: 6e6f 7468 6572 2074 6173 6b2c 206f 7220  nother task, or 
+0000c550: 7768 656e 2061 2057 6f72 6b65 7253 7461  when a WorkerSta
+0000c560: 7465 2e74 6173 6b73 2063 6f6e 7461 696e  te.tasks contain
+0000c570: 7320 7461 736b 732c 0a20 2020 2020 2020  s tasks,.       
+0000c580: 2074 6869 7320 6d65 7468 6f64 2069 7320   this method is 
+0000c590: 6e6f 7420 6578 6563 7574 6564 2066 6f72  not executed for
+0000c5a0: 2074 6865 2069 6e6e 6572 2074 6173 6b2c   the inner task,
+0000c5b0: 2065 7665 6e20 6966 2074 6865 2069 6e6e   even if the inn
+0000c5c0: 6572 2074 6173 6b20 7761 7320 6e65 7665  er task was neve
+0000c5d0: 720a 2020 2020 2020 2020 7365 656e 2062  r.        seen b
+0000c5e0: 6566 6f72 653b 2079 6f75 2067 6574 2061  efore; you get a
+0000c5f0: 2072 6570 7220 696e 7374 6561 642e 2041   repr instead. A
+0000c600: 6c6c 2074 6173 6b73 2073 686f 756c 6420  ll tasks should 
+0000c610: 6e65 6174 6c79 2061 7070 6561 7220 756e  neatly appear un
+0000c620: 6465 720a 2020 2020 2020 2020 5363 6865  der.        Sche
+0000c630: 6475 6c65 722e 7461 736b 732e 2054 6869  duler.tasks. Thi
+0000c640: 7320 616c 736f 2070 7265 7665 6e74 7320  s also prevents 
+0000c650: 6120 5265 6375 7273 696f 6e45 7272 6f72  a RecursionError
+0000c660: 2064 7572 696e 6720 7061 7274 6963 756c   during particul
+0000c670: 6172 6c79 2068 6561 7679 0a20 2020 2020  arly heavy.     
+0000c680: 2020 206c 6f61 6473 2c20 7768 6963 6820     loads, which 
+0000c690: 6861 7665 2062 6565 6e20 6f62 7365 7276  have been observ
+0000c6a0: 6564 2074 6f20 6861 7070 656e 2077 6865  ed to happen whe
+0000c6b0: 6e65 7665 7220 7468 6572 6527 7320 616e  never there's an
+0000c6c0: 2061 6379 636c 6963 2064 6570 656e 6465   acyclic depende
+0000c6d0: 6e63 790a 2020 2020 2020 2020 6368 6169  ncy.        chai
+0000c6e0: 6e20 6f66 207e 3230 302b 2074 6173 6b73  n of ~200+ tasks
+0000c6f0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0000c700: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
+0000c710: 7572 7369 7665 5f74 6f5f 6469 6374 2873  ursive_to_dict(s
+0000c720: 656c 662c 2065 7863 6c75 6465 3d65 7863  elf, exclude=exc
+0000c730: 6c75 6465 2c20 6d65 6d62 6572 733d 5472  lude, members=Tr
+0000c740: 7565 290a 0a0a 636c 6173 7320 5472 616e  ue)...class Tran
+0000c750: 7369 7469 6f6e 284e 616d 6564 5475 706c  sition(NamedTupl
+0000c760: 6529 3a0a 2020 2020 2222 2241 6e20 656e  e):.    """An en
+0000c770: 7472 7920 696e 203a 6174 7472 3a60 5363  try in :attr:`Sc
+0000c780: 6865 6475 6c65 7253 7461 7465 2e74 7261  hedulerState.tra
+0000c790: 6e73 6974 696f 6e5f 6c6f 6760 2222 220a  nsition_log`""".
+0000c7a0: 0a20 2020 206b 6579 3a20 7374 720a 2020  .    key: str.  
+0000c7b0: 2020 7374 6172 743a 2054 6173 6b53 7461    start: TaskSta
+0000c7c0: 7465 5374 6174 650a 2020 2020 6669 6e69  teState.    fini
+0000c7d0: 7368 3a20 5461 736b 5374 6174 6553 7461  sh: TaskStateSta
+0000c7e0: 7465 0a20 2020 2072 6563 6f6d 6d65 6e64  te.    recommend
+0000c7f0: 6174 696f 6e73 3a20 5265 6373 0a20 2020  ations: Recs.   
+0000c800: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+0000c810: 720a 2020 2020 7469 6d65 7374 616d 703a  r.    timestamp:
+0000c820: 2066 6c6f 6174 0a0a 0a63 6c61 7373 2053   float...class S
+0000c830: 6368 6564 756c 6572 5374 6174 653a 0a20  chedulerState:. 
+0000c840: 2020 2022 2222 556e 6465 726c 7969 6e67     """Underlying
+0000c850: 2074 6173 6b20 7374 6174 6520 6f66 2064   task state of d
+0000c860: 796e 616d 6963 2073 6368 6564 756c 6572  ynamic scheduler
+0000c870: 0a0a 2020 2020 5472 6163 6b73 2074 6865  ..    Tracks the
+0000c880: 2063 7572 7265 6e74 2073 7461 7465 206f   current state o
+0000c890: 6620 776f 726b 6572 732c 2064 6174 612c  f workers, data,
+0000c8a0: 2061 6e64 2063 6f6d 7075 7461 7469 6f6e   and computation
+0000c8b0: 732e 0a0a 2020 2020 4861 6e64 6c65 7320  s...    Handles 
+0000c8c0: 7472 616e 7369 7469 6f6e 7320 6265 7477  transitions betw
+0000c8d0: 6565 6e20 6469 6666 6572 656e 7420 7461  een different ta
+0000c8e0: 736b 2073 7461 7465 732e 204e 6f74 6966  sk states. Notif
+0000c8f0: 6965 7320 7468 650a 2020 2020 5363 6865  ies the.    Sche
+0000c900: 6475 6c65 7220 6f66 2063 6861 6e67 6573  duler of changes
+0000c910: 2062 7920 6d65 7373 6167 696e 6720 7061   by messaging pa
+0000c920: 7373 696e 6720 7468 726f 7567 6820 5175  ssing through Qu
+0000c930: 6575 6573 2c20 7768 6963 6820 7468 650a  eues, which the.
+0000c940: 2020 2020 5363 6865 6475 6c65 7220 6c69      Scheduler li
+0000c950: 7374 656e 7320 746f 2072 6573 706f 6e64  stens to respond
+0000c960: 7320 6163 636f 7264 696e 676c 792e 0a0a  s accordingly...
+0000c970: 2020 2020 416c 6c20 6576 656e 7473 2061      All events a
+0000c980: 7265 2068 616e 646c 6564 2071 7569 636b  re handled quick
+0000c990: 6c79 2c20 696e 206c 696e 6561 7220 7469  ly, in linear ti
+0000c9a0: 6d65 2077 6974 6820 7265 7370 6563 7420  me with respect 
+0000c9b0: 746f 2074 6865 6972 0a20 2020 2069 6e70  to their.    inp
+0000c9c0: 7574 2028 7768 6963 6820 6973 206f 6674  ut (which is oft
+0000c9d0: 656e 206f 6620 636f 6e73 7461 6e74 2073  en of constant s
+0000c9e0: 697a 6529 2061 6e64 2067 656e 6572 616c  ize) and general
+0000c9f0: 6c79 2077 6974 6869 6e20 610a 2020 2020  ly within a.    
+0000ca00: 6d69 6c6c 6973 6563 6f6e 642e 0a0a 2020  millisecond...  
+0000ca10: 2020 5573 6572 7320 7479 7069 6361 6c6c    Users typicall
+0000ca20: 7920 646f 206e 6f74 2069 6e74 6572 6163  y do not interac
+0000ca30: 7420 7769 7468 2060 6054 7261 6e73 6974  t with ``Transit
+0000ca40: 696f 6e73 6060 2064 6972 6563 746c 792e  ions`` directly.
+0000ca50: 2049 6e73 7465 6164 0a20 2020 2075 7365   Instead.    use
+0000ca60: 7273 2069 6e74 6572 6163 7420 7769 7468  rs interact with
+0000ca70: 2074 6865 2060 6043 6c69 656e 7460 602c   the ``Client``,
+0000ca80: 2077 6869 6368 2069 6e20 7475 726e 2065   which in turn e
+0000ca90: 6e67 6167 6573 2074 6865 0a20 2020 2060  ngages the.    `
+0000caa0: 6053 6368 6564 756c 6572 6060 2061 6666  `Scheduler`` aff
+0000cab0: 6563 7469 6e67 2064 6966 6665 7265 6e74  ecting different
+0000cac0: 2074 7261 6e73 6974 696f 6e73 2068 6572   transitions her
+0000cad0: 6520 756e 6465 722d 7468 652d 686f 6f64  e under-the-hood
+0000cae0: 2e20 496e 0a20 2020 2074 6865 2062 6163  . In.    the bac
+0000caf0: 6b67 726f 756e 6420 6060 576f 726b 6572  kground ``Worker
+0000cb00: 6060 7320 616c 736f 2065 6e67 6167 6520  ``s also engage 
+0000cb10: 7769 7468 2074 6865 2060 6053 6368 6564  with the ``Sched
+0000cb20: 756c 6572 6060 0a20 2020 2061 6666 6563  uler``.    affec
+0000cb30: 7469 6e67 2074 6865 7365 2073 7461 7465  ting these state
+0000cb40: 2074 7261 6e73 6974 696f 6e73 2061 7320   transitions as 
+0000cb50: 7765 6c6c 2e0a 2020 2020 2222 220a 0a20  well..    """.. 
+0000cb60: 2020 2062 616e 6477 6964 7468 3a20 696e     bandwidth: in
+0000cb70: 740a 0a20 2020 2023 3a20 436c 6965 6e74  t..    #: Client
+0000cb80: 7320 6375 7272 656e 746c 7920 636f 6e6e  s currently conn
+0000cb90: 6563 7465 6420 746f 2074 6865 2073 6368  ected to the sch
+0000cba0: 6564 756c 6572 0a20 2020 2063 6c69 656e  eduler.    clien
+0000cbb0: 7473 3a20 6469 6374 5b73 7472 2c20 436c  ts: dict[str, Cl
+0000cbc0: 6965 6e74 5374 6174 655d 0a0a 2020 2020  ientState]..    
+0000cbd0: 6578 7465 6e73 696f 6e73 3a20 6469 6374  extensions: dict
+0000cbe0: 5b73 7472 2c20 416e 795d 2020 2320 544f  [str, Any]  # TO
+0000cbf0: 444f 2077 7269 7465 2061 2073 6368 6564  DO write a sched
+0000cc00: 756c 6572 2065 7874 656e 7369 6f6e 2050  uler extension P
+0000cc10: 726f 746f 636f 6c0a 2020 2020 706c 7567  rotocol.    plug
+0000cc20: 696e 733a 2064 6963 745b 7374 722c 2053  ins: dict[str, S
+0000cc30: 6368 6564 756c 6572 506c 7567 696e 5d0a  chedulerPlugin].
+0000cc40: 2020 2020 686f 7374 5f69 6e66 6f3a 2064      host_info: d
+0000cc50: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
+0000cc60: 722c 2041 6e79 5d5d 0a0a 2020 2020 233a  r, Any]]..    #:
+0000cc70: 2049 6620 5472 7565 2c20 656e 6162 6c65   If True, enable
+0000cc80: 2065 7870 656e 7369 7665 2069 6e74 6572   expensive inter
+0000cc90: 6e61 6c20 636f 6e73 6973 7465 6e63 7920  nal consistency 
+0000cca0: 6368 6563 6b2e 0a20 2020 2023 3a20 5479  check..    #: Ty
+0000ccb0: 7069 6361 6c6c 7920 6469 7361 626c 6564  pically disabled
+0000ccc0: 2069 6e20 7072 6f64 7563 7469 6f6e 2e0a   in production..
+0000ccd0: 2020 2020 7661 6c69 6461 7465 3a20 626f      validate: bo
+0000cce0: 6f6c 0a0a 2020 2020 2323 2323 2323 2323  ol..    ########
+0000ccf0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000cd00: 2020 2020 2320 576f 726b 6572 732d 7265      # Workers-re
+0000cd10: 6c61 7465 6420 7374 6174 650a 2020 2020  lated state.    
+0000cd20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000cd30: 2323 2323 2323 230a 0a20 2020 2023 3a20  #######..    #: 
+0000cd40: 576f 726b 6572 7320 6375 7272 656e 746c  Workers currentl
+0000cd50: 7920 636f 6e6e 6563 7465 6420 746f 2074  y connected to t
+0000cd60: 6865 2073 6368 6564 756c 6572 0a20 2020  he scheduler.   
+0000cd70: 2023 3a20 2861 6374 7561 6c6c 7920 6120   #: (actually a 
+0000cd80: 536f 7274 6564 4469 6374 2c20 6275 7420  SortedDict, but 
+0000cd90: 7468 6520 736f 7274 6564 636f 6e74 6169  the sortedcontai
+0000cda0: 6e65 7273 2070 6163 6b61 6765 2069 736e  ners package isn
+0000cdb0: 2774 2061 6e6e 6f74 6174 6564 290a 2020  't annotated).  
+0000cdc0: 2020 776f 726b 6572 733a 2064 6963 745b    workers: dict[
+0000cdd0: 7374 722c 2057 6f72 6b65 7253 7461 7465  str, WorkerState
+0000cde0: 5d0a 2020 2020 233a 2057 6f72 6b65 7220  ].    #: Worker 
+0000cdf0: 7b6e 616d 653a 2061 6464 7265 7373 7d0a  {name: address}.
+0000ce00: 2020 2020 616c 6961 7365 733a 2064 6963      aliases: dic
+0000ce10: 745b 4861 7368 6162 6c65 2c20 7374 725d  t[Hashable, str]
+0000ce20: 0a20 2020 2023 3a20 576f 726b 6572 7320  .    #: Workers 
+0000ce30: 7468 6174 2061 7265 2063 7572 7265 6e74  that are current
+0000ce40: 6c79 2069 6e20 7275 6e6e 696e 6720 7374  ly in running st
+0000ce50: 6174 650a 2020 2020 7275 6e6e 696e 673a  ate.    running:
+0000ce60: 2073 6574 5b57 6f72 6b65 7253 7461 7465   set[WorkerState
+0000ce70: 5d0a 2020 2020 233a 2057 6f72 6b65 7273  ].    #: Workers
+0000ce80: 2074 6861 7420 6172 6520 6375 7272 656e   that are curren
+0000ce90: 746c 7920 696e 2072 756e 6e69 6e67 2073  tly in running s
+0000cea0: 7461 7465 2061 6e64 206e 6f74 2066 756c  tate and not ful
+0000ceb0: 6c79 2075 7469 6c69 7a65 640a 2020 2020  ly utilized.    
+0000cec0: 233a 2044 6566 696e 6974 696f 6e20 6261  #: Definition ba
+0000ced0: 7365 6420 6f6e 206f 6363 7570 616e 6379  sed on occupancy
+0000cee0: 0a20 2020 2023 3a20 2861 6374 7561 6c6c  .    #: (actuall
+0000cef0: 7920 6120 536f 7274 6564 4469 6374 2c20  y a SortedDict, 
+0000cf00: 6275 7420 7468 6520 736f 7274 6564 636f  but the sortedco
+0000cf10: 6e74 6169 6e65 7273 2070 6163 6b61 6765  ntainers package
+0000cf20: 2069 736e 2774 2061 6e6e 6f74 6174 6564   isn't annotated
+0000cf30: 290a 2020 2020 6964 6c65 3a20 6469 6374  ).    idle: dict
+0000cf40: 5b73 7472 2c20 576f 726b 6572 5374 6174  [str, WorkerStat
+0000cf50: 655d 0a20 2020 2023 3a20 5369 6d69 6c61  e].    #: Simila
+0000cf60: 7220 746f 2060 6964 6c65 600a 2020 2020  r to `idle`.    
+0000cf70: 233a 2044 6566 696e 6974 696f 6e20 6261  #: Definition ba
+0000cf80: 7365 6420 6f6e 2061 7373 6967 6e65 6420  sed on assigned 
+0000cf90: 7461 736b 730a 2020 2020 6964 6c65 5f74  tasks.    idle_t
+0000cfa0: 6173 6b5f 636f 756e 743a 2073 6574 5b57  ask_count: set[W
+0000cfb0: 6f72 6b65 7253 7461 7465 5d0a 2020 2020  orkerState].    
+0000cfc0: 233a 2057 6f72 6b65 7273 2074 6861 7420  #: Workers that 
+0000cfd0: 6172 6520 6675 6c6c 7920 7574 696c 697a  are fully utiliz
+0000cfe0: 6564 2e20 4d61 7920 696e 636c 7564 6520  ed. May include 
+0000cff0: 6e6f 6e2d 7275 6e6e 696e 6720 776f 726b  non-running work
+0000d000: 6572 732e 0a20 2020 2073 6174 7572 6174  ers..    saturat
+0000d010: 6564 3a20 7365 745b 576f 726b 6572 5374  ed: set[WorkerSt
+0000d020: 6174 655d 0a20 2020 2074 6f74 616c 5f6e  ate].    total_n
+0000d030: 7468 7265 6164 733a 2069 6e74 0a20 2020  threads: int.   
+0000d040: 2023 3a20 436c 7573 7465 722d 7769 6465   #: Cluster-wide
+0000d050: 2072 6573 6f75 7263 6573 2e20 7b72 6573   resources. {res
+0000d060: 6f75 7263 6520 6e61 6d65 3a20 7b77 6f72  ource name: {wor
+0000d070: 6b65 7220 6164 6472 6573 733a 2061 6d6f  ker address: amo
+0000d080: 756e 747d 7d0a 2020 2020 7265 736f 7572  unt}}.    resour
+0000d090: 6365 733a 2064 6963 745b 7374 722c 2064  ces: dict[str, d
+0000d0a0: 6963 745b 7374 722c 2066 6c6f 6174 5d5d  ict[str, float]]
+0000d0b0: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
+0000d0c0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+0000d0d0: 2320 5461 736b 732d 7265 6c61 7465 6420  # Tasks-related 
+0000d0e0: 7374 6174 650a 2020 2020 2323 2323 2323  state.    ######
+0000d0f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000d100: 0a20 2020 2023 3a20 546f 7461 6c20 6e75  .    #: Total nu
+0000d110: 6d62 6572 206f 6620 7461 736b 7320 6576  mber of tasks ev
+0000d120: 6572 2070 726f 6365 7373 6564 0a20 2020  er processed.   
+0000d130: 206e 5f74 6173 6b73 3a20 696e 740a 0a20   n_tasks: int.. 
+0000d140: 2020 2023 3a20 416c 6c20 7461 736b 7320     #: All tasks 
+0000d150: 6375 7272 656e 746c 7920 6b6e 6f77 6e20  currently known 
+0000d160: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
+0000d170: 0a20 2020 2074 6173 6b73 3a20 6469 6374  .    tasks: dict
+0000d180: 5b73 7472 2c20 5461 736b 5374 6174 655d  [str, TaskState]
+0000d190: 0a0a 2020 2020 233a 2054 6173 6b73 2069  ..    #: Tasks i
+0000d1a0: 6e20 7468 6520 2271 7565 7565 6422 2073  n the "queued" s
+0000d1b0: 7461 7465 2c20 6f72 6465 7265 6420 6279  tate, ordered by
+0000d1c0: 2070 7269 6f72 6974 790a 2020 2020 7175   priority.    qu
+0000d1d0: 6575 6564 3a20 4865 6170 5365 745b 5461  eued: HeapSet[Ta
+0000d1e0: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
+0000d1f0: 2054 6173 6b73 2069 6e20 7468 6520 226e   Tasks in the "n
+0000d200: 6f2d 776f 726b 6572 2220 7374 6174 650a  o-worker" state.
+0000d210: 2020 2020 756e 7275 6e6e 6162 6c65 3a20      unrunnable: 
+0000d220: 7365 745b 5461 736b 5374 6174 655d 0a0a  set[TaskState]..
+0000d230: 2020 2020 233a 2053 7562 7365 7420 6f66      #: Subset of
+0000d240: 2074 6173 6b73 2074 6861 7420 6578 6973   tasks that exis
+0000d250: 7420 696e 206d 656d 6f72 7920 6f6e 206d  t in memory on m
+0000d260: 6f72 6520 7468 616e 206f 6e65 2077 6f72  ore than one wor
+0000d270: 6b65 720a 2020 2020 7265 706c 6963 6174  ker.    replicat
+0000d280: 6564 5f74 6173 6b73 3a20 7365 745b 5461  ed_tasks: set[Ta
+0000d290: 736b 5374 6174 655d 0a0a 2020 2020 756e  skState]..    un
+0000d2a0: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 733a  known_durations:
+0000d2b0: 2064 6963 745b 7374 722c 2073 6574 5b54   dict[str, set[T
+0000d2c0: 6173 6b53 7461 7465 5d5d 0a20 2020 2074  askState]].    t
+0000d2d0: 6173 6b5f 6772 6f75 7073 3a20 6469 6374  ask_groups: dict
+0000d2e0: 5b73 7472 2c20 5461 736b 4772 6f75 705d  [str, TaskGroup]
+0000d2f0: 0a20 2020 2074 6173 6b5f 7072 6566 6978  .    task_prefix
+0000d300: 6573 3a20 6469 6374 5b73 7472 2c20 5461  es: dict[str, Ta
+0000d310: 736b 5072 6566 6978 5d0a 2020 2020 7461  skPrefix].    ta
+0000d320: 736b 5f6d 6574 6164 6174 613a 2064 6963  sk_metadata: dic
+0000d330: 745b 7374 722c 2041 6e79 5d0a 0a20 2020  t[str, Any]..   
+0000d340: 2023 2323 2323 2323 2323 0a20 2020 2023   #########.    #
+0000d350: 2048 6973 746f 7279 0a20 2020 2023 2323   History.    ###
+0000d360: 2323 2323 2323 0a0a 2020 2020 233a 2048  ######..    #: H
+0000d370: 6973 746f 7279 206f 6620 636f 6d70 7574  istory of comput
+0000d380: 6174 696f 6e73 2e0a 2020 2020 233a 2054  ations..    #: T
+0000d390: 6865 206c 656e 6774 6820 6361 6e20 6265  he length can be
+0000d3a0: 2074 7765 616b 6564 2074 6872 6f75 6768   tweaked through
+0000d3b0: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
+0000d3c0: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
+0000d3d0: 636f 6d70 7574 6174 696f 6e73 2e6d 6178  computations.max
+0000d3e0: 2d68 6973 746f 7279 0a20 2020 2063 6f6d  -history.    com
+0000d3f0: 7075 7461 7469 6f6e 733a 2064 6571 7565  putations: deque
+0000d400: 5b43 6f6d 7075 7461 7469 6f6e 5d0a 0a20  [Computation].. 
+0000d410: 2020 2023 3a20 4869 7374 6f72 7920 6f66     #: History of
+0000d420: 2065 7272 6564 2074 6173 6b73 2e0a 2020   erred tasks..  
+0000d430: 2020 233a 2054 6865 206c 656e 6774 6820    #: The length 
+0000d440: 6361 6e20 6265 2074 7765 616b 6564 2074  can be tweaked t
+0000d450: 6872 6f75 6768 0a20 2020 2023 3a20 6469  hrough.    #: di
+0000d460: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
+0000d470: 7374 6963 732e 6572 7265 642d 7461 736b  stics.erred-task
+0000d480: 732e 6d61 782d 6869 7374 6f72 790a 2020  s.max-history.  
+0000d490: 2020 6572 7265 645f 7461 736b 733a 2064    erred_tasks: d
+0000d4a0: 6571 7565 5b45 7272 6564 5461 736b 5d0a  eque[ErredTask].
+0000d4b0: 0a20 2020 2023 3a20 4869 7374 6f72 7920  .    #: History 
+0000d4c0: 6f66 2074 6173 6b20 7374 6174 6520 7472  of task state tr
+0000d4d0: 616e 7369 7469 6f6e 732e 0a20 2020 2023  ansitions..    #
+0000d4e0: 3a20 5468 6520 6c65 6e67 7468 2063 616e  : The length can
+0000d4f0: 2062 6520 7477 6561 6b65 6420 7468 726f   be tweaked thro
+0000d500: 7567 680a 2020 2020 233a 2064 6973 7472  ugh.    #: distr
+0000d510: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0000d520: 2e74 7261 6e73 6974 696f 6e2d 6c6f 672d  .transition-log-
+0000d530: 6c65 6e67 7468 0a20 2020 2074 7261 6e73  length.    trans
+0000d540: 6974 696f 6e5f 6c6f 673a 2064 6571 7565  ition_log: deque
+0000d550: 5b54 7261 6e73 6974 696f 6e5d 0a0a 2020  [Transition]..  
+0000d560: 2020 233a 2054 6f74 616c 206e 756d 6265    #: Total numbe
+0000d570: 7220 6f66 2074 7261 6e73 6974 696f 6e73  r of transitions
+0000d580: 2073 696e 6365 2074 6865 2063 6c75 7374   since the clust
+0000d590: 6572 2077 6173 2073 7461 7274 6564 0a20  er was started. 
+0000d5a0: 2020 2074 7261 6e73 6974 696f 6e5f 636f     transition_co
+0000d5b0: 756e 7465 723a 2069 6e74 0a0a 2020 2020  unter: int..    
+0000d5c0: 233a 2054 6f74 616c 206e 756d 6265 7220  #: Total number 
+0000d5d0: 6f66 2074 7261 6e73 6974 696f 6e73 2061  of transitions a
+0000d5e0: 7320 6f66 2074 6865 2070 7265 7669 6f75  s of the previou
+0000d5f0: 7320 6361 6c6c 2074 6f20 6368 6563 6b5f  s call to check_
+0000d600: 6964 6c65 2829 0a20 2020 205f 6964 6c65  idle().    _idle
+0000d610: 5f74 7261 6e73 6974 696f 6e5f 636f 756e  _transition_coun
+0000d620: 7465 723a 2069 6e74 0a0a 2020 2020 233a  ter: int..    #:
+0000d630: 2052 6169 7365 2061 6e20 6572 726f 7220   Raise an error 
+0000d640: 6966 2074 6865 203a 6174 7472 3a60 7472  if the :attr:`tr
+0000d650: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+0000d660: 6020 6576 6572 2072 6561 6368 6573 2074  ` ever reaches t
+0000d670: 6869 7320 7661 6c75 652e 0a20 2020 2023  his value..    #
+0000d680: 3a20 5468 6973 2069 7320 6d65 616e 7420  : This is meant 
+0000d690: 666f 7220 6465 6275 6767 696e 6720 6f6e  for debugging on
+0000d6a0: 6c79 2c20 746f 2063 6174 6368 2069 6e66  ly, to catch inf
+0000d6b0: 696e 6974 6520 7265 6375 7273 696f 6e20  inite recursion 
+0000d6c0: 6c6f 6f70 732e 0a20 2020 2023 3a20 496e  loops..    #: In
+0000d6d0: 2070 726f 6475 6374 696f 6e2c 2069 7420   production, it 
+0000d6e0: 7368 6f75 6c64 2061 6c77 6179 7320 6265  should always be
+0000d6f0: 2073 6574 2074 6f20 4661 6c73 652e 0a20   set to False.. 
+0000d700: 2020 2074 7261 6e73 6974 696f 6e5f 636f     transition_co
+0000d710: 756e 7465 725f 6d61 783a 2069 6e74 207c  unter_max: int |
+0000d720: 204c 6974 6572 616c 5b46 616c 7365 5d0a   Literal[False].
+0000d730: 0a20 2020 205f 7461 736b 5f70 7265 6669  .    _task_prefi
+0000d740: 785f 636f 756e 745f 676c 6f62 616c 3a20  x_count_global: 
+0000d750: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
+0000d760: 2069 6e74 5d0a 2020 2020 5f6e 6574 776f   int].    _netwo
+0000d770: 726b 5f6f 6363 5f67 6c6f 6261 6c3a 2066  rk_occ_global: f
+0000d780: 6c6f 6174 0a20 2020 2023 2323 2323 2323  loat.    #######
+0000d790: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000d7a0: 2020 2020 2320 4361 6368 6564 2063 6f6e      # Cached con
+0000d7b0: 6669 6775 7261 7469 6f6e 0a20 2020 2023  figuration.    #
+0000d7c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d7d0: 2323 2323 230a 0a20 2020 2023 3a20 6469  #####..    #: di
+0000d7e0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+0000d7f0: 6c65 722e 756e 6b6e 6f77 6e2d 7461 736b  ler.unknown-task
+0000d800: 2d64 7572 6174 696f 6e0a 2020 2020 554e  -duration.    UN
+0000d810: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
+0000d820: 494f 4e3a 2066 6c6f 6174 0a20 2020 2023  ION: float.    #
+0000d830: 3a20 6469 7374 7269 6275 7465 642e 776f  : distributed.wo
+0000d840: 726b 6572 2e6d 656d 6f72 792e 7265 6365  rker.memory.rece
+0000d850: 6e74 2d74 6f2d 6f6c 642d 7469 6d65 0a20  nt-to-old-time. 
+0000d860: 2020 204d 454d 4f52 595f 5245 4345 4e54     MEMORY_RECENT
+0000d870: 5f54 4f5f 4f4c 445f 5449 4d45 3a20 666c  _TO_OLD_TIME: fl
+0000d880: 6f61 740a 2020 2020 233a 2064 6973 7472  oat.    #: distr
+0000d890: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+0000d8a0: 6d6f 7279 2e72 6562 616c 616e 6365 2e6d  mory.rebalance.m
+0000d8b0: 6561 7375 7265 0a20 2020 204d 454d 4f52  easure.    MEMOR
+0000d8c0: 595f 5245 4241 4c41 4e43 455f 4d45 4153  Y_REBALANCE_MEAS
+0000d8d0: 5552 453a 2073 7472 0a20 2020 2023 3a20  URE: str.    #: 
+0000d8e0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+0000d8f0: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
+0000d900: 6e63 652e 7365 6e64 6572 2d6d 696e 0a20  nce.sender-min. 
+0000d910: 2020 204d 454d 4f52 595f 5245 4241 4c41     MEMORY_REBALA
+0000d920: 4e43 455f 5345 4e44 4552 5f4d 494e 3a20  NCE_SENDER_MIN: 
+0000d930: 666c 6f61 740a 2020 2020 233a 2064 6973  float.    #: dis
+0000d940: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0000d950: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+0000d960: 2e72 6563 6970 6965 6e74 2d6d 6178 0a20  .recipient-max. 
+0000d970: 2020 204d 454d 4f52 595f 5245 4241 4c41     MEMORY_REBALA
+0000d980: 4e43 455f 5245 4349 5049 454e 545f 4d41  NCE_RECIPIENT_MA
+0000d990: 583a 2066 6c6f 6174 0a20 2020 2023 3a20  X: float.    #: 
+0000d9a0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+0000d9b0: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
+0000d9c0: 6e63 652e 7365 6e64 6572 2d72 6563 6970  nce.sender-recip
+0000d9d0: 6965 6e74 2d67 6170 202f 2032 0a20 2020  ient-gap / 2.   
+0000d9e0: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
+0000d9f0: 455f 4841 4c46 5f47 4150 3a20 666c 6f61  E_HALF_GAP: floa
+0000da00: 740a 2020 2020 233a 2064 6973 7472 6962  t.    #: distrib
+0000da10: 7574 6564 2e73 6368 6564 756c 6572 2e77  uted.scheduler.w
+0000da20: 6f72 6b65 722d 7361 7475 7261 7469 6f6e  orker-saturation
+0000da30: 0a20 2020 2057 4f52 4b45 525f 5341 5455  .    WORKER_SATU
+0000da40: 5241 5449 4f4e 3a20 666c 6f61 740a 0a20  RATION: float.. 
+0000da50: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
+0000da60: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
+0000da70: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
+0000da80: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
+0000da90: 2073 656c 662c 0a20 2020 2020 2020 2061   self,.        a
+0000daa0: 6c69 6173 6573 3a20 6469 6374 5b48 6173  liases: dict[Has
+0000dab0: 6861 626c 652c 2073 7472 5d2c 0a20 2020  hable, str],.   
+0000dac0: 2020 2020 2063 6c69 656e 7473 3a20 6469       clients: di
+0000dad0: 6374 5b73 7472 2c20 436c 6965 6e74 5374  ct[str, ClientSt
+0000dae0: 6174 655d 2c0a 2020 2020 2020 2020 776f  ate],.        wo
+0000daf0: 726b 6572 733a 2053 6f72 7465 6444 6963  rkers: SortedDic
+0000db00: 745b 7374 722c 2057 6f72 6b65 7253 7461  t[str, WorkerSta
+0000db10: 7465 5d2c 0a20 2020 2020 2020 2068 6f73  te],.        hos
+0000db20: 745f 696e 666f 3a20 6469 6374 5b73 7472  t_info: dict[str
+0000db30: 2c20 6469 6374 5b73 7472 2c20 416e 795d  , dict[str, Any]
+0000db40: 5d2c 0a20 2020 2020 2020 2072 6573 6f75  ],.        resou
+0000db50: 7263 6573 3a20 6469 6374 5b73 7472 2c20  rces: dict[str, 
+0000db60: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
+0000db70: 5d2c 0a20 2020 2020 2020 2074 6173 6b73  ],.        tasks
+0000db80: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
+0000db90: 5374 6174 655d 2c0a 2020 2020 2020 2020  State],.        
+0000dba0: 756e 7275 6e6e 6162 6c65 3a20 7365 745b  unrunnable: set[
+0000dbb0: 5461 736b 5374 6174 655d 2c0a 2020 2020  TaskState],.    
+0000dbc0: 2020 2020 7175 6575 6564 3a20 4865 6170      queued: Heap
+0000dbd0: 5365 745b 5461 736b 5374 6174 655d 2c0a  Set[TaskState],.
+0000dbe0: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+0000dbf0: 3a20 626f 6f6c 2c0a 2020 2020 2020 2020  : bool,.        
+0000dc00: 706c 7567 696e 733a 2049 7465 7261 626c  plugins: Iterabl
+0000dc10: 655b 5363 6865 6475 6c65 7250 6c75 6769  e[SchedulerPlugi
+0000dc20: 6e5d 203d 2028 292c 0a20 2020 2020 2020  n] = (),.       
+0000dc30: 2074 7261 6e73 6974 696f 6e5f 636f 756e   transition_coun
+0000dc40: 7465 725f 6d61 783a 2069 6e74 207c 204c  ter_max: int | L
+0000dc50: 6974 6572 616c 5b46 616c 7365 5d20 3d20  iteral[False] = 
+0000dc60: 4661 6c73 652c 0a20 2020 2020 2020 202a  False,.        *
+0000dc70: 2a6b 7761 7267 733a 2041 6e79 2c20 2023  *kwargs: Any,  #
+0000dc80: 2050 6173 7365 6420 7665 7262 6174 696d   Passed verbatim
+0000dc90: 2074 6f20 5365 7276 6572 2e5f 5f69 6e69   to Server.__ini
+0000dca0: 745f 5f28 290a 2020 2020 293a 0a20 2020  t__().    ):.   
+0000dcb0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0000dcc0: 2822 5374 6174 6520 7374 6172 7422 290a  ("State start").
+0000dcd0: 2020 2020 2020 2020 7365 6c66 2e61 6c69          self.ali
+0000dce0: 6173 6573 203d 2061 6c69 6173 6573 0a20  ases = aliases. 
+0000dcf0: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
+0000dd00: 7769 6474 6820 3d20 7061 7273 655f 6279  width = parse_by
+0000dd10: 7465 7328 6461 736b 2e63 6f6e 6669 672e  tes(dask.config.
+0000dd20: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+0000dd30: 2e73 6368 6564 756c 6572 2e62 616e 6477  .scheduler.bandw
+0000dd40: 6964 7468 2229 290a 2020 2020 2020 2020  idth")).        
+0000dd50: 7365 6c66 2e63 6c69 656e 7473 203d 2063  self.clients = c
+0000dd60: 6c69 656e 7473 0a20 2020 2020 2020 2073  lients.        s
+0000dd70: 656c 662e 636c 6965 6e74 735b 2266 6972  elf.clients["fir
+0000dd80: 652d 616e 642d 666f 7267 6574 225d 203d  e-and-forget"] =
+0000dd90: 2043 6c69 656e 7453 7461 7465 2822 6669   ClientState("fi
+0000dda0: 7265 2d61 6e64 2d66 6f72 6765 7422 290a  re-and-forget").
+0000ddb0: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
+0000ddc0: 656e 7369 6f6e 7320 3d20 7b7d 0a20 2020  ensions = {}.   
+0000ddd0: 2020 2020 2073 656c 662e 686f 7374 5f69       self.host_i
+0000dde0: 6e66 6f20 3d20 686f 7374 5f69 6e66 6f0a  nfo = host_info.
+0000ddf0: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
+0000de00: 6520 3d20 536f 7274 6564 4469 6374 2829  e = SortedDict()
+0000de10: 0a20 2020 2020 2020 2073 656c 662e 6964  .        self.id
+0000de20: 6c65 5f74 6173 6b5f 636f 756e 7420 3d20  le_task_count = 
+0000de30: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
+0000de40: 6c66 2e6e 5f74 6173 6b73 203d 2030 0a20  lf.n_tasks = 0. 
+0000de50: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
+0000de60: 7572 6365 7320 3d20 7265 736f 7572 6365  urces = resource
+0000de70: 730a 2020 2020 2020 2020 7365 6c66 2e73  s.        self.s
+0000de80: 6174 7572 6174 6564 203d 2073 6574 2829  aturated = set()
+0000de90: 0a20 2020 2020 2020 2073 656c 662e 7461  .        self.ta
+0000dea0: 736b 7320 3d20 7461 736b 730a 2020 2020  sks = tasks.    
+0000deb0: 2020 2020 7365 6c66 2e72 6570 6c69 6361      self.replica
+0000dec0: 7465 645f 7461 736b 7320 3d20 7b0a 2020  ted_tasks = {.  
+0000ded0: 2020 2020 2020 2020 2020 7473 2066 6f72            ts for
+0000dee0: 2074 7320 696e 2073 656c 662e 7461 736b   ts in self.task
+0000def0: 732e 7661 6c75 6573 2829 2069 6620 6c65  s.values() if le
+0000df00: 6e28 7473 2e77 686f 5f68 6173 2920 3e20  n(ts.who_has) > 
+0000df10: 310a 2020 2020 2020 2020 7d0a 2020 2020  1.        }.    
+0000df20: 2020 2020 7365 6c66 2e63 6f6d 7075 7461      self.computa
+0000df30: 7469 6f6e 7320 3d20 6465 7175 6528 0a20  tions = deque(. 
+0000df40: 2020 2020 2020 2020 2020 206d 6178 6c65             maxle
+0000df50: 6e3d 6461 736b 2e63 6f6e 6669 672e 6765  n=dask.config.ge
+0000df60: 7428 2264 6973 7472 6962 7574 6564 2e64  t("distributed.d
+0000df70: 6961 676e 6f73 7469 6373 2e63 6f6d 7075  iagnostics.compu
+0000df80: 7461 7469 6f6e 732e 6d61 782d 6869 7374  tations.max-hist
+0000df90: 6f72 7922 290a 2020 2020 2020 2020 290a  ory").        ).
+0000dfa0: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
+0000dfb0: 6564 5f74 6173 6b73 203d 2064 6571 7565  ed_tasks = deque
+0000dfc0: 280a 2020 2020 2020 2020 2020 2020 6d61  (.            ma
+0000dfd0: 786c 656e 3d64 6173 6b2e 636f 6e66 6967  xlen=dask.config
+0000dfe0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0000dff0: 642e 6469 6167 6e6f 7374 6963 732e 6572  d.diagnostics.er
+0000e000: 7265 642d 7461 736b 732e 6d61 782d 6869  red-tasks.max-hi
+0000e010: 7374 6f72 7922 290a 2020 2020 2020 2020  story").        
+0000e020: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
+0000e030: 6173 6b5f 6772 6f75 7073 203d 207b 7d0a  ask_groups = {}.
+0000e040: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0000e050: 6b5f 7072 6566 6978 6573 203d 207b 7d0a  k_prefixes = {}.
+0000e060: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0000e070: 6b5f 6d65 7461 6461 7461 203d 207b 7d0a  k_metadata = {}.
+0000e080: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+0000e090: 616c 5f6e 7468 7265 6164 7320 3d20 300a  al_nthreads = 0.
+0000e0a0: 2020 2020 2020 2020 7365 6c66 2e75 6e6b          self.unk
+0000e0b0: 6e6f 776e 5f64 7572 6174 696f 6e73 203d  nown_durations =
+0000e0c0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+0000e0d0: 2e71 7565 7565 6420 3d20 7175 6575 6564  .queued = queued
+0000e0e0: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
+0000e0f0: 7275 6e6e 6162 6c65 203d 2075 6e72 756e  runnable = unrun
+0000e100: 6e61 626c 650a 2020 2020 2020 2020 7365  nable.        se
+0000e110: 6c66 2e76 616c 6964 6174 6520 3d20 7661  lf.validate = va
+0000e120: 6c69 6461 7465 0a20 2020 2020 2020 2073  lidate.        s
+0000e130: 656c 662e 776f 726b 6572 7320 3d20 776f  elf.workers = wo
+0000e140: 726b 6572 730a 2020 2020 2020 2020 7365  rkers.        se
+0000e150: 6c66 2e5f 7461 736b 5f70 7265 6669 785f  lf._task_prefix_
+0000e160: 636f 756e 745f 676c 6f62 616c 203d 2064  count_global = d
+0000e170: 6566 6175 6c74 6469 6374 2869 6e74 290a  efaultdict(int).
+0000e180: 2020 2020 2020 2020 7365 6c66 2e5f 6e65          self._ne
+0000e190: 7477 6f72 6b5f 6f63 635f 676c 6f62 616c  twork_occ_global
+0000e1a0: 203d 2030 2e30 0a20 2020 2020 2020 2073   = 0.0.        s
+0000e1b0: 656c 662e 7275 6e6e 696e 6720 3d20 7b0a  elf.running = {.
+0000e1c0: 2020 2020 2020 2020 2020 2020 7773 2066              ws f
+0000e1d0: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
+0000e1e0: 726b 6572 732e 7661 6c75 6573 2829 2069  rkers.values() i
+0000e1f0: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
+0000e200: 7461 7475 732e 7275 6e6e 696e 670a 2020  tatus.running.  
+0000e210: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0000e220: 7365 6c66 2e70 6c75 6769 6e73 203d 207b  self.plugins = {
+0000e230: 7d20 6966 206e 6f74 2070 6c75 6769 6e73  } if not plugins
+0000e240: 2065 6c73 6520 7b5f 6765 745f 706c 7567   else {_get_plug
+0000e250: 696e 5f6e 616d 6528 7029 3a20 7020 666f  in_name(p): p fo
+0000e260: 7220 7020 696e 2070 6c75 6769 6e73 7d0a  r p in plugins}.
+0000e270: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
+0000e280: 616e 7369 7469 6f6e 5f6c 6f67 203d 2064  ansition_log = d
+0000e290: 6571 7565 280a 2020 2020 2020 2020 2020  eque(.          
+0000e2a0: 2020 6d61 786c 656e 3d64 6173 6b2e 636f    maxlen=dask.co
+0000e2b0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+0000e2c0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0000e2d0: 7472 616e 7369 7469 6f6e 2d6c 6f67 2d6c  transition-log-l
+0000e2e0: 656e 6774 6822 290a 2020 2020 2020 2020  ength").        
+0000e2f0: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
+0000e300: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
+0000e310: 7220 3d20 300a 2020 2020 2020 2020 7365  r = 0.        se
+0000e320: 6c66 2e5f 6964 6c65 5f74 7261 6e73 6974  lf._idle_transit
+0000e330: 696f 6e5f 636f 756e 7465 7220 3d20 300a  ion_counter = 0.
+0000e340: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
+0000e350: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
+0000e360: 6d61 7820 3d20 7472 616e 7369 7469 6f6e  max = transition
+0000e370: 5f63 6f75 6e74 6572 5f6d 6178 0a0a 2020  _counter_max..  
+0000e380: 2020 2020 2020 2320 5661 7269 6162 6c65        # Variable
+0000e390: 7320 6672 6f6d 2064 6173 6b2e 636f 6e66  s from dask.conf
+0000e3a0: 6967 2c20 6361 6368 6564 2062 7920 5f5f  ig, cached by __
+0000e3b0: 696e 6974 5f5f 2066 6f72 2070 6572 666f  init__ for perfo
+0000e3c0: 726d 616e 6365 0a20 2020 2020 2020 2073  rmance.        s
+0000e3d0: 656c 662e 554e 4b4e 4f57 4e5f 5441 534b  elf.UNKNOWN_TASK
+0000e3e0: 5f44 5552 4154 494f 4e20 3d20 7061 7273  _DURATION = pars
+0000e3f0: 655f 7469 6d65 6465 6c74 6128 0a20 2020  e_timedelta(.   
+0000e400: 2020 2020 2020 2020 2064 6173 6b2e 636f           dask.co
+0000e410: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+0000e420: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0000e430: 756e 6b6e 6f77 6e2d 7461 736b 2d64 7572  unknown-task-dur
+0000e440: 6174 696f 6e22 290a 2020 2020 2020 2020  ation").        
+0000e450: 290a 2020 2020 2020 2020 7365 6c66 2e4d  ).        self.M
+0000e460: 454d 4f52 595f 5245 4345 4e54 5f54 4f5f  EMORY_RECENT_TO_
+0000e470: 4f4c 445f 5449 4d45 203d 2070 6172 7365  OLD_TIME = parse
+0000e480: 5f74 696d 6564 656c 7461 280a 2020 2020  _timedelta(.    
+0000e490: 2020 2020 2020 2020 6461 736b 2e63 6f6e          dask.con
+0000e4a0: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0000e4b0: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
+0000e4c0: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
+0000e4d0: 2d74 696d 6522 290a 2020 2020 2020 2020  -time").        
+0000e4e0: 290a 2020 2020 2020 2020 7365 6c66 2e4d  ).        self.M
+0000e4f0: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
+0000e500: 4d45 4153 5552 4520 3d20 6461 736b 2e63  MEASURE = dask.c
+0000e510: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
+0000e520: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
+0000e530: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0000e540: 792e 7265 6261 6c61 6e63 652e 6d65 6173  y.rebalance.meas
+0000e550: 7572 6522 0a20 2020 2020 2020 2029 0a20  ure".        ). 
+0000e560: 2020 2020 2020 2073 656c 662e 4d45 4d4f         self.MEMO
+0000e570: 5259 5f52 4542 414c 414e 4345 5f53 454e  RY_REBALANCE_SEN
+0000e580: 4445 525f 4d49 4e20 3d20 6461 736b 2e63  DER_MIN = dask.c
+0000e590: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
+0000e5a0: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
+0000e5b0: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0000e5c0: 792e 7265 6261 6c61 6e63 652e 7365 6e64  y.rebalance.send
+0000e5d0: 6572 2d6d 696e 220a 2020 2020 2020 2020  er-min".        
+0000e5e0: 290a 2020 2020 2020 2020 7365 6c66 2e4d  ).        self.M
+0000e5f0: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
+0000e600: 5245 4349 5049 454e 545f 4d41 5820 3d20  RECIPIENT_MAX = 
+0000e610: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+0000e620: 0a20 2020 2020 2020 2020 2020 2022 6469  .            "di
+0000e630: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
+0000e640: 2e6d 656d 6f72 792e 7265 6261 6c61 6e63  .memory.rebalanc
+0000e650: 652e 7265 6369 7069 656e 742d 6d61 7822  e.recipient-max"
+0000e660: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000e670: 2020 2073 656c 662e 4d45 4d4f 5259 5f52     self.MEMORY_R
+0000e680: 4542 414c 414e 4345 5f48 414c 465f 4741  EBALANCE_HALF_GA
+0000e690: 5020 3d20 280a 2020 2020 2020 2020 2020  P = (.          
+0000e6a0: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
+0000e6b0: 7428 2264 6973 7472 6962 7574 6564 2e77  t("distributed.w
+0000e6c0: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6562  orker.memory.reb
+0000e6d0: 616c 616e 6365 2e73 656e 6465 722d 7265  alance.sender-re
+0000e6e0: 6369 7069 656e 742d 6761 7022 290a 2020  cipient-gap").  
+0000e6f0: 2020 2020 2020 2020 2020 2f20 322e 300a            / 2.0.
+0000e700: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000e710: 2020 2073 656c 662e 574f 524b 4552 5f53     self.WORKER_S
+0000e720: 4154 5552 4154 494f 4e20 3d20 6461 736b  ATURATION = dask
+0000e730: 2e63 6f6e 6669 672e 6765 7428 0a20 2020  .config.get(.   
+0000e740: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
+0000e750: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0000e760: 776f 726b 6572 2d73 6174 7572 6174 696f  worker-saturatio
+0000e770: 6e22 0a20 2020 2020 2020 2029 0a20 2020  n".        ).   
+0000e780: 2020 2020 2069 6620 7365 6c66 2e57 4f52       if self.WOR
+0000e790: 4b45 525f 5341 5455 5241 5449 4f4e 203d  KER_SATURATION =
+0000e7a0: 3d20 2269 6e66 223a 0a20 2020 2020 2020  = "inf":.       
+0000e7b0: 2020 2020 2023 2053 7065 6369 616c 2063       # Special c
+0000e7c0: 6173 6520 6e65 6365 7373 6172 7920 6265  ase necessary be
+0000e7d0: 6361 7573 6520 7468 6572 6527 7320 6e6f  cause there's no
+0000e7e0: 2077 6179 2074 6f20 7061 7273 6520 6120   way to parse a 
+0000e7f0: 666c 6f61 7420 696e 6669 6e69 7479 0a20  float infinity. 
+0000e800: 2020 2020 2020 2020 2020 2023 2066 726f             # fro
+0000e810: 6d20 6120 4441 534b 5f2a 2065 6e76 6972  m a DASK_* envir
+0000e820: 6f6e 6d65 6e74 2076 6172 6961 626c 650a  onment variable.
+0000e830: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000e840: 2e57 4f52 4b45 525f 5341 5455 5241 5449  .WORKER_SATURATI
+0000e850: 4f4e 203d 206d 6174 682e 696e 660a 2020  ON = math.inf.  
+0000e860: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
+0000e870: 2020 2020 2020 206e 6f74 2069 7369 6e73         not isins
+0000e880: 7461 6e63 6528 7365 6c66 2e57 4f52 4b45  tance(self.WORKE
+0000e890: 525f 5341 5455 5241 5449 4f4e 2c20 2869  R_SATURATION, (i
+0000e8a0: 6e74 2c20 666c 6f61 7429 290a 2020 2020  nt, float)).    
+0000e8b0: 2020 2020 2020 2020 6f72 2073 656c 662e          or self.
+0000e8c0: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
+0000e8d0: 4e20 3c3d 2030 0a20 2020 2020 2020 2029  N <= 0.        )
+0000e8e0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000e8f0: 6973 6520 5661 6c75 6545 7272 6f72 2820  ise ValueError( 
+0000e900: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
+0000e910: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+0000e920: 2020 2022 6064 6973 7472 6962 7574 6564     "`distributed
+0000e930: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+0000e940: 722d 7361 7475 7261 7469 6f6e 6020 6d75  r-saturation` mu
+0000e950: 7374 2062 6520 6120 666c 6f61 7420 3e20  st be a float > 
+0000e960: 303b 2067 6f74 2022 0a20 2020 2020 2020  0; got ".       
+0000e970: 2020 2020 2020 2020 202b 2072 6570 7228           + repr(
+0000e980: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+0000e990: 5241 5449 4f4e 290a 2020 2020 2020 2020  RATION).        
+0000e9a0: 2020 2020 290a 0a20 2020 2040 7072 6f70      )..    @prop
+0000e9b0: 6572 7479 0a20 2020 2064 6566 206d 656d  erty.    def mem
+0000e9c0: 6f72 7928 7365 6c66 2920 2d3e 204d 656d  ory(self) -> Mem
+0000e9d0: 6f72 7953 7461 7465 3a0a 2020 2020 2020  oryState:.      
+0000e9e0: 2020 7265 7475 726e 204d 656d 6f72 7953    return MemoryS
+0000e9f0: 7461 7465 2e73 756d 282a 2877 2e6d 656d  tate.sum(*(w.mem
+0000ea00: 6f72 7920 666f 7220 7720 696e 2073 656c  ory for w in sel
+0000ea10: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
+0000ea20: 2829 2929 0a0a 2020 2020 4070 726f 7065  ()))..    @prope
+0000ea30: 7274 790a 2020 2020 6465 6620 5f5f 7064  rty.    def __pd
+0000ea40: 6963 745f 5f28 7365 6c66 2920 2d3e 2064  ict__(self) -> d
+0000ea50: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+0000ea60: 2020 2020 2020 2072 6574 7572 6e20 7b0a         return {.
+0000ea70: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
+0000ea80: 6477 6964 7468 223a 2073 656c 662e 6261  dwidth": self.ba
+0000ea90: 6e64 7769 6474 682c 0a20 2020 2020 2020  ndwidth,.       
+0000eaa0: 2020 2020 2022 7265 736f 7572 6365 7322       "resources"
+0000eab0: 3a20 7365 6c66 2e72 6573 6f75 7263 6573  : self.resources
+0000eac0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0000ead0: 6174 7572 6174 6564 223a 2073 656c 662e  aturated": self.
+0000eae0: 7361 7475 7261 7465 642c 0a20 2020 2020  saturated,.     
+0000eaf0: 2020 2020 2020 2022 756e 7275 6e6e 6162         "unrunnab
+0000eb00: 6c65 223a 2073 656c 662e 756e 7275 6e6e  le": self.unrunn
+0000eb10: 6162 6c65 2c0a 2020 2020 2020 2020 2020  able,.          
+0000eb20: 2020 2271 7565 7565 6422 3a20 7365 6c66    "queued": self
+0000eb30: 2e71 7565 7565 642c 0a20 2020 2020 2020  .queued,.       
+0000eb40: 2020 2020 2022 6e5f 7461 736b 7322 3a20       "n_tasks": 
+0000eb50: 7365 6c66 2e6e 5f74 6173 6b73 2c0a 2020  self.n_tasks,.  
+0000eb60: 2020 2020 2020 2020 2020 2275 6e6b 6e6f            "unkno
+0000eb70: 776e 5f64 7572 6174 696f 6e73 223a 2073  wn_durations": s
+0000eb80: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
+0000eb90: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0000eba0: 2020 2022 7661 6c69 6461 7465 223a 2073     "validate": s
+0000ebb0: 656c 662e 7661 6c69 6461 7465 2c0a 2020  elf.validate,.  
+0000ebc0: 2020 2020 2020 2020 2020 2274 6173 6b73            "tasks
+0000ebd0: 223a 2073 656c 662e 7461 736b 732c 0a20  ": self.tasks,. 
+0000ebe0: 2020 2020 2020 2020 2020 2022 7461 736b             "task
+0000ebf0: 5f67 726f 7570 7322 3a20 7365 6c66 2e74  _groups": self.t
+0000ec00: 6173 6b5f 6772 6f75 7073 2c0a 2020 2020  ask_groups,.    
+0000ec10: 2020 2020 2020 2020 2274 6173 6b5f 7072          "task_pr
+0000ec20: 6566 6978 6573 223a 2073 656c 662e 7461  efixes": self.ta
+0000ec30: 736b 5f70 7265 6669 7865 732c 0a20 2020  sk_prefixes,.   
+0000ec40: 2020 2020 2020 2020 2022 746f 7461 6c5f           "total_
+0000ec50: 6e74 6872 6561 6473 223a 2073 656c 662e  nthreads": self.
+0000ec60: 746f 7461 6c5f 6e74 6872 6561 6473 2c0a  total_nthreads,.
+0000ec70: 2020 2020 2020 2020 2020 2020 2274 6f74              "tot
+0000ec80: 616c 5f6f 6363 7570 616e 6379 223a 2073  al_occupancy": s
+0000ec90: 656c 662e 746f 7461 6c5f 6f63 6375 7061  elf.total_occupa
+0000eca0: 6e63 792c 0a20 2020 2020 2020 2020 2020  ncy,.           
+0000ecb0: 2022 6572 7265 645f 7461 736b 7322 3a20   "erred_tasks": 
+0000ecc0: 7365 6c66 2e65 7272 6564 5f74 6173 6b73  self.erred_tasks
+0000ecd0: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
+0000ece0: 7874 656e 7369 6f6e 7322 3a20 7365 6c66  xtensions": self
+0000ecf0: 2e65 7874 656e 7369 6f6e 732c 0a20 2020  .extensions,.   
+0000ed00: 2020 2020 2020 2020 2022 636c 6965 6e74           "client
+0000ed10: 7322 3a20 7365 6c66 2e63 6c69 656e 7473  s": self.clients
+0000ed20: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+0000ed30: 6f72 6b65 7273 223a 2073 656c 662e 776f  orkers": self.wo
+0000ed40: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
+0000ed50: 2020 2022 6964 6c65 223a 2073 656c 662e     "idle": self.
+0000ed60: 6964 6c65 2c0a 2020 2020 2020 2020 2020  idle,.          
+0000ed70: 2020 2268 6f73 745f 696e 666f 223a 2073    "host_info": s
+0000ed80: 656c 662e 686f 7374 5f69 6e66 6f2c 0a20  elf.host_info,. 
+0000ed90: 2020 2020 2020 207d 0a0a 2020 2020 6465         }..    de
+0000eda0: 6620 6e65 775f 7461 736b 280a 2020 2020  f new_task(.    
+0000edb0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0000edc0: 2020 6b65 793a 2073 7472 2c0a 2020 2020    key: str,.    
+0000edd0: 2020 2020 7370 6563 3a20 6f62 6a65 6374      spec: object
+0000ede0: 2c0a 2020 2020 2020 2020 7374 6174 653a  ,.        state:
+0000edf0: 2054 6173 6b53 7461 7465 5374 6174 652c   TaskStateState,
+0000ee00: 0a20 2020 2020 2020 2063 6f6d 7075 7461  .        computa
+0000ee10: 7469 6f6e 3a20 436f 6d70 7574 6174 696f  tion: Computatio
+0000ee20: 6e20 7c20 4e6f 6e65 203d 204e 6f6e 652c  n | None = None,
+0000ee30: 0a20 2020 2029 202d 3e20 5461 736b 5374  .    ) -> TaskSt
+0000ee40: 6174 653a 0a20 2020 2020 2020 2022 2222  ate:.        """
+0000ee50: 4372 6561 7465 2061 206e 6577 2074 6173  Create a new tas
+0000ee60: 6b2c 2061 6e64 2061 7373 6f63 6961 7465  k, and associate
+0000ee70: 6420 7374 6174 6573 2222 220a 2020 2020  d states""".    
+0000ee80: 2020 2020 7473 203d 2054 6173 6b53 7461      ts = TaskSta
+0000ee90: 7465 286b 6579 2c20 7370 6563 2c20 7374  te(key, spec, st
+0000eea0: 6174 6529 0a0a 2020 2020 2020 2020 7072  ate)..        pr
+0000eeb0: 6566 6978 5f6b 6579 203d 206b 6579 5f73  efix_key = key_s
+0000eec0: 706c 6974 286b 6579 290a 2020 2020 2020  plit(key).      
+0000eed0: 2020 7470 203d 2073 656c 662e 7461 736b    tp = self.task
+0000eee0: 5f70 7265 6669 7865 732e 6765 7428 7072  _prefixes.get(pr
+0000eef0: 6566 6978 5f6b 6579 290a 2020 2020 2020  efix_key).      
+0000ef00: 2020 6966 2074 7020 6973 204e 6f6e 653a    if tp is None:
+0000ef10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000ef20: 662e 7461 736b 5f70 7265 6669 7865 735b  f.task_prefixes[
+0000ef30: 7072 6566 6978 5f6b 6579 5d20 3d20 7470  prefix_key] = tp
+0000ef40: 203d 2054 6173 6b50 7265 6669 7828 7072   = TaskPrefix(pr
+0000ef50: 6566 6978 5f6b 6579 290a 2020 2020 2020  efix_key).      
+0000ef60: 2020 7473 2e70 7265 6669 7820 3d20 7470    ts.prefix = tp
+0000ef70: 0a0a 2020 2020 2020 2020 6772 6f75 705f  ..        group_
+0000ef80: 6b65 7920 3d20 7473 2e67 726f 7570 5f6b  key = ts.group_k
+0000ef90: 6579 0a20 2020 2020 2020 2074 6720 3d20  ey.        tg = 
+0000efa0: 7365 6c66 2e74 6173 6b5f 6772 6f75 7073  self.task_groups
+0000efb0: 2e67 6574 2867 726f 7570 5f6b 6579 290a  .get(group_key).
+0000efc0: 2020 2020 2020 2020 6966 2074 6720 6973          if tg is
+0000efd0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000efe0: 2020 2073 656c 662e 7461 736b 5f67 726f     self.task_gro
+0000eff0: 7570 735b 6772 6f75 705f 6b65 795d 203d  ups[group_key] =
+0000f000: 2074 6720 3d20 5461 736b 4772 6f75 7028   tg = TaskGroup(
+0000f010: 6772 6f75 705f 6b65 7929 0a20 2020 2020  group_key).     
+0000f020: 2020 2020 2020 2069 6620 636f 6d70 7574         if comput
+0000f030: 6174 696f 6e3a 0a20 2020 2020 2020 2020  ation:.         
+0000f040: 2020 2020 2020 2063 6f6d 7075 7461 7469         computati
+0000f050: 6f6e 2e67 726f 7570 732e 6164 6428 7467  on.groups.add(tg
+0000f060: 290a 2020 2020 2020 2020 2020 2020 7467  ).            tg
+0000f070: 2e70 7265 6669 7820 3d20 7470 0a20 2020  .prefix = tp.   
+0000f080: 2020 2020 2020 2020 2074 702e 6772 6f75           tp.grou
+0000f090: 7073 2e61 7070 656e 6428 7467 290a 2020  ps.append(tg).  
+0000f0a0: 2020 2020 2020 7467 2e61 6464 2874 7329        tg.add(ts)
+0000f0b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
+0000f0c0: 6173 6b73 5b6b 6579 5d20 3d20 7473 0a0a  asks[key] = ts..
+0000f0d0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0000f0e0: 730a 0a20 2020 2064 6566 205f 636c 6561  s..    def _clea
+0000f0f0: 725f 7461 736b 5f73 7461 7465 2873 656c  r_task_state(sel
+0000f100: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
+0000f110: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0000f120: 2822 436c 6561 7220 7461 736b 2073 7461  ("Clear task sta
+0000f130: 7465 2229 0a20 2020 2020 2020 2066 6f72  te").        for
+0000f140: 2063 6f6c 6c65 6374 696f 6e20 696e 2028   collection in (
+0000f150: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000f160: 662e 756e 7275 6e6e 6162 6c65 2c0a 2020  f.unrunnable,.  
+0000f170: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+0000f180: 7272 6564 5f74 6173 6b73 2c0a 2020 2020  rred_tasks,.    
+0000f190: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
+0000f1a0: 7075 7461 7469 6f6e 732c 0a20 2020 2020  putations,.     
+0000f1b0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0000f1c0: 5f70 7265 6669 7865 732c 0a20 2020 2020  _prefixes,.     
+0000f1d0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0000f1e0: 5f67 726f 7570 732c 0a20 2020 2020 2020  _groups,.       
+0000f1f0: 2020 2020 2073 656c 662e 7461 736b 5f6d       self.task_m
+0000f200: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
+0000f210: 2020 2020 2073 656c 662e 756e 6b6e 6f77       self.unknow
+0000f220: 6e5f 6475 7261 7469 6f6e 732c 0a20 2020  n_durations,.   
+0000f230: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+0000f240: 706c 6963 6174 6564 5f74 6173 6b73 2c0a  plicated_tasks,.
+0000f250: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+0000f260: 2020 2020 2020 2063 6f6c 6c65 6374 696f         collectio
+0000f270: 6e2e 636c 6561 7228 2920 2023 2074 7970  n.clear()  # typ
+0000f280: 653a 2069 676e 6f72 650a 0a20 2020 2040  e: ignore..    @
+0000f290: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0000f2a0: 2074 6f74 616c 5f6f 6363 7570 616e 6379   total_occupancy
+0000f2b0: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
+0000f2c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000f2d0: 7365 6c66 2e5f 6361 6c63 5f6f 6363 7570  self._calc_occup
+0000f2e0: 616e 6379 280a 2020 2020 2020 2020 2020  ancy(.          
+0000f2f0: 2020 7365 6c66 2e5f 7461 736b 5f70 7265    self._task_pre
+0000f300: 6669 785f 636f 756e 745f 676c 6f62 616c  fix_count_global
+0000f310: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+0000f320: 6c66 2e5f 6e65 7477 6f72 6b5f 6f63 635f  lf._network_occ_
+0000f330: 676c 6f62 616c 2c0a 2020 2020 2020 2020  global,.        
+0000f340: 290a 0a20 2020 2064 6566 205f 6361 6c63  )..    def _calc
+0000f350: 5f6f 6363 7570 616e 6379 280a 2020 2020  _occupancy(.    
+0000f360: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0000f370: 2020 7461 736b 5f70 7265 6669 785f 636f    task_prefix_co
+0000f380: 756e 743a 2064 6963 745b 7374 722c 2069  unt: dict[str, i
+0000f390: 6e74 5d2c 0a20 2020 2020 2020 206e 6574  nt],.        net
+0000f3a0: 776f 726b 5f6f 6363 3a20 666c 6f61 742c  work_occ: float,
+0000f3b0: 0a20 2020 2029 202d 3e20 666c 6f61 743a  .    ) -> float:
+0000f3c0: 0a20 2020 2020 2020 2072 6573 203d 2030  .        res = 0
+0000f3d0: 2e30 0a20 2020 2020 2020 2066 6f72 2070  .0.        for p
+0000f3e0: 7265 6669 785f 6e61 6d65 2c20 636f 756e  refix_name, coun
+0000f3f0: 7420 696e 2074 6173 6b5f 7072 6566 6978  t in task_prefix
+0000f400: 5f63 6f75 6e74 2e69 7465 6d73 2829 3a0a  _count.items():.
+0000f410: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+0000f420: 444f 3a20 4465 616c 2077 6974 6820 756e  DO: Deal with un
+0000f430: 6b6e 6f77 6e20 7461 736b 7320 6265 7474  known tasks bett
+0000f440: 6572 0a20 2020 2020 2020 2020 2020 2070  er.            p
+0000f450: 7265 6669 7820 3d20 7365 6c66 2e74 6173  refix = self.tas
+0000f460: 6b5f 7072 6566 6978 6573 5b70 7265 6669  k_prefixes[prefi
+0000f470: 785f 6e61 6d65 5d0a 2020 2020 2020 2020  x_name].        
+0000f480: 2020 2020 6173 7365 7274 2070 7265 6669      assert prefi
+0000f490: 7820 6973 206e 6f74 204e 6f6e 650a 2020  x is not None.  
+0000f4a0: 2020 2020 2020 2020 2020 6475 7261 7469            durati
+0000f4b0: 6f6e 203d 2070 7265 6669 782e 6475 7261  on = prefix.dura
+0000f4c0: 7469 6f6e 5f61 7665 7261 6765 0a20 2020  tion_average.   
+0000f4d0: 2020 2020 2020 2020 2069 6620 6475 7261           if dura
+0000f4e0: 7469 6f6e 203c 2030 3a0a 2020 2020 2020  tion < 0:.      
+0000f4f0: 2020 2020 2020 2020 2020 6966 2070 7265            if pre
+0000f500: 6669 782e 6d61 785f 6578 6563 5f74 696d  fix.max_exec_tim
+0000f510: 6520 3e20 303a 0a20 2020 2020 2020 2020  e > 0:.         
+0000f520: 2020 2020 2020 2020 2020 2064 7572 6174             durat
+0000f530: 696f 6e20 3d20 3220 2a20 7072 6566 6978  ion = 2 * prefix
+0000f540: 2e6d 6178 5f65 7865 635f 7469 6d65 0a20  .max_exec_time. 
+0000f550: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000f560: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000f570: 2020 2020 2020 2020 2064 7572 6174 696f           duratio
+0000f580: 6e20 3d20 7365 6c66 2e55 4e4b 4e4f 574e  n = self.UNKNOWN
+0000f590: 5f54 4153 4b5f 4455 5241 5449 4f4e 0a20  _TASK_DURATION. 
+0000f5a0: 2020 2020 2020 2020 2020 2072 6573 202b             res +
+0000f5b0: 3d20 6475 7261 7469 6f6e 202a 2063 6f75  = duration * cou
+0000f5c0: 6e74 0a20 2020 2020 2020 206f 6363 203d  nt.        occ =
+0000f5d0: 2072 6573 202b 206e 6574 776f 726b 5f6f   res + network_o
+0000f5e0: 6363 202f 2073 656c 662e 6261 6e64 7769  cc / self.bandwi
+0000f5f0: 6474 680a 2020 2020 2020 2020 6173 7365  dth.        asse
+0000f600: 7274 206f 6363 203e 3d20 302c 206f 6363  rt occ >= 0, occ
+0000f610: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000f620: 6f63 630a 0a20 2020 2023 2323 2323 2323  occ..    #######
+0000f630: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+0000f640: 2020 2023 2053 7461 7465 2054 7261 6e73     # State Trans
+0000f650: 6974 696f 6e73 2023 0a20 2020 2023 2323  itions #.    ###
+0000f660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f670: 2323 0a0a 2020 2020 6465 6620 5f74 7261  ##..    def _tra
+0000f680: 6e73 6974 696f 6e28 0a20 2020 2020 2020  nsition(.       
+0000f690: 2073 656c 662c 206b 6579 3a20 7374 722c   self, key: str,
+0000f6a0: 2066 696e 6973 683a 2054 6173 6b53 7461   finish: TaskSta
+0000f6b0: 7465 5374 6174 652c 2073 7469 6d75 6c75  teState, stimulu
+0000f6c0: 735f 6964 3a20 7374 722c 202a 2a6b 7761  s_id: str, **kwa
+0000f6d0: 7267 733a 2041 6e79 0a20 2020 2029 202d  rgs: Any.    ) -
+0000f6e0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
+0000f6f0: 2020 2020 2222 2254 7261 6e73 6974 696f      """Transitio
+0000f700: 6e20 6120 6b65 7920 6672 6f6d 2069 7473  n a key from its
+0000f710: 2063 7572 7265 6e74 2073 7461 7465 2074   current state t
+0000f720: 6f20 7468 6520 6669 6e69 7368 2073 7461  o the finish sta
+0000f730: 7465 0a0a 2020 2020 2020 2020 4578 616d  te..        Exam
+0000f740: 706c 6573 0a20 2020 2020 2020 202d 2d2d  ples.        ---
+0000f750: 2d2d 2d2d 2d0a 2020 2020 2020 2020 3e3e  -----.        >>
+0000f760: 3e20 7365 6c66 2e5f 7472 616e 7369 7469  > self._transiti
+0000f770: 6f6e 2827 7827 2c20 2777 6169 7469 6e67  on('x', 'waiting
+0000f780: 2729 0a20 2020 2020 2020 207b 2778 273a  ').        {'x':
+0000f790: 2027 7072 6f63 6573 7369 6e67 277d 2c20   'processing'}, 
+0000f7a0: 7b7d 2c20 7b7d 0a0a 2020 2020 2020 2020  {}, {}..        
+0000f7b0: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
+0000f7c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0000f7d0: 5475 706c 6520 6f66 3a0a 0a20 2020 2020  Tuple of:..     
+0000f7e0: 2020 202d 2044 6963 7469 6f6e 6172 7920     - Dictionary 
+0000f7f0: 6f66 2072 6563 6f6d 6d65 6e64 6174 696f  of recommendatio
+0000f800: 6e73 2066 6f72 2066 7574 7572 6520 7472  ns for future tr
+0000f810: 616e 7369 7469 6f6e 7320 7b6b 6579 3a20  ansitions {key: 
+0000f820: 6e65 7720 7374 6174 657d 0a20 2020 2020  new state}.     
+0000f830: 2020 202d 204d 6573 7361 6765 7320 746f     - Messages to
+0000f840: 2063 6c69 656e 7473 207b 636c 6965 6e74   clients {client
+0000f850: 2061 6464 7265 7373 3a20 5b6d 7367 2c20   address: [msg, 
+0000f860: 6d73 672c 202e 2e2e 5d7d 0a20 2020 2020  msg, ...]}.     
+0000f870: 2020 202d 204d 6573 7361 6765 7320 746f     - Messages to
+0000f880: 2077 6f72 6b65 7273 207b 776f 726b 6572   workers {worker
+0000f890: 2061 6464 7265 7373 3a20 5b6d 7367 2c20   address: [msg, 
+0000f8a0: 6d73 672c 202e 2e2e 5d7d 0a0a 2020 2020  msg, ...]}..    
+0000f8b0: 2020 2020 5365 6520 416c 736f 0a20 2020      See Also.   
+0000f8c0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+0000f8d0: 2020 2020 2020 5363 6865 6475 6c65 722e        Scheduler.
+0000f8e0: 7472 616e 7369 7469 6f6e 7320 3a20 7472  transitions : tr
+0000f8f0: 616e 7369 7469 7665 2076 6572 7369 6f6e  ansitive version
+0000f900: 206f 6620 7468 6973 2066 756e 6374 696f   of this functio
+0000f910: 6e0a 2020 2020 2020 2020 2222 220a 2020  n.        """.  
+0000f920: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000f930: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+0000f940: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
+0000f950: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0000f960: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0000f970: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000f980: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a20 2020  n {}, {}, {}.   
+0000f990: 2020 2020 2020 2020 2073 7461 7274 203d           start =
+0000f9a0: 2074 732e 5f73 7461 7465 0a20 2020 2020   ts._state.     
+0000f9b0: 2020 2020 2020 2069 6620 7374 6172 7420         if start 
+0000f9c0: 3d3d 2066 696e 6973 683a 0a20 2020 2020  == finish:.     
+0000f9d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000f9e0: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a 2020  n {}, {}, {}..  
+0000f9f0: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
+0000fa00: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
+0000fa10: 202d 2069 6e20 6361 7365 206f 6620 7472   - in case of tr
+0000fa20: 616e 7369 7469 6f6e 2074 6872 6f75 6768  ansition through
+0000fa30: 2072 656c 6561 7365 642c 2074 6869 7320   released, this 
+0000fa40: 636f 756e 7465 7220 6973 2069 6e63 7265  counter is incre
+0000fa50: 6d65 6e74 6564 2062 7920 320a 2020 2020  mented by 2.    
+0000fa60: 2020 2020 2020 2020 2320 2d20 7468 6973          # - this
+0000fa70: 2069 6e63 7265 6173 6520 6861 7070 656e   increase happen
+0000fa80: 7320 6265 666f 7265 2074 6865 2061 6374  s before the act
+0000fa90: 7561 6c20 7472 616e 7369 7469 6f6e 732c  ual transitions,
+0000faa0: 2073 6f20 7468 6174 2069 7420 6361 6e0a   so that it can.
+0000fab0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0000fac0: 6361 7463 6820 706f 7465 6e74 6961 6c20  catch potential 
+0000fad0: 696e 6669 6e69 7465 2072 6563 7572 7369  infinite recursi
+0000fae0: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
+0000faf0: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
+0000fb00: 636f 756e 7465 7220 2b3d 2031 0a20 2020  counter += 1.   
+0000fb10: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0000fb20: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+0000fb30: 7465 725f 6d61 783a 0a20 2020 2020 2020  ter_max:.       
+0000fb40: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0000fb50: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
+0000fb60: 636f 756e 7465 7220 3c20 7365 6c66 2e74  counter < self.t
+0000fb70: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
+0000fb80: 725f 6d61 780a 0a20 2020 2020 2020 2020  r_max..         
+0000fb90: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0000fba0: 6e73 3a20 6469 6374 203d 207b 7d0a 2020  ns: dict = {}.  
+0000fbb0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0000fbc0: 5f6d 7367 733a 2064 6963 7420 3d20 7b7d  _msgs: dict = {}
+0000fbd0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0000fbe0: 656e 745f 6d73 6773 3a20 6469 6374 203d  ent_msgs: dict =
+0000fbf0: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
+0000fc00: 2069 6620 7365 6c66 2e70 6c75 6769 6e73   if self.plugins
+0000fc10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000fc20: 2020 6465 7065 6e64 656e 7473 203d 2073    dependents = s
+0000fc30: 6574 2874 732e 6465 7065 6e64 656e 7473  et(ts.dependents
+0000fc40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000fc50: 2020 6465 7065 6e64 656e 6369 6573 203d    dependencies =
+0000fc60: 2073 6574 2874 732e 6465 7065 6e64 656e   set(ts.dependen
+0000fc70: 6369 6573 290a 0a20 2020 2020 2020 2020  cies)..         
+0000fc80: 2020 2066 756e 6320 3d20 7365 6c66 2e5f     func = self._
+0000fc90: 5452 414e 5349 5449 4f4e 535f 5441 424c  TRANSITIONS_TABL
+0000fca0: 452e 6765 7428 2873 7461 7274 2c20 6669  E.get((start, fi
+0000fcb0: 6e69 7368 2929 0a20 2020 2020 2020 2020  nish)).         
+0000fcc0: 2020 2069 6620 6675 6e63 2069 7320 6e6f     if func is no
+0000fcd0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000fce0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0000fcf0: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+0000fd00: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+0000fd10: 7320 3d20 6675 6e63 280a 2020 2020 2020  s = func(.      
+0000fd20: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000fd30: 6c66 2c20 6b65 792c 2073 7469 6d75 6c75  lf, key, stimulu
+0000fd40: 735f 6964 2c20 2a2a 6b77 6172 6773 0a20  s_id, **kwargs. 
+0000fd50: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000fd60: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+0000fd70: 6966 2022 7265 6c65 6173 6564 2220 6e6f  if "released" no
+0000fd80: 7420 696e 2028 7374 6172 742c 2066 696e  t in (start, fin
+0000fd90: 6973 6829 3a0a 2020 2020 2020 2020 2020  ish):.          
+0000fda0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0000fdb0: 206b 7761 7267 732c 2028 6b77 6172 6773   kwargs, (kwargs
+0000fdc0: 2c20 7374 6172 742c 2066 696e 6973 6829  , start, finish)
+0000fdd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fde0: 2061 5f72 6563 732c 2061 5f63 6d73 6773   a_recs, a_cmsgs
+0000fdf0: 2c20 615f 776d 7367 7320 3d20 7365 6c66  , a_wmsgs = self
+0000fe00: 2e5f 7472 616e 7369 7469 6f6e 280a 2020  ._transition(.  
+0000fe10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe20: 2020 6b65 792c 2022 7265 6c65 6173 6564    key, "released
+0000fe30: 222c 2073 7469 6d75 6c75 735f 6964 0a20  ", stimulus_id. 
+0000fe40: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000fe50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000fe60: 2020 7620 3d20 615f 7265 6373 2e67 6574    v = a_recs.get
+0000fe70: 286b 6579 2c20 6669 6e69 7368 290a 2020  (key, finish).  
+0000fe80: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+0000fe90: 6e63 203d 2073 656c 662e 5f54 5241 4e53  nc = self._TRANS
+0000fea0: 4954 494f 4e53 5f54 4142 4c45 5b22 7265  ITIONS_TABLE["re
+0000feb0: 6c65 6173 6564 222c 2076 5d0a 2020 2020  leased", v].    
+0000fec0: 2020 2020 2020 2020 2020 2020 625f 7265              b_re
+0000fed0: 6373 2c20 625f 636d 7367 732c 2062 5f77  cs, b_cmsgs, b_w
+0000fee0: 6d73 6773 203d 2066 756e 6328 7365 6c66  msgs = func(self
+0000fef0: 2c20 6b65 792c 2073 7469 6d75 6c75 735f  , key, stimulus_
+0000ff00: 6964 290a 0a20 2020 2020 2020 2020 2020  id)..           
+0000ff10: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0000ff20: 696f 6e73 2e75 7064 6174 6528 615f 7265  ions.update(a_re
+0000ff30: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
+0000ff40: 2020 2020 666f 7220 632c 206e 6577 5f6d      for c, new_m
+0000ff50: 7367 7320 696e 2061 5f63 6d73 6773 2e69  sgs in a_cmsgs.i
+0000ff60: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+0000ff70: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+0000ff80: 6e74 5f6d 7367 732e 7365 7464 6566 6175  nt_msgs.setdefau
+0000ff90: 6c74 2863 2c20 5b5d 292e 6578 7465 6e64  lt(c, []).extend
+0000ffa0: 286e 6577 5f6d 7367 7329 0a20 2020 2020  (new_msgs).     
+0000ffb0: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
+0000ffc0: 2c20 6e65 775f 6d73 6773 2069 6e20 615f  , new_msgs in a_
+0000ffd0: 776d 7367 732e 6974 656d 7328 293a 0a20  wmsgs.items():. 
+0000ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fff0: 2020 2077 6f72 6b65 725f 6d73 6773 2e73     worker_msgs.s
+00010000: 6574 6465 6661 756c 7428 772c 205b 5d29  etdefault(w, [])
+00010010: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
+00010020: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00010030: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+00010040: 6e73 2e75 7064 6174 6528 625f 7265 6373  ns.update(b_recs
+00010050: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010060: 2020 666f 7220 632c 206e 6577 5f6d 7367    for c, new_msg
+00010070: 7320 696e 2062 5f63 6d73 6773 2e69 7465  s in b_cmsgs.ite
+00010080: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00010090: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+000100a0: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
+000100b0: 2863 2c20 5b5d 292e 6578 7465 6e64 286e  (c, []).extend(n
+000100c0: 6577 5f6d 7367 7329 0a20 2020 2020 2020  ew_msgs).       
+000100d0: 2020 2020 2020 2020 2066 6f72 2077 2c20           for w, 
+000100e0: 6e65 775f 6d73 6773 2069 6e20 625f 776d  new_msgs in b_wm
+000100f0: 7367 732e 6974 656d 7328 293a 0a20 2020  sgs.items():.   
+00010100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010110: 2077 6f72 6b65 725f 6d73 6773 2e73 6574   worker_msgs.set
+00010120: 6465 6661 756c 7428 772c 205b 5d29 2e65  default(w, []).e
+00010130: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
+00010140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010150: 2073 7461 7274 203d 2022 7265 6c65 6173   start = "releas
+00010160: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
+00010170: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00010180: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+00010190: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
+000101a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000101b0: 496d 706f 7373 6962 6c65 2074 7261 6e73  Impossible trans
+000101c0: 6974 696f 6e20 6672 6f6d 207b 7374 6172  ition from {star
+000101d0: 747d 2074 6f20 7b66 696e 6973 687d 2066  t} to {finish} f
+000101e0: 6f72 207b 6b65 7921 727d 3a20 220a 2020  or {key!r}: ".  
+000101f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010200: 2020 6622 7b73 7469 6d75 6c75 735f 6964    f"{stimulus_id
+00010210: 3d7d 2c20 7b6b 7761 7267 733d 7d2c 2073  =}, {kwargs=}, s
+00010220: 746f 7279 3d7b 7365 6c66 2e73 746f 7279  tory={self.story
+00010230: 2874 7329 7d22 0a20 2020 2020 2020 2020  (ts)}".         
+00010240: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00010250: 2020 2020 2020 6966 206e 6f74 2073 7469        if not sti
+00010260: 6d75 6c75 735f 6964 3a0a 2020 2020 2020  mulus_id:.      
+00010270: 2020 2020 2020 2020 2020 7374 696d 756c            stimul
+00010280: 7573 5f69 6420 3d20 5354 494d 554c 5553  us_id = STIMULUS
+00010290: 5f49 445f 554e 5345 540a 0a20 2020 2020  _ID_UNSET..     
+000102a0: 2020 2020 2020 2061 6374 7561 6c5f 6669         actual_fi
+000102b0: 6e69 7368 203d 2074 732e 5f73 7461 7465  nish = ts._state
+000102c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000102d0: 662e 7472 616e 7369 7469 6f6e 5f6c 6f67  f.transition_log
+000102e0: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
+000102f0: 2020 2020 2020 2020 2054 7261 6e73 6974           Transit
+00010300: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00010310: 2020 2020 2020 2020 206b 6579 2c20 7374           key, st
+00010320: 6172 742c 2061 6374 7561 6c5f 6669 6e69  art, actual_fini
+00010330: 7368 2c20 7265 636f 6d6d 656e 6461 7469  sh, recommendati
+00010340: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
+00010350: 2c20 7469 6d65 2829 0a20 2020 2020 2020  , time().       
+00010360: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00010370: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00010380: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00010390: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+000103a0: 2020 2020 2020 2069 6620 7374 696d 756c         if stimul
+000103b0: 7573 5f69 6420 3d3d 2053 5449 4d55 4c55  us_id == STIMULU
+000103c0: 535f 4944 5f55 4e53 4554 3a0a 2020 2020  S_ID_UNSET:.    
+000103d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103e0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
+000103f0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00010400: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+00010410: 6d75 6c75 735f 6964 206e 6f74 2073 6574  mulus_id not set
+00010420: 2064 7572 696e 6720 5363 6865 6475 6c65   during Schedule
+00010430: 7220 7472 616e 7369 7469 6f6e 220a 2020  r transition".  
+00010440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010450: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00010460: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00010470: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00010480: 2020 2020 2020 2254 7261 6e73 6974 696f        "Transitio
+00010490: 6e65 6420 2572 2025 732d 3e25 7320 2861  ned %r %s->%s (a
+000104a0: 6374 7561 6c3a 2025 7329 2e20 2043 6f6e  ctual: %s).  Con
+000104b0: 7365 7175 656e 6365 3a20 2573 222c 0a20  sequence: %s",. 
+000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104d0: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
+000104e0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+000104f0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00010500: 2020 2020 2020 2066 696e 6973 682c 0a20         finish,. 
+00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010520: 2020 2061 6374 7561 6c5f 6669 6e69 7368     actual_finish
+00010530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010540: 2020 2020 2020 6469 6374 2872 6563 6f6d        dict(recom
+00010550: 6d65 6e64 6174 696f 6e73 292c 0a20 2020  mendations),.   
+00010560: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00010570: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00010580: 6c66 2e70 6c75 6769 6e73 3a0a 2020 2020  lf.plugins:.    
+00010590: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+000105a0: 6d70 6f72 6172 696c 7920 7075 7420 6261  mporarily put ba
+000105b0: 636b 2066 6f72 676f 7474 656e 206b 6579  ck forgotten key
+000105c0: 2066 6f72 2070 6c75 6769 6e20 746f 2072   for plugin to r
+000105d0: 6574 7269 6576 6520 6974 0a20 2020 2020  etrieve it.     
+000105e0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+000105f0: 2e5f 7374 6174 6520 3d3d 2022 666f 7267  ._state == "forg
+00010600: 6f74 7465 6e22 3a0a 2020 2020 2020 2020  otten":.        
+00010610: 2020 2020 2020 2020 2020 2020 7473 2e64              ts.d
+00010620: 6570 656e 6465 6e74 7320 3d20 6465 7065  ependents = depe
+00010630: 6e64 656e 7473 0a20 2020 2020 2020 2020  ndents.         
+00010640: 2020 2020 2020 2020 2020 2074 732e 6465             ts.de
+00010650: 7065 6e64 656e 6369 6573 203d 2064 6570  pendencies = dep
+00010660: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
+00010670: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00010680: 6c66 2e74 6173 6b73 5b74 732e 6b65 795d  lf.tasks[ts.key]
+00010690: 203d 2074 730a 2020 2020 2020 2020 2020   = ts.          
+000106a0: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
+000106b0: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
+000106c0: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
+000106d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000106e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000106f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010700: 2020 706c 7567 696e 2e74 7261 6e73 6974    plugin.transit
+00010710: 696f 6e28 6b65 792c 2073 7461 7274 2c20  ion(key, start, 
+00010720: 6163 7475 616c 5f66 696e 6973 682c 202a  actual_finish, *
+00010730: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+00010740: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00010750: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010770: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00010780: 666f 2822 506c 7567 696e 2066 6169 6c65  fo("Plugin faile
+00010790: 6420 7769 7468 2065 7863 6570 7469 6f6e  d with exception
+000107a0: 222c 2065 7863 5f69 6e66 6f3d 5472 7565  ", exc_info=True
+000107b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000107c0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+000107d0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
+000107e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107f0: 2020 6465 6c20 7365 6c66 2e74 6173 6b73    del self.tasks
+00010800: 5b74 732e 6b65 795d 0a0a 2020 2020 2020  [ts.key]..      
+00010810: 2020 2020 2020 7467 203d 2074 732e 6772        tg = ts.gr
+00010820: 6f75 700a 2020 2020 2020 2020 2020 2020  oup.            
+00010830: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
+00010840: 666f 7267 6f74 7465 6e22 2061 6e64 2074  forgotten" and t
+00010850: 672e 6e61 6d65 2069 6e20 7365 6c66 2e74  g.name in self.t
+00010860: 6173 6b5f 6772 6f75 7073 3a0a 2020 2020  ask_groups:.    
+00010870: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+00010880: 6d6f 7665 2054 6173 6b47 726f 7570 2069  move TaskGroup i
+00010890: 6620 616c 6c20 7461 736b 7320 6172 6520  f all tasks are 
+000108a0: 696e 2074 6865 2066 6f72 676f 7474 656e  in the forgotten
+000108b0: 2073 7461 7465 0a20 2020 2020 2020 2020   state.         
+000108c0: 2020 2020 2020 2069 6620 616c 6c28 7620         if all(v 
+000108d0: 3d3d 2030 206f 7220 6b20 3d3d 2022 666f  == 0 or k == "fo
+000108e0: 7267 6f74 7465 6e22 2066 6f72 206b 2c20  rgotten" for k, 
+000108f0: 7620 696e 2074 672e 7374 6174 6573 2e69  v in tg.states.i
+00010900: 7465 6d73 2829 293a 0a20 2020 2020 2020  tems()):.       
+00010910: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+00010920: 7072 6566 6978 2e67 726f 7570 732e 7265  prefix.groups.re
+00010930: 6d6f 7665 2874 6729 0a20 2020 2020 2020  move(tg).       
+00010940: 2020 2020 2020 2020 2020 2020 2064 656c               del
+00010950: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
+00010960: 735b 7467 2e6e 616d 655d 0a0a 2020 2020  s[tg.name]..    
+00010970: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00010980: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+00010990: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
+000109a0: 6b65 725f 6d73 6773 0a20 2020 2020 2020  ker_msgs.       
+000109b0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000109c0: 6e3a 0a20 2020 2020 2020 2020 2020 206c  n:.            l
+000109d0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+000109e0: 2245 7272 6f72 2074 7261 6e73 6974 696f  "Error transitio
+000109f0: 6e69 6e67 2025 7220 6672 6f6d 2025 7220  ning %r from %r 
+00010a00: 746f 2025 7222 2c20 6b65 792c 2073 7461  to %r", key, sta
+00010a10: 7274 2c20 6669 6e69 7368 290a 2020 2020  rt, finish).    
+00010a20: 2020 2020 2020 2020 6966 204c 4f47 5f50          if LOG_P
+00010a30: 4442 3a0a 2020 2020 2020 2020 2020 2020  DB:.            
+00010a40: 2020 2020 696d 706f 7274 2070 6462 0a0a      import pdb..
+00010a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a60: 7064 622e 7365 745f 7472 6163 6528 290a  pdb.set_trace().
+00010a70: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00010a80: 650a 0a20 2020 2064 6566 205f 7472 616e  e..    def _tran
+00010a90: 7369 7469 6f6e 7328 0a20 2020 2020 2020  sitions(.       
+00010aa0: 2073 656c 662c 0a20 2020 2020 2020 2072   self,.        r
+00010ab0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+00010ac0: 5265 6373 2c0a 2020 2020 2020 2020 636c  Recs,.        cl
+00010ad0: 6965 6e74 5f6d 7367 733a 204d 7367 732c  ient_msgs: Msgs,
+00010ae0: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
+00010af0: 6d73 6773 3a20 4d73 6773 2c0a 2020 2020  msgs: Msgs,.    
+00010b00: 2020 2020 7374 696d 756c 7573 5f69 643a      stimulus_id:
+00010b10: 2073 7472 2c0a 2020 2020 2920 2d3e 204e   str,.    ) -> N
+00010b20: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00010b30: 5072 6f63 6573 7320 7472 616e 7369 7469  Process transiti
+00010b40: 6f6e 7320 756e 7469 6c20 6e6f 6e65 2061  ons until none a
+00010b50: 7265 206c 6566 740a 0a20 2020 2020 2020  re left..       
+00010b60: 2054 6869 7320 696e 636c 7564 6573 2066   This includes f
+00010b70: 6565 6462 6163 6b20 6672 6f6d 2070 7265  eedback from pre
+00010b80: 7669 6f75 7320 7472 616e 7369 7469 6f6e  vious transition
+00010b90: 7320 616e 6420 636f 6e74 696e 7565 7320  s and continues 
+00010ba0: 756e 7469 6c20 7765 0a20 2020 2020 2020  until we.       
+00010bb0: 2072 6561 6368 2061 2073 7465 6164 7920   reach a steady 
+00010bc0: 7374 6174 650a 2020 2020 2020 2020 2222  state.        ""
+00010bd0: 220a 2020 2020 2020 2020 6b65 7973 3a20  ".        keys: 
+00010be0: 7365 745b 7374 725d 203d 2073 6574 2829  set[str] = set()
+00010bf0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00010c00: 6e64 6174 696f 6e73 203d 2072 6563 6f6d  ndations = recom
+00010c10: 6d65 6e64 6174 696f 6e73 2e63 6f70 7928  mendations.copy(
+00010c20: 290a 0a20 2020 2020 2020 2077 6869 6c65  )..        while
+00010c30: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00010c40: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
+00010c50: 792c 2066 696e 6973 6820 3d20 7265 636f  y, finish = reco
+00010c60: 6d6d 656e 6461 7469 6f6e 732e 706f 7069  mmendations.popi
+00010c70: 7465 6d28 290a 2020 2020 2020 2020 2020  tem().          
+00010c80: 2020 6b65 7973 2e61 6464 286b 6579 290a    keys.add(key).
+00010c90: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+00010ca0: 5f72 6563 732c 206e 6577 5f63 6d73 6773  _recs, new_cmsgs
+00010cb0: 2c20 6e65 775f 776d 7367 7320 3d20 7365  , new_wmsgs = se
+00010cc0: 6c66 2e5f 7472 616e 7369 7469 6f6e 286b  lf._transition(k
+00010cd0: 6579 2c20 6669 6e69 7368 2c20 7374 696d  ey, finish, stim
+00010ce0: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
+00010cf0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00010d00: 7469 6f6e 732e 7570 6461 7465 286e 6577  tions.update(new
+00010d10: 5f72 6563 7329 0a20 2020 2020 2020 2020  _recs).         
+00010d20: 2020 2066 6f72 2063 2c20 6e65 775f 6d73     for c, new_ms
+00010d30: 6773 2069 6e20 6e65 775f 636d 7367 732e  gs in new_cmsgs.
+00010d40: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00010d50: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
+00010d60: 6d73 6773 2e73 6574 6465 6661 756c 7428  msgs.setdefault(
+00010d70: 632c 205b 5d29 2e65 7874 656e 6428 6e65  c, []).extend(ne
+00010d80: 775f 6d73 6773 290a 2020 2020 2020 2020  w_msgs).        
+00010d90: 2020 2020 666f 7220 772c 206e 6577 5f6d      for w, new_m
+00010da0: 7367 7320 696e 206e 6577 5f77 6d73 6773  sgs in new_wmsgs
+00010db0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00010dc0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00010dd0: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
+00010de0: 2877 2c20 5b5d 292e 6578 7465 6e64 286e  (w, []).extend(n
+00010df0: 6577 5f6d 7367 7329 0a0a 2020 2020 2020  ew_msgs)..      
+00010e00: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00010e10: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00010e20: 2320 4649 584d 4520 646f 776e 6361 7374  # FIXME downcast
+00010e30: 2061 6e74 6970 6174 7465 726e 0a20 2020   antipattern.   
+00010e40: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
+00010e50: 6572 203d 2063 6173 7428 5363 6865 6475  er = cast(Schedu
+00010e60: 6c65 722c 2073 656c 6629 0a20 2020 2020  ler, self).     
+00010e70: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00010e80: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+00010e90: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+00010ea0: 722e 7661 6c69 6461 7465 5f6b 6579 286b  r.validate_key(k
+00010eb0: 6579 290a 0a20 2020 2064 6566 2074 7261  ey)..    def tra
+00010ec0: 6e73 6974 696f 6e5f 7265 6c65 6173 6564  nsition_released
+00010ed0: 5f77 6169 7469 6e67 2873 656c 662c 206b  _waiting(self, k
+00010ee0: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
+00010ef0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+00010f00: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00010f10: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00010f20: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
+00010f30: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00010f40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00010f50: 7274 2074 732e 7275 6e5f 7370 6563 0a20  rt ts.run_spec. 
+00010f60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00010f70: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+00010f80: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
+00010f90: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
+00010fa0: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
+00010fb0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00010fc0: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+00010fd0: 2020 2020 2020 2020 2020 666f 7220 6474            for dt
+00010fe0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00010ff0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00011000: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
+00011010: 2e73 7461 7465 206e 6f74 2069 6e20 7b22  .state not in {"
+00011020: 666f 7267 6f74 7465 6e22 2c20 2265 7272  forgotten", "err
+00011030: 6564 227d 0a0a 2020 2020 2020 2020 6966  ed"}..        if
+00011040: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
+00011050: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+00011060: 2020 2020 2020 2072 6574 7572 6e20 7b6b         return {k
+00011070: 6579 3a20 2266 6f72 676f 7474 656e 227d  ey: "forgotten"}
+00011080: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 2020  , {}, {}..      
+00011090: 2020 7473 2e73 7461 7465 203d 2022 7761    ts.state = "wa
+000110a0: 6974 696e 6722 0a0a 2020 2020 2020 2020  iting"..        
+000110b0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
+000110c0: 2052 6563 7320 3d20 7b7d 0a0a 2020 2020   Recs = {}..    
+000110d0: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+000110e0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+000110f0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00011100: 6f74 2064 7473 2e77 686f 5f68 6173 3a0a  ot dts.who_has:.
+00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011120: 7473 2e77 6169 7469 6e67 5f6f 6e2e 6164  ts.waiting_on.ad
+00011130: 6428 6474 7329 0a20 2020 2020 2020 2020  d(dts).         
+00011140: 2020 2069 6620 6474 732e 7374 6174 6520     if dts.state 
+00011150: 3d3d 2022 7265 6c65 6173 6564 223a 0a20  == "released":. 
+00011160: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00011170: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+00011180: 7473 2e6b 6579 5d20 3d20 2277 6169 7469  ts.key] = "waiti
+00011190: 6e67 220a 2020 2020 2020 2020 2020 2020  ng".            
+000111a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000111b0: 2020 2020 2020 6474 732e 7761 6974 6572        dts.waiter
+000111c0: 732e 6164 6428 7473 290a 0a20 2020 2020  s.add(ts)..     
+000111d0: 2020 2074 732e 7761 6974 6572 7320 3d20     ts.waiters = 
+000111e0: 7b64 7473 2066 6f72 2064 7473 2069 6e20  {dts for dts in 
+000111f0: 7473 2e64 6570 656e 6465 6e74 7320 6966  ts.dependents if
+00011200: 2064 7473 2e73 7461 7465 203d 3d20 2277   dts.state == "w
+00011210: 6169 7469 6e67 227d 0a0a 2020 2020 2020  aiting"}..      
+00011220: 2020 6966 206e 6f74 2074 732e 7761 6974    if not ts.wait
+00011230: 696e 675f 6f6e 3a0a 2020 2020 2020 2020  ing_on:.        
+00011240: 2020 2020 2320 4e4f 5445 3a20 7761 6974      # NOTE: wait
+00011250: 696e 672d 3e70 726f 6365 7373 696e 6720  ing->processing 
+00011260: 7769 6c6c 2073 656e 6420 7461 736b 7320  will send tasks 
+00011270: 746f 2071 7565 7565 6420 6f72 206e 6f2d  to queued or no-
+00011280: 776f 726b 6572 2061 730a 2020 2020 2020  worker as.      
+00011290: 2020 2020 2020 2320 6e65 6365 7373 6172        # necessar
+000112a0: 790a 2020 2020 2020 2020 2020 2020 7265  y.            re
+000112b0: 636f 6d6d 656e 6461 7469 6f6e 735b 6b65  commendations[ke
+000112c0: 795d 203d 2022 7072 6f63 6573 7369 6e67  y] = "processing
+000112d0: 220a 0a20 2020 2020 2020 2072 6574 7572  "..        retur
+000112e0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+000112f0: 732c 207b 7d2c 207b 7d0a 0a20 2020 2064  s, {}, {}..    d
+00011300: 6566 2074 7261 6e73 6974 696f 6e5f 6e6f  ef transition_no
+00011310: 5f77 6f72 6b65 725f 7072 6f63 6573 7369  _worker_processi
+00011320: 6e67 2873 656c 662c 206b 6579 3a20 7374  ng(self, key: st
+00011330: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+00011340: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
+00011350: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+00011360: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+00011370: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
+00011380: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
+00011390: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+000113a0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+000113b0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+000113c0: 7473 2e61 6374 6f72 2c20 6622 4163 746f  ts.actor, f"Acto
+000113d0: 7273 2063 616e 2774 2062 6520 696e 2060  rs can't be in `
+000113e0: 6e6f 2d77 6f72 6b65 7260 3a20 7b74 737d  no-worker`: {ts}
+000113f0: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
+00011400: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
+00011410: 756e 7275 6e6e 6162 6c65 0a0a 2020 2020  unrunnable..    
+00011420: 2020 2020 6966 2077 7320 3a3d 2073 656c      if ws := sel
+00011430: 662e 6465 6369 6465 5f77 6f72 6b65 725f  f.decide_worker_
+00011440: 6e6f 6e5f 726f 6f74 6973 6828 7473 293a  non_rootish(ts):
+00011450: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00011460: 662e 756e 7275 6e6e 6162 6c65 2e64 6973  f.unrunnable.dis
+00011470: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+00011480: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00011490: 203d 2073 656c 662e 5f61 6464 5f74 6f5f   = self._add_to_
+000114a0: 7072 6f63 6573 7369 6e67 2874 732c 2077  processing(ts, w
+000114b0: 7329 0a20 2020 2020 2020 2023 2049 6620  s).        # If 
+000114c0: 6e6f 2077 6f72 6b65 722c 2074 6173 6b20  no worker, task 
+000114d0: 6a75 7374 2073 7461 7973 2069 6e20 606e  just stays in `n
+000114e0: 6f2d 776f 726b 6572 600a 0a20 2020 2020  o-worker`..     
+000114f0: 2020 2072 6574 7572 6e20 7b7d 2c20 7b7d     return {}, {}
+00011500: 2c20 776f 726b 6572 5f6d 7367 730a 0a20  , worker_msgs.. 
+00011510: 2020 2064 6566 2064 6563 6964 655f 776f     def decide_wo
+00011520: 726b 6572 5f72 6f6f 7469 7368 5f71 7565  rker_rootish_que
+00011530: 7569 6e67 5f64 6973 6162 6c65 6428 0a20  uing_disabled(. 
+00011540: 2020 2020 2020 2073 656c 662c 2074 733a         self, ts:
+00011550: 2054 6173 6b53 7461 7465 0a20 2020 2029   TaskState.    )
+00011560: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
+00011570: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
+00011580: 2222 2250 6963 6b20 6120 776f 726b 6572  """Pick a worker
+00011590: 2066 6f72 2061 2072 756e 6e61 626c 6520   for a runnable 
+000115a0: 726f 6f74 2d69 7368 2074 6173 6b2c 2077  root-ish task, w
+000115b0: 6974 686f 7574 2071 7565 7569 6e67 2e0a  ithout queuing..
+000115c0: 0a20 2020 2020 2020 2054 6869 7320 6174  .        This at
+000115d0: 7465 6d70 7473 2074 6f20 7363 6865 6475  tempts to schedu
+000115e0: 6c65 2073 6962 6c69 6e67 2074 6173 6b73  le sibling tasks
+000115f0: 206f 6e20 7468 6520 7361 6d65 2077 6f72   on the same wor
+00011600: 6b65 722c 2072 6564 7563 696e 6720 6675  ker, reducing fu
+00011610: 7475 7265 2064 6174 610a 2020 2020 2020  ture data.      
+00011620: 2020 7472 616e 7366 6572 2e20 4974 2064    transfer. It d
+00011630: 6f65 7320 6e6f 7420 636f 6e73 6964 6572  oes not consider
+00011640: 2074 6865 206c 6f63 6174 696f 6e20 6f66   the location of
+00011650: 2064 6570 656e 6465 6e63 6965 732c 2073   dependencies, s
+00011660: 696e 6365 2074 6865 7927 6c6c 2065 6e64  ince they'll end
+00011670: 0a20 2020 2020 2020 2075 7020 6f6e 2065  .        up on e
+00011680: 7665 7279 2077 6f72 6b65 7220 616e 7977  very worker anyw
+00011690: 6179 2e0a 0a20 2020 2020 2020 2049 7420  ay...        It 
+000116a0: 6173 7375 6d65 7320 6974 2773 2062 6569  assumes it's bei
+000116b0: 6e67 2063 616c 6c65 6420 6f6e 2061 2062  ng called on a b
+000116c0: 6174 6368 206f 6620 7461 736b 7320 696e  atch of tasks in
+000116d0: 2070 7269 6f72 6974 7920 6f72 6465 722c   priority order,
+000116e0: 2061 6e64 0a20 2020 2020 2020 206d 6169   and.        mai
+000116f0: 6e74 6169 6e73 2073 7461 7465 2069 6e20  ntains state in 
+00011700: 6053 6368 6564 756c 6572 5374 6174 652e  `SchedulerState.
+00011710: 6c61 7374 5f72 6f6f 745f 776f 726b 6572  last_root_worker
+00011720: 6020 616e 640a 2020 2020 2020 2020 6053  ` and.        `S
+00011730: 6368 6564 756c 6572 5374 6174 652e 6c61  chedulerState.la
+00011740: 7374 5f72 6f6f 745f 776f 726b 6572 5f74  st_root_worker_t
+00011750: 6173 6b73 5f6c 6566 7460 2074 6f20 6163  asks_left` to ac
+00011760: 6869 6576 6520 7468 6973 2e0a 0a20 2020  hieve this...   
+00011770: 2020 2020 2054 6869 7320 7769 6c6c 2073       This will s
+00011780: 656e 6420 6576 6572 7920 7275 6e6e 6162  end every runnab
+00011790: 6c65 2074 6173 6b20 746f 2061 2077 6f72  le task to a wor
+000117a0: 6b65 722c 206f 6674 656e 2063 6175 7369  ker, often causi
+000117b0: 6e67 2072 6f6f 7420 7461 736b 0a20 2020  ng root task.   
+000117c0: 2020 2020 206f 7665 7270 726f 6475 6374       overproduct
+000117d0: 696f 6e2e 0a0a 2020 2020 2020 2020 5265  ion...        Re
+000117e0: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
+000117f0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 7773  -----.        ws
+00011800: 3a20 576f 726b 6572 5374 6174 6520 7c20  : WorkerState | 
+00011810: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00011820: 2054 6865 2077 6f72 6b65 7220 746f 2061   The worker to a
+00011830: 7373 6967 6e20 7468 6520 7461 736b 2074  ssign the task t
+00011840: 6f2e 2049 6620 7468 6572 6520 6172 6520  o. If there are 
+00011850: 6e6f 2077 6f72 6b65 7273 2069 6e20 7468  no workers in th
+00011860: 6520 636c 7573 7465 722c 0a20 2020 2020  e cluster,.     
+00011870: 2020 2020 2020 2072 6574 7572 6e73 204e         returns N
+00011880: 6f6e 652c 2069 6e20 7768 6963 6820 6361  one, in which ca
+00011890: 7365 2074 6865 2074 6173 6b20 7368 6f75  se the task shou
+000118a0: 6c64 2062 6520 7472 616e 7369 7469 6f6e  ld be transition
+000118b0: 6564 2074 6f0a 2020 2020 2020 2020 2020  ed to.          
+000118c0: 2020 6060 6e6f 2d77 6f72 6b65 7260 602e    ``no-worker``.
+000118d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000118e0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+000118f0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+00011900: 2020 2023 2053 6565 2072 6f6f 742d 6973     # See root-is
+00011910: 682d 6e65 7373 206e 6f74 6520 6265 6c6f  h-ness note belo
+00011920: 7720 696e 2060 6465 6369 6465 5f77 6f72  w in `decide_wor
+00011930: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
+00011940: 696e 675f 656e 6162 6c65 6460 0a20 2020  ing_enabled`.   
+00011950: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00011960: 6d61 7468 2e69 7369 6e66 2873 656c 662e  math.isinf(self.
+00011970: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
+00011980: 4e29 0a0a 2020 2020 2020 2020 706f 6f6c  N)..        pool
+00011990: 203d 2073 656c 662e 6964 6c65 2e76 616c   = self.idle.val
+000119a0: 7565 7328 2920 6966 2073 656c 662e 6964  ues() if self.id
+000119b0: 6c65 2065 6c73 6520 7365 6c66 2e72 756e  le else self.run
+000119c0: 6e69 6e67 0a20 2020 2020 2020 2069 6620  ning.        if 
+000119d0: 6e6f 7420 706f 6f6c 3a0a 2020 2020 2020  not pool:.      
+000119e0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+000119f0: 650a 0a20 2020 2020 2020 2074 6720 3d20  e..        tg = 
+00011a00: 7473 2e67 726f 7570 0a20 2020 2020 2020  ts.group.       
+00011a10: 206c 7773 203d 2074 672e 6c61 7374 5f77   lws = tg.last_w
+00011a20: 6f72 6b65 720a 2020 2020 2020 2020 6966  orker.        if
+00011a30: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
+00011a40: 7773 0a20 2020 2020 2020 2020 2020 2061  ws.            a
+00011a50: 6e64 2074 672e 6c61 7374 5f77 6f72 6b65  nd tg.last_worke
+00011a60: 725f 7461 736b 735f 6c65 6674 0a20 2020  r_tasks_left.   
+00011a70: 2020 2020 2020 2020 2061 6e64 206c 7773           and lws
+00011a80: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
+00011a90: 732e 7275 6e6e 696e 670a 2020 2020 2020  s.running.      
+00011aa0: 2020 2020 2020 616e 6420 7365 6c66 2e77        and self.w
+00011ab0: 6f72 6b65 7273 2e67 6574 286c 7773 2e61  orkers.get(lws.a
+00011ac0: 6464 7265 7373 2920 6973 206c 7773 0a20  ddress) is lws. 
+00011ad0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00011ae0: 2020 2020 2020 7773 203d 206c 7773 0a20        ws = lws. 
+00011af0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00011b00: 2020 2020 2020 2020 2023 204c 6173 742d           # Last-
+00011b10: 7573 6564 2077 6f72 6b65 7220 6973 2066  used worker is f
+00011b20: 756c 6c2c 2075 6e6b 6e6f 776e 2c20 7265  ull, unknown, re
+00011b30: 7469 7269 6e67 2c20 6f72 2070 6175 7365  tiring, or pause
+00011b40: 643b 0a20 2020 2020 2020 2020 2020 2023  d;.            #
+00011b50: 2070 6963 6b20 6120 6e65 7720 776f 726b   pick a new work
+00011b60: 6572 2066 6f72 2074 6865 206e 6578 7420  er for the next 
+00011b70: 6665 7720 7461 736b 730a 2020 2020 2020  few tasks.      
+00011b80: 2020 2020 2020 7773 203d 206d 696e 2870        ws = min(p
+00011b90: 6f6f 6c2c 206b 6579 3d70 6172 7469 616c  ool, key=partial
+00011ba0: 2873 656c 662e 776f 726b 6572 5f6f 626a  (self.worker_obj
+00011bb0: 6563 7469 7665 2c20 7473 2929 0a20 2020  ective, ts)).   
+00011bc0: 2020 2020 2020 2020 2074 672e 6c61 7374           tg.last
+00011bd0: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
+00011be0: 6674 203d 206d 6174 682e 666c 6f6f 7228  ft = math.floor(
+00011bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011c00: 2028 6c65 6e28 7467 2920 2f20 7365 6c66   (len(tg) / self
+00011c10: 2e74 6f74 616c 5f6e 7468 7265 6164 7329  .total_nthreads)
+00011c20: 202a 2077 732e 6e74 6872 6561 6473 0a20   * ws.nthreads. 
+00011c30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00011c40: 2020 2020 2020 2320 5265 636f 7264 2060        # Record `
+00011c50: 6c61 7374 5f77 6f72 6b65 7260 2c20 6f72  last_worker`, or
+00011c60: 2063 6c65 6172 2069 7420 6f6e 2074 6865   clear it on the
+00011c70: 2066 696e 616c 2074 6173 6b0a 2020 2020   final task.    
+00011c80: 2020 2020 7467 2e6c 6173 745f 776f 726b      tg.last_work
+00011c90: 6572 203d 2028 0a20 2020 2020 2020 2020  er = (.         
+00011ca0: 2020 2077 7320 6966 2074 672e 7374 6174     ws if tg.stat
+00011cb0: 6573 5b22 7265 6c65 6173 6564 225d 202b  es["released"] +
+00011cc0: 2074 672e 7374 6174 6573 5b22 7761 6974   tg.states["wait
+00011cd0: 696e 6722 5d20 3e20 3120 656c 7365 204e  ing"] > 1 else N
+00011ce0: 6f6e 650a 2020 2020 2020 2020 290a 2020  one.        ).  
+00011cf0: 2020 2020 2020 7467 2e6c 6173 745f 776f        tg.last_wo
+00011d00: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
+00011d10: 2d3d 2031 0a0a 2020 2020 2020 2020 6966  -= 1..        if
+00011d20: 2073 656c 662e 7661 6c69 6461 7465 2061   self.validate a
+00011d30: 6e64 2077 7320 6973 206e 6f74 204e 6f6e  nd ws is not Non
+00011d40: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00011d50: 7373 6572 7420 7365 6c66 2e77 6f72 6b65  ssert self.worke
+00011d60: 7273 2e67 6574 2877 732e 6164 6472 6573  rs.get(ws.addres
+00011d70: 7329 2069 7320 7773 0a20 2020 2020 2020  s) is ws.       
+00011d80: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
+00011d90: 6e20 7365 6c66 2e72 756e 6e69 6e67 2c20  n self.running, 
+00011da0: 2877 732c 2073 656c 662e 7275 6e6e 696e  (ws, self.runnin
+00011db0: 6729 0a0a 2020 2020 2020 2020 7265 7475  g)..        retu
+00011dc0: 726e 2077 730a 0a20 2020 2064 6566 2064  rn ws..    def d
+00011dd0: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
+00011de0: 7469 7368 5f71 7565 7569 6e67 5f65 6e61  tish_queuing_ena
+00011df0: 626c 6564 2873 656c 6629 202d 3e20 576f  bled(self) -> Wo
+00011e00: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
+00011e10: 3a0a 2020 2020 2020 2020 2222 2250 6963  :.        """Pic
+00011e20: 6b20 6120 776f 726b 6572 2066 6f72 2061  k a worker for a
+00011e30: 2072 756e 6e61 626c 6520 726f 6f74 2d69   runnable root-i
+00011e40: 7368 2074 6173 6b2c 2069 6620 6e6f 7420  sh task, if not 
+00011e50: 616c 6c20 6172 6520 6275 7379 2e0a 0a20  all are busy... 
+00011e60: 2020 2020 2020 2050 6963 6b73 2074 6865         Picks the
+00011e70: 206c 6561 7374 2d62 7573 7920 776f 726b   least-busy work
+00011e80: 6572 206f 7574 206f 6620 7468 6520 6060  er out of the ``
+00011e90: 6964 6c65 6060 2077 6f72 6b65 7273 2028  idle`` workers (
+00011ea0: 6964 6c65 2077 6f72 6b65 7273 2068 6176  idle workers hav
+00011eb0: 6520 6665 7765 720a 2020 2020 2020 2020  e fewer.        
+00011ec0: 7461 736b 7320 7275 6e6e 696e 6720 7468  tasks running th
+00011ed0: 616e 2074 6872 6561 6473 2c20 6173 2073  an threads, as s
+00011ee0: 6574 2062 7920 6060 6469 7374 7269 6275  et by ``distribu
+00011ef0: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
+00011f00: 726b 6572 2d73 6174 7572 6174 696f 6e60  rker-saturation`
+00011f10: 6029 2e0a 2020 2020 2020 2020 4974 2064  `)..        It d
+00011f20: 6f65 7320 6e6f 7420 636f 6e73 6964 6572  oes not consider
+00011f30: 2074 6865 206c 6f63 6174 696f 6e20 6f66   the location of
+00011f40: 2064 6570 656e 6465 6e63 6965 732c 2073   dependencies, s
+00011f50: 696e 6365 2074 6865 7927 6c6c 2065 6e64  ince they'll end
+00011f60: 2075 7020 6f6e 2065 7665 7279 0a20 2020   up on every.   
+00011f70: 2020 2020 2077 6f72 6b65 7220 616e 7977       worker anyw
+00011f80: 6179 2e0a 0a20 2020 2020 2020 2049 6620  ay...        If 
+00011f90: 616c 6c20 776f 726b 6572 7320 6172 6520  all workers are 
+00011fa0: 6675 6c6c 2c20 7265 7475 726e 7320 4e6f  full, returns No
+00011fb0: 6e65 2c20 6d65 616e 696e 6720 7468 6520  ne, meaning the 
+00011fc0: 7461 736b 2073 686f 756c 6420 7472 616e  task should tran
+00011fd0: 7369 7469 6f6e 2074 6f0a 2020 2020 2020  sition to.      
+00011fe0: 2020 6060 7175 6575 6564 6060 2e20 5468    ``queued``. Th
+00011ff0: 6520 7363 6865 6475 6c65 7220 7769 6c6c  e scheduler will
+00012000: 2077 6169 7420 746f 2073 656e 6420 6974   wait to send it
+00012010: 2074 6f20 6120 776f 726b 6572 2075 6e74   to a worker unt
+00012020: 696c 2061 2074 6872 6561 6420 6f70 656e  il a thread open
+00012030: 730a 2020 2020 2020 2020 7570 2e20 5468  s.        up. Th
+00012040: 6973 2065 6e73 7572 6573 2074 6861 7420  is ensures that 
+00012050: 646f 776e 7374 7265 616d 2074 6173 6b73  downstream tasks
+00012060: 2061 6c77 6179 7320 7275 6e20 6265 666f   always run befo
+00012070: 7265 206e 6577 2072 6f6f 7420 7461 736b  re new root task
+00012080: 7320 6172 650a 2020 2020 2020 2020 7374  s are.        st
+00012090: 6172 7465 642e 0a0a 2020 2020 2020 2020  arted...        
+000120a0: 5468 6973 2064 6f65 7320 6e6f 7420 7472  This does not tr
+000120b0: 7920 746f 2073 6368 6564 756c 6520 7369  y to schedule si
+000120c0: 626c 696e 6720 7461 736b 7320 6f6e 2074  bling tasks on t
+000120d0: 6865 2073 616d 6520 776f 726b 6572 3b20  he same worker; 
+000120e0: 696e 2066 6163 742c 2069 740a 2020 2020  in fact, it.    
+000120f0: 2020 2020 7573 7561 6c6c 7920 646f 6573      usually does
+00012100: 2074 6865 206f 7070 6f73 6974 652e 2045   the opposite. E
+00012110: 7665 6e20 7468 6f75 6768 2074 6869 7320  ven though this 
+00012120: 696e 6372 6561 7365 7320 7375 6273 6571  increases subseq
+00012130: 7565 6e74 2064 6174 6120 7472 616e 7366  uent data transf
+00012140: 6572 2c0a 2020 2020 2020 2020 6974 2074  er,.        it t
+00012150: 7970 6963 616c 6c79 2072 6564 7563 6573  ypically reduces
+00012160: 206f 7665 7261 6c6c 206d 656d 6f72 7920   overall memory 
+00012170: 7573 6520 6279 2065 6c69 6d69 6e61 7469  use by eliminati
+00012180: 6e67 2072 6f6f 7420 7461 736b 206f 7665  ng root task ove
+00012190: 7270 726f 6475 6374 696f 6e2e 0a0a 2020  rproduction...  
+000121a0: 2020 2020 2020 5265 7475 726e 730a 2020        Returns.  
+000121b0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
+000121c0: 2020 2020 2020 7773 3a20 576f 726b 6572        ws: Worker
+000121d0: 5374 6174 6520 7c20 4e6f 6e65 0a20 2020  State | None.   
+000121e0: 2020 2020 2020 2020 2054 6865 2077 6f72           The wor
+000121f0: 6b65 7220 746f 2061 7373 6967 6e20 7468  ker to assign th
+00012200: 6520 7461 736b 2074 6f2e 2049 6620 7468  e task to. If th
+00012210: 6572 6520 6172 6520 6e6f 2069 646c 6520  ere are no idle 
+00012220: 776f 726b 6572 732c 2072 6574 7572 6e73  workers, returns
+00012230: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
+00012240: 652c 2069 6e20 7768 6963 6820 6361 7365  e, in which case
+00012250: 2074 6865 2074 6173 6b20 7368 6f75 6c64   the task should
+00012260: 2062 6520 7472 616e 7369 7469 6f6e 6564   be transitioned
+00012270: 2074 6f20 6060 7175 6575 6564 6060 2e0a   to ``queued``..
+00012280: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00012290: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+000122a0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+000122b0: 2020 2023 2057 6520 646f 6e27 7420 6061     # We don't `a
+000122c0: 7373 6572 7420 7365 6c66 2e69 735f 726f  ssert self.is_ro
+000122d0: 6f74 6973 6828 7473 2960 2068 6572 652c  otish(ts)` here,
+000122e0: 2062 6563 6175 7365 2074 6861 7420 6368   because that ch
+000122f0: 6563 6b20 6973 0a20 2020 2020 2020 2020  eck is.         
+00012300: 2020 2023 2064 6570 656e 6465 6e74 206f     # dependent o
+00012310: 6e20 636c 7573 7465 7220 7369 7a65 2e20  n cluster size. 
+00012320: 4974 2773 2070 6f73 7369 626c 6520 6120  It's possible a 
+00012330: 7461 736b 206c 6f6f 6b65 6420 726f 6f74  task looked root
+00012340: 2d69 7368 2077 6865 6e20 6974 0a20 2020  -ish when it.   
+00012350: 2020 2020 2020 2020 2023 2077 6173 2071           # was q
+00012360: 7565 7565 642c 2062 7574 2074 6865 2063  ueued, but the c
+00012370: 6c75 7374 6572 2068 6173 2073 696e 6365  luster has since
+00012380: 2073 6361 6c65 6420 7570 2061 6e64 2069   scaled up and i
+00012390: 7420 6e6f 206c 6f6e 6765 7220 646f 6573  t no longer does
+000123a0: 2077 6865 6e0a 2020 2020 2020 2020 2020   when.          
+000123b0: 2020 2320 636f 6d69 6e67 206f 7574 206f    # coming out o
+000123c0: 6620 7468 6520 7175 6575 652e 2049 6620  f the queue. If 
+000123d0: 6069 735f 726f 6f74 6973 6860 2063 6861  `is_rootish` cha
+000123e0: 6e67 6573 2074 6f20 6120 7374 6174 6963  nges to a static
+000123f0: 2064 6566 696e 6974 696f 6e2c 0a20 2020   definition,.   
+00012400: 2020 2020 2020 2020 2023 2074 6865 6e20           # then 
+00012410: 6164 6420 7468 6174 2061 7373 6572 7469  add that asserti
+00012420: 6f6e 2068 6572 6520 2861 6e64 2061 6374  on here (and act
+00012430: 7561 6c6c 7920 7061 7373 2069 6e20 7468  ually pass in th
+00012440: 6520 7461 736b 292e 0a20 2020 2020 2020  e task)..       
+00012450: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00012460: 6d61 7468 2e69 7369 6e66 2873 656c 662e  math.isinf(self.
+00012470: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
+00012480: 4e29 0a0a 2020 2020 2020 2020 6966 206e  N)..        if n
+00012490: 6f74 2073 656c 662e 6964 6c65 5f74 6173  ot self.idle_tas
+000124a0: 6b5f 636f 756e 743a 0a20 2020 2020 2020  k_count:.       
+000124b0: 2020 2020 2023 2041 6c6c 2077 6f72 6b65       # All worke
+000124c0: 7273 2062 7573 793f 2054 6173 6b20 6765  rs busy? Task ge
+000124d0: 7473 2f73 7461 7973 2071 7565 7565 642e  ts/stays queued.
+000124e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000124f0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
+00012500: 2020 2320 4a75 7374 2070 6963 6b20 7468    # Just pick th
+00012510: 6520 6c65 6173 7420 6275 7379 2077 6f72  e least busy wor
+00012520: 6b65 722e 0a20 2020 2020 2020 2023 204e  ker..        # N
+00012530: 4f54 453a 2074 6869 7320 7769 6c6c 206c  OTE: this will l
+00012540: 6561 6420 746f 2077 6f72 7374 2d63 6173  ead to worst-cas
+00012550: 6520 7363 6865 6475 6c69 6e67 2077 6974  e scheduling wit
+00012560: 6820 7265 6761 7264 7320 746f 2063 6f2d  h regards to co-
+00012570: 6173 7369 676e 6d65 6e74 2e0a 2020 2020  assignment..    
+00012580: 2020 2020 7773 203d 206d 696e 280a 2020      ws = min(.  
+00012590: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
+000125a0: 646c 655f 7461 736b 5f63 6f75 6e74 2c0a  dle_task_count,.
+000125b0: 2020 2020 2020 2020 2020 2020 6b65 793d              key=
+000125c0: 6c61 6d62 6461 2077 733a 206c 656e 2877  lambda ws: len(w
+000125d0: 732e 7072 6f63 6573 7369 6e67 2920 2f20  s.processing) / 
+000125e0: 7773 2e6e 7468 7265 6164 732c 0a20 2020  ws.nthreads,.   
+000125f0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+00012600: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00012610: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00012620: 6572 7420 6e6f 7420 5f77 6f72 6b65 725f  ert not _worker_
+00012630: 6675 6c6c 2877 732c 2073 656c 662e 574f  full(ws, self.WO
+00012640: 524b 4552 5f53 4154 5552 4154 494f 4e29  RKER_SATURATION)
+00012650: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00012660: 2020 2020 7773 2c0a 2020 2020 2020 2020      ws,.        
+00012670: 2020 2020 2020 2020 5f74 6173 6b5f 736c          _task_sl
+00012680: 6f74 735f 6176 6169 6c61 626c 6528 7773  ots_available(ws
+00012690: 2c20 7365 6c66 2e57 4f52 4b45 525f 5341  , self.WORKER_SA
+000126a0: 5455 5241 5449 4f4e 292c 0a20 2020 2020  TURATION),.     
+000126b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000126c0: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
+000126d0: 6e20 7365 6c66 2e72 756e 6e69 6e67 2c20  n self.running, 
+000126e0: 2877 732c 2073 656c 662e 7275 6e6e 696e  (ws, self.runnin
+000126f0: 6729 0a0a 2020 2020 2020 2020 6966 2073  g)..        if s
+00012700: 656c 662e 7661 6c69 6461 7465 2061 6e64  elf.validate and
+00012710: 2077 7320 6973 206e 6f74 204e 6f6e 653a   ws is not None:
+00012720: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00012730: 6572 7420 7365 6c66 2e77 6f72 6b65 7273  ert self.workers
+00012740: 2e67 6574 2877 732e 6164 6472 6573 7329  .get(ws.address)
+00012750: 2069 7320 7773 0a20 2020 2020 2020 2020   is ws.         
+00012760: 2020 2061 7373 6572 7420 7773 2069 6e20     assert ws in 
+00012770: 7365 6c66 2e72 756e 6e69 6e67 2c20 2877  self.running, (w
+00012780: 732c 2073 656c 662e 7275 6e6e 696e 6729  s, self.running)
+00012790: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000127a0: 2077 730a 0a20 2020 2064 6566 2064 6563   ws..    def dec
+000127b0: 6964 655f 776f 726b 6572 5f6e 6f6e 5f72  ide_worker_non_r
+000127c0: 6f6f 7469 7368 2873 656c 662c 2074 733a  ootish(self, ts:
+000127d0: 2054 6173 6b53 7461 7465 2920 2d3e 2057   TaskState) -> W
+000127e0: 6f72 6b65 7253 7461 7465 207c 204e 6f6e  orkerState | Non
+000127f0: 653a 0a20 2020 2020 2020 2022 2222 5069  e:.        """Pi
+00012800: 636b 2061 2077 6f72 6b65 7220 666f 7220  ck a worker for 
+00012810: 6120 7275 6e6e 6162 6c65 206e 6f6e 2d72  a runnable non-r
+00012820: 6f6f 7420 7461 736b 2c20 636f 6e73 6964  oot task, consid
+00012830: 6572 696e 6720 6465 7065 6e64 656e 6369  ering dependenci
+00012840: 6573 2061 6e64 0a20 2020 2020 2020 2072  es and.        r
+00012850: 6573 7472 6963 7469 6f6e 732e 0a0a 2020  estrictions...  
+00012860: 2020 2020 2020 4f75 7420 6f66 2065 6c69        Out of eli
+00012870: 6769 626c 6520 776f 726b 6572 7320 686f  gible workers ho
+00012880: 6c64 696e 6720 6465 7065 6e64 656e 6369  lding dependenci
+00012890: 6573 206f 6620 6060 7473 6060 2c20 7365  es of ``ts``, se
+000128a0: 6c65 6374 7320 7468 6520 776f 726b 6572  lects the worker
+000128b0: 0a20 2020 2020 2020 2077 6865 7265 2c20  .        where, 
+000128c0: 636f 6e73 6964 6572 696e 6720 776f 726b  considering work
+000128d0: 6572 2062 6163 6b6c 6f6e 6720 616e 6420  er backlong and 
+000128e0: 6461 7461 2d74 7261 6e73 6665 7220 636f  data-transfer co
+000128f0: 7374 732c 2074 6865 2074 6173 6b20 6973  sts, the task is
+00012900: 0a20 2020 2020 2020 2065 7374 696d 6174  .        estimat
+00012910: 6564 2074 6f20 7374 6172 7420 7275 6e6e  ed to start runn
+00012920: 696e 6720 7468 6520 736f 6f6e 6573 742e  ing the soonest.
+00012930: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00012940: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00012950: 2d0a 2020 2020 2020 2020 7773 3a20 576f  -.        ws: Wo
+00012960: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
+00012970: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00012980: 2077 6f72 6b65 7220 746f 2061 7373 6967   worker to assig
+00012990: 6e20 7468 6520 7461 736b 2074 6f2e 2049  n the task to. I
+000129a0: 6620 6e6f 2077 6f72 6b65 7273 2073 6174  f no workers sat
+000129b0: 6973 6679 2074 6865 2072 6573 7472 6963  isfy the restric
+000129c0: 7469 6f6e 7320 6f66 0a20 2020 2020 2020  tions of.       
+000129d0: 2020 2020 2060 6074 7360 6020 6f72 2074       ``ts`` or t
+000129e0: 6865 7265 2061 7265 206e 6f20 7275 6e6e  here are no runn
+000129f0: 696e 6720 776f 726b 6572 732c 2072 6574  ing workers, ret
+00012a00: 7572 6e73 204e 6f6e 652c 2069 6e20 7768  urns None, in wh
+00012a10: 6963 6820 6361 7365 2074 6865 2074 6173  ich case the tas
+00012a20: 6b0a 2020 2020 2020 2020 2020 2020 7368  k.            sh
+00012a30: 6f75 6c64 2062 6520 7472 616e 7369 7469  ould be transiti
+00012a40: 6f6e 6564 2074 6f20 6060 6e6f 2d77 6f72  oned to ``no-wor
+00012a50: 6b65 7260 602e 0a20 2020 2020 2020 2022  ker``..        "
+00012a60: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+00012a70: 7420 7365 6c66 2e72 756e 6e69 6e67 3a0a  t self.running:.
+00012a80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012a90: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
+00012aa0: 2076 616c 6964 5f77 6f72 6b65 7273 203d   valid_workers =
+00012ab0: 2073 656c 662e 7661 6c69 645f 776f 726b   self.valid_work
+00012ac0: 6572 7328 7473 290a 2020 2020 2020 2020  ers(ts).        
+00012ad0: 6966 2076 616c 6964 5f77 6f72 6b65 7273  if valid_workers
+00012ae0: 2069 7320 4e6f 6e65 2061 6e64 206c 656e   is None and len
+00012af0: 2873 656c 662e 7275 6e6e 696e 6729 203c  (self.running) <
+00012b00: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
+00012b10: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00012b20: 6966 206e 6f74 2073 656c 662e 7275 6e6e  if not self.runn
+00012b30: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00012b40: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00012b50: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00012b60: 4966 2074 6865 7265 2077 6572 6520 6e6f  If there were no
+00012b70: 2072 6573 7472 6963 7469 6f6e 732c 2060   restrictions, `
+00012b80: 7661 6c69 645f 776f 726b 6572 7328 2960  valid_workers()`
+00012b90: 2064 6964 6e27 7420 7375 6273 6574 2062   didn't subset b
+00012ba0: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
+00012bb0: 6072 756e 6e69 6e67 602e 0a20 2020 2020  `running`..     
+00012bc0: 2020 2020 2020 2076 616c 6964 5f77 6f72         valid_wor
+00012bd0: 6b65 7273 203d 2073 656c 662e 7275 6e6e  kers = self.runn
+00012be0: 696e 670a 0a20 2020 2020 2020 2069 6620  ing..        if 
+00012bf0: 7473 2e64 6570 656e 6465 6e63 6965 7320  ts.dependencies 
+00012c00: 6f72 2076 616c 6964 5f77 6f72 6b65 7273  or valid_workers
+00012c10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00012c20: 2020 2020 2020 2020 2020 7773 203d 2064            ws = d
+00012c30: 6563 6964 655f 776f 726b 6572 280a 2020  ecide_worker(.  
+00012c40: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00012c50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012c60: 2020 7365 6c66 2e72 756e 6e69 6e67 2c0a    self.running,.
+00012c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c80: 7661 6c69 645f 776f 726b 6572 732c 0a20  valid_workers,. 
+00012c90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00012ca0: 6172 7469 616c 2873 656c 662e 776f 726b  artial(self.work
+00012cb0: 6572 5f6f 626a 6563 7469 7665 2c20 7473  er_objective, ts
+00012cc0: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+00012cd0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00012ce0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+00012cf0: 4f20 6966 2060 6973 5f72 6f6f 7469 7368  O if `is_rootish
+00012d00: 6020 776f 756c 6420 616c 7761 7973 2072  ` would always r
+00012d10: 6574 7572 6e20 5472 7565 2066 6f72 2074  eturn True for t
+00012d20: 6173 6b73 2077 6974 686f 7574 0a20 2020  asks without.   
+00012d30: 2020 2020 2020 2020 2023 2064 6570 656e           # depen
+00012d40: 6465 6e63 6965 732c 2077 6520 636f 756c  dencies, we coul
+00012d50: 6420 7265 6d6f 7665 2061 6c6c 2074 6869  d remove all thi
+00012d60: 7320 6c6f 6769 632e 2054 6865 2072 6f6f  s logic. The roo
+00012d70: 7469 7368 2061 7373 6967 6e6d 656e 7420  tish assignment 
+00012d80: 6c6f 6769 630a 2020 2020 2020 2020 2020  logic.          
+00012d90: 2020 2320 776f 756c 6420 6265 6861 7665    # would behave
+00012da0: 206d 6f72 6520 6f72 206c 6573 7320 7468   more or less th
+00012db0: 6520 7361 6d65 2061 7320 7468 6973 2c20  e same as this, 
+00012dc0: 6d61 7962 6520 7769 7468 6f75 7420 6775  maybe without gu
+00012dd0: 6172 616e 7465 6564 0a20 2020 2020 2020  aranteed.       
+00012de0: 2020 2020 2023 2072 6f75 6e64 2d72 6f62       # round-rob
+00012df0: 696e 2074 686f 7567 683f 2054 6869 7320  in though? This 
+00012e00: 7061 7468 2069 7320 6f6e 6c79 2072 6561  path is only rea
+00012e10: 6368 6162 6c65 2077 6865 6e20 6074 7360  chable when `ts`
+00012e20: 2064 6f65 736e 2774 2068 6176 650a 2020   doesn't have.  
+00012e30: 2020 2020 2020 2020 2020 2320 6465 7065            # depe
+00012e40: 6e64 656e 6369 6573 2c20 6275 7420 6974  ndencies, but it
+00012e50: 7320 6772 6f75 7020 6973 2061 6c73 6f20  s group is also 
+00012e60: 736d 616c 6c65 7220 7468 616e 2074 6865  smaller than the
+00012e70: 2063 6c75 7374 6572 2e0a 0a20 2020 2020   cluster...     
+00012e80: 2020 2020 2020 2023 2046 6173 7470 6174         # Fastpat
+00012e90: 6820 7768 656e 2074 6865 7265 2061 7265  h when there are
+00012ea0: 206e 6f20 7265 6c61 7465 6420 7461 736b   no related task
+00012eb0: 7320 6f72 2072 6573 7472 6963 7469 6f6e  s or restriction
+00012ec0: 730a 2020 2020 2020 2020 2020 2020 776f  s.            wo
+00012ed0: 726b 6572 5f70 6f6f 6c20 3d20 7365 6c66  rker_pool = self
+00012ee0: 2e69 646c 6520 6f72 2073 656c 662e 776f  .idle or self.wo
+00012ef0: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
+00012f00: 2020 2320 4649 584d 4520 6964 6c65 2061    # FIXME idle a
+00012f10: 6e64 2077 6f72 6b65 7273 2061 7265 2053  nd workers are S
+00012f20: 6f72 7465 6444 6963 7427 7320 6465 636c  ortedDict's decl
+00012f30: 6172 6564 2061 7320 6469 6374 730a 2020  ared as dicts.  
+00012f40: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00012f50: 2020 6265 6361 7573 6520 736f 7274 6564    because sorted
+00012f60: 636f 6e74 6169 6e65 7273 2069 7320 6e6f  containers is no
+00012f70: 7420 616e 6e6f 7461 7465 640a 2020 2020  t annotated.    
+00012f80: 2020 2020 2020 2020 7770 5f76 616c 7320          wp_vals 
+00012f90: 3d20 6361 7374 2822 5365 7175 656e 6365  = cast("Sequence
+00012fa0: 5b57 6f72 6b65 7253 7461 7465 5d22 2c20  [WorkerState]", 
+00012fb0: 776f 726b 6572 5f70 6f6f 6c2e 7661 6c75  worker_pool.valu
+00012fc0: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
+00012fd0: 2020 6e5f 776f 726b 6572 7320 3d20 6c65    n_workers = le
+00012fe0: 6e28 7770 5f76 616c 7329 0a20 2020 2020  n(wp_vals).     
+00012ff0: 2020 2020 2020 2069 6620 6e5f 776f 726b         if n_work
+00013000: 6572 7320 3c20 3230 3a20 2023 2073 6d61  ers < 20:  # sma
+00013010: 7274 2062 7574 206c 696e 6561 7220 696e  rt but linear in
+00013020: 2073 6d61 6c6c 2063 6173 650a 2020 2020   small case.    
+00013030: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
+00013040: 206d 696e 2877 705f 7661 6c73 2c20 6b65   min(wp_vals, ke
+00013050: 793d 6f70 6572 6174 6f72 2e61 7474 7267  y=operator.attrg
+00013060: 6574 7465 7228 226f 6363 7570 616e 6379  etter("occupancy
+00013070: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+00013080: 2020 2020 6173 7365 7274 2077 730a 2020      assert ws.  
+00013090: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000130a0: 2077 732e 6f63 6375 7061 6e63 7920 3d3d   ws.occupancy ==
+000130b0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000130c0: 2020 2020 2020 2020 2320 7370 6563 6961          # specia
+000130d0: 6c20 6361 7365 2074 6f20 7573 6520 726f  l case to use ro
+000130e0: 756e 642d 726f 6269 6e3b 206c 696e 6561  und-robin; linea
+000130f0: 7220 7365 6172 6368 0a20 2020 2020 2020  r search.       
+00013100: 2020 2020 2020 2020 2020 2020 2023 2066               # f
+00013110: 6f72 206e 6578 7420 776f 726b 6572 2077  or next worker w
+00013120: 6974 6820 7a65 726f 206f 6363 7570 616e  ith zero occupan
+00013130: 6379 2028 6f72 206a 7573 740a 2020 2020  cy (or just.    
+00013140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013150: 2320 6c61 6e64 2062 6163 6b20 7768 6572  # land back wher
+00013160: 6520 7765 2073 7461 7274 6564 292e 0a20  e we started).. 
+00013170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013180: 2020 2073 7461 7274 203d 2073 656c 662e     start = self.
+00013190: 6e5f 7461 736b 7320 2520 6e5f 776f 726b  n_tasks % n_work
+000131a0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+000131b0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+000131c0: 2072 616e 6765 286e 5f77 6f72 6b65 7273   range(n_workers
+000131d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000131e0: 2020 2020 2020 2020 2020 2077 705f 6920             wp_i 
+000131f0: 3d20 7770 5f76 616c 735b 2869 202b 2073  = wp_vals[(i + s
+00013200: 7461 7274 2920 2520 6e5f 776f 726b 6572  tart) % n_worker
+00013210: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
+00013220: 2020 2020 2020 2020 2020 2069 6620 7770             if wp
+00013230: 5f69 2e6f 6363 7570 616e 6379 203d 3d20  _i.occupancy == 
+00013240: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00013250: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00013260: 7320 3d20 7770 5f69 0a20 2020 2020 2020  s = wp_i.       
+00013270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013280: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
+00013290: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
+000132a0: 6475 6d62 2062 7574 2066 6173 7420 696e  dumb but fast in
+000132b0: 206c 6172 6765 2063 6173 650a 2020 2020   large case.    
+000132c0: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
+000132d0: 2077 705f 7661 6c73 5b73 656c 662e 6e5f   wp_vals[self.n_
+000132e0: 7461 736b 7320 2520 6e5f 776f 726b 6572  tasks % n_worker
+000132f0: 735d 0a0a 2020 2020 2020 2020 6966 2073  s]..        if s
+00013300: 656c 662e 7661 6c69 6461 7465 2061 6e64  elf.validate and
+00013310: 2077 7320 6973 206e 6f74 204e 6f6e 653a   ws is not None:
+00013320: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00013330: 6572 7420 7365 6c66 2e77 6f72 6b65 7273  ert self.workers
+00013340: 2e67 6574 2877 732e 6164 6472 6573 7329  .get(ws.address)
+00013350: 2069 7320 7773 0a20 2020 2020 2020 2020   is ws.         
+00013360: 2020 2061 7373 6572 7420 7773 2069 6e20     assert ws in 
+00013370: 7365 6c66 2e72 756e 6e69 6e67 2c20 2877  self.running, (w
+00013380: 732c 2073 656c 662e 7275 6e6e 696e 6729  s, self.running)
+00013390: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000133a0: 2077 730a 0a20 2020 2064 6566 2074 7261   ws..    def tra
+000133b0: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
+000133c0: 7072 6f63 6573 7369 6e67 2873 656c 662c  processing(self,
+000133d0: 206b 6579 3a20 7374 722c 2073 7469 6d75   key: str, stimu
+000133e0: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
+000133f0: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
+00013400: 2020 2222 2250 6f73 7369 626c 7920 7363    """Possibly sc
+00013410: 6865 6475 6c65 2061 2072 6561 6479 2074  hedule a ready t
+00013420: 6173 6b2e 2054 6869 7320 6973 2074 6865  ask. This is the
+00013430: 2070 7269 6d61 7279 2064 6973 7061 7463   primary dispatc
+00013440: 6820 666f 7220 7265 6164 7920 7461 736b  h for ready task
+00013450: 732e 0a0a 2020 2020 2020 2020 4966 2074  s...        If t
+00013460: 6865 7265 2773 206e 6f20 6170 7072 6f70  here's no approp
+00013470: 7269 6174 6520 776f 726b 6572 2066 6f72  riate worker for
+00013480: 2074 6865 2074 6173 6b20 2862 7574 2074   the task (but t
+00013490: 6865 2074 6173 6b20 6973 206f 7468 6572  he task is other
+000134a0: 7769 7365 0a20 2020 2020 2020 2072 756e  wise.        run
+000134b0: 6e61 626c 6529 2c20 6974 2077 696c 6c20  nable), it will 
+000134c0: 6265 2072 6563 6f6d 6d65 6e64 6564 2074  be recommended t
+000134d0: 6f20 6060 6e6f 2d77 6f72 6b65 7260 6020  o ``no-worker`` 
+000134e0: 6f72 2060 6071 7565 7565 6460 602e 0a20  or ``queued``.. 
+000134f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00013500: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00013510: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
+00013520: 2069 6620 7365 6c66 2e69 735f 726f 6f74   if self.is_root
+00013530: 6973 6828 7473 293a 0a20 2020 2020 2020  ish(ts):.       
+00013540: 2020 2020 2023 204e 4f54 453a 2068 6176       # NOTE: hav
+00013550: 696e 6720 7477 6f20 726f 6f74 2d69 7368  ing two root-ish
+00013560: 206d 6574 686f 6473 2069 7320 7465 6d70   methods is temp
+00013570: 6f72 6172 792e 2057 6865 6e20 7468 6520  orary. When the 
+00013580: 6665 6174 7572 6520 666c 6167 2069 730a  feature flag is.
+00013590: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+000135a0: 6d6f 7665 642c 2074 6865 7265 2073 686f  moved, there sho
+000135b0: 756c 6420 6f6e 6c79 2062 6520 6f6e 652c  uld only be one,
+000135c0: 2077 6869 6368 2063 6f6d 6269 6e65 7320   which combines 
+000135d0: 636f 2d61 7373 6967 6e6d 656e 7420 616e  co-assignment an
+000135e0: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+000135f0: 7175 6575 696e 672e 2045 7665 6e74 7561  queuing. Eventua
+00013600: 6c6c 792c 2073 7065 6369 616c 2d63 6173  lly, special-cas
+00013610: 696e 6720 726f 6f74 2074 6173 6b73 206d  ing root tasks m
+00013620: 6967 6874 2062 6520 7265 6d6f 7665 6420  ight be removed 
+00013630: 656e 7469 7265 6c79 2c0a 2020 2020 2020  entirely,.      
+00013640: 2020 2020 2020 2320 7769 7468 2062 6574        # with bet
+00013650: 7465 7220 6865 7572 6973 7469 6373 2e0a  ter heuristics..
+00013660: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00013670: 6174 682e 6973 696e 6628 7365 6c66 2e57  ath.isinf(self.W
+00013680: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+00013690: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000136a0: 2020 2069 6620 6e6f 7420 2877 7320 3a3d     if not (ws :=
+000136b0: 2073 656c 662e 6465 6369 6465 5f77 6f72   self.decide_wor
+000136c0: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
+000136d0: 696e 675f 6469 7361 626c 6564 2874 7329  ing_disabled(ts)
+000136e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000136f0: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
+00013700: 732e 6b65 793a 2022 6e6f 2d77 6f72 6b65  s.key: "no-worke
+00013710: 7222 7d2c 207b 7d2c 207b 7d0a 2020 2020  r"}, {}, {}.    
+00013720: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00013730: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00013740: 206e 6f74 2028 7773 203a 3d20 7365 6c66   not (ws := self
+00013750: 2e64 6563 6964 655f 776f 726b 6572 5f72  .decide_worker_r
+00013760: 6f6f 7469 7368 5f71 7565 7569 6e67 5f65  ootish_queuing_e
+00013770: 6e61 626c 6564 2829 293a 0a20 2020 2020  nabled()):.     
+00013780: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00013790: 6574 7572 6e20 7b74 732e 6b65 793a 2022  eturn {ts.key: "
+000137a0: 7175 6575 6564 227d 2c20 7b7d 2c20 7b7d  queued"}, {}, {}
+000137b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000137c0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+000137d0: 7420 2877 7320 3a3d 2073 656c 662e 6465  t (ws := self.de
+000137e0: 6369 6465 5f77 6f72 6b65 725f 6e6f 6e5f  cide_worker_non_
+000137f0: 726f 6f74 6973 6828 7473 2929 3a0a 2020  rootish(ts)):.  
+00013800: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00013810: 7475 726e 207b 7473 2e6b 6579 3a20 226e  turn {ts.key: "n
+00013820: 6f2d 776f 726b 6572 227d 2c20 7b7d 2c20  o-worker"}, {}, 
+00013830: 7b7d 0a0a 2020 2020 2020 2020 776f 726b  {}..        work
+00013840: 6572 5f6d 7367 7320 3d20 7365 6c66 2e5f  er_msgs = self._
+00013850: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
+00013860: 6728 7473 2c20 7773 290a 2020 2020 2020  g(ts, ws).      
+00013870: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
+00013880: 2077 6f72 6b65 725f 6d73 6773 0a0a 2020   worker_msgs..  
+00013890: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+000138a0: 5f77 6169 7469 6e67 5f6d 656d 6f72 7928  _waiting_memory(
+000138b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+000138c0: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
+000138d0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+000138e0: 735f 6964 3a20 7374 722c 0a20 2020 2020  s_id: str,.     
+000138f0: 2020 202a 2c0a 2020 2020 2020 2020 6e62     *,.        nb
+00013900: 7974 6573 3a20 696e 7420 7c20 4e6f 6e65  ytes: int | None
+00013910: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00013920: 2074 7970 653a 2062 7974 6573 207c 204e   type: bytes | N
+00013930: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00013940: 2020 2020 7479 7065 6e61 6d65 3a20 7374      typename: st
+00013950: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+00013960: 0a20 2020 2020 2020 2077 6f72 6b65 723a  .        worker:
+00013970: 2073 7472 2c0a 2020 2020 2020 2020 2a2a   str,.        **
+00013980: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
+00013990: 2029 202d 3e20 5265 6373 4d73 6773 3a0a   ) -> RecsMsgs:.
+000139a0: 2020 2020 2020 2020 2222 2254 6869 7320          """This 
+000139b0: 7472 616e 7369 7469 6f6e 2065 7863 6c75  transition exclu
+000139c0: 7369 7665 6c79 2068 6170 7065 6e73 2069  sively happens i
+000139d0: 6e20 6120 7261 6365 2063 6f6e 6469 7469  n a race conditi
+000139e0: 6f6e 2077 6865 7265 2074 6865 2073 6368  on where the sch
+000139f0: 6564 756c 6572 0a20 2020 2020 2020 2062  eduler.        b
+00013a00: 656c 6965 7665 7320 7468 6174 2074 6865  elieves that the
+00013a10: 206f 6e6c 7920 636f 7079 206f 6620 6120   only copy of a 
+00013a20: 6465 7065 6e64 656e 6379 2074 6173 6b20  dependency task 
+00013a30: 6861 7320 6a75 7374 2062 6565 6e20 6c6f  has just been lo
+00013a40: 7374 2c20 736f 2069 740a 2020 2020 2020  st, so it.      
+00013a50: 2020 7472 616e 7369 7469 6f6e 7320 616c    transitions al
+00013a60: 6c20 6465 7065 6e64 656e 7473 2062 6163  l dependents bac
+00013a70: 6b20 746f 2077 6169 7469 6e67 2c20 6275  k to waiting, bu
+00013a80: 7420 6163 7475 616c 6c79 2061 2072 6570  t actually a rep
+00013a90: 6c69 6361 2068 6173 2061 6c72 6561 6479  lica has already
+00013aa0: 0a20 2020 2020 2020 2062 6565 6e20 6163  .        been ac
+00013ab0: 7175 6972 6564 2062 7920 6120 776f 726b  quired by a work
+00013ac0: 6572 2063 6f6d 7075 7469 6e67 2074 6865  er computing the
+00013ad0: 2064 6570 656e 6465 6e63 7920 2d20 7468   dependency - th
+00013ae0: 6520 7363 6865 6475 6c65 7220 6a75 7374  e scheduler just
+00013af0: 2064 6f65 736e 2774 0a20 2020 2020 2020   doesn't.       
+00013b00: 206b 6e6f 7720 7965 7420 2d20 616e 6420   know yet - and 
+00013b10: 7468 6520 6578 6563 7574 696f 6e20 6669  the execution fi
+00013b20: 6e69 7368 6573 2062 6566 6f72 6520 7468  nishes before th
+00013b30: 6520 6361 6e63 656c 6c61 7469 6f6e 206d  e cancellation m
+00013b40: 6573 7361 6765 2066 726f 6d20 7468 650a  essage from the.
+00013b50: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+00013b60: 7220 6861 7320 6120 6368 616e 6365 2074  r has a chance t
+00013b70: 6f20 7265 6163 6820 7468 6520 776f 726b  o reach the work
+00013b80: 6572 2e20 5368 6f72 746c 792c 2074 6865  er. Shortly, the
+00013b90: 2063 616e 6365 6c6c 6174 696f 6e20 7265   cancellation re
+00013ba0: 7175 6573 740a 2020 2020 2020 2020 7769  quest.        wi
+00013bb0: 6c6c 2072 6561 6368 2074 6865 2077 6f72  ll reach the wor
+00013bc0: 6b65 722c 2074 6875 7320 6465 6c65 7469  ker, thus deleti
+00013bd0: 6e67 2074 6865 2064 6174 6120 6672 6f6d  ng the data from
+00013be0: 206d 656d 6f72 792e 0a20 2020 2020 2020   memory..       
+00013bf0: 2022 2222 0a20 2020 2020 2020 2074 7320   """.        ts 
+00013c00: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00013c10: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+00013c20: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00013c30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00013c40: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
+00013c50: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
+00013c60: 2061 7373 6572 7420 7473 2e77 6169 7469   assert ts.waiti
+00013c70: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+00013c80: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+00013c90: 6520 3d3d 2022 7761 6974 696e 6722 0a0a  e == "waiting"..
+00013ca0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00013cb0: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2064  }, {}, {}..    d
+00013cc0: 6566 2074 7261 6e73 6974 696f 6e5f 7072  ef transition_pr
+00013cd0: 6f63 6573 7369 6e67 5f6d 656d 6f72 7928  ocessing_memory(
+00013ce0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00013cf0: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
+00013d00: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+00013d10: 735f 6964 3a20 7374 722c 0a20 2020 2020  s_id: str,.     
+00013d20: 2020 202a 2c0a 2020 2020 2020 2020 6e62     *,.        nb
+00013d30: 7974 6573 3a20 696e 7420 7c20 4e6f 6e65  ytes: int | None
+00013d40: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00013d50: 2074 7970 653a 2062 7974 6573 207c 204e   type: bytes | N
+00013d60: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00013d70: 2020 2020 7479 7065 6e61 6d65 3a20 7374      typename: st
+00013d80: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+00013d90: 0a20 2020 2020 2020 2077 6f72 6b65 723a  .        worker:
+00013da0: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
+00013db0: 6172 7473 746f 7073 3a20 6c69 7374 5b64  artstops: list[d
+00013dc0: 6963 745d 207c 204e 6f6e 6520 3d20 4e6f  ict] | None = No
+00013dd0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+00013de0: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
+00013df0: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
+00013e00: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00013e10: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
+00013e20: 2020 2020 6173 7365 7274 2077 6f72 6b65      assert worke
+00013e30: 720a 2020 2020 2020 2020 6173 7365 7274  r.        assert
+00013e40: 2069 7369 6e73 7461 6e63 6528 776f 726b   isinstance(work
+00013e50: 6572 2c20 7374 7229 0a0a 2020 2020 2020  er, str)..      
+00013e60: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00013e70: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00013e80: 6173 7365 7274 2074 732e 7072 6f63 6573  assert ts.proces
+00013e90: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+00013ea0: 2020 2020 7773 7320 3d20 7473 2e70 726f      wss = ts.pro
+00013eb0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+00013ec0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+00013ed0: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00013ee0: 7365 7274 2074 7320 696e 2077 7373 2e70  sert ts in wss.p
+00013ef0: 726f 6365 7373 696e 670a 2020 2020 2020  rocessing.      
+00013f00: 2020 2020 2020 6465 6c20 7773 730a 2020        del wss.  
+00013f10: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00013f20: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+00013f30: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
+00013f40: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+00013f50: 5f68 6173 2c20 2874 732c 2074 732e 7768  _has, (ts, ts.wh
+00013f60: 6f5f 6861 7329 0a20 2020 2020 2020 2020  o_has).         
+00013f70: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00013f80: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+00013f90: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00013fa0: 6572 7420 7473 2e73 7461 7465 203d 3d20  ert ts.state == 
+00013fb0: 2270 726f 6365 7373 696e 6722 0a0a 2020  "processing"..  
+00013fc0: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
+00013fd0: 776f 726b 6572 732e 6765 7428 776f 726b  workers.get(work
+00013fe0: 6572 290a 2020 2020 2020 2020 6966 2077  er).        if w
+00013ff0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00014000: 2020 2020 2020 2072 6574 7572 6e20 7b6b         return {k
+00014010: 6579 3a20 2272 656c 6561 7365 6422 7d2c  ey: "released"},
+00014020: 207b 7d2c 207b 7d0a 0a20 2020 2020 2020   {}, {}..       
+00014030: 2069 6620 7773 2021 3d20 7473 2e70 726f   if ws != ts.pro
+00014040: 6365 7373 696e 675f 6f6e 3a20 2023 2070  cessing_on:  # p
+00014050: 7261 676d 613a 206e 6f63 6f76 6572 0a20  ragma: nocover. 
+00014060: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00014070: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+00014080: 6f6e 0a20 2020 2020 2020 2020 2020 2072  on.            r
+00014090: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+000140a0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000140b0: 2020 2066 2254 6173 6b20 7b74 732e 6b65     f"Task {ts.ke
+000140c0: 7921 727d 2074 7261 6e73 6974 696f 6e65  y!r} transitione
+000140d0: 6420 6672 6f6d 2070 726f 6365 7373 696e  d from processin
+000140e0: 6720 746f 206d 656d 6f72 7920 6f6e 2077  g to memory on w
+000140f0: 6f72 6b65 7220 220a 2020 2020 2020 2020  orker ".        
+00014100: 2020 2020 2020 2020 6622 7b77 737d 2c20          f"{ws}, 
+00014110: 7768 696c 6520 6974 2077 6173 2065 7870  while it was exp
+00014120: 6563 7465 6420 6672 6f6d 207b 7473 2e70  ected from {ts.p
+00014130: 726f 6365 7373 696e 675f 6f6e 7d2e 2054  rocessing_on}. T
+00014140: 6869 7320 7368 6f75 6c64 2022 0a20 2020  his should ".   
+00014150: 2020 2020 2020 2020 2020 2020 2066 2262               f"b
+00014160: 6520 696d 706f 7373 6962 6c65 2e20 7b73  e impossible. {s
+00014170: 7469 6d75 6c75 735f 6964 3d7d 2c20 7374  timulus_id=}, st
+00014180: 6f72 793d 7b73 656c 662e 7374 6f72 7928  ory={self.story(
+00014190: 7473 297d 220a 2020 2020 2020 2020 2020  ts)}".          
+000141a0: 2020 290a 0a20 2020 2020 2020 2023 2323    )..        ###
+000141b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000141c0: 2323 2323 2323 2323 2323 0a20 2020 2020  ##########.     
+000141d0: 2020 2023 2055 7064 6174 6520 5469 6d69     # Update Timi
+000141e0: 6e67 2049 6e66 6f72 6d61 7469 6f6e 2023  ng Information #
+000141f0: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+00014200: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014210: 2323 2323 2323 0a20 2020 2020 2020 2069  ######.        i
+00014220: 6620 7374 6172 7473 746f 7073 3a0a 2020  f startstops:.  
+00014230: 2020 2020 2020 2020 2020 666f 7220 7374            for st
+00014240: 6172 7473 746f 7020 696e 2073 7461 7274  artstop in start
+00014250: 7374 6f70 733a 0a20 2020 2020 2020 2020  stops:.         
+00014260: 2020 2020 2020 2074 732e 6772 6f75 702e         ts.group.
+00014270: 6164 645f 6475 7261 7469 6f6e 280a 2020  add_duration(.  
+00014280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014290: 2020 7374 6f70 3d73 7461 7274 7374 6f70    stop=startstop
+000142a0: 5b22 7374 6f70 225d 2c0a 2020 2020 2020  ["stop"],.      
+000142b0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000142c0: 6172 743d 7374 6172 7473 746f 705b 2273  art=startstop["s
+000142d0: 7461 7274 225d 2c0a 2020 2020 2020 2020  tart"],.        
+000142e0: 2020 2020 2020 2020 2020 2020 6163 7469              acti
+000142f0: 6f6e 3d73 7461 7274 7374 6f70 5b22 6163  on=startstop["ac
+00014300: 7469 6f6e 225d 2c0a 2020 2020 2020 2020  tion"],.        
+00014310: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00014320: 2020 2073 203d 2073 656c 662e 756e 6b6e     s = self.unkn
+00014330: 6f77 6e5f 6475 7261 7469 6f6e 732e 706f  own_durations.po
+00014340: 7028 7473 2e70 7265 6669 782e 6e61 6d65  p(ts.prefix.name
+00014350: 2c20 7365 7428 2929 0a20 2020 2020 2020  , set()).       
+00014360: 2073 7465 616c 203d 2073 656c 662e 6578   steal = self.ex
+00014370: 7465 6e73 696f 6e73 2e67 6574 2822 7374  tensions.get("st
+00014380: 6561 6c69 6e67 2229 0a20 2020 2020 2020  ealing").       
+00014390: 2069 6620 7374 6561 6c3a 0a20 2020 2020   if steal:.     
+000143a0: 2020 2020 2020 2066 6f72 2074 7473 2069         for tts i
+000143b0: 6e20 733a 0a20 2020 2020 2020 2020 2020  n s:.           
+000143c0: 2020 2020 2069 6620 7474 732e 7072 6f63       if tts.proc
+000143d0: 6573 7369 6e67 5f6f 6e3a 0a20 2020 2020  essing_on:.     
+000143e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000143f0: 7465 616c 2e72 6563 616c 6375 6c61 7465  teal.recalculate
+00014400: 5f63 6f73 7428 7474 7329 0a0a 2020 2020  _cost(tts)..    
+00014410: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+00014420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014430: 0a20 2020 2020 2020 2023 2055 7064 6174  .        # Updat
+00014440: 6520 5374 6174 6520 496e 666f 726d 6174  e State Informat
+00014450: 696f 6e20 230a 2020 2020 2020 2020 2323  ion #.        ##
+00014460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014470: 2323 2323 2323 2323 2323 0a20 2020 2020  ##########.     
+00014480: 2020 2069 6620 6e62 7974 6573 2069 7320     if nbytes is 
+00014490: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000144a0: 2020 2020 2020 7473 2e73 6574 5f6e 6279        ts.set_nby
+000144b0: 7465 7328 6e62 7974 6573 290a 0a20 2020  tes(nbytes)..   
+000144c0: 2020 2020 2073 656c 662e 5f65 7869 745f       self._exit_
+000144d0: 7072 6f63 6573 7369 6e67 5f63 6f6d 6d6f  processing_commo
+000144e0: 6e28 7473 290a 0a20 2020 2020 2020 2072  n(ts)..        r
+000144f0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+00014500: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
+00014510: 2020 636c 6965 6e74 5f6d 7367 733a 204d    client_msgs: M
+00014520: 7367 7320 3d20 7b7d 0a20 2020 2020 2020  sgs = {}.       
+00014530: 2073 656c 662e 5f61 6464 5f74 6f5f 6d65   self._add_to_me
+00014540: 6d6f 7279 280a 2020 2020 2020 2020 2020  mory(.          
+00014550: 2020 7473 2c20 7773 2c20 7265 636f 6d6d    ts, ws, recomm
+00014560: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
+00014570: 745f 6d73 6773 2c20 7479 7065 3d74 7970  t_msgs, type=typ
+00014580: 652c 2074 7970 656e 616d 653d 7479 7065  e, typename=type
+00014590: 6e61 6d65 0a20 2020 2020 2020 2029 0a0a  name.        )..
+000145a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000145b0: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+000145c0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+000145d0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+000145e0: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+000145f0: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+00014600: 696e 675f 6f6e 0a0a 2020 2020 2020 2020  ing_on..        
+00014610: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00014620: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+00014630: 7367 732c 207b 7d0a 0a20 2020 2064 6566  sgs, {}..    def
+00014640: 2074 7261 6e73 6974 696f 6e5f 6d65 6d6f   transition_memo
+00014650: 7279 5f72 656c 6561 7365 6428 0a20 2020  ry_released(.   
+00014660: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
+00014670: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+00014680: 3a20 7374 722c 202a 2c20 7361 6665 3a20  : str, *, safe: 
+00014690: 626f 6f6c 203d 2046 616c 7365 0a20 2020  bool = False.   
+000146a0: 2029 202d 3e20 5265 6373 4d73 6773 3a0a   ) -> RecsMsgs:.
+000146b0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+000146c0: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
+000146d0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+000146e0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+000146f0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00014700: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+00014710: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00014720: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
+00014730: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
+00014740: 2069 6620 7361 6665 3a0a 2020 2020 2020   if safe:.      
+00014750: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00014760: 206e 6f74 2074 732e 7761 6974 6572 730a   not ts.waiters.
+00014770: 0a20 2020 2020 2020 2069 6620 7473 2e61  .        if ts.a
+00014780: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
+00014790: 2020 666f 7220 7773 2069 6e20 7473 2e77    for ws in ts.w
+000147a0: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
+000147b0: 2020 2020 2020 2020 7773 2e61 6374 6f72          ws.actor
+000147c0: 732e 6469 7363 6172 6428 7473 290a 2020  s.discard(ts).  
+000147d0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+000147e0: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
+000147f0: 2020 2020 2020 2020 2020 2074 732e 6578             ts.ex
+00014800: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
+00014810: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
+00014820: 2020 2074 732e 6578 6365 7074 696f 6e20     ts.exception 
+00014830: 3d20 5365 7269 616c 697a 6564 280a 2020  = Serialized(.  
+00014840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014850: 2020 2a73 6572 6961 6c69 7a65 2856 616c    *serialize(Val
+00014860: 7565 4572 726f 7228 2257 6f72 6b65 7220  ueError("Worker 
+00014870: 686f 6c64 696e 6720 4163 746f 7220 7761  holding Actor wa
+00014880: 7320 6c6f 7374 2229 290a 2020 2020 2020  s lost")).      
+00014890: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000148a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000148b0: 726e 207b 7473 2e6b 6579 3a20 2265 7272  rn {ts.key: "err
+000148c0: 6564 227d 2c20 7b7d 2c20 7b7d 2020 2320  ed"}, {}, {}  # 
+000148d0: 646f 6e27 7420 7472 7920 746f 2072 6563  don't try to rec
+000148e0: 7265 6174 650a 0a20 2020 2020 2020 2072  reate..        r
+000148f0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+00014900: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
+00014910: 2020 636c 6965 6e74 5f6d 7367 733a 204d    client_msgs: M
+00014920: 7367 7320 3d20 7b7d 0a20 2020 2020 2020  sgs = {}.       
+00014930: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
+00014940: 6773 203d 207b 7d0a 0a20 2020 2020 2020  gs = {}..       
+00014950: 2023 2058 5858 2066 6163 746f 7220 7468   # XXX factor th
+00014960: 6973 206f 7574 3f0a 2020 2020 2020 2020  is out?.        
+00014970: 776f 726b 6572 5f6d 7367 203d 207b 0a20  worker_msg = {. 
+00014980: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
+00014990: 2022 6672 6565 2d6b 6579 7322 2c0a 2020   "free-keys",.  
+000149a0: 2020 2020 2020 2020 2020 226b 6579 7322            "keys"
+000149b0: 3a20 5b6b 6579 5d2c 0a20 2020 2020 2020  : [key],.       
+000149c0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
+000149d0: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
+000149e0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+000149f0: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
+00014a00: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
+00014a10: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00014a20: 5b77 732e 6164 6472 6573 735d 203d 205b  [ws.address] = [
+00014a30: 776f 726b 6572 5f6d 7367 5d0a 2020 2020  worker_msg].    
+00014a40: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
+00014a50: 616c 6c5f 7265 706c 6963 6173 2874 7329  all_replicas(ts)
+00014a60: 0a0a 2020 2020 2020 2020 7473 2e73 7461  ..        ts.sta
+00014a70: 7465 203d 2022 7265 6c65 6173 6564 220a  te = "released".
+00014a80: 0a20 2020 2020 2020 2072 6570 6f72 745f  .        report_
+00014a90: 6d73 6720 3d20 7b22 6f70 223a 2022 6c6f  msg = {"op": "lo
+00014aa0: 7374 2d64 6174 6122 2c20 226b 6579 223a  st-data", "key":
+00014ab0: 206b 6579 7d0a 2020 2020 2020 2020 666f   key}.        fo
+00014ac0: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
+00014ad0: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
+00014ae0: 2020 636c 6965 6e74 5f6d 7367 735b 6373    client_msgs[cs
+00014af0: 2e63 6c69 656e 745f 6b65 795d 203d 205b  .client_key] = [
+00014b00: 7265 706f 7274 5f6d 7367 5d0a 0a20 2020  report_msg]..   
+00014b10: 2020 2020 2069 6620 6e6f 7420 7473 2e72       if not ts.r
+00014b20: 756e 5f73 7065 633a 2020 2320 7075 7265  un_spec:  # pure
+00014b30: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+00014b40: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00014b50: 735b 6b65 795d 203d 2022 666f 7267 6f74  s[key] = "forgot
+00014b60: 7465 6e22 0a20 2020 2020 2020 2065 6c69  ten".        eli
+00014b70: 6620 7473 2e68 6173 5f6c 6f73 745f 6465  f ts.has_lost_de
+00014b80: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+00014b90: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00014ba0: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
+00014bb0: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
+00014bc0: 2020 2065 6c69 6620 7473 2e77 686f 5f77     elif ts.who_w
+00014bd0: 616e 7473 206f 7220 7473 2e77 6169 7465  ants or ts.waite
+00014be0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00014bf0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+00014c00: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
+00014c10: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+00014c20: 7320 696e 2074 732e 7761 6974 6572 733a  s in ts.waiters:
+00014c30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00014c40: 6474 732e 7374 6174 6520 696e 2028 226e  dts.state in ("n
+00014c50: 6f2d 776f 726b 6572 222c 2022 7072 6f63  o-worker", "proc
+00014c60: 6573 7369 6e67 2229 3a0a 2020 2020 2020  essing"):.      
+00014c70: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+00014c80: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
+00014c90: 795d 203d 2022 7761 6974 696e 6722 0a20  y] = "waiting". 
+00014ca0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00014cb0: 6474 732e 7374 6174 6520 3d3d 2022 7761  dts.state == "wa
+00014cc0: 6974 696e 6722 3a0a 2020 2020 2020 2020  iting":.        
+00014cd0: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
+00014ce0: 696e 675f 6f6e 2e61 6464 2874 7329 0a0a  ing_on.add(ts)..
+00014cf0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00014d00: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00014d10: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00014d20: 2074 732e 7761 6974 696e 675f 6f6e 0a0a   ts.waiting_on..
+00014d30: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00014d40: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+00014d50: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
+00014d60: 6b65 725f 6d73 6773 0a0a 2020 2020 6465  ker_msgs..    de
+00014d70: 6620 7472 616e 7369 7469 6f6e 5f72 656c  f transition_rel
+00014d80: 6561 7365 645f 6572 7265 6428 7365 6c66  eased_erred(self
+00014d90: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
+00014da0: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
+00014db0: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+00014dc0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00014dd0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+00014de0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
+00014df0: 2052 6563 7320 3d20 7b7d 0a20 2020 2020   Recs = {}.     
+00014e00: 2020 2063 6c69 656e 745f 6d73 6773 3a20     client_msgs: 
+00014e10: 4d73 6773 203d 207b 7d0a 0a20 2020 2020  Msgs = {}..     
+00014e20: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+00014e30: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00014e40: 2077 6974 6820 6c6f 675f 6572 726f 7273   with log_errors
+00014e50: 2870 6462 3d4c 4f47 5f50 4442 293a 0a20  (pdb=LOG_PDB):. 
 00014e60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00014e70: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00014e80: 7465 7273 0a0a 2020 2020 2020 2020 6661  ters..        fa
-00014e90: 696c 696e 675f 7473 203d 2074 732e 6578  iling_ts = ts.ex
-00014ea0: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
-00014eb0: 2020 2020 2020 6173 7365 7274 2066 6169        assert fai
-00014ec0: 6c69 6e67 5f74 730a 0a20 2020 2020 2020  ling_ts..       
-00014ed0: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-00014ee0: 6570 656e 6465 6e74 733a 0a20 2020 2020  ependents:.     
-00014ef0: 2020 2020 2020 2064 7473 2e65 7863 6570         dts.excep
-00014f00: 7469 6f6e 5f62 6c61 6d65 203d 2066 6169  tion_blame = fai
-00014f10: 6c69 6e67 5f74 730a 2020 2020 2020 2020  ling_ts.        
-00014f20: 2020 2020 6966 206e 6f74 2064 7473 2e77      if not dts.w
-00014f30: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
-00014f40: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00014f50: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
-00014f60: 203d 2022 6572 7265 6422 0a0a 2020 2020   = "erred"..    
-00014f70: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
-00014f80: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-00014f90: 6f70 223a 2022 7461 736b 2d65 7272 6564  op": "task-erred
-00014fa0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00014fb0: 6b65 7922 3a20 6b65 792c 0a20 2020 2020  key": key,.     
-00014fc0: 2020 2020 2020 2022 6578 6365 7074 696f         "exceptio
-00014fd0: 6e22 3a20 6661 696c 696e 675f 7473 2e65  n": failing_ts.e
-00014fe0: 7863 6570 7469 6f6e 2c0a 2020 2020 2020  xception,.      
-00014ff0: 2020 2020 2020 2274 7261 6365 6261 636b        "traceback
-00015000: 223a 2066 6169 6c69 6e67 5f74 732e 7472  ": failing_ts.tr
-00015010: 6163 6562 6163 6b2c 0a20 2020 2020 2020  aceback,.       
-00015020: 207d 0a20 2020 2020 2020 2066 6f72 2063   }.        for c
-00015030: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
-00015040: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
-00015050: 6c69 656e 745f 6d73 6773 5b63 732e 636c  lient_msgs[cs.cl
-00015060: 6965 6e74 5f6b 6579 5d20 3d20 5b72 6570  ient_key] = [rep
-00015070: 6f72 745f 6d73 675d 0a0a 2020 2020 2020  ort_msg]..      
-00015080: 2020 7473 2e73 7461 7465 203d 2022 6572    ts.state = "er
-00015090: 7265 6422 0a0a 2020 2020 2020 2020 2320  red"..        # 
-000150a0: 544f 444f 3a20 7761 6974 696e 6720 6461  TODO: waiting da
-000150b0: 7461 3f0a 2020 2020 2020 2020 7265 7475  ta?.        retu
-000150c0: 726e 2072 6563 6f6d 6d65 6e64 6174 696f  rn recommendatio
-000150d0: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
-000150e0: 207b 7d0a 0a20 2020 2064 6566 2074 7261   {}..    def tra
-000150f0: 6e73 6974 696f 6e5f 6572 7265 645f 7265  nsition_erred_re
-00015100: 6c65 6173 6564 2873 656c 662c 206b 6579  leased(self, key
-00015110: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
-00015120: 6964 3a20 7374 7229 202d 3e20 5265 6373  id: str) -> Recs
-00015130: 4d73 6773 3a0a 2020 2020 2020 2020 7473  Msgs:.        ts
-00015140: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-00015150: 795d 0a20 2020 2020 2020 2072 6563 6f6d  y].        recom
-00015160: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-00015170: 203d 207b 7d0a 2020 2020 2020 2020 636c   = {}.        cl
-00015180: 6965 6e74 5f6d 7367 733a 204d 7367 7320  ient_msgs: Msgs 
-00015190: 3d20 7b7d 0a20 2020 2020 2020 2077 6f72  = {}.        wor
-000151a0: 6b65 725f 6d73 6773 3a20 4d73 6773 203d  ker_msgs: Msgs =
-000151b0: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
-000151c0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-000151d0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-000151e0: 6c6f 675f 6572 726f 7273 2870 6462 3d4c  log_errors(pdb=L
-000151f0: 4f47 5f50 4442 293a 0a20 2020 2020 2020  OG_PDB):.       
-00015200: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00015210: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
-00015220: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-00015230: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00015240: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-00015250: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00015260: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-00015270: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00015280: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00015290: 7761 6974 6572 730a 0a20 2020 2020 2020  waiters..       
-000152a0: 2074 732e 6578 6365 7074 696f 6e20 3d20   ts.exception = 
-000152b0: 4e6f 6e65 0a20 2020 2020 2020 2074 732e  None.        ts.
-000152c0: 6578 6365 7074 696f 6e5f 626c 616d 6520  exception_blame 
-000152d0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2074  = None.        t
-000152e0: 732e 7472 6163 6562 6163 6b20 3d20 4e6f  s.traceback = No
-000152f0: 6e65 0a0a 2020 2020 2020 2020 666f 7220  ne..        for 
-00015300: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-00015310: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-00015320: 2020 6966 2064 7473 2e73 7461 7465 203d    if dts.state =
-00015330: 3d20 2265 7272 6564 223a 0a20 2020 2020  = "erred":.     
-00015340: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00015350: 6d65 6e64 6174 696f 6e73 5b64 7473 2e6b  mendations[dts.k
-00015360: 6579 5d20 3d20 2277 6169 7469 6e67 220a  ey] = "waiting".
-00015370: 0a20 2020 2020 2020 2077 5f6d 7367 203d  .        w_msg =
-00015380: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-00015390: 6f70 223a 2022 6672 6565 2d6b 6579 7322  op": "free-keys"
-000153a0: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
-000153b0: 6579 7322 3a20 5b6b 6579 5d2c 0a20 2020  eys": [key],.   
-000153c0: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
-000153d0: 7573 5f69 6422 3a20 7374 696d 756c 7573  us_id": stimulus
-000153e0: 5f69 642c 0a20 2020 2020 2020 207d 0a20  _id,.        }. 
-000153f0: 2020 2020 2020 2066 6f72 2077 735f 6164         for ws_ad
-00015400: 6472 2069 6e20 7473 2e65 7272 6564 5f6f  dr in ts.erred_o
-00015410: 6e3a 0a20 2020 2020 2020 2020 2020 2077  n:.            w
-00015420: 6f72 6b65 725f 6d73 6773 5b77 735f 6164  orker_msgs[ws_ad
-00015430: 6472 5d20 3d20 5b77 5f6d 7367 5d0a 2020  dr] = [w_msg].  
-00015440: 2020 2020 2020 7473 2e65 7272 6564 5f6f        ts.erred_o
-00015450: 6e2e 636c 6561 7228 290a 0a20 2020 2020  n.clear()..     
-00015460: 2020 2072 6570 6f72 745f 6d73 6720 3d20     report_msg = 
-00015470: 7b22 6f70 223a 2022 7461 736b 2d72 6574  {"op": "task-ret
-00015480: 7269 6564 222c 2022 6b65 7922 3a20 6b65  ried", "key": ke
-00015490: 797d 0a20 2020 2020 2020 2066 6f72 2063  y}.        for c
-000154a0: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
-000154b0: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
-000154c0: 6c69 656e 745f 6d73 6773 5b63 732e 636c  lient_msgs[cs.cl
-000154d0: 6965 6e74 5f6b 6579 5d20 3d20 5b72 6570  ient_key] = [rep
-000154e0: 6f72 745f 6d73 675d 0a0a 2020 2020 2020  ort_msg]..      
-000154f0: 2020 7473 2e73 7461 7465 203d 2022 7265    ts.state = "re
-00015500: 6c65 6173 6564 220a 0a20 2020 2020 2020  leased"..       
-00015510: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
-00015520: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-00015530: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-00015540: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
-00015550: 6974 696f 6e5f 7761 6974 696e 675f 7265  ition_waiting_re
-00015560: 6c65 6173 6564 2873 656c 662c 206b 6579  leased(self, key
-00015570: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
-00015580: 6964 3a20 7374 7229 202d 3e20 5265 6373  id: str) -> Recs
-00015590: 4d73 6773 3a0a 2020 2020 2020 2020 7473  Msgs:.        ts
-000155a0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-000155b0: 795d 0a20 2020 2020 2020 2072 6563 6f6d  y].        recom
-000155c0: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-000155d0: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
-000155e0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-000155f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00015600: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
-00015610: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
-00015620: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-00015630: 6365 7373 696e 675f 6f6e 0a0a 2020 2020  cessing_on..    
-00015640: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-00015650: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
-00015660: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00015670: 7320 696e 2064 7473 2e77 6169 7465 7273  s in dts.waiters
-00015680: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015690: 2020 6474 732e 7761 6974 6572 732e 6469    dts.waiters.di
-000156a0: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
-000156b0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-000156c0: 2064 7473 2e77 6169 7465 7273 2061 6e64   dts.waiters and
-000156d0: 206e 6f74 2064 7473 2e77 686f 5f77 616e   not dts.who_wan
-000156e0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-000156f0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00015700: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
-00015710: 203d 2022 7265 6c65 6173 6564 220a 2020   = "released".  
-00015720: 2020 2020 2020 7473 2e77 6169 7469 6e67        ts.waiting
-00015730: 5f6f 6e2e 636c 6561 7228 290a 0a20 2020  _on.clear()..   
-00015740: 2020 2020 2074 732e 7374 6174 6520 3d20       ts.state = 
-00015750: 2272 656c 6561 7365 6422 0a0a 2020 2020  "released"..    
-00015760: 2020 2020 6966 2074 732e 6861 735f 6c6f      if ts.has_lo
-00015770: 7374 5f64 6570 656e 6465 6e63 6965 733a  st_dependencies:
-00015780: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-00015790: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 6579  ommendations[key
-000157a0: 5d20 3d20 2266 6f72 676f 7474 656e 220a  ] = "forgotten".
-000157b0: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
-000157c0: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
-000157d0: 616d 6520 616e 6420 2874 732e 7768 6f5f  ame and (ts.who_
-000157e0: 7761 6e74 7320 6f72 2074 732e 7761 6974  wants or ts.wait
-000157f0: 6572 7329 3a0a 2020 2020 2020 2020 2020  ers):.          
-00015800: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00015810: 735b 6b65 795d 203d 2022 7761 6974 696e  s[key] = "waitin
-00015820: 6722 0a20 2020 2020 2020 2065 6c73 653a  g".        else:
-00015830: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
-00015840: 7761 6974 6572 732e 636c 6561 7228 290a  waiters.clear().
-00015850: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00015860: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-00015870: 207b 7d2c 207b 7d0a 0a20 2020 2064 6566   {}, {}..    def
-00015880: 2074 7261 6e73 6974 696f 6e5f 7072 6f63   transition_proc
-00015890: 6573 7369 6e67 5f72 656c 6561 7365 6428  essing_released(
-000158a0: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-000158b0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-000158c0: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-000158d0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-000158e0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-000158f0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00015900: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
-00015910: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-00015920: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
-00015930: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00015940: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00015950: 2020 2020 2061 7373 6572 7420 7473 2e70       assert ts.p
-00015960: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-00015970: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00015980: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
-00015990: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000159a0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-000159b0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-000159c0: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
-000159d0: 3d3d 2022 7072 6f63 6573 7369 6e67 220a  == "processing".
-000159e0: 0a20 2020 2020 2020 2077 7320 3d20 7365  .        ws = se
-000159f0: 6c66 2e5f 6578 6974 5f70 726f 6365 7373  lf._exit_process
-00015a00: 696e 675f 636f 6d6d 6f6e 2874 7329 0a20  ing_common(ts). 
-00015a10: 2020 2020 2020 2069 6620 7773 3a0a 2020         if ws:.  
-00015a20: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00015a30: 5f6d 7367 735b 7773 2e61 6464 7265 7373  _msgs[ws.address
-00015a40: 5d20 3d20 5b0a 2020 2020 2020 2020 2020  ] = [.          
-00015a50: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00015a60: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
-00015a70: 3a20 2266 7265 652d 6b65 7973 222c 0a20  : "free-keys",. 
-00015a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a90: 2020 2022 6b65 7973 223a 205b 6b65 795d     "keys": [key]
-00015aa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015ab0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-00015ac0: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-00015ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015ae0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00015af0: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
-00015b00: 5f70 726f 7061 6761 7465 5f72 656c 6561  _propagate_relea
-00015b10: 7365 6428 7473 2c20 7265 636f 6d6d 656e  sed(ts, recommen
-00015b20: 6461 7469 6f6e 7329 0a20 2020 2020 2020  dations).       
-00015b30: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
-00015b40: 6461 7469 6f6e 732c 207b 7d2c 2077 6f72  dations, {}, wor
-00015b50: 6b65 725f 6d73 6773 0a0a 2020 2020 6465  ker_msgs..    de
-00015b60: 6620 7472 616e 7369 7469 6f6e 5f70 726f  f transition_pro
-00015b70: 6365 7373 696e 675f 6572 7265 6428 0a20  cessing_erred(. 
-00015b80: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00015b90: 2020 2020 206b 6579 3a20 7374 722c 0a20       key: str,. 
-00015ba0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-00015bb0: 6964 3a20 7374 722c 0a20 2020 2020 2020  id: str,.       
-00015bc0: 202a 2c0a 2020 2020 2020 2020 776f 726b   *,.        work
-00015bd0: 6572 3a20 7374 722c 0a20 2020 2020 2020  er: str,.       
-00015be0: 2063 6175 7365 3a20 7374 7220 7c20 4e6f   cause: str | No
-00015bf0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00015c00: 2020 2065 7863 6570 7469 6f6e 3a20 5365     exception: Se
-00015c10: 7269 616c 697a 6564 207c 204e 6f6e 6520  rialized | None 
-00015c20: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00015c30: 7472 6163 6562 6163 6b3a 2053 6572 6961  traceback: Seria
-00015c40: 6c69 7a65 6420 7c20 4e6f 6e65 203d 204e  lized | None = N
-00015c50: 6f6e 652c 0a20 2020 2020 2020 2065 7863  one,.        exc
-00015c60: 6570 7469 6f6e 5f74 6578 743a 2073 7472  eption_text: str
-00015c70: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00015c80: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
-00015c90: 6b5f 7465 7874 3a20 7374 7220 7c20 4e6f  k_text: str | No
-00015ca0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00015cb0: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
-00015cc0: 2c0a 2020 2020 2920 2d3e 2052 6563 734d  ,.    ) -> RecsM
-00015cd0: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
-00015ce0: 5072 6f63 6573 7365 6420 6120 7265 636f  Processed a reco
-00015cf0: 6d6d 656e 6465 6420 7472 616e 7369 7469  mmended transiti
-00015d00: 6f6e 2070 726f 6365 7373 696e 6720 2d3e  on processing ->
-00015d10: 2065 7272 6564 2e0a 0a20 2020 2020 2020   erred...       
-00015d20: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00015d30: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00015d40: 2020 2020 2020 206b 6579 0a20 2020 2020         key.     
-00015d50: 2020 2020 2020 4b65 7920 6f66 2074 6865        Key of the
-00015d60: 2074 6173 6b20 746f 2074 7261 6e73 6974   task to transit
-00015d70: 696f 6e0a 2020 2020 2020 2020 7374 696d  ion.        stim
-00015d80: 756c 7573 5f69 640a 2020 2020 2020 2020  ulus_id.        
-00015d90: 2020 2020 4944 206f 6620 7468 6520 7374      ID of the st
-00015da0: 696d 756c 7573 2063 6175 7369 6e67 2074  imulus causing t
-00015db0: 6865 2074 7261 6e73 6974 696f 6e0a 2020  he transition.  
-00015dc0: 2020 2020 2020 776f 726b 6572 0a20 2020        worker.   
-00015dd0: 2020 2020 2020 2020 2041 6464 7265 7373           Address
-00015de0: 206f 6620 7468 6520 776f 726b 6572 2077   of the worker w
-00015df0: 6865 7265 2074 6865 2074 6173 6b20 6572  here the task er
-00015e00: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
-00015e10: 204e 6f74 206e 6563 6573 7361 7269 6c79   Not necessarily
-00015e20: 2060 6074 732e 7072 6f63 6573 7369 6e67   ``ts.processing
-00015e30: 5f6f 6e60 602e 0a20 2020 2020 2020 2063  _on``..        c
-00015e40: 6175 7365 0a20 2020 2020 2020 2020 2020  ause.           
-00015e50: 2041 6464 7265 7373 206f 6620 7468 6520   Address of the 
-00015e60: 7461 736b 2074 6861 7420 6361 7573 6564  task that caused
-00015e70: 2074 6869 7320 7461 736b 2074 6f20 6265   this task to be
-00015e80: 2074 7261 6e73 6974 696f 6e65 6420 746f   transitioned to
-00015e90: 2065 7272 6564 0a20 2020 2020 2020 2065   erred.        e
-00015ea0: 7863 6570 7469 6f6e 0a20 2020 2020 2020  xception.       
-00015eb0: 2020 2020 2045 7863 6570 7469 6f6e 2063       Exception c
-00015ec0: 6175 7365 6420 6279 2074 6865 2074 6173  aused by the tas
-00015ed0: 6b0a 2020 2020 2020 2020 7472 6163 6562  k.        traceb
-00015ee0: 6163 6b0a 2020 2020 2020 2020 2020 2020  ack.            
-00015ef0: 5472 6163 6562 6163 6b20 6361 7573 6564  Traceback caused
-00015f00: 2062 7920 7468 6520 7461 736b 0a20 2020   by the task.   
-00015f10: 2020 2020 2065 7863 6570 7469 6f6e 5f74       exception_t
-00015f20: 6578 740a 2020 2020 2020 2020 2020 2020  ext.            
-00015f30: 5374 7269 6e67 2072 6570 7265 7365 6e74  String represent
-00015f40: 6174 696f 6e20 6f66 2074 6865 2065 7863  ation of the exc
-00015f50: 6570 7469 6f6e 0a20 2020 2020 2020 2074  eption.        t
-00015f60: 7261 6365 6261 636b 5f74 6578 740a 2020  raceback_text.  
-00015f70: 2020 2020 2020 2020 2020 5374 7269 6e67            String
-00015f80: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
-00015f90: 6f66 2074 6865 2074 7261 6365 6261 636b  of the traceback
-00015fa0: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-00015fb0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00015fc0: 2d0a 2020 2020 2020 2020 5265 636f 6d6d  -.        Recomm
-00015fd0: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-00015fe0: 7420 6d65 7373 6167 6573 2061 6e64 2077  t messages and w
-00015ff0: 6f72 6b65 7220 6d65 7373 6167 6573 2074  orker messages t
-00016000: 6f20 7072 6f63 6573 730a 2020 2020 2020  o process.      
-00016010: 2020 2222 220a 2020 2020 2020 2020 7473    """.        ts
-00016020: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-00016030: 795d 0a20 2020 2020 2020 2072 6563 6f6d  y].        recom
-00016040: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-00016050: 203d 207b 7d0a 2020 2020 2020 2020 636c   = {}.        cl
-00016060: 6965 6e74 5f6d 7367 733a 204d 7367 7320  ient_msgs: Msgs 
-00016070: 3d20 7b7d 0a0a 2020 2020 2020 2020 6966  = {}..        if
-00016080: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-00016090: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000160a0: 7274 2063 6175 7365 206f 7220 7473 2e65  rt cause or ts.e
-000160b0: 7863 6570 7469 6f6e 5f62 6c61 6d65 0a20  xception_blame. 
-000160c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000160d0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-000160e0: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-000160f0: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-00016100: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
-00016110: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00016120: 6169 7469 6e67 5f6f 6e0a 0a20 2020 2020  aiting_on..     
-00016130: 2020 2069 6620 7473 2e61 6374 6f72 3a0a     if ts.actor:.
-00016140: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
-00016150: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00016160: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-00016170: 7365 7274 2077 730a 2020 2020 2020 2020  sert ws.        
-00016180: 2020 2020 7773 2e61 6374 6f72 732e 7265      ws.actors.re
-00016190: 6d6f 7665 2874 7329 0a0a 2020 2020 2020  move(ts)..      
-000161a0: 2020 7365 6c66 2e5f 6578 6974 5f70 726f    self._exit_pro
-000161b0: 6365 7373 696e 675f 636f 6d6d 6f6e 2874  cessing_common(t
-000161c0: 7329 0a0a 2020 2020 2020 2020 7473 2e65  s)..        ts.e
-000161d0: 7272 6564 5f6f 6e2e 6164 6428 776f 726b  rred_on.add(work
-000161e0: 6572 290a 2020 2020 2020 2020 6966 2065  er).        if e
-000161f0: 7863 6570 7469 6f6e 2069 7320 6e6f 7420  xception is not 
-00016200: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00016210: 2020 7473 2e65 7863 6570 7469 6f6e 203d    ts.exception =
-00016220: 2065 7863 6570 7469 6f6e 0a20 2020 2020   exception.     
-00016230: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
-00016240: 696f 6e5f 7465 7874 203d 2065 7863 6570  ion_text = excep
-00016250: 7469 6f6e 5f74 6578 7420 2023 2074 7970  tion_text  # typ
-00016260: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-00016270: 2020 6966 2074 7261 6365 6261 636b 2069    if traceback i
-00016280: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00016290: 2020 2020 2020 2020 7473 2e74 7261 6365          ts.trace
-000162a0: 6261 636b 203d 2074 7261 6365 6261 636b  back = traceback
-000162b0: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
-000162c0: 7472 6163 6562 6163 6b5f 7465 7874 203d  traceback_text =
-000162d0: 2074 7261 6365 6261 636b 5f74 6578 7420   traceback_text 
-000162e0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-000162f0: 2020 2020 2020 2020 6966 2063 6175 7365          if cause
-00016300: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00016310: 2020 2020 2020 2020 2020 6661 696c 696e            failin
-00016320: 675f 7473 203d 2073 656c 662e 7461 736b  g_ts = self.task
-00016330: 735b 6361 7573 655d 0a20 2020 2020 2020  s[cause].       
-00016340: 2020 2020 2074 732e 6578 6365 7074 696f       ts.exceptio
-00016350: 6e5f 626c 616d 6520 3d20 6661 696c 696e  n_blame = failin
-00016360: 675f 7473 0a20 2020 2020 2020 2065 6c73  g_ts.        els
-00016370: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00016380: 6169 6c69 6e67 5f74 7320 3d20 7473 2e65  ailing_ts = ts.e
-00016390: 7863 6570 7469 6f6e 5f62 6c61 6d65 2020  xception_blame  
-000163a0: 2320 7479 7065 3a20 6967 6e6f 7265 0a0a  # type: ignore..
-000163b0: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
-000163c0: 6564 5f74 6173 6b73 2e61 7070 656e 646c  ed_tasks.appendl
-000163d0: 6566 7428 0a20 2020 2020 2020 2020 2020  eft(.           
-000163e0: 2045 7272 6564 5461 736b 280a 2020 2020   ErredTask(.    
-000163f0: 2020 2020 2020 2020 2020 2020 7473 2e6b              ts.k
-00016400: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-00016410: 2020 2020 7469 6d65 2829 2c0a 2020 2020      time(),.    
-00016420: 2020 2020 2020 2020 2020 2020 7473 2e65              ts.e
-00016430: 7272 6564 5f6f 6e2e 636f 7079 2829 2c0a  rred_on.copy(),.
-00016440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016450: 6578 6365 7074 696f 6e5f 7465 7874 206f  exception_text o
-00016460: 7220 2222 2c0a 2020 2020 2020 2020 2020  r "",.          
-00016470: 2020 2020 2020 7472 6163 6562 6163 6b5f        traceback_
-00016480: 7465 7874 206f 7220 2222 2c0a 2020 2020  text or "",.    
-00016490: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000164a0: 2020 290a 0a20 2020 2020 2020 2066 6f72    )..        for
-000164b0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-000164c0: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
-000164d0: 2020 2064 7473 2e65 7863 6570 7469 6f6e     dts.exception
-000164e0: 5f62 6c61 6d65 203d 2066 6169 6c69 6e67  _blame = failing
-000164f0: 5f74 730a 2020 2020 2020 2020 2020 2020  _ts.            
-00016500: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-00016510: 6474 732e 6b65 795d 203d 2022 6572 7265  dts.key] = "erre
-00016520: 6422 0a0a 2020 2020 2020 2020 666f 7220  d"..        for 
-00016530: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-00016540: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-00016550: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
-00016560: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
-00016570: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-00016580: 7473 2e77 6169 7465 7273 2061 6e64 206e  ts.waiters and n
-00016590: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
-000165a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000165b0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-000165c0: 735b 6474 732e 6b65 795d 203d 2022 7265  s[dts.key] = "re
-000165d0: 6c65 6173 6564 220a 0a20 2020 2020 2020  leased"..       
-000165e0: 2074 732e 7761 6974 6572 732e 636c 6561   ts.waiters.clea
-000165f0: 7228 2920 2023 2064 6f20 616e 7974 6869  r()  # do anythi
-00016600: 6e67 2077 6974 6820 7468 6973 3f0a 0a20  ng with this?.. 
-00016610: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
-00016620: 3d20 2265 7272 6564 220a 0a20 2020 2020  = "erred"..     
-00016630: 2020 2072 6570 6f72 745f 6d73 6720 3d20     report_msg = 
-00016640: 7b0a 2020 2020 2020 2020 2020 2020 226f  {.            "o
-00016650: 7022 3a20 2274 6173 6b2d 6572 7265 6422  p": "task-erred"
-00016660: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
-00016670: 6579 223a 206b 6579 2c0a 2020 2020 2020  ey": key,.      
-00016680: 2020 2020 2020 2265 7863 6570 7469 6f6e        "exception
-00016690: 223a 2066 6169 6c69 6e67 5f74 732e 6578  ": failing_ts.ex
-000166a0: 6365 7074 696f 6e2c 0a20 2020 2020 2020  ception,.       
-000166b0: 2020 2020 2022 7472 6163 6562 6163 6b22       "traceback"
-000166c0: 3a20 6661 696c 696e 675f 7473 2e74 7261  : failing_ts.tra
-000166d0: 6365 6261 636b 2c0a 2020 2020 2020 2020  ceback,.        
-000166e0: 7d0a 2020 2020 2020 2020 666f 7220 6373  }.        for cs
-000166f0: 2069 6e20 7473 2e77 686f 5f77 616e 7473   in ts.who_wants
-00016700: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00016710: 6965 6e74 5f6d 7367 735b 6373 2e63 6c69  ient_msgs[cs.cli
-00016720: 656e 745f 6b65 795d 203d 205b 7265 706f  ent_key] = [repo
-00016730: 7274 5f6d 7367 5d0a 0a20 2020 2020 2020  rt_msg]..       
-00016740: 2063 7320 3d20 7365 6c66 2e63 6c69 656e   cs = self.clien
-00016750: 7473 5b22 6669 7265 2d61 6e64 2d66 6f72  ts["fire-and-for
-00016760: 6765 7422 5d0a 2020 2020 2020 2020 6966  get"].        if
-00016770: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
-00016780: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
-00016790: 2020 7365 6c66 2e5f 636c 6965 6e74 5f72    self._client_r
-000167a0: 656c 6561 7365 735f 6b65 7973 280a 2020  eleases_keys(.  
-000167b0: 2020 2020 2020 2020 2020 2020 2020 6373                cs
-000167c0: 3d63 732c 0a20 2020 2020 2020 2020 2020  =cs,.           
-000167d0: 2020 2020 206b 6579 733d 5b6b 6579 5d2c       keys=[key],
-000167e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000167f0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00016800: 3d72 6563 6f6d 6d65 6e64 6174 696f 6e73  =recommendations
-00016810: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00016820: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00016830: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00016840: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00016850: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00016860: 6f6e 0a0a 2020 2020 2020 2020 7265 7475  on..        retu
-00016870: 726e 2072 6563 6f6d 6d65 6e64 6174 696f  rn recommendatio
-00016880: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
-00016890: 207b 7d0a 0a20 2020 2064 6566 2074 7261   {}..    def tra
-000168a0: 6e73 6974 696f 6e5f 6e6f 5f77 6f72 6b65  nsition_no_worke
-000168b0: 725f 7265 6c65 6173 6564 2873 656c 662c  r_released(self,
-000168c0: 206b 6579 3a20 7374 722c 2073 7469 6d75   key: str, stimu
-000168d0: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
-000168e0: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
-000168f0: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-00016900: 735b 6b65 795d 0a0a 2020 2020 2020 2020  s[key]..        
-00016910: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00016920: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00016930: 7365 7274 2073 656c 662e 7461 736b 735b  sert self.tasks[
-00016940: 6b65 795d 2e73 7461 7465 203d 3d20 226e  key].state == "n
-00016950: 6f2d 776f 726b 6572 220a 2020 2020 2020  o-worker".      
-00016960: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00016970: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-00016980: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00016990: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-000169a0: 0a0a 2020 2020 2020 2020 7365 6c66 2e75  ..        self.u
-000169b0: 6e72 756e 6e61 626c 652e 7265 6d6f 7665  nrunnable.remove
-000169c0: 2874 7329 0a20 2020 2020 2020 2074 732e  (ts).        ts.
-000169d0: 7374 6174 6520 3d20 2272 656c 6561 7365  state = "release
-000169e0: 6422 0a0a 2020 2020 2020 2020 666f 7220  d"..        for 
-000169f0: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-00016a00: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-00016a10: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
-00016a20: 6469 7363 6172 6428 7473 290a 0a20 2020  discard(ts)..   
-00016a30: 2020 2020 2074 732e 7761 6974 6572 732e       ts.waiters.
-00016a40: 636c 6561 7228 290a 0a20 2020 2020 2020  clear()..       
-00016a50: 2072 6574 7572 6e20 7b7d 2c20 7b7d 2c20   return {}, {}, 
-00016a60: 7b7d 0a0a 2020 2020 6465 6620 7472 616e  {}..    def tran
-00016a70: 7369 7469 6f6e 5f77 6169 7469 6e67 5f71  sition_waiting_q
-00016a80: 7565 7565 6428 7365 6c66 2c20 6b65 793a  ueued(self, key:
-00016a90: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
-00016aa0: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-00016ab0: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00016ac0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00016ad0: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00016ae0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00016af0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00016b00: 6e6f 7420 7365 6c66 2e69 646c 655f 7461  not self.idle_ta
-00016b10: 736b 5f63 6f75 6e74 2c20 2874 732c 2073  sk_count, (ts, s
-00016b20: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
-00016b30: 756e 7429 0a20 2020 2020 2020 2020 2020  unt).           
-00016b40: 2073 656c 662e 5f76 616c 6964 6174 655f   self._validate_
-00016b50: 7265 6164 7928 7473 290a 0a20 2020 2020  ready(ts)..     
-00016b60: 2020 2074 732e 7374 6174 6520 3d20 2271     ts.state = "q
-00016b70: 7565 7565 6422 0a20 2020 2020 2020 2073  ueued".        s
-00016b80: 656c 662e 7175 6575 6564 2e61 6464 2874  elf.queued.add(t
-00016b90: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
-00016ba0: 726e 207b 7d2c 207b 7d2c 207b 7d0a 0a20  rn {}, {}, {}.. 
-00016bb0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
-00016bc0: 6e5f 7761 6974 696e 675f 6e6f 5f77 6f72  n_waiting_no_wor
-00016bd0: 6b65 7228 7365 6c66 2c20 6b65 793a 2073  ker(self, key: s
-00016be0: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
-00016bf0: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
-00016c00: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
-00016c10: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00016c20: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00016c30: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00016c40: 2020 2020 2020 2073 656c 662e 5f76 616c         self._val
-00016c50: 6964 6174 655f 7265 6164 7928 7473 290a  idate_ready(ts).
-00016c60: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
-00016c70: 6520 3d20 226e 6f2d 776f 726b 6572 220a  e = "no-worker".
-00016c80: 2020 2020 2020 2020 7365 6c66 2e75 6e72          self.unr
-00016c90: 756e 6e61 626c 652e 6164 6428 7473 290a  unnable.add(ts).
-00016ca0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00016cb0: 7b7d 2c20 7b7d 2c20 7b7d 0a0a 2020 2020  {}, {}, {}..    
-00016cc0: 6465 6620 7472 616e 7369 7469 6f6e 5f71  def transition_q
-00016cd0: 7565 7565 645f 7265 6c65 6173 6564 2873  ueued_released(s
-00016ce0: 656c 662c 206b 6579 3a20 7374 722c 2073  elf, key: str, s
-00016cf0: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
-00016d00: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
-00016d10: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00016d20: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
-00016d30: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00016d40: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00016d50: 2020 6173 7365 7274 2074 7320 696e 2073    assert ts in s
-00016d60: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
-00016d70: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00016d80: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00016d90: 6f6e 0a0a 2020 2020 2020 2020 7365 6c66  on..        self
-00016da0: 2e71 7565 7565 642e 7265 6d6f 7665 2874  .queued.remove(t
-00016db0: 7329 0a0a 2020 2020 2020 2020 7265 636f  s)..        reco
-00016dc0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-00016dd0: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
-00016de0: 656c 662e 5f70 726f 7061 6761 7465 5f72  elf._propagate_r
-00016df0: 656c 6561 7365 6428 7473 2c20 7265 636f  eleased(ts, reco
-00016e00: 6d6d 656e 6461 7469 6f6e 7329 0a20 2020  mmendations).   
-00016e10: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-00016e20: 6d6d 656e 6461 7469 6f6e 732c 207b 7d2c  mmendations, {},
-00016e30: 207b 7d0a 0a20 2020 2064 6566 2074 7261   {}..    def tra
-00016e40: 6e73 6974 696f 6e5f 7175 6575 6564 5f70  nsition_queued_p
-00016e50: 726f 6365 7373 696e 6728 7365 6c66 2c20  rocessing(self, 
-00016e60: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
-00016e70: 7573 5f69 643a 2073 7472 2920 2d3e 2052  us_id: str) -> R
-00016e80: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
-00016e90: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-00016ea0: 5b6b 6579 5d0a 2020 2020 2020 2020 7265  [key].        re
-00016eb0: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-00016ec0: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
-00016ed0: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
-00016ee0: 6773 203d 207b 7d0a 0a20 2020 2020 2020  gs = {}..       
-00016ef0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00016f00: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00016f10: 7373 6572 7420 6e6f 7420 7473 2e61 6374  ssert not ts.act
-00016f20: 6f72 2c20 6622 4163 746f 7273 2063 616e  or, f"Actors can
-00016f30: 2774 2062 6520 7175 6575 6564 3a20 7b74  't be queued: {t
-00016f40: 737d 220a 2020 2020 2020 2020 2020 2020  s}".            
-00016f50: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
-00016f60: 662e 7175 6575 6564 0a0a 2020 2020 2020  f.queued..      
-00016f70: 2020 6966 2077 7320 3a3d 2073 656c 662e    if ws := self.
-00016f80: 6465 6369 6465 5f77 6f72 6b65 725f 726f  decide_worker_ro
-00016f90: 6f74 6973 685f 7175 6575 696e 675f 656e  otish_queuing_en
-00016fa0: 6162 6c65 6428 293a 0a20 2020 2020 2020  abled():.       
-00016fb0: 2020 2020 2073 656c 662e 7175 6575 6564       self.queued
-00016fc0: 2e64 6973 6361 7264 2874 7329 0a20 2020  .discard(ts).   
-00016fd0: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
-00016fe0: 6d73 6773 203d 2073 656c 662e 5f61 6464  msgs = self._add
-00016ff0: 5f74 6f5f 7072 6f63 6573 7369 6e67 2874  _to_processing(t
-00017000: 732c 2077 7329 0a20 2020 2020 2020 2023  s, ws).        #
-00017010: 2049 6620 6e6f 2077 6f72 6b65 722c 2074   If no worker, t
-00017020: 6173 6b20 6a75 7374 2073 7461 7973 2060  ask just stays `
-00017030: 7175 6575 6564 600a 0a20 2020 2020 2020  queued`..       
-00017040: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
-00017050: 6461 7469 6f6e 732c 207b 7d2c 2077 6f72  dations, {}, wor
-00017060: 6b65 725f 6d73 6773 0a0a 2020 2020 6465  ker_msgs..    de
-00017070: 6620 5f72 656d 6f76 655f 6b65 7928 7365  f _remove_key(se
-00017080: 6c66 2c20 6b65 793a 2073 7472 2920 2d3e  lf, key: str) ->
-00017090: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
-000170a0: 7320 3d20 7365 6c66 2e74 6173 6b73 2e70  s = self.tasks.p
-000170b0: 6f70 286b 6579 290a 2020 2020 2020 2020  op(key).        
-000170c0: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
-000170d0: 3d3d 2022 666f 7267 6f74 7465 6e22 0a20  == "forgotten". 
-000170e0: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
-000170f0: 6e6e 6162 6c65 2e64 6973 6361 7264 2874  nnable.discard(t
-00017100: 7329 0a20 2020 2020 2020 2066 6f72 2063  s).        for c
-00017110: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
-00017120: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
-00017130: 732e 7761 6e74 735f 7768 6174 2e72 656d  s.wants_what.rem
-00017140: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
-00017150: 7473 2e77 686f 5f77 616e 7473 2e63 6c65  ts.who_wants.cle
-00017160: 6172 2829 0a20 2020 2020 2020 2074 732e  ar().        ts.
-00017170: 7072 6f63 6573 7369 6e67 5f6f 6e20 3d20  processing_on = 
-00017180: 4e6f 6e65 0a20 2020 2020 2020 2074 732e  None.        ts.
-00017190: 6578 6365 7074 696f 6e5f 626c 616d 6520  exception_blame 
-000171a0: 3d20 7473 2e65 7863 6570 7469 6f6e 203d  = ts.exception =
-000171b0: 2074 732e 7472 6163 6562 6163 6b20 3d20   ts.traceback = 
-000171c0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-000171d0: 662e 7461 736b 5f6d 6574 6164 6174 612e  f.task_metadata.
-000171e0: 706f 7028 6b65 792c 204e 6f6e 6529 0a0a  pop(key, None)..
-000171f0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
-00017200: 6f6e 5f6d 656d 6f72 795f 666f 7267 6f74  on_memory_forgot
-00017210: 7465 6e28 7365 6c66 2c20 6b65 793a 2073  ten(self, key: s
-00017220: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
-00017230: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
-00017240: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
-00017250: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00017260: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00017270: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00017280: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00017290: 2e73 7461 7465 203d 3d20 226d 656d 6f72  .state == "memor
-000172a0: 7922 0a20 2020 2020 2020 2020 2020 2061  y".            a
-000172b0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-000172c0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-000172d0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-000172e0: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-000172f0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00017300: 6f74 2074 732e 7275 6e5f 7370 6563 3a0a  ot ts.run_spec:.
-00017310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017320: 2320 4974 2773 206f 6b20 746f 2066 6f72  # It's ok to for
-00017330: 6765 7420 6120 7075 7265 2064 6174 6120  get a pure data 
-00017340: 7461 736b 0a20 2020 2020 2020 2020 2020  task.           
-00017350: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-00017360: 2020 2020 2020 656c 6966 2074 732e 6861        elif ts.ha
-00017370: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
-00017380: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-00017390: 2020 2020 2023 2049 7427 7320 6f6b 2074       # It's ok t
-000173a0: 6f20 666f 7267 6574 2061 2074 6173 6b20  o forget a task 
-000173b0: 7769 7468 2066 6f72 676f 7474 656e 2064  with forgotten d
-000173c0: 6570 656e 6465 6e63 6965 730a 2020 2020  ependencies.    
-000173d0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-000173e0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-000173f0: 6620 6e6f 7420 7473 2e77 686f 5f77 616e  f not ts.who_wan
-00017400: 7473 2061 6e64 206e 6f74 2074 732e 7761  ts and not ts.wa
-00017410: 6974 6572 7320 616e 6420 6e6f 7420 7473  iters and not ts
-00017420: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
-00017430: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-00017440: 7427 7320 6f6b 2074 6f20 666f 7267 6574  t's ok to forget
-00017450: 2061 2074 6173 6b20 7468 6174 206e 6f62   a task that nob
-00017460: 6f64 7920 6e65 6564 730a 2020 2020 2020  ody needs.      
-00017470: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-00017480: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00017490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000174a0: 2072 6169 7365 2041 7373 6572 7469 6f6e   raise Assertion
-000174b0: 4572 726f 7228 2255 6e72 6561 6368 6162  Error("Unreachab
-000174c0: 6c65 222c 2074 7329 2020 2320 7072 6167  le", ts)  # prag
-000174d0: 6d61 3a20 6e6f 636f 7665 720a 0a20 2020  ma: nocover..   
-000174e0: 2020 2020 2069 6620 7473 2e61 6374 6f72       if ts.actor
-000174f0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00017500: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
-00017510: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-00017520: 2020 2020 7773 2e61 6374 6f72 732e 6469      ws.actors.di
-00017530: 7363 6172 6428 7473 290a 0a20 2020 2020  scard(ts)..     
-00017540: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00017550: 6e73 3a20 5265 6373 203d 207b 7d0a 2020  ns: Recs = {}.  
-00017560: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
-00017570: 733a 204d 7367 7320 3d20 7b7d 0a20 2020  s: Msgs = {}.   
-00017580: 2020 2020 2073 656c 662e 5f70 726f 7061       self._propa
-00017590: 6761 7465 5f66 6f72 676f 7474 656e 2874  gate_forgotten(t
-000175a0: 732c 2072 6563 6f6d 6d65 6e64 6174 696f  s, recommendatio
-000175b0: 6e73 2c20 776f 726b 6572 5f6d 7367 732c  ns, worker_msgs,
-000175c0: 2073 7469 6d75 6c75 735f 6964 290a 0a20   stimulus_id).. 
-000175d0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-000175e0: 6773 203d 205f 7461 736b 5f74 6f5f 636c  gs = _task_to_cl
-000175f0: 6965 6e74 5f6d 7367 7328 7473 290a 2020  ient_msgs(ts).  
-00017600: 2020 2020 2020 7365 6c66 2e5f 7265 6d6f        self._remo
-00017610: 7665 5f6b 6579 286b 6579 290a 0a20 2020  ve_key(key)..   
-00017620: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-00017630: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-00017640: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-00017650: 5f6d 7367 730a 0a20 2020 2064 6566 2074  _msgs..    def t
-00017660: 7261 6e73 6974 696f 6e5f 7265 6c65 6173  ransition_releas
-00017670: 6564 5f66 6f72 676f 7474 656e 2873 656c  ed_forgotten(sel
-00017680: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
-00017690: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-000176a0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-000176b0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-000176c0: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
-000176d0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-000176e0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-000176f0: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
-00017700: 696e 2028 2272 656c 6561 7365 6422 2c20  in ("released", 
-00017710: 2265 7272 6564 2229 0a20 2020 2020 2020  "erred").       
-00017720: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00017730: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-00017740: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00017750: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00017760: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-00017770: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
-00017780: 7365 6c66 2e71 7565 7565 640a 2020 2020  self.queued.    
-00017790: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000177a0: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-000177b0: 2c20 2874 732c 2074 732e 7761 6974 696e  , (ts, ts.waitin
-000177c0: 675f 6f6e 290a 2020 2020 2020 2020 2020  g_on).          
-000177d0: 2020 6966 206e 6f74 2074 732e 7275 6e5f    if not ts.run_
-000177e0: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
-000177f0: 2020 2020 2020 2320 4974 2773 206f 6b20        # It's ok 
-00017800: 746f 2066 6f72 6765 7420 6120 7075 7265  to forget a pure
-00017810: 2064 6174 6120 7461 736b 0a20 2020 2020   data task.     
-00017820: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00017830: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00017840: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
-00017850: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00017860: 2020 2020 2020 2020 2020 2023 2049 7427             # It'
-00017870: 7320 6f6b 2074 6f20 666f 7267 6574 2061  s ok to forget a
-00017880: 2074 6173 6b20 7769 7468 2066 6f72 676f   task with forgo
-00017890: 7474 656e 2064 6570 656e 6465 6e63 6965  tten dependencie
-000178a0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000178b0: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
-000178c0: 2020 2065 6c69 6620 6e6f 7420 7473 2e77     elif not ts.w
-000178d0: 686f 5f77 616e 7473 2061 6e64 206e 6f74  ho_wants and not
-000178e0: 2074 732e 7761 6974 6572 7320 616e 6420   ts.waiters and 
-000178f0: 6e6f 7420 7473 2e64 6570 656e 6465 6e74  not ts.dependent
-00017900: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00017910: 2020 2023 2049 7427 7320 6f6b 2074 6f20     # It's ok to 
-00017920: 666f 7267 6574 2061 2074 6173 6b20 7468  forget a task th
-00017930: 6174 206e 6f62 6f64 7920 6e65 6564 730a  at nobody needs.
-00017940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017950: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
-00017960: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00017970: 2020 2020 2020 2072 6169 7365 2041 7373         raise Ass
-00017980: 6572 7469 6f6e 4572 726f 7228 2255 6e72  ertionError("Unr
-00017990: 6561 6368 6162 6c65 222c 2073 7472 2874  eachable", str(t
-000179a0: 7329 2920 2023 2070 7261 676d 613a 206e  s))  # pragma: n
-000179b0: 6f63 6f76 6572 0a0a 2020 2020 2020 2020  ocover..        
-000179c0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-000179d0: 2052 6563 7320 3d20 7b7d 0a20 2020 2020   Recs = {}.     
-000179e0: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
-000179f0: 4d73 6773 203d 207b 7d0a 2020 2020 2020  Msgs = {}.      
-00017a00: 2020 7365 6c66 2e5f 7072 6f70 6167 6174    self._propagat
-00017a10: 655f 666f 7267 6f74 7465 6e28 7473 2c20  e_forgotten(ts, 
-00017a20: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-00017a30: 2077 6f72 6b65 725f 6d73 6773 2c20 7374   worker_msgs, st
-00017a40: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-00017a50: 2020 2020 636c 6965 6e74 5f6d 7367 7320      client_msgs 
-00017a60: 3d20 5f74 6173 6b5f 746f 5f63 6c69 656e  = _task_to_clien
-00017a70: 745f 6d73 6773 2874 7329 0a20 2020 2020  t_msgs(ts).     
-00017a80: 2020 2073 656c 662e 5f72 656d 6f76 655f     self._remove_
-00017a90: 6b65 7928 6b65 7929 0a0a 2020 2020 2020  key(key)..      
-00017aa0: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
-00017ab0: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-00017ac0: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-00017ad0: 6773 0a0a 2020 2020 2320 7b0a 2020 2020  gs..    # {.    
-00017ae0: 2320 2020 2020 2873 7461 7274 2c20 6669  #     (start, fi
-00017af0: 6e69 7368 293a 0a20 2020 2023 2020 2020  nish):.    #    
-00017b00: 2074 7261 6e73 6974 696f 6e5f 3c73 7461   transition_<sta
-00017b10: 7274 3e5f 3c66 696e 6973 683e 280a 2020  rt>_<finish>(.  
-00017b20: 2020 2320 2020 2020 2020 2020 7365 6c66    #         self
-00017b30: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
-00017b40: 756c 7573 5f69 643a 2073 7472 2c20 2a2a  ulus_id: str, **
-00017b50: 6b77 6172 6773 0a20 2020 2023 2020 2020  kwargs.    #    
-00017b60: 2029 202d 3e20 2872 6563 6f6d 6d65 6e64   ) -> (recommend
-00017b70: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
-00017b80: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-00017b90: 290a 2020 2020 2320 7d0a 2020 2020 5f54  ).    # }.    _T
-00017ba0: 5241 4e53 4954 494f 4e53 5f54 4142 4c45  RANSITIONS_TABLE
-00017bb0: 3a20 436c 6173 7356 6172 5b0a 2020 2020  : ClassVar[.    
-00017bc0: 2020 2020 4d61 7070 696e 675b 0a20 2020      Mapping[.   
-00017bd0: 2020 2020 2020 2020 2074 7570 6c65 5b54           tuple[T
-00017be0: 6173 6b53 7461 7465 5374 6174 652c 2054  askStateState, T
-00017bf0: 6173 6b53 7461 7465 5374 6174 655d 2c0a  askStateState],.
-00017c00: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
-00017c10: 6162 6c65 5b2e 2e2e 2c20 5265 6373 4d73  able[..., RecsMs
-00017c20: 6773 5d2c 0a20 2020 2020 2020 205d 0a20  gs],.        ]. 
-00017c30: 2020 205d 203d 207b 0a20 2020 2020 2020     ] = {.       
-00017c40: 2028 2272 656c 6561 7365 6422 2c20 2277   ("released", "w
-00017c50: 6169 7469 6e67 2229 3a20 7472 616e 7369  aiting"): transi
-00017c60: 7469 6f6e 5f72 656c 6561 7365 645f 7761  tion_released_wa
-00017c70: 6974 696e 672c 0a20 2020 2020 2020 2028  iting,.        (
-00017c80: 2277 6169 7469 6e67 222c 2022 7265 6c65  "waiting", "rele
-00017c90: 6173 6564 2229 3a20 7472 616e 7369 7469  ased"): transiti
-00017ca0: 6f6e 5f77 6169 7469 6e67 5f72 656c 6561  on_waiting_relea
-00017cb0: 7365 642c 0a20 2020 2020 2020 2028 2277  sed,.        ("w
-00017cc0: 6169 7469 6e67 222c 2022 7072 6f63 6573  aiting", "proces
-00017cd0: 7369 6e67 2229 3a20 7472 616e 7369 7469  sing"): transiti
-00017ce0: 6f6e 5f77 6169 7469 6e67 5f70 726f 6365  on_waiting_proce
-00017cf0: 7373 696e 672c 0a20 2020 2020 2020 2028  ssing,.        (
-00017d00: 2277 6169 7469 6e67 222c 2022 6e6f 2d77  "waiting", "no-w
-00017d10: 6f72 6b65 7222 293a 2074 7261 6e73 6974  orker"): transit
-00017d20: 696f 6e5f 7761 6974 696e 675f 6e6f 5f77  ion_waiting_no_w
-00017d30: 6f72 6b65 722c 0a20 2020 2020 2020 2028  orker,.        (
-00017d40: 2277 6169 7469 6e67 222c 2022 7175 6575  "waiting", "queu
-00017d50: 6564 2229 3a20 7472 616e 7369 7469 6f6e  ed"): transition
-00017d60: 5f77 6169 7469 6e67 5f71 7565 7565 642c  _waiting_queued,
-00017d70: 0a20 2020 2020 2020 2028 2277 6169 7469  .        ("waiti
-00017d80: 6e67 222c 2022 6d65 6d6f 7279 2229 3a20  ng", "memory"): 
-00017d90: 7472 616e 7369 7469 6f6e 5f77 6169 7469  transition_waiti
-00017da0: 6e67 5f6d 656d 6f72 792c 0a20 2020 2020  ng_memory,.     
-00017db0: 2020 2028 2271 7565 7565 6422 2c20 2272     ("queued", "r
-00017dc0: 656c 6561 7365 6422 293a 2074 7261 6e73  eleased"): trans
-00017dd0: 6974 696f 6e5f 7175 6575 6564 5f72 656c  ition_queued_rel
-00017de0: 6561 7365 642c 0a20 2020 2020 2020 2028  eased,.        (
-00017df0: 2271 7565 7565 6422 2c20 2270 726f 6365  "queued", "proce
-00017e00: 7373 696e 6722 293a 2074 7261 6e73 6974  ssing"): transit
-00017e10: 696f 6e5f 7175 6575 6564 5f70 726f 6365  ion_queued_proce
-00017e20: 7373 696e 672c 0a20 2020 2020 2020 2028  ssing,.        (
-00017e30: 2270 726f 6365 7373 696e 6722 2c20 2272  "processing", "r
-00017e40: 656c 6561 7365 6422 293a 2074 7261 6e73  eleased"): trans
-00017e50: 6974 696f 6e5f 7072 6f63 6573 7369 6e67  ition_processing
-00017e60: 5f72 656c 6561 7365 642c 0a20 2020 2020  _released,.     
-00017e70: 2020 2028 2270 726f 6365 7373 696e 6722     ("processing"
-00017e80: 2c20 226d 656d 6f72 7922 293a 2074 7261  , "memory"): tra
-00017e90: 6e73 6974 696f 6e5f 7072 6f63 6573 7369  nsition_processi
-00017ea0: 6e67 5f6d 656d 6f72 792c 0a20 2020 2020  ng_memory,.     
-00017eb0: 2020 2028 2270 726f 6365 7373 696e 6722     ("processing"
-00017ec0: 2c20 2265 7272 6564 2229 3a20 7472 616e  , "erred"): tran
-00017ed0: 7369 7469 6f6e 5f70 726f 6365 7373 696e  sition_processin
-00017ee0: 675f 6572 7265 642c 0a20 2020 2020 2020  g_erred,.       
-00017ef0: 2028 226e 6f2d 776f 726b 6572 222c 2022   ("no-worker", "
-00017f00: 7265 6c65 6173 6564 2229 3a20 7472 616e  released"): tran
-00017f10: 7369 7469 6f6e 5f6e 6f5f 776f 726b 6572  sition_no_worker
-00017f20: 5f72 656c 6561 7365 642c 0a20 2020 2020  _released,.     
-00017f30: 2020 2028 226e 6f2d 776f 726b 6572 222c     ("no-worker",
-00017f40: 2022 7072 6f63 6573 7369 6e67 2229 3a20   "processing"): 
-00017f50: 7472 616e 7369 7469 6f6e 5f6e 6f5f 776f  transition_no_wo
-00017f60: 726b 6572 5f70 726f 6365 7373 696e 672c  rker_processing,
-00017f70: 0a20 2020 2020 2020 2028 2272 656c 6561  .        ("relea
-00017f80: 7365 6422 2c20 2266 6f72 676f 7474 656e  sed", "forgotten
-00017f90: 2229 3a20 7472 616e 7369 7469 6f6e 5f72  "): transition_r
-00017fa0: 656c 6561 7365 645f 666f 7267 6f74 7465  eleased_forgotte
-00017fb0: 6e2c 0a20 2020 2020 2020 2028 226d 656d  n,.        ("mem
-00017fc0: 6f72 7922 2c20 2266 6f72 676f 7474 656e  ory", "forgotten
-00017fd0: 2229 3a20 7472 616e 7369 7469 6f6e 5f6d  "): transition_m
-00017fe0: 656d 6f72 795f 666f 7267 6f74 7465 6e2c  emory_forgotten,
-00017ff0: 0a20 2020 2020 2020 2028 2265 7272 6564  .        ("erred
-00018000: 222c 2022 7265 6c65 6173 6564 2229 3a20  ", "released"): 
-00018010: 7472 616e 7369 7469 6f6e 5f65 7272 6564  transition_erred
-00018020: 5f72 656c 6561 7365 642c 0a20 2020 2020  _released,.     
-00018030: 2020 2028 226d 656d 6f72 7922 2c20 2272     ("memory", "r
-00018040: 656c 6561 7365 6422 293a 2074 7261 6e73  eleased"): trans
-00018050: 6974 696f 6e5f 6d65 6d6f 7279 5f72 656c  ition_memory_rel
-00018060: 6561 7365 642c 0a20 2020 2020 2020 2028  eased,.        (
-00018070: 2272 656c 6561 7365 6422 2c20 2265 7272  "released", "err
-00018080: 6564 2229 3a20 7472 616e 7369 7469 6f6e  ed"): transition
-00018090: 5f72 656c 6561 7365 645f 6572 7265 642c  _released_erred,
-000180a0: 0a20 2020 207d 0a0a 2020 2020 6465 6620  .    }..    def 
-000180b0: 7374 6f72 7928 7365 6c66 2c20 2a6b 6579  story(self, *key
-000180c0: 735f 6f72 5f74 6173 6b73 5f6f 725f 7374  s_or_tasks_or_st
-000180d0: 696d 756c 693a 2073 7472 207c 2054 6173  imuli: str | Tas
-000180e0: 6b53 7461 7465 2920 2d3e 206c 6973 745b  kState) -> list[
-000180f0: 5472 616e 7369 7469 6f6e 5d3a 0a20 2020  Transition]:.   
-00018100: 2020 2020 2022 2222 4765 7420 616c 6c20       """Get all 
-00018110: 7472 616e 7369 7469 6f6e 7320 7468 6174  transitions that
-00018120: 2074 6f75 6368 206f 6e65 206f 6620 7468   touch one of th
-00018130: 6520 696e 7075 7420 6b65 7973 206f 7220  e input keys or 
-00018140: 7374 696d 756c 7573 5f69 6427 7322 2222  stimulus_id's"""
-00018150: 0a20 2020 2020 2020 206b 6579 735f 6f72  .        keys_or
-00018160: 5f73 7469 6d75 6c69 203d 207b 0a20 2020  _stimuli = {.   
-00018170: 2020 2020 2020 2020 206b 6579 2e6b 6579           key.key
-00018180: 2069 6620 6973 696e 7374 616e 6365 286b   if isinstance(k
-00018190: 6579 2c20 5461 736b 5374 6174 6529 2065  ey, TaskState) e
-000181a0: 6c73 6520 6b65 790a 2020 2020 2020 2020  lse key.        
-000181b0: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-000181c0: 6579 735f 6f72 5f74 6173 6b73 5f6f 725f  eys_or_tasks_or_
-000181d0: 7374 696d 756c 690a 2020 2020 2020 2020  stimuli.        
-000181e0: 7d0a 2020 2020 2020 2020 7265 7475 726e  }.        return
-000181f0: 2073 6368 6564 756c 6572 5f73 746f 7279   scheduler_story
-00018200: 286b 6579 735f 6f72 5f73 7469 6d75 6c69  (keys_or_stimuli
-00018210: 2c20 7365 6c66 2e74 7261 6e73 6974 696f  , self.transitio
-00018220: 6e5f 6c6f 6729 0a0a 2020 2020 2323 2323  n_log)..    ####
-00018230: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018240: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-00018250: 2041 7373 6967 6e69 6e67 2054 6173 6b73   Assigning Tasks
-00018260: 2074 6f20 576f 726b 6572 7320 230a 2020   to Workers #.  
-00018270: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-00018280: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018290: 0a0a 2020 2020 6465 6620 6973 5f72 6f6f  ..    def is_roo
-000182a0: 7469 7368 2873 656c 662c 2074 733a 2054  tish(self, ts: T
-000182b0: 6173 6b53 7461 7465 2920 2d3e 2062 6f6f  askState) -> boo
-000182c0: 6c3a 0a20 2020 2020 2020 2022 2222 0a20  l:.        """. 
-000182d0: 2020 2020 2020 2057 6865 7468 6572 2060         Whether `
-000182e0: 6074 7360 6020 6973 2061 2072 6f6f 7420  `ts`` is a root 
-000182f0: 6f72 2072 6f6f 742d 6c69 6b65 2074 6173  or root-like tas
-00018300: 6b2e 0a0a 2020 2020 2020 2020 526f 6f74  k...        Root
-00018310: 2d69 7368 2074 6173 6b73 2061 7265 2070  -ish tasks are p
-00018320: 6172 7420 6f66 2061 2067 726f 7570 2074  art of a group t
-00018330: 6861 7427 7320 6d75 6368 206c 6172 6765  hat's much large
-00018340: 7220 7468 616e 2074 6865 2063 6c75 7374  r than the clust
-00018350: 6572 2c0a 2020 2020 2020 2020 616e 6420  er,.        and 
-00018360: 6861 7665 2066 6577 206f 7220 6e6f 2064  have few or no d
-00018370: 6570 656e 6465 6e63 6965 732e 0a20 2020  ependencies..   
-00018380: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00018390: 2069 6620 7473 2e72 6573 6f75 7263 655f   if ts.resource_
-000183a0: 7265 7374 7269 6374 696f 6e73 206f 7220  restrictions or 
-000183b0: 7473 2e77 6f72 6b65 725f 7265 7374 7269  ts.worker_restri
-000183c0: 6374 696f 6e73 206f 7220 7473 2e68 6f73  ctions or ts.hos
-000183d0: 745f 7265 7374 7269 6374 696f 6e73 3a0a  t_restrictions:.
-000183e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000183f0: 726e 2046 616c 7365 0a20 2020 2020 2020  rn False.       
-00018400: 2074 6720 3d20 7473 2e67 726f 7570 0a20   tg = ts.group. 
-00018410: 2020 2020 2020 2023 2054 4f44 4f20 7368         # TODO sh
-00018420: 6f72 742d 6369 7263 7569 7420 746f 2054  ort-circuit to T
-00018430: 7275 6520 6966 2060 6e6f 7420 7473 2e64  rue if `not ts.d
-00018440: 6570 656e 6465 6e63 6965 7360 3f0a 2020  ependencies`?.  
-00018450: 2020 2020 2020 7265 7475 726e 2028 0a20        return (. 
-00018460: 2020 2020 2020 2020 2020 206c 656e 2874             len(t
-00018470: 6729 203e 2073 656c 662e 746f 7461 6c5f  g) > self.total_
-00018480: 6e74 6872 6561 6473 202a 2032 0a20 2020  nthreads * 2.   
-00018490: 2020 2020 2020 2020 2061 6e64 206c 656e           and len
-000184a0: 2874 672e 6465 7065 6e64 656e 6369 6573  (tg.dependencies
-000184b0: 2920 3c20 350a 2020 2020 2020 2020 2020  ) < 5.          
-000184c0: 2020 616e 6420 7375 6d28 6d61 7028 6c65    and sum(map(le
-000184d0: 6e2c 2074 672e 6465 7065 6e64 656e 6369  n, tg.dependenci
-000184e0: 6573 2929 203c 2035 0a20 2020 2020 2020  es)) < 5.       
-000184f0: 2029 0a0a 2020 2020 6465 6620 6368 6563   )..    def chec
-00018500: 6b5f 6964 6c65 5f73 6174 7572 6174 6564  k_idle_saturated
-00018510: 2873 656c 662c 2077 733a 2057 6f72 6b65  (self, ws: Worke
-00018520: 7253 7461 7465 2c20 6f63 633a 2066 6c6f  rState, occ: flo
-00018530: 6174 203d 202d 312e 3029 202d 3e20 4e6f  at = -1.0) -> No
-00018540: 6e65 3a0a 2020 2020 2020 2020 2222 2255  ne:.        """U
-00018550: 7064 6174 6520 7468 6520 7374 6174 7573  pdate the status
-00018560: 206f 6620 7468 6520 6964 6c65 2061 6e64   of the idle and
-00018570: 2073 6174 7572 6174 6564 2073 7461 7465   saturated state
-00018580: 0a0a 2020 2020 2020 2020 5468 6520 7363  ..        The sc
-00018590: 6865 6475 6c65 7220 6b65 6570 7320 7472  heduler keeps tr
-000185a0: 6163 6b20 6f66 2077 6f72 6b65 7273 2074  ack of workers t
-000185b0: 6861 7420 6172 6520 2e2e 0a0a 2020 2020  hat are ....    
-000185c0: 2020 2020 2d20 2053 6174 7572 6174 6564      -  Saturated
-000185d0: 3a20 6861 7665 2065 6e6f 7567 6820 776f  : have enough wo
-000185e0: 726b 2074 6f20 7374 6179 2062 7573 790a  rk to stay busy.
-000185f0: 2020 2020 2020 2020 2d20 2049 646c 653a          -  Idle:
-00018600: 2064 6f20 6e6f 7420 6861 7665 2065 6e6f   do not have eno
-00018610: 7567 6820 776f 726b 2074 6f20 7374 6179  ugh work to stay
-00018620: 2062 7573 790a 0a20 2020 2020 2020 2054   busy..        T
-00018630: 6865 7920 6172 6520 636f 6e73 6964 6572  hey are consider
-00018640: 6564 2073 6174 7572 6174 6564 2069 6620  ed saturated if 
-00018650: 7468 6579 2062 6f74 6820 6861 7665 2065  they both have e
-00018660: 6e6f 7567 6820 7461 736b 7320 746f 206f  nough tasks to o
-00018670: 6363 7570 790a 2020 2020 2020 2020 616c  ccupy.        al
-00018680: 6c20 6f66 2074 6865 6972 2074 6872 6561  l of their threa
-00018690: 6473 2c20 616e 6420 6966 2074 6865 2065  ds, and if the e
-000186a0: 7870 6563 7465 6420 7275 6e74 696d 6520  xpected runtime 
-000186b0: 6f66 2074 686f 7365 2074 6173 6b73 2069  of those tasks i
-000186c0: 730a 2020 2020 2020 2020 6c61 7267 6520  s.        large 
-000186d0: 656e 6f75 6768 2e0a 0a20 2020 2020 2020  enough...       
-000186e0: 2049 6620 6060 6469 7374 7269 6275 7465   If ``distribute
-000186f0: 642e 7363 6865 6475 6c65 722e 776f 726b  d.scheduler.work
-00018700: 6572 2d73 6174 7572 6174 696f 6e60 6020  er-saturation`` 
-00018710: 6973 206e 6f74 2060 6069 6e66 6060 0a20  is not ``inf``. 
-00018720: 2020 2020 2020 2028 7363 6865 6475 6c65         (schedule
-00018730: 722d 7369 6465 2071 7565 7569 6e67 2069  r-side queuing i
-00018740: 7320 656e 6162 6c65 6429 2c20 7468 6579  s enabled), they
-00018750: 2061 7265 2063 6f6e 7369 6465 7265 6420   are considered 
-00018760: 6964 6c65 0a20 2020 2020 2020 2069 6620  idle.        if 
-00018770: 7468 6579 2068 6176 6520 6665 7765 7220  they have fewer 
-00018780: 7461 736b 7320 7072 6f63 6573 7369 6e67  tasks processing
-00018790: 2074 6861 6e20 7468 6520 6060 776f 726b   than the ``work
-000187a0: 6572 2d73 6174 7572 6174 696f 6e60 600a  er-saturation``.
-000187b0: 2020 2020 2020 2020 7468 7265 7368 6f6c          threshol
-000187c0: 6420 6469 6374 6174 6573 2e0a 0a20 2020  d dictates...   
-000187d0: 2020 2020 204f 7468 6572 7769 7365 2c20       Otherwise, 
-000187e0: 7468 6579 2061 7265 2063 6f6e 7369 6465  they are conside
-000187f0: 7265 6420 6964 6c65 2069 6620 7468 6579  red idle if they
-00018800: 2068 6176 6520 6665 7765 7220 7461 736b   have fewer task
-00018810: 7320 7072 6f63 6573 7369 6e67 0a20 2020  s processing.   
-00018820: 2020 2020 2074 6861 6e20 7468 7265 6164       than thread
-00018830: 732c 206f 7220 6966 2074 6865 6972 2074  s, or if their t
-00018840: 6173 6b73 2720 746f 7461 6c20 6578 7065  asks' total expe
-00018850: 6374 6564 2072 756e 7469 6d65 2069 7320  cted runtime is 
-00018860: 6c65 7373 2074 6861 6e20 6861 6c66 0a20  less than half. 
-00018870: 2020 2020 2020 2074 6865 2065 7870 6563         the expec
-00018880: 7465 6420 7275 6e74 696d 6520 6f66 2074  ted runtime of t
-00018890: 6865 2073 616d 6520 6e75 6d62 6572 206f  he same number o
-000188a0: 6620 6176 6572 6167 6520 7461 736b 732e  f average tasks.
-000188b0: 0a0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
-000188c0: 7320 7573 6566 756c 2066 6f72 206c 6f61  s useful for loa
-000188d0: 6420 6261 6c61 6e63 696e 6720 616e 6420  d balancing and 
-000188e0: 6164 6170 7469 7669 7479 2e0a 2020 2020  adaptivity..    
-000188f0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00018900: 6966 2073 656c 662e 746f 7461 6c5f 6e74  if self.total_nt
-00018910: 6872 6561 6473 203d 3d20 3020 6f72 2077  hreads == 0 or w
-00018920: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-00018930: 7573 2e63 6c6f 7365 643a 0a20 2020 2020  us.closed:.     
-00018940: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-00018950: 2020 2020 2020 6966 206f 6363 203c 2030        if occ < 0
-00018960: 3a0a 2020 2020 2020 2020 2020 2020 6f63  :.            oc
-00018970: 6320 3d20 7773 2e6f 6363 7570 616e 6379  c = ws.occupancy
-00018980: 0a0a 2020 2020 2020 2020 7020 3d20 6c65  ..        p = le
-00018990: 6e28 7773 2e70 726f 6365 7373 696e 6729  n(ws.processing)
-000189a0: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-000189b0: 6174 7572 6174 6564 2e64 6973 6361 7264  aturated.discard
-000189c0: 2877 7329 0a20 2020 2020 2020 2069 6620  (ws).        if 
-000189d0: 7773 2e73 7461 7475 7320 213d 2053 7461  ws.status != Sta
-000189e0: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
-000189f0: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
-00018a00: 6c65 2e70 6f70 2877 732e 6164 6472 6573  le.pop(ws.addres
-00018a10: 732c 204e 6f6e 6529 0a20 2020 2020 2020  s, None).       
-00018a20: 2065 6c69 6620 7365 6c66 2e69 735f 756e   elif self.is_un
-00018a30: 6f63 6375 7069 6564 2877 732c 206f 6363  occupied(ws, occ
-00018a40: 2c20 7029 3a0a 2020 2020 2020 2020 2020  , p):.          
-00018a50: 2020 7365 6c66 2e69 646c 655b 7773 2e61    self.idle[ws.a
-00018a60: 6464 7265 7373 5d20 3d20 7773 0a20 2020  ddress] = ws.   
-00018a70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00018a80: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-00018a90: 2e70 6f70 2877 732e 6164 6472 6573 732c  .pop(ws.address,
-00018aa0: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
-00018ab0: 2020 206e 6320 3d20 7773 2e6e 7468 7265     nc = ws.nthre
-00018ac0: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
-00018ad0: 6966 2070 203e 206e 633a 0a20 2020 2020  if p > nc:.     
-00018ae0: 2020 2020 2020 2020 2020 2070 656e 6469             pendi
-00018af0: 6e67 203d 206f 6363 202a 2028 7020 2d20  ng = occ * (p - 
-00018b00: 6e63 2920 2f20 2870 202a 206e 6329 0a20  nc) / (p * nc). 
-00018b10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00018b20: 6620 302e 3420 3c20 7065 6e64 696e 6720  f 0.4 < pending 
-00018b30: 3e20 312e 3920 2a20 2873 656c 662e 746f  > 1.9 * (self.to
-00018b40: 7461 6c5f 6f63 6375 7061 6e63 7920 2f20  tal_occupancy / 
-00018b50: 7365 6c66 2e74 6f74 616c 5f6e 7468 7265  self.total_nthre
-00018b60: 6164 7329 3a0a 2020 2020 2020 2020 2020  ads):.          
-00018b70: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00018b80: 6174 7572 6174 6564 2e61 6464 2877 7329  aturated.add(ws)
-00018b90: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00018ba0: 205f 776f 726b 6572 5f66 756c 6c28 7773   _worker_full(ws
-00018bb0: 2c20 7365 6c66 2e57 4f52 4b45 525f 5341  , self.WORKER_SA
-00018bc0: 5455 5241 5449 4f4e 2920 616e 6420 7773  TURATION) and ws
-00018bd0: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
-00018be0: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
-00018bf0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-00018c00: 5f74 6173 6b5f 636f 756e 742e 6164 6428  _task_count.add(
-00018c10: 7773 290a 2020 2020 2020 2020 656c 7365  ws).        else
-00018c20: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00018c30: 6c66 2e69 646c 655f 7461 736b 5f63 6f75  lf.idle_task_cou
-00018c40: 6e74 2e64 6973 6361 7264 2877 7329 0a0a  nt.discard(ws)..
-00018c50: 2020 2020 6465 6620 6973 5f75 6e6f 6363      def is_unocc
-00018c60: 7570 6965 6428 0a20 2020 2020 2020 2073  upied(.        s
-00018c70: 656c 662c 2077 733a 2057 6f72 6b65 7253  elf, ws: WorkerS
-00018c80: 7461 7465 2c20 6f63 6375 7061 6e63 793a  tate, occupancy:
-00018c90: 2066 6c6f 6174 2c20 6e70 726f 6365 7373   float, nprocess
-00018ca0: 696e 673a 2069 6e74 0a20 2020 2029 202d  ing: int.    ) -
-00018cb0: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-00018cc0: 6e74 6872 6561 6473 203d 2077 732e 6e74  nthreads = ws.nt
-00018cd0: 6872 6561 6473 0a20 2020 2020 2020 2072  hreads.        r
-00018ce0: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
-00018cf0: 2020 2020 6e70 726f 6365 7373 696e 6720      nprocessing 
-00018d00: 3c20 6e74 6872 6561 6473 0a20 2020 2020  < nthreads.     
-00018d10: 2020 2020 2020 206f 7220 6f63 6375 7061         or occupa
-00018d20: 6e63 7920 3c20 6e74 6872 6561 6473 202a  ncy < nthreads *
-00018d30: 2028 7365 6c66 2e74 6f74 616c 5f6f 6363   (self.total_occ
-00018d40: 7570 616e 6379 202f 2073 656c 662e 746f  upancy / self.to
-00018d50: 7461 6c5f 6e74 6872 6561 6473 2920 2f20  tal_nthreads) / 
-00018d60: 320a 2020 2020 2020 2020 290a 0a20 2020  2.        )..   
-00018d70: 2064 6566 2067 6574 5f63 6f6d 6d5f 636f   def get_comm_co
-00018d80: 7374 2873 656c 662c 2074 733a 2054 6173  st(self, ts: Tas
-00018d90: 6b53 7461 7465 2c20 7773 3a20 576f 726b  kState, ws: Work
-00018da0: 6572 5374 6174 6529 202d 3e20 666c 6f61  erState) -> floa
-00018db0: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
-00018dc0: 2020 2020 2020 2047 6574 2074 6865 2065         Get the e
-00018dd0: 7374 696d 6174 6564 2063 6f6d 6d75 6e69  stimated communi
-00018de0: 6361 7469 6f6e 2063 6f73 7420 2869 6e20  cation cost (in 
-00018df0: 732e 2920 746f 2063 6f6d 7075 7465 2074  s.) to compute t
-00018e00: 6865 2074 6173 6b0a 2020 2020 2020 2020  he task.        
-00018e10: 6f6e 2074 6865 2067 6976 656e 2077 6f72  on the given wor
-00018e20: 6b65 722e 0a20 2020 2020 2020 2022 2222  ker..        """
-00018e30: 0a20 2020 2020 2020 2069 6620 3130 202a  .        if 10 *
-00018e40: 206c 656e 2874 732e 6465 7065 6e64 656e   len(ts.dependen
-00018e50: 6369 6573 2920 3c20 6c65 6e28 7773 2e68  cies) < len(ws.h
-00018e60: 6173 5f77 6861 7429 3a0a 2020 2020 2020  as_what):.      
-00018e70: 2020 2020 2020 2320 496e 2074 6865 2063        # In the c
-00018e80: 6f6d 6d6f 6e20 6361 7365 2077 6865 7265  ommon case where
-00018e90: 2074 6865 206e 756d 6265 7220 6f66 2064   the number of d
-00018ea0: 6570 656e 6465 6e63 6965 7320 6973 0a20  ependencies is. 
-00018eb0: 2020 2020 2020 2020 2020 2023 206d 7563             # muc
-00018ec0: 6820 6c65 7373 2074 6861 6e20 7468 6520  h less than the 
-00018ed0: 6e75 6d62 6572 206f 6620 7461 736b 7320  number of tasks 
-00018ee0: 7468 6174 2077 6520 6861 7665 2c0a 2020  that we have,.  
-00018ef0: 2020 2020 2020 2020 2020 2320 636f 6e73            # cons
-00018f00: 7472 7563 7420 7468 6520 7365 7420 6f66  truct the set of
-00018f10: 2064 6570 7320 7468 6174 2072 6571 7569   deps that requi
-00018f20: 7265 2063 6f6d 6d75 6e69 6361 7469 6f6e  re communication
-00018f30: 2069 6e0a 2020 2020 2020 2020 2020 2020   in.            
-00018f40: 2320 4f28 6c65 6e28 6465 7065 6e64 656e  # O(len(dependen
-00018f50: 6369 6573 2929 2072 6174 6865 7220 7468  cies)) rather th
-00018f60: 616e 204f 286c 656e 2868 6173 5f77 6861  an O(len(has_wha
-00018f70: 7429 2920 7469 6d65 2e0a 2020 2020 2020  t)) time..      
-00018f80: 2020 2020 2020 2320 4661 6374 6f72 206f        # Factor o
-00018f90: 6620 3130 2069 7320 6120 6775 6573 7320  f 10 is a guess 
-00018fa0: 6174 2074 6865 206f 7665 7268 6561 6420  at the overhead 
-00018fb0: 6f66 2065 7870 6c69 6369 740a 2020 2020  of explicit.    
-00018fc0: 2020 2020 2020 2020 2320 6974 6572 6174          # iterat
-00018fd0: 696f 6e20 6173 206f 7070 6f73 6564 2074  ion as opposed t
-00018fe0: 6f20 6a75 7374 2063 616c 6c69 6e67 2073  o just calling s
-00018ff0: 6574 2e64 6966 6665 7265 6e63 650a 2020  et.difference.  
-00019000: 2020 2020 2020 2020 2020 6465 7073 203d            deps =
-00019010: 207b 6465 7020 666f 7220 6465 7020 696e   {dep for dep in
-00019020: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-00019030: 2069 6620 6465 7020 6e6f 7420 696e 2077   if dep not in w
-00019040: 732e 6861 735f 7768 6174 7d0a 2020 2020  s.has_what}.    
-00019050: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00019060: 2020 2020 2020 6465 7073 203d 2074 732e        deps = ts.
-00019070: 6465 7065 6e64 656e 6369 6573 2e64 6966  dependencies.dif
-00019080: 6665 7265 6e63 6528 7773 2e68 6173 5f77  ference(ws.has_w
-00019090: 6861 7429 0a20 2020 2020 2020 206e 6279  hat).        nby
-000190a0: 7465 7320 3d20 7375 6d28 6474 732e 6e62  tes = sum(dts.nb
-000190b0: 7974 6573 2066 6f72 2064 7473 2069 6e20  ytes for dts in 
-000190c0: 6465 7073 290a 2020 2020 2020 2020 7265  deps).        re
-000190d0: 7475 726e 206e 6279 7465 7320 2f20 7365  turn nbytes / se
-000190e0: 6c66 2e62 616e 6477 6964 7468 0a0a 2020  lf.bandwidth..  
-000190f0: 2020 6465 6620 6765 745f 7461 736b 5f64    def get_task_d
-00019100: 7572 6174 696f 6e28 7365 6c66 2c20 7473  uration(self, ts
-00019110: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-00019120: 666c 6f61 743a 0a20 2020 2020 2020 2022  float:.        "
-00019130: 2222 4765 7420 7468 6520 6573 7469 6d61  ""Get the estima
-00019140: 7465 6420 636f 6d70 7574 6174 696f 6e20  ted computation 
-00019150: 636f 7374 206f 6620 7468 6520 6769 7665  cost of the give
-00019160: 6e20 7461 736b 2028 6e6f 7420 696e 636c  n task (not incl
-00019170: 7564 696e 670a 2020 2020 2020 2020 616e  uding.        an
-00019180: 7920 636f 6d6d 756e 6963 6174 696f 6e20  y communication 
-00019190: 636f 7374 292e 0a0a 2020 2020 2020 2020  cost)...        
-000191a0: 4966 206e 6f20 6461 7461 2068 6173 2062  If no data has b
-000191b0: 6565 6e20 6f62 7365 7276 6564 2c20 7661  een observed, va
-000191c0: 6c75 6520 6f66 0a20 2020 2020 2020 2060  lue of.        `
-000191d0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-000191e0: 6475 6c65 722e 6465 6661 756c 742d 7461  duler.default-ta
-000191f0: 736b 2d64 7572 6174 696f 6e73 6020 6172  sk-durations` ar
-00019200: 6520 7573 6564 2e20 4966 206e 6f6e 6520  e used. If none 
-00019210: 6973 2073 6574 0a20 2020 2020 2020 2066  is set.        f
-00019220: 6f72 2074 6869 7320 7461 736b 2c20 6064  or this task, `d
-00019230: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-00019240: 756c 6572 2e75 6e6b 6e6f 776e 2d74 6173  uler.unknown-tas
-00019250: 6b2d 6475 7261 7469 6f6e 6020 6973 2075  k-duration` is u
-00019260: 7365 640a 2020 2020 2020 2020 696e 7374  sed.        inst
-00019270: 6561 642e 0a20 2020 2020 2020 2022 2222  ead..        """
-00019280: 0a20 2020 2020 2020 2064 7572 6174 696f  .        duratio
-00019290: 6e3a 2066 6c6f 6174 203d 2074 732e 7072  n: float = ts.pr
-000192a0: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
-000192b0: 6572 6167 650a 2020 2020 2020 2020 6966  erage.        if
-000192c0: 2064 7572 6174 696f 6e20 3e3d 2030 3a0a   duration >= 0:.
-000192d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000192e0: 726e 2064 7572 6174 696f 6e0a 0a20 2020  rn duration..   
-000192f0: 2020 2020 2073 203d 2073 656c 662e 756e       s = self.un
-00019300: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 732e  known_durations.
-00019310: 6765 7428 7473 2e70 7265 6669 782e 6e61  get(ts.prefix.na
-00019320: 6d65 290a 2020 2020 2020 2020 6966 2073  me).        if s
-00019330: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00019340: 2020 2020 2020 7365 6c66 2e75 6e6b 6e6f        self.unkno
-00019350: 776e 5f64 7572 6174 696f 6e73 5b74 732e  wn_durations[ts.
-00019360: 7072 6566 6978 2e6e 616d 655d 203d 2073  prefix.name] = s
-00019370: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-00019380: 2073 2e61 6464 2874 7329 0a20 2020 2020   s.add(ts).     
-00019390: 2020 2072 6574 7572 6e20 7365 6c66 2e55     return self.U
-000193a0: 4e4b 4e4f 574e 5f54 4153 4b5f 4455 5241  NKNOWN_TASK_DURA
-000193b0: 5449 4f4e 0a0a 2020 2020 6465 6620 7661  TION..    def va
-000193c0: 6c69 645f 776f 726b 6572 7328 7365 6c66  lid_workers(self
-000193d0: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
-000193e0: 202d 3e20 7365 745b 576f 726b 6572 5374   -> set[WorkerSt
-000193f0: 6174 655d 207c 204e 6f6e 653a 0a20 2020  ate] | None:.   
-00019400: 2020 2020 2022 2222 5265 7475 726e 2073       """Return s
-00019410: 6574 206f 6620 6375 7272 656e 746c 7920  et of currently 
-00019420: 7661 6c69 6420 776f 726b 6572 7320 666f  valid workers fo
-00019430: 7220 6b65 790a 0a20 2020 2020 2020 2049  r key..        I
-00019440: 6620 616c 6c20 776f 726b 6572 7320 6172  f all workers ar
-00019450: 6520 7661 6c69 6420 7468 656e 2074 6869  e valid then thi
-00019460: 7320 7265 7475 726e 7320 6060 4e6f 6e65  s returns ``None
-00019470: 6060 2c20 696e 2077 6869 6368 2063 6173  ``, in which cas
-00019480: 650a 2020 2020 2020 2020 616e 7920 2a72  e.        any *r
-00019490: 756e 6e69 6e67 2a20 776f 726b 6572 2063  unning* worker c
-000194a0: 616e 2062 6520 7573 6564 2e0a 2020 2020  an be used..    
-000194b0: 2020 2020 4f74 6865 7277 6973 652c 2074      Otherwise, t
-000194c0: 6865 2073 7562 7365 7420 6f66 2072 756e  he subset of run
-000194d0: 6e69 6e67 2077 6f72 6b65 7273 2076 616c  ning workers val
-000194e0: 6964 2066 6f72 2074 6869 7320 7461 736b  id for this task
-000194f0: 0a20 2020 2020 2020 2069 7320 7265 7475  .        is retu
-00019500: 726e 6564 2e0a 2020 2020 2020 2020 5468  rned..        Th
-00019510: 6973 2063 6865 636b 7320 7472 6163 6b73  is checks tracks
-00019520: 2074 6865 2066 6f6c 6c6f 7769 6e67 2073   the following s
-00019530: 7461 7465 3a0a 0a20 2020 2020 2020 202a  tate:..        *
-00019540: 2020 776f 726b 6572 5f72 6573 7472 6963    worker_restric
-00019550: 7469 6f6e 730a 2020 2020 2020 2020 2a20  tions.        * 
-00019560: 2068 6f73 745f 7265 7374 7269 6374 696f   host_restrictio
-00019570: 6e73 0a20 2020 2020 2020 202a 2020 7265  ns.        *  re
-00019580: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
-00019590: 6f6e 730a 2020 2020 2020 2020 2222 220a  ons.        """.
-000195a0: 2020 2020 2020 2020 733a 2073 6574 5b73          s: set[s
-000195b0: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
-000195c0: 650a 0a20 2020 2020 2020 2069 6620 7473  e..        if ts
-000195d0: 2e77 6f72 6b65 725f 7265 7374 7269 6374  .worker_restrict
-000195e0: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-000195f0: 2020 7320 3d20 7b61 6464 7220 666f 7220    s = {addr for 
-00019600: 6164 6472 2069 6e20 7473 2e77 6f72 6b65  addr in ts.worke
-00019610: 725f 7265 7374 7269 6374 696f 6e73 2069  r_restrictions i
-00019620: 6620 6164 6472 2069 6e20 7365 6c66 2e77  f addr in self.w
-00019630: 6f72 6b65 7273 7d0a 0a20 2020 2020 2020  orkers}..       
-00019640: 2069 6620 7473 2e68 6f73 745f 7265 7374   if ts.host_rest
-00019650: 7269 6374 696f 6e73 3a0a 2020 2020 2020  rictions:.      
-00019660: 2020 2020 2020 2320 5265 736f 6c76 6520        # Resolve 
-00019670: 7468 6520 616c 6961 7320 6865 7265 2072  the alias here r
-00019680: 6174 6865 7220 7468 616e 2065 6172 6c79  ather than early
-00019690: 2c20 666f 7220 7468 6520 776f 726b 6572  , for the worker
-000196a0: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-000196b0: 6179 206e 6f74 2062 6520 636f 6e6e 6563  ay not be connec
-000196c0: 7465 6420 7768 656e 2068 6f73 745f 7265  ted when host_re
-000196d0: 7374 7269 6374 696f 6e73 2069 7320 706f  strictions is po
-000196e0: 7075 6c61 7465 640a 2020 2020 2020 2020  pulated.        
-000196f0: 2020 2020 6872 203d 205b 7365 6c66 2e63      hr = [self.c
-00019700: 6f65 7263 655f 686f 7374 6e61 6d65 2868  oerce_hostname(h
-00019710: 2920 666f 7220 6820 696e 2074 732e 686f  ) for h in ts.ho
-00019720: 7374 5f72 6573 7472 6963 7469 6f6e 735d  st_restrictions]
-00019730: 0a20 2020 2020 2020 2020 2020 2023 2058  .            # X
-00019740: 5858 206e 6565 6420 486f 7374 5374 6174  XX need HostStat
-00019750: 653f 0a20 2020 2020 2020 2020 2020 2073  e?.            s
-00019760: 6c20 3d20 5b5d 0a20 2020 2020 2020 2020  l = [].         
-00019770: 2020 2066 6f72 2068 2069 6e20 6872 3a0a     for h in hr:.
-00019780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019790: 6468 203d 2073 656c 662e 686f 7374 5f69  dh = self.host_i
-000197a0: 6e66 6f2e 6765 7428 6829 0a20 2020 2020  nfo.get(h).     
-000197b0: 2020 2020 2020 2020 2020 2069 6620 6468             if dh
-000197c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-000197d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197e0: 2020 736c 2e61 7070 656e 6428 6468 5b22    sl.append(dh["
-000197f0: 6164 6472 6573 7365 7322 5d29 0a0a 2020  addresses"])..  
-00019800: 2020 2020 2020 2020 2020 7373 203d 2073            ss = s
-00019810: 6574 2e75 6e69 6f6e 282a 736c 2920 6966  et.union(*sl) if
-00019820: 2073 6c20 656c 7365 2073 6574 2829 0a20   sl else set(). 
-00019830: 2020 2020 2020 2020 2020 2069 6620 7320             if s 
-00019840: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00019850: 2020 2020 2020 2020 2073 203d 2073 730a           s = ss.
-00019860: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00019870: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019880: 2020 7320 7c3d 2073 730a 0a20 2020 2020    s |= ss..     
-00019890: 2020 2069 6620 7473 2e72 6573 6f75 7263     if ts.resourc
-000198a0: 655f 7265 7374 7269 6374 696f 6e73 3a0a  e_restrictions:.
-000198b0: 2020 2020 2020 2020 2020 2020 6477 203d              dw =
-000198c0: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-000198d0: 666f 7220 7265 736f 7572 6365 2c20 7265  for resource, re
-000198e0: 7175 6972 6564 2069 6e20 7473 2e72 6573  quired in ts.res
-000198f0: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-00019900: 6e73 2e69 7465 6d73 2829 3a0a 2020 2020  ns.items():.    
-00019910: 2020 2020 2020 2020 2020 2020 6472 203d              dr =
-00019920: 2073 656c 662e 7265 736f 7572 6365 732e   self.resources.
-00019930: 6765 7428 7265 736f 7572 6365 290a 2020  get(resource).  
-00019940: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00019950: 2064 7220 6973 204e 6f6e 653a 0a20 2020   dr is None:.   
-00019960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019970: 2073 656c 662e 7265 736f 7572 6365 735b   self.resources[
-00019980: 7265 736f 7572 6365 5d20 3d20 6472 203d  resource] = dr =
-00019990: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
-000199a0: 2020 2020 2073 7720 3d20 7365 7428 290a       sw = set().
-000199b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199c0: 666f 7220 6164 6472 2c20 7375 7070 6c69  for addr, suppli
-000199d0: 6564 2069 6e20 6472 2e69 7465 6d73 2829  ed in dr.items()
-000199e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000199f0: 2020 2020 2020 6966 2073 7570 706c 6965        if supplie
-00019a00: 6420 3e3d 2072 6571 7569 7265 643a 0a20  d >= required:. 
-00019a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a20: 2020 2020 2020 2073 772e 6164 6428 6164         sw.add(ad
-00019a30: 6472 290a 0a20 2020 2020 2020 2020 2020  dr)..           
-00019a40: 2020 2020 2064 775b 7265 736f 7572 6365       dw[resource
-00019a50: 5d20 3d20 7377 0a0a 2020 2020 2020 2020  ] = sw..        
-00019a60: 2020 2020 7777 203d 2073 6574 2e69 6e74      ww = set.int
-00019a70: 6572 7365 6374 696f 6e28 2a64 772e 7661  ersection(*dw.va
-00019a80: 6c75 6573 2829 290a 2020 2020 2020 2020  lues()).        
-00019a90: 2020 2020 6966 2073 2069 7320 4e6f 6e65      if s is None
-00019aa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019ab0: 2020 7320 3d20 7777 0a20 2020 2020 2020    s = ww.       
-00019ac0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00019ad0: 2020 2020 2020 2020 2020 2073 2026 3d20             s &= 
-00019ae0: 7777 0a0a 2020 2020 2020 2020 6966 2073  ww..        if s
-00019af0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00019b00: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00019b10: 6520 2023 2041 6c6c 2077 6f72 6b65 7273  e  # All workers
-00019b20: 2061 7265 2076 616c 6964 0a20 2020 2020   are valid.     
-00019b30: 2020 2069 6620 6e6f 7420 733a 0a20 2020     if not s:.   
-00019b40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00019b50: 7365 7428 2920 2023 204e 6f20 776f 726b  set()  # No work
-00019b60: 6572 7320 6172 6520 7661 6c69 640a 0a20  ers are valid.. 
-00019b70: 2020 2020 2020 2023 2053 6f6d 6520 776f         # Some wo
-00019b80: 726b 6572 7320 6172 6520 7661 6c69 640a  rkers are valid.
-00019b90: 2020 2020 2020 2020 735f 7773 203d 207b          s_ws = {
-00019ba0: 7365 6c66 2e77 6f72 6b65 7273 5b61 6464  self.workers[add
-00019bb0: 725d 2066 6f72 2061 6464 7220 696e 2073  r] for addr in s
-00019bc0: 7d0a 2020 2020 2020 2020 6966 206c 656e  }.        if len
-00019bd0: 2873 656c 662e 7275 6e6e 696e 6729 203c  (self.running) <
-00019be0: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
-00019bf0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00019c00: 735f 7773 2026 3d20 7365 6c66 2e72 756e  s_ws &= self.run
-00019c10: 6e69 6e67 0a20 2020 2020 2020 2072 6574  ning.        ret
-00019c20: 7572 6e20 735f 7773 0a0a 2020 2020 6465  urn s_ws..    de
-00019c30: 6620 6163 7175 6972 655f 7265 736f 7572  f acquire_resour
-00019c40: 6365 7328 7365 6c66 2c20 7473 3a20 5461  ces(self, ts: Ta
-00019c50: 736b 5374 6174 652c 2077 733a 2057 6f72  skState, ws: Wor
-00019c60: 6b65 7253 7461 7465 2920 2d3e 204e 6f6e  kerState) -> Non
-00019c70: 653a 0a20 2020 2020 2020 2066 6f72 2072  e:.        for r
-00019c80: 2c20 7265 7175 6972 6564 2069 6e20 7473  , required in ts
-00019c90: 2e72 6573 6f75 7263 655f 7265 7374 7269  .resource_restri
-00019ca0: 6374 696f 6e73 2e69 7465 6d73 2829 3a0a  ctions.items():.
-00019cb0: 2020 2020 2020 2020 2020 2020 7773 2e75              ws.u
-00019cc0: 7365 645f 7265 736f 7572 6365 735b 725d  sed_resources[r]
-00019cd0: 202b 3d20 7265 7175 6972 6564 0a0a 2020   += required..  
-00019ce0: 2020 6465 6620 7265 6c65 6173 655f 7265    def release_re
-00019cf0: 736f 7572 6365 7328 7365 6c66 2c20 7473  sources(self, ts
-00019d00: 3a20 5461 736b 5374 6174 652c 2077 733a  : TaskState, ws:
-00019d10: 2057 6f72 6b65 7253 7461 7465 2920 2d3e   WorkerState) ->
-00019d20: 204e 6f6e 653a 0a20 2020 2020 2020 2066   None:.        f
-00019d30: 6f72 2072 2c20 7265 7175 6972 6564 2069  or r, required i
-00019d40: 6e20 7473 2e72 6573 6f75 7263 655f 7265  n ts.resource_re
-00019d50: 7374 7269 6374 696f 6e73 2e69 7465 6d73  strictions.items
-00019d60: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00019d70: 7773 2e75 7365 645f 7265 736f 7572 6365  ws.used_resource
-00019d80: 735b 725d 202d 3d20 7265 7175 6972 6564  s[r] -= required
-00019d90: 0a0a 2020 2020 6465 6620 636f 6572 6365  ..    def coerce
-00019da0: 5f68 6f73 746e 616d 6528 7365 6c66 2c20  _hostname(self, 
-00019db0: 686f 7374 3a20 4861 7368 6162 6c65 2920  host: Hashable) 
-00019dc0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-00019dd0: 2222 220a 2020 2020 2020 2020 436f 6572  """.        Coer
-00019de0: 6365 2074 6865 2068 6f73 746e 616d 6520  ce the hostname 
-00019df0: 6f66 2061 2077 6f72 6b65 722e 0a20 2020  of a worker..   
-00019e00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00019e10: 2061 6c69 6173 203d 2073 656c 662e 616c   alias = self.al
-00019e20: 6961 7365 732e 6765 7428 686f 7374 290a  iases.get(host).
-00019e30: 2020 2020 2020 2020 6966 2061 6c69 6173          if alias
-00019e40: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00019e50: 2020 2020 2020 2020 2020 7773 203d 2073            ws = s
-00019e60: 656c 662e 776f 726b 6572 735b 616c 6961  elf.workers[alia
-00019e70: 735d 0a20 2020 2020 2020 2020 2020 2072  s].            r
-00019e80: 6574 7572 6e20 7773 2e68 6f73 740a 2020  eturn ws.host.  
-00019e90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00019ea0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-00019eb0: 7369 6e73 7461 6e63 6528 686f 7374 2c20  sinstance(host, 
-00019ec0: 7374 7229 0a20 2020 2020 2020 2020 2020  str).           
-00019ed0: 2072 6574 7572 6e20 686f 7374 0a0a 2020   return host..  
-00019ee0: 2020 6465 6620 776f 726b 6572 5f6f 626a    def worker_obj
-00019ef0: 6563 7469 7665 2873 656c 662c 2074 733a  ective(self, ts:
-00019f00: 2054 6173 6b53 7461 7465 2c20 7773 3a20   TaskState, ws: 
-00019f10: 576f 726b 6572 5374 6174 6529 202d 3e20  WorkerState) -> 
-00019f20: 7475 706c 653a 0a20 2020 2020 2020 2022  tuple:.        "
-00019f30: 2222 4f62 6a65 6374 6976 6520 6675 6e63  ""Objective func
-00019f40: 7469 6f6e 2074 6f20 6465 7465 726d 696e  tion to determin
-00019f50: 6520 7768 6963 6820 776f 726b 6572 2073  e which worker s
-00019f60: 686f 756c 6420 6765 7420 7468 6520 7461  hould get the ta
-00019f70: 736b 0a0a 2020 2020 2020 2020 4d69 6e69  sk..        Mini
-00019f80: 6d69 7a65 2065 7870 6563 7465 6420 7374  mize expected st
-00019f90: 6172 7420 7469 6d65 2e20 2049 6620 6120  art time.  If a 
-00019fa0: 7469 6520 7468 656e 2062 7265 616b 2077  tie then break w
-00019fb0: 6974 6820 6461 7461 2073 746f 7261 6765  ith data storage
-00019fc0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00019fd0: 2020 2020 2020 636f 6d6d 5f62 7974 6573        comm_bytes
-00019fe0: 203d 2073 756d 280a 2020 2020 2020 2020   = sum(.        
-00019ff0: 2020 2020 6474 732e 6765 745f 6e62 7974      dts.get_nbyt
-0001a000: 6573 2829 2066 6f72 2064 7473 2069 6e20  es() for dts in 
-0001a010: 7473 2e64 6570 656e 6465 6e63 6965 7320  ts.dependencies 
-0001a020: 6966 2077 7320 6e6f 7420 696e 2064 7473  if ws not in dts
-0001a030: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-0001a040: 2029 0a0a 2020 2020 2020 2020 7374 6163   )..        stac
-0001a050: 6b5f 7469 6d65 203d 2077 732e 6f63 6375  k_time = ws.occu
-0001a060: 7061 6e63 7920 2f20 7773 2e6e 7468 7265  pancy / ws.nthre
-0001a070: 6164 730a 2020 2020 2020 2020 7374 6172  ads.        star
-0001a080: 745f 7469 6d65 203d 2073 7461 636b 5f74  t_time = stack_t
-0001a090: 696d 6520 2b20 636f 6d6d 5f62 7974 6573  ime + comm_bytes
-0001a0a0: 202f 2073 656c 662e 6261 6e64 7769 6474   / self.bandwidt
-0001a0b0: 680a 0a20 2020 2020 2020 2069 6620 7473  h..        if ts
-0001a0c0: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
-0001a0d0: 2020 2020 7265 7475 726e 2028 6c65 6e28      return (len(
-0001a0e0: 7773 2e61 6374 6f72 7329 2c20 7374 6172  ws.actors), star
-0001a0f0: 745f 7469 6d65 2c20 7773 2e6e 6279 7465  t_time, ws.nbyte
-0001a100: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
-0001a110: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001a120: 7572 6e20 2873 7461 7274 5f74 696d 652c  urn (start_time,
-0001a130: 2077 732e 6e62 7974 6573 290a 0a20 2020   ws.nbytes)..   
-0001a140: 2064 6566 2061 6464 5f72 6570 6c69 6361   def add_replica
-0001a150: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-0001a160: 7461 7465 2c20 7773 3a20 576f 726b 6572  tate, ws: Worker
-0001a170: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-0001a180: 2020 2020 2020 2020 2222 224e 6f74 6520          """Note 
-0001a190: 7468 6174 2061 2077 6f72 6b65 7220 686f  that a worker ho
-0001a1a0: 6c64 7320 6120 7265 706c 6963 6120 6f66  lds a replica of
-0001a1b0: 2061 2074 6173 6b20 7769 7468 2073 7461   a task with sta
-0001a1c0: 7465 3d27 6d65 6d6f 7279 2722 2222 0a20  te='memory'""". 
-0001a1d0: 2020 2020 2020 2077 732e 6164 645f 7265         ws.add_re
-0001a1e0: 706c 6963 6128 7473 290a 2020 2020 2020  plica(ts).      
-0001a1f0: 2020 6966 206c 656e 2874 732e 7768 6f5f    if len(ts.who_
-0001a200: 6861 7329 203d 3d20 323a 0a20 2020 2020  has) == 2:.     
-0001a210: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
-0001a220: 6963 6174 6564 5f74 6173 6b73 2e61 6464  icated_tasks.add
-0001a230: 2874 7329 0a0a 2020 2020 6465 6620 7265  (ts)..    def re
-0001a240: 6d6f 7665 5f72 6570 6c69 6361 2873 656c  move_replica(sel
-0001a250: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-0001a260: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
-0001a270: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0001a280: 2020 2020 2222 224e 6f74 6520 7468 6174      """Note that
-0001a290: 2061 2077 6f72 6b65 7220 6e6f 206c 6f6e   a worker no lon
-0001a2a0: 6765 7220 686f 6c64 7320 6120 7265 706c  ger holds a repl
-0001a2b0: 6963 6120 6f66 2061 2074 6173 6b22 2222  ica of a task"""
-0001a2c0: 0a20 2020 2020 2020 2077 732e 7265 6d6f  .        ws.remo
-0001a2d0: 7665 5f72 6570 6c69 6361 2874 7329 0a20  ve_replica(ts). 
-0001a2e0: 2020 2020 2020 2069 6620 6c65 6e28 7473         if len(ts
-0001a2f0: 2e77 686f 5f68 6173 2920 3d3d 2031 3a0a  .who_has) == 1:.
-0001a300: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001a310: 2e72 6570 6c69 6361 7465 645f 7461 736b  .replicated_task
-0001a320: 732e 7265 6d6f 7665 2874 7329 0a0a 2020  s.remove(ts)..  
-0001a330: 2020 6465 6620 7265 6d6f 7665 5f61 6c6c    def remove_all
-0001a340: 5f72 6570 6c69 6361 7328 7365 6c66 2c20  _replicas(self, 
-0001a350: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
-0001a360: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0001a370: 2222 2252 656d 6f76 6520 616c 6c20 7265  """Remove all re
-0001a380: 706c 6963 6173 206f 6620 6120 7461 736b  plicas of a task
-0001a390: 2066 726f 6d20 616c 6c20 776f 726b 6572   from all worker
-0001a3a0: 7322 2222 0a20 2020 2020 2020 206e 6279  s""".        nby
-0001a3b0: 7465 7320 3d20 7473 2e67 6574 5f6e 6279  tes = ts.get_nby
-0001a3c0: 7465 7328 290a 2020 2020 2020 2020 666f  tes().        fo
-0001a3d0: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
-0001a3e0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-0001a3f0: 7773 2e6e 6279 7465 7320 2d3d 206e 6279  ws.nbytes -= nby
-0001a400: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
-0001a410: 6465 6c20 7773 2e5f 6861 735f 7768 6174  del ws._has_what
-0001a420: 5b74 735d 0a20 2020 2020 2020 2069 6620  [ts].        if 
-0001a430: 6c65 6e28 7473 2e77 686f 5f68 6173 2920  len(ts.who_has) 
-0001a440: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-0001a450: 2073 656c 662e 7265 706c 6963 6174 6564   self.replicated
-0001a460: 5f74 6173 6b73 2e72 656d 6f76 6528 7473  _tasks.remove(ts
-0001a470: 290a 2020 2020 2020 2020 7473 2e77 686f  ).        ts.who
-0001a480: 5f68 6173 2e63 6c65 6172 2829 0a0a 2020  _has.clear()..  
-0001a490: 2020 6465 6620 6275 6c6b 5f73 6368 6564    def bulk_sched
-0001a4a0: 756c 655f 756e 7275 6e6e 6162 6c65 5f61  ule_unrunnable_a
-0001a4b0: 6674 6572 5f61 6464 696e 675f 776f 726b  fter_adding_work
-0001a4c0: 6572 2873 656c 662c 2077 733a 2057 6f72  er(self, ws: Wor
-0001a4d0: 6b65 7253 7461 7465 2920 2d3e 2052 6563  kerState) -> Rec
-0001a4e0: 733a 0a20 2020 2020 2020 2022 2222 5365  s:.        """Se
-0001a4f0: 6e64 2060 606e 6f2d 776f 726b 6572 6060  nd ``no-worker``
-0001a500: 2074 6173 6b73 2074 6f20 6060 7072 6f63   tasks to ``proc
-0001a510: 6573 7369 6e67 6060 2074 6861 7420 7468  essing`` that th
-0001a520: 6973 2077 6f72 6b65 7220 6361 6e20 6861  is worker can ha
-0001a530: 6e64 6c65 2e0a 0a20 2020 2020 2020 2052  ndle...        R
-0001a540: 6574 7572 6e73 2070 7269 6f72 6974 792d  eturns priority-
-0001a550: 6f72 6465 7265 6420 7265 636f 6d6d 656e  ordered recommen
-0001a560: 6461 7469 6f6e 732e 0a20 2020 2020 2020  dations..       
-0001a570: 2022 2222 0a20 2020 2020 2020 2072 756e   """.        run
-0001a580: 6e61 626c 653a 206c 6973 745b 5461 736b  nable: list[Task
-0001a590: 5374 6174 655d 203d 205b 5d0a 2020 2020  State] = [].    
-0001a5a0: 2020 2020 666f 7220 7473 2069 6e20 7365      for ts in se
-0001a5b0: 6c66 2e75 6e72 756e 6e61 626c 653a 0a20  lf.unrunnable:. 
-0001a5c0: 2020 2020 2020 2020 2020 2076 616c 6964             valid
-0001a5d0: 203d 2073 656c 662e 7661 6c69 645f 776f   = self.valid_wo
-0001a5e0: 726b 6572 7328 7473 290a 2020 2020 2020  rkers(ts).      
-0001a5f0: 2020 2020 2020 6966 2076 616c 6964 2069        if valid i
-0001a600: 7320 4e6f 6e65 206f 7220 7773 2069 6e20  s None or ws in 
-0001a610: 7661 6c69 643a 0a20 2020 2020 2020 2020  valid:.         
-0001a620: 2020 2020 2020 2072 756e 6e61 626c 652e         runnable.
-0001a630: 6170 7065 6e64 2874 7329 0a0a 2020 2020  append(ts)..    
-0001a640: 2020 2020 2320 5265 636f 6d6d 656e 6461      # Recommenda
-0001a650: 7469 6f6e 7320 6172 6520 7072 6f63 6573  tions are proces
-0001a660: 7365 6420 4c49 464f 2c20 6865 6e63 6520  sed LIFO, hence 
-0001a670: 7468 6520 7265 7665 7273 6564 206f 7264  the reversed ord
-0001a680: 6572 0a20 2020 2020 2020 2072 756e 6e61  er.        runna
-0001a690: 626c 652e 736f 7274 286b 6579 3d6f 7065  ble.sort(key=ope
-0001a6a0: 7261 746f 722e 6174 7472 6765 7474 6572  rator.attrgetter
-0001a6b0: 2822 7072 696f 7269 7479 2229 2c20 7265  ("priority"), re
-0001a6c0: 7665 7273 653d 5472 7565 290a 2020 2020  verse=True).    
-0001a6d0: 2020 2020 7265 7475 726e 207b 7473 2e6b      return {ts.k
-0001a6e0: 6579 3a20 2270 726f 6365 7373 696e 6722  ey: "processing"
-0001a6f0: 2066 6f72 2074 7320 696e 2072 756e 6e61   for ts in runna
-0001a700: 626c 657d 0a0a 2020 2020 6465 6620 5f76  ble}..    def _v
-0001a710: 616c 6964 6174 655f 7265 6164 7928 7365  alidate_ready(se
-0001a720: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-0001a730: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0001a740: 2020 2020 2222 2256 616c 6964 6174 696f      """Validatio
-0001a750: 6e20 666f 7220 7265 6164 7920 7374 6174  n for ready stat
-0001a760: 6573 2028 7072 6f63 6573 7369 6e67 2c20  es (processing, 
-0001a770: 7175 6575 6564 2c20 6e6f 2d77 6f72 6b65  queued, no-worke
-0001a780: 7229 2222 220a 2020 2020 2020 2020 6173  r)""".        as
-0001a790: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-0001a7a0: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-0001a7b0: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-0001a7c0: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
-0001a7d0: 6572 7420 6e6f 7420 7473 2e65 7863 6570  ert not ts.excep
-0001a7e0: 7469 6f6e 5f62 6c61 6d65 0a20 2020 2020  tion_blame.     
-0001a7f0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-0001a800: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
-0001a810: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0001a820: 7420 7473 2e68 6173 5f6c 6f73 745f 6465  t ts.has_lost_de
-0001a830: 7065 6e64 656e 6369 6573 0a20 2020 2020  pendencies.     
-0001a840: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-0001a850: 2069 6e20 7365 6c66 2e75 6e72 756e 6e61   in self.unrunna
-0001a860: 626c 650a 2020 2020 2020 2020 6173 7365  ble.        asse
-0001a870: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
-0001a880: 662e 7175 6575 6564 0a20 2020 2020 2020  f.queued.       
-0001a890: 2061 7373 6572 7420 616c 6c28 6474 732e   assert all(dts.
-0001a8a0: 7768 6f5f 6861 7320 666f 7220 6474 7320  who_has for dts 
-0001a8b0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0001a8c0: 6573 290a 0a20 2020 2064 6566 205f 6164  es)..    def _ad
-0001a8d0: 645f 746f 5f70 726f 6365 7373 696e 6728  d_to_processing(
-0001a8e0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-0001a8f0: 6174 652c 2077 733a 2057 6f72 6b65 7253  ate, ws: WorkerS
-0001a900: 7461 7465 2920 2d3e 204d 7367 733a 0a20  tate) -> Msgs:. 
-0001a910: 2020 2020 2020 2022 2222 5365 7420 6120         """Set a 
-0001a920: 7461 736b 2061 7320 7072 6f63 6573 7369  task as processi
-0001a930: 6e67 206f 6e20 6120 776f 726b 6572 2061  ng on a worker a
-0001a940: 6e64 2072 6574 7572 6e20 7468 6520 776f  nd return the wo
-0001a950: 726b 6572 206d 6573 7361 6765 7320 746f  rker messages to
-0001a960: 2073 656e 6422 2222 0a20 2020 2020 2020   send""".       
-0001a970: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-0001a980: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0001a990: 656c 662e 5f76 616c 6964 6174 655f 7265  elf._validate_re
-0001a9a0: 6164 7928 7473 290a 2020 2020 2020 2020  ady(ts).        
-0001a9b0: 2020 2020 6173 7365 7274 2077 7320 696e      assert ws in
-0001a9c0: 2073 656c 662e 7275 6e6e 696e 672c 2073   self.running, s
-0001a9d0: 656c 662e 7275 6e6e 696e 670a 2020 2020  elf.running.    
-0001a9e0: 2020 2020 2020 2020 6173 7365 7274 2028          assert (
-0001a9f0: 6f20 3a3d 2073 656c 662e 776f 726b 6572  o := self.worker
-0001aa00: 732e 6765 7428 7773 2e61 6464 7265 7373  s.get(ws.address
-0001aa10: 2929 2069 7320 7773 2c20 2877 732c 206f  )) is ws, (ws, o
-0001aa20: 290a 0a20 2020 2020 2020 2077 732e 6164  )..        ws.ad
-0001aa30: 645f 746f 5f70 726f 6365 7373 696e 6728  d_to_processing(
-0001aa40: 7473 290a 2020 2020 2020 2020 7473 2e70  ts).        ts.p
-0001aa50: 726f 6365 7373 696e 675f 6f6e 203d 2077  rocessing_on = w
-0001aa60: 730a 2020 2020 2020 2020 7473 2e73 7461  s.        ts.sta
-0001aa70: 7465 203d 2022 7072 6f63 6573 7369 6e67  te = "processing
-0001aa80: 220a 2020 2020 2020 2020 7365 6c66 2e61  ".        self.a
-0001aa90: 6371 7569 7265 5f72 6573 6f75 7263 6573  cquire_resources
-0001aaa0: 2874 732c 2077 7329 0a20 2020 2020 2020  (ts, ws).       
-0001aab0: 2073 656c 662e 6368 6563 6b5f 6964 6c65   self.check_idle
-0001aac0: 5f73 6174 7572 6174 6564 2877 7329 0a20  _saturated(ws). 
-0001aad0: 2020 2020 2020 2073 656c 662e 6e5f 7461         self.n_ta
-0001aae0: 736b 7320 2b3d 2031 0a0a 2020 2020 2020  sks += 1..      
-0001aaf0: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
-0001ab00: 2020 2020 2020 2020 2020 2077 732e 6163             ws.ac
-0001ab10: 746f 7273 2e61 6464 2874 7329 0a0a 2020  tors.add(ts)..  
-0001ab20: 2020 2020 2020 7265 7475 726e 207b 7773        return {ws
-0001ab30: 2e61 6464 7265 7373 3a20 5b73 656c 662e  .address: [self.
-0001ab40: 5f74 6173 6b5f 746f 5f6d 7367 2874 7329  _task_to_msg(ts)
-0001ab50: 5d7d 0a0a 2020 2020 6465 6620 5f65 7869  ]}..    def _exi
-0001ab60: 745f 7072 6f63 6573 7369 6e67 5f63 6f6d  t_processing_com
-0001ab70: 6d6f 6e28 7365 6c66 2c20 7473 3a20 5461  mon(self, ts: Ta
-0001ab80: 736b 5374 6174 6529 202d 3e20 576f 726b  skState) -> Work
-0001ab90: 6572 5374 6174 6520 7c20 4e6f 6e65 3a0a  erState | None:.
-0001aba0: 2020 2020 2020 2020 2222 2252 656d 6f76          """Remov
-0001abb0: 6520 2a74 732a 2066 726f 6d20 7468 6520  e *ts* from the 
-0001abc0: 7365 7420 6f66 2070 726f 6365 7373 696e  set of processin
-0001abd0: 6720 7461 736b 732e 0a0a 2020 2020 2020  g tasks...      
-0001abe0: 2020 5265 7475 726e 730a 2020 2020 2020    Returns.      
-0001abf0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 2020    -------.      
-0001ac00: 2020 576f 726b 6572 2073 7461 7465 206f    Worker state o
-0001ac10: 6620 7468 6520 776f 726b 6572 2074 6861  f the worker tha
-0001ac20: 7420 7072 6f63 6573 7365 6420 2a74 732a  t processed *ts*
-0001ac30: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
-0001ac40: 7320 6375 7272 656e 742c 0a20 2020 2020  s current,.     
-0001ac50: 2020 204e 6f6e 6520 6966 2074 6865 2077     None if the w
-0001ac60: 6f72 6b65 7220 6973 2073 7461 6c65 2e0a  orker is stale..
-0001ac70: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
-0001ac80: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-0001ac90: 2d2d 0a20 2020 2020 2020 2053 6368 6564  --.        Sched
-0001aca0: 756c 6572 2e5f 7365 745f 6475 7261 7469  uler._set_durati
-0001acb0: 6f6e 5f65 7374 696d 6174 650a 2020 2020  on_estimate.    
-0001acc0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001acd0: 7773 203d 2074 732e 7072 6f63 6573 7369  ws = ts.processi
-0001ace0: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
-0001acf0: 7365 7274 2077 730a 2020 2020 2020 2020  sert ws.        
-0001ad00: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-0001ad10: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-0001ad20: 2077 732e 7265 6d6f 7665 5f66 726f 6d5f   ws.remove_from_
-0001ad30: 7072 6f63 6573 7369 6e67 2874 7329 0a20  processing(ts). 
-0001ad40: 2020 2020 2020 2069 6620 7365 6c66 2e77         if self.w
-0001ad50: 6f72 6b65 7273 2e67 6574 2877 732e 6164  orkers.get(ws.ad
-0001ad60: 6472 6573 7329 2069 7320 6e6f 7420 7773  dress) is not ws
-0001ad70: 3a20 2023 206d 6179 2068 6176 6520 6265  :  # may have be
-0001ad80: 656e 2072 656d 6f76 6564 0a20 2020 2020  en removed.     
-0001ad90: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0001ada0: 6e65 0a0a 2020 2020 2020 2020 7365 6c66  ne..        self
-0001adb0: 2e63 6865 636b 5f69 646c 655f 7361 7475  .check_idle_satu
-0001adc0: 7261 7465 6428 7773 290a 2020 2020 2020  rated(ws).      
-0001add0: 2020 7365 6c66 2e72 656c 6561 7365 5f72    self.release_r
-0001ade0: 6573 6f75 7263 6573 2874 732c 2077 7329  esources(ts, ws)
-0001adf0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0001ae00: 2077 730a 0a20 2020 2064 6566 205f 6164   ws..    def _ad
-0001ae10: 645f 746f 5f6d 656d 6f72 7928 0a20 2020  d_to_memory(.   
-0001ae20: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0001ae30: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
-0001ae40: 2c0a 2020 2020 2020 2020 7773 3a20 576f  ,.        ws: Wo
-0001ae50: 726b 6572 5374 6174 652c 0a20 2020 2020  rkerState,.     
-0001ae60: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-0001ae70: 6e73 3a20 5265 6373 2c0a 2020 2020 2020  ns: Recs,.      
-0001ae80: 2020 636c 6965 6e74 5f6d 7367 733a 204d    client_msgs: M
-0001ae90: 7367 732c 0a20 2020 2020 2020 2074 7970  sgs,.        typ
-0001aea0: 653a 2062 7974 6573 207c 204e 6f6e 6520  e: bytes | None 
-0001aeb0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0001aec0: 7479 7065 6e61 6d65 3a20 7374 7220 7c20  typename: str | 
-0001aed0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-0001aee0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-0001aef0: 2020 2020 2222 2241 6464 2074 7320 746f      """Add ts to
-0001af00: 2074 6865 2073 6574 206f 6620 696e 2d6d   the set of in-m
-0001af10: 656d 6f72 7920 7461 736b 7322 2222 0a20  emory tasks""". 
-0001af20: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-0001af30: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-0001af40: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-0001af50: 6f74 2069 6e20 7773 2e68 6173 5f77 6861  ot in ws.has_wha
-0001af60: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
-0001af70: 6164 645f 7265 706c 6963 6128 7473 2c20  add_replica(ts, 
-0001af80: 7773 290a 0a20 2020 2020 2020 2064 6570  ws)..        dep
-0001af90: 7320 3d20 6c69 7374 2874 732e 6465 7065  s = list(ts.depe
-0001afa0: 6e64 656e 7473 290a 2020 2020 2020 2020  ndents).        
-0001afb0: 6966 206c 656e 2864 6570 7329 203e 2031  if len(deps) > 1
-0001afc0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-0001afd0: 7073 2e73 6f72 7428 6b65 793d 6f70 6572  ps.sort(key=oper
-0001afe0: 6174 6f72 2e61 7474 7267 6574 7465 7228  ator.attrgetter(
-0001aff0: 2270 7269 6f72 6974 7922 292c 2072 6576  "priority"), rev
-0001b000: 6572 7365 3d54 7275 6529 0a0a 2020 2020  erse=True)..    
-0001b010: 2020 2020 666f 7220 6474 7320 696e 2064      for dts in d
-0001b020: 6570 733a 0a20 2020 2020 2020 2020 2020  eps:.           
-0001b030: 2073 203d 2064 7473 2e77 6169 7469 6e67   s = dts.waiting
-0001b040: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-0001b050: 6966 2074 7320 696e 2073 3a0a 2020 2020  if ts in s:.    
-0001b060: 2020 2020 2020 2020 2020 2020 732e 6469              s.di
-0001b070: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
-0001b080: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0001b090: 2073 3a20 2023 206e 6577 2074 6173 6b20   s:  # new task 
-0001b0a0: 7265 6164 7920 746f 2072 756e 0a20 2020  ready to run.   
-0001b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b0c0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001b0d0: 5b64 7473 2e6b 6579 5d20 3d20 2270 726f  [dts.key] = "pro
-0001b0e0: 6365 7373 696e 6722 0a0a 2020 2020 2020  cessing"..      
-0001b0f0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-0001b100: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-0001b110: 2020 2020 2020 2020 2020 7320 3d20 6474            s = dt
-0001b120: 732e 7761 6974 6572 730a 2020 2020 2020  s.waiters.      
-0001b130: 2020 2020 2020 732e 6469 7363 6172 6428        s.discard(
-0001b140: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-0001b150: 6966 206e 6f74 2073 2061 6e64 206e 6f74  if not s and not
-0001b160: 2064 7473 2e77 686f 5f77 616e 7473 3a0a   dts.who_wants:.
-0001b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b180: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-0001b190: 6474 732e 6b65 795d 203d 2022 7265 6c65  dts.key] = "rele
-0001b1a0: 6173 6564 220a 0a20 2020 2020 2020 2069  ased"..        i
-0001b1b0: 6620 6e6f 7420 7473 2e77 6169 7465 7273  f not ts.waiters
-0001b1c0: 2061 6e64 206e 6f74 2074 732e 7768 6f5f   and not ts.who_
-0001b1d0: 7761 6e74 733a 0a20 2020 2020 2020 2020  wants:.         
-0001b1e0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-0001b1f0: 6e73 5b74 732e 6b65 795d 203d 2022 7265  ns[ts.key] = "re
-0001b200: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
-0001b210: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001b220: 2020 7265 706f 7274 5f6d 7367 3a20 6469    report_msg: di
-0001b230: 6374 5b73 7472 2c20 416e 795d 203d 207b  ct[str, Any] = {
-0001b240: 226f 7022 3a20 226b 6579 2d69 6e2d 6d65  "op": "key-in-me
-0001b250: 6d6f 7279 222c 2022 6b65 7922 3a20 7473  mory", "key": ts
-0001b260: 2e6b 6579 7d0a 2020 2020 2020 2020 2020  .key}.          
-0001b270: 2020 6966 2074 7970 6520 6973 206e 6f74    if type is not
-0001b280: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001b290: 2020 2020 2020 2072 6570 6f72 745f 6d73         report_ms
-0001b2a0: 675b 2274 7970 6522 5d20 3d20 7479 7065  g["type"] = type
-0001b2b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001b2c0: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
-0001b2d0: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0001b2e0: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-0001b2f0: 5b63 732e 636c 6965 6e74 5f6b 6579 5d20  [cs.client_key] 
-0001b300: 3d20 5b72 6570 6f72 745f 6d73 675d 0a0a  = [report_msg]..
-0001b310: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
-0001b320: 203d 2022 6d65 6d6f 7279 220a 2020 2020   = "memory".    
-0001b330: 2020 2020 7473 2e74 7970 6520 3d20 7479      ts.type = ty
-0001b340: 7065 6e61 6d65 2020 2320 7479 7065 3a20  pename  # type: 
-0001b350: 6967 6e6f 7265 0a20 2020 2020 2020 2074  ignore.        t
-0001b360: 732e 6772 6f75 702e 7479 7065 732e 6164  s.group.types.ad
-0001b370: 6428 7479 7065 6e61 6d65 2920 2023 2074  d(typename)  # t
-0001b380: 7970 653a 2069 676e 6f72 650a 0a20 2020  ype: ignore..   
-0001b390: 2020 2020 2063 7320 3d20 7365 6c66 2e63       cs = self.c
-0001b3a0: 6c69 656e 7473 5b22 6669 7265 2d61 6e64  lients["fire-and
-0001b3b0: 2d66 6f72 6765 7422 5d0a 2020 2020 2020  -forget"].      
-0001b3c0: 2020 6966 2074 7320 696e 2063 732e 7761    if ts in cs.wa
-0001b3d0: 6e74 735f 7768 6174 3a0a 2020 2020 2020  nts_what:.      
-0001b3e0: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
-0001b3f0: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
-0001b400: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001b410: 2020 6373 3d63 732c 0a20 2020 2020 2020    cs=cs,.       
-0001b420: 2020 2020 2020 2020 206b 6579 733d 5b74           keys=[t
-0001b430: 732e 6b65 795d 2c0a 2020 2020 2020 2020  s.key],.        
-0001b440: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0001b450: 6461 7469 6f6e 733d 7265 636f 6d6d 656e  dations=recommen
-0001b460: 6461 7469 6f6e 732c 0a20 2020 2020 2020  dations,.       
-0001b470: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0001b480: 5f70 726f 7061 6761 7465 5f72 656c 6561  _propagate_relea
-0001b490: 7365 6428 7365 6c66 2c20 7473 3a20 5461  sed(self, ts: Ta
-0001b4a0: 736b 5374 6174 652c 2072 6563 6f6d 6d65  skState, recomme
-0001b4b0: 6e64 6174 696f 6e73 3a20 5265 6373 2920  ndations: Recs) 
-0001b4c0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0001b4d0: 2074 732e 7374 6174 6520 3d20 2272 656c   ts.state = "rel
-0001b4e0: 6561 7365 6422 0a20 2020 2020 2020 206b  eased".        k
-0001b4f0: 6579 203d 2074 732e 6b65 790a 0a20 2020  ey = ts.key..   
-0001b500: 2020 2020 2069 6620 7473 2e68 6173 5f6c       if ts.has_l
-0001b510: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-0001b520: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001b530: 636f 6d6d 656e 6461 7469 6f6e 735b 6b65  commendations[ke
-0001b540: 795d 203d 2022 666f 7267 6f74 7465 6e22  y] = "forgotten"
-0001b550: 0a20 2020 2020 2020 2065 6c69 6620 7473  .        elif ts
-0001b560: 2e77 6169 7465 7273 206f 7220 7473 2e77  .waiters or ts.w
-0001b570: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-0001b580: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001b590: 7469 6f6e 735b 6b65 795d 203d 2022 7761  tions[key] = "wa
-0001b5a0: 6974 696e 6722 0a0a 2020 2020 2020 2020  iting"..        
-0001b5b0: 6966 2072 6563 6f6d 6d65 6e64 6174 696f  if recommendatio
-0001b5c0: 6e73 2e67 6574 286b 6579 2920 213d 2022  ns.get(key) != "
-0001b5d0: 7761 6974 696e 6722 3a0a 2020 2020 2020  waiting":.      
-0001b5e0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-0001b5f0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-0001b600: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b610: 2020 6966 2064 7473 2e73 7461 7465 2021    if dts.state !
-0001b620: 3d20 2272 656c 6561 7365 6422 3a0a 2020  = "released":.  
-0001b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b640: 2020 6474 732e 7761 6974 6572 732e 6469    dts.waiters.di
-0001b650: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
-0001b660: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001b670: 206e 6f74 2064 7473 2e77 6169 7465 7273   not dts.waiters
-0001b680: 2061 6e64 206e 6f74 2064 7473 2e77 686f   and not dts.who
-0001b690: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
-0001b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b6b0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-0001b6c0: 6474 732e 6b65 795d 203d 2022 7265 6c65  dts.key] = "rele
-0001b6d0: 6173 6564 220a 2020 2020 2020 2020 2020  ased".          
-0001b6e0: 2020 7473 2e77 6169 7465 7273 2e63 6c65    ts.waiters.cle
-0001b6f0: 6172 2829 0a0a 2020 2020 2020 2020 6966  ar()..        if
-0001b700: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-0001b710: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001b720: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
-0001b730: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-0001b740: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
-0001b750: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
-0001b760: 0a0a 2020 2020 6465 6620 5f70 726f 7061  ..    def _propa
-0001b770: 6761 7465 5f66 6f72 676f 7474 656e 280a  gate_forgotten(.
-0001b780: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-0001b790: 2020 2020 2020 7473 3a20 5461 736b 5374        ts: TaskSt
-0001b7a0: 6174 652c 0a20 2020 2020 2020 2072 6563  ate,.        rec
-0001b7b0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-0001b7c0: 6373 2c0a 2020 2020 2020 2020 776f 726b  cs,.        work
-0001b7d0: 6572 5f6d 7367 733a 204d 7367 732c 0a20  er_msgs: Msgs,. 
-0001b7e0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0001b7f0: 6964 3a20 7374 722c 0a20 2020 2029 202d  id: str,.    ) -
-0001b800: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0001b810: 7473 2e73 7461 7465 203d 2022 666f 7267  ts.state = "forg
-0001b820: 6f74 7465 6e22 0a20 2020 2020 2020 2066  otten".        f
-0001b830: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0001b840: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
-0001b850: 2020 2020 2064 7473 2e68 6173 5f6c 6f73       dts.has_los
-0001b860: 745f 6465 7065 6e64 656e 6369 6573 203d  t_dependencies =
-0001b870: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-0001b880: 2020 6474 732e 6465 7065 6e64 656e 6369    dts.dependenci
-0001b890: 6573 2e72 656d 6f76 6528 7473 290a 2020  es.remove(ts).  
-0001b8a0: 2020 2020 2020 2020 2020 6474 732e 7761            dts.wa
-0001b8b0: 6974 696e 675f 6f6e 2e64 6973 6361 7264  iting_on.discard
-0001b8c0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-0001b8d0: 2069 6620 6474 732e 7374 6174 6520 6e6f   if dts.state no
-0001b8e0: 7420 696e 2028 226d 656d 6f72 7922 2c20  t in ("memory", 
-0001b8f0: 2265 7272 6564 2229 3a0a 2020 2020 2020  "erred"):.      
-0001b900: 2020 2020 2020 2020 2020 2320 4361 6e6e            # Cann
-0001b910: 6f74 2063 6f6d 7075 7465 2074 6173 6b20  ot compute task 
-0001b920: 616e 796d 6f72 650a 2020 2020 2020 2020  anymore.        
-0001b930: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0001b940: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
-0001b950: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
-0001b960: 2020 2020 2020 2074 732e 6465 7065 6e64         ts.depend
-0001b970: 656e 7473 2e63 6c65 6172 2829 0a20 2020  ents.clear().   
-0001b980: 2020 2020 2074 732e 7761 6974 6572 732e       ts.waiters.
-0001b990: 636c 6561 7228 290a 0a20 2020 2020 2020  clear()..       
-0001b9a0: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-0001b9b0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-0001b9c0: 2020 2020 2020 2020 2064 7473 2e64 6570           dts.dep
-0001b9d0: 656e 6465 6e74 732e 7265 6d6f 7665 2874  endents.remove(t
-0001b9e0: 7329 0a20 2020 2020 2020 2020 2020 2064  s).            d
-0001b9f0: 7473 2e77 6169 7465 7273 2e64 6973 6361  ts.waiters.disca
-0001ba00: 7264 2874 7329 0a20 2020 2020 2020 2020  rd(ts).         
-0001ba10: 2020 2069 6620 6e6f 7420 6474 732e 6465     if not dts.de
-0001ba20: 7065 6e64 656e 7473 2061 6e64 206e 6f74  pendents and not
-0001ba30: 2064 7473 2e77 686f 5f77 616e 7473 3a0a   dts.who_wants:.
-0001ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba50: 2320 5461 736b 206e 6f74 206e 6565 6465  # Task not neede
-0001ba60: 6420 616e 796d 6f72 650a 2020 2020 2020  d anymore.      
-0001ba70: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001ba80: 2064 7473 2069 7320 6e6f 7420 7473 0a20   dts is not ts. 
-0001ba90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001baa0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
-0001bab0: 7473 2e6b 6579 5d20 3d20 2266 6f72 676f  ts.key] = "forgo
-0001bac0: 7474 656e 220a 2020 2020 2020 2020 7473  tten".        ts
-0001bad0: 2e64 6570 656e 6465 6e63 6965 732e 636c  .dependencies.cl
-0001bae0: 6561 7228 290a 2020 2020 2020 2020 7473  ear().        ts
-0001baf0: 2e77 6169 7469 6e67 5f6f 6e2e 636c 6561  .waiting_on.clea
-0001bb00: 7228 290a 0a20 2020 2020 2020 2066 6f72  r()..        for
-0001bb10: 2077 7320 696e 2074 732e 7768 6f5f 6861   ws in ts.who_ha
-0001bb20: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0001bb30: 6620 7773 2e61 6464 7265 7373 2069 6e20  f ws.address in 
-0001bb40: 7365 6c66 2e77 6f72 6b65 7273 3a20 2023  self.workers:  #
-0001bb50: 2069 6e20 6361 7365 2077 6f72 6b65 7220   in case worker 
-0001bb60: 6861 7320 6469 6564 0a20 2020 2020 2020  has died.       
-0001bb70: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
-0001bb80: 6d73 6773 5b77 732e 6164 6472 6573 735d  msgs[ws.address]
-0001bb90: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0001bba0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbc0: 2020 2022 6f70 223a 2022 6672 6565 2d6b     "op": "free-k
-0001bbd0: 6579 7322 2c0a 2020 2020 2020 2020 2020  eys",.          
-0001bbe0: 2020 2020 2020 2020 2020 2020 2020 226b                "k
-0001bbf0: 6579 7322 3a20 5b74 732e 6b65 795d 2c0a  eys": [ts.key],.
-0001bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc10: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
-0001bc20: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
-0001bc30: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0001bc40: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0001bc50: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-0001bc60: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-0001bc70: 616c 6c5f 7265 706c 6963 6173 2874 7329  all_replicas(ts)
-0001bc80: 0a0a 2020 2020 6465 6620 5f63 6c69 656e  ..    def _clien
-0001bc90: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
-0001bca0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0001bcb0: 2020 2020 2020 206b 6579 733a 2043 6f6c         keys: Col
-0001bcc0: 6c65 6374 696f 6e5b 7374 725d 2c0a 2020  lection[str],.  
-0001bcd0: 2020 2020 2020 6373 3a20 436c 6965 6e74        cs: Client
-0001bce0: 5374 6174 652c 0a20 2020 2020 2020 2072  State,.        r
-0001bcf0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-0001bd00: 5265 6373 2c0a 2020 2020 2920 2d3e 204e  Recs,.    ) -> N
-0001bd10: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0001bd20: 5265 6d6f 7665 206b 6579 7320 6672 6f6d  Remove keys from
-0001bd30: 2063 6c69 656e 7420 6465 7369 7265 6420   client desired 
-0001bd40: 6c69 7374 2222 220a 2020 2020 2020 2020  list""".        
-0001bd50: 6c6f 6767 6572 2e64 6562 7567 2822 436c  logger.debug("Cl
-0001bd60: 6965 6e74 2025 7320 7265 6c65 6173 6573  ient %s releases
-0001bd70: 206b 6579 733a 2025 7322 2c20 6373 2e63   keys: %s", cs.c
-0001bd80: 6c69 656e 745f 6b65 792c 206b 6579 7329  lient_key, keys)
-0001bd90: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
-0001bda0: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
-0001bdb0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-0001bdc0: 7461 736b 732e 6765 7428 6b65 7929 0a20  tasks.get(key). 
-0001bdd0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0001bde0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-0001bdf0: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
-0001be00: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
-0001be10: 2020 2020 2020 6373 2e77 616e 7473 5f77        cs.wants_w
-0001be20: 6861 742e 7265 6d6f 7665 2874 7329 0a20  hat.remove(ts). 
-0001be30: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001be40: 732e 7768 6f5f 7761 6e74 732e 7265 6d6f  s.who_wants.remo
-0001be50: 7665 2863 7329 0a20 2020 2020 2020 2020  ve(cs).         
-0001be60: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-0001be70: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
-0001be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be90: 6966 206e 6f74 2074 732e 6465 7065 6e64  if not ts.depend
-0001bea0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-0001beb0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001bec0: 4e6f 206c 6976 6520 6465 7065 6e64 656e  No live dependen
-0001bed0: 7473 2c20 6361 6e20 666f 7267 6574 0a20  ts, can forget. 
-0001bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bef0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-0001bf00: 6174 696f 6e73 5b74 732e 6b65 795d 203d  ations[ts.key] =
-0001bf10: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
+00014e70: 7373 6572 7420 7473 2e65 7863 6570 7469  ssert ts.excepti
+00014e80: 6f6e 5f62 6c61 6d65 0a20 2020 2020 2020  on_blame.       
+00014e90: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00014ea0: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
+00014eb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00014ec0: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+00014ed0: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
+00014ee0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00014ef0: 6f74 2074 732e 7761 6974 6572 730a 0a20  ot ts.waiters.. 
+00014f00: 2020 2020 2020 2066 6169 6c69 6e67 5f74         failing_t
+00014f10: 7320 3d20 7473 2e65 7863 6570 7469 6f6e  s = ts.exception
+00014f20: 5f62 6c61 6d65 0a20 2020 2020 2020 2061  _blame.        a
+00014f30: 7373 6572 7420 6661 696c 696e 675f 7473  ssert failing_ts
+00014f40: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+00014f50: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00014f60: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00014f70: 6474 732e 6578 6365 7074 696f 6e5f 626c  dts.exception_bl
+00014f80: 616d 6520 3d20 6661 696c 696e 675f 7473  ame = failing_ts
+00014f90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00014fa0: 6e6f 7420 6474 732e 7768 6f5f 6861 733a  not dts.who_has:
+00014fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014fc0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00014fd0: 5b64 7473 2e6b 6579 5d20 3d20 2265 7272  [dts.key] = "err
+00014fe0: 6564 220a 0a20 2020 2020 2020 2072 6570  ed"..        rep
+00014ff0: 6f72 745f 6d73 6720 3d20 7b0a 2020 2020  ort_msg = {.    
+00015000: 2020 2020 2020 2020 226f 7022 3a20 2274          "op": "t
+00015010: 6173 6b2d 6572 7265 6422 2c0a 2020 2020  ask-erred",.    
+00015020: 2020 2020 2020 2020 226b 6579 223a 206b          "key": k
+00015030: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
+00015040: 2265 7863 6570 7469 6f6e 223a 2066 6169  "exception": fai
+00015050: 6c69 6e67 5f74 732e 6578 6365 7074 696f  ling_ts.exceptio
+00015060: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
+00015070: 7472 6163 6562 6163 6b22 3a20 6661 696c  traceback": fail
+00015080: 696e 675f 7473 2e74 7261 6365 6261 636b  ing_ts.traceback
+00015090: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
+000150a0: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
+000150b0: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
+000150c0: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+000150d0: 7367 735b 6373 2e63 6c69 656e 745f 6b65  sgs[cs.client_ke
+000150e0: 795d 203d 205b 7265 706f 7274 5f6d 7367  y] = [report_msg
+000150f0: 5d0a 0a20 2020 2020 2020 2074 732e 7374  ]..        ts.st
+00015100: 6174 6520 3d20 2265 7272 6564 220a 0a20  ate = "erred".. 
+00015110: 2020 2020 2020 2023 2054 4f44 4f3a 2077         # TODO: w
+00015120: 6169 7469 6e67 2064 6174 613f 0a20 2020  aiting data?.   
+00015130: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
+00015140: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+00015150: 656e 745f 6d73 6773 2c20 7b7d 0a0a 2020  ent_msgs, {}..  
+00015160: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+00015170: 5f65 7272 6564 5f72 656c 6561 7365 6428  _erred_released(
+00015180: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00015190: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+000151a0: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
+000151b0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+000151c0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+000151d0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+000151e0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
+000151f0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+00015200: 6773 3a20 4d73 6773 203d 207b 7d0a 2020  gs: Msgs = {}.  
+00015210: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+00015220: 733a 204d 7367 7320 3d20 7b7d 0a0a 2020  s: Msgs = {}..  
+00015230: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+00015240: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+00015250: 2020 2020 7769 7468 206c 6f67 5f65 7272      with log_err
+00015260: 6f72 7328 7064 623d 4c4f 475f 5044 4229  ors(pdb=LOG_PDB)
+00015270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015280: 2020 6173 7365 7274 2074 732e 6578 6365    assert ts.exce
+00015290: 7074 696f 6e5f 626c 616d 650a 2020 2020  ption_blame.    
+000152a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000152b0: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
+000152c0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000152d0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+000152e0: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
+000152f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00015300: 7420 6e6f 7420 7473 2e77 6169 7465 7273  t not ts.waiters
+00015310: 0a0a 2020 2020 2020 2020 7473 2e65 7863  ..        ts.exc
+00015320: 6570 7469 6f6e 203d 204e 6f6e 650a 2020  eption = None.  
+00015330: 2020 2020 2020 7473 2e65 7863 6570 7469        ts.excepti
+00015340: 6f6e 5f62 6c61 6d65 203d 204e 6f6e 650a  on_blame = None.
+00015350: 2020 2020 2020 2020 7473 2e74 7261 6365          ts.trace
+00015360: 6261 636b 203d 204e 6f6e 650a 0a20 2020  back = None..   
+00015370: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+00015380: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
+00015390: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
+000153a0: 732e 7374 6174 6520 3d3d 2022 6572 7265  s.state == "erre
+000153b0: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
+000153c0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+000153d0: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
+000153e0: 7761 6974 696e 6722 0a0a 2020 2020 2020  waiting"..      
+000153f0: 2020 775f 6d73 6720 3d20 7b0a 2020 2020    w_msg = {.    
+00015400: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
+00015410: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
+00015420: 2020 2020 2020 2022 6b65 7973 223a 205b         "keys": [
+00015430: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
+00015440: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+00015450: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+00015460: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00015470: 666f 7220 7773 5f61 6464 7220 696e 2074  for ws_addr in t
+00015480: 732e 6572 7265 645f 6f6e 3a0a 2020 2020  s.erred_on:.    
+00015490: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+000154a0: 7367 735b 7773 5f61 6464 725d 203d 205b  sgs[ws_addr] = [
+000154b0: 775f 6d73 675d 0a20 2020 2020 2020 2074  w_msg].        t
+000154c0: 732e 6572 7265 645f 6f6e 2e63 6c65 6172  s.erred_on.clear
+000154d0: 2829 0a0a 2020 2020 2020 2020 7265 706f  ()..        repo
+000154e0: 7274 5f6d 7367 203d 207b 226f 7022 3a20  rt_msg = {"op": 
+000154f0: 2274 6173 6b2d 7265 7472 6965 6422 2c20  "task-retried", 
+00015500: 226b 6579 223a 206b 6579 7d0a 2020 2020  "key": key}.    
+00015510: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
+00015520: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
+00015530: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00015540: 7367 735b 6373 2e63 6c69 656e 745f 6b65  sgs[cs.client_ke
+00015550: 795d 203d 205b 7265 706f 7274 5f6d 7367  y] = [report_msg
+00015560: 5d0a 0a20 2020 2020 2020 2074 732e 7374  ]..        ts.st
+00015570: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
+00015580: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00015590: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+000155a0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
+000155b0: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
+000155c0: 6465 6620 7472 616e 7369 7469 6f6e 5f77  def transition_w
+000155d0: 6169 7469 6e67 5f72 656c 6561 7365 6428  aiting_released(
+000155e0: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+000155f0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00015600: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
+00015610: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00015620: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+00015630: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00015640: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a0a  ons: Recs = {}..
+00015650: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00015660: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00015670: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00015680: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+00015690: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+000156a0: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
+000156b0: 5f6f 6e0a 0a20 2020 2020 2020 2066 6f72  _on..        for
+000156c0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+000156d0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+000156e0: 2020 2020 2069 6620 7473 2069 6e20 6474       if ts in dt
+000156f0: 732e 7761 6974 6572 733a 0a20 2020 2020  s.waiters:.     
+00015700: 2020 2020 2020 2020 2020 2064 7473 2e77             dts.w
+00015710: 6169 7465 7273 2e64 6973 6361 7264 2874  aiters.discard(t
+00015720: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00015730: 2020 2069 6620 6e6f 7420 6474 732e 7761     if not dts.wa
+00015740: 6974 6572 7320 616e 6420 6e6f 7420 6474  iters and not dt
+00015750: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
+00015760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015770: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00015780: 5b64 7473 2e6b 6579 5d20 3d20 2272 656c  [dts.key] = "rel
+00015790: 6561 7365 6422 0a20 2020 2020 2020 2074  eased".        t
+000157a0: 732e 7761 6974 696e 675f 6f6e 2e63 6c65  s.waiting_on.cle
+000157b0: 6172 2829 0a0a 2020 2020 2020 2020 7473  ar()..        ts
+000157c0: 2e73 7461 7465 203d 2022 7265 6c65 6173  .state = "releas
+000157d0: 6564 220a 0a20 2020 2020 2020 2069 6620  ed"..        if 
+000157e0: 7473 2e68 6173 5f6c 6f73 745f 6465 7065  ts.has_lost_depe
+000157f0: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+00015800: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00015810: 7469 6f6e 735b 6b65 795d 203d 2022 666f  tions[key] = "fo
+00015820: 7267 6f74 7465 6e22 0a20 2020 2020 2020  rgotten".       
+00015830: 2065 6c69 6620 6e6f 7420 7473 2e65 7863   elif not ts.exc
+00015840: 6570 7469 6f6e 5f62 6c61 6d65 2061 6e64  eption_blame and
+00015850: 2028 7473 2e77 686f 5f77 616e 7473 206f   (ts.who_wants o
+00015860: 7220 7473 2e77 6169 7465 7273 293a 0a20  r ts.waiters):. 
+00015870: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00015880: 6d65 6e64 6174 696f 6e73 5b6b 6579 5d20  mendations[key] 
+00015890: 3d20 2277 6169 7469 6e67 220a 2020 2020  = "waiting".    
+000158a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000158b0: 2020 2020 2020 7473 2e77 6169 7465 7273        ts.waiters
+000158c0: 2e63 6c65 6172 2829 0a0a 2020 2020 2020  .clear()..      
+000158d0: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
+000158e0: 6e64 6174 696f 6e73 2c20 7b7d 2c20 7b7d  ndations, {}, {}
+000158f0: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+00015900: 7469 6f6e 5f70 726f 6365 7373 696e 675f  tion_processing_
+00015910: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
+00015920: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
+00015930: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+00015940: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00015950: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00015960: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
+00015970: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+00015980: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
+00015990: 776f 726b 6572 5f6d 7367 733a 204d 7367  worker_msgs: Msg
+000159a0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+000159b0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+000159c0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+000159d0: 7365 7274 2074 732e 7072 6f63 6573 7369  sert ts.processi
+000159e0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+000159f0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00015a00: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+00015a10: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00015a20: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+00015a30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00015a40: 7473 2e73 7461 7465 203d 3d20 2270 726f  ts.state == "pro
+00015a50: 6365 7373 696e 6722 0a0a 2020 2020 2020  cessing"..      
+00015a60: 2020 7773 203d 2073 656c 662e 5f65 7869    ws = self._exi
+00015a70: 745f 7072 6f63 6573 7369 6e67 5f63 6f6d  t_processing_com
+00015a80: 6d6f 6e28 7473 290a 2020 2020 2020 2020  mon(ts).        
+00015a90: 6966 2077 733a 0a20 2020 2020 2020 2020  if ws:.         
+00015aa0: 2020 2077 6f72 6b65 725f 6d73 6773 5b77     worker_msgs[w
+00015ab0: 732e 6164 6472 6573 735d 203d 205b 0a20  s.address] = [. 
+00015ac0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00015ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ae0: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
+00015af0: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
+00015b00: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+00015b10: 7322 3a20 5b6b 6579 5d2c 0a20 2020 2020  s": [key],.     
+00015b20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00015b30: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
+00015b40: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+00015b50: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00015b60: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
+00015b70: 2020 2020 7365 6c66 2e5f 7072 6f70 6167      self._propag
+00015b80: 6174 655f 7265 6c65 6173 6564 2874 732c  ate_released(ts,
+00015b90: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00015ba0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00015bb0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00015bc0: 2c20 7b7d 2c20 776f 726b 6572 5f6d 7367  , {}, worker_msg
+00015bd0: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
+00015be0: 6974 696f 6e5f 7072 6f63 6573 7369 6e67  ition_processing
+00015bf0: 5f65 7272 6564 280a 2020 2020 2020 2020  _erred(.        
+00015c00: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
+00015c10: 793a 2073 7472 2c0a 2020 2020 2020 2020  y: str,.        
+00015c20: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00015c30: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00015c40: 2020 2020 2077 6f72 6b65 723a 2073 7472       worker: str
+00015c50: 2c0a 2020 2020 2020 2020 6361 7573 653a  ,.        cause:
+00015c60: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00015c70: 6e65 2c0a 2020 2020 2020 2020 6578 6365  ne,.        exce
+00015c80: 7074 696f 6e3a 2053 6572 6961 6c69 7a65  ption: Serialize
+00015c90: 6420 7c20 4e6f 6e65 203d 204e 6f6e 652c  d | None = None,
+00015ca0: 0a20 2020 2020 2020 2074 7261 6365 6261  .        traceba
+00015cb0: 636b 3a20 5365 7269 616c 697a 6564 207c  ck: Serialized |
+00015cc0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00015cd0: 2020 2020 2020 6578 6365 7074 696f 6e5f        exception_
+00015ce0: 7465 7874 3a20 7374 7220 7c20 4e6f 6e65  text: str | None
+00015cf0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00015d00: 2074 7261 6365 6261 636b 5f74 6578 743a   traceback_text:
+00015d10: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00015d20: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+00015d30: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
+00015d40: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
+00015d50: 2020 2020 2020 2222 2250 726f 6365 7373        """Process
+00015d60: 6564 2061 2072 6563 6f6d 6d65 6e64 6564  ed a recommended
+00015d70: 2074 7261 6e73 6974 696f 6e20 7072 6f63   transition proc
+00015d80: 6573 7369 6e67 202d 3e20 6572 7265 642e  essing -> erred.
+00015d90: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+00015da0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
+00015db0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00015dc0: 6b65 790a 2020 2020 2020 2020 2020 204b  key.           K
+00015dd0: 6579 206f 6620 7468 6520 7461 736b 2074  ey of the task t
+00015de0: 6f20 7472 616e 7369 7469 6f6e 0a20 2020  o transition.   
+00015df0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00015e00: 0a20 2020 2020 2020 2020 2020 2049 4420  .            ID 
+00015e10: 6f66 2074 6865 2073 7469 6d75 6c75 7320  of the stimulus 
+00015e20: 6361 7573 696e 6720 7468 6520 7472 616e  causing the tran
+00015e30: 7369 7469 6f6e 0a20 2020 2020 2020 2077  sition.        w
+00015e40: 6f72 6b65 720a 2020 2020 2020 2020 2020  orker.          
+00015e50: 2020 4164 6472 6573 7320 6f66 2074 6865    Address of the
+00015e60: 2077 6f72 6b65 7220 7768 6572 6520 7468   worker where th
+00015e70: 6520 7461 736b 2065 7272 6564 2e0a 2020  e task erred..  
+00015e80: 2020 2020 2020 2020 2020 4e6f 7420 6e65            Not ne
+00015e90: 6365 7373 6172 696c 7920 6060 7473 2e70  cessarily ``ts.p
+00015ea0: 726f 6365 7373 696e 675f 6f6e 6060 2e0a  rocessing_on``..
+00015eb0: 2020 2020 2020 2020 6361 7573 650a 2020          cause.  
+00015ec0: 2020 2020 2020 2020 2020 4164 6472 6573            Addres
+00015ed0: 7320 6f66 2074 6865 2074 6173 6b20 7468  s of the task th
+00015ee0: 6174 2063 6175 7365 6420 7468 6973 2074  at caused this t
+00015ef0: 6173 6b20 746f 2062 6520 7472 616e 7369  ask to be transi
+00015f00: 7469 6f6e 6564 2074 6f20 6572 7265 640a  tioned to erred.
+00015f10: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+00015f20: 6e0a 2020 2020 2020 2020 2020 2020 4578  n.            Ex
+00015f30: 6365 7074 696f 6e20 6361 7573 6564 2062  ception caused b
+00015f40: 7920 7468 6520 7461 736b 0a20 2020 2020  y the task.     
+00015f50: 2020 2074 7261 6365 6261 636b 0a20 2020     traceback.   
+00015f60: 2020 2020 2020 2020 2054 7261 6365 6261           Traceba
+00015f70: 636b 2063 6175 7365 6420 6279 2074 6865  ck caused by the
+00015f80: 2074 6173 6b0a 2020 2020 2020 2020 6578   task.        ex
+00015f90: 6365 7074 696f 6e5f 7465 7874 0a20 2020  ception_text.   
+00015fa0: 2020 2020 2020 2020 2053 7472 696e 6720           String 
+00015fb0: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
+00015fc0: 6620 7468 6520 6578 6365 7074 696f 6e0a  f the exception.
+00015fd0: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
+00015fe0: 6b5f 7465 7874 0a20 2020 2020 2020 2020  k_text.         
+00015ff0: 2020 2053 7472 696e 6720 7265 7072 6573     String repres
+00016000: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
+00016010: 7472 6163 6562 6163 6b0a 0a20 2020 2020  traceback..     
+00016020: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+00016030: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00016040: 2020 2052 6563 6f6d 6d65 6e64 6174 696f     Recommendatio
+00016050: 6e73 2c20 636c 6965 6e74 206d 6573 7361  ns, client messa
+00016060: 6765 7320 616e 6420 776f 726b 6572 206d  ges and worker m
+00016070: 6573 7361 6765 7320 746f 2070 726f 6365  essages to proce
+00016080: 7373 0a20 2020 2020 2020 2022 2222 0a20  ss.        """. 
+00016090: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+000160a0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+000160b0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+000160c0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
+000160d0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+000160e0: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
+000160f0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00016100: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00016110: 2020 2020 2061 7373 6572 7420 6361 7573       assert caus
+00016120: 6520 6f72 2074 732e 6578 6365 7074 696f  e or ts.exceptio
+00016130: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
+00016140: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
+00016150: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+00016160: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00016170: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
+00016180: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00016190: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+000161a0: 6f6e 0a0a 2020 2020 2020 2020 6966 2074  on..        if t
+000161b0: 732e 6163 746f 723a 0a20 2020 2020 2020  s.actor:.       
+000161c0: 2020 2020 2077 7320 3d20 7473 2e70 726f       ws = ts.pro
+000161d0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+000161e0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+000161f0: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+00016200: 6163 746f 7273 2e72 656d 6f76 6528 7473  actors.remove(ts
+00016210: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00016220: 5f65 7869 745f 7072 6f63 6573 7369 6e67  _exit_processing
+00016230: 5f63 6f6d 6d6f 6e28 7473 290a 0a20 2020  _common(ts)..   
+00016240: 2020 2020 2074 732e 6572 7265 645f 6f6e       ts.erred_on
+00016250: 2e61 6464 2877 6f72 6b65 7229 0a20 2020  .add(worker).   
+00016260: 2020 2020 2069 6620 6578 6365 7074 696f       if exceptio
+00016270: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
+00016280: 2020 2020 2020 2020 2020 2074 732e 6578             ts.ex
+00016290: 6365 7074 696f 6e20 3d20 6578 6365 7074  ception = except
+000162a0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+000162b0: 7473 2e65 7863 6570 7469 6f6e 5f74 6578  ts.exception_tex
+000162c0: 7420 3d20 6578 6365 7074 696f 6e5f 7465  t = exception_te
+000162d0: 7874 2020 2320 7479 7065 3a20 6967 6e6f  xt  # type: igno
+000162e0: 7265 0a20 2020 2020 2020 2069 6620 7472  re.        if tr
+000162f0: 6163 6562 6163 6b20 6973 206e 6f74 204e  aceback is not N
+00016300: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00016310: 2074 732e 7472 6163 6562 6163 6b20 3d20   ts.traceback = 
+00016320: 7472 6163 6562 6163 6b0a 2020 2020 2020  traceback.      
+00016330: 2020 2020 2020 7473 2e74 7261 6365 6261        ts.traceba
+00016340: 636b 5f74 6578 7420 3d20 7472 6163 6562  ck_text = traceb
+00016350: 6163 6b5f 7465 7874 2020 2320 7479 7065  ack_text  # type
+00016360: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+00016370: 2069 6620 6361 7573 6520 6973 206e 6f74   if cause is not
+00016380: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00016390: 2020 2066 6169 6c69 6e67 5f74 7320 3d20     failing_ts = 
+000163a0: 7365 6c66 2e74 6173 6b73 5b63 6175 7365  self.tasks[cause
+000163b0: 5d0a 2020 2020 2020 2020 2020 2020 7473  ].            ts
+000163c0: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+000163d0: 203d 2066 6169 6c69 6e67 5f74 730a 2020   = failing_ts.  
+000163e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000163f0: 2020 2020 2020 2020 6661 696c 696e 675f          failing_
+00016400: 7473 203d 2074 732e 6578 6365 7074 696f  ts = ts.exceptio
+00016410: 6e5f 626c 616d 6520 2023 2074 7970 653a  n_blame  # type:
+00016420: 2069 676e 6f72 650a 0a20 2020 2020 2020   ignore..       
+00016430: 2073 656c 662e 6572 7265 645f 7461 736b   self.erred_task
+00016440: 732e 6170 7065 6e64 6c65 6674 280a 2020  s.appendleft(.  
+00016450: 2020 2020 2020 2020 2020 4572 7265 6454            ErredT
+00016460: 6173 6b28 0a20 2020 2020 2020 2020 2020  ask(.           
+00016470: 2020 2020 2074 732e 6b65 792c 0a20 2020       ts.key,.   
+00016480: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+00016490: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
+000164a0: 2020 2020 2074 732e 6572 7265 645f 6f6e       ts.erred_on
+000164b0: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
+000164c0: 2020 2020 2020 2020 2065 7863 6570 7469           excepti
+000164d0: 6f6e 5f74 6578 7420 6f72 2022 222c 0a20  on_text or "",. 
+000164e0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000164f0: 7261 6365 6261 636b 5f74 6578 7420 6f72  raceback_text or
+00016500: 2022 222c 0a20 2020 2020 2020 2020 2020   "",.           
+00016510: 2029 0a20 2020 2020 2020 2029 0a0a 2020   ).        )..  
+00016520: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+00016530: 2074 732e 6465 7065 6e64 656e 7473 3a0a   ts.dependents:.
+00016540: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
+00016550: 6578 6365 7074 696f 6e5f 626c 616d 6520  exception_blame 
+00016560: 3d20 6661 696c 696e 675f 7473 0a20 2020  = failing_ts.   
+00016570: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+00016580: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
+00016590: 5d20 3d20 2265 7272 6564 220a 0a20 2020  ] = "erred"..   
+000165a0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+000165b0: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
+000165c0: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
+000165d0: 2e77 6169 7465 7273 2e64 6973 6361 7264  .waiters.discard
+000165e0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+000165f0: 2069 6620 6e6f 7420 6474 732e 7761 6974   if not dts.wait
+00016600: 6572 7320 616e 6420 6e6f 7420 6474 732e  ers and not dts.
+00016610: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
+00016620: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00016630: 6d65 6e64 6174 696f 6e73 5b64 7473 2e6b  mendations[dts.k
+00016640: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
+00016650: 0a0a 2020 2020 2020 2020 7473 2e77 6169  ..        ts.wai
+00016660: 7465 7273 2e63 6c65 6172 2829 2020 2320  ters.clear()  # 
+00016670: 646f 2061 6e79 7468 696e 6720 7769 7468  do anything with
+00016680: 2074 6869 733f 0a0a 2020 2020 2020 2020   this?..        
+00016690: 7473 2e73 7461 7465 203d 2022 6572 7265  ts.state = "erre
+000166a0: 6422 0a0a 2020 2020 2020 2020 7265 706f  d"..        repo
+000166b0: 7274 5f6d 7367 203d 207b 0a20 2020 2020  rt_msg = {.     
+000166c0: 2020 2020 2020 2022 6f70 223a 2022 7461         "op": "ta
+000166d0: 736b 2d65 7272 6564 222c 0a20 2020 2020  sk-erred",.     
+000166e0: 2020 2020 2020 2022 6b65 7922 3a20 6b65         "key": ke
+000166f0: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
+00016700: 6578 6365 7074 696f 6e22 3a20 6661 696c  exception": fail
+00016710: 696e 675f 7473 2e65 7863 6570 7469 6f6e  ing_ts.exception
+00016720: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00016730: 7261 6365 6261 636b 223a 2066 6169 6c69  raceback": faili
+00016740: 6e67 5f74 732e 7472 6163 6562 6163 6b2c  ng_ts.traceback,
+00016750: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00016760: 2020 2066 6f72 2063 7320 696e 2074 732e     for cs in ts.
+00016770: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
+00016780: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+00016790: 6773 5b63 732e 636c 6965 6e74 5f6b 6579  gs[cs.client_key
+000167a0: 5d20 3d20 5b72 6570 6f72 745f 6d73 675d  ] = [report_msg]
+000167b0: 0a0a 2020 2020 2020 2020 6373 203d 2073  ..        cs = s
+000167c0: 656c 662e 636c 6965 6e74 735b 2266 6972  elf.clients["fir
+000167d0: 652d 616e 642d 666f 7267 6574 225d 0a20  e-and-forget"]. 
+000167e0: 2020 2020 2020 2069 6620 7473 2069 6e20         if ts in 
+000167f0: 6373 2e77 616e 7473 5f77 6861 743a 0a20  cs.wants_what:. 
+00016800: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00016810: 5f63 6c69 656e 745f 7265 6c65 6173 6573  _client_releases
+00016820: 5f6b 6579 7328 0a20 2020 2020 2020 2020  _keys(.         
+00016830: 2020 2020 2020 2063 733d 6373 2c0a 2020         cs=cs,.  
+00016840: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+00016850: 7973 3d5b 6b65 795d 2c0a 2020 2020 2020  ys=[key],.      
+00016860: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+00016870: 656e 6461 7469 6f6e 733d 7265 636f 6d6d  endations=recomm
+00016880: 656e 6461 7469 6f6e 732c 0a20 2020 2020  endations,.     
+00016890: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000168a0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+000168b0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+000168c0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+000168d0: 6f63 6573 7369 6e67 5f6f 6e0a 0a20 2020  ocessing_on..   
+000168e0: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
+000168f0: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+00016900: 656e 745f 6d73 6773 2c20 7b7d 0a0a 2020  ent_msgs, {}..  
+00016910: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+00016920: 5f6e 6f5f 776f 726b 6572 5f72 656c 6561  _no_worker_relea
+00016930: 7365 6428 7365 6c66 2c20 6b65 793a 2073  sed(self, key: s
+00016940: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
+00016950: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
+00016960: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
+00016970: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00016980: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00016990: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+000169a0: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+000169b0: 6c66 2e74 6173 6b73 5b6b 6579 5d2e 7374  lf.tasks[key].st
+000169c0: 6174 6520 3d3d 2022 6e6f 2d77 6f72 6b65  ate == "no-worke
+000169d0: 7222 0a20 2020 2020 2020 2020 2020 2061  r".            a
+000169e0: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+000169f0: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
+00016a00: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00016a10: 6169 7469 6e67 5f6f 6e0a 0a20 2020 2020  aiting_on..     
+00016a20: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
+00016a30: 6c65 2e72 656d 6f76 6528 7473 290a 2020  le.remove(ts).  
+00016a40: 2020 2020 2020 7473 2e73 7461 7465 203d        ts.state =
+00016a50: 2022 7265 6c65 6173 6564 220a 0a20 2020   "released"..   
+00016a60: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+00016a70: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
+00016a80: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
+00016a90: 2e77 6169 7465 7273 2e64 6973 6361 7264  .waiters.discard
+00016aa0: 2874 7329 0a0a 2020 2020 2020 2020 7473  (ts)..        ts
+00016ab0: 2e77 6169 7465 7273 2e63 6c65 6172 2829  .waiters.clear()
+00016ac0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00016ad0: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
+00016ae0: 2064 6566 2074 7261 6e73 6974 696f 6e5f   def transition_
+00016af0: 7761 6974 696e 675f 7175 6575 6564 2873  waiting_queued(s
+00016b00: 656c 662c 206b 6579 3a20 7374 722c 2073  elf, key: str, s
+00016b10: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
+00016b20: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
+00016b30: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00016b40: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
+00016b50: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+00016b60: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00016b70: 2020 6173 7365 7274 206e 6f74 2073 656c    assert not sel
+00016b80: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
+00016b90: 742c 2028 7473 2c20 7365 6c66 2e69 646c  t, (ts, self.idl
+00016ba0: 655f 7461 736b 5f63 6f75 6e74 290a 2020  e_task_count).  
+00016bb0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00016bc0: 7661 6c69 6461 7465 5f72 6561 6479 2874  validate_ready(t
+00016bd0: 7329 0a0a 2020 2020 2020 2020 7473 2e73  s)..        ts.s
+00016be0: 7461 7465 203d 2022 7175 6575 6564 220a  tate = "queued".
+00016bf0: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
+00016c00: 7565 642e 6164 6428 7473 290a 0a20 2020  ued.add(ts)..   
+00016c10: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
+00016c20: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
+00016c30: 7472 616e 7369 7469 6f6e 5f77 6169 7469  transition_waiti
+00016c40: 6e67 5f6e 6f5f 776f 726b 6572 2873 656c  ng_no_worker(sel
+00016c50: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
+00016c60: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
+00016c70: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
+00016c80: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00016c90: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
+00016ca0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00016cb0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00016cc0: 7365 6c66 2e5f 7661 6c69 6461 7465 5f72  self._validate_r
+00016cd0: 6561 6479 2874 7329 0a0a 2020 2020 2020  eady(ts)..      
+00016ce0: 2020 7473 2e73 7461 7465 203d 2022 6e6f    ts.state = "no
+00016cf0: 2d77 6f72 6b65 7222 0a20 2020 2020 2020  -worker".       
+00016d00: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+00016d10: 2e61 6464 2874 7329 0a0a 2020 2020 2020  .add(ts)..      
+00016d20: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
+00016d30: 207b 7d0a 0a20 2020 2064 6566 2074 7261   {}..    def tra
+00016d40: 6e73 6974 696f 6e5f 7175 6575 6564 5f72  nsition_queued_r
+00016d50: 656c 6561 7365 6428 7365 6c66 2c20 6b65  eleased(self, ke
+00016d60: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
+00016d70: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
+00016d80: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
+00016d90: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00016da0: 6579 5d0a 0a20 2020 2020 2020 2069 6620  ey]..        if 
+00016db0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+00016dc0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00016dd0: 7420 7473 2069 6e20 7365 6c66 2e71 7565  t ts in self.que
+00016de0: 7565 640a 2020 2020 2020 2020 2020 2020  ued.            
+00016df0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+00016e00: 6f63 6573 7369 6e67 5f6f 6e0a 0a20 2020  ocessing_on..   
+00016e10: 2020 2020 2073 656c 662e 7175 6575 6564       self.queued
+00016e20: 2e72 656d 6f76 6528 7473 290a 0a20 2020  .remove(ts)..   
+00016e30: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00016e40: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00016e50: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
+00016e60: 6f70 6167 6174 655f 7265 6c65 6173 6564  opagate_released
+00016e70: 2874 732c 2072 6563 6f6d 6d65 6e64 6174  (ts, recommendat
+00016e80: 696f 6e73 290a 2020 2020 2020 2020 7265  ions).        re
+00016e90: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
+00016ea0: 696f 6e73 2c20 7b7d 2c20 7b7d 0a0a 2020  ions, {}, {}..  
+00016eb0: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+00016ec0: 5f71 7565 7565 645f 7072 6f63 6573 7369  _queued_processi
+00016ed0: 6e67 2873 656c 662c 206b 6579 3a20 7374  ng(self, key: st
+00016ee0: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+00016ef0: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
+00016f00: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+00016f10: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+00016f20: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+00016f30: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
+00016f40: 7d0a 2020 2020 2020 2020 776f 726b 6572  }.        worker
+00016f50: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
+00016f60: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00016f70: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+00016f80: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00016f90: 6f74 2074 732e 6163 746f 722c 2066 2241  ot ts.actor, f"A
+00016fa0: 6374 6f72 7320 6361 6e27 7420 6265 2071  ctors can't be q
+00016fb0: 7565 7565 643a 207b 7473 7d22 0a20 2020  ueued: {ts}".   
+00016fc0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00016fd0: 7473 2069 6e20 7365 6c66 2e71 7565 7565  ts in self.queue
+00016fe0: 640a 0a20 2020 2020 2020 2069 6620 7773  d..        if ws
+00016ff0: 203a 3d20 7365 6c66 2e64 6563 6964 655f   := self.decide_
+00017000: 776f 726b 6572 5f72 6f6f 7469 7368 5f71  worker_rootish_q
+00017010: 7565 7569 6e67 5f65 6e61 626c 6564 2829  ueuing_enabled()
+00017020: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00017030: 6c66 2e71 7565 7565 642e 6469 7363 6172  lf.queued.discar
+00017040: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
+00017050: 2020 776f 726b 6572 5f6d 7367 7320 3d20    worker_msgs = 
+00017060: 7365 6c66 2e5f 6164 645f 746f 5f70 726f  self._add_to_pro
+00017070: 6365 7373 696e 6728 7473 2c20 7773 290a  cessing(ts, ws).
+00017080: 2020 2020 2020 2020 2320 4966 206e 6f20          # If no 
+00017090: 776f 726b 6572 2c20 7461 736b 206a 7573  worker, task jus
+000170a0: 7420 7374 6179 7320 6071 7565 7565 6460  t stays `queued`
+000170b0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000170c0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+000170d0: 2c20 7b7d 2c20 776f 726b 6572 5f6d 7367  , {}, worker_msg
+000170e0: 730a 0a20 2020 2064 6566 205f 7265 6d6f  s..    def _remo
+000170f0: 7665 5f6b 6579 2873 656c 662c 206b 6579  ve_key(self, key
+00017100: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+00017110: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00017120: 662e 7461 736b 732e 706f 7028 6b65 7929  f.tasks.pop(key)
+00017130: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00017140: 7473 2e73 7461 7465 203d 3d20 2266 6f72  ts.state == "for
+00017150: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
+00017160: 7365 6c66 2e75 6e72 756e 6e61 626c 652e  self.unrunnable.
+00017170: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+00017180: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
+00017190: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
+000171a0: 2020 2020 2020 2020 6373 2e77 616e 7473          cs.wants
+000171b0: 5f77 6861 742e 7265 6d6f 7665 2874 7329  _what.remove(ts)
+000171c0: 0a20 2020 2020 2020 2074 732e 7768 6f5f  .        ts.who_
+000171d0: 7761 6e74 732e 636c 6561 7228 290a 2020  wants.clear().  
+000171e0: 2020 2020 2020 7473 2e70 726f 6365 7373        ts.process
+000171f0: 696e 675f 6f6e 203d 204e 6f6e 650a 2020  ing_on = None.  
+00017200: 2020 2020 2020 7473 2e65 7863 6570 7469        ts.excepti
+00017210: 6f6e 5f62 6c61 6d65 203d 2074 732e 6578  on_blame = ts.ex
+00017220: 6365 7074 696f 6e20 3d20 7473 2e74 7261  ception = ts.tra
+00017230: 6365 6261 636b 203d 204e 6f6e 650a 2020  ceback = None.  
+00017240: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
+00017250: 6d65 7461 6461 7461 2e70 6f70 286b 6579  metadata.pop(key
+00017260: 2c20 4e6f 6e65 290a 0a20 2020 2064 6566  , None)..    def
+00017270: 2074 7261 6e73 6974 696f 6e5f 6d65 6d6f   transition_memo
+00017280: 7279 5f66 6f72 676f 7474 656e 2873 656c  ry_forgotten(sel
+00017290: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
+000172a0: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
+000172b0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
+000172c0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+000172d0: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
+000172e0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+000172f0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00017300: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
+00017310: 3d3d 2022 6d65 6d6f 7279 220a 2020 2020  == "memory".    
+00017320: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00017330: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
+00017340: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
+00017350: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+00017360: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+00017370: 2020 2020 2069 6620 6e6f 7420 7473 2e72       if not ts.r
+00017380: 756e 5f73 7065 633a 0a20 2020 2020 2020  un_spec:.       
+00017390: 2020 2020 2020 2020 2023 2049 7427 7320           # It's 
+000173a0: 6f6b 2074 6f20 666f 7267 6574 2061 2070  ok to forget a p
+000173b0: 7572 6520 6461 7461 2074 6173 6b0a 2020  ure data task.  
+000173c0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000173d0: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
+000173e0: 6c69 6620 7473 2e68 6173 5f6c 6f73 745f  lif ts.has_lost_
+000173f0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+00017400: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00017410: 4974 2773 206f 6b20 746f 2066 6f72 6765  It's ok to forge
+00017420: 7420 6120 7461 736b 2077 6974 6820 666f  t a task with fo
+00017430: 7267 6f74 7465 6e20 6465 7065 6e64 656e  rgotten dependen
+00017440: 6369 6573 0a20 2020 2020 2020 2020 2020  cies.           
+00017450: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+00017460: 2020 2020 2020 656c 6966 206e 6f74 2074        elif not t
+00017470: 732e 7768 6f5f 7761 6e74 7320 616e 6420  s.who_wants and 
+00017480: 6e6f 7420 7473 2e77 6169 7465 7273 2061  not ts.waiters a
+00017490: 6e64 206e 6f74 2074 732e 6465 7065 6e64  nd not ts.depend
+000174a0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+000174b0: 2020 2020 2020 2320 4974 2773 206f 6b20        # It's ok 
+000174c0: 746f 2066 6f72 6765 7420 6120 7461 736b  to forget a task
+000174d0: 2074 6861 7420 6e6f 626f 6479 206e 6565   that nobody nee
+000174e0: 6473 0a20 2020 2020 2020 2020 2020 2020  ds.             
+000174f0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+00017500: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00017510: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00017520: 4173 7365 7274 696f 6e45 7272 6f72 2822  AssertionError("
+00017530: 556e 7265 6163 6861 626c 6522 2c20 7473  Unreachable", ts
+00017540: 2920 2023 2070 7261 676d 613a 206e 6f63  )  # pragma: noc
+00017550: 6f76 6572 0a0a 2020 2020 2020 2020 6966  over..        if
+00017560: 2074 732e 6163 746f 723a 0a20 2020 2020   ts.actor:.     
+00017570: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+00017580: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
+00017590: 2020 2020 2020 2020 2020 2020 2077 732e               ws.
+000175a0: 6163 746f 7273 2e64 6973 6361 7264 2874  actors.discard(t
+000175b0: 7329 0a0a 2020 2020 2020 2020 7265 636f  s)..        reco
+000175c0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+000175d0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
+000175e0: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+000175f0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+00017600: 6c66 2e5f 7072 6f70 6167 6174 655f 666f  lf._propagate_fo
+00017610: 7267 6f74 7465 6e28 7473 2c20 7265 636f  rgotten(ts, reco
+00017620: 6d6d 656e 6461 7469 6f6e 732c 2077 6f72  mmendations, wor
+00017630: 6b65 725f 6d73 6773 2c20 7374 696d 756c  ker_msgs, stimul
+00017640: 7573 5f69 6429 0a0a 2020 2020 2020 2020  us_id)..        
+00017650: 636c 6965 6e74 5f6d 7367 7320 3d20 5f74  client_msgs = _t
+00017660: 6173 6b5f 746f 5f63 6c69 656e 745f 6d73  ask_to_client_ms
+00017670: 6773 2874 7329 0a20 2020 2020 2020 2073  gs(ts).        s
+00017680: 656c 662e 5f72 656d 6f76 655f 6b65 7928  elf._remove_key(
+00017690: 6b65 7929 0a0a 2020 2020 2020 2020 7265  key)..        re
+000176a0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
+000176b0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+000176c0: 732c 2077 6f72 6b65 725f 6d73 6773 0a0a  s, worker_msgs..
+000176d0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
+000176e0: 6f6e 5f72 656c 6561 7365 645f 666f 7267  on_released_forg
+000176f0: 6f74 7465 6e28 7365 6c66 2c20 6b65 793a  otten(self, key:
+00017700: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00017710: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
+00017720: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00017730: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00017740: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+00017750: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00017760: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00017770: 7473 2e73 7461 7465 2069 6e20 2822 7265  ts.state in ("re
+00017780: 6c65 6173 6564 222c 2022 6572 7265 6422  leased", "erred"
+00017790: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+000177a0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+000177b0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+000177c0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+000177d0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+000177e0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000177f0: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
+00017800: 6575 6564 0a20 2020 2020 2020 2020 2020  eued.           
+00017810: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00017820: 6169 7469 6e67 5f6f 6e2c 2028 7473 2c20  aiting_on, (ts, 
+00017830: 7473 2e77 6169 7469 6e67 5f6f 6e29 0a20  ts.waiting_on). 
+00017840: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00017850: 7420 7473 2e72 756e 5f73 7065 633a 0a20  t ts.run_spec:. 
+00017860: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017870: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
+00017880: 6574 2061 2070 7572 6520 6461 7461 2074  et a pure data t
+00017890: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
+000178a0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+000178b0: 2020 2020 2065 6c69 6620 7473 2e68 6173       elif ts.has
+000178c0: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
+000178d0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000178e0: 2020 2020 2320 4974 2773 206f 6b20 746f      # It's ok to
+000178f0: 2066 6f72 6765 7420 6120 7461 736b 2077   forget a task w
+00017900: 6974 6820 666f 7267 6f74 7465 6e20 6465  ith forgotten de
+00017910: 7065 6e64 656e 6369 6573 0a20 2020 2020  pendencies.     
+00017920: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00017930: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00017940: 206e 6f74 2074 732e 7768 6f5f 7761 6e74   not ts.who_want
+00017950: 7320 616e 6420 6e6f 7420 7473 2e77 6169  s and not ts.wai
+00017960: 7465 7273 2061 6e64 206e 6f74 2074 732e  ters and not ts.
+00017970: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+00017980: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+00017990: 2773 206f 6b20 746f 2066 6f72 6765 7420  's ok to forget 
+000179a0: 6120 7461 736b 2074 6861 7420 6e6f 626f  a task that nobo
+000179b0: 6479 206e 6565 6473 0a20 2020 2020 2020  dy needs.       
+000179c0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+000179d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000179e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179f0: 7261 6973 6520 4173 7365 7274 696f 6e45  raise AssertionE
+00017a00: 7272 6f72 2822 556e 7265 6163 6861 626c  rror("Unreachabl
+00017a10: 6522 2c20 7374 7228 7473 2929 2020 2320  e", str(ts))  # 
+00017a20: 7072 6167 6d61 3a20 6e6f 636f 7665 720a  pragma: nocover.
+00017a30: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00017a40: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00017a50: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
+00017a60: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
+00017a70: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00017a80: 5f70 726f 7061 6761 7465 5f66 6f72 676f  _propagate_forgo
+00017a90: 7474 656e 2874 732c 2072 6563 6f6d 6d65  tten(ts, recomme
+00017aa0: 6e64 6174 696f 6e73 2c20 776f 726b 6572  ndations, worker
+00017ab0: 5f6d 7367 732c 2073 7469 6d75 6c75 735f  _msgs, stimulus_
+00017ac0: 6964 290a 0a20 2020 2020 2020 2063 6c69  id)..        cli
+00017ad0: 656e 745f 6d73 6773 203d 205f 7461 736b  ent_msgs = _task
+00017ae0: 5f74 6f5f 636c 6965 6e74 5f6d 7367 7328  _to_client_msgs(
+00017af0: 7473 290a 2020 2020 2020 2020 7365 6c66  ts).        self
+00017b00: 2e5f 7265 6d6f 7665 5f6b 6579 286b 6579  ._remove_key(key
+00017b10: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00017b20: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+00017b30: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+00017b40: 776f 726b 6572 5f6d 7367 730a 0a20 2020  worker_msgs..   
+00017b50: 2023 207b 0a20 2020 2023 2020 2020 2028   # {.    #     (
+00017b60: 7374 6172 742c 2066 696e 6973 6829 3a0a  start, finish):.
+00017b70: 2020 2020 2320 2020 2020 7472 616e 7369      #     transi
+00017b80: 7469 6f6e 5f3c 7374 6172 743e 5f3c 6669  tion_<start>_<fi
+00017b90: 6e69 7368 3e28 0a20 2020 2023 2020 2020  nish>(.    #    
+00017ba0: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
+00017bb0: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+00017bc0: 3a20 7374 722c 202a 2a6b 7761 7267 730a  : str, **kwargs.
+00017bd0: 2020 2020 2320 2020 2020 2920 2d3e 2028      #     ) -> (
+00017be0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00017bf0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+00017c00: 726b 6572 5f6d 7367 7329 0a20 2020 2023  rker_msgs).    #
+00017c10: 207d 0a20 2020 205f 5452 414e 5349 5449   }.    _TRANSITI
+00017c20: 4f4e 535f 5441 424c 453a 2043 6c61 7373  ONS_TABLE: Class
+00017c30: 5661 725b 0a20 2020 2020 2020 204d 6170  Var[.        Map
+00017c40: 7069 6e67 5b0a 2020 2020 2020 2020 2020  ping[.          
+00017c50: 2020 7475 706c 655b 5461 736b 5374 6174    tuple[TaskStat
+00017c60: 6553 7461 7465 2c20 5461 736b 5374 6174  eState, TaskStat
+00017c70: 6553 7461 7465 5d2c 0a20 2020 2020 2020  eState],.       
+00017c80: 2020 2020 2043 616c 6c61 626c 655b 2e2e       Callable[..
+00017c90: 2e2c 2052 6563 734d 7367 735d 2c0a 2020  ., RecsMsgs],.  
+00017ca0: 2020 2020 2020 5d0a 2020 2020 5d20 3d20        ].    ] = 
+00017cb0: 7b0a 2020 2020 2020 2020 2822 7265 6c65  {.        ("rele
+00017cc0: 6173 6564 222c 2022 7761 6974 696e 6722  ased", "waiting"
+00017cd0: 293a 2074 7261 6e73 6974 696f 6e5f 7265  ): transition_re
+00017ce0: 6c65 6173 6564 5f77 6169 7469 6e67 2c0a  leased_waiting,.
+00017cf0: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
+00017d00: 6722 2c20 2272 656c 6561 7365 6422 293a  g", "released"):
+00017d10: 2074 7261 6e73 6974 696f 6e5f 7761 6974   transition_wait
+00017d20: 696e 675f 7265 6c65 6173 6564 2c0a 2020  ing_released,.  
+00017d30: 2020 2020 2020 2822 7761 6974 696e 6722        ("waiting"
+00017d40: 2c20 2270 726f 6365 7373 696e 6722 293a  , "processing"):
+00017d50: 2074 7261 6e73 6974 696f 6e5f 7761 6974   transition_wait
+00017d60: 696e 675f 7072 6f63 6573 7369 6e67 2c0a  ing_processing,.
+00017d70: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
+00017d80: 6722 2c20 226e 6f2d 776f 726b 6572 2229  g", "no-worker")
+00017d90: 3a20 7472 616e 7369 7469 6f6e 5f77 6169  : transition_wai
+00017da0: 7469 6e67 5f6e 6f5f 776f 726b 6572 2c0a  ting_no_worker,.
+00017db0: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
+00017dc0: 6722 2c20 2271 7565 7565 6422 293a 2074  g", "queued"): t
+00017dd0: 7261 6e73 6974 696f 6e5f 7761 6974 696e  ransition_waitin
+00017de0: 675f 7175 6575 6564 2c0a 2020 2020 2020  g_queued,.      
+00017df0: 2020 2822 7761 6974 696e 6722 2c20 226d    ("waiting", "m
+00017e00: 656d 6f72 7922 293a 2074 7261 6e73 6974  emory"): transit
+00017e10: 696f 6e5f 7761 6974 696e 675f 6d65 6d6f  ion_waiting_memo
+00017e20: 7279 2c0a 2020 2020 2020 2020 2822 7175  ry,.        ("qu
+00017e30: 6575 6564 222c 2022 7265 6c65 6173 6564  eued", "released
+00017e40: 2229 3a20 7472 616e 7369 7469 6f6e 5f71  "): transition_q
+00017e50: 7565 7565 645f 7265 6c65 6173 6564 2c0a  ueued_released,.
+00017e60: 2020 2020 2020 2020 2822 7175 6575 6564          ("queued
+00017e70: 222c 2022 7072 6f63 6573 7369 6e67 2229  ", "processing")
+00017e80: 3a20 7472 616e 7369 7469 6f6e 5f71 7565  : transition_que
+00017e90: 7565 645f 7072 6f63 6573 7369 6e67 2c0a  ued_processing,.
+00017ea0: 2020 2020 2020 2020 2822 7072 6f63 6573          ("proces
+00017eb0: 7369 6e67 222c 2022 7265 6c65 6173 6564  sing", "released
+00017ec0: 2229 3a20 7472 616e 7369 7469 6f6e 5f70  "): transition_p
+00017ed0: 726f 6365 7373 696e 675f 7265 6c65 6173  rocessing_releas
+00017ee0: 6564 2c0a 2020 2020 2020 2020 2822 7072  ed,.        ("pr
+00017ef0: 6f63 6573 7369 6e67 222c 2022 6d65 6d6f  ocessing", "memo
+00017f00: 7279 2229 3a20 7472 616e 7369 7469 6f6e  ry"): transition
+00017f10: 5f70 726f 6365 7373 696e 675f 6d65 6d6f  _processing_memo
+00017f20: 7279 2c0a 2020 2020 2020 2020 2822 7072  ry,.        ("pr
+00017f30: 6f63 6573 7369 6e67 222c 2022 6572 7265  ocessing", "erre
+00017f40: 6422 293a 2074 7261 6e73 6974 696f 6e5f  d"): transition_
+00017f50: 7072 6f63 6573 7369 6e67 5f65 7272 6564  processing_erred
+00017f60: 2c0a 2020 2020 2020 2020 2822 6e6f 2d77  ,.        ("no-w
+00017f70: 6f72 6b65 7222 2c20 2272 656c 6561 7365  orker", "release
+00017f80: 6422 293a 2074 7261 6e73 6974 696f 6e5f  d"): transition_
+00017f90: 6e6f 5f77 6f72 6b65 725f 7265 6c65 6173  no_worker_releas
+00017fa0: 6564 2c0a 2020 2020 2020 2020 2822 6e6f  ed,.        ("no
+00017fb0: 2d77 6f72 6b65 7222 2c20 2270 726f 6365  -worker", "proce
+00017fc0: 7373 696e 6722 293a 2074 7261 6e73 6974  ssing"): transit
+00017fd0: 696f 6e5f 6e6f 5f77 6f72 6b65 725f 7072  ion_no_worker_pr
+00017fe0: 6f63 6573 7369 6e67 2c0a 2020 2020 2020  ocessing,.      
+00017ff0: 2020 2822 7265 6c65 6173 6564 222c 2022    ("released", "
+00018000: 666f 7267 6f74 7465 6e22 293a 2074 7261  forgotten"): tra
+00018010: 6e73 6974 696f 6e5f 7265 6c65 6173 6564  nsition_released
+00018020: 5f66 6f72 676f 7474 656e 2c0a 2020 2020  _forgotten,.    
+00018030: 2020 2020 2822 6d65 6d6f 7279 222c 2022      ("memory", "
+00018040: 666f 7267 6f74 7465 6e22 293a 2074 7261  forgotten"): tra
+00018050: 6e73 6974 696f 6e5f 6d65 6d6f 7279 5f66  nsition_memory_f
+00018060: 6f72 676f 7474 656e 2c0a 2020 2020 2020  orgotten,.      
+00018070: 2020 2822 6572 7265 6422 2c20 2272 656c    ("erred", "rel
+00018080: 6561 7365 6422 293a 2074 7261 6e73 6974  eased"): transit
+00018090: 696f 6e5f 6572 7265 645f 7265 6c65 6173  ion_erred_releas
+000180a0: 6564 2c0a 2020 2020 2020 2020 2822 6d65  ed,.        ("me
+000180b0: 6d6f 7279 222c 2022 7265 6c65 6173 6564  mory", "released
+000180c0: 2229 3a20 7472 616e 7369 7469 6f6e 5f6d  "): transition_m
+000180d0: 656d 6f72 795f 7265 6c65 6173 6564 2c0a  emory_released,.
+000180e0: 2020 2020 2020 2020 2822 7265 6c65 6173          ("releas
+000180f0: 6564 222c 2022 6572 7265 6422 293a 2074  ed", "erred"): t
+00018100: 7261 6e73 6974 696f 6e5f 7265 6c65 6173  ransition_releas
+00018110: 6564 5f65 7272 6564 2c0a 2020 2020 7d0a  ed_erred,.    }.
+00018120: 0a20 2020 2064 6566 2073 746f 7279 2873  .    def story(s
+00018130: 656c 662c 202a 6b65 7973 5f6f 725f 7461  elf, *keys_or_ta
+00018140: 736b 735f 6f72 5f73 7469 6d75 6c69 3a20  sks_or_stimuli: 
+00018150: 7374 7220 7c20 5461 736b 5374 6174 6529  str | TaskState)
+00018160: 202d 3e20 6c69 7374 5b54 7261 6e73 6974   -> list[Transit
+00018170: 696f 6e5d 3a0a 2020 2020 2020 2020 2222  ion]:.        ""
+00018180: 2247 6574 2061 6c6c 2074 7261 6e73 6974  "Get all transit
+00018190: 696f 6e73 2074 6861 7420 746f 7563 6820  ions that touch 
+000181a0: 6f6e 6520 6f66 2074 6865 2069 6e70 7574  one of the input
+000181b0: 206b 6579 7320 6f72 2073 7469 6d75 6c75   keys or stimulu
+000181c0: 735f 6964 2773 2222 220a 2020 2020 2020  s_id's""".      
+000181d0: 2020 6b65 7973 5f6f 725f 7374 696d 756c    keys_or_stimul
+000181e0: 6920 3d20 7b0a 2020 2020 2020 2020 2020  i = {.          
+000181f0: 2020 6b65 792e 6b65 7920 6966 2069 7369    key.key if isi
+00018200: 6e73 7461 6e63 6528 6b65 792c 2054 6173  nstance(key, Tas
+00018210: 6b53 7461 7465 2920 656c 7365 206b 6579  kState) else key
+00018220: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00018230: 206b 6579 2069 6e20 6b65 7973 5f6f 725f   key in keys_or_
+00018240: 7461 736b 735f 6f72 5f73 7469 6d75 6c69  tasks_or_stimuli
+00018250: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00018260: 2020 2072 6574 7572 6e20 7363 6865 6475     return schedu
+00018270: 6c65 725f 7374 6f72 7928 6b65 7973 5f6f  ler_story(keys_o
+00018280: 725f 7374 696d 756c 692c 2073 656c 662e  r_stimuli, self.
+00018290: 7472 616e 7369 7469 6f6e 5f6c 6f67 290a  transition_log).
+000182a0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+000182b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000182c0: 2323 230a 2020 2020 2320 4173 7369 676e  ###.    # Assign
+000182d0: 696e 6720 5461 736b 7320 746f 2057 6f72  ing Tasks to Wor
+000182e0: 6b65 7273 2023 0a20 2020 2023 2323 2323  kers #.    #####
+000182f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018300: 2323 2323 2323 2323 230a 0a20 2020 2064  #########..    d
+00018310: 6566 2069 735f 726f 6f74 6973 6828 7365  ef is_rootish(se
+00018320: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
+00018330: 6529 202d 3e20 626f 6f6c 3a0a 2020 2020  e) -> bool:.    
+00018340: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00018350: 5768 6574 6865 7220 6060 7473 6060 2069  Whether ``ts`` i
+00018360: 7320 6120 726f 6f74 206f 7220 726f 6f74  s a root or root
+00018370: 2d6c 696b 6520 7461 736b 2e0a 0a20 2020  -like task...   
+00018380: 2020 2020 2052 6f6f 742d 6973 6820 7461       Root-ish ta
+00018390: 736b 7320 6172 6520 7061 7274 206f 6620  sks are part of 
+000183a0: 6120 6772 6f75 7020 7468 6174 2773 206d  a group that's m
+000183b0: 7563 6820 6c61 7267 6572 2074 6861 6e20  uch larger than 
+000183c0: 7468 6520 636c 7573 7465 722c 0a20 2020  the cluster,.   
+000183d0: 2020 2020 2061 6e64 2068 6176 6520 6665       and have fe
+000183e0: 7720 6f72 206e 6f20 6465 7065 6e64 656e  w or no dependen
+000183f0: 6369 6573 2e0a 2020 2020 2020 2020 2222  cies..        ""
+00018400: 220a 2020 2020 2020 2020 6966 2074 732e  ".        if ts.
+00018410: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
+00018420: 7469 6f6e 7320 6f72 2074 732e 776f 726b  tions or ts.work
+00018430: 6572 5f72 6573 7472 6963 7469 6f6e 7320  er_restrictions 
+00018440: 6f72 2074 732e 686f 7374 5f72 6573 7472  or ts.host_restr
+00018450: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
+00018460: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+00018470: 650a 2020 2020 2020 2020 7467 203d 2074  e.        tg = t
+00018480: 732e 6772 6f75 700a 2020 2020 2020 2020  s.group.        
+00018490: 2320 544f 444f 2073 686f 7274 2d63 6972  # TODO short-cir
+000184a0: 6375 6974 2074 6f20 5472 7565 2069 6620  cuit to True if 
+000184b0: 606e 6f74 2074 732e 6465 7065 6e64 656e  `not ts.dependen
+000184c0: 6369 6573 603f 0a20 2020 2020 2020 2072  cies`?.        r
+000184d0: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+000184e0: 2020 2020 6c65 6e28 7467 2920 3e20 7365      len(tg) > se
+000184f0: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
+00018500: 7320 2a20 320a 2020 2020 2020 2020 2020  s * 2.          
+00018510: 2020 616e 6420 6c65 6e28 7467 2e64 6570    and len(tg.dep
+00018520: 656e 6465 6e63 6965 7329 203c 2035 0a20  endencies) < 5. 
+00018530: 2020 2020 2020 2020 2020 2061 6e64 2073             and s
+00018540: 756d 286d 6170 286c 656e 2c20 7467 2e64  um(map(len, tg.d
+00018550: 6570 656e 6465 6e63 6965 7329 2920 3c20  ependencies)) < 
+00018560: 350a 2020 2020 2020 2020 290a 0a20 2020  5.        )..   
+00018570: 2064 6566 2063 6865 636b 5f69 646c 655f   def check_idle_
+00018580: 7361 7475 7261 7465 6428 7365 6c66 2c20  saturated(self, 
+00018590: 7773 3a20 576f 726b 6572 5374 6174 652c  ws: WorkerState,
+000185a0: 206f 6363 3a20 666c 6f61 7420 3d20 2d31   occ: float = -1
+000185b0: 2e30 2920 2d3e 204e 6f6e 653a 0a20 2020  .0) -> None:.   
+000185c0: 2020 2020 2022 2222 5570 6461 7465 2074       """Update t
+000185d0: 6865 2073 7461 7475 7320 6f66 2074 6865  he status of the
+000185e0: 2069 646c 6520 616e 6420 7361 7475 7261   idle and satura
+000185f0: 7465 6420 7374 6174 650a 0a20 2020 2020  ted state..     
+00018600: 2020 2054 6865 2073 6368 6564 756c 6572     The scheduler
+00018610: 206b 6565 7073 2074 7261 636b 206f 6620   keeps track of 
+00018620: 776f 726b 6572 7320 7468 6174 2061 7265  workers that are
+00018630: 202e 2e0a 0a20 2020 2020 2020 202d 2020   ....        -  
+00018640: 5361 7475 7261 7465 643a 2068 6176 6520  Saturated: have 
+00018650: 656e 6f75 6768 2077 6f72 6b20 746f 2073  enough work to s
+00018660: 7461 7920 6275 7379 0a20 2020 2020 2020  tay busy.       
+00018670: 202d 2020 4964 6c65 3a20 646f 206e 6f74   -  Idle: do not
+00018680: 2068 6176 6520 656e 6f75 6768 2077 6f72   have enough wor
+00018690: 6b20 746f 2073 7461 7920 6275 7379 0a0a  k to stay busy..
+000186a0: 2020 2020 2020 2020 5468 6579 2061 7265          They are
+000186b0: 2063 6f6e 7369 6465 7265 6420 7361 7475   considered satu
+000186c0: 7261 7465 6420 6966 2074 6865 7920 626f  rated if they bo
+000186d0: 7468 2068 6176 6520 656e 6f75 6768 2074  th have enough t
+000186e0: 6173 6b73 2074 6f20 6f63 6375 7079 0a20  asks to occupy. 
+000186f0: 2020 2020 2020 2061 6c6c 206f 6620 7468         all of th
+00018700: 6569 7220 7468 7265 6164 732c 2061 6e64  eir threads, and
+00018710: 2069 6620 7468 6520 6578 7065 6374 6564   if the expected
+00018720: 2072 756e 7469 6d65 206f 6620 7468 6f73   runtime of thos
+00018730: 6520 7461 736b 7320 6973 0a20 2020 2020  e tasks is.     
+00018740: 2020 206c 6172 6765 2065 6e6f 7567 682e     large enough.
+00018750: 0a0a 2020 2020 2020 2020 4966 2060 6064  ..        If ``d
+00018760: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+00018770: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
+00018780: 7261 7469 6f6e 6060 2069 7320 6e6f 7420  ration`` is not 
+00018790: 6060 696e 6660 600a 2020 2020 2020 2020  ``inf``.        
+000187a0: 2873 6368 6564 756c 6572 2d73 6964 6520  (scheduler-side 
+000187b0: 7175 6575 696e 6720 6973 2065 6e61 626c  queuing is enabl
+000187c0: 6564 292c 2074 6865 7920 6172 6520 636f  ed), they are co
+000187d0: 6e73 6964 6572 6564 2069 646c 650a 2020  nsidered idle.  
+000187e0: 2020 2020 2020 6966 2074 6865 7920 6861        if they ha
+000187f0: 7665 2066 6577 6572 2074 6173 6b73 2070  ve fewer tasks p
+00018800: 726f 6365 7373 696e 6720 7468 616e 2074  rocessing than t
+00018810: 6865 2060 6077 6f72 6b65 722d 7361 7475  he ``worker-satu
+00018820: 7261 7469 6f6e 6060 0a20 2020 2020 2020  ration``.       
+00018830: 2074 6872 6573 686f 6c64 2064 6963 7461   threshold dicta
+00018840: 7465 732e 0a0a 2020 2020 2020 2020 4f74  tes...        Ot
+00018850: 6865 7277 6973 652c 2074 6865 7920 6172  herwise, they ar
+00018860: 6520 636f 6e73 6964 6572 6564 2069 646c  e considered idl
+00018870: 6520 6966 2074 6865 7920 6861 7665 2066  e if they have f
+00018880: 6577 6572 2074 6173 6b73 2070 726f 6365  ewer tasks proce
+00018890: 7373 696e 670a 2020 2020 2020 2020 7468  ssing.        th
+000188a0: 616e 2074 6872 6561 6473 2c20 6f72 2069  an threads, or i
+000188b0: 6620 7468 6569 7220 7461 736b 7327 2074  f their tasks' t
+000188c0: 6f74 616c 2065 7870 6563 7465 6420 7275  otal expected ru
+000188d0: 6e74 696d 6520 6973 206c 6573 7320 7468  ntime is less th
+000188e0: 616e 2068 616c 660a 2020 2020 2020 2020  an half.        
+000188f0: 7468 6520 6578 7065 6374 6564 2072 756e  the expected run
+00018900: 7469 6d65 206f 6620 7468 6520 7361 6d65  time of the same
+00018910: 206e 756d 6265 7220 6f66 2061 7665 7261   number of avera
+00018920: 6765 2074 6173 6b73 2e0a 0a20 2020 2020  ge tasks...     
+00018930: 2020 2054 6869 7320 6973 2075 7365 6675     This is usefu
+00018940: 6c20 666f 7220 6c6f 6164 2062 616c 616e  l for load balan
+00018950: 6369 6e67 2061 6e64 2061 6461 7074 6976  cing and adaptiv
+00018960: 6974 792e 0a20 2020 2020 2020 2022 2222  ity..        """
+00018970: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00018980: 2e74 6f74 616c 5f6e 7468 7265 6164 7320  .total_nthreads 
+00018990: 3d3d 2030 206f 7220 7773 2e73 7461 7475  == 0 or ws.statu
+000189a0: 7320 3d3d 2053 7461 7475 732e 636c 6f73  s == Status.clos
+000189b0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+000189c0: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
+000189d0: 6620 6f63 6320 3c20 303a 0a20 2020 2020  f occ < 0:.     
+000189e0: 2020 2020 2020 206f 6363 203d 2077 732e         occ = ws.
+000189f0: 6f63 6375 7061 6e63 790a 0a20 2020 2020  occupancy..     
+00018a00: 2020 2070 203d 206c 656e 2877 732e 7072     p = len(ws.pr
+00018a10: 6f63 6573 7369 6e67 290a 0a20 2020 2020  ocessing)..     
+00018a20: 2020 2073 656c 662e 7361 7475 7261 7465     self.saturate
+00018a30: 642e 6469 7363 6172 6428 7773 290a 2020  d.discard(ws).  
+00018a40: 2020 2020 2020 6966 2077 732e 7374 6174        if ws.stat
+00018a50: 7573 2021 3d20 5374 6174 7573 2e72 756e  us != Status.run
+00018a60: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+00018a70: 2020 7365 6c66 2e69 646c 652e 706f 7028    self.idle.pop(
+00018a80: 7773 2e61 6464 7265 7373 2c20 4e6f 6e65  ws.address, None
+00018a90: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
+00018aa0: 656c 662e 6973 5f75 6e6f 6363 7570 6965  elf.is_unoccupie
+00018ab0: 6428 7773 2c20 6f63 632c 2070 293a 0a20  d(ws, occ, p):. 
+00018ac0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00018ad0: 6964 6c65 5b77 732e 6164 6472 6573 735d  idle[ws.address]
+00018ae0: 203d 2077 730a 2020 2020 2020 2020 656c   = ws.        el
+00018af0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00018b00: 7365 6c66 2e69 646c 652e 706f 7028 7773  self.idle.pop(ws
+00018b10: 2e61 6464 7265 7373 2c20 4e6f 6e65 290a  .address, None).
+00018b20: 2020 2020 2020 2020 2020 2020 6e63 203d              nc =
+00018b30: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
+00018b40: 2020 2020 2020 2020 2069 6620 7020 3e20           if p > 
+00018b50: 6e63 3a0a 2020 2020 2020 2020 2020 2020  nc:.            
+00018b60: 2020 2020 7065 6e64 696e 6720 3d20 6f63      pending = oc
+00018b70: 6320 2a20 2870 202d 206e 6329 202f 2028  c * (p - nc) / (
+00018b80: 7020 2a20 6e63 290a 2020 2020 2020 2020  p * nc).        
+00018b90: 2020 2020 2020 2020 6966 2030 2e34 203c          if 0.4 <
+00018ba0: 2070 656e 6469 6e67 203e 2031 2e39 202a   pending > 1.9 *
+00018bb0: 2028 7365 6c66 2e74 6f74 616c 5f6f 6363   (self.total_occ
+00018bc0: 7570 616e 6379 202f 2073 656c 662e 746f  upancy / self.to
+00018bd0: 7461 6c5f 6e74 6872 6561 6473 293a 0a20  tal_nthreads):. 
+00018be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018bf0: 2020 2073 656c 662e 7361 7475 7261 7465     self.saturate
+00018c00: 642e 6164 6428 7773 290a 0a20 2020 2020  d.add(ws)..     
+00018c10: 2020 2069 6620 6e6f 7420 5f77 6f72 6b65     if not _worke
+00018c20: 725f 6675 6c6c 2877 732c 2073 656c 662e  r_full(ws, self.
+00018c30: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
+00018c40: 4e29 2061 6e64 2077 732e 7374 6174 7573  N) and ws.status
+00018c50: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+00018c60: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00018c70: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
+00018c80: 6f75 6e74 2e61 6464 2877 7329 0a20 2020  ount.add(ws).   
+00018c90: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00018ca0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00018cb0: 5f74 6173 6b5f 636f 756e 742e 6469 7363  _task_count.disc
+00018cc0: 6172 6428 7773 290a 0a20 2020 2064 6566  ard(ws)..    def
+00018cd0: 2069 735f 756e 6f63 6375 7069 6564 280a   is_unoccupied(.
+00018ce0: 2020 2020 2020 2020 7365 6c66 2c20 7773          self, ws
+00018cf0: 3a20 576f 726b 6572 5374 6174 652c 206f  : WorkerState, o
+00018d00: 6363 7570 616e 6379 3a20 666c 6f61 742c  ccupancy: float,
+00018d10: 206e 7072 6f63 6573 7369 6e67 3a20 696e   nprocessing: in
+00018d20: 740a 2020 2020 2920 2d3e 2062 6f6f 6c3a  t.    ) -> bool:
+00018d30: 0a20 2020 2020 2020 206e 7468 7265 6164  .        nthread
+00018d40: 7320 3d20 7773 2e6e 7468 7265 6164 730a  s = ws.nthreads.
+00018d50: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+00018d60: 0a20 2020 2020 2020 2020 2020 206e 7072  .            npr
+00018d70: 6f63 6573 7369 6e67 203c 206e 7468 7265  ocessing < nthre
+00018d80: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
+00018d90: 6f72 206f 6363 7570 616e 6379 203c 206e  or occupancy < n
+00018da0: 7468 7265 6164 7320 2a20 2873 656c 662e  threads * (self.
+00018db0: 746f 7461 6c5f 6f63 6375 7061 6e63 7920  total_occupancy 
+00018dc0: 2f20 7365 6c66 2e74 6f74 616c 5f6e 7468  / self.total_nth
+00018dd0: 7265 6164 7329 202f 2032 0a20 2020 2020  reads) / 2.     
+00018de0: 2020 2029 0a0a 2020 2020 6465 6620 6765     )..    def ge
+00018df0: 745f 636f 6d6d 5f63 6f73 7428 7365 6c66  t_comm_cost(self
+00018e00: 2c20 7473 3a20 5461 736b 5374 6174 652c  , ts: TaskState,
+00018e10: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
+00018e20: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+00018e30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00018e40: 4765 7420 7468 6520 6573 7469 6d61 7465  Get the estimate
+00018e50: 6420 636f 6d6d 756e 6963 6174 696f 6e20  d communication 
+00018e60: 636f 7374 2028 696e 2073 2e29 2074 6f20  cost (in s.) to 
+00018e70: 636f 6d70 7574 6520 7468 6520 7461 736b  compute the task
+00018e80: 0a20 2020 2020 2020 206f 6e20 7468 6520  .        on the 
+00018e90: 6769 7665 6e20 776f 726b 6572 2e0a 2020  given worker..  
+00018ea0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00018eb0: 2020 6966 2031 3020 2a20 6c65 6e28 7473    if 10 * len(ts
+00018ec0: 2e64 6570 656e 6465 6e63 6965 7329 203c  .dependencies) <
+00018ed0: 206c 656e 2877 732e 6861 735f 7768 6174   len(ws.has_what
+00018ee0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+00018ef0: 2049 6e20 7468 6520 636f 6d6d 6f6e 2063   In the common c
+00018f00: 6173 6520 7768 6572 6520 7468 6520 6e75  ase where the nu
+00018f10: 6d62 6572 206f 6620 6465 7065 6e64 656e  mber of dependen
+00018f20: 6369 6573 2069 730a 2020 2020 2020 2020  cies is.        
+00018f30: 2020 2020 2320 6d75 6368 206c 6573 7320      # much less 
+00018f40: 7468 616e 2074 6865 206e 756d 6265 7220  than the number 
+00018f50: 6f66 2074 6173 6b73 2074 6861 7420 7765  of tasks that we
+00018f60: 2068 6176 652c 0a20 2020 2020 2020 2020   have,.         
+00018f70: 2020 2023 2063 6f6e 7374 7275 6374 2074     # construct t
+00018f80: 6865 2073 6574 206f 6620 6465 7073 2074  he set of deps t
+00018f90: 6861 7420 7265 7175 6972 6520 636f 6d6d  hat require comm
+00018fa0: 756e 6963 6174 696f 6e20 696e 0a20 2020  unication in.   
+00018fb0: 2020 2020 2020 2020 2023 204f 286c 656e           # O(len
+00018fc0: 2864 6570 656e 6465 6e63 6965 7329 2920  (dependencies)) 
+00018fd0: 7261 7468 6572 2074 6861 6e20 4f28 6c65  rather than O(le
+00018fe0: 6e28 6861 735f 7768 6174 2929 2074 696d  n(has_what)) tim
+00018ff0: 652e 0a20 2020 2020 2020 2020 2020 2023  e..            #
+00019000: 2046 6163 746f 7220 6f66 2031 3020 6973   Factor of 10 is
+00019010: 2061 2067 7565 7373 2061 7420 7468 6520   a guess at the 
+00019020: 6f76 6572 6865 6164 206f 6620 6578 706c  overhead of expl
+00019030: 6963 6974 0a20 2020 2020 2020 2020 2020  icit.           
+00019040: 2023 2069 7465 7261 7469 6f6e 2061 7320   # iteration as 
+00019050: 6f70 706f 7365 6420 746f 206a 7573 7420  opposed to just 
+00019060: 6361 6c6c 696e 6720 7365 742e 6469 6666  calling set.diff
+00019070: 6572 656e 6365 0a20 2020 2020 2020 2020  erence.         
+00019080: 2020 2064 6570 7320 3d20 7b64 6570 2066     deps = {dep f
+00019090: 6f72 2064 6570 2069 6e20 7473 2e64 6570  or dep in ts.dep
+000190a0: 656e 6465 6e63 6965 7320 6966 2064 6570  endencies if dep
+000190b0: 206e 6f74 2069 6e20 7773 2e68 6173 5f77   not in ws.has_w
+000190c0: 6861 747d 0a20 2020 2020 2020 2065 6c73  hat}.        els
+000190d0: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+000190e0: 6570 7320 3d20 7473 2e64 6570 656e 6465  eps = ts.depende
+000190f0: 6e63 6965 732e 6469 6666 6572 656e 6365  ncies.difference
+00019100: 2877 732e 6861 735f 7768 6174 290a 2020  (ws.has_what).  
+00019110: 2020 2020 2020 6e62 7974 6573 203d 2073        nbytes = s
+00019120: 756d 2864 7473 2e6e 6279 7465 7320 666f  um(dts.nbytes fo
+00019130: 7220 6474 7320 696e 2064 6570 7329 0a20  r dts in deps). 
+00019140: 2020 2020 2020 2072 6574 7572 6e20 6e62         return nb
+00019150: 7974 6573 202f 2073 656c 662e 6261 6e64  ytes / self.band
+00019160: 7769 6474 680a 0a20 2020 2064 6566 2067  width..    def g
+00019170: 6574 5f74 6173 6b5f 6475 7261 7469 6f6e  et_task_duration
+00019180: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
+00019190: 7461 7465 2920 2d3e 2066 6c6f 6174 3a0a  tate) -> float:.
+000191a0: 2020 2020 2020 2020 2222 2247 6574 2074          """Get t
+000191b0: 6865 2065 7374 696d 6174 6564 2063 6f6d  he estimated com
+000191c0: 7075 7461 7469 6f6e 2063 6f73 7420 6f66  putation cost of
+000191d0: 2074 6865 2067 6976 656e 2074 6173 6b20   the given task 
+000191e0: 286e 6f74 2069 6e63 6c75 6469 6e67 0a20  (not including. 
+000191f0: 2020 2020 2020 2061 6e79 2063 6f6d 6d75         any commu
+00019200: 6e69 6361 7469 6f6e 2063 6f73 7429 2e0a  nication cost)..
+00019210: 0a20 2020 2020 2020 2049 6620 6e6f 2064  .        If no d
+00019220: 6174 6120 6861 7320 6265 656e 206f 6273  ata has been obs
+00019230: 6572 7665 642c 2076 616c 7565 206f 660a  erved, value of.
+00019240: 2020 2020 2020 2020 6064 6973 7472 6962          `distrib
+00019250: 7574 6564 2e73 6368 6564 756c 6572 2e64  uted.scheduler.d
+00019260: 6566 6175 6c74 2d74 6173 6b2d 6475 7261  efault-task-dura
+00019270: 7469 6f6e 7360 2061 7265 2075 7365 642e  tions` are used.
+00019280: 2049 6620 6e6f 6e65 2069 7320 7365 740a   If none is set.
+00019290: 2020 2020 2020 2020 666f 7220 7468 6973          for this
+000192a0: 2074 6173 6b2c 2060 6469 7374 7269 6275   task, `distribu
+000192b0: 7465 642e 7363 6865 6475 6c65 722e 756e  ted.scheduler.un
+000192c0: 6b6e 6f77 6e2d 7461 736b 2d64 7572 6174  known-task-durat
+000192d0: 696f 6e60 2069 7320 7573 6564 0a20 2020  ion` is used.   
+000192e0: 2020 2020 2069 6e73 7465 6164 2e0a 2020       instead..  
+000192f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00019300: 2020 6475 7261 7469 6f6e 3a20 666c 6f61    duration: floa
+00019310: 7420 3d20 7473 2e70 7265 6669 782e 6475  t = ts.prefix.du
+00019320: 7261 7469 6f6e 5f61 7665 7261 6765 0a20  ration_average. 
+00019330: 2020 2020 2020 2069 6620 6475 7261 7469         if durati
+00019340: 6f6e 203e 3d20 303a 0a20 2020 2020 2020  on >= 0:.       
+00019350: 2020 2020 2072 6574 7572 6e20 6475 7261       return dura
+00019360: 7469 6f6e 0a0a 2020 2020 2020 2020 7320  tion..        s 
+00019370: 3d20 7365 6c66 2e75 6e6b 6e6f 776e 5f64  = self.unknown_d
+00019380: 7572 6174 696f 6e73 2e67 6574 2874 732e  urations.get(ts.
+00019390: 7072 6566 6978 2e6e 616d 6529 0a20 2020  prefix.name).   
+000193a0: 2020 2020 2069 6620 7320 6973 204e 6f6e       if s is Non
+000193b0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000193c0: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
+000193d0: 7469 6f6e 735b 7473 2e70 7265 6669 782e  tions[ts.prefix.
+000193e0: 6e61 6d65 5d20 3d20 7320 3d20 7365 7428  name] = s = set(
+000193f0: 290a 2020 2020 2020 2020 732e 6164 6428  ).        s.add(
+00019400: 7473 290a 2020 2020 2020 2020 7265 7475  ts).        retu
+00019410: 726e 2073 656c 662e 554e 4b4e 4f57 4e5f  rn self.UNKNOWN_
+00019420: 5441 534b 5f44 5552 4154 494f 4e0a 0a20  TASK_DURATION.. 
+00019430: 2020 2064 6566 2076 616c 6964 5f77 6f72     def valid_wor
+00019440: 6b65 7273 2873 656c 662c 2074 733a 2054  kers(self, ts: T
+00019450: 6173 6b53 7461 7465 2920 2d3e 2073 6574  askState) -> set
+00019460: 5b57 6f72 6b65 7253 7461 7465 5d20 7c20  [WorkerState] | 
+00019470: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+00019480: 2252 6574 7572 6e20 7365 7420 6f66 2063  "Return set of c
+00019490: 7572 7265 6e74 6c79 2076 616c 6964 2077  urrently valid w
+000194a0: 6f72 6b65 7273 2066 6f72 206b 6579 0a0a  orkers for key..
+000194b0: 2020 2020 2020 2020 4966 2061 6c6c 2077          If all w
+000194c0: 6f72 6b65 7273 2061 7265 2076 616c 6964  orkers are valid
+000194d0: 2074 6865 6e20 7468 6973 2072 6574 7572   then this retur
+000194e0: 6e73 2060 604e 6f6e 6560 602c 2069 6e20  ns ``None``, in 
+000194f0: 7768 6963 6820 6361 7365 0a20 2020 2020  which case.     
+00019500: 2020 2061 6e79 202a 7275 6e6e 696e 672a     any *running*
+00019510: 2077 6f72 6b65 7220 6361 6e20 6265 2075   worker can be u
+00019520: 7365 642e 0a20 2020 2020 2020 204f 7468  sed..        Oth
+00019530: 6572 7769 7365 2c20 7468 6520 7375 6273  erwise, the subs
+00019540: 6574 206f 6620 7275 6e6e 696e 6720 776f  et of running wo
+00019550: 726b 6572 7320 7661 6c69 6420 666f 7220  rkers valid for 
+00019560: 7468 6973 2074 6173 6b0a 2020 2020 2020  this task.      
+00019570: 2020 6973 2072 6574 7572 6e65 642e 0a20    is returned.. 
+00019580: 2020 2020 2020 2054 6869 7320 6368 6563         This chec
+00019590: 6b73 2074 7261 636b 7320 7468 6520 666f  ks tracks the fo
+000195a0: 6c6c 6f77 696e 6720 7374 6174 653a 0a0a  llowing state:..
+000195b0: 2020 2020 2020 2020 2a20 2077 6f72 6b65          *  worke
+000195c0: 725f 7265 7374 7269 6374 696f 6e73 0a20  r_restrictions. 
+000195d0: 2020 2020 2020 202a 2020 686f 7374 5f72         *  host_r
+000195e0: 6573 7472 6963 7469 6f6e 730a 2020 2020  estrictions.    
+000195f0: 2020 2020 2a20 2072 6573 6f75 7263 655f      *  resource_
+00019600: 7265 7374 7269 6374 696f 6e73 0a20 2020  restrictions.   
+00019610: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00019620: 2073 3a20 7365 745b 7374 725d 207c 204e   s: set[str] | N
+00019630: 6f6e 6520 3d20 4e6f 6e65 0a0a 2020 2020  one = None..    
+00019640: 2020 2020 6966 2074 732e 776f 726b 6572      if ts.worker
+00019650: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
+00019660: 2020 2020 2020 2020 2020 2073 203d 207b             s = {
+00019670: 6164 6472 2066 6f72 2061 6464 7220 696e  addr for addr in
+00019680: 2074 732e 776f 726b 6572 5f72 6573 7472   ts.worker_restr
+00019690: 6963 7469 6f6e 7320 6966 2061 6464 7220  ictions if addr 
+000196a0: 696e 2073 656c 662e 776f 726b 6572 737d  in self.workers}
+000196b0: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
+000196c0: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
+000196d0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
+000196e0: 2052 6573 6f6c 7665 2074 6865 2061 6c69   Resolve the ali
+000196f0: 6173 2068 6572 6520 7261 7468 6572 2074  as here rather t
+00019700: 6861 6e20 6561 726c 792c 2066 6f72 2074  han early, for t
+00019710: 6865 2077 6f72 6b65 720a 2020 2020 2020  he worker.      
+00019720: 2020 2020 2020 2320 6d61 7920 6e6f 7420        # may not 
+00019730: 6265 2063 6f6e 6e65 6374 6564 2077 6865  be connected whe
+00019740: 6e20 686f 7374 5f72 6573 7472 6963 7469  n host_restricti
+00019750: 6f6e 7320 6973 2070 6f70 756c 6174 6564  ons is populated
+00019760: 0a20 2020 2020 2020 2020 2020 2068 7220  .            hr 
+00019770: 3d20 5b73 656c 662e 636f 6572 6365 5f68  = [self.coerce_h
+00019780: 6f73 746e 616d 6528 6829 2066 6f72 2068  ostname(h) for h
+00019790: 2069 6e20 7473 2e68 6f73 745f 7265 7374   in ts.host_rest
+000197a0: 7269 6374 696f 6e73 5d0a 2020 2020 2020  rictions].      
+000197b0: 2020 2020 2020 2320 5858 5820 6e65 6564        # XXX need
+000197c0: 2048 6f73 7453 7461 7465 3f0a 2020 2020   HostState?.    
+000197d0: 2020 2020 2020 2020 736c 203d 205b 5d0a          sl = [].
+000197e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000197f0: 6820 696e 2068 723a 0a20 2020 2020 2020  h in hr:.       
+00019800: 2020 2020 2020 2020 2064 6820 3d20 7365           dh = se
+00019810: 6c66 2e68 6f73 745f 696e 666f 2e67 6574  lf.host_info.get
+00019820: 2868 290a 2020 2020 2020 2020 2020 2020  (h).            
+00019830: 2020 2020 6966 2064 6820 6973 206e 6f74      if dh is not
+00019840: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00019850: 2020 2020 2020 2020 2020 2073 6c2e 6170             sl.ap
+00019860: 7065 6e64 2864 685b 2261 6464 7265 7373  pend(dh["address
+00019870: 6573 225d 290a 0a20 2020 2020 2020 2020  es"])..         
+00019880: 2020 2073 7320 3d20 7365 742e 756e 696f     ss = set.unio
+00019890: 6e28 2a73 6c29 2069 6620 736c 2065 6c73  n(*sl) if sl els
+000198a0: 6520 7365 7428 290a 2020 2020 2020 2020  e set().        
+000198b0: 2020 2020 6966 2073 2069 7320 4e6f 6e65      if s is None
+000198c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000198d0: 2020 7320 3d20 7373 0a20 2020 2020 2020    s = ss.       
+000198e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000198f0: 2020 2020 2020 2020 2020 2073 207c 3d20             s |= 
+00019900: 7373 0a0a 2020 2020 2020 2020 6966 2074  ss..        if t
+00019910: 732e 7265 736f 7572 6365 5f72 6573 7472  s.resource_restr
+00019920: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
+00019930: 2020 2020 2064 7720 3d20 7b7d 0a20 2020       dw = {}.   
+00019940: 2020 2020 2020 2020 2066 6f72 2072 6573           for res
+00019950: 6f75 7263 652c 2072 6571 7569 7265 6420  ource, required 
+00019960: 696e 2074 732e 7265 736f 7572 6365 5f72  in ts.resource_r
+00019970: 6573 7472 6963 7469 6f6e 732e 6974 656d  estrictions.item
+00019980: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00019990: 2020 2020 2064 7220 3d20 7365 6c66 2e72       dr = self.r
+000199a0: 6573 6f75 7263 6573 2e67 6574 2872 6573  esources.get(res
+000199b0: 6f75 7263 6529 0a20 2020 2020 2020 2020  ource).         
+000199c0: 2020 2020 2020 2069 6620 6472 2069 7320         if dr is 
+000199d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000199e0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+000199f0: 6573 6f75 7263 6573 5b72 6573 6f75 7263  esources[resourc
+00019a00: 655d 203d 2064 7220 3d20 7b7d 0a0a 2020  e] = dr = {}..  
+00019a10: 2020 2020 2020 2020 2020 2020 2020 7377                sw
+00019a20: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+00019a30: 2020 2020 2020 2020 2066 6f72 2061 6464           for add
+00019a40: 722c 2073 7570 706c 6965 6420 696e 2064  r, supplied in d
+00019a50: 722e 6974 656d 7328 293a 0a20 2020 2020  r.items():.     
+00019a60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00019a70: 6620 7375 7070 6c69 6564 203e 3d20 7265  f supplied >= re
+00019a80: 7175 6972 6564 3a0a 2020 2020 2020 2020  quired:.        
+00019a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019aa0: 7377 2e61 6464 2861 6464 7229 0a0a 2020  sw.add(addr)..  
+00019ab0: 2020 2020 2020 2020 2020 2020 2020 6477                dw
+00019ac0: 5b72 6573 6f75 7263 655d 203d 2073 770a  [resource] = sw.
+00019ad0: 0a20 2020 2020 2020 2020 2020 2077 7720  .            ww 
+00019ae0: 3d20 7365 742e 696e 7465 7273 6563 7469  = set.intersecti
+00019af0: 6f6e 282a 6477 2e76 616c 7565 7328 2929  on(*dw.values())
+00019b00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00019b10: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00019b20: 2020 2020 2020 2020 2020 2073 203d 2077             s = w
+00019b30: 770a 2020 2020 2020 2020 2020 2020 656c  w.            el
+00019b40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00019b50: 2020 2020 7320 263d 2077 770a 0a20 2020      s &= ww..   
+00019b60: 2020 2020 2069 6620 7320 6973 204e 6f6e       if s is Non
+00019b70: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00019b80: 6574 7572 6e20 4e6f 6e65 2020 2320 416c  eturn None  # Al
+00019b90: 6c20 776f 726b 6572 7320 6172 6520 7661  l workers are va
+00019ba0: 6c69 640a 2020 2020 2020 2020 6966 206e  lid.        if n
+00019bb0: 6f74 2073 3a0a 2020 2020 2020 2020 2020  ot s:.          
+00019bc0: 2020 7265 7475 726e 2073 6574 2829 2020    return set()  
+00019bd0: 2320 4e6f 2077 6f72 6b65 7273 2061 7265  # No workers are
+00019be0: 2076 616c 6964 0a0a 2020 2020 2020 2020   valid..        
+00019bf0: 2320 536f 6d65 2077 6f72 6b65 7273 2061  # Some workers a
+00019c00: 7265 2076 616c 6964 0a20 2020 2020 2020  re valid.       
+00019c10: 2073 5f77 7320 3d20 7b73 656c 662e 776f   s_ws = {self.wo
+00019c20: 726b 6572 735b 6164 6472 5d20 666f 7220  rkers[addr] for 
+00019c30: 6164 6472 2069 6e20 737d 0a20 2020 2020  addr in s}.     
+00019c40: 2020 2069 6620 6c65 6e28 7365 6c66 2e72     if len(self.r
+00019c50: 756e 6e69 6e67 2920 3c20 6c65 6e28 7365  unning) < len(se
+00019c60: 6c66 2e77 6f72 6b65 7273 293a 0a20 2020  lf.workers):.   
+00019c70: 2020 2020 2020 2020 2073 5f77 7320 263d           s_ws &=
+00019c80: 2073 656c 662e 7275 6e6e 696e 670a 2020   self.running.  
+00019c90: 2020 2020 2020 7265 7475 726e 2073 5f77        return s_w
+00019ca0: 730a 0a20 2020 2064 6566 2061 6371 7569  s..    def acqui
+00019cb0: 7265 5f72 6573 6f75 7263 6573 2873 656c  re_resources(sel
+00019cc0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+00019cd0: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
+00019ce0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+00019cf0: 2020 2020 666f 7220 722c 2072 6571 7569      for r, requi
+00019d00: 7265 6420 696e 2074 732e 7265 736f 7572  red in ts.resour
+00019d10: 6365 5f72 6573 7472 6963 7469 6f6e 732e  ce_restrictions.
+00019d20: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00019d30: 2020 2020 2077 732e 7573 6564 5f72 6573       ws.used_res
+00019d40: 6f75 7263 6573 5b72 5d20 2b3d 2072 6571  ources[r] += req
+00019d50: 7569 7265 640a 0a20 2020 2064 6566 2072  uired..    def r
+00019d60: 656c 6561 7365 5f72 6573 6f75 7263 6573  elease_resources
+00019d70: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
+00019d80: 7461 7465 2c20 7773 3a20 576f 726b 6572  tate, ws: Worker
+00019d90: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00019da0: 2020 2020 2020 2020 666f 7220 722c 2072          for r, r
+00019db0: 6571 7569 7265 6420 696e 2074 732e 7265  equired in ts.re
+00019dc0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
+00019dd0: 6f6e 732e 6974 656d 7328 293a 0a20 2020  ons.items():.   
+00019de0: 2020 2020 2020 2020 2077 732e 7573 6564           ws.used
+00019df0: 5f72 6573 6f75 7263 6573 5b72 5d20 2d3d  _resources[r] -=
+00019e00: 2072 6571 7569 7265 640a 0a20 2020 2064   required..    d
+00019e10: 6566 2063 6f65 7263 655f 686f 7374 6e61  ef coerce_hostna
+00019e20: 6d65 2873 656c 662c 2068 6f73 743a 2048  me(self, host: H
+00019e30: 6173 6861 626c 6529 202d 3e20 7374 723a  ashable) -> str:
+00019e40: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00019e50: 2020 2020 2043 6f65 7263 6520 7468 6520       Coerce the 
+00019e60: 686f 7374 6e61 6d65 206f 6620 6120 776f  hostname of a wo
+00019e70: 726b 6572 2e0a 2020 2020 2020 2020 2222  rker..        ""
+00019e80: 220a 2020 2020 2020 2020 616c 6961 7320  ".        alias 
+00019e90: 3d20 7365 6c66 2e61 6c69 6173 6573 2e67  = self.aliases.g
+00019ea0: 6574 2868 6f73 7429 0a20 2020 2020 2020  et(host).       
+00019eb0: 2069 6620 616c 6961 7320 6973 206e 6f74   if alias is not
+00019ec0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00019ed0: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
+00019ee0: 6b65 7273 5b61 6c69 6173 5d0a 2020 2020  kers[alias].    
+00019ef0: 2020 2020 2020 2020 7265 7475 726e 2077          return w
+00019f00: 732e 686f 7374 0a20 2020 2020 2020 2065  s.host.        e
+00019f10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00019f20: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+00019f30: 6365 2868 6f73 742c 2073 7472 290a 2020  ce(host, str).  
+00019f40: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00019f50: 2068 6f73 740a 0a20 2020 2064 6566 2077   host..    def w
+00019f60: 6f72 6b65 725f 6f62 6a65 6374 6976 6528  orker_objective(
+00019f70: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+00019f80: 6174 652c 2077 733a 2057 6f72 6b65 7253  ate, ws: WorkerS
+00019f90: 7461 7465 2920 2d3e 2074 7570 6c65 3a0a  tate) -> tuple:.
+00019fa0: 2020 2020 2020 2020 2222 224f 626a 6563          """Objec
+00019fb0: 7469 7665 2066 756e 6374 696f 6e20 746f  tive function to
+00019fc0: 2064 6574 6572 6d69 6e65 2077 6869 6368   determine which
+00019fd0: 2077 6f72 6b65 7220 7368 6f75 6c64 2067   worker should g
+00019fe0: 6574 2074 6865 2074 6173 6b0a 0a20 2020  et the task..   
+00019ff0: 2020 2020 204d 696e 696d 697a 6520 6578       Minimize ex
+0001a000: 7065 6374 6564 2073 7461 7274 2074 696d  pected start tim
+0001a010: 652e 2020 4966 2061 2074 6965 2074 6865  e.  If a tie the
+0001a020: 6e20 6272 6561 6b20 7769 7468 2064 6174  n break with dat
+0001a030: 6120 7374 6f72 6167 652e 0a20 2020 2020  a storage..     
+0001a040: 2020 2022 2222 0a20 2020 2020 2020 2063     """.        c
+0001a050: 6f6d 6d5f 6279 7465 7320 3d20 7375 6d28  omm_bytes = sum(
+0001a060: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
+0001a070: 2e67 6574 5f6e 6279 7465 7328 2920 666f  .get_nbytes() fo
+0001a080: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+0001a090: 6e64 656e 6369 6573 2069 6620 7773 206e  ndencies if ws n
+0001a0a0: 6f74 2069 6e20 6474 732e 7768 6f5f 6861  ot in dts.who_ha
+0001a0b0: 730a 2020 2020 2020 2020 290a 0a20 2020  s.        )..   
+0001a0c0: 2020 2020 2073 7461 636b 5f74 696d 6520       stack_time 
+0001a0d0: 3d20 7773 2e6f 6363 7570 616e 6379 202f  = ws.occupancy /
+0001a0e0: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
+0001a0f0: 2020 2020 2073 7461 7274 5f74 696d 6520       start_time 
+0001a100: 3d20 7374 6163 6b5f 7469 6d65 202b 2063  = stack_time + c
+0001a110: 6f6d 6d5f 6279 7465 7320 2f20 7365 6c66  omm_bytes / self
+0001a120: 2e62 616e 6477 6964 7468 0a0a 2020 2020  .bandwidth..    
+0001a130: 2020 2020 6966 2074 732e 6163 746f 723a      if ts.actor:
+0001a140: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001a150: 7572 6e20 286c 656e 2877 732e 6163 746f  urn (len(ws.acto
+0001a160: 7273 292c 2073 7461 7274 5f74 696d 652c  rs), start_time,
+0001a170: 2077 732e 6e62 7974 6573 290a 2020 2020   ws.nbytes).    
+0001a180: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001a190: 2020 2020 2020 7265 7475 726e 2028 7374        return (st
+0001a1a0: 6172 745f 7469 6d65 2c20 7773 2e6e 6279  art_time, ws.nby
+0001a1b0: 7465 7329 0a0a 2020 2020 6465 6620 6164  tes)..    def ad
+0001a1c0: 645f 7265 706c 6963 6128 7365 6c66 2c20  d_replica(self, 
+0001a1d0: 7473 3a20 5461 736b 5374 6174 652c 2077  ts: TaskState, w
+0001a1e0: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
+0001a1f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0001a200: 2022 2222 4e6f 7465 2074 6861 7420 6120   """Note that a 
+0001a210: 776f 726b 6572 2068 6f6c 6473 2061 2072  worker holds a r
+0001a220: 6570 6c69 6361 206f 6620 6120 7461 736b  eplica of a task
+0001a230: 2077 6974 6820 7374 6174 653d 276d 656d   with state='mem
+0001a240: 6f72 7927 2222 220a 2020 2020 2020 2020  ory'""".        
+0001a250: 7773 2e61 6464 5f72 6570 6c69 6361 2874  ws.add_replica(t
+0001a260: 7329 0a20 2020 2020 2020 2069 6620 6c65  s).        if le
+0001a270: 6e28 7473 2e77 686f 5f68 6173 2920 3d3d  n(ts.who_has) ==
+0001a280: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
+0001a290: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
+0001a2a0: 7461 736b 732e 6164 6428 7473 290a 0a20  tasks.add(ts).. 
+0001a2b0: 2020 2064 6566 2072 656d 6f76 655f 7265     def remove_re
+0001a2c0: 706c 6963 6128 7365 6c66 2c20 7473 3a20  plica(self, ts: 
+0001a2d0: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
+0001a2e0: 6f72 6b65 7253 7461 7465 2920 2d3e 204e  orkerState) -> N
+0001a2f0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0001a300: 4e6f 7465 2074 6861 7420 6120 776f 726b  Note that a work
+0001a310: 6572 206e 6f20 6c6f 6e67 6572 2068 6f6c  er no longer hol
+0001a320: 6473 2061 2072 6570 6c69 6361 206f 6620  ds a replica of 
+0001a330: 6120 7461 736b 2222 220a 2020 2020 2020  a task""".      
+0001a340: 2020 7773 2e72 656d 6f76 655f 7265 706c    ws.remove_repl
+0001a350: 6963 6128 7473 290a 2020 2020 2020 2020  ica(ts).        
+0001a360: 6966 206c 656e 2874 732e 7768 6f5f 6861  if len(ts.who_ha
+0001a370: 7329 203d 3d20 313a 0a20 2020 2020 2020  s) == 1:.       
+0001a380: 2020 2020 2073 656c 662e 7265 706c 6963       self.replic
+0001a390: 6174 6564 5f74 6173 6b73 2e72 656d 6f76  ated_tasks.remov
+0001a3a0: 6528 7473 290a 0a20 2020 2064 6566 2072  e(ts)..    def r
+0001a3b0: 656d 6f76 655f 616c 6c5f 7265 706c 6963  emove_all_replic
+0001a3c0: 6173 2873 656c 662c 2074 733a 2054 6173  as(self, ts: Tas
+0001a3d0: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
+0001a3e0: 0a20 2020 2020 2020 2022 2222 5265 6d6f  .        """Remo
+0001a3f0: 7665 2061 6c6c 2072 6570 6c69 6361 7320  ve all replicas 
+0001a400: 6f66 2061 2074 6173 6b20 6672 6f6d 2061  of a task from a
+0001a410: 6c6c 2077 6f72 6b65 7273 2222 220a 2020  ll workers""".  
+0001a420: 2020 2020 2020 6e62 7974 6573 203d 2074        nbytes = t
+0001a430: 732e 6765 745f 6e62 7974 6573 2829 0a20  s.get_nbytes(). 
+0001a440: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+0001a450: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
+0001a460: 2020 2020 2020 2020 2077 732e 6e62 7974           ws.nbyt
+0001a470: 6573 202d 3d20 6e62 7974 6573 0a20 2020  es -= nbytes.   
+0001a480: 2020 2020 2020 2020 2064 656c 2077 732e           del ws.
+0001a490: 5f68 6173 5f77 6861 745b 7473 5d0a 2020  _has_what[ts].  
+0001a4a0: 2020 2020 2020 6966 206c 656e 2874 732e        if len(ts.
+0001a4b0: 7768 6f5f 6861 7329 203e 2031 3a0a 2020  who_has) > 1:.  
+0001a4c0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+0001a4d0: 6570 6c69 6361 7465 645f 7461 736b 732e  eplicated_tasks.
+0001a4e0: 7265 6d6f 7665 2874 7329 0a20 2020 2020  remove(ts).     
+0001a4f0: 2020 2074 732e 7768 6f5f 6861 732e 636c     ts.who_has.cl
+0001a500: 6561 7228 290a 0a20 2020 2064 6566 2062  ear()..    def b
+0001a510: 756c 6b5f 7363 6865 6475 6c65 5f75 6e72  ulk_schedule_unr
+0001a520: 756e 6e61 626c 655f 6166 7465 725f 6164  unnable_after_ad
+0001a530: 6469 6e67 5f77 6f72 6b65 7228 7365 6c66  ding_worker(self
+0001a540: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
+0001a550: 6529 202d 3e20 5265 6373 3a0a 2020 2020  e) -> Recs:.    
+0001a560: 2020 2020 2222 2253 656e 6420 6060 6e6f      """Send ``no
+0001a570: 2d77 6f72 6b65 7260 6020 7461 736b 7320  -worker`` tasks 
+0001a580: 746f 2060 6070 726f 6365 7373 696e 6760  to ``processing`
+0001a590: 6020 7468 6174 2074 6869 7320 776f 726b  ` that this work
+0001a5a0: 6572 2063 616e 2068 616e 646c 652e 0a0a  er can handle...
+0001a5b0: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+0001a5c0: 7072 696f 7269 7479 2d6f 7264 6572 6564  priority-ordered
+0001a5d0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001a5e0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0001a5f0: 2020 2020 2020 7275 6e6e 6162 6c65 3a20        runnable: 
+0001a600: 6c69 7374 5b54 6173 6b53 7461 7465 5d20  list[TaskState] 
+0001a610: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+0001a620: 2074 7320 696e 2073 656c 662e 756e 7275   ts in self.unru
+0001a630: 6e6e 6162 6c65 3a0a 2020 2020 2020 2020  nnable:.        
+0001a640: 2020 2020 7661 6c69 6420 3d20 7365 6c66      valid = self
+0001a650: 2e76 616c 6964 5f77 6f72 6b65 7273 2874  .valid_workers(t
+0001a660: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
+0001a670: 6620 7661 6c69 6420 6973 204e 6f6e 6520  f valid is None 
+0001a680: 6f72 2077 7320 696e 2076 616c 6964 3a0a  or ws in valid:.
+0001a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6a0: 7275 6e6e 6162 6c65 2e61 7070 656e 6428  runnable.append(
+0001a6b0: 7473 290a 0a20 2020 2020 2020 2023 2052  ts)..        # R
+0001a6c0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2061  ecommendations a
+0001a6d0: 7265 2070 726f 6365 7373 6564 204c 4946  re processed LIF
+0001a6e0: 4f2c 2068 656e 6365 2074 6865 2072 6576  O, hence the rev
+0001a6f0: 6572 7365 6420 6f72 6465 720a 2020 2020  ersed order.    
+0001a700: 2020 2020 7275 6e6e 6162 6c65 2e73 6f72      runnable.sor
+0001a710: 7428 6b65 793d 6f70 6572 6174 6f72 2e61  t(key=operator.a
+0001a720: 7474 7267 6574 7465 7228 2270 7269 6f72  ttrgetter("prior
+0001a730: 6974 7922 292c 2072 6576 6572 7365 3d54  ity"), reverse=T
+0001a740: 7275 6529 0a20 2020 2020 2020 2072 6574  rue).        ret
+0001a750: 7572 6e20 7b74 732e 6b65 793a 2022 7072  urn {ts.key: "pr
+0001a760: 6f63 6573 7369 6e67 2220 666f 7220 7473  ocessing" for ts
+0001a770: 2069 6e20 7275 6e6e 6162 6c65 7d0a 0a20   in runnable}.. 
+0001a780: 2020 2064 6566 205f 7661 6c69 6461 7465     def _validate
+0001a790: 5f72 6561 6479 2873 656c 662c 2074 733a  _ready(self, ts:
+0001a7a0: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
+0001a7b0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0001a7c0: 5661 6c69 6461 7469 6f6e 2066 6f72 2072  Validation for r
+0001a7d0: 6561 6479 2073 7461 7465 7320 2870 726f  eady states (pro
+0001a7e0: 6365 7373 696e 672c 2071 7565 7565 642c  cessing, queued,
+0001a7f0: 206e 6f2d 776f 726b 6572 2922 2222 0a20   no-worker)""". 
+0001a800: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0001a810: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+0001a820: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+0001a830: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
+0001a840: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0001a850: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
+0001a860: 616d 650a 2020 2020 2020 2020 6173 7365  ame.        asse
+0001a870: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+0001a880: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+0001a890: 6173 7365 7274 206e 6f74 2074 732e 6861  assert not ts.ha
+0001a8a0: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
+0001a8b0: 6965 730a 2020 2020 2020 2020 6173 7365  ies.        asse
+0001a8c0: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
+0001a8d0: 662e 756e 7275 6e6e 6162 6c65 0a20 2020  f.unrunnable.   
+0001a8e0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+0001a8f0: 6f74 2069 6e20 7365 6c66 2e71 7565 7565  ot in self.queue
+0001a900: 640a 2020 2020 2020 2020 6173 7365 7274  d.        assert
+0001a910: 2061 6c6c 2864 7473 2e77 686f 5f68 6173   all(dts.who_has
+0001a920: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+0001a930: 6570 656e 6465 6e63 6965 7329 0a0a 2020  ependencies)..  
+0001a940: 2020 6465 6620 5f61 6464 5f74 6f5f 7072    def _add_to_pr
+0001a950: 6f63 6573 7369 6e67 2873 656c 662c 2074  ocessing(self, t
+0001a960: 733a 2054 6173 6b53 7461 7465 2c20 7773  s: TaskState, ws
+0001a970: 3a20 576f 726b 6572 5374 6174 6529 202d  : WorkerState) -
+0001a980: 3e20 4d73 6773 3a0a 2020 2020 2020 2020  > Msgs:.        
+0001a990: 2222 2253 6574 2061 2074 6173 6b20 6173  """Set a task as
+0001a9a0: 2070 726f 6365 7373 696e 6720 6f6e 2061   processing on a
+0001a9b0: 2077 6f72 6b65 7220 616e 6420 7265 7475   worker and retu
+0001a9c0: 726e 2074 6865 2077 6f72 6b65 7220 6d65  rn the worker me
+0001a9d0: 7373 6167 6573 2074 6f20 7365 6e64 2222  ssages to send""
+0001a9e0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+0001a9f0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+0001aa00: 2020 2020 2020 2020 7365 6c66 2e5f 7661          self._va
+0001aa10: 6c69 6461 7465 5f72 6561 6479 2874 7329  lidate_ready(ts)
+0001aa20: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001aa30: 6572 7420 7773 2069 6e20 7365 6c66 2e72  ert ws in self.r
+0001aa40: 756e 6e69 6e67 2c20 7365 6c66 2e72 756e  unning, self.run
+0001aa50: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
+0001aa60: 2061 7373 6572 7420 286f 203a 3d20 7365   assert (o := se
+0001aa70: 6c66 2e77 6f72 6b65 7273 2e67 6574 2877  lf.workers.get(w
+0001aa80: 732e 6164 6472 6573 7329 2920 6973 2077  s.address)) is w
+0001aa90: 732c 2028 7773 2c20 6f29 0a0a 2020 2020  s, (ws, o)..    
+0001aaa0: 2020 2020 7773 2e61 6464 5f74 6f5f 7072      ws.add_to_pr
+0001aab0: 6f63 6573 7369 6e67 2874 7329 0a20 2020  ocessing(ts).   
+0001aac0: 2020 2020 2074 732e 7072 6f63 6573 7369       ts.processi
+0001aad0: 6e67 5f6f 6e20 3d20 7773 0a20 2020 2020  ng_on = ws.     
+0001aae0: 2020 2074 732e 7374 6174 6520 3d20 2270     ts.state = "p
+0001aaf0: 726f 6365 7373 696e 6722 0a20 2020 2020  rocessing".     
+0001ab00: 2020 2073 656c 662e 6163 7175 6972 655f     self.acquire_
+0001ab10: 7265 736f 7572 6365 7328 7473 2c20 7773  resources(ts, ws
+0001ab20: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0001ab30: 6865 636b 5f69 646c 655f 7361 7475 7261  heck_idle_satura
+0001ab40: 7465 6428 7773 290a 2020 2020 2020 2020  ted(ws).        
+0001ab50: 7365 6c66 2e6e 5f74 6173 6b73 202b 3d20  self.n_tasks += 
+0001ab60: 310a 0a20 2020 2020 2020 2069 6620 7473  1..        if ts
+0001ab70: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
+0001ab80: 2020 2020 7773 2e61 6374 6f72 732e 6164      ws.actors.ad
+0001ab90: 6428 7473 290a 0a20 2020 2020 2020 2072  d(ts)..        r
+0001aba0: 6574 7572 6e20 7b77 732e 6164 6472 6573  eturn {ws.addres
+0001abb0: 733a 205b 7365 6c66 2e5f 7461 736b 5f74  s: [self._task_t
+0001abc0: 6f5f 6d73 6728 7473 295d 7d0a 0a20 2020  o_msg(ts)]}..   
+0001abd0: 2064 6566 205f 6578 6974 5f70 726f 6365   def _exit_proce
+0001abe0: 7373 696e 675f 636f 6d6d 6f6e 2873 656c  ssing_common(sel
+0001abf0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+0001ac00: 2920 2d3e 2057 6f72 6b65 7253 7461 7465  ) -> WorkerState
+0001ac10: 207c 204e 6f6e 653a 0a20 2020 2020 2020   | None:.       
+0001ac20: 2022 2222 5265 6d6f 7665 202a 7473 2a20   """Remove *ts* 
+0001ac30: 6672 6f6d 2074 6865 2073 6574 206f 6620  from the set of 
+0001ac40: 7072 6f63 6573 7369 6e67 2074 6173 6b73  processing tasks
+0001ac50: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+0001ac60: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
+0001ac70: 2d2d 0a20 2020 2020 2020 2057 6f72 6b65  --.        Worke
+0001ac80: 7220 7374 6174 6520 6f66 2074 6865 2077  r state of the w
+0001ac90: 6f72 6b65 7220 7468 6174 2070 726f 6365  orker that proce
+0001aca0: 7373 6564 202a 7473 2a20 6966 2074 6865  ssed *ts* if the
+0001acb0: 2077 6f72 6b65 7220 6973 2063 7572 7265   worker is curre
+0001acc0: 6e74 2c0a 2020 2020 2020 2020 4e6f 6e65  nt,.        None
+0001acd0: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
+0001ace0: 7320 7374 616c 652e 0a0a 2020 2020 2020  s stale...      
+0001acf0: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+0001ad00: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+0001ad10: 2020 2020 5363 6865 6475 6c65 722e 5f73      Scheduler._s
+0001ad20: 6574 5f64 7572 6174 696f 6e5f 6573 7469  et_duration_esti
+0001ad30: 6d61 7465 0a20 2020 2020 2020 2022 2222  mate.        """
+0001ad40: 0a20 2020 2020 2020 2077 7320 3d20 7473  .        ws = ts
+0001ad50: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+0001ad60: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+0001ad70: 0a20 2020 2020 2020 2074 732e 7072 6f63  .        ts.proc
+0001ad80: 6573 7369 6e67 5f6f 6e20 3d20 4e6f 6e65  essing_on = None
+0001ad90: 0a0a 2020 2020 2020 2020 7773 2e72 656d  ..        ws.rem
+0001ada0: 6f76 655f 6672 6f6d 5f70 726f 6365 7373  ove_from_process
+0001adb0: 696e 6728 7473 290a 2020 2020 2020 2020  ing(ts).        
+0001adc0: 6966 2073 656c 662e 776f 726b 6572 732e  if self.workers.
+0001add0: 6765 7428 7773 2e61 6464 7265 7373 2920  get(ws.address) 
+0001ade0: 6973 206e 6f74 2077 733a 2020 2320 6d61  is not ws:  # ma
+0001adf0: 7920 6861 7665 2062 6565 6e20 7265 6d6f  y have been remo
+0001ae00: 7665 640a 2020 2020 2020 2020 2020 2020  ved.            
+0001ae10: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
+0001ae20: 2020 2020 2073 656c 662e 6368 6563 6b5f       self.check_
+0001ae30: 6964 6c65 5f73 6174 7572 6174 6564 2877  idle_saturated(w
+0001ae40: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+0001ae50: 7265 6c65 6173 655f 7265 736f 7572 6365  release_resource
+0001ae60: 7328 7473 2c20 7773 290a 0a20 2020 2020  s(ts, ws)..     
+0001ae70: 2020 2072 6574 7572 6e20 7773 0a0a 2020     return ws..  
+0001ae80: 2020 6465 6620 5f61 6464 5f74 6f5f 6d65    def _add_to_me
+0001ae90: 6d6f 7279 280a 2020 2020 2020 2020 7365  mory(.        se
+0001aea0: 6c66 2c0a 2020 2020 2020 2020 7473 3a20  lf,.        ts: 
+0001aeb0: 5461 736b 5374 6174 652c 0a20 2020 2020  TaskState,.     
+0001aec0: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
+0001aed0: 7465 2c0a 2020 2020 2020 2020 7265 636f  te,.        reco
+0001aee0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+0001aef0: 732c 0a20 2020 2020 2020 2063 6c69 656e  s,.        clien
+0001af00: 745f 6d73 6773 3a20 4d73 6773 2c0a 2020  t_msgs: Msgs,.  
+0001af10: 2020 2020 2020 7479 7065 3a20 6279 7465        type: byte
+0001af20: 7320 7c20 4e6f 6e65 203d 204e 6f6e 652c  s | None = None,
+0001af30: 0a20 2020 2020 2020 2074 7970 656e 616d  .        typenam
+0001af40: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
+0001af50: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 204e  None,.    ) -> N
+0001af60: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0001af70: 4164 6420 7473 2074 6f20 7468 6520 7365  Add ts to the se
+0001af80: 7420 6f66 2069 6e2d 6d65 6d6f 7279 2074  t of in-memory t
+0001af90: 6173 6b73 2222 220a 2020 2020 2020 2020  asks""".        
+0001afa0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+0001afb0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+0001afc0: 7365 7274 2074 7320 6e6f 7420 696e 2077  sert ts not in w
+0001afd0: 732e 6861 735f 7768 6174 0a0a 2020 2020  s.has_what..    
+0001afe0: 2020 2020 7365 6c66 2e61 6464 5f72 6570      self.add_rep
+0001aff0: 6c69 6361 2874 732c 2077 7329 0a0a 2020  lica(ts, ws)..  
+0001b000: 2020 2020 2020 6465 7073 203d 206c 6973        deps = lis
+0001b010: 7428 7473 2e64 6570 656e 6465 6e74 7329  t(ts.dependents)
+0001b020: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0001b030: 6465 7073 2920 3e20 313a 0a20 2020 2020  deps) > 1:.     
+0001b040: 2020 2020 2020 2064 6570 732e 736f 7274         deps.sort
+0001b050: 286b 6579 3d6f 7065 7261 746f 722e 6174  (key=operator.at
+0001b060: 7472 6765 7474 6572 2822 7072 696f 7269  trgetter("priori
+0001b070: 7479 2229 2c20 7265 7665 7273 653d 5472  ty"), reverse=Tr
+0001b080: 7565 290a 0a20 2020 2020 2020 2066 6f72  ue)..        for
+0001b090: 2064 7473 2069 6e20 6465 7073 3a0a 2020   dts in deps:.  
+0001b0a0: 2020 2020 2020 2020 2020 7320 3d20 6474            s = dt
+0001b0b0: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+0001b0c0: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+0001b0d0: 6e20 733a 0a20 2020 2020 2020 2020 2020  n s:.           
+0001b0e0: 2020 2020 2073 2e64 6973 6361 7264 2874       s.discard(t
+0001b0f0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0001b100: 2020 2069 6620 6e6f 7420 733a 2020 2320     if not s:  # 
+0001b110: 6e65 7720 7461 736b 2072 6561 6479 2074  new task ready t
+0001b120: 6f20 7275 6e0a 2020 2020 2020 2020 2020  o run.          
+0001b130: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+0001b140: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
+0001b150: 795d 203d 2022 7072 6f63 6573 7369 6e67  y] = "processing
+0001b160: 220a 0a20 2020 2020 2020 2066 6f72 2064  "..        for d
+0001b170: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+0001b180: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
+0001b190: 2020 2073 203d 2064 7473 2e77 6169 7465     s = dts.waite
+0001b1a0: 7273 0a20 2020 2020 2020 2020 2020 2073  rs.            s
+0001b1b0: 2e64 6973 6361 7264 2874 7329 0a20 2020  .discard(ts).   
+0001b1c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001b1d0: 7320 616e 6420 6e6f 7420 6474 732e 7768  s and not dts.wh
+0001b1e0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+0001b1f0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+0001b200: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
+0001b210: 5d20 3d20 2272 656c 6561 7365 6422 0a0a  ] = "released"..
+0001b220: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
+0001b230: 732e 7761 6974 6572 7320 616e 6420 6e6f  s.waiters and no
+0001b240: 7420 7473 2e77 686f 5f77 616e 7473 3a0a  t ts.who_wants:.
+0001b250: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0001b260: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
+0001b270: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
+0001b280: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001b290: 2020 2020 2020 2020 2020 2072 6570 6f72             repor
+0001b2a0: 745f 6d73 673a 2064 6963 745b 7374 722c  t_msg: dict[str,
+0001b2b0: 2041 6e79 5d20 3d20 7b22 6f70 223a 2022   Any] = {"op": "
+0001b2c0: 6b65 792d 696e 2d6d 656d 6f72 7922 2c20  key-in-memory", 
+0001b2d0: 226b 6579 223a 2074 732e 6b65 797d 0a20  "key": ts.key}. 
+0001b2e0: 2020 2020 2020 2020 2020 2069 6620 7479             if ty
+0001b2f0: 7065 2069 7320 6e6f 7420 4e6f 6e65 3a0a  pe is not None:.
+0001b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b310: 7265 706f 7274 5f6d 7367 5b22 7479 7065  report_msg["type
+0001b320: 225d 203d 2074 7970 650a 2020 2020 2020  "] = type.      
+0001b330: 2020 2020 2020 666f 7220 6373 2069 6e20        for cs in 
+0001b340: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
+0001b350: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+0001b360: 6965 6e74 5f6d 7367 735b 6373 2e63 6c69  ient_msgs[cs.cli
+0001b370: 656e 745f 6b65 795d 203d 205b 7265 706f  ent_key] = [repo
+0001b380: 7274 5f6d 7367 5d0a 0a20 2020 2020 2020  rt_msg]..       
+0001b390: 2074 732e 7374 6174 6520 3d20 226d 656d   ts.state = "mem
+0001b3a0: 6f72 7922 0a20 2020 2020 2020 2074 732e  ory".        ts.
+0001b3b0: 7479 7065 203d 2074 7970 656e 616d 6520  type = typename 
+0001b3c0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+0001b3d0: 2020 2020 2020 2020 7473 2e67 726f 7570          ts.group
+0001b3e0: 2e74 7970 6573 2e61 6464 2874 7970 656e  .types.add(typen
+0001b3f0: 616d 6529 2020 2320 7479 7065 3a20 6967  ame)  # type: ig
+0001b400: 6e6f 7265 0a0a 2020 2020 2020 2020 6373  nore..        cs
+0001b410: 203d 2073 656c 662e 636c 6965 6e74 735b   = self.clients[
+0001b420: 2266 6972 652d 616e 642d 666f 7267 6574  "fire-and-forget
+0001b430: 225d 0a20 2020 2020 2020 2069 6620 7473  "].        if ts
+0001b440: 2069 6e20 6373 2e77 616e 7473 5f77 6861   in cs.wants_wha
+0001b450: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+0001b460: 656c 662e 5f63 6c69 656e 745f 7265 6c65  elf._client_rele
+0001b470: 6173 6573 5f6b 6579 7328 0a20 2020 2020  ases_keys(.     
+0001b480: 2020 2020 2020 2020 2020 2063 733d 6373             cs=cs
+0001b490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b4a0: 2020 6b65 7973 3d5b 7473 2e6b 6579 5d2c    keys=[ts.key],
+0001b4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b4c0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001b4d0: 3d72 6563 6f6d 6d65 6e64 6174 696f 6e73  =recommendations
+0001b4e0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0001b4f0: 0a20 2020 2064 6566 205f 7072 6f70 6167  .    def _propag
+0001b500: 6174 655f 7265 6c65 6173 6564 2873 656c  ate_released(sel
+0001b510: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+0001b520: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
+0001b530: 733a 2052 6563 7329 202d 3e20 4e6f 6e65  s: Recs) -> None
+0001b540: 3a0a 2020 2020 2020 2020 7473 2e73 7461  :.        ts.sta
+0001b550: 7465 203d 2022 7265 6c65 6173 6564 220a  te = "released".
+0001b560: 2020 2020 2020 2020 6b65 7920 3d20 7473          key = ts
+0001b570: 2e6b 6579 0a0a 2020 2020 2020 2020 6966  .key..        if
+0001b580: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
+0001b590: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+0001b5a0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0001b5b0: 6174 696f 6e73 5b6b 6579 5d20 3d20 2266  ations[key] = "f
+0001b5c0: 6f72 676f 7474 656e 220a 2020 2020 2020  orgotten".      
+0001b5d0: 2020 656c 6966 2074 732e 7761 6974 6572    elif ts.waiter
+0001b5e0: 7320 6f72 2074 732e 7768 6f5f 7761 6e74  s or ts.who_want
+0001b5f0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+0001b600: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
+0001b610: 6579 5d20 3d20 2277 6169 7469 6e67 220a  ey] = "waiting".
+0001b620: 0a20 2020 2020 2020 2069 6620 7265 636f  .        if reco
+0001b630: 6d6d 656e 6461 7469 6f6e 732e 6765 7428  mmendations.get(
+0001b640: 6b65 7929 2021 3d20 2277 6169 7469 6e67  key) != "waiting
+0001b650: 223a 0a20 2020 2020 2020 2020 2020 2066  ":.            f
+0001b660: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+0001b670: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+0001b680: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
+0001b690: 732e 7374 6174 6520 213d 2022 7265 6c65  s.state != "rele
+0001b6a0: 6173 6564 223a 0a20 2020 2020 2020 2020  ased":.         
+0001b6b0: 2020 2020 2020 2020 2020 2064 7473 2e77             dts.w
+0001b6c0: 6169 7465 7273 2e64 6973 6361 7264 2874  aiters.discard(t
+0001b6d0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0001b6e0: 2020 2020 2020 2069 6620 6e6f 7420 6474         if not dt
+0001b6f0: 732e 7761 6974 6572 7320 616e 6420 6e6f  s.waiters and no
+0001b700: 7420 6474 732e 7768 6f5f 7761 6e74 733a  t dts.who_wants:
+0001b710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b720: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+0001b730: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
+0001b740: 5d20 3d20 2272 656c 6561 7365 6422 0a20  ] = "released". 
+0001b750: 2020 2020 2020 2020 2020 2074 732e 7761             ts.wa
+0001b760: 6974 6572 732e 636c 6561 7228 290a 0a20  iters.clear().. 
+0001b770: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+0001b780: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+0001b790: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0001b7a0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+0001b7b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001b7c0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
+0001b7d0: 6c66 2e71 7565 7565 640a 0a20 2020 2064  lf.queued..    d
+0001b7e0: 6566 205f 7072 6f70 6167 6174 655f 666f  ef _propagate_fo
+0001b7f0: 7267 6f74 7465 6e28 0a20 2020 2020 2020  rgotten(.       
+0001b800: 2073 656c 662c 0a20 2020 2020 2020 2074   self,.        t
+0001b810: 733a 2054 6173 6b53 7461 7465 2c0a 2020  s: TaskState,.  
+0001b820: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+0001b830: 7469 6f6e 733a 2052 6563 732c 0a20 2020  tions: Recs,.   
+0001b840: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+0001b850: 3a20 4d73 6773 2c0a 2020 2020 2020 2020  : Msgs,.        
+0001b860: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+0001b870: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
+0001b880: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
+0001b890: 6520 3d20 2266 6f72 676f 7474 656e 220a  e = "forgotten".
+0001b8a0: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+0001b8b0: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
+0001b8c0: 3a0a 2020 2020 2020 2020 2020 2020 6474  :.            dt
+0001b8d0: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
+0001b8e0: 6465 6e63 6965 7320 3d20 5472 7565 0a20  dencies = True. 
+0001b8f0: 2020 2020 2020 2020 2020 2064 7473 2e64             dts.d
+0001b900: 6570 656e 6465 6e63 6965 732e 7265 6d6f  ependencies.remo
+0001b910: 7665 2874 7329 0a20 2020 2020 2020 2020  ve(ts).         
+0001b920: 2020 2064 7473 2e77 6169 7469 6e67 5f6f     dts.waiting_o
+0001b930: 6e2e 6469 7363 6172 6428 7473 290a 2020  n.discard(ts).  
+0001b940: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
+0001b950: 2e73 7461 7465 206e 6f74 2069 6e20 2822  .state not in ("
+0001b960: 6d65 6d6f 7279 222c 2022 6572 7265 6422  memory", "erred"
+0001b970: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001b980: 2020 2023 2043 616e 6e6f 7420 636f 6d70     # Cannot comp
+0001b990: 7574 6520 7461 736b 2061 6e79 6d6f 7265  ute task anymore
+0001b9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b9b0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001b9c0: 5b64 7473 2e6b 6579 5d20 3d20 2266 6f72  [dts.key] = "for
+0001b9d0: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
+0001b9e0: 7473 2e64 6570 656e 6465 6e74 732e 636c  ts.dependents.cl
+0001b9f0: 6561 7228 290a 2020 2020 2020 2020 7473  ear().        ts
+0001ba00: 2e77 6169 7465 7273 2e63 6c65 6172 2829  .waiters.clear()
+0001ba10: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+0001ba20: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0001ba30: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+0001ba40: 2020 6474 732e 6465 7065 6e64 656e 7473    dts.dependents
+0001ba50: 2e72 656d 6f76 6528 7473 290a 2020 2020  .remove(ts).    
+0001ba60: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
+0001ba70: 6572 732e 6469 7363 6172 6428 7473 290a  ers.discard(ts).
+0001ba80: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0001ba90: 6f74 2064 7473 2e64 6570 656e 6465 6e74  ot dts.dependent
+0001baa0: 7320 616e 6420 6e6f 7420 6474 732e 7768  s and not dts.wh
+0001bab0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+0001bac0: 2020 2020 2020 2020 2023 2054 6173 6b20           # Task 
+0001bad0: 6e6f 7420 6e65 6564 6564 2061 6e79 6d6f  not needed anymo
+0001bae0: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+0001baf0: 2020 2061 7373 6572 7420 6474 7320 6973     assert dts is
+0001bb00: 206e 6f74 2074 730a 2020 2020 2020 2020   not ts.        
+0001bb10: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0001bb20: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
+0001bb30: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
+0001bb40: 2020 2020 2020 2074 732e 6465 7065 6e64         ts.depend
+0001bb50: 656e 6369 6573 2e63 6c65 6172 2829 0a20  encies.clear(). 
+0001bb60: 2020 2020 2020 2074 732e 7761 6974 696e         ts.waitin
+0001bb70: 675f 6f6e 2e63 6c65 6172 2829 0a0a 2020  g_on.clear()..  
+0001bb80: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+0001bb90: 7473 2e77 686f 5f68 6173 3a0a 2020 2020  ts.who_has:.    
+0001bba0: 2020 2020 2020 2020 6966 2077 732e 6164          if ws.ad
+0001bbb0: 6472 6573 7320 696e 2073 656c 662e 776f  dress in self.wo
+0001bbc0: 726b 6572 733a 2020 2320 696e 2063 6173  rkers:  # in cas
+0001bbd0: 6520 776f 726b 6572 2068 6173 2064 6965  e worker has die
+0001bbe0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0001bbf0: 2020 776f 726b 6572 5f6d 7367 735b 7773    worker_msgs[ws
+0001bc00: 2e61 6464 7265 7373 5d20 3d20 5b0a 2020  .address] = [.  
+0001bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc20: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0001bc30: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
+0001bc40: 3a20 2266 7265 652d 6b65 7973 222c 0a20  : "free-keys",. 
+0001bc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc60: 2020 2020 2020 2022 6b65 7973 223a 205b         "keys": [
+0001bc70: 7473 2e6b 6579 5d2c 0a20 2020 2020 2020  ts.key],.       
+0001bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc90: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+0001bca0: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+0001bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bcc0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0001bcd0: 2020 205d 0a20 2020 2020 2020 2073 656c     ].        sel
+0001bce0: 662e 7265 6d6f 7665 5f61 6c6c 5f72 6570  f.remove_all_rep
+0001bcf0: 6c69 6361 7328 7473 290a 0a20 2020 2064  licas(ts)..    d
+0001bd00: 6566 205f 636c 6965 6e74 5f72 656c 6561  ef _client_relea
+0001bd10: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
+0001bd20: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0001bd30: 6b65 7973 3a20 436f 6c6c 6563 7469 6f6e  keys: Collection
+0001bd40: 5b73 7472 5d2c 0a20 2020 2020 2020 2063  [str],.        c
+0001bd50: 733a 2043 6c69 656e 7453 7461 7465 2c0a  s: ClientState,.
+0001bd60: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0001bd70: 6461 7469 6f6e 733a 2052 6563 732c 0a20  dations: Recs,. 
+0001bd80: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+0001bd90: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
+0001bda0: 6b65 7973 2066 726f 6d20 636c 6965 6e74  keys from client
+0001bdb0: 2064 6573 6972 6564 206c 6973 7422 2222   desired list"""
+0001bdc0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0001bdd0: 6465 6275 6728 2243 6c69 656e 7420 2573  debug("Client %s
+0001bde0: 2072 656c 6561 7365 7320 6b65 7973 3a20   releases keys: 
+0001bdf0: 2573 222c 2063 732e 636c 6965 6e74 5f6b  %s", cs.client_k
+0001be00: 6579 2c20 6b65 7973 290a 2020 2020 2020  ey, keys).      
+0001be10: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+0001be20: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+0001be30: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+0001be40: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+0001be50: 2020 2020 6966 2074 7320 6973 206e 6f74      if ts is not
+0001be60: 204e 6f6e 6520 616e 6420 7473 2069 6e20   None and ts in 
+0001be70: 6373 2e77 616e 7473 5f77 6861 743a 0a20  cs.wants_what:. 
+0001be80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001be90: 732e 7761 6e74 735f 7768 6174 2e72 656d  s.wants_what.rem
+0001bea0: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
+0001beb0: 2020 2020 2020 2020 7473 2e77 686f 5f77          ts.who_w
+0001bec0: 616e 7473 2e72 656d 6f76 6528 6373 290a  ants.remove(cs).
+0001bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bee0: 6966 206e 6f74 2074 732e 7768 6f5f 7761  if not ts.who_wa
+0001bef0: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0001bf00: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001bf10: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
 0001bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf30: 2065 6c69 6620 7473 2e73 7461 7465 2021   elif ts.state !
-0001bf40: 3d20 2265 7272 6564 2220 616e 6420 6e6f  = "erred" and no
-0001bf50: 7420 7473 2e77 6169 7465 7273 3a0a 2020  t ts.waiters:.  
+0001bf30: 2020 2020 2020 2023 204e 6f20 6c69 7665         # No live
+0001bf40: 2064 6570 656e 6465 6e74 732c 2063 616e   dependents, can
+0001bf50: 2066 6f72 6765 740a 2020 2020 2020 2020   forget.        
 0001bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf70: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001bf80: 7469 6f6e 735b 7473 2e6b 6579 5d20 3d20  tions[ts.key] = 
-0001bf90: 2272 656c 6561 7365 6422 0a0a 2020 2020  "released"..    
-0001bfa0: 6465 6620 5f74 6173 6b5f 746f 5f6d 7367  def _task_to_msg
-0001bfb0: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-0001bfc0: 7461 7465 2c20 6475 7261 7469 6f6e 3a20  tate, duration: 
-0001bfd0: 666c 6f61 7420 3d20 2d31 2920 2d3e 2064  float = -1) -> d
-0001bfe0: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-0001bff0: 2020 2020 2020 2022 2222 436f 6e76 6572         """Conver
-0001c000: 7420 6120 7369 6e67 6c65 2063 6f6d 7075  t a single compu
-0001c010: 7461 7469 6f6e 616c 2074 6173 6b20 746f  tational task to
-0001c020: 2061 206d 6573 7361 6765 2222 220a 2020   a message""".  
-0001c030: 2020 2020 2020 2320 4649 584d 453a 2054        # FIXME: T
-0001c040: 6865 2064 7572 6174 696f 6e20 6174 7472  he duration attr
-0001c050: 6962 7574 6520 6973 206e 6f74 2075 7365  ibute is not use
-0001c060: 6420 6f6e 2077 6f72 6b65 722e 2057 6520  d on worker. We 
-0001c070: 636f 756c 6420 7361 7665 206f 7572 7365  could save ourse
-0001c080: 6c76 6573 2074 6865 0a20 2020 2020 2020  lves the.       
-0001c090: 2023 2020 2020 2020 2020 7469 6d65 2074   #        time t
-0001c0a0: 6f20 636f 6d70 7574 6520 616e 6420 7375  o compute and su
-0001c0b0: 626d 6974 2074 6869 730a 2020 2020 2020  bmit this.      
-0001c0c0: 2020 6966 2064 7572 6174 696f 6e20 3c20    if duration < 
-0001c0d0: 303a 0a20 2020 2020 2020 2020 2020 2064  0:.            d
-0001c0e0: 7572 6174 696f 6e20 3d20 7365 6c66 2e67  uration = self.g
-0001c0f0: 6574 5f74 6173 6b5f 6475 7261 7469 6f6e  et_task_duration
-0001c100: 2874 7329 0a20 2020 2020 2020 2074 732e  (ts).        ts.
-0001c110: 7275 6e5f 6964 203d 206e 6578 7428 5461  run_id = next(Ta
-0001c120: 736b 5374 6174 652e 5f72 756e 5f69 645f  skState._run_id_
-0001c130: 6974 6572 6174 6f72 290a 0a20 2020 2020  iterator)..     
-0001c140: 2020 206d 7367 3a20 6469 6374 5b73 7472     msg: dict[str
-0001c150: 2c20 416e 795d 203d 207b 0a20 2020 2020  , Any] = {.     
-0001c160: 2020 2020 2020 2022 6f70 223a 2022 636f         "op": "co
-0001c170: 6d70 7574 652d 7461 736b 222c 0a20 2020  mpute-task",.   
-0001c180: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
-0001c190: 7473 2e6b 6579 2c0a 2020 2020 2020 2020  ts.key,.        
-0001c1a0: 2020 2020 2272 756e 5f69 6422 3a20 7473      "run_id": ts
-0001c1b0: 2e72 756e 5f69 642c 0a20 2020 2020 2020  .run_id,.       
-0001c1c0: 2020 2020 2022 7072 696f 7269 7479 223a       "priority":
-0001c1d0: 2074 732e 7072 696f 7269 7479 2c0a 2020   ts.priority,.  
-0001c1e0: 2020 2020 2020 2020 2020 2264 7572 6174            "durat
-0001c1f0: 696f 6e22 3a20 6475 7261 7469 6f6e 2c0a  ion": duration,.
-0001c200: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-0001c210: 6d75 6c75 735f 6964 223a 2066 2263 6f6d  mulus_id": f"com
-0001c220: 7075 7465 2d74 6173 6b2d 7b74 696d 6528  pute-task-{time(
-0001c230: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
-0001c240: 2022 7768 6f5f 6861 7322 3a20 7b0a 2020   "who_has": {.  
-0001c250: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-0001c260: 732e 6b65 793a 205b 7773 2e61 6464 7265  s.key: [ws.addre
-0001c270: 7373 2066 6f72 2077 7320 696e 2064 7473  ss for ws in dts
-0001c280: 2e77 686f 5f68 6173 5d20 666f 7220 6474  .who_has] for dt
-0001c290: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001c2a0: 6369 6573 0a20 2020 2020 2020 2020 2020  cies.           
-0001c2b0: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
-0001c2c0: 226e 6279 7465 7322 3a20 7b64 7473 2e6b  "nbytes": {dts.k
-0001c2d0: 6579 3a20 6474 732e 6e62 7974 6573 2066  ey: dts.nbytes f
-0001c2e0: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0001c2f0: 656e 6465 6e63 6965 737d 2c0a 2020 2020  endencies},.    
-0001c300: 2020 2020 2020 2020 2272 756e 5f73 7065          "run_spe
-0001c310: 6322 3a20 4e6f 6e65 2c0a 2020 2020 2020  c": None,.      
-0001c320: 2020 2020 2020 2266 756e 6374 696f 6e22        "function"
-0001c330: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-0001c340: 2020 2020 2261 7267 7322 3a20 4e6f 6e65      "args": None
-0001c350: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
-0001c360: 7761 7267 7322 3a20 4e6f 6e65 2c0a 2020  wargs": None,.  
-0001c370: 2020 2020 2020 2020 2020 2272 6573 6f75            "resou
-0001c380: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-0001c390: 223a 2074 732e 7265 736f 7572 6365 5f72  ": ts.resource_r
-0001c3a0: 6573 7472 6963 7469 6f6e 732c 0a20 2020  estrictions,.   
-0001c3b0: 2020 2020 2020 2020 2022 6163 746f 7222           "actor"
-0001c3c0: 3a20 7473 2e61 6374 6f72 2c0a 2020 2020  : ts.actor,.    
-0001c3d0: 2020 2020 2020 2020 2261 6e6e 6f74 6174          "annotat
-0001c3e0: 696f 6e73 223a 2074 732e 616e 6e6f 7461  ions": ts.annota
-0001c3f0: 7469 6f6e 732c 0a20 2020 2020 2020 207d  tions,.        }
-0001c400: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001c410: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-0001c420: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
-0001c430: 6c28 6d73 675b 2277 686f 5f68 6173 225d  l(msg["who_has"]
-0001c440: 2e76 616c 7565 7328 2929 0a0a 2020 2020  .values())..    
-0001c450: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0001c460: 6528 7473 2e72 756e 5f73 7065 632c 2064  e(ts.run_spec, d
-0001c470: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
-0001c480: 2020 6d73 672e 7570 6461 7465 2874 732e    msg.update(ts.
-0001c490: 7275 6e5f 7370 6563 290a 2020 2020 2020  run_spec).      
-0001c4a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001c4b0: 2020 2020 6d73 675b 2272 756e 5f73 7065      msg["run_spe
-0001c4c0: 6322 5d20 3d20 7473 2e72 756e 5f73 7065  c"] = ts.run_spe
-0001c4d0: 630a 0a20 2020 2020 2020 2072 6574 7572  c..        retur
-0001c4e0: 6e20 6d73 670a 0a0a 636c 6173 7320 5363  n msg...class Sc
-0001c4f0: 6865 6475 6c65 7228 5363 6865 6475 6c65  heduler(Schedule
-0001c500: 7253 7461 7465 2c20 5365 7276 6572 4e6f  rState, ServerNo
-0001c510: 6465 293a 0a20 2020 2022 2222 4479 6e61  de):.    """Dyna
-0001c520: 6d69 6320 6469 7374 7269 6275 7465 6420  mic distributed 
-0001c530: 7461 736b 2073 6368 6564 756c 6572 0a0a  task scheduler..
-0001c540: 2020 2020 5468 6520 7363 6865 6475 6c65      The schedule
-0001c550: 7220 7472 6163 6b73 2074 6865 2063 7572  r tracks the cur
-0001c560: 7265 6e74 2073 7461 7465 206f 6620 776f  rent state of wo
-0001c570: 726b 6572 732c 2064 6174 612c 2061 6e64  rkers, data, and
-0001c580: 2063 6f6d 7075 7461 7469 6f6e 732e 0a20   computations.. 
-0001c590: 2020 2054 6865 2073 6368 6564 756c 6572     The scheduler
-0001c5a0: 206c 6973 7465 6e73 2066 6f72 2065 7665   listens for eve
-0001c5b0: 6e74 7320 616e 6420 7265 7370 6f6e 6473  nts and responds
-0001c5c0: 2062 7920 636f 6e74 726f 6c6c 696e 6720   by controlling 
-0001c5d0: 776f 726b 6572 730a 2020 2020 6170 7072  workers.    appr
-0001c5e0: 6f70 7269 6174 656c 792e 2020 4974 2063  opriately.  It c
-0001c5f0: 6f6e 7469 6e75 6f75 736c 7920 7472 6965  ontinuously trie
-0001c600: 7320 746f 2075 7365 2074 6865 2077 6f72  s to use the wor
-0001c610: 6b65 7273 2074 6f20 6578 6563 7574 6520  kers to execute 
-0001c620: 616e 2065 7665 720a 2020 2020 6772 6f77  an ever.    grow
-0001c630: 696e 6720 6461 736b 2067 7261 7068 2e0a  ing dask graph..
-0001c640: 0a20 2020 2041 6c6c 2065 7665 6e74 7320  .    All events 
-0001c650: 6172 6520 6861 6e64 6c65 6420 7175 6963  are handled quic
-0001c660: 6b6c 792c 2069 6e20 6c69 6e65 6172 2074  kly, in linear t
-0001c670: 696d 6520 7769 7468 2072 6573 7065 6374  ime with respect
-0001c680: 2074 6f20 7468 6569 7220 696e 7075 740a   to their input.
-0001c690: 2020 2020 2877 6869 6368 2069 7320 6f66      (which is of
-0001c6a0: 7465 6e20 6f66 2063 6f6e 7374 616e 7420  ten of constant 
-0001c6b0: 7369 7a65 2920 616e 6420 6765 6e65 7261  size) and genera
-0001c6c0: 6c6c 7920 7769 7468 696e 2061 206d 696c  lly within a mil
-0001c6d0: 6c69 7365 636f 6e64 2e20 2054 6f0a 2020  lisecond.  To.  
-0001c6e0: 2020 6163 636f 6d70 6c69 7368 2074 6869    accomplish thi
-0001c6f0: 7320 7468 6520 7363 6865 6475 6c65 7220  s the scheduler 
-0001c700: 7472 6163 6b73 2061 206c 6f74 206f 6620  tracks a lot of 
-0001c710: 7374 6174 652e 2020 4576 6572 7920 6f70  state.  Every op
-0001c720: 6572 6174 696f 6e0a 2020 2020 6d61 696e  eration.    main
-0001c730: 7461 696e 7320 7468 6520 636f 6e73 6973  tains the consis
-0001c740: 7465 6e63 7920 6f66 2074 6869 7320 7374  tency of this st
-0001c750: 6174 652e 0a0a 2020 2020 5468 6520 7363  ate...    The sc
-0001c760: 6865 6475 6c65 7220 636f 6d6d 756e 6963  heduler communic
-0001c770: 6174 6573 2077 6974 6820 7468 6520 6f75  ates with the ou
-0001c780: 7473 6964 6520 776f 726c 6420 7468 726f  tside world thro
-0001c790: 7567 6820 436f 6d6d 206f 626a 6563 7473  ugh Comm objects
-0001c7a0: 2e0a 2020 2020 4974 206d 6169 6e74 6169  ..    It maintai
-0001c7b0: 6e73 2061 2063 6f6e 7369 7374 656e 7420  ns a consistent 
-0001c7c0: 616e 6420 7661 6c69 6420 7669 6577 206f  and valid view o
-0001c7d0: 6620 7468 6520 776f 726c 6420 6576 656e  f the world even
-0001c7e0: 2077 6865 6e20 6c69 7374 656e 696e 670a   when listening.
-0001c7f0: 2020 2020 746f 2073 6576 6572 616c 2063      to several c
-0001c800: 6c69 656e 7473 2061 7420 6f6e 6365 2e0a  lients at once..
-0001c810: 0a20 2020 2041 2053 6368 6564 756c 6572  .    A Scheduler
-0001c820: 2069 7320 7479 7069 6361 6c6c 7920 7374   is typically st
-0001c830: 6172 7465 6420 6569 7468 6572 2077 6974  arted either wit
-0001c840: 6820 7468 6520 6060 6461 736b 2073 6368  h the ``dask sch
-0001c850: 6564 756c 6572 6060 0a20 2020 2065 7865  eduler``.    exe
-0001c860: 6375 7461 626c 653a 3a0a 0a20 2020 2020  cutable::..     
-0001c870: 2020 2020 2420 6461 736b 2073 6368 6564      $ dask sched
-0001c880: 756c 6572 0a20 2020 2020 2020 2020 5363  uler.         Sc
-0001c890: 6865 6475 6c65 7220 7374 6172 7465 6420  heduler started 
-0001c8a0: 6174 2031 3237 2e30 2e30 2e31 3a38 3738  at 127.0.0.1:878
-0001c8b0: 360a 0a20 2020 204f 7220 7769 7468 696e  6..    Or within
-0001c8c0: 2061 204c 6f63 616c 436c 7573 7465 7220   a LocalCluster 
-0001c8d0: 6120 436c 6965 6e74 2073 7461 7274 7320  a Client starts 
-0001c8e0: 7570 2077 6974 686f 7574 2063 6f6e 6e65  up without conne
-0001c8f0: 6374 696f 6e0a 2020 2020 696e 666f 726d  ction.    inform
-0001c900: 6174 696f 6e3a 3a0a 0a20 2020 2020 2020  ation::..       
-0001c910: 203e 3e3e 2063 203d 2043 6c69 656e 7428   >>> c = Client(
-0001c920: 2920 2023 2064 6f63 7465 7374 3a20 2b53  )  # doctest: +S
-0001c930: 4b49 500a 2020 2020 2020 2020 3e3e 3e20  KIP.        >>> 
-0001c940: 632e 636c 7573 7465 722e 7363 6865 6475  c.cluster.schedu
-0001c950: 6c65 7220 2023 2064 6f63 7465 7374 3a20  ler  # doctest: 
-0001c960: 2b53 4b49 500a 2020 2020 2020 2020 5363  +SKIP.        Sc
-0001c970: 6865 6475 6c65 7228 2e2e 2e29 0a0a 2020  heduler(...)..  
-0001c980: 2020 5573 6572 7320 7479 7069 6361 6c6c    Users typicall
-0001c990: 7920 646f 206e 6f74 2069 6e74 6572 6163  y do not interac
-0001c9a0: 7420 7769 7468 2074 6865 2073 6368 6564  t with the sched
-0001c9b0: 756c 6572 2064 6972 6563 746c 7920 6275  uler directly bu
-0001c9c0: 7420 7261 7468 6572 2077 6974 680a 2020  t rather with.  
-0001c9d0: 2020 7468 6520 636c 6965 6e74 206f 626a    the client obj
-0001c9e0: 6563 7420 6060 436c 6965 6e74 6060 2e0a  ect ``Client``..
-0001c9f0: 0a20 2020 2054 6865 2060 6063 6f6e 7461  .    The ``conta
-0001ca00: 6374 5f61 6464 7265 7373 6060 2070 6172  ct_address`` par
-0001ca10: 616d 6574 6572 2061 6c6c 6f77 7320 746f  ameter allows to
-0001ca20: 2061 6476 6572 7469 7365 2061 2073 7065   advertise a spe
-0001ca30: 6369 6669 6320 6164 6472 6573 7320 746f  cific address to
-0001ca40: 0a20 2020 2074 6865 2077 6f72 6b65 7273  .    the workers
-0001ca50: 2066 6f72 2063 6f6d 6d75 6e69 6361 7469   for communicati
-0001ca60: 6f6e 2077 6974 6820 7468 6520 7363 6865  on with the sche
-0001ca70: 6475 6c65 722c 2077 6869 6368 2069 7320  duler, which is 
-0001ca80: 6469 6666 6572 656e 7420 7468 616e 0a20  different than. 
-0001ca90: 2020 2074 6865 2061 6464 7265 7373 2074     the address t
-0001caa0: 6865 2073 6368 6564 756c 6572 2062 696e  he scheduler bin
-0001cab0: 6473 2074 6f2e 2054 6869 7320 6973 2075  ds to. This is u
-0001cac0: 7365 6675 6c20 7768 656e 2074 6865 2073  seful when the s
-0001cad0: 6368 6564 756c 6572 0a20 2020 206c 6973  cheduler.    lis
-0001cae0: 7465 6e73 206f 6e20 6120 7072 6976 6174  tens on a privat
-0001caf0: 6520 6164 6472 6573 732c 2077 6869 6368  e address, which
-0001cb00: 2074 6865 7265 666f 7265 2063 616e 6e6f   therefore canno
-0001cb10: 7420 6265 2075 7365 6420 6279 2074 6865  t be used by the
-0001cb20: 2077 6f72 6b65 7273 0a20 2020 2074 6f20   workers.    to 
-0001cb30: 636f 6e74 6163 7420 6974 2e0a 0a20 2020  contact it...   
-0001cb40: 202a 2a53 7461 7465 2a2a 0a0a 2020 2020   **State**..    
-0001cb50: 5468 6520 7363 6865 6475 6c65 7220 636f  The scheduler co
-0001cb60: 6e74 6169 6e73 2074 6865 2066 6f6c 6c6f  ntains the follo
-0001cb70: 7769 6e67 2073 7461 7465 2076 6172 6961  wing state varia
-0001cb80: 626c 6573 2e20 2045 6163 6820 7661 7269  bles.  Each vari
-0001cb90: 6162 6c65 2069 730a 2020 2020 6c69 7374  able is.    list
-0001cba0: 6564 2061 6c6f 6e67 2077 6974 6820 7768  ed along with wh
-0001cbb0: 6174 2069 7420 7374 6f72 6573 2061 6e64  at it stores and
-0001cbc0: 2061 2062 7269 6566 2064 6573 6372 6970   a brief descrip
-0001cbd0: 7469 6f6e 2e0a 0a20 2020 202a 202a 2a74  tion...    * **t
-0001cbe0: 6173 6b73 3a2a 2a20 6060 7b74 6173 6b20  asks:** ``{task 
-0001cbf0: 6b65 793a 2054 6173 6b53 7461 7465 7d60  key: TaskState}`
-0001cc00: 600a 2020 2020 2020 2020 5461 736b 7320  `.        Tasks 
-0001cc10: 6375 7272 656e 746c 7920 6b6e 6f77 6e20  currently known 
-0001cc20: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
-0001cc30: 0a20 2020 202a 202a 2a75 6e72 756e 6e61  .    * **unrunna
-0001cc40: 626c 653a 2a2a 2060 607b 5461 736b 5374  ble:** ``{TaskSt
-0001cc50: 6174 657d 6060 0a20 2020 2020 2020 2054  ate}``.        T
-0001cc60: 6173 6b73 2069 6e20 7468 6520 226e 6f2d  asks in the "no-
-0001cc70: 776f 726b 6572 2220 7374 6174 650a 0a20  worker" state.. 
-0001cc80: 2020 202a 202a 2a77 6f72 6b65 7273 3a2a     * **workers:*
-0001cc90: 2a20 6060 7b77 6f72 6b65 7220 6b65 793a  * ``{worker key:
-0001cca0: 2057 6f72 6b65 7253 7461 7465 7d60 600a   WorkerState}``.
-0001ccb0: 2020 2020 2020 2020 576f 726b 6572 7320          Workers 
-0001ccc0: 6375 7272 656e 746c 7920 636f 6e6e 6563  currently connec
-0001ccd0: 7465 6420 746f 2074 6865 2073 6368 6564  ted to the sched
-0001cce0: 756c 6572 0a20 2020 202a 202a 2a69 646c  uler.    * **idl
-0001ccf0: 653a 2a2a 2060 607b 576f 726b 6572 5374  e:** ``{WorkerSt
-0001cd00: 6174 657d 6060 3a0a 2020 2020 2020 2020  ate}``:.        
-0001cd10: 5365 7420 6f66 2077 6f72 6b65 7273 2074  Set of workers t
-0001cd20: 6861 7420 6172 6520 6e6f 7420 6675 6c6c  hat are not full
-0001cd30: 7920 7574 696c 697a 6564 0a20 2020 202a  y utilized.    *
-0001cd40: 202a 2a73 6174 7572 6174 6564 3a2a 2a20   **saturated:** 
-0001cd50: 6060 7b57 6f72 6b65 7253 7461 7465 7d60  ``{WorkerState}`
-0001cd60: 603a 0a20 2020 2020 2020 2053 6574 206f  `:.        Set o
-0001cd70: 6620 776f 726b 6572 7320 7468 6174 2061  f workers that a
-0001cd80: 7265 206e 6f74 206f 7665 722d 7574 696c  re not over-util
-0001cd90: 697a 6564 0a0a 2020 2020 2a20 2a2a 686f  ized..    * **ho
-0001cda0: 7374 5f69 6e66 6f3a 2a2a 2060 607b 686f  st_info:** ``{ho
-0001cdb0: 7374 6e61 6d65 3a20 6469 6374 7d60 603a  stname: dict}``:
-0001cdc0: 0a20 2020 2020 2020 2049 6e66 6f72 6d61  .        Informa
-0001cdd0: 7469 6f6e 2061 626f 7574 2065 6163 6820  tion about each 
-0001cde0: 776f 726b 6572 2068 6f73 740a 0a20 2020  worker host..   
-0001cdf0: 202a 202a 2a63 6c69 656e 7473 3a2a 2a20   * **clients:** 
-0001ce00: 6060 7b63 6c69 656e 7420 6b65 793a 2043  ``{client key: C
-0001ce10: 6c69 656e 7453 7461 7465 7d60 600a 2020  lientState}``.  
-0001ce20: 2020 2020 2020 436c 6965 6e74 7320 6375        Clients cu
-0001ce30: 7272 656e 746c 7920 636f 6e6e 6563 7465  rrently connecte
-0001ce40: 6420 746f 2074 6865 2073 6368 6564 756c  d to the schedul
-0001ce50: 6572 0a0a 2020 2020 2a20 2a2a 7365 7276  er..    * **serv
-0001ce60: 6963 6573 3a2a 2a20 6060 7b73 7472 3a20  ices:** ``{str: 
-0001ce70: 706f 7274 7d60 603a 0a20 2020 2020 2020  port}``:.       
-0001ce80: 204f 7468 6572 2073 6572 7669 6365 7320   Other services 
-0001ce90: 7275 6e6e 696e 6720 6f6e 2074 6869 7320  running on this 
-0001cea0: 7363 6865 6475 6c65 722c 206c 696b 6520  scheduler, like 
-0001ceb0: 426f 6b65 680a 2020 2020 2a20 2a2a 6c6f  Bokeh.    * **lo
-0001cec0: 6f70 3a2a 2a20 6060 494f 4c6f 6f70 6060  op:** ``IOLoop``
-0001ced0: 3a0a 2020 2020 2020 2020 5468 6520 7275  :.        The ru
-0001cee0: 6e6e 696e 6720 546f 726e 6164 6f20 494f  nning Tornado IO
-0001cef0: 4c6f 6f70 0a20 2020 202a 202a 2a63 6c69  Loop.    * **cli
-0001cf00: 656e 745f 636f 6d6d 733a 2a2a 2060 607b  ent_comms:** ``{
-0001cf10: 636c 6965 6e74 206b 6579 3a20 436f 6d6d  client key: Comm
-0001cf20: 7d60 600a 2020 2020 2020 2020 466f 7220  }``.        For 
-0001cf30: 6561 6368 2063 6c69 656e 742c 2061 2043  each client, a C
-0001cf40: 6f6d 6d20 6f62 6a65 6374 2075 7365 6420  omm object used 
-0001cf50: 746f 2072 6563 6569 7665 2074 6173 6b20  to receive task 
-0001cf60: 7265 7175 6573 7473 2061 6e64 0a20 2020  requests and.   
-0001cf70: 2020 2020 2072 6570 6f72 7420 7461 736b       report task
-0001cf80: 2073 7461 7475 7320 7570 6461 7465 732e   status updates.
-0001cf90: 0a20 2020 202a 202a 2a73 7472 6561 6d5f  .    * **stream_
-0001cfa0: 636f 6d6d 733a 2a2a 2060 607b 776f 726b  comms:** ``{work
-0001cfb0: 6572 206b 6579 3a20 436f 6d6d 7d60 600a  er key: Comm}``.
-0001cfc0: 2020 2020 2020 2020 466f 7220 6561 6368          For each
-0001cfd0: 2077 6f72 6b65 722c 2061 2043 6f6d 6d20   worker, a Comm 
-0001cfe0: 6f62 6a65 6374 2066 726f 6d20 7768 6963  object from whic
-0001cff0: 6820 7765 2062 6f74 6820 6163 6365 7074  h we both accept
-0001d000: 2073 7469 6d75 6c69 2061 6e64 0a20 2020   stimuli and.   
-0001d010: 2020 2020 2072 6570 6f72 7420 7265 7375       report resu
-0001d020: 6c74 730a 2020 2020 2a20 2a2a 7461 736b  lts.    * **task
-0001d030: 5f64 7572 6174 696f 6e3a 2a2a 2060 607b  _duration:** ``{
-0001d040: 6b65 792d 7072 6566 6978 3a20 7469 6d65  key-prefix: time
-0001d050: 7d60 600a 2020 2020 2020 2020 5469 6d65  }``.        Time
-0001d060: 2077 6520 6578 7065 6374 2063 6572 7461   we expect certa
-0001d070: 696e 2066 756e 6374 696f 6e73 2074 6f20  in functions to 
-0001d080: 7461 6b65 2c20 652e 672e 2060 607b 2773  take, e.g. ``{'s
-0001d090: 756d 273a 2030 2e32 357d 6060 0a20 2020  um': 0.25}``.   
-0001d0a0: 2022 2222 0a0a 2020 2020 6465 6661 756c   """..    defaul
-0001d0b0: 745f 706f 7274 203d 2038 3738 360a 2020  t_port = 8786.  
-0001d0c0: 2020 5f69 6e73 7461 6e63 6573 3a20 436c    _instances: Cl
-0001d0d0: 6173 7356 6172 5b77 6561 6b72 6566 2e57  assVar[weakref.W
-0001d0e0: 6561 6b53 6574 5b53 6368 6564 756c 6572  eakSet[Scheduler
-0001d0f0: 5d5d 203d 2077 6561 6b72 6566 2e57 6561  ]] = weakref.Wea
-0001d100: 6b53 6574 2829 0a0a 2020 2020 6465 6620  kSet()..    def 
-0001d110: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
-0001d120: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0001d130: 6c6f 6f70 3d4e 6f6e 652c 0a20 2020 2020  loop=None,.     
-0001d140: 2020 2064 656c 6574 655f 696e 7465 7276     delete_interv
-0001d150: 616c 3d22 3530 306d 7322 2c0a 2020 2020  al="500ms",.    
-0001d160: 2020 2020 7379 6e63 6872 6f6e 697a 655f      synchronize_
-0001d170: 776f 726b 6572 5f69 6e74 6572 7661 6c3d  worker_interval=
-0001d180: 2236 3073 222c 0a20 2020 2020 2020 2073  "60s",.        s
-0001d190: 6572 7669 6365 733d 4e6f 6e65 2c0a 2020  ervices=None,.  
-0001d1a0: 2020 2020 2020 7365 7276 6963 655f 6b77        service_kw
-0001d1b0: 6172 6773 3d4e 6f6e 652c 0a20 2020 2020  args=None,.     
-0001d1c0: 2020 2061 6c6c 6f77 6564 5f66 6169 6c75     allowed_failu
-0001d1d0: 7265 733d 4e6f 6e65 2c0a 2020 2020 2020  res=None,.      
-0001d1e0: 2020 6578 7465 6e73 696f 6e73 3d4e 6f6e    extensions=Non
-0001d1f0: 652c 0a20 2020 2020 2020 2076 616c 6964  e,.        valid
-0001d200: 6174 653d 4e6f 6e65 2c0a 2020 2020 2020  ate=None,.      
-0001d210: 2020 7363 6865 6475 6c65 725f 6669 6c65    scheduler_file
-0001d220: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-0001d230: 6563 7572 6974 793d 4e6f 6e65 2c0a 2020  ecurity=None,.  
-0001d240: 2020 2020 2020 776f 726b 6572 5f74 746c        worker_ttl
-0001d250: 3d4e 6f6e 652c 0a20 2020 2020 2020 2069  =None,.        i
-0001d260: 646c 655f 7469 6d65 6f75 743d 4e6f 6e65  dle_timeout=None
-0001d270: 2c0a 2020 2020 2020 2020 696e 7465 7266  ,.        interf
-0001d280: 6163 653d 4e6f 6e65 2c0a 2020 2020 2020  ace=None,.      
-0001d290: 2020 686f 7374 3d4e 6f6e 652c 0a20 2020    host=None,.   
-0001d2a0: 2020 2020 2070 6f72 743d 302c 0a20 2020       port=0,.   
-0001d2b0: 2020 2020 2070 726f 746f 636f 6c3d 4e6f       protocol=No
-0001d2c0: 6e65 2c0a 2020 2020 2020 2020 6461 7368  ne,.        dash
-0001d2d0: 626f 6172 645f 6164 6472 6573 733d 4e6f  board_address=No
-0001d2e0: 6e65 2c0a 2020 2020 2020 2020 6461 7368  ne,.        dash
-0001d2f0: 626f 6172 643d 4e6f 6e65 2c0a 2020 2020  board=None,.    
-0001d300: 2020 2020 6874 7470 5f70 7265 6669 783d      http_prefix=
-0001d310: 222f 222c 0a20 2020 2020 2020 2070 7265  "/",.        pre
-0001d320: 6c6f 6164 3d4e 6f6e 652c 0a20 2020 2020  load=None,.     
-0001d330: 2020 2070 7265 6c6f 6164 5f61 7267 763d     preload_argv=
-0001d340: 2829 2c0a 2020 2020 2020 2020 706c 7567  (),.        plug
-0001d350: 696e 733d 2829 2c0a 2020 2020 2020 2020  ins=(),.        
-0001d360: 636f 6e74 6163 745f 6164 6472 6573 733d  contact_address=
-0001d370: 4e6f 6e65 2c0a 2020 2020 2020 2020 7472  None,.        tr
-0001d380: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-0001d390: 5f6d 6178 3d46 616c 7365 2c0a 2020 2020  _max=False,.    
-0001d3a0: 2020 2020 6a75 7079 7465 723d 4661 6c73      jupyter=Fals
-0001d3b0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-0001d3c0: 7267 732c 0a20 2020 2029 3a0a 2020 2020  rgs,.    ):.    
-0001d3d0: 2020 2020 6966 206c 6f6f 7020 6973 206e      if loop is n
-0001d3e0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001d3f0: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
-0001d400: 726e 280a 2020 2020 2020 2020 2020 2020  rn(.            
-0001d410: 2020 2020 2274 6865 206c 6f6f 7020 6b77      "the loop kw
-0001d420: 6172 6720 746f 2053 6368 6564 756c 6572  arg to Scheduler
-0001d430: 2069 7320 6465 7072 6563 6174 6564 222c   is deprecated",
-0001d440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d450: 2044 6570 7265 6361 7469 6f6e 5761 726e   DeprecationWarn
-0001d460: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
-0001d470: 2020 2020 2073 7461 636b 6c65 7665 6c3d       stacklevel=
-0001d480: 322c 0a20 2020 2020 2020 2020 2020 2029  2,.            )
-0001d490: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
-0001d4a0: 6f6f 7020 3d20 7365 6c66 2e69 6f5f 6c6f  oop = self.io_lo
-0001d4b0: 6f70 203d 2049 4f4c 6f6f 702e 6375 7272  op = IOLoop.curr
-0001d4c0: 656e 7428 290a 2020 2020 2020 2020 7365  ent().        se
-0001d4d0: 6c66 2e5f 7365 7475 705f 6c6f 6767 696e  lf._setup_loggin
-0001d4e0: 6728 6c6f 6767 6572 290a 0a20 2020 2020  g(logger)..     
-0001d4f0: 2020 2023 2041 7474 7269 6275 7465 730a     # Attributes.
-0001d500: 2020 2020 2020 2020 6966 2063 6f6e 7461          if conta
-0001d510: 6374 5f61 6464 7265 7373 2069 7320 4e6f  ct_address is No
-0001d520: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001d530: 636f 6e74 6163 745f 6164 6472 6573 7320  contact_address 
-0001d540: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
-0001d550: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0001d560: 6368 6564 756c 6572 2e63 6f6e 7461 6374  cheduler.contact
-0001d570: 2d61 6464 7265 7373 2229 0a20 2020 2020  -address").     
-0001d580: 2020 2073 656c 662e 636f 6e74 6163 745f     self.contact_
-0001d590: 6164 6472 6573 7320 3d20 636f 6e74 6163  address = contac
-0001d5a0: 745f 6164 6472 6573 730a 2020 2020 2020  t_address.      
-0001d5b0: 2020 6966 2061 6c6c 6f77 6564 5f66 6169    if allowed_fai
-0001d5c0: 6c75 7265 7320 6973 204e 6f6e 653a 0a20  lures is None:. 
-0001d5d0: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
-0001d5e0: 6564 5f66 6169 6c75 7265 7320 3d20 6461  ed_failures = da
-0001d5f0: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-0001d600: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0001d610: 756c 6572 2e61 6c6c 6f77 6564 2d66 6169  uler.allowed-fai
-0001d620: 6c75 7265 7322 290a 2020 2020 2020 2020  lures").        
-0001d630: 7365 6c66 2e61 6c6c 6f77 6564 5f66 6169  self.allowed_fai
-0001d640: 6c75 7265 7320 3d20 616c 6c6f 7765 645f  lures = allowed_
-0001d650: 6661 696c 7572 6573 0a20 2020 2020 2020  failures.       
-0001d660: 2069 6620 7661 6c69 6461 7465 2069 7320   if validate is 
-0001d670: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001d680: 2020 7661 6c69 6461 7465 203d 2064 6173    validate = das
-0001d690: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-0001d6a0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0001d6b0: 6c65 722e 7661 6c69 6461 7465 2229 0a20  ler.validate"). 
-0001d6c0: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
-0001d6d0: 203d 2070 7375 7469 6c2e 5072 6f63 6573   = psutil.Proces
-0001d6e0: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-0001d6f0: 2e64 656c 6574 655f 696e 7465 7276 616c  .delete_interval
-0001d700: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
-0001d710: 7461 2864 656c 6574 655f 696e 7465 7276  ta(delete_interv
-0001d720: 616c 2c20 6465 6661 756c 743d 226d 7322  al, default="ms"
-0001d730: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0001d740: 796e 6368 726f 6e69 7a65 5f77 6f72 6b65  ynchronize_worke
-0001d750: 725f 696e 7465 7276 616c 203d 2070 6172  r_interval = par
-0001d760: 7365 5f74 696d 6564 656c 7461 280a 2020  se_timedelta(.  
-0001d770: 2020 2020 2020 2020 2020 7379 6e63 6872            synchr
-0001d780: 6f6e 697a 655f 776f 726b 6572 5f69 6e74  onize_worker_int
-0001d790: 6572 7661 6c2c 2064 6566 6175 6c74 3d22  erval, default="
-0001d7a0: 6d73 220a 2020 2020 2020 2020 290a 2020  ms".        ).  
-0001d7b0: 2020 2020 2020 7365 6c66 2e73 6572 7669        self.servi
-0001d7c0: 6365 5f73 7065 6373 203d 2073 6572 7669  ce_specs = servi
-0001d7d0: 6365 7320 6f72 207b 7d0a 2020 2020 2020  ces or {}.      
-0001d7e0: 2020 7365 6c66 2e73 6572 7669 6365 5f6b    self.service_k
-0001d7f0: 7761 7267 7320 3d20 7365 7276 6963 655f  wargs = service_
-0001d800: 6b77 6172 6773 206f 7220 7b7d 0a20 2020  kwargs or {}.   
-0001d810: 2020 2020 2073 656c 662e 7365 7276 6963       self.servic
-0001d820: 6573 203d 207b 7d0a 2020 2020 2020 2020  es = {}.        
-0001d830: 7365 6c66 2e73 6368 6564 756c 6572 5f66  self.scheduler_f
-0001d840: 696c 6520 3d20 7363 6865 6475 6c65 725f  ile = scheduler_
-0001d850: 6669 6c65 0a20 2020 2020 2020 2077 6f72  file.        wor
-0001d860: 6b65 725f 7474 6c20 3d20 776f 726b 6572  ker_ttl = worker
-0001d870: 5f74 746c 206f 7220 6461 736b 2e63 6f6e  _ttl or dask.con
-0001d880: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-0001d890: 7574 6564 2e73 6368 6564 756c 6572 2e77  uted.scheduler.w
-0001d8a0: 6f72 6b65 722d 7474 6c22 290a 2020 2020  orker-ttl").    
-0001d8b0: 2020 2020 7365 6c66 2e77 6f72 6b65 725f      self.worker_
-0001d8c0: 7474 6c20 3d20 7061 7273 655f 7469 6d65  ttl = parse_time
-0001d8d0: 6465 6c74 6128 776f 726b 6572 5f74 746c  delta(worker_ttl
-0001d8e0: 2920 6966 2077 6f72 6b65 725f 7474 6c20  ) if worker_ttl 
-0001d8f0: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-0001d900: 2020 6964 6c65 5f74 696d 656f 7574 203d    idle_timeout =
-0001d910: 2069 646c 655f 7469 6d65 6f75 7420 6f72   idle_timeout or
-0001d920: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
-0001d930: 280a 2020 2020 2020 2020 2020 2020 2264  (.            "d
-0001d940: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0001d950: 756c 6572 2e69 646c 652d 7469 6d65 6f75  uler.idle-timeou
-0001d960: 7422 0a20 2020 2020 2020 2029 0a20 2020  t".        ).   
-0001d970: 2020 2020 2069 6620 6964 6c65 5f74 696d       if idle_tim
-0001d980: 656f 7574 3a0a 2020 2020 2020 2020 2020  eout:.          
-0001d990: 2020 7365 6c66 2e69 646c 655f 7469 6d65    self.idle_time
-0001d9a0: 6f75 7420 3d20 7061 7273 655f 7469 6d65  out = parse_time
-0001d9b0: 6465 6c74 6128 6964 6c65 5f74 696d 656f  delta(idle_timeo
-0001d9c0: 7574 290a 2020 2020 2020 2020 656c 7365  ut).        else
-0001d9d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001d9e0: 6c66 2e69 646c 655f 7469 6d65 6f75 7420  lf.idle_timeout 
-0001d9f0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-0001da00: 656c 662e 6964 6c65 5f73 696e 6365 203d  elf.idle_since =
-0001da10: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
-0001da20: 7365 6c66 2e74 696d 655f 7374 6172 7465  self.time_starte
-0001da30: 6420 3d20 7365 6c66 2e69 646c 655f 7369  d = self.idle_si
-0001da40: 6e63 6520 2023 2063 6f6d 7061 7469 6269  nce  # compatibi
-0001da50: 6c69 7479 2066 6f72 2064 6173 6b2d 6761  lity for dask-ga
-0001da60: 7465 7761 790a 2020 2020 2020 2020 7365  teway.        se
-0001da70: 6c66 2e5f 6c6f 636b 203d 2061 7379 6e63  lf._lock = async
-0001da80: 696f 2e4c 6f63 6b28 290a 2020 2020 2020  io.Lock().      
-0001da90: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
-0001daa0: 5f77 6f72 6b65 7273 203d 2064 6566 6175  _workers = defau
-0001dab0: 6c74 6469 6374 2866 6c6f 6174 290a 2020  ltdict(float).  
-0001dac0: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
-0001dad0: 6964 7468 5f74 7970 6573 203d 2064 6566  idth_types = def
-0001dae0: 6175 6c74 6469 6374 2866 6c6f 6174 290a  aultdict(float).
-0001daf0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0001db00: 7072 656c 6f61 643a 0a20 2020 2020 2020  preload:.       
-0001db10: 2020 2020 2070 7265 6c6f 6164 203d 2064       preload = d
-0001db20: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-0001db30: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-0001db40: 6475 6c65 722e 7072 656c 6f61 6422 290a  duler.preload").
-0001db50: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
-0001db60: 7265 6c6f 6164 5f61 7267 763a 0a20 2020  reload_argv:.   
-0001db70: 2020 2020 2020 2020 2070 7265 6c6f 6164           preload
-0001db80: 5f61 7267 7620 3d20 6461 736b 2e63 6f6e  _argv = dask.con
-0001db90: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-0001dba0: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
-0001dbb0: 7265 6c6f 6164 2d61 7267 7622 290a 2020  reload-argv").  
-0001dbc0: 2020 2020 2020 7365 6c66 2e70 7265 6c6f        self.prelo
-0001dbd0: 6164 7320 3d20 7072 656c 6f61 6469 6e67  ads = preloading
-0001dbe0: 2e70 726f 6365 7373 5f70 7265 6c6f 6164  .process_preload
-0001dbf0: 7328 7365 6c66 2c20 7072 656c 6f61 642c  s(self, preload,
-0001dc00: 2070 7265 6c6f 6164 5f61 7267 7629 0a0a   preload_argv)..
-0001dc10: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001dc20: 7461 6e63 6528 7365 6375 7269 7479 2c20  tance(security, 
-0001dc30: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
-0001dc40: 2020 2073 6563 7572 6974 7920 3d20 5365     security = Se
-0001dc50: 6375 7269 7479 282a 2a73 6563 7572 6974  curity(**securit
-0001dc60: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
-0001dc70: 7365 6375 7269 7479 203d 2073 6563 7572  security = secur
-0001dc80: 6974 7920 6f72 2053 6563 7572 6974 7928  ity or Security(
-0001dc90: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0001dca0: 2069 7369 6e73 7461 6e63 6528 7365 6c66   isinstance(self
-0001dcb0: 2e73 6563 7572 6974 792c 2053 6563 7572  .security, Secur
-0001dcc0: 6974 7929 0a20 2020 2020 2020 2073 656c  ity).        sel
-0001dcd0: 662e 636f 6e6e 6563 7469 6f6e 5f61 7267  f.connection_arg
-0001dce0: 7320 3d20 7365 6c66 2e73 6563 7572 6974  s = self.securit
-0001dcf0: 792e 6765 745f 636f 6e6e 6563 7469 6f6e  y.get_connection
-0001dd00: 5f61 7267 7328 2273 6368 6564 756c 6572  _args("scheduler
-0001dd10: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-0001dd20: 636f 6e6e 6563 7469 6f6e 5f61 7267 735b  connection_args[
-0001dd30: 2268 616e 6473 6861 6b65 5f6f 7665 7272  "handshake_overr
-0001dd40: 6964 6573 225d 203d 207b 2020 2320 636f  ides"] = {  # co
-0001dd50: 6d6d 6f6e 2064 656e 6f6d 696e 6174 6f72  mmon denominator
-0001dd60: 0a20 2020 2020 2020 2020 2020 2022 7069  .            "pi
-0001dd70: 636b 6c65 2d70 726f 746f 636f 6c22 3a20  ckle-protocol": 
-0001dd80: 340a 2020 2020 2020 2020 7d0a 0a20 2020  4.        }..   
-0001dd90: 2020 2020 2073 656c 662e 5f73 7461 7274       self._start
-0001dda0: 5f61 6464 7265 7373 203d 2061 6464 7265  _address = addre
-0001ddb0: 7373 6573 5f66 726f 6d5f 7573 6572 5f61  sses_from_user_a
-0001ddc0: 7267 7328 0a20 2020 2020 2020 2020 2020  rgs(.           
-0001ddd0: 2068 6f73 743d 686f 7374 2c0a 2020 2020   host=host,.    
-0001dde0: 2020 2020 2020 2020 706f 7274 3d70 6f72          port=por
-0001ddf0: 742c 0a20 2020 2020 2020 2020 2020 2069  t,.            i
-0001de00: 6e74 6572 6661 6365 3d69 6e74 6572 6661  nterface=interfa
-0001de10: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-0001de20: 7072 6f74 6f63 6f6c 3d70 726f 746f 636f  protocol=protoco
-0001de30: 6c2c 0a20 2020 2020 2020 2020 2020 2073  l,.            s
-0001de40: 6563 7572 6974 793d 7365 6375 7269 7479  ecurity=security
-0001de50: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
-0001de60: 6661 756c 745f 706f 7274 3d73 656c 662e  fault_port=self.
-0001de70: 6465 6661 756c 745f 706f 7274 2c0a 2020  default_port,.  
-0001de80: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001de90: 2068 7474 705f 7365 7276 6572 5f6d 6f64   http_server_mod
-0001dea0: 756c 6573 203d 2064 6173 6b2e 636f 6e66  ules = dask.conf
-0001deb0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-0001dec0: 7465 642e 7363 6865 6475 6c65 722e 6874  ted.scheduler.ht
-0001ded0: 7470 2e72 6f75 7465 7322 290a 2020 2020  tp.routes").    
-0001dee0: 2020 2020 7368 6f77 5f64 6173 6862 6f61      show_dashboa
-0001def0: 7264 203d 2064 6173 6862 6f61 7264 206f  rd = dashboard o
-0001df00: 7220 2864 6173 6862 6f61 7264 2069 7320  r (dashboard is 
-0001df10: 4e6f 6e65 2061 6e64 2064 6173 6862 6f61  None and dashboa
-0001df20: 7264 5f61 6464 7265 7373 290a 2020 2020  rd_address).    
-0001df30: 2020 2020 2320 696e 7374 616c 6c20 7661      # install va
-0001df40: 6e69 6c6c 6120 726f 7574 6520 6966 2073  nilla route if s
-0001df50: 686f 775f 6461 7368 626f 6172 6420 6275  how_dashboard bu
-0001df60: 7420 626f 6b65 6820 6973 206e 6f74 2069  t bokeh is not i
-0001df70: 6e73 7461 6c6c 6564 0a20 2020 2020 2020  nstalled.       
-0001df80: 2069 6620 7368 6f77 5f64 6173 6862 6f61   if show_dashboa
-0001df90: 7264 3a0a 2020 2020 2020 2020 2020 2020  rd:.            
-0001dfa0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0001dfb0: 2020 2020 2069 6d70 6f72 7420 6469 7374       import dist
-0001dfc0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
-0001dfd0: 642e 7363 6865 6475 6c65 720a 2020 2020  d.scheduler.    
-0001dfe0: 2020 2020 2020 2020 6578 6365 7074 2049          except I
-0001dff0: 6d70 6f72 7445 7272 6f72 3a0a 2020 2020  mportError:.    
-0001e000: 2020 2020 2020 2020 2020 2020 7368 6f77              show
-0001e010: 5f64 6173 6862 6f61 7264 203d 2046 616c  _dashboard = Fal
-0001e020: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0001e030: 2020 2068 7474 705f 7365 7276 6572 5f6d     http_server_m
-0001e040: 6f64 756c 6573 2e61 7070 656e 6428 2264  odules.append("d
-0001e050: 6973 7472 6962 7574 6564 2e68 7474 702e  istributed.http.
-0001e060: 7363 6865 6475 6c65 722e 6d69 7373 696e  scheduler.missin
-0001e070: 675f 626f 6b65 6822 290a 2020 2020 2020  g_bokeh").      
-0001e080: 2020 726f 7574 6573 203d 2067 6574 5f68    routes = get_h
-0001e090: 616e 646c 6572 7328 0a20 2020 2020 2020  andlers(.       
-0001e0a0: 2020 2020 2073 6572 7665 723d 7365 6c66       server=self
-0001e0b0: 2c20 6d6f 6475 6c65 733d 6874 7470 5f73  , modules=http_s
-0001e0c0: 6572 7665 725f 6d6f 6475 6c65 732c 2070  erver_modules, p
-0001e0d0: 7265 6669 783d 6874 7470 5f70 7265 6669  refix=http_prefi
-0001e0e0: 780a 2020 2020 2020 2020 290a 2020 2020  x.        ).    
-0001e0f0: 2020 2020 7365 6c66 2e73 7461 7274 5f68      self.start_h
-0001e100: 7474 705f 7365 7276 6572 2872 6f75 7465  ttp_server(route
-0001e110: 732c 2064 6173 6862 6f61 7264 5f61 6464  s, dashboard_add
-0001e120: 7265 7373 2c20 6465 6661 756c 745f 706f  ress, default_po
-0001e130: 7274 3d38 3738 3729 0a20 2020 2020 2020  rt=8787).       
-0001e140: 2073 656c 662e 6a75 7079 7465 7220 3d20   self.jupyter = 
-0001e150: 6a75 7079 7465 720a 2020 2020 2020 2020  jupyter.        
-0001e160: 6966 2073 686f 775f 6461 7368 626f 6172  if show_dashboar
-0001e170: 643a 0a20 2020 2020 2020 2020 2020 2064  d:.            d
-0001e180: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
-0001e190: 6f61 7264 2e73 6368 6564 756c 6572 2e63  oard.scheduler.c
-0001e1a0: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
-0001e1b0: 2020 2020 2020 2020 7365 6c66 2e68 7474          self.htt
-0001e1c0: 705f 6170 706c 6963 6174 696f 6e2c 2073  p_application, s
-0001e1d0: 656c 662e 6874 7470 5f73 6572 7665 722c  elf.http_server,
-0001e1e0: 2073 656c 662c 2070 7265 6669 783d 6874   self, prefix=ht
-0001e1f0: 7470 5f70 7265 6669 780a 2020 2020 2020  tp_prefix.      
-0001e200: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001e210: 6966 2073 656c 662e 6a75 7079 7465 723a  if self.jupyter:
-0001e220: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-0001e230: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e240: 2020 6672 6f6d 206a 7570 7974 6572 5f73    from jupyter_s
-0001e250: 6572 7665 722e 7365 7276 6572 6170 7020  erver.serverapp 
-0001e260: 696d 706f 7274 2053 6572 7665 7241 7070  import ServerApp
-0001e270: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0001e280: 6570 7420 496d 706f 7274 4572 726f 723a  ept ImportError:
-0001e290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e2a0: 2072 6169 7365 2049 6d70 6f72 7445 7272   raise ImportErr
-0001e2b0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0001e2c0: 2020 2020 2020 2020 2249 6e20 6f72 6465          "In orde
-0001e2d0: 7220 746f 2075 7365 2074 6865 2044 6173  r to use the Das
-0001e2e0: 6b20 6a75 7079 7465 7220 6f70 7469 6f6e  k jupyter option
-0001e2f0: 2079 6f75 2022 0a20 2020 2020 2020 2020   you ".         
-0001e300: 2020 2020 2020 2020 2020 2022 6e65 6564             "need
-0001e310: 2074 6f20 6861 7665 206a 7570 7974 6572   to have jupyter
-0001e320: 6c61 6220 696e 7374 616c 6c65 6422 0a20  lab installed". 
-0001e330: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001e340: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-0001e350: 6d20 7472 6169 746c 6574 732e 636f 6e66  m traitlets.conf
-0001e360: 6967 2069 6d70 6f72 7420 436f 6e66 6967  ig import Config
-0001e370: 0a0a 2020 2020 2020 2020 2020 2020 6a20  ..            j 
-0001e380: 3d20 5365 7276 6572 4170 702e 696e 7374  = ServerApp.inst
-0001e390: 616e 6365 280a 2020 2020 2020 2020 2020  ance(.          
-0001e3a0: 2020 2020 2020 636f 6e66 6967 3d43 6f6e        config=Con
-0001e3b0: 6669 6728 0a20 2020 2020 2020 2020 2020  fig(.           
-0001e3c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0001e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3e0: 2020 2022 5365 7276 6572 4170 7022 3a20     "ServerApp": 
-0001e3f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0001e400: 2020 2020 2020 2020 2020 2020 2020 2262                "b
-0001e410: 6173 655f 7572 6c22 3a20 226a 7570 7974  ase_url": "jupyt
-0001e420: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
-0001e430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e440: 2023 2053 4543 5552 4954 593a 2057 6520   # SECURITY: We 
-0001e450: 7573 7561 6c6c 7920 6578 7065 6374 2074  usually expect t
-0001e460: 6865 2064 6173 6862 6f61 7264 2074 6f20  he dashboard to 
-0001e470: 6265 2061 2072 6561 642d 6f6e 6c79 2076  be a read-only v
-0001e480: 6965 7720 696e 746f 0a20 2020 2020 2020  iew into.       
-0001e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4a0: 2020 2020 2023 2074 6865 2073 6368 6564       # the sched
-0001e4b0: 756c 6572 2061 6374 6976 6974 792e 2048  uler activity. H
-0001e4c0: 6f77 6576 6572 2c20 6279 2061 6464 696e  owever, by addin
-0001e4d0: 6720 616e 206f 7065 6e20 4a75 7079 7465  g an open Jupyte
-0001e4e0: 7220 6170 706c 6963 6174 696f 6e0a 2020  r application.  
-0001e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e500: 2020 2020 2020 2020 2020 2320 7765 2061            # we a
-0001e510: 7265 2061 6c6c 6f77 696e 6720 6172 6269  re allowing arbi
-0001e520: 7472 6172 7920 7265 6d6f 7465 2063 6f64  trary remote cod
-0001e530: 6520 6578 6563 7574 696f 6e20 6f6e 2074  e execution on t
-0001e540: 6865 2073 6368 6564 756c 6572 2076 6961  he scheduler via
-0001e550: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0001bf70: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+0001bf80: 7473 2e6b 6579 5d20 3d20 2266 6f72 676f  ts.key] = "forgo
+0001bf90: 7474 656e 220a 2020 2020 2020 2020 2020  tten".          
+0001bfa0: 2020 2020 2020 2020 2020 656c 6966 2074            elif t
+0001bfb0: 732e 7374 6174 6520 213d 2022 6572 7265  s.state != "erre
+0001bfc0: 6422 2061 6e64 206e 6f74 2074 732e 7761  d" and not ts.wa
+0001bfd0: 6974 6572 733a 0a20 2020 2020 2020 2020  iters:.         
+0001bfe0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001bff0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b74  ecommendations[t
+0001c000: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
+0001c010: 6564 220a 0a20 2020 2064 6566 205f 7461  ed"..    def _ta
+0001c020: 736b 5f74 6f5f 6d73 6728 7365 6c66 2c20  sk_to_msg(self, 
+0001c030: 7473 3a20 5461 736b 5374 6174 652c 2064  ts: TaskState, d
+0001c040: 7572 6174 696f 6e3a 2066 6c6f 6174 203d  uration: float =
+0001c050: 202d 3129 202d 3e20 6469 6374 5b73 7472   -1) -> dict[str
+0001c060: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
+0001c070: 2222 2243 6f6e 7665 7274 2061 2073 696e  """Convert a sin
+0001c080: 676c 6520 636f 6d70 7574 6174 696f 6e61  gle computationa
+0001c090: 6c20 7461 736b 2074 6f20 6120 6d65 7373  l task to a mess
+0001c0a0: 6167 6522 2222 0a20 2020 2020 2020 2023  age""".        #
+0001c0b0: 2046 4958 4d45 3a20 5468 6520 6475 7261   FIXME: The dura
+0001c0c0: 7469 6f6e 2061 7474 7269 6275 7465 2069  tion attribute i
+0001c0d0: 7320 6e6f 7420 7573 6564 206f 6e20 776f  s not used on wo
+0001c0e0: 726b 6572 2e20 5765 2063 6f75 6c64 2073  rker. We could s
+0001c0f0: 6176 6520 6f75 7273 656c 7665 7320 7468  ave ourselves th
+0001c100: 650a 2020 2020 2020 2020 2320 2020 2020  e.        #     
+0001c110: 2020 2074 696d 6520 746f 2063 6f6d 7075     time to compu
+0001c120: 7465 2061 6e64 2073 7562 6d69 7420 7468  te and submit th
+0001c130: 6973 0a20 2020 2020 2020 2069 6620 6475  is.        if du
+0001c140: 7261 7469 6f6e 203c 2030 3a0a 2020 2020  ration < 0:.    
+0001c150: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
+0001c160: 203d 2073 656c 662e 6765 745f 7461 736b   = self.get_task
+0001c170: 5f64 7572 6174 696f 6e28 7473 290a 2020  _duration(ts).  
+0001c180: 2020 2020 2020 7473 2e72 756e 5f69 6420        ts.run_id 
+0001c190: 3d20 6e65 7874 2854 6173 6b53 7461 7465  = next(TaskState
+0001c1a0: 2e5f 7275 6e5f 6964 5f69 7465 7261 746f  ._run_id_iterato
+0001c1b0: 7229 0a20 2020 2020 2020 2061 7373 6572  r).        asser
+0001c1c0: 7420 7473 2e70 7269 6f72 6974 792c 2074  t ts.priority, t
+0001c1d0: 730a 2020 2020 2020 2020 6d73 673a 2064  s.        msg: d
+0001c1e0: 6963 745b 7374 722c 2041 6e79 5d20 3d20  ict[str, Any] = 
+0001c1f0: 7b0a 2020 2020 2020 2020 2020 2020 226f  {.            "o
+0001c200: 7022 3a20 2263 6f6d 7075 7465 2d74 6173  p": "compute-tas
+0001c210: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
+0001c220: 226b 6579 223a 2074 732e 6b65 792c 0a20  "key": ts.key,. 
+0001c230: 2020 2020 2020 2020 2020 2022 7275 6e5f             "run_
+0001c240: 6964 223a 2074 732e 7275 6e5f 6964 2c0a  id": ts.run_id,.
+0001c250: 2020 2020 2020 2020 2020 2020 2270 7269              "pri
+0001c260: 6f72 6974 7922 3a20 7473 2e70 7269 6f72  ority": ts.prior
+0001c270: 6974 792c 0a20 2020 2020 2020 2020 2020  ity,.           
+0001c280: 2022 6475 7261 7469 6f6e 223a 2064 7572   "duration": dur
+0001c290: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
+0001c2a0: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
+0001c2b0: 3a20 6622 636f 6d70 7574 652d 7461 736b  : f"compute-task
+0001c2c0: 2d7b 7469 6d65 2829 7d22 2c0a 2020 2020  -{time()}",.    
+0001c2d0: 2020 2020 2020 2020 2277 686f 5f68 6173          "who_has
+0001c2e0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+0001c2f0: 2020 2020 2064 7473 2e6b 6579 3a20 5b77       dts.key: [w
+0001c300: 732e 6164 6472 6573 7320 666f 7220 7773  s.address for ws
+0001c310: 2069 6e20 6474 732e 7768 6f5f 6861 735d   in dts.who_has]
+0001c320: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+0001c330: 6570 656e 6465 6e63 6965 730a 2020 2020  ependencies.    
+0001c340: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+0001c350: 2020 2020 2020 2022 6e62 7974 6573 223a         "nbytes":
+0001c360: 207b 6474 732e 6b65 793a 2064 7473 2e6e   {dts.key: dts.n
+0001c370: 6279 7465 7320 666f 7220 6474 7320 696e  bytes for dts in
+0001c380: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+0001c390: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
+0001c3a0: 7275 6e5f 7370 6563 223a 204e 6f6e 652c  run_spec": None,
+0001c3b0: 0a20 2020 2020 2020 2020 2020 2022 6675  .            "fu
+0001c3c0: 6e63 7469 6f6e 223a 204e 6f6e 652c 0a20  nction": None,. 
+0001c3d0: 2020 2020 2020 2020 2020 2022 6172 6773             "args
+0001c3e0: 223a 204e 6f6e 652c 0a20 2020 2020 2020  ": None,.       
+0001c3f0: 2020 2020 2022 6b77 6172 6773 223a 204e       "kwargs": N
+0001c400: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0001c410: 2022 7265 736f 7572 6365 5f72 6573 7472   "resource_restr
+0001c420: 6963 7469 6f6e 7322 3a20 7473 2e72 6573  ictions": ts.res
+0001c430: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+0001c440: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+0001c450: 2261 6374 6f72 223a 2074 732e 6163 746f  "actor": ts.acto
+0001c460: 722c 0a20 2020 2020 2020 2020 2020 2022  r,.            "
+0001c470: 616e 6e6f 7461 7469 6f6e 7322 3a20 7473  annotations": ts
+0001c480: 2e61 6e6e 6f74 6174 696f 6e73 2c0a 2020  .annotations,.  
+0001c490: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0001c4a0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+0001c4b0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+0001c4c0: 7365 7274 2061 6c6c 286d 7367 5b22 7768  sert all(msg["wh
+0001c4d0: 6f5f 6861 7322 5d2e 7661 6c75 6573 2829  o_has"].values()
+0001c4e0: 290a 0a20 2020 2020 2020 2069 6620 6973  )..        if is
+0001c4f0: 696e 7374 616e 6365 2874 732e 7275 6e5f  instance(ts.run_
+0001c500: 7370 6563 2c20 6469 6374 293a 0a20 2020  spec, dict):.   
+0001c510: 2020 2020 2020 2020 206d 7367 2e75 7064           msg.upd
+0001c520: 6174 6528 7473 2e72 756e 5f73 7065 6329  ate(ts.run_spec)
+0001c530: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001c540: 2020 2020 2020 2020 2020 206d 7367 5b22             msg["
+0001c550: 7275 6e5f 7370 6563 225d 203d 2074 732e  run_spec"] = ts.
+0001c560: 7275 6e5f 7370 6563 0a0a 2020 2020 2020  run_spec..      
+0001c570: 2020 7265 7475 726e 206d 7367 0a0a 0a63    return msg...c
+0001c580: 6c61 7373 2053 6368 6564 756c 6572 2853  lass Scheduler(S
+0001c590: 6368 6564 756c 6572 5374 6174 652c 2053  chedulerState, S
+0001c5a0: 6572 7665 724e 6f64 6529 3a0a 2020 2020  erverNode):.    
+0001c5b0: 2222 2244 796e 616d 6963 2064 6973 7472  """Dynamic distr
+0001c5c0: 6962 7574 6564 2074 6173 6b20 7363 6865  ibuted task sche
+0001c5d0: 6475 6c65 720a 0a20 2020 2054 6865 2073  duler..    The s
+0001c5e0: 6368 6564 756c 6572 2074 7261 636b 7320  cheduler tracks 
+0001c5f0: 7468 6520 6375 7272 656e 7420 7374 6174  the current stat
+0001c600: 6520 6f66 2077 6f72 6b65 7273 2c20 6461  e of workers, da
+0001c610: 7461 2c20 616e 6420 636f 6d70 7574 6174  ta, and computat
+0001c620: 696f 6e73 2e0a 2020 2020 5468 6520 7363  ions..    The sc
+0001c630: 6865 6475 6c65 7220 6c69 7374 656e 7320  heduler listens 
+0001c640: 666f 7220 6576 656e 7473 2061 6e64 2072  for events and r
+0001c650: 6573 706f 6e64 7320 6279 2063 6f6e 7472  esponds by contr
+0001c660: 6f6c 6c69 6e67 2077 6f72 6b65 7273 0a20  olling workers. 
+0001c670: 2020 2061 7070 726f 7072 6961 7465 6c79     appropriately
+0001c680: 2e20 2049 7420 636f 6e74 696e 756f 7573  .  It continuous
+0001c690: 6c79 2074 7269 6573 2074 6f20 7573 6520  ly tries to use 
+0001c6a0: 7468 6520 776f 726b 6572 7320 746f 2065  the workers to e
+0001c6b0: 7865 6375 7465 2061 6e20 6576 6572 0a20  xecute an ever. 
+0001c6c0: 2020 2067 726f 7769 6e67 2064 6173 6b20     growing dask 
+0001c6d0: 6772 6170 682e 0a0a 2020 2020 416c 6c20  graph...    All 
+0001c6e0: 6576 656e 7473 2061 7265 2068 616e 646c  events are handl
+0001c6f0: 6564 2071 7569 636b 6c79 2c20 696e 206c  ed quickly, in l
+0001c700: 696e 6561 7220 7469 6d65 2077 6974 6820  inear time with 
+0001c710: 7265 7370 6563 7420 746f 2074 6865 6972  respect to their
+0001c720: 2069 6e70 7574 0a20 2020 2028 7768 6963   input.    (whic
+0001c730: 6820 6973 206f 6674 656e 206f 6620 636f  h is often of co
+0001c740: 6e73 7461 6e74 2073 697a 6529 2061 6e64  nstant size) and
+0001c750: 2067 656e 6572 616c 6c79 2077 6974 6869   generally withi
+0001c760: 6e20 6120 6d69 6c6c 6973 6563 6f6e 642e  n a millisecond.
+0001c770: 2020 546f 0a20 2020 2061 6363 6f6d 706c    To.    accompl
+0001c780: 6973 6820 7468 6973 2074 6865 2073 6368  ish this the sch
+0001c790: 6564 756c 6572 2074 7261 636b 7320 6120  eduler tracks a 
+0001c7a0: 6c6f 7420 6f66 2073 7461 7465 2e20 2045  lot of state.  E
+0001c7b0: 7665 7279 206f 7065 7261 7469 6f6e 0a20  very operation. 
+0001c7c0: 2020 206d 6169 6e74 6169 6e73 2074 6865     maintains the
+0001c7d0: 2063 6f6e 7369 7374 656e 6379 206f 6620   consistency of 
+0001c7e0: 7468 6973 2073 7461 7465 2e0a 0a20 2020  this state...   
+0001c7f0: 2054 6865 2073 6368 6564 756c 6572 2063   The scheduler c
+0001c800: 6f6d 6d75 6e69 6361 7465 7320 7769 7468  ommunicates with
+0001c810: 2074 6865 206f 7574 7369 6465 2077 6f72   the outside wor
+0001c820: 6c64 2074 6872 6f75 6768 2043 6f6d 6d20  ld through Comm 
+0001c830: 6f62 6a65 6374 732e 0a20 2020 2049 7420  objects..    It 
+0001c840: 6d61 696e 7461 696e 7320 6120 636f 6e73  maintains a cons
+0001c850: 6973 7465 6e74 2061 6e64 2076 616c 6964  istent and valid
+0001c860: 2076 6965 7720 6f66 2074 6865 2077 6f72   view of the wor
+0001c870: 6c64 2065 7665 6e20 7768 656e 206c 6973  ld even when lis
+0001c880: 7465 6e69 6e67 0a20 2020 2074 6f20 7365  tening.    to se
+0001c890: 7665 7261 6c20 636c 6965 6e74 7320 6174  veral clients at
+0001c8a0: 206f 6e63 652e 0a0a 2020 2020 4120 5363   once...    A Sc
+0001c8b0: 6865 6475 6c65 7220 6973 2074 7970 6963  heduler is typic
+0001c8c0: 616c 6c79 2073 7461 7274 6564 2065 6974  ally started eit
+0001c8d0: 6865 7220 7769 7468 2074 6865 2060 6064  her with the ``d
+0001c8e0: 6173 6b20 7363 6865 6475 6c65 7260 600a  ask scheduler``.
+0001c8f0: 2020 2020 6578 6563 7574 6162 6c65 3a3a      executable::
+0001c900: 0a0a 2020 2020 2020 2020 2024 2064 6173  ..         $ das
+0001c910: 6b20 7363 6865 6475 6c65 720a 2020 2020  k scheduler.    
+0001c920: 2020 2020 2053 6368 6564 756c 6572 2073       Scheduler s
+0001c930: 7461 7274 6564 2061 7420 3132 372e 302e  tarted at 127.0.
+0001c940: 302e 313a 3837 3836 0a0a 2020 2020 4f72  0.1:8786..    Or
+0001c950: 2077 6974 6869 6e20 6120 4c6f 6361 6c43   within a LocalC
+0001c960: 6c75 7374 6572 2061 2043 6c69 656e 7420  luster a Client 
+0001c970: 7374 6172 7473 2075 7020 7769 7468 6f75  starts up withou
+0001c980: 7420 636f 6e6e 6563 7469 6f6e 0a20 2020  t connection.   
+0001c990: 2069 6e66 6f72 6d61 7469 6f6e 3a3a 0a0a   information::..
+0001c9a0: 2020 2020 2020 2020 3e3e 3e20 6320 3d20          >>> c = 
+0001c9b0: 436c 6965 6e74 2829 2020 2320 646f 6374  Client()  # doct
+0001c9c0: 6573 743a 202b 534b 4950 0a20 2020 2020  est: +SKIP.     
+0001c9d0: 2020 203e 3e3e 2063 2e63 6c75 7374 6572     >>> c.cluster
+0001c9e0: 2e73 6368 6564 756c 6572 2020 2320 646f  .scheduler  # do
+0001c9f0: 6374 6573 743a 202b 534b 4950 0a20 2020  ctest: +SKIP.   
+0001ca00: 2020 2020 2053 6368 6564 756c 6572 282e       Scheduler(.
+0001ca10: 2e2e 290a 0a20 2020 2055 7365 7273 2074  ..)..    Users t
+0001ca20: 7970 6963 616c 6c79 2064 6f20 6e6f 7420  ypically do not 
+0001ca30: 696e 7465 7261 6374 2077 6974 6820 7468  interact with th
+0001ca40: 6520 7363 6865 6475 6c65 7220 6469 7265  e scheduler dire
+0001ca50: 6374 6c79 2062 7574 2072 6174 6865 7220  ctly but rather 
+0001ca60: 7769 7468 0a20 2020 2074 6865 2063 6c69  with.    the cli
+0001ca70: 656e 7420 6f62 6a65 6374 2060 6043 6c69  ent object ``Cli
+0001ca80: 656e 7460 602e 0a0a 2020 2020 5468 6520  ent``...    The 
+0001ca90: 6060 636f 6e74 6163 745f 6164 6472 6573  ``contact_addres
+0001caa0: 7360 6020 7061 7261 6d65 7465 7220 616c  s`` parameter al
+0001cab0: 6c6f 7773 2074 6f20 6164 7665 7274 6973  lows to advertis
+0001cac0: 6520 6120 7370 6563 6966 6963 2061 6464  e a specific add
+0001cad0: 7265 7373 2074 6f0a 2020 2020 7468 6520  ress to.    the 
+0001cae0: 776f 726b 6572 7320 666f 7220 636f 6d6d  workers for comm
+0001caf0: 756e 6963 6174 696f 6e20 7769 7468 2074  unication with t
+0001cb00: 6865 2073 6368 6564 756c 6572 2c20 7768  he scheduler, wh
+0001cb10: 6963 6820 6973 2064 6966 6665 7265 6e74  ich is different
+0001cb20: 2074 6861 6e0a 2020 2020 7468 6520 6164   than.    the ad
+0001cb30: 6472 6573 7320 7468 6520 7363 6865 6475  dress the schedu
+0001cb40: 6c65 7220 6269 6e64 7320 746f 2e20 5468  ler binds to. Th
+0001cb50: 6973 2069 7320 7573 6566 756c 2077 6865  is is useful whe
+0001cb60: 6e20 7468 6520 7363 6865 6475 6c65 720a  n the scheduler.
+0001cb70: 2020 2020 6c69 7374 656e 7320 6f6e 2061      listens on a
+0001cb80: 2070 7269 7661 7465 2061 6464 7265 7373   private address
+0001cb90: 2c20 7768 6963 6820 7468 6572 6566 6f72  , which therefor
+0001cba0: 6520 6361 6e6e 6f74 2062 6520 7573 6564  e cannot be used
+0001cbb0: 2062 7920 7468 6520 776f 726b 6572 730a   by the workers.
+0001cbc0: 2020 2020 746f 2063 6f6e 7461 6374 2069      to contact i
+0001cbd0: 742e 0a0a 2020 2020 2a2a 5374 6174 652a  t...    **State*
+0001cbe0: 2a0a 0a20 2020 2054 6865 2073 6368 6564  *..    The sched
+0001cbf0: 756c 6572 2063 6f6e 7461 696e 7320 7468  uler contains th
+0001cc00: 6520 666f 6c6c 6f77 696e 6720 7374 6174  e following stat
+0001cc10: 6520 7661 7269 6162 6c65 732e 2020 4561  e variables.  Ea
+0001cc20: 6368 2076 6172 6961 626c 6520 6973 0a20  ch variable is. 
+0001cc30: 2020 206c 6973 7465 6420 616c 6f6e 6720     listed along 
+0001cc40: 7769 7468 2077 6861 7420 6974 2073 746f  with what it sto
+0001cc50: 7265 7320 616e 6420 6120 6272 6965 6620  res and a brief 
+0001cc60: 6465 7363 7269 7074 696f 6e2e 0a0a 2020  description...  
+0001cc70: 2020 2a20 2a2a 7461 736b 733a 2a2a 2060    * **tasks:** `
+0001cc80: 607b 7461 736b 206b 6579 3a20 5461 736b  `{task key: Task
+0001cc90: 5374 6174 657d 6060 0a20 2020 2020 2020  State}``.       
+0001cca0: 2054 6173 6b73 2063 7572 7265 6e74 6c79   Tasks currently
+0001ccb0: 206b 6e6f 776e 2074 6f20 7468 6520 7363   known to the sc
+0001ccc0: 6865 6475 6c65 720a 2020 2020 2a20 2a2a  heduler.    * **
+0001ccd0: 756e 7275 6e6e 6162 6c65 3a2a 2a20 6060  unrunnable:** ``
+0001cce0: 7b54 6173 6b53 7461 7465 7d60 600a 2020  {TaskState}``.  
+0001ccf0: 2020 2020 2020 5461 736b 7320 696e 2074        Tasks in t
+0001cd00: 6865 2022 6e6f 2d77 6f72 6b65 7222 2073  he "no-worker" s
+0001cd10: 7461 7465 0a0a 2020 2020 2a20 2a2a 776f  tate..    * **wo
+0001cd20: 726b 6572 733a 2a2a 2060 607b 776f 726b  rkers:** ``{work
+0001cd30: 6572 206b 6579 3a20 576f 726b 6572 5374  er key: WorkerSt
+0001cd40: 6174 657d 6060 0a20 2020 2020 2020 2057  ate}``.        W
+0001cd50: 6f72 6b65 7273 2063 7572 7265 6e74 6c79  orkers currently
+0001cd60: 2063 6f6e 6e65 6374 6564 2074 6f20 7468   connected to th
+0001cd70: 6520 7363 6865 6475 6c65 720a 2020 2020  e scheduler.    
+0001cd80: 2a20 2a2a 6964 6c65 3a2a 2a20 6060 7b57  * **idle:** ``{W
+0001cd90: 6f72 6b65 7253 7461 7465 7d60 603a 0a20  orkerState}``:. 
+0001cda0: 2020 2020 2020 2053 6574 206f 6620 776f         Set of wo
+0001cdb0: 726b 6572 7320 7468 6174 2061 7265 206e  rkers that are n
+0001cdc0: 6f74 2066 756c 6c79 2075 7469 6c69 7a65  ot fully utilize
+0001cdd0: 640a 2020 2020 2a20 2a2a 7361 7475 7261  d.    * **satura
+0001cde0: 7465 643a 2a2a 2060 607b 576f 726b 6572  ted:** ``{Worker
+0001cdf0: 5374 6174 657d 6060 3a0a 2020 2020 2020  State}``:.      
+0001ce00: 2020 5365 7420 6f66 2077 6f72 6b65 7273    Set of workers
+0001ce10: 2074 6861 7420 6172 6520 6e6f 7420 6f76   that are not ov
+0001ce20: 6572 2d75 7469 6c69 7a65 640a 0a20 2020  er-utilized..   
+0001ce30: 202a 202a 2a68 6f73 745f 696e 666f 3a2a   * **host_info:*
+0001ce40: 2a20 6060 7b68 6f73 746e 616d 653a 2064  * ``{hostname: d
+0001ce50: 6963 747d 6060 3a0a 2020 2020 2020 2020  ict}``:.        
+0001ce60: 496e 666f 726d 6174 696f 6e20 6162 6f75  Information abou
+0001ce70: 7420 6561 6368 2077 6f72 6b65 7220 686f  t each worker ho
+0001ce80: 7374 0a0a 2020 2020 2a20 2a2a 636c 6965  st..    * **clie
+0001ce90: 6e74 733a 2a2a 2060 607b 636c 6965 6e74  nts:** ``{client
+0001cea0: 206b 6579 3a20 436c 6965 6e74 5374 6174   key: ClientStat
+0001ceb0: 657d 6060 0a20 2020 2020 2020 2043 6c69  e}``.        Cli
+0001cec0: 656e 7473 2063 7572 7265 6e74 6c79 2063  ents currently c
+0001ced0: 6f6e 6e65 6374 6564 2074 6f20 7468 6520  onnected to the 
+0001cee0: 7363 6865 6475 6c65 720a 0a20 2020 202a  scheduler..    *
+0001cef0: 202a 2a73 6572 7669 6365 733a 2a2a 2060   **services:** `
+0001cf00: 607b 7374 723a 2070 6f72 747d 6060 3a0a  `{str: port}``:.
+0001cf10: 2020 2020 2020 2020 4f74 6865 7220 7365          Other se
+0001cf20: 7276 6963 6573 2072 756e 6e69 6e67 206f  rvices running o
+0001cf30: 6e20 7468 6973 2073 6368 6564 756c 6572  n this scheduler
+0001cf40: 2c20 6c69 6b65 2042 6f6b 6568 0a20 2020  , like Bokeh.   
+0001cf50: 202a 202a 2a6c 6f6f 703a 2a2a 2060 6049   * **loop:** ``I
+0001cf60: 4f4c 6f6f 7060 603a 0a20 2020 2020 2020  OLoop``:.       
+0001cf70: 2054 6865 2072 756e 6e69 6e67 2054 6f72   The running Tor
+0001cf80: 6e61 646f 2049 4f4c 6f6f 700a 2020 2020  nado IOLoop.    
+0001cf90: 2a20 2a2a 636c 6965 6e74 5f63 6f6d 6d73  * **client_comms
+0001cfa0: 3a2a 2a20 6060 7b63 6c69 656e 7420 6b65  :** ``{client ke
+0001cfb0: 793a 2043 6f6d 6d7d 6060 0a20 2020 2020  y: Comm}``.     
+0001cfc0: 2020 2046 6f72 2065 6163 6820 636c 6965     For each clie
+0001cfd0: 6e74 2c20 6120 436f 6d6d 206f 626a 6563  nt, a Comm objec
+0001cfe0: 7420 7573 6564 2074 6f20 7265 6365 6976  t used to receiv
+0001cff0: 6520 7461 736b 2072 6571 7565 7374 7320  e task requests 
+0001d000: 616e 640a 2020 2020 2020 2020 7265 706f  and.        repo
+0001d010: 7274 2074 6173 6b20 7374 6174 7573 2075  rt task status u
+0001d020: 7064 6174 6573 2e0a 2020 2020 2a20 2a2a  pdates..    * **
+0001d030: 7374 7265 616d 5f63 6f6d 6d73 3a2a 2a20  stream_comms:** 
+0001d040: 6060 7b77 6f72 6b65 7220 6b65 793a 2043  ``{worker key: C
+0001d050: 6f6d 6d7d 6060 0a20 2020 2020 2020 2046  omm}``.        F
+0001d060: 6f72 2065 6163 6820 776f 726b 6572 2c20  or each worker, 
+0001d070: 6120 436f 6d6d 206f 626a 6563 7420 6672  a Comm object fr
+0001d080: 6f6d 2077 6869 6368 2077 6520 626f 7468  om which we both
+0001d090: 2061 6363 6570 7420 7374 696d 756c 6920   accept stimuli 
+0001d0a0: 616e 640a 2020 2020 2020 2020 7265 706f  and.        repo
+0001d0b0: 7274 2072 6573 756c 7473 0a20 2020 202a  rt results.    *
+0001d0c0: 202a 2a74 6173 6b5f 6475 7261 7469 6f6e   **task_duration
+0001d0d0: 3a2a 2a20 6060 7b6b 6579 2d70 7265 6669  :** ``{key-prefi
+0001d0e0: 783a 2074 696d 657d 6060 0a20 2020 2020  x: time}``.     
+0001d0f0: 2020 2054 696d 6520 7765 2065 7870 6563     Time we expec
+0001d100: 7420 6365 7274 6169 6e20 6675 6e63 7469  t certain functi
+0001d110: 6f6e 7320 746f 2074 616b 652c 2065 2e67  ons to take, e.g
+0001d120: 2e20 6060 7b27 7375 6d27 3a20 302e 3235  . ``{'sum': 0.25
+0001d130: 7d60 600a 2020 2020 2222 220a 0a20 2020  }``.    """..   
+0001d140: 2064 6566 6175 6c74 5f70 6f72 7420 3d20   default_port = 
+0001d150: 3837 3836 0a20 2020 205f 696e 7374 616e  8786.    _instan
+0001d160: 6365 733a 2043 6c61 7373 5661 725b 7765  ces: ClassVar[we
+0001d170: 616b 7265 662e 5765 616b 5365 745b 5363  akref.WeakSet[Sc
+0001d180: 6865 6475 6c65 725d 5d20 3d20 7765 616b  heduler]] = weak
+0001d190: 7265 662e 5765 616b 5365 7428 290a 0a20  ref.WeakSet().. 
+0001d1a0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0001d1b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0001d1c0: 2020 2020 2020 206c 6f6f 703d 4e6f 6e65         loop=None
+0001d1d0: 2c0a 2020 2020 2020 2020 6465 6c65 7465  ,.        delete
+0001d1e0: 5f69 6e74 6572 7661 6c3d 2235 3030 6d73  _interval="500ms
+0001d1f0: 222c 0a20 2020 2020 2020 2073 796e 6368  ",.        synch
+0001d200: 726f 6e69 7a65 5f77 6f72 6b65 725f 696e  ronize_worker_in
+0001d210: 7465 7276 616c 3d22 3630 7322 2c0a 2020  terval="60s",.  
+0001d220: 2020 2020 2020 7365 7276 6963 6573 3d4e        services=N
+0001d230: 6f6e 652c 0a20 2020 2020 2020 2073 6572  one,.        ser
+0001d240: 7669 6365 5f6b 7761 7267 733d 4e6f 6e65  vice_kwargs=None
+0001d250: 2c0a 2020 2020 2020 2020 616c 6c6f 7765  ,.        allowe
+0001d260: 645f 6661 696c 7572 6573 3d4e 6f6e 652c  d_failures=None,
+0001d270: 0a20 2020 2020 2020 2065 7874 656e 7369  .        extensi
+0001d280: 6f6e 733d 4e6f 6e65 2c0a 2020 2020 2020  ons=None,.      
+0001d290: 2020 7661 6c69 6461 7465 3d4e 6f6e 652c    validate=None,
+0001d2a0: 0a20 2020 2020 2020 2073 6368 6564 756c  .        schedul
+0001d2b0: 6572 5f66 696c 653d 4e6f 6e65 2c0a 2020  er_file=None,.  
+0001d2c0: 2020 2020 2020 7365 6375 7269 7479 3d4e        security=N
+0001d2d0: 6f6e 652c 0a20 2020 2020 2020 2077 6f72  one,.        wor
+0001d2e0: 6b65 725f 7474 6c3d 4e6f 6e65 2c0a 2020  ker_ttl=None,.  
+0001d2f0: 2020 2020 2020 6964 6c65 5f74 696d 656f        idle_timeo
+0001d300: 7574 3d4e 6f6e 652c 0a20 2020 2020 2020  ut=None,.       
+0001d310: 2069 6e74 6572 6661 6365 3d4e 6f6e 652c   interface=None,
+0001d320: 0a20 2020 2020 2020 2068 6f73 743d 4e6f  .        host=No
+0001d330: 6e65 2c0a 2020 2020 2020 2020 706f 7274  ne,.        port
+0001d340: 3d30 2c0a 2020 2020 2020 2020 7072 6f74  =0,.        prot
+0001d350: 6f63 6f6c 3d4e 6f6e 652c 0a20 2020 2020  ocol=None,.     
+0001d360: 2020 2064 6173 6862 6f61 7264 5f61 6464     dashboard_add
+0001d370: 7265 7373 3d4e 6f6e 652c 0a20 2020 2020  ress=None,.     
+0001d380: 2020 2064 6173 6862 6f61 7264 3d4e 6f6e     dashboard=Non
+0001d390: 652c 0a20 2020 2020 2020 2068 7474 705f  e,.        http_
+0001d3a0: 7072 6566 6978 3d22 2f22 2c0a 2020 2020  prefix="/",.    
+0001d3b0: 2020 2020 7072 656c 6f61 643d 4e6f 6e65      preload=None
+0001d3c0: 2c0a 2020 2020 2020 2020 7072 656c 6f61  ,.        preloa
+0001d3d0: 645f 6172 6776 3d28 292c 0a20 2020 2020  d_argv=(),.     
+0001d3e0: 2020 2070 6c75 6769 6e73 3d28 292c 0a20     plugins=(),. 
+0001d3f0: 2020 2020 2020 2063 6f6e 7461 6374 5f61         contact_a
+0001d400: 6464 7265 7373 3d4e 6f6e 652c 0a20 2020  ddress=None,.   
+0001d410: 2020 2020 2074 7261 6e73 6974 696f 6e5f       transition_
+0001d420: 636f 756e 7465 725f 6d61 783d 4661 6c73  counter_max=Fals
+0001d430: 652c 0a20 2020 2020 2020 206a 7570 7974  e,.        jupyt
+0001d440: 6572 3d46 616c 7365 2c0a 2020 2020 2020  er=False,.      
+0001d450: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+0001d460: 293a 0a20 2020 2020 2020 2069 6620 6c6f  ):.        if lo
+0001d470: 6f70 2069 7320 6e6f 7420 4e6f 6e65 3a0a  op is not None:.
+0001d480: 2020 2020 2020 2020 2020 2020 7761 726e              warn
+0001d490: 696e 6773 2e77 6172 6e28 0a20 2020 2020  ings.warn(.     
+0001d4a0: 2020 2020 2020 2020 2020 2022 7468 6520             "the 
+0001d4b0: 6c6f 6f70 206b 7761 7267 2074 6f20 5363  loop kwarg to Sc
+0001d4c0: 6865 6475 6c65 7220 6973 2064 6570 7265  heduler is depre
+0001d4d0: 6361 7465 6422 2c0a 2020 2020 2020 2020  cated",.        
+0001d4e0: 2020 2020 2020 2020 4465 7072 6563 6174          Deprecat
+0001d4f0: 696f 6e57 6172 6e69 6e67 2c0a 2020 2020  ionWarning,.    
+0001d500: 2020 2020 2020 2020 2020 2020 7374 6163              stac
+0001d510: 6b6c 6576 656c 3d32 2c0a 2020 2020 2020  klevel=2,.      
+0001d520: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001d530: 2073 656c 662e 6c6f 6f70 203d 2073 656c   self.loop = sel
+0001d540: 662e 696f 5f6c 6f6f 7020 3d20 494f 4c6f  f.io_loop = IOLo
+0001d550: 6f70 2e63 7572 7265 6e74 2829 0a20 2020  op.current().   
+0001d560: 2020 2020 2073 656c 662e 5f73 6574 7570       self._setup
+0001d570: 5f6c 6f67 6769 6e67 286c 6f67 6765 7229  _logging(logger)
+0001d580: 0a0a 2020 2020 2020 2020 2320 4174 7472  ..        # Attr
+0001d590: 6962 7574 6573 0a20 2020 2020 2020 2069  ibutes.        i
+0001d5a0: 6620 636f 6e74 6163 745f 6164 6472 6573  f contact_addres
+0001d5b0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0001d5c0: 2020 2020 2020 2063 6f6e 7461 6374 5f61         contact_a
+0001d5d0: 6464 7265 7373 203d 2064 6173 6b2e 636f  ddress = dask.co
+0001d5e0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+0001d5f0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0001d600: 636f 6e74 6163 742d 6164 6472 6573 7322  contact-address"
+0001d610: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0001d620: 6f6e 7461 6374 5f61 6464 7265 7373 203d  ontact_address =
+0001d630: 2063 6f6e 7461 6374 5f61 6464 7265 7373   contact_address
+0001d640: 0a20 2020 2020 2020 2069 6620 616c 6c6f  .        if allo
+0001d650: 7765 645f 6661 696c 7572 6573 2069 7320  wed_failures is 
+0001d660: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001d670: 2020 616c 6c6f 7765 645f 6661 696c 7572    allowed_failur
+0001d680: 6573 203d 2064 6173 6b2e 636f 6e66 6967  es = dask.config
+0001d690: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0001d6a0: 642e 7363 6865 6475 6c65 722e 616c 6c6f  d.scheduler.allo
+0001d6b0: 7765 642d 6661 696c 7572 6573 2229 0a20  wed-failures"). 
+0001d6c0: 2020 2020 2020 2073 656c 662e 616c 6c6f         self.allo
+0001d6d0: 7765 645f 6661 696c 7572 6573 203d 2061  wed_failures = a
+0001d6e0: 6c6c 6f77 6564 5f66 6169 6c75 7265 730a  llowed_failures.
+0001d6f0: 2020 2020 2020 2020 6966 2076 616c 6964          if valid
+0001d700: 6174 6520 6973 204e 6f6e 653a 0a20 2020  ate is None:.   
+0001d710: 2020 2020 2020 2020 2076 616c 6964 6174           validat
+0001d720: 6520 3d20 6461 736b 2e63 6f6e 6669 672e  e = dask.config.
+0001d730: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+0001d740: 2e73 6368 6564 756c 6572 2e76 616c 6964  .scheduler.valid
+0001d750: 6174 6522 290a 2020 2020 2020 2020 7365  ate").        se
+0001d760: 6c66 2e70 726f 6320 3d20 7073 7574 696c  lf.proc = psutil
+0001d770: 2e50 726f 6365 7373 2829 0a20 2020 2020  .Process().     
+0001d780: 2020 2073 656c 662e 6465 6c65 7465 5f69     self.delete_i
+0001d790: 6e74 6572 7661 6c20 3d20 7061 7273 655f  nterval = parse_
+0001d7a0: 7469 6d65 6465 6c74 6128 6465 6c65 7465  timedelta(delete
+0001d7b0: 5f69 6e74 6572 7661 6c2c 2064 6566 6175  _interval, defau
+0001d7c0: 6c74 3d22 6d73 2229 0a20 2020 2020 2020  lt="ms").       
+0001d7d0: 2073 656c 662e 7379 6e63 6872 6f6e 697a   self.synchroniz
+0001d7e0: 655f 776f 726b 6572 5f69 6e74 6572 7661  e_worker_interva
+0001d7f0: 6c20 3d20 7061 7273 655f 7469 6d65 6465  l = parse_timede
+0001d800: 6c74 6128 0a20 2020 2020 2020 2020 2020  lta(.           
+0001d810: 2073 796e 6368 726f 6e69 7a65 5f77 6f72   synchronize_wor
+0001d820: 6b65 725f 696e 7465 7276 616c 2c20 6465  ker_interval, de
+0001d830: 6661 756c 743d 226d 7322 0a20 2020 2020  fault="ms".     
+0001d840: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0001d850: 662e 7365 7276 6963 655f 7370 6563 7320  f.service_specs 
+0001d860: 3d20 7365 7276 6963 6573 206f 7220 7b7d  = services or {}
+0001d870: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+0001d880: 7276 6963 655f 6b77 6172 6773 203d 2073  rvice_kwargs = s
+0001d890: 6572 7669 6365 5f6b 7761 7267 7320 6f72  ervice_kwargs or
+0001d8a0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+0001d8b0: 2e73 6572 7669 6365 7320 3d20 7b7d 0a20  .services = {}. 
+0001d8c0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+0001d8d0: 6475 6c65 725f 6669 6c65 203d 2073 6368  duler_file = sch
+0001d8e0: 6564 756c 6572 5f66 696c 650a 2020 2020  eduler_file.    
+0001d8f0: 2020 2020 776f 726b 6572 5f74 746c 203d      worker_ttl =
+0001d900: 2077 6f72 6b65 725f 7474 6c20 6f72 2064   worker_ttl or d
+0001d910: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+0001d920: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+0001d930: 6475 6c65 722e 776f 726b 6572 2d74 746c  duler.worker-ttl
+0001d940: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+0001d950: 776f 726b 6572 5f74 746c 203d 2070 6172  worker_ttl = par
+0001d960: 7365 5f74 696d 6564 656c 7461 2877 6f72  se_timedelta(wor
+0001d970: 6b65 725f 7474 6c29 2069 6620 776f 726b  ker_ttl) if work
+0001d980: 6572 5f74 746c 2065 6c73 6520 4e6f 6e65  er_ttl else None
+0001d990: 0a20 2020 2020 2020 2069 646c 655f 7469  .        idle_ti
+0001d9a0: 6d65 6f75 7420 3d20 6964 6c65 5f74 696d  meout = idle_tim
+0001d9b0: 656f 7574 206f 7220 6461 736b 2e63 6f6e  eout or dask.con
+0001d9c0: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
+0001d9d0: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
+0001d9e0: 642e 7363 6865 6475 6c65 722e 6964 6c65  d.scheduler.idle
+0001d9f0: 2d74 696d 656f 7574 220a 2020 2020 2020  -timeout".      
+0001da00: 2020 290a 2020 2020 2020 2020 6966 2069    ).        if i
+0001da10: 646c 655f 7469 6d65 6f75 743a 0a20 2020  dle_timeout:.   
+0001da20: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
+0001da30: 6c65 5f74 696d 656f 7574 203d 2070 6172  le_timeout = par
+0001da40: 7365 5f74 696d 6564 656c 7461 2869 646c  se_timedelta(idl
+0001da50: 655f 7469 6d65 6f75 7429 0a20 2020 2020  e_timeout).     
+0001da60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001da70: 2020 2020 2073 656c 662e 6964 6c65 5f74       self.idle_t
+0001da80: 696d 656f 7574 203d 204e 6f6e 650a 2020  imeout = None.  
+0001da90: 2020 2020 2020 7365 6c66 2e69 646c 655f        self.idle_
+0001daa0: 7369 6e63 6520 3d20 7469 6d65 2829 0a20  since = time(). 
+0001dab0: 2020 2020 2020 2073 656c 662e 7469 6d65         self.time
+0001dac0: 5f73 7461 7274 6564 203d 2073 656c 662e  _started = self.
+0001dad0: 6964 6c65 5f73 696e 6365 2020 2320 636f  idle_since  # co
+0001dae0: 6d70 6174 6962 696c 6974 7920 666f 7220  mpatibility for 
+0001daf0: 6461 736b 2d67 6174 6577 6179 0a20 2020  dask-gateway.   
+0001db00: 2020 2020 2073 656c 662e 5f6c 6f63 6b20       self._lock 
+0001db10: 3d20 6173 796e 6369 6f2e 4c6f 636b 2829  = asyncio.Lock()
+0001db20: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+0001db30: 6e64 7769 6474 685f 776f 726b 6572 7320  ndwidth_workers 
+0001db40: 3d20 6465 6661 756c 7464 6963 7428 666c  = defaultdict(fl
+0001db50: 6f61 7429 0a20 2020 2020 2020 2073 656c  oat).        sel
+0001db60: 662e 6261 6e64 7769 6474 685f 7479 7065  f.bandwidth_type
+0001db70: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
+0001db80: 666c 6f61 7429 0a0a 2020 2020 2020 2020  float)..        
+0001db90: 7365 6c66 2e63 756d 756c 6174 6976 655f  self.cumulative_
+0001dba0: 776f 726b 6572 5f6d 6574 7269 6373 203d  worker_metrics =
+0001dbb0: 2064 6566 6175 6c74 6469 6374 2866 6c6f   defaultdict(flo
+0001dbc0: 6174 290a 0a20 2020 2020 2020 2069 6620  at)..        if 
+0001dbd0: 6e6f 7420 7072 656c 6f61 643a 0a20 2020  not preload:.   
+0001dbe0: 2020 2020 2020 2020 2070 7265 6c6f 6164           preload
+0001dbf0: 203d 2064 6173 6b2e 636f 6e66 6967 2e67   = dask.config.g
+0001dc00: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0001dc10: 7363 6865 6475 6c65 722e 7072 656c 6f61  scheduler.preloa
+0001dc20: 6422 290a 2020 2020 2020 2020 6966 206e  d").        if n
+0001dc30: 6f74 2070 7265 6c6f 6164 5f61 7267 763a  ot preload_argv:
+0001dc40: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+0001dc50: 6c6f 6164 5f61 7267 7620 3d20 6461 736b  load_argv = dask
+0001dc60: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+0001dc70: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
+0001dc80: 6572 2e70 7265 6c6f 6164 2d61 7267 7622  er.preload-argv"
+0001dc90: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+0001dca0: 7265 6c6f 6164 7320 3d20 7072 656c 6f61  reloads = preloa
+0001dcb0: 6469 6e67 2e70 726f 6365 7373 5f70 7265  ding.process_pre
+0001dcc0: 6c6f 6164 7328 7365 6c66 2c20 7072 656c  loads(self, prel
+0001dcd0: 6f61 642c 2070 7265 6c6f 6164 5f61 7267  oad, preload_arg
+0001dce0: 7629 0a0a 2020 2020 2020 2020 6966 2069  v)..        if i
+0001dcf0: 7369 6e73 7461 6e63 6528 7365 6375 7269  sinstance(securi
+0001dd00: 7479 2c20 6469 6374 293a 0a20 2020 2020  ty, dict):.     
+0001dd10: 2020 2020 2020 2073 6563 7572 6974 7920         security 
+0001dd20: 3d20 5365 6375 7269 7479 282a 2a73 6563  = Security(**sec
+0001dd30: 7572 6974 7929 0a20 2020 2020 2020 2073  urity).        s
+0001dd40: 656c 662e 7365 6375 7269 7479 203d 2073  elf.security = s
+0001dd50: 6563 7572 6974 7920 6f72 2053 6563 7572  ecurity or Secur
+0001dd60: 6974 7928 290a 2020 2020 2020 2020 6173  ity().        as
+0001dd70: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0001dd80: 7365 6c66 2e73 6563 7572 6974 792c 2053  self.security, S
+0001dd90: 6563 7572 6974 7929 0a20 2020 2020 2020  ecurity).       
+0001dda0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0001ddb0: 5f61 7267 7320 3d20 7365 6c66 2e73 6563  _args = self.sec
+0001ddc0: 7572 6974 792e 6765 745f 636f 6e6e 6563  urity.get_connec
+0001ddd0: 7469 6f6e 5f61 7267 7328 2273 6368 6564  tion_args("sched
+0001dde0: 756c 6572 2229 0a20 2020 2020 2020 2073  uler").        s
+0001ddf0: 656c 662e 636f 6e6e 6563 7469 6f6e 5f61  elf.connection_a
+0001de00: 7267 735b 2268 616e 6473 6861 6b65 5f6f  rgs["handshake_o
+0001de10: 7665 7272 6964 6573 225d 203d 207b 2020  verrides"] = {  
+0001de20: 2320 636f 6d6d 6f6e 2064 656e 6f6d 696e  # common denomin
+0001de30: 6174 6f72 0a20 2020 2020 2020 2020 2020  ator.           
+0001de40: 2022 7069 636b 6c65 2d70 726f 746f 636f   "pickle-protoco
+0001de50: 6c22 3a20 340a 2020 2020 2020 2020 7d0a  l": 4.        }.
+0001de60: 0a20 2020 2020 2020 2073 656c 662e 5f73  .        self._s
+0001de70: 7461 7274 5f61 6464 7265 7373 203d 2061  tart_address = a
+0001de80: 6464 7265 7373 6573 5f66 726f 6d5f 7573  ddresses_from_us
+0001de90: 6572 5f61 7267 7328 0a20 2020 2020 2020  er_args(.       
+0001dea0: 2020 2020 2068 6f73 743d 686f 7374 2c0a       host=host,.
+0001deb0: 2020 2020 2020 2020 2020 2020 706f 7274              port
+0001dec0: 3d70 6f72 742c 0a20 2020 2020 2020 2020  =port,.         
+0001ded0: 2020 2069 6e74 6572 6661 6365 3d69 6e74     interface=int
+0001dee0: 6572 6661 6365 2c0a 2020 2020 2020 2020  erface,.        
+0001def0: 2020 2020 7072 6f74 6f63 6f6c 3d70 726f      protocol=pro
+0001df00: 746f 636f 6c2c 0a20 2020 2020 2020 2020  tocol,.         
+0001df10: 2020 2073 6563 7572 6974 793d 7365 6375     security=secu
+0001df20: 7269 7479 2c0a 2020 2020 2020 2020 2020  rity,.          
+0001df30: 2020 6465 6661 756c 745f 706f 7274 3d73    default_port=s
+0001df40: 656c 662e 6465 6661 756c 745f 706f 7274  elf.default_port
+0001df50: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0001df60: 2020 2020 2068 7474 705f 7365 7276 6572       http_server
+0001df70: 5f6d 6f64 756c 6573 203d 2064 6173 6b2e  _modules = dask.
+0001df80: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0001df90: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0001dfa0: 722e 6874 7470 2e72 6f75 7465 7322 290a  r.http.routes").
+0001dfb0: 2020 2020 2020 2020 7368 6f77 5f64 6173          show_das
+0001dfc0: 6862 6f61 7264 203d 2064 6173 6862 6f61  hboard = dashboa
+0001dfd0: 7264 206f 7220 2864 6173 6862 6f61 7264  rd or (dashboard
+0001dfe0: 2069 7320 4e6f 6e65 2061 6e64 2064 6173   is None and das
+0001dff0: 6862 6f61 7264 5f61 6464 7265 7373 290a  hboard_address).
+0001e000: 2020 2020 2020 2020 2320 696e 7374 616c          # instal
+0001e010: 6c20 7661 6e69 6c6c 6120 726f 7574 6520  l vanilla route 
+0001e020: 6966 2073 686f 775f 6461 7368 626f 6172  if show_dashboar
+0001e030: 6420 6275 7420 626f 6b65 6820 6973 206e  d but bokeh is n
+0001e040: 6f74 2069 6e73 7461 6c6c 6564 0a20 2020  ot installed.   
+0001e050: 2020 2020 2069 6620 7368 6f77 5f64 6173       if show_das
+0001e060: 6862 6f61 7264 3a0a 2020 2020 2020 2020  hboard:.        
+0001e070: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001e080: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
+0001e090: 6469 7374 7269 6275 7465 642e 6461 7368  distributed.dash
+0001e0a0: 626f 6172 642e 7363 6865 6475 6c65 720a  board.scheduler.
+0001e0b0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0001e0c0: 7074 2049 6d70 6f72 7445 7272 6f72 3a0a  pt ImportError:.
+0001e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0e0: 7368 6f77 5f64 6173 6862 6f61 7264 203d  show_dashboard =
+0001e0f0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
+0001e100: 2020 2020 2020 2068 7474 705f 7365 7276         http_serv
+0001e110: 6572 5f6d 6f64 756c 6573 2e61 7070 656e  er_modules.appen
+0001e120: 6428 2264 6973 7472 6962 7574 6564 2e68  d("distributed.h
+0001e130: 7474 702e 7363 6865 6475 6c65 722e 6d69  ttp.scheduler.mi
+0001e140: 7373 696e 675f 626f 6b65 6822 290a 2020  ssing_bokeh").  
+0001e150: 2020 2020 2020 726f 7574 6573 203d 2067        routes = g
+0001e160: 6574 5f68 616e 646c 6572 7328 0a20 2020  et_handlers(.   
+0001e170: 2020 2020 2020 2020 2073 6572 7665 723d           server=
+0001e180: 7365 6c66 2c20 6d6f 6475 6c65 733d 6874  self, modules=ht
+0001e190: 7470 5f73 6572 7665 725f 6d6f 6475 6c65  tp_server_module
+0001e1a0: 732c 2070 7265 6669 783d 6874 7470 5f70  s, prefix=http_p
+0001e1b0: 7265 6669 780a 2020 2020 2020 2020 290a  refix.        ).
+0001e1c0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+0001e1d0: 7274 5f68 7474 705f 7365 7276 6572 2872  rt_http_server(r
+0001e1e0: 6f75 7465 732c 2064 6173 6862 6f61 7264  outes, dashboard
+0001e1f0: 5f61 6464 7265 7373 2c20 6465 6661 756c  _address, defaul
+0001e200: 745f 706f 7274 3d38 3738 3729 0a20 2020  t_port=8787).   
+0001e210: 2020 2020 2073 656c 662e 6a75 7079 7465       self.jupyte
+0001e220: 7220 3d20 6a75 7079 7465 720a 2020 2020  r = jupyter.    
+0001e230: 2020 2020 6966 2073 686f 775f 6461 7368      if show_dash
+0001e240: 626f 6172 643a 0a20 2020 2020 2020 2020  board:.         
+0001e250: 2020 2064 6973 7472 6962 7574 6564 2e64     distributed.d
+0001e260: 6173 6862 6f61 7264 2e73 6368 6564 756c  ashboard.schedul
+0001e270: 6572 2e63 6f6e 6e65 6374 280a 2020 2020  er.connect(.    
+0001e280: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001e290: 2e68 7474 705f 6170 706c 6963 6174 696f  .http_applicatio
+0001e2a0: 6e2c 2073 656c 662e 6874 7470 5f73 6572  n, self.http_ser
+0001e2b0: 7665 722c 2073 656c 662c 2070 7265 6669  ver, self, prefi
+0001e2c0: 783d 6874 7470 5f70 7265 6669 780a 2020  x=http_prefix.  
+0001e2d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001e2e0: 2020 2020 6966 2073 656c 662e 6a75 7079      if self.jupy
+0001e2f0: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
+0001e300: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0001e310: 2020 2020 2020 6672 6f6d 206a 7570 7974        from jupyt
+0001e320: 6572 5f73 6572 7665 722e 7365 7276 6572  er_server.server
+0001e330: 6170 7020 696d 706f 7274 2053 6572 7665  app import Serve
+0001e340: 7241 7070 0a20 2020 2020 2020 2020 2020  rApp.           
+0001e350: 2065 7863 6570 7420 496d 706f 7274 4572   except ImportEr
+0001e360: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0001e370: 2020 2020 2072 6169 7365 2049 6d70 6f72       raise Impor
+0001e380: 7445 7272 6f72 280a 2020 2020 2020 2020  tError(.        
+0001e390: 2020 2020 2020 2020 2020 2020 2249 6e20              "In 
+0001e3a0: 6f72 6465 7220 746f 2075 7365 2074 6865  order to use the
+0001e3b0: 2044 6173 6b20 6a75 7079 7465 7220 6f70   Dask jupyter op
+0001e3c0: 7469 6f6e 2079 6f75 2022 0a20 2020 2020  tion you ".     
+0001e3d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001e3e0: 6e65 6564 2074 6f20 6861 7665 206a 7570  need to have jup
+0001e3f0: 7974 6572 6c61 6220 696e 7374 616c 6c65  yterlab installe
+0001e400: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
+0001e410: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001e420: 2066 726f 6d20 7472 6169 746c 6574 732e   from traitlets.
+0001e430: 636f 6e66 6967 2069 6d70 6f72 7420 436f  config import Co
+0001e440: 6e66 6967 0a0a 2020 2020 2020 2020 2020  nfig..          
+0001e450: 2020 6a20 3d20 5365 7276 6572 4170 702e    j = ServerApp.
+0001e460: 696e 7374 616e 6365 280a 2020 2020 2020  instance(.      
+0001e470: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+0001e480: 3d43 6f6e 6669 6728 0a20 2020 2020 2020  =Config(.       
+0001e490: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+0001e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4b0: 2020 2020 2020 2022 5365 7276 6572 4170         "ServerAp
+0001e4c0: 7022 3a20 7b0a 2020 2020 2020 2020 2020  p": {.          
+0001e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4e0: 2020 2262 6173 655f 7572 6c22 3a20 226a    "base_url": "j
+0001e4f0: 7570 7974 6572 222c 0a20 2020 2020 2020  upyter",.       
+0001e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e510: 2020 2020 2023 2053 4543 5552 4954 593a       # SECURITY:
+0001e520: 2057 6520 7573 7561 6c6c 7920 6578 7065   We usually expe
+0001e530: 6374 2074 6865 2064 6173 6862 6f61 7264  ct the dashboard
+0001e540: 2074 6f20 6265 2061 2072 6561 642d 6f6e   to be a read-on
+0001e550: 6c79 2076 6965 7720 696e 746f 0a20 2020  ly view into.   
 0001e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e570: 2023 2064 6173 6862 6f61 7264 2073 6572   # dashboard ser
-0001e580: 7665 722e 2054 6869 7320 6f70 7469 6f6e  ver. This option
-0001e590: 2073 686f 756c 6420 6f6e 6c79 2062 6520   should only be 
-0001e5a0: 7573 6564 2077 6865 6e20 7468 6520 6461  used when the da
-0001e5b0: 7368 626f 6172 6420 6973 0a20 2020 2020  shboard is.     
-0001e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5d0: 2020 2020 2020 2023 2070 726f 7465 6374         # protect
-0001e5e0: 6564 2076 6961 206f 7468 6572 206d 6561  ed via other mea
-0001e5f0: 6e73 2c20 6f72 2077 6865 6e20 796f 7520  ns, or when you 
-0001e600: 646f 6e27 7420 6361 7265 2061 626f 7574  don't care about
-0001e610: 2063 6c75 7374 6572 2073 6563 7572 6974   cluster securit
-0001e620: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
-0001e630: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001e640: 746f 6b65 6e22 3a20 2222 2c0a 2020 2020  token": "",.    
-0001e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e660: 2020 2020 2020 2020 2261 6c6c 6f77 5f72          "allow_r
-0001e670: 656d 6f74 655f 6163 6365 7373 223a 2054  emote_access": T
-0001e680: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0001e690: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0001e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6b0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0001e6c0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001e6d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001e6e0: 206a 2e69 6e69 7469 616c 697a 6528 0a20   j.initialize(. 
-0001e6f0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0001e700: 6577 5f68 7474 7073 6572 7665 723d 4661  ew_httpserver=Fa
-0001e710: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-0001e720: 2020 2020 2061 7267 763d 5b5d 2c0a 2020       argv=[],.  
-0001e730: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001e740: 2020 2020 2020 2020 7365 6c66 2e5f 6a75          self._ju
-0001e750: 7079 7465 725f 7365 7276 6572 5f61 7070  pyter_server_app
-0001e760: 6c69 6361 7469 6f6e 203d 206a 0a20 2020  lication = j.   
-0001e770: 2020 2020 2020 2020 2073 656c 662e 6874           self.ht
-0001e780: 7470 5f61 7070 6c69 6361 7469 6f6e 2e61  tp_application.a
-0001e790: 6464 5f61 7070 6c69 6361 7469 6f6e 286a  dd_application(j
-0001e7a0: 2e77 6562 5f61 7070 290a 0a20 2020 2020  .web_app)..     
-0001e7b0: 2020 2023 2043 6f6d 6d75 6e69 6361 7469     # Communicati
-0001e7c0: 6f6e 2073 7461 7465 0a20 2020 2020 2020  on state.       
-0001e7d0: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
-0001e7e0: 6d73 203d 207b 7d0a 2020 2020 2020 2020  ms = {}.        
-0001e7f0: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-0001e800: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-0001e810: 2320 5461 736b 2073 7461 7465 0a20 2020  # Task state.   
-0001e820: 2020 2020 2074 6173 6b73 203d 207b 7d0a       tasks = {}.
-0001e830: 0a20 2020 2020 2020 2073 656c 662e 6765  .        self.ge
-0001e840: 6e65 7261 7469 6f6e 203d 2030 0a20 2020  neration = 0.   
-0001e850: 2020 2020 2073 656c 662e 5f6c 6173 745f       self._last_
-0001e860: 636c 6965 6e74 203d 204e 6f6e 650a 2020  client = None.  
-0001e870: 2020 2020 2020 7365 6c66 2e5f 6c61 7374        self._last
-0001e880: 5f74 696d 6520 3d20 300a 2020 2020 2020  _time = 0.      
-0001e890: 2020 756e 7275 6e6e 6162 6c65 203d 2073    unrunnable = s
-0001e8a0: 6574 2829 0a20 2020 2020 2020 2071 7565  et().        que
-0001e8b0: 7565 643a 2048 6561 7053 6574 5b54 6173  ued: HeapSet[Tas
-0001e8c0: 6b53 7461 7465 5d20 3d20 4865 6170 5365  kState] = HeapSe
-0001e8d0: 7428 6b65 793d 6f70 6572 6174 6f72 2e61  t(key=operator.a
-0001e8e0: 7474 7267 6574 7465 7228 2270 7269 6f72  ttrgetter("prior
-0001e8f0: 6974 7922 2929 0a0a 2020 2020 2020 2020  ity"))..        
-0001e900: 7365 6c66 2e64 6174 6173 6574 7320 3d20  self.datasets = 
-0001e910: 7b7d 0a0a 2020 2020 2020 2020 2320 5072  {}..        # Pr
-0001e920: 6566 6978 2d6b 6579 6564 2063 6f6e 7461  efix-keyed conta
-0001e930: 696e 6572 730a 0a20 2020 2020 2020 2023  iners..        #
-0001e940: 2043 6c69 656e 7420 7374 6174 650a 2020   Client state.  
-0001e950: 2020 2020 2020 636c 6965 6e74 7320 3d20        clients = 
-0001e960: 7b7d 0a0a 2020 2020 2020 2020 2320 576f  {}..        # Wo
-0001e970: 726b 6572 2073 7461 7465 0a20 2020 2020  rker state.     
-0001e980: 2020 2077 6f72 6b65 7273 203d 2053 6f72     workers = Sor
-0001e990: 7465 6444 6963 7428 290a 0a20 2020 2020  tedDict()..     
-0001e9a0: 2020 2068 6f73 745f 696e 666f 203d 207b     host_info = {
-0001e9b0: 7d0a 2020 2020 2020 2020 7265 736f 7572  }.        resour
-0001e9c0: 6365 7320 3d20 7b7d 0a20 2020 2020 2020  ces = {}.       
-0001e9d0: 2061 6c69 6173 6573 203d 207b 7d0a 0a20   aliases = {}.. 
-0001e9e0: 2020 2020 2020 2073 656c 662e 5f77 6f72         self._wor
-0001e9f0: 6b65 725f 636f 6c6c 6563 7469 6f6e 7320  ker_collections 
-0001ea00: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0001ea10: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
-0001ea20: 2020 2020 2068 6f73 745f 696e 666f 2c0a       host_info,.
-0001ea30: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-0001ea40: 7572 6365 732c 0a20 2020 2020 2020 2020  urces,.         
-0001ea50: 2020 2061 6c69 6173 6573 2c0a 2020 2020     aliases,.    
-0001ea60: 2020 2020 5d0a 0a20 2020 2020 2020 2073      ]..        s
-0001ea70: 656c 662e 6576 656e 7473 203d 2064 6566  elf.events = def
-0001ea80: 6175 6c74 6469 6374 280a 2020 2020 2020  aultdict(.      
-0001ea90: 2020 2020 2020 7061 7274 6961 6c28 0a20        partial(. 
-0001eaa0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001eab0: 6571 7565 2c20 6d61 786c 656e 3d64 6173  eque, maxlen=das
-0001eac0: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-0001ead0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0001eae0: 6c65 722e 6576 656e 7473 2d6c 6f67 2d6c  ler.events-log-l
-0001eaf0: 656e 6774 6822 290a 2020 2020 2020 2020  ength").        
-0001eb00: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
-0001eb10: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
-0001eb20: 6e74 5f63 6f75 6e74 7320 3d20 6465 6661  nt_counts = defa
-0001eb30: 756c 7464 6963 7428 696e 7429 0a20 2020  ultdict(int).   
-0001eb40: 2020 2020 2073 656c 662e 6576 656e 745f       self.event_
-0001eb50: 7375 6273 6372 6962 6572 203d 2064 6566  subscriber = def
-0001eb60: 6175 6c74 6469 6374 2873 6574 290a 2020  aultdict(set).  
-0001eb70: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-0001eb80: 725f 706c 7567 696e 7320 3d20 7b7d 0a20  r_plugins = {}. 
-0001eb90: 2020 2020 2020 2073 656c 662e 6e61 6e6e         self.nann
-0001eba0: 795f 706c 7567 696e 7320 3d20 7b7d 0a0a  y_plugins = {}..
-0001ebb0: 2020 2020 2020 2020 776f 726b 6572 5f68          worker_h
-0001ebc0: 616e 646c 6572 7320 3d20 7b0a 2020 2020  andlers = {.    
-0001ebd0: 2020 2020 2020 2020 2274 6173 6b2d 6669          "task-fi
-0001ebe0: 6e69 7368 6564 223a 2073 656c 662e 6861  nished": self.ha
-0001ebf0: 6e64 6c65 5f74 6173 6b5f 6669 6e69 7368  ndle_task_finish
-0001ec00: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
-0001ec10: 2274 6173 6b2d 6572 7265 6422 3a20 7365  "task-erred": se
-0001ec20: 6c66 2e68 616e 646c 655f 7461 736b 5f65  lf.handle_task_e
-0001ec30: 7272 6564 2c0a 2020 2020 2020 2020 2020  rred,.          
-0001ec40: 2020 2272 656c 6561 7365 2d77 6f72 6b65    "release-worke
-0001ec50: 722d 6461 7461 223a 2073 656c 662e 7265  r-data": self.re
-0001ec60: 6c65 6173 655f 776f 726b 6572 5f64 6174  lease_worker_dat
-0001ec70: 612c 0a20 2020 2020 2020 2020 2020 2022  a,.            "
-0001ec80: 6164 642d 6b65 7973 223a 2073 656c 662e  add-keys": self.
-0001ec90: 6164 645f 6b65 7973 2c0a 2020 2020 2020  add_keys,.      
-0001eca0: 2020 2020 2020 226c 6f6e 672d 7275 6e6e        "long-runn
-0001ecb0: 696e 6722 3a20 7365 6c66 2e68 616e 646c  ing": self.handl
-0001ecc0: 655f 6c6f 6e67 5f72 756e 6e69 6e67 2c0a  e_long_running,.
-0001ecd0: 2020 2020 2020 2020 2020 2020 2272 6573              "res
-0001ece0: 6368 6564 756c 6522 3a20 7365 6c66 2e5f  chedule": self._
-0001ecf0: 7265 7363 6865 6475 6c65 2c0a 2020 2020  reschedule,.    
-0001ed00: 2020 2020 2020 2020 226b 6565 702d 616c          "keep-al
-0001ed10: 6976 6522 3a20 6c61 6d62 6461 202a 6172  ive": lambda *ar
-0001ed20: 6773 2c20 2a2a 6b77 6172 6773 3a20 4e6f  gs, **kwargs: No
-0001ed30: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0001ed40: 226c 6f67 2d65 7665 6e74 223a 2073 656c  "log-event": sel
-0001ed50: 662e 6c6f 675f 776f 726b 6572 5f65 7665  f.log_worker_eve
-0001ed60: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0001ed70: 2277 6f72 6b65 722d 7374 6174 7573 2d63  "worker-status-c
-0001ed80: 6861 6e67 6522 3a20 7365 6c66 2e68 616e  hange": self.han
-0001ed90: 646c 655f 776f 726b 6572 5f73 7461 7475  dle_worker_statu
-0001eda0: 735f 6368 616e 6765 2c0a 2020 2020 2020  s_change,.      
-0001edb0: 2020 2020 2020 2272 6571 7565 7374 2d72        "request-r
-0001edc0: 6566 7265 7368 2d77 686f 2d68 6173 223a  efresh-who-has":
-0001edd0: 2073 656c 662e 6861 6e64 6c65 5f72 6571   self.handle_req
-0001ede0: 7565 7374 5f72 6566 7265 7368 5f77 686f  uest_refresh_who
-0001edf0: 5f68 6173 2c0a 2020 2020 2020 2020 7d0a  _has,.        }.
-0001ee00: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
-0001ee10: 6861 6e64 6c65 7273 203d 207b 0a20 2020  handlers = {.   
-0001ee20: 2020 2020 2020 2020 2022 7570 6461 7465           "update
-0001ee30: 2d67 7261 7068 223a 2073 656c 662e 7570  -graph": self.up
-0001ee40: 6461 7465 5f67 7261 7068 2c0a 2020 2020  date_graph,.    
-0001ee50: 2020 2020 2020 2020 2275 7064 6174 652d          "update-
-0001ee60: 6772 6170 682d 686c 6722 3a20 7365 6c66  graph-hlg": self
-0001ee70: 2e75 7064 6174 655f 6772 6170 685f 686c  .update_graph_hl
-0001ee80: 672c 0a20 2020 2020 2020 2020 2020 2022  g,.            "
-0001ee90: 636c 6965 6e74 2d64 6573 6972 6573 2d6b  client-desires-k
-0001eea0: 6579 7322 3a20 7365 6c66 2e63 6c69 656e  eys": self.clien
-0001eeb0: 745f 6465 7369 7265 735f 6b65 7973 2c0a  t_desires_keys,.
-0001eec0: 2020 2020 2020 2020 2020 2020 2275 7064              "upd
-0001eed0: 6174 652d 6461 7461 223a 2073 656c 662e  ate-data": self.
-0001eee0: 7570 6461 7465 5f64 6174 612c 0a20 2020  update_data,.   
-0001eef0: 2020 2020 2020 2020 2022 7265 706f 7274           "report
-0001ef00: 2d6b 6579 223a 2073 656c 662e 7265 706f  -key": self.repo
-0001ef10: 7274 5f6f 6e5f 6b65 792c 0a20 2020 2020  rt_on_key,.     
-0001ef20: 2020 2020 2020 2022 636c 6965 6e74 2d72         "client-r
-0001ef30: 656c 6561 7365 732d 6b65 7973 223a 2073  eleases-keys": s
-0001ef40: 656c 662e 636c 6965 6e74 5f72 656c 6561  elf.client_relea
-0001ef50: 7365 735f 6b65 7973 2c0a 2020 2020 2020  ses_keys,.      
-0001ef60: 2020 2020 2020 2268 6561 7274 6265 6174        "heartbeat
-0001ef70: 2d63 6c69 656e 7422 3a20 7365 6c66 2e63  -client": self.c
-0001ef80: 6c69 656e 745f 6865 6172 7462 6561 742c  lient_heartbeat,
-0001ef90: 0a20 2020 2020 2020 2020 2020 2022 636c  .            "cl
-0001efa0: 6f73 652d 636c 6965 6e74 223a 2073 656c  ose-client": sel
-0001efb0: 662e 7265 6d6f 7665 5f63 6c69 656e 742c  f.remove_client,
-0001efc0: 0a20 2020 2020 2020 2020 2020 2022 7375  .            "su
-0001efd0: 6273 6372 6962 652d 746f 7069 6322 3a20  bscribe-topic": 
-0001efe0: 7365 6c66 2e73 7562 7363 7269 6265 5f74  self.subscribe_t
-0001eff0: 6f70 6963 2c0a 2020 2020 2020 2020 2020  opic,.          
-0001f000: 2020 2275 6e73 7562 7363 7269 6265 2d74    "unsubscribe-t
-0001f010: 6f70 6963 223a 2073 656c 662e 756e 7375  opic": self.unsu
-0001f020: 6273 6372 6962 655f 746f 7069 632c 0a20  bscribe_topic,. 
-0001f030: 2020 2020 2020 2020 2020 2022 6361 6e63             "canc
-0001f040: 656c 2d6b 6579 7322 3a20 7365 6c66 2e73  el-keys": self.s
-0001f050: 7469 6d75 6c75 735f 6361 6e63 656c 2c0a  timulus_cancel,.
-0001f060: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0001f070: 2020 2073 656c 662e 6861 6e64 6c65 7273     self.handlers
-0001f080: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0001f090: 2022 7265 6769 7374 6572 2d63 6c69 656e   "register-clien
-0001f0a0: 7422 3a20 7365 6c66 2e61 6464 5f63 6c69  t": self.add_cli
-0001f0b0: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-0001f0c0: 2022 7363 6174 7465 7222 3a20 7365 6c66   "scatter": self
-0001f0d0: 2e73 6361 7474 6572 2c0a 2020 2020 2020  .scatter,.      
-0001f0e0: 2020 2020 2020 2272 6567 6973 7465 722d        "register-
-0001f0f0: 776f 726b 6572 223a 2073 656c 662e 6164  worker": self.ad
-0001f100: 645f 776f 726b 6572 2c0a 2020 2020 2020  d_worker,.      
-0001f110: 2020 2020 2020 2272 6567 6973 7465 725f        "register_
-0001f120: 6e61 6e6e 7922 3a20 7365 6c66 2e61 6464  nanny": self.add
-0001f130: 5f6e 616e 6e79 2c0a 2020 2020 2020 2020  _nanny,.        
-0001f140: 2020 2020 2275 6e72 6567 6973 7465 7222      "unregister"
-0001f150: 3a20 7365 6c66 2e72 656d 6f76 655f 776f  : self.remove_wo
-0001f160: 726b 6572 2c0a 2020 2020 2020 2020 2020  rker,.          
-0001f170: 2020 2267 6174 6865 7222 3a20 7365 6c66    "gather": self
-0001f180: 2e67 6174 6865 722c 0a20 2020 2020 2020  .gather,.       
-0001f190: 2020 2020 2022 7265 7472 7922 3a20 7365       "retry": se
-0001f1a0: 6c66 2e73 7469 6d75 6c75 735f 7265 7472  lf.stimulus_retr
-0001f1b0: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
-0001f1c0: 6665 6564 223a 2073 656c 662e 6665 6564  feed": self.feed
-0001f1d0: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-0001f1e0: 6572 6d69 6e61 7465 223a 2073 656c 662e  erminate": self.
-0001f1f0: 636c 6f73 652c 0a20 2020 2020 2020 2020  close,.         
-0001f200: 2020 2022 6272 6f61 6463 6173 7422 3a20     "broadcast": 
-0001f210: 7365 6c66 2e62 726f 6164 6361 7374 2c0a  self.broadcast,.
-0001f220: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
-0001f230: 7879 223a 2073 656c 662e 7072 6f78 792c  xy": self.proxy,
-0001f240: 0a20 2020 2020 2020 2020 2020 2022 6e63  .            "nc
-0001f250: 6f72 6573 223a 2073 656c 662e 6765 745f  ores": self.get_
-0001f260: 6e63 6f72 6573 2c0a 2020 2020 2020 2020  ncores,.        
-0001f270: 2020 2020 226e 636f 7265 735f 7275 6e6e      "ncores_runn
-0001f280: 696e 6722 3a20 7365 6c66 2e67 6574 5f6e  ing": self.get_n
-0001f290: 636f 7265 735f 7275 6e6e 696e 672c 0a20  cores_running,. 
-0001f2a0: 2020 2020 2020 2020 2020 2022 6861 735f             "has_
-0001f2b0: 7768 6174 223a 2073 656c 662e 6765 745f  what": self.get_
-0001f2c0: 6861 735f 7768 6174 2c0a 2020 2020 2020  has_what,.      
-0001f2d0: 2020 2020 2020 2277 686f 5f68 6173 223a        "who_has":
-0001f2e0: 2073 656c 662e 6765 745f 7768 6f5f 6861   self.get_who_ha
-0001f2f0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0001f300: 7072 6f63 6573 7369 6e67 223a 2073 656c  processing": sel
-0001f310: 662e 6765 745f 7072 6f63 6573 7369 6e67  f.get_processing
-0001f320: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-0001f330: 616c 6c5f 7374 6163 6b22 3a20 7365 6c66  all_stack": self
-0001f340: 2e67 6574 5f63 616c 6c5f 7374 6163 6b2c  .get_call_stack,
-0001f350: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
-0001f360: 6f66 696c 6522 3a20 7365 6c66 2e67 6574  ofile": self.get
-0001f370: 5f70 726f 6669 6c65 2c0a 2020 2020 2020  _profile,.      
-0001f380: 2020 2020 2020 2270 6572 666f 726d 616e        "performan
-0001f390: 6365 5f72 6570 6f72 7422 3a20 7365 6c66  ce_report": self
-0001f3a0: 2e70 6572 666f 726d 616e 6365 5f72 6570  .performance_rep
-0001f3b0: 6f72 742c 0a20 2020 2020 2020 2020 2020  ort,.           
-0001f3c0: 2022 6765 745f 6c6f 6773 223a 2073 656c   "get_logs": sel
-0001f3d0: 662e 6765 745f 6c6f 6773 2c0a 2020 2020  f.get_logs,.    
-0001f3e0: 2020 2020 2020 2020 226c 6f67 7322 3a20          "logs": 
-0001f3f0: 7365 6c66 2e67 6574 5f6c 6f67 732c 0a20  self.get_logs,. 
-0001f400: 2020 2020 2020 2020 2020 2022 776f 726b             "work
-0001f410: 6572 5f6c 6f67 7322 3a20 7365 6c66 2e67  er_logs": self.g
-0001f420: 6574 5f77 6f72 6b65 725f 6c6f 6773 2c0a  et_worker_logs,.
-0001f430: 2020 2020 2020 2020 2020 2020 226c 6f67              "log
-0001f440: 5f65 7665 6e74 223a 2073 656c 662e 6c6f  _event": self.lo
-0001f450: 675f 6576 656e 742c 0a20 2020 2020 2020  g_event,.       
-0001f460: 2020 2020 2022 6576 656e 7473 223a 2073       "events": s
-0001f470: 656c 662e 6765 745f 6576 656e 7473 2c0a  elf.get_events,.
-0001f480: 2020 2020 2020 2020 2020 2020 226e 6279              "nby
-0001f490: 7465 7322 3a20 7365 6c66 2e67 6574 5f6e  tes": self.get_n
-0001f4a0: 6279 7465 732c 0a20 2020 2020 2020 2020  bytes,.         
-0001f4b0: 2020 2022 7665 7273 696f 6e73 223a 2073     "versions": s
-0001f4c0: 656c 662e 7665 7273 696f 6e73 2c0a 2020  elf.versions,.  
-0001f4d0: 2020 2020 2020 2020 2020 2261 6464 5f6b            "add_k
-0001f4e0: 6579 7322 3a20 7365 6c66 2e61 6464 5f6b  eys": self.add_k
-0001f4f0: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
-0001f500: 2022 7265 6261 6c61 6e63 6522 3a20 7365   "rebalance": se
-0001f510: 6c66 2e72 6562 616c 616e 6365 2c0a 2020  lf.rebalance,.  
-0001f520: 2020 2020 2020 2020 2020 2272 6570 6c69            "repli
-0001f530: 6361 7465 223a 2073 656c 662e 7265 706c  cate": self.repl
-0001f540: 6963 6174 652c 0a20 2020 2020 2020 2020  icate,.         
-0001f550: 2020 2022 7275 6e5f 6675 6e63 7469 6f6e     "run_function
-0001f560: 223a 2073 656c 662e 7275 6e5f 6675 6e63  ": self.run_func
-0001f570: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-0001f580: 2020 2272 6573 7461 7274 223a 2073 656c    "restart": sel
-0001f590: 662e 7265 7374 6172 742c 0a20 2020 2020  f.restart,.     
-0001f5a0: 2020 2020 2020 2022 7570 6461 7465 5f64         "update_d
-0001f5b0: 6174 6122 3a20 7365 6c66 2e75 7064 6174  ata": self.updat
-0001f5c0: 655f 6461 7461 2c0a 2020 2020 2020 2020  e_data,.        
-0001f5d0: 2020 2020 2273 6574 5f72 6573 6f75 7263      "set_resourc
-0001f5e0: 6573 223a 2073 656c 662e 6164 645f 7265  es": self.add_re
-0001f5f0: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
-0001f600: 2020 2020 2022 7265 7469 7265 5f77 6f72       "retire_wor
-0001f610: 6b65 7273 223a 2073 656c 662e 7265 7469  kers": self.reti
-0001f620: 7265 5f77 6f72 6b65 7273 2c0a 2020 2020  re_workers,.    
-0001f630: 2020 2020 2020 2020 2267 6574 5f6d 6574          "get_met
-0001f640: 6164 6174 6122 3a20 7365 6c66 2e67 6574  adata": self.get
-0001f650: 5f6d 6574 6164 6174 612c 0a20 2020 2020  _metadata,.     
-0001f660: 2020 2020 2020 2022 7365 745f 6d65 7461         "set_meta
-0001f670: 6461 7461 223a 2073 656c 662e 7365 745f  data": self.set_
-0001f680: 6d65 7461 6461 7461 2c0a 2020 2020 2020  metadata,.      
-0001f690: 2020 2020 2020 2273 6574 5f72 6573 7472        "set_restr
-0001f6a0: 6963 7469 6f6e 7322 3a20 7365 6c66 2e73  ictions": self.s
-0001f6b0: 6574 5f72 6573 7472 6963 7469 6f6e 732c  et_restrictions,
-0001f6c0: 0a20 2020 2020 2020 2020 2020 2022 6865  .            "he
-0001f6d0: 6172 7462 6561 745f 776f 726b 6572 223a  artbeat_worker":
-0001f6e0: 2073 656c 662e 6865 6172 7462 6561 745f   self.heartbeat_
-0001f6f0: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
-0001f700: 2020 2020 2267 6574 5f74 6173 6b5f 7374      "get_task_st
-0001f710: 6174 7573 223a 2073 656c 662e 6765 745f  atus": self.get_
-0001f720: 7461 736b 5f73 7461 7475 732c 0a20 2020  task_status,.   
-0001f730: 2020 2020 2020 2020 2022 6765 745f 7461           "get_ta
-0001f740: 736b 5f73 7472 6561 6d22 3a20 7365 6c66  sk_stream": self
-0001f750: 2e67 6574 5f74 6173 6b5f 7374 7265 616d  .get_task_stream
-0001f760: 2c0a 2020 2020 2020 2020 2020 2020 2267  ,.            "g
-0001f770: 6574 5f74 6173 6b5f 7072 6566 6978 5f73  et_task_prefix_s
-0001f780: 7461 7465 7322 3a20 7365 6c66 2e67 6574  tates": self.get
-0001f790: 5f74 6173 6b5f 7072 6566 6978 5f73 7461  _task_prefix_sta
-0001f7a0: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
-0001f7b0: 2022 7265 6769 7374 6572 5f73 6368 6564   "register_sched
-0001f7c0: 756c 6572 5f70 6c75 6769 6e22 3a20 7365  uler_plugin": se
-0001f7d0: 6c66 2e72 6567 6973 7465 725f 7363 6865  lf.register_sche
-0001f7e0: 6475 6c65 725f 706c 7567 696e 2c0a 2020  duler_plugin,.  
-0001f7f0: 2020 2020 2020 2020 2020 2272 6567 6973            "regis
-0001f800: 7465 725f 776f 726b 6572 5f70 6c75 6769  ter_worker_plugi
-0001f810: 6e22 3a20 7365 6c66 2e72 6567 6973 7465  n": self.registe
-0001f820: 725f 776f 726b 6572 5f70 6c75 6769 6e2c  r_worker_plugin,
-0001f830: 0a20 2020 2020 2020 2020 2020 2022 756e  .            "un
-0001f840: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
-0001f850: 706c 7567 696e 223a 2073 656c 662e 756e  plugin": self.un
-0001f860: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
-0001f870: 706c 7567 696e 2c0a 2020 2020 2020 2020  plugin,.        
-0001f880: 2020 2020 2272 6567 6973 7465 725f 6e61      "register_na
-0001f890: 6e6e 795f 706c 7567 696e 223a 2073 656c  nny_plugin": sel
-0001f8a0: 662e 7265 6769 7374 6572 5f6e 616e 6e79  f.register_nanny
-0001f8b0: 5f70 6c75 6769 6e2c 0a20 2020 2020 2020  _plugin,.       
-0001f8c0: 2020 2020 2022 756e 7265 6769 7374 6572       "unregister
-0001f8d0: 5f6e 616e 6e79 5f70 6c75 6769 6e22 3a20  _nanny_plugin": 
-0001f8e0: 7365 6c66 2e75 6e72 6567 6973 7465 725f  self.unregister_
-0001f8f0: 6e61 6e6e 795f 706c 7567 696e 2c0a 2020  nanny_plugin,.  
-0001f900: 2020 2020 2020 2020 2020 2261 6461 7074            "adapt
-0001f910: 6976 655f 7461 7267 6574 223a 2073 656c  ive_target": sel
-0001f920: 662e 6164 6170 7469 7665 5f74 6172 6765  f.adaptive_targe
-0001f930: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
-0001f940: 776f 726b 6572 735f 746f 5f63 6c6f 7365  workers_to_close
-0001f950: 223a 2073 656c 662e 776f 726b 6572 735f  ": self.workers_
-0001f960: 746f 5f63 6c6f 7365 2c0a 2020 2020 2020  to_close,.      
-0001f970: 2020 2020 2020 2273 7562 7363 7269 6265        "subscribe
-0001f980: 5f77 6f72 6b65 725f 7374 6174 7573 223a  _worker_status":
-0001f990: 2073 656c 662e 7375 6273 6372 6962 655f   self.subscribe_
-0001f9a0: 776f 726b 6572 5f73 7461 7475 732c 0a20  worker_status,. 
-0001f9b0: 2020 2020 2020 2020 2020 2022 7374 6172             "star
-0001f9c0: 745f 7461 736b 5f6d 6574 6164 6174 6122  t_task_metadata"
-0001f9d0: 3a20 7365 6c66 2e73 7461 7274 5f74 6173  : self.start_tas
-0001f9e0: 6b5f 6d65 7461 6461 7461 2c0a 2020 2020  k_metadata,.    
-0001f9f0: 2020 2020 2020 2020 2273 746f 705f 7461          "stop_ta
-0001fa00: 736b 5f6d 6574 6164 6174 6122 3a20 7365  sk_metadata": se
-0001fa10: 6c66 2e73 746f 705f 7461 736b 5f6d 6574  lf.stop_task_met
-0001fa20: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
-0001fa30: 2020 2022 6765 745f 636c 7573 7465 725f     "get_cluster_
-0001fa40: 7374 6174 6522 3a20 7365 6c66 2e67 6574  state": self.get
-0001fa50: 5f63 6c75 7374 6572 5f73 7461 7465 2c0a  _cluster_state,.
-0001fa60: 2020 2020 2020 2020 2020 2020 2264 756d              "dum
-0001fa70: 705f 636c 7573 7465 725f 7374 6174 655f  p_cluster_state_
-0001fa80: 746f 5f75 726c 223a 2073 656c 662e 6475  to_url": self.du
-0001fa90: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
-0001faa0: 5f74 6f5f 7572 6c2c 0a20 2020 2020 2020  _to_url,.       
-0001fab0: 2020 2020 2022 6265 6e63 686d 6172 6b5f       "benchmark_
-0001fac0: 6861 7264 7761 7265 223a 2073 656c 662e  hardware": self.
-0001fad0: 6265 6e63 686d 6172 6b5f 6861 7264 7761  benchmark_hardwa
-0001fae0: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
-0001faf0: 2267 6574 5f73 746f 7279 223a 2073 656c  "get_story": sel
-0001fb00: 662e 6765 745f 7374 6f72 792c 0a20 2020  f.get_story,.   
-0001fb10: 2020 2020 2020 2020 2022 6368 6563 6b5f           "check_
-0001fb20: 6964 6c65 223a 2073 656c 662e 6368 6563  idle": self.chec
-0001fb30: 6b5f 6964 6c65 2c0a 2020 2020 2020 2020  k_idle,.        
-0001fb40: 7d0a 0a20 2020 2020 2020 2063 6f6e 6e65  }..        conne
-0001fb50: 6374 696f 6e5f 6c69 6d69 7420 3d20 6765  ction_limit = ge
-0001fb60: 745f 6669 6c65 6e6f 5f6c 696d 6974 2829  t_fileno_limit()
-0001fb70: 202f 2032 0a0a 2020 2020 2020 2020 5363   / 2..        Sc
-0001fb80: 6865 6475 6c65 7253 7461 7465 2e5f 5f69  hedulerState.__i
-0001fb90: 6e69 745f 5f28 0a20 2020 2020 2020 2020  nit__(.         
-0001fba0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001fbb0: 2020 2020 2061 6c69 6173 6573 3d61 6c69       aliases=ali
-0001fbc0: 6173 6573 2c0a 2020 2020 2020 2020 2020  ases,.          
-0001fbd0: 2020 636c 6965 6e74 733d 636c 6965 6e74    clients=client
-0001fbe0: 732c 0a20 2020 2020 2020 2020 2020 2077  s,.            w
-0001fbf0: 6f72 6b65 7273 3d77 6f72 6b65 7273 2c0a  orkers=workers,.
-0001fc00: 2020 2020 2020 2020 2020 2020 686f 7374              host
-0001fc10: 5f69 6e66 6f3d 686f 7374 5f69 6e66 6f2c  _info=host_info,
-0001fc20: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0001fc30: 6f75 7263 6573 3d72 6573 6f75 7263 6573  ources=resources
-0001fc40: 2c0a 2020 2020 2020 2020 2020 2020 7461  ,.            ta
-0001fc50: 736b 733d 7461 736b 732c 0a20 2020 2020  sks=tasks,.     
-0001fc60: 2020 2020 2020 2075 6e72 756e 6e61 626c         unrunnabl
-0001fc70: 653d 756e 7275 6e6e 6162 6c65 2c0a 2020  e=unrunnable,.  
-0001fc80: 2020 2020 2020 2020 2020 7175 6575 6564            queued
-0001fc90: 3d71 7565 7565 642c 0a20 2020 2020 2020  =queued,.       
-0001fca0: 2020 2020 2076 616c 6964 6174 653d 7661       validate=va
-0001fcb0: 6c69 6461 7465 2c0a 2020 2020 2020 2020  lidate,.        
-0001fcc0: 2020 2020 706c 7567 696e 733d 706c 7567      plugins=plug
-0001fcd0: 696e 732c 0a20 2020 2020 2020 2020 2020  ins,.           
-0001fce0: 2074 7261 6e73 6974 696f 6e5f 636f 756e   transition_coun
-0001fcf0: 7465 725f 6d61 783d 7472 616e 7369 7469  ter_max=transiti
-0001fd00: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 2c0a  on_counter_max,.
-0001fd10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001fd20: 2020 5365 7276 6572 4e6f 6465 2e5f 5f69    ServerNode.__i
-0001fd30: 6e69 745f 5f28 0a20 2020 2020 2020 2020  nit__(.         
-0001fd40: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001fd50: 2020 2020 2068 616e 646c 6572 733d 7365       handlers=se
-0001fd60: 6c66 2e68 616e 646c 6572 732c 0a20 2020  lf.handlers,.   
-0001fd70: 2020 2020 2020 2020 2073 7472 6561 6d5f           stream_
-0001fd80: 6861 6e64 6c65 7273 3d6d 6572 6765 2877  handlers=merge(w
-0001fd90: 6f72 6b65 725f 6861 6e64 6c65 7273 2c20  orker_handlers, 
-0001fda0: 636c 6965 6e74 5f68 616e 646c 6572 7329  client_handlers)
-0001fdb0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-0001fdc0: 6e6e 6563 7469 6f6e 5f6c 696d 6974 3d63  nnection_limit=c
-0001fdd0: 6f6e 6e65 6374 696f 6e5f 6c69 6d69 742c  onnection_limit,
-0001fde0: 0a20 2020 2020 2020 2020 2020 2064 6573  .            des
-0001fdf0: 6572 6961 6c69 7a65 3d46 616c 7365 2c0a  erialize=False,.
-0001fe00: 2020 2020 2020 2020 2020 2020 636f 6e6e              conn
-0001fe10: 6563 7469 6f6e 5f61 7267 733d 7365 6c66  ection_args=self
-0001fe20: 2e63 6f6e 6e65 6374 696f 6e5f 6172 6773  .connection_args
-0001fe30: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-0001fe40: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-0001fe50: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-0001fe60: 6c66 2e77 6f72 6b65 725f 7474 6c3a 0a20  lf.worker_ttl:. 
-0001fe70: 2020 2020 2020 2020 2020 2070 6320 3d20             pc = 
-0001fe80: 5065 7269 6f64 6963 4361 6c6c 6261 636b  PeriodicCallback
-0001fe90: 2873 656c 662e 6368 6563 6b5f 776f 726b  (self.check_work
-0001fea0: 6572 5f74 746c 2c20 7365 6c66 2e77 6f72  er_ttl, self.wor
-0001feb0: 6b65 725f 7474 6c20 2a20 3130 3030 290a  ker_ttl * 1000).
-0001fec0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001fed0: 2e70 6572 696f 6469 635f 6361 6c6c 6261  .periodic_callba
-0001fee0: 636b 735b 2277 6f72 6b65 722d 7474 6c22  cks["worker-ttl"
-0001fef0: 5d20 3d20 7063 0a0a 2020 2020 2020 2020  ] = pc..        
-0001ff00: 7063 203d 2050 6572 696f 6469 6343 616c  pc = PeriodicCal
-0001ff10: 6c62 6163 6b28 7365 6c66 2e63 6865 636b  lback(self.check
-0001ff20: 5f69 646c 652c 2028 7365 6c66 2e69 646c  _idle, (self.idl
-0001ff30: 655f 7469 6d65 6f75 7420 6f72 2031 2920  e_timeout or 1) 
-0001ff40: 2a20 3130 3030 202f 2034 290a 2020 2020  * 1000 / 4).    
-0001ff50: 2020 2020 7365 6c66 2e70 6572 696f 6469      self.periodi
-0001ff60: 635f 6361 6c6c 6261 636b 735b 2269 646c  c_callbacks["idl
-0001ff70: 652d 7469 6d65 6f75 7422 5d20 3d20 7063  e-timeout"] = pc
-0001ff80: 0a0a 2020 2020 2020 2020 6966 2065 7874  ..        if ext
-0001ff90: 656e 7369 6f6e 7320 6973 204e 6f6e 653a  ensions is None:
-0001ffa0: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
-0001ffb0: 656e 7369 6f6e 7320 3d20 4445 4641 554c  ensions = DEFAUL
-0001ffc0: 545f 4558 5445 4e53 494f 4e53 2e63 6f70  T_EXTENSIONS.cop
-0001ffd0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-0001ffe0: 6966 206e 6f74 2064 6173 6b2e 636f 6e66  if not dask.conf
-0001fff0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-00020000: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
-00020010: 726b 2d73 7465 616c 696e 6722 293a 0a20  rk-stealing"):. 
-00020020: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00020030: 6620 2273 7465 616c 696e 6722 2069 6e20  f "stealing" in 
-00020040: 6578 7465 6e73 696f 6e73 3a0a 2020 2020  extensions:.    
-00020050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020060: 6465 6c20 6578 7465 6e73 696f 6e73 5b22  del extensions["
-00020070: 7374 6561 6c69 6e67 225d 0a0a 2020 2020  stealing"]..    
-00020080: 2020 2020 666f 7220 6e61 6d65 2c20 6578      for name, ex
-00020090: 7465 6e73 696f 6e20 696e 2065 7874 656e  tension in exten
-000200a0: 7369 6f6e 732e 6974 656d 7328 293a 0a20  sions.items():. 
-000200b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000200c0: 6578 7465 6e73 696f 6e73 5b6e 616d 655d  extensions[name]
-000200d0: 203d 2065 7874 656e 7369 6f6e 2873 656c   = extension(sel
-000200e0: 6629 0a0a 2020 2020 2020 2020 7365 7470  f)..        setp
-000200f0: 726f 6374 6974 6c65 2822 6461 736b 2073  roctitle("dask s
-00020100: 6368 6564 756c 6572 205b 6e6f 7420 7374  cheduler [not st
-00020110: 6172 7465 645d 2229 0a20 2020 2020 2020  arted]").       
-00020120: 2053 6368 6564 756c 6572 2e5f 696e 7374   Scheduler._inst
-00020130: 616e 6365 732e 6164 6428 7365 6c66 290a  ances.add(self).
-00020140: 2020 2020 2020 2020 7365 6c66 2e72 7063          self.rpc
-00020150: 2e61 6c6c 6f77 5f6f 6666 6c6f 6164 203d  .allow_offload =
-00020160: 2046 616c 7365 0a0a 2020 2020 2323 2323   False..    ####
-00020170: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-00020180: 2020 2023 2041 646d 696e 6973 7472 6174     # Administrat
-00020190: 696f 6e20 230a 2020 2020 2323 2323 2323  ion #.    ######
-000201a0: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
-000201b0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
-000201c0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-000201d0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
-000201e0: 2020 2066 223c 5363 6865 6475 6c65 7220     f"<Scheduler 
-000201f0: 7b73 656c 662e 6164 6472 6573 735f 7361  {self.address_sa
-00020200: 6665 2172 7d2c 2022 0a20 2020 2020 2020  fe!r}, ".       
-00020210: 2020 2020 2066 2277 6f72 6b65 7273 3a20       f"workers: 
-00020220: 7b6c 656e 2873 656c 662e 776f 726b 6572  {len(self.worker
-00020230: 7329 7d2c 2022 0a20 2020 2020 2020 2020  s)}, ".         
-00020240: 2020 2066 2263 6f72 6573 3a20 7b73 656c     f"cores: {sel
-00020250: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
-00020260: 7d2c 2022 0a20 2020 2020 2020 2020 2020  }, ".           
-00020270: 2066 2274 6173 6b73 3a20 7b6c 656e 2873   f"tasks: {len(s
-00020280: 656c 662e 7461 736b 7329 7d3e 220a 2020  elf.tasks)}>".  
-00020290: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-000202a0: 205f 7265 7072 5f68 746d 6c5f 2873 656c   _repr_html_(sel
-000202b0: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-000202c0: 726e 2067 6574 5f74 656d 706c 6174 6528  rn get_template(
-000202d0: 2273 6368 6564 756c 6572 2e68 746d 6c2e  "scheduler.html.
-000202e0: 6a32 2229 2e72 656e 6465 7228 0a20 2020  j2").render(.   
-000202f0: 2020 2020 2020 2020 2061 6464 7265 7373           address
-00020300: 3d73 656c 662e 6164 6472 6573 732c 0a20  =self.address,. 
-00020310: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00020320: 7273 3d73 656c 662e 776f 726b 6572 732c  rs=self.workers,
-00020330: 0a20 2020 2020 2020 2020 2020 2074 6872  .            thr
-00020340: 6561 6473 3d73 656c 662e 746f 7461 6c5f  eads=self.total_
-00020350: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
-00020360: 2020 2020 2020 7461 736b 733d 7365 6c66        tasks=self
-00020370: 2e74 6173 6b73 2c0a 2020 2020 2020 2020  .tasks,.        
-00020380: 290a 0a20 2020 2064 6566 2069 6465 6e74  )..    def ident
-00020390: 6974 7928 7365 6c66 293a 0a20 2020 2020  ity(self):.     
-000203a0: 2020 2022 2222 4261 7369 6320 696e 666f     """Basic info
-000203b0: 726d 6174 696f 6e20 6162 6f75 7420 6f75  rmation about ou
-000203c0: 7273 656c 7665 7320 616e 6420 6f75 7220  rselves and our 
-000203d0: 636c 7573 7465 7222 2222 0a20 2020 2020  cluster""".     
-000203e0: 2020 2064 203d 207b 0a20 2020 2020 2020     d = {.       
-000203f0: 2020 2020 2022 7479 7065 223a 2074 7970       "type": typ
-00020400: 6528 7365 6c66 292e 5f5f 6e61 6d65 5f5f  e(self).__name__
-00020410: 2c0a 2020 2020 2020 2020 2020 2020 2269  ,.            "i
-00020420: 6422 3a20 7374 7228 7365 6c66 2e69 6429  d": str(self.id)
-00020430: 2c0a 2020 2020 2020 2020 2020 2020 2261  ,.            "a
-00020440: 6464 7265 7373 223a 2073 656c 662e 6164  ddress": self.ad
-00020450: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
-00020460: 2020 2022 7365 7276 6963 6573 223a 207b     "services": {
-00020470: 6b65 793a 2076 2e70 6f72 7420 666f 7220  key: v.port for 
-00020480: 286b 6579 2c20 7629 2069 6e20 7365 6c66  (key, v) in self
-00020490: 2e73 6572 7669 6365 732e 6974 656d 7328  .services.items(
-000204a0: 297d 2c0a 2020 2020 2020 2020 2020 2020  )},.            
-000204b0: 2273 7461 7274 6564 223a 2073 656c 662e  "started": self.
-000204c0: 7469 6d65 5f73 7461 7274 6564 2c0a 2020  time_started,.  
-000204d0: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-000204e0: 7273 223a 207b 0a20 2020 2020 2020 2020  rs": {.         
-000204f0: 2020 2020 2020 2077 6f72 6b65 722e 6164         worker.ad
-00020500: 6472 6573 733a 2077 6f72 6b65 722e 6964  dress: worker.id
-00020510: 656e 7469 7479 2829 2066 6f72 2077 6f72  entity() for wor
-00020520: 6b65 7220 696e 2073 656c 662e 776f 726b  ker in self.work
-00020530: 6572 732e 7661 6c75 6573 2829 0a20 2020  ers.values().   
-00020540: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00020550: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
-00020560: 7475 726e 2064 0a0a 2020 2020 6465 6620  turn d..    def 
-00020570: 5f74 6f5f 6469 6374 2873 656c 662c 202a  _to_dict(self, *
-00020580: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
-00020590: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
-000205a0: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
-000205b0: 2022 2222 4469 6374 696f 6e61 7279 2072   """Dictionary r
-000205c0: 6570 7265 7365 6e74 6174 696f 6e20 666f  epresentation fo
-000205d0: 7220 6465 6275 6767 696e 6720 7075 7270  r debugging purp
-000205e0: 6f73 6573 2e0a 2020 2020 2020 2020 4e6f  oses..        No
-000205f0: 7420 7479 7065 2073 7461 626c 6520 616e  t type stable an
-00020600: 6420 6e6f 7420 696e 7465 6e64 6564 2066  d not intended f
-00020610: 6f72 2072 6f75 6e64 7472 6970 732e 0a0a  or roundtrips...
-00020620: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-00020630: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00020640: 2d0a 2020 2020 2020 2020 5365 7276 6572  -.        Server
-00020650: 2e69 6465 6e74 6974 790a 2020 2020 2020  .identity.      
-00020660: 2020 436c 6965 6e74 2e64 756d 705f 636c    Client.dump_cl
-00020670: 7573 7465 725f 7374 6174 650a 2020 2020  uster_state.    
-00020680: 2020 2020 6469 7374 7269 6275 7465 642e      distributed.
-00020690: 7574 696c 732e 7265 6375 7273 6976 655f  utils.recursive_
-000206a0: 746f 5f64 6963 740a 2020 2020 2020 2020  to_dict.        
-000206b0: 2222 220a 2020 2020 2020 2020 696e 666f  """.        info
-000206c0: 203d 2073 7570 6572 2829 2e5f 746f 5f64   = super()._to_d
-000206d0: 6963 7428 6578 636c 7564 653d 6578 636c  ict(exclude=excl
-000206e0: 7564 6529 0a20 2020 2020 2020 2065 7874  ude).        ext
-000206f0: 7261 203d 207b 0a20 2020 2020 2020 2020  ra = {.         
-00020700: 2020 2022 7472 616e 7369 7469 6f6e 5f6c     "transition_l
-00020710: 6f67 223a 2073 656c 662e 7472 616e 7369  og": self.transi
-00020720: 7469 6f6e 5f6c 6f67 2c0a 2020 2020 2020  tion_log,.      
-00020730: 2020 2020 2020 2274 7261 6e73 6974 696f        "transitio
-00020740: 6e5f 636f 756e 7465 7222 3a20 7365 6c66  n_counter": self
-00020750: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-00020760: 7465 722c 0a20 2020 2020 2020 2020 2020  ter,.           
-00020770: 2022 7461 736b 7322 3a20 7365 6c66 2e74   "tasks": self.t
-00020780: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-00020790: 2020 2274 6173 6b5f 6772 6f75 7073 223a    "task_groups":
-000207a0: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-000207b0: 732c 0a20 2020 2020 2020 2020 2020 2023  s,.            #
-000207c0: 204f 7665 7277 7269 7465 2064 6963 7420   Overwrite dict 
-000207d0: 6f66 2057 6f72 6b65 7253 7461 7465 2e69  of WorkerState.i
-000207e0: 6465 6e74 6974 7920 6672 6f6d 2069 6e66  dentity from inf
-000207f0: 6f0a 2020 2020 2020 2020 2020 2020 2277  o.            "w
-00020800: 6f72 6b65 7273 223a 2073 656c 662e 776f  orkers": self.wo
-00020810: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
-00020820: 2020 2022 636c 6965 6e74 7322 3a20 7365     "clients": se
-00020830: 6c66 2e63 6c69 656e 7473 2c0a 2020 2020  lf.clients,.    
-00020840: 2020 2020 2020 2020 226d 656d 6f72 7922          "memory"
-00020850: 3a20 7365 6c66 2e6d 656d 6f72 792c 0a20  : self.memory,. 
-00020860: 2020 2020 2020 2020 2020 2022 6576 656e             "even
-00020870: 7473 223a 2073 656c 662e 6576 656e 7473  ts": self.events
-00020880: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
-00020890: 7874 656e 7369 6f6e 7322 3a20 7365 6c66  xtensions": self
-000208a0: 2e65 7874 656e 7369 6f6e 732c 0a20 2020  .extensions,.   
-000208b0: 2020 2020 207d 0a20 2020 2020 2020 2065       }.        e
-000208c0: 7874 7261 203d 207b 6b3a 2076 2066 6f72  xtra = {k: v for
-000208d0: 206b 2c20 7620 696e 2065 7874 7261 2e69   k, v in extra.i
-000208e0: 7465 6d73 2829 2069 6620 6b20 6e6f 7420  tems() if k not 
-000208f0: 696e 2065 7863 6c75 6465 7d0a 2020 2020  in exclude}.    
-00020900: 2020 2020 696e 666f 2e75 7064 6174 6528      info.update(
-00020910: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
-00020920: 7428 6578 7472 612c 2065 7863 6c75 6465  t(extra, exclude
-00020930: 3d65 7863 6c75 6465 2929 0a20 2020 2020  =exclude)).     
-00020940: 2020 2072 6574 7572 6e20 696e 666f 0a0a     return info..
-00020950: 2020 2020 6173 796e 6320 6465 6620 6765      async def ge
-00020960: 745f 636c 7573 7465 725f 7374 6174 6528  t_cluster_state(
-00020970: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00020980: 2020 2020 2020 2065 7863 6c75 6465 3a20         exclude: 
-00020990: 2243 6f6c 6c65 6374 696f 6e5b 7374 725d  "Collection[str]
-000209a0: 222c 0a20 2020 2029 202d 3e20 6469 6374  ",.    ) -> dict
-000209b0: 3a0a 2020 2020 2020 2020 2250 726f 6475  :.        "Produ
-000209c0: 6365 2074 6865 2073 7461 7465 2064 6963  ce the state dic
-000209d0: 7420 7573 6564 2069 6e20 6120 636c 7573  t used in a clus
-000209e0: 7465 7220 7374 6174 6520 6475 6d70 220a  ter state dump".
-000209f0: 2020 2020 2020 2020 2320 4b69 636b 206f          # Kick o
-00020a00: 6666 2073 7461 7465 2d64 756d 7069 6e67  ff state-dumping
-00020a10: 206f 6e20 776f 726b 6572 7320 6265 666f   on workers befo
-00020a20: 7265 2077 6520 626c 6f63 6b20 7468 6520  re we block the 
-00020a30: 6576 656e 7420 6c6f 6f70 2069 6e20 6073  event loop in `s
-00020a40: 656c 662e 5f74 6f5f 6469 6374 602e 0a20  elf._to_dict`.. 
-00020a50: 2020 2020 2020 2077 6f72 6b65 7273 5f66         workers_f
-00020a60: 7574 7572 6520 3d20 6173 796e 6369 6f2e  uture = asyncio.
-00020a70: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-00020a80: 2020 2020 7365 6c66 2e62 726f 6164 6361      self.broadca
-00020a90: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00020aa0: 2020 2020 6d73 673d 7b22 6f70 223a 2022      msg={"op": "
-00020ab0: 6475 6d70 5f73 7461 7465 222c 2022 6578  dump_state", "ex
-00020ac0: 636c 7564 6522 3a20 6578 636c 7564 657d  clude": exclude}
-00020ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020ae0: 2020 6f6e 5f65 7272 6f72 3d22 7265 7475    on_error="retu
-00020af0: 726e 222c 0a20 2020 2020 2020 2020 2020  rn",.           
-00020b00: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00020b10: 7365 6c66 2e62 726f 6164 6361 7374 280a  self.broadcast(.
-00020b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b30: 6d73 673d 7b22 6f70 223a 2022 7665 7273  msg={"op": "vers
-00020b40: 696f 6e73 227d 2c0a 2020 2020 2020 2020  ions"},.        
-00020b50: 2020 2020 2020 2020 6f6e 5f65 7272 6f72          on_error
-00020b60: 3d22 6967 6e6f 7265 222c 0a20 2020 2020  ="ignore",.     
-00020b70: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00020b80: 2020 290a 2020 2020 2020 2020 7472 793a    ).        try:
-00020b90: 0a20 2020 2020 2020 2020 2020 2073 6368  .            sch
-00020ba0: 6564 756c 6572 5f73 7461 7465 203d 2073  eduler_state = s
-00020bb0: 656c 662e 5f74 6f5f 6469 6374 2865 7863  elf._to_dict(exc
-00020bc0: 6c75 6465 3d65 7863 6c75 6465 290a 0a20  lude=exclude).. 
-00020bd0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00020be0: 725f 7374 6174 6573 2c20 776f 726b 6572  r_states, worker
-00020bf0: 5f76 6572 7369 6f6e 7320 3d20 6177 6169  _versions = awai
-00020c00: 7420 776f 726b 6572 735f 6675 7475 7265  t workers_future
-00020c10: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-00020c20: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00020c30: 456e 7375 7265 2074 6865 2074 6173 6b73  Ensure the tasks
-00020c40: 2061 7265 6e27 7420 6c65 6674 2072 756e   aren't left run
-00020c50: 6e69 6e67 2069 6620 616e 7974 6869 6e67  ning if anything
-00020c60: 2066 6169 6c73 2e0a 2020 2020 2020 2020   fails..        
-00020c70: 2020 2020 2320 536f 6d65 6461 7920 2870      # Someday (p
-00020c80: 7933 2e31 3129 2c20 7573 6520 6120 7472  y3.11), use a tr
-00020c90: 696f 2d73 7479 6c65 2054 6173 6b47 726f  io-style TaskGro
-00020ca0: 7570 2066 6f72 2074 6869 732e 0a20 2020  up for this..   
-00020cb0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00020cc0: 5f66 7574 7572 652e 6361 6e63 656c 2829  _future.cancel()
-00020cd0: 0a0a 2020 2020 2020 2020 2320 436f 6e76  ..        # Conv
-00020ce0: 6572 7420 616e 7920 5250 4320 6572 726f  ert any RPC erro
-00020cf0: 7273 2074 6f20 7374 7269 6e67 730a 2020  rs to strings.  
-00020d00: 2020 2020 2020 776f 726b 6572 5f73 7461        worker_sta
-00020d10: 7465 7320 3d20 7b0a 2020 2020 2020 2020  tes = {.        
-00020d20: 2020 2020 6b3a 2072 6570 7228 7629 2069      k: repr(v) i
-00020d30: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-00020d40: 4578 6365 7074 696f 6e29 2065 6c73 6520  Exception) else 
-00020d50: 760a 2020 2020 2020 2020 2020 2020 666f  v.            fo
-00020d60: 7220 6b2c 2076 2069 6e20 776f 726b 6572  r k, v in worker
-00020d70: 5f73 7461 7465 732e 6974 656d 7328 290a  _states.items().
-00020d80: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00020d90: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-00020da0: 2020 2020 2020 2020 2273 6368 6564 756c          "schedul
-00020db0: 6572 223a 2073 6368 6564 756c 6572 5f73  er": scheduler_s
-00020dc0: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
-00020dd0: 2020 2277 6f72 6b65 7273 223a 2077 6f72    "workers": wor
-00020de0: 6b65 725f 7374 6174 6573 2c0a 2020 2020  ker_states,.    
-00020df0: 2020 2020 2020 2020 2276 6572 7369 6f6e          "version
-00020e00: 7322 3a20 7b22 7363 6865 6475 6c65 7222  s": {"scheduler"
-00020e10: 3a20 7365 6c66 2e76 6572 7369 6f6e 7328  : self.versions(
-00020e20: 292c 2022 776f 726b 6572 7322 3a20 776f  ), "workers": wo
-00020e30: 726b 6572 5f76 6572 7369 6f6e 737d 2c0a  rker_versions},.
-00020e40: 2020 2020 2020 2020 7d0a 0a20 2020 2061          }..    a
-00020e50: 7379 6e63 2064 6566 2064 756d 705f 636c  sync def dump_cl
-00020e60: 7573 7465 725f 7374 6174 655f 746f 5f75  uster_state_to_u
-00020e70: 726c 280a 2020 2020 2020 2020 7365 6c66  rl(.        self
-00020e80: 2c0a 2020 2020 2020 2020 7572 6c3a 2073  ,.        url: s
-00020e90: 7472 2c0a 2020 2020 2020 2020 6578 636c  tr,.        excl
-00020ea0: 7564 653a 2022 436f 6c6c 6563 7469 6f6e  ude: "Collection
-00020eb0: 5b73 7472 5d22 2c0a 2020 2020 2020 2020  [str]",.        
-00020ec0: 666f 726d 6174 3a20 4c69 7465 7261 6c5b  format: Literal[
-00020ed0: 226d 7367 7061 636b 222c 2022 7961 6d6c  "msgpack", "yaml
-00020ee0: 225d 2c0a 2020 2020 2020 2020 2a2a 7374  "],.        **st
-00020ef0: 6f72 6167 655f 6f70 7469 6f6e 733a 2064  orage_options: d
-00020f00: 6963 745b 7374 722c 2041 6e79 5d2c 0a20  ict[str, Any],. 
-00020f10: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-00020f20: 2020 2020 2020 2257 7269 7465 2061 2063        "Write a c
-00020f30: 6c75 7374 6572 2073 7461 7465 2064 756d  luster state dum
-00020f40: 7020 746f 2061 6e20 6673 7370 6563 2d63  p to an fsspec-c
-00020f50: 6f6d 7061 7469 626c 6520 5552 4c2e 220a  ompatible URL.".
-00020f60: 2020 2020 2020 2020 6177 6169 7420 636c          await cl
-00020f70: 7573 7465 725f 6475 6d70 2e77 7269 7465  uster_dump.write
-00020f80: 5f73 7461 7465 280a 2020 2020 2020 2020  _state(.        
-00020f90: 2020 2020 7061 7274 6961 6c28 7365 6c66      partial(self
-00020fa0: 2e67 6574 5f63 6c75 7374 6572 5f73 7461  .get_cluster_sta
-00020fb0: 7465 2c20 6578 636c 7564 6529 2c20 7572  te, exclude), ur
-00020fc0: 6c2c 2066 6f72 6d61 742c 202a 2a73 746f  l, format, **sto
-00020fd0: 7261 6765 5f6f 7074 696f 6e73 0a20 2020  rage_options.   
-00020fe0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00020ff0: 6765 745f 776f 726b 6572 5f73 6572 7669  get_worker_servi
-00021000: 6365 5f61 6464 7228 0a20 2020 2020 2020  ce_addr(.       
-00021010: 2073 656c 662c 2077 6f72 6b65 723a 2073   self, worker: s
-00021020: 7472 2c20 7365 7276 6963 655f 6e61 6d65  tr, service_name
-00021030: 3a20 7374 722c 2070 726f 746f 636f 6c3a  : str, protocol:
-00021040: 2062 6f6f 6c20 3d20 4661 6c73 650a 2020   bool = False.  
-00021050: 2020 2920 2d3e 2074 7570 6c65 5b73 7472    ) -> tuple[str
-00021060: 2c20 696e 745d 207c 2073 7472 207c 204e  , int] | str | N
-00021070: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00021080: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
-00021090: 2028 686f 7374 2c20 706f 7274 2920 6164   (host, port) ad
-000210a0: 6472 6573 7320 6f66 2074 6865 206e 616d  dress of the nam
-000210b0: 6564 2073 6572 7669 6365 206f 6e20 7468  ed service on th
-000210c0: 6520 2a77 6f72 6b65 722a 2e0a 2020 2020  e *worker*..    
-000210d0: 2020 2020 5265 7475 726e 7320 4e6f 6e65      Returns None
-000210e0: 2069 6620 7468 6520 7365 7276 6963 6520   if the service 
-000210f0: 646f 6573 6e27 7420 6578 6973 742e 0a0a  doesn't exist...
-00021100: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-00021110: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-00021120: 2d2d 2d2d 2d0a 2020 2020 2020 2020 776f  -----.        wo
-00021130: 726b 6572 203a 2061 6464 7265 7373 0a20  rker : address. 
-00021140: 2020 2020 2020 2073 6572 7669 6365 5f6e         service_n
-00021150: 616d 6520 3a20 7374 720a 2020 2020 2020  ame : str.      
-00021160: 2020 2020 2020 436f 6d6d 6f6e 2073 6572        Common ser
-00021170: 7669 6365 7320 696e 636c 7564 6520 2762  vices include 'b
-00021180: 6f6b 6568 2720 616e 6420 276e 616e 6e79  okeh' and 'nanny
-00021190: 270a 2020 2020 2020 2020 7072 6f74 6f63  '.        protoc
-000211a0: 6f6c 203a 2062 6f6f 6c65 616e 0a20 2020  ol : boolean.   
-000211b0: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
-000211c0: 206f 7220 6e6f 7420 746f 2069 6e63 6c75   or not to inclu
-000211d0: 6465 2061 2066 756c 6c20 6164 6472 6573  de a full addres
-000211e0: 7320 7769 7468 2070 726f 746f 636f 6c20  s with protocol 
-000211f0: 2854 7275 6529 0a20 2020 2020 2020 2020  (True).         
-00021200: 2020 206f 7220 6a75 7374 2061 2028 686f     or just a (ho
-00021210: 7374 2c20 706f 7274 2920 7061 6972 0a20  st, port) pair. 
-00021220: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00021230: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
-00021240: 6b65 7273 5b77 6f72 6b65 725d 0a20 2020  kers[worker].   
-00021250: 2020 2020 2070 6f72 7420 3d20 7773 2e73       port = ws.s
-00021260: 6572 7669 6365 732e 6765 7428 7365 7276  ervices.get(serv
-00021270: 6963 655f 6e61 6d65 290a 2020 2020 2020  ice_name).      
-00021280: 2020 6966 2070 6f72 7420 6973 204e 6f6e    if port is Non
-00021290: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-000212a0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
-000212b0: 2020 2065 6c69 6620 7072 6f74 6f63 6f6c     elif protocol
-000212c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000212d0: 7475 726e 2022 2528 7072 6f74 6f63 6f6c  turn "%(protocol
-000212e0: 2973 3a2f 2f25 2868 6f73 7429 733a 2528  )s://%(host)s:%(
-000212f0: 706f 7274 2964 2220 2520 7b0a 2020 2020  port)d" % {.    
-00021300: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
-00021310: 746f 636f 6c22 3a20 7773 2e61 6464 7265  tocol": ws.addre
-00021320: 7373 2e73 706c 6974 2822 3a2f 2f22 295b  ss.split("://")[
-00021330: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-00021340: 2020 2020 2268 6f73 7422 3a20 7773 2e68      "host": ws.h
-00021350: 6f73 742c 0a20 2020 2020 2020 2020 2020  ost,.           
-00021360: 2020 2020 2022 706f 7274 223a 2070 6f72       "port": por
-00021370: 742c 0a20 2020 2020 2020 2020 2020 207d  t,.            }
-00021380: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00021390: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000213a0: 6e20 7773 2e68 6f73 742c 2070 6f72 740a  n ws.host, port.
-000213b0: 0a20 2020 2061 7379 6e63 2064 6566 2073  .    async def s
-000213c0: 7461 7274 5f75 6e73 6166 6528 7365 6c66  tart_unsafe(self
-000213d0: 293a 0a20 2020 2020 2020 2022 2222 436c  ):.        """Cl
-000213e0: 6561 7220 6f75 7420 6f6c 6420 7374 6174  ear out old stat
-000213f0: 6520 616e 6420 7265 7374 6172 7420 616c  e and restart al
-00021400: 6c20 7275 6e6e 696e 6720 636f 726f 7574  l running corout
-00021410: 696e 6573 2222 220a 2020 2020 2020 2020  ines""".        
-00021420: 6177 6169 7420 7375 7065 7228 292e 7374  await super().st
-00021430: 6172 745f 756e 7361 6665 2829 0a0a 2020  art_unsafe()..  
-00021440: 2020 2020 2020 656e 6162 6c65 5f67 635f        enable_gc_
-00021450: 6469 6167 6e6f 7369 7328 290a 0a20 2020  diagnosis()..   
-00021460: 2020 2020 2073 656c 662e 5f63 6c65 6172       self._clear
-00021470: 5f74 6173 6b5f 7374 6174 6528 290a 0a20  _task_state().. 
-00021480: 2020 2020 2020 2066 6f72 2061 6464 7220         for addr 
-00021490: 696e 2073 656c 662e 5f73 7461 7274 5f61  in self._start_a
-000214a0: 6464 7265 7373 3a0a 2020 2020 2020 2020  ddress:.        
-000214b0: 2020 2020 6177 6169 7420 7365 6c66 2e6c      await self.l
-000214c0: 6973 7465 6e28 0a20 2020 2020 2020 2020  isten(.         
-000214d0: 2020 2020 2020 2061 6464 722c 0a20 2020         addr,.   
-000214e0: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
-000214f0: 6f77 5f6f 6666 6c6f 6164 3d46 616c 7365  ow_offload=False
-00021500: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021510: 2020 6861 6e64 7368 616b 655f 6f76 6572    handshake_over
-00021520: 7269 6465 733d 7b22 7069 636b 6c65 2d70  rides={"pickle-p
-00021530: 726f 746f 636f 6c22 3a20 342c 2022 636f  rotocol": 4, "co
-00021540: 6d70 7265 7373 696f 6e22 3a20 4e6f 6e65  mpression": None
-00021550: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00021560: 2020 202a 2a73 656c 662e 7365 6375 7269     **self.securi
-00021570: 7479 2e67 6574 5f6c 6973 7465 6e5f 6172  ty.get_listen_ar
-00021580: 6773 2822 7363 6865 6475 6c65 7222 292c  gs("scheduler"),
-00021590: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000215a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000215b0: 6970 203d 2067 6574 5f61 6464 7265 7373  ip = get_address
-000215c0: 5f68 6f73 7428 7365 6c66 2e6c 6973 7465  _host(self.liste
-000215d0: 6e5f 6164 6472 6573 7329 0a20 2020 2020  n_address).     
-000215e0: 2020 2020 2020 206c 6973 7465 6e5f 6970         listen_ip
-000215f0: 203d 2073 656c 662e 6970 0a0a 2020 2020   = self.ip..    
-00021600: 2020 2020 2020 2020 6966 206c 6973 7465          if liste
-00021610: 6e5f 6970 203d 3d20 2230 2e30 2e30 2e30  n_ip == "0.0.0.0
-00021620: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00021630: 2020 206c 6973 7465 6e5f 6970 203d 2022     listen_ip = "
-00021640: 220a 0a20 2020 2020 2020 2069 6620 7365  "..        if se
-00021650: 6c66 2e61 6464 7265 7373 2e73 7461 7274  lf.address.start
-00021660: 7377 6974 6828 2269 6e70 726f 633a 2f2f  swith("inproc://
-00021670: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00021680: 6c69 7374 656e 5f69 7020 3d20 226c 6f63  listen_ip = "loc
-00021690: 616c 686f 7374 220a 0a20 2020 2020 2020  alhost"..       
-000216a0: 2023 2053 6572 7669 6365 7320 6c69 7374   # Services list
-000216b0: 656e 206f 6e20 616c 6c20 6164 6472 6573  en on all addres
-000216c0: 7365 730a 2020 2020 2020 2020 7365 6c66  ses.        self
-000216d0: 2e73 7461 7274 5f73 6572 7669 6365 7328  .start_services(
-000216e0: 6c69 7374 656e 5f69 7029 0a0a 2020 2020  listen_ip)..    
-000216f0: 2020 2020 666f 7220 6c69 7374 656e 6572      for listener
-00021700: 2069 6e20 7365 6c66 2e6c 6973 7465 6e65   in self.listene
-00021710: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00021720: 6c6f 6767 6572 2e69 6e66 6f28 2220 2053  logger.info("  S
-00021730: 6368 6564 756c 6572 2061 743a 2025 3235  cheduler at: %25
-00021740: 7322 2c20 6c69 7374 656e 6572 2e63 6f6e  s", listener.con
-00021750: 7461 6374 5f61 6464 7265 7373 290a 2020  tact_address).  
-00021760: 2020 2020 2020 666f 7220 6e61 6d65 2c20        for name, 
-00021770: 7365 7276 6572 2069 6e20 7365 6c66 2e73  server in self.s
-00021780: 6572 7669 6365 732e 6974 656d 7328 293a  ervices.items():
-00021790: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000217a0: 6e61 6d65 203d 3d20 2264 6173 6862 6f61  name == "dashboa
-000217b0: 7264 223a 0a20 2020 2020 2020 2020 2020  rd":.           
-000217c0: 2020 2020 2061 6464 7220 3d20 6765 745f       addr = get_
-000217d0: 6164 6472 6573 735f 686f 7374 286c 6973  address_host(lis
-000217e0: 7465 6e65 722e 636f 6e74 6163 745f 6164  tener.contact_ad
-000217f0: 6472 6573 7329 0a20 2020 2020 2020 2020  dress).         
-00021800: 2020 2020 2020 206c 696e 6b20 3d20 666f         link = fo
-00021810: 726d 6174 5f64 6173 6862 6f61 7264 5f6c  rmat_dashboard_l
-00021820: 696e 6b28 6164 6472 2c20 7365 7276 6572  ink(addr, server
-00021830: 2e70 6f72 7429 0a20 2020 2020 2020 2020  .port).         
-00021840: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00021850: 2020 2020 2020 2020 206c 696e 6b20 3d20           link = 
-00021860: 6622 7b6c 6973 7465 6e5f 6970 7d3a 7b73  f"{listen_ip}:{s
-00021870: 6572 7665 722e 706f 7274 7d22 0a20 2020  erver.port}".   
-00021880: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00021890: 696e 666f 2822 2531 3173 2061 743a 2020  info("%11s at:  
-000218a0: 2532 3573 222c 206e 616d 652c 206c 696e  %25s", name, lin
-000218b0: 6b29 0a0a 2020 2020 2020 2020 6966 2073  k)..        if s
-000218c0: 656c 662e 7363 6865 6475 6c65 725f 6669  elf.scheduler_fi
-000218d0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-000218e0: 7769 7468 206f 7065 6e28 7365 6c66 2e73  with open(self.s
-000218f0: 6368 6564 756c 6572 5f66 696c 652c 2022  cheduler_file, "
-00021900: 7722 2920 6173 2066 3a0a 2020 2020 2020  w") as f:.      
-00021910: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
-00021920: 756d 7028 7365 6c66 2e69 6465 6e74 6974  ump(self.identit
-00021930: 7928 292c 2066 2c20 696e 6465 6e74 3d32  y(), f, indent=2
-00021940: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
-00021950: 6e20 3d20 7365 6c66 2e73 6368 6564 756c  n = self.schedul
-00021960: 6572 5f66 696c 6520 2023 2072 656d 6f76  er_file  # remov
-00021970: 6520 6669 6c65 2077 6865 6e20 7765 2063  e file when we c
-00021980: 6c6f 7365 2074 6865 2070 726f 6365 7373  lose the process
-00021990: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
-000219a0: 6620 6465 6c5f 7363 6865 6475 6c65 725f  f del_scheduler_
-000219b0: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
-000219c0: 2020 2020 2020 2020 6966 206f 732e 7061          if os.pa
-000219d0: 7468 2e65 7869 7374 7328 666e 293a 0a20  th.exists(fn):. 
-000219e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000219f0: 2020 206f 732e 7265 6d6f 7665 2866 6e29     os.remove(fn)
-00021a00: 0a0a 2020 2020 2020 2020 2020 2020 7765  ..            we
-00021a10: 616b 7265 662e 6669 6e61 6c69 7a65 2873  akref.finalize(s
-00021a20: 656c 662c 2064 656c 5f73 6368 6564 756c  elf, del_schedul
-00021a30: 6572 5f66 696c 6529 0a0a 2020 2020 2020  er_file)..      
-00021a40: 2020 666f 7220 7072 656c 6f61 6420 696e    for preload in
-00021a50: 2073 656c 662e 7072 656c 6f61 6473 3a0a   self.preloads:.
-00021a60: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00021a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021a80: 2061 7761 6974 2070 7265 6c6f 6164 2e73   await preload.s
-00021a90: 7461 7274 2829 0a20 2020 2020 2020 2020  tart().         
-00021aa0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00021ab0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-00021ac0: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00021ad0: 7074 696f 6e28 2246 6169 6c65 6420 746f  ption("Failed to
-00021ae0: 2073 7461 7274 2070 7265 6c6f 6164 2229   start preload")
-00021af0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00021b00: 662e 6a75 7079 7465 723a 0a20 2020 2020  f.jupyter:.     
-00021b10: 2020 2020 2020 2023 2041 6c6c 6f77 2069         # Allow i
-00021b20: 6e73 6563 7572 6520 636f 6d6d 756e 6963  nsecure communic
-00021b30: 6174 696f 6e73 2066 726f 6d20 6c6f 6361  ations from loca
-00021b40: 6c20 7573 6572 730a 2020 2020 2020 2020  l users.        
-00021b50: 2020 2020 6966 2073 656c 662e 6164 6472      if self.addr
-00021b60: 6573 732e 7374 6172 7473 7769 7468 2822  ess.startswith("
-00021b70: 746c 733a 2f2f 2229 3a0a 2020 2020 2020  tls://"):.      
-00021b80: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00021b90: 7365 6c66 2e6c 6973 7465 6e28 2274 6370  self.listen("tcp
-00021ba0: 3a2f 2f6c 6f63 616c 686f 7374 3a30 2229  ://localhost:0")
-00021bb0: 0a20 2020 2020 2020 2020 2020 206f 732e  .            os.
-00021bc0: 656e 7669 726f 6e5b 2244 4153 4b5f 5343  environ["DASK_SC
-00021bd0: 4845 4455 4c45 525f 4144 4452 4553 5322  HEDULER_ADDRESS"
-00021be0: 5d20 3d20 7365 6c66 2e6c 6973 7465 6e65  ] = self.listene
-00021bf0: 7273 5b2d 315d 2e63 6f6e 7461 6374 5f61  rs[-1].contact_a
-00021c00: 6464 7265 7373 0a0a 2020 2020 2020 2020  ddress..        
-00021c10: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-00021c20: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-00021c30: 2020 2a5b 706c 7567 696e 2e73 7461 7274    *[plugin.start
-00021c40: 2873 656c 6629 2066 6f72 2070 6c75 6769  (self) for plugi
-00021c50: 6e20 696e 206c 6973 7428 7365 6c66 2e70  n in list(self.p
-00021c60: 6c75 6769 6e73 2e76 616c 7565 7328 2929  lugins.values())
-00021c70: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
-00021c80: 2020 2020 2073 656c 662e 7374 6172 745f       self.start_
-00021c90: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
-00021ca0: 6b73 2829 0a0a 2020 2020 2020 2020 7365  ks()..        se
-00021cb0: 7470 726f 6374 6974 6c65 2866 2264 6173  tproctitle(f"das
-00021cc0: 6b20 7363 6865 6475 6c65 7220 5b7b 7365  k scheduler [{se
-00021cd0: 6c66 2e61 6464 7265 7373 7d5d 2229 0a20  lf.address}]"). 
-00021ce0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00021cf0: 6c66 0a0a 2020 2020 6173 796e 6320 6465  lf..    async de
-00021d00: 6620 636c 6f73 6528 7365 6c66 2c20 6661  f close(self, fa
-00021d10: 7374 3d4e 6f6e 652c 2063 6c6f 7365 5f77  st=None, close_w
-00021d20: 6f72 6b65 7273 3d4e 6f6e 6529 3a0a 2020  orkers=None):.  
-00021d30: 2020 2020 2020 2222 2253 656e 6420 636c        """Send cl
-00021d40: 6561 6e75 7020 7369 676e 616c 2074 6f20  eanup signal to 
-00021d50: 616c 6c20 636f 726f 7574 696e 6573 2074  all coroutines t
-00021d60: 6865 6e20 7761 6974 2075 6e74 696c 2066  hen wait until f
-00021d70: 696e 6973 6865 640a 0a20 2020 2020 2020  inished..       
-00021d80: 2053 6565 2041 6c73 6f0a 2020 2020 2020   See Also.      
-00021d90: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-00021da0: 2020 2053 6368 6564 756c 6572 2e63 6c65     Scheduler.cle
-00021db0: 616e 7570 0a20 2020 2020 2020 2022 2222  anup.        """
-00021dc0: 0a20 2020 2020 2020 2069 6620 6661 7374  .        if fast
-00021dd0: 2069 7320 6e6f 7420 4e6f 6e65 206f 7220   is not None or 
-00021de0: 636c 6f73 655f 776f 726b 6572 7320 6973  close_workers is
-00021df0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00021e00: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
-00021e10: 7761 726e 280a 2020 2020 2020 2020 2020  warn(.          
-00021e20: 2020 2020 2020 2254 6865 2027 6661 7374        "The 'fast
-00021e30: 2720 616e 6420 2763 6c6f 7365 5f77 6f72  ' and 'close_wor
-00021e40: 6b65 7273 2720 7061 7261 6d65 7465 7273  kers' parameters
-00021e50: 2069 6e20 5363 6865 6475 6c65 722e 636c   in Scheduler.cl
-00021e60: 6f73 6520 6861 7665 206e 6f20 6566 6665  ose have no effe
-00021e70: 6374 2061 6e64 2077 696c 6c20 6265 2072  ct and will be r
-00021e80: 656d 6f76 6564 2069 6e20 6120 6675 7475  emoved in a futu
-00021e90: 7265 2076 6572 7369 6f6e 206f 6620 6469  re version of di
-00021ea0: 7374 7269 6275 7465 642e 222c 0a20 2020  stributed.",.   
-00021eb0: 2020 2020 2020 2020 2020 2020 2046 7574               Fut
-00021ec0: 7572 6557 6172 6e69 6e67 2c0a 2020 2020  ureWarning,.    
-00021ed0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00021ee0: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
-00021ef0: 2069 6e20 2853 7461 7475 732e 636c 6f73   in (Status.clos
-00021f00: 696e 672c 2053 7461 7475 732e 636c 6f73  ing, Status.clos
-00021f10: 6564 293a 0a20 2020 2020 2020 2020 2020  ed):.           
-00021f20: 2061 7761 6974 2073 656c 662e 6669 6e69   await self.fini
-00021f30: 7368 6564 2829 0a20 2020 2020 2020 2020  shed().         
-00021f40: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00021f50: 2020 2061 7379 6e63 2064 6566 206c 6f67     async def log
-00021f60: 5f65 7272 6f72 7328 6675 6e63 293a 0a20  _errors(func):. 
-00021f70: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00021f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f90: 6177 6169 7420 6675 6e63 2829 0a20 2020  await func().   
-00021fa0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00021fb0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00021fc0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00021fd0: 722e 6578 6365 7074 696f 6e28 2250 6c75  r.exception("Plu
-00021fe0: 6769 6e20 6361 6c6c 2066 6169 6c65 6420  gin call failed 
-00021ff0: 6475 7269 6e67 2073 6368 6564 756c 6572  during scheduler
-00022000: 2e63 6c6f 7365 2229 0a0a 2020 2020 2020  .close")..      
-00022010: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-00022020: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-00022030: 2020 2020 2a5b 6c6f 675f 6572 726f 7273      *[log_errors
-00022040: 2870 6c75 6769 6e2e 6265 666f 7265 5f63  (plugin.before_c
-00022050: 6c6f 7365 2920 666f 7220 706c 7567 696e  lose) for plugin
-00022060: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-00022070: 7567 696e 732e 7661 6c75 6573 2829 295d  ugins.values())]
-00022080: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00022090: 2020 2020 7365 6c66 2e73 7461 7475 7320      self.status 
-000220a0: 3d20 5374 6174 7573 2e63 6c6f 7369 6e67  = Status.closing
-000220b0: 0a0a 2020 2020 2020 2020 6c6f 6767 6572  ..        logger
-000220c0: 2e69 6e66 6f28 2253 6368 6564 756c 6572  .info("Scheduler
-000220d0: 2063 6c6f 7369 6e67 2e2e 2e22 290a 2020   closing...").  
-000220e0: 2020 2020 2020 7365 7470 726f 6374 6974        setproctit
-000220f0: 6c65 2822 6461 736b 2073 6368 6564 756c  le("dask schedul
-00022100: 6572 205b 636c 6f73 696e 675d 2229 0a0a  er [closing]")..
-00022110: 2020 2020 2020 2020 666f 7220 7072 656c          for prel
-00022120: 6f61 6420 696e 2073 656c 662e 7072 656c  oad in self.prel
-00022130: 6f61 6473 3a0a 2020 2020 2020 2020 2020  oads:.          
-00022140: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00022150: 2020 2020 2020 2061 7761 6974 2070 7265         await pre
-00022160: 6c6f 6164 2e74 6561 7264 6f77 6e28 290a  load.teardown().
-00022170: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00022180: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
-00022190: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-000221a0: 6767 6572 2e65 7863 6570 7469 6f6e 2822  gger.exception("
-000221b0: 4661 696c 6564 2074 6f20 7465 6172 2064  Failed to tear d
-000221c0: 6f77 6e20 7072 656c 6f61 6422 290a 0a20  own preload").. 
-000221d0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-000221e0: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-000221f0: 2020 2020 2020 2020 202a 5b6c 6f67 5f65           *[log_e
-00022200: 7272 6f72 7328 706c 7567 696e 2e63 6c6f  rrors(plugin.clo
-00022210: 7365 2920 666f 7220 706c 7567 696e 2069  se) for plugin i
-00022220: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
-00022230: 696e 732e 7661 6c75 6573 2829 295d 0a20  ins.values())]. 
-00022240: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00022250: 2020 666f 7220 7063 2069 6e20 7365 6c66    for pc in self
-00022260: 2e70 6572 696f 6469 635f 6361 6c6c 6261  .periodic_callba
-00022270: 636b 732e 7661 6c75 6573 2829 3a0a 2020  cks.values():.  
-00022280: 2020 2020 2020 2020 2020 7063 2e73 746f            pc.sto
-00022290: 7028 290a 2020 2020 2020 2020 7365 6c66  p().        self
-000222a0: 2e70 6572 696f 6469 635f 6361 6c6c 6261  .periodic_callba
-000222b0: 636b 732e 636c 6561 7228 290a 0a20 2020  cks.clear()..   
-000222c0: 2020 2020 2073 656c 662e 7374 6f70 5f73       self.stop_s
-000222d0: 6572 7669 6365 7328 290a 0a20 2020 2020  ervices()..     
-000222e0: 2020 2066 6f72 2065 7874 2069 6e20 7365     for ext in se
-000222f0: 6c66 2e65 7874 656e 7369 6f6e 732e 7661  lf.extensions.va
-00022300: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-00022310: 2020 2020 7769 7468 2073 7570 7072 6573      with suppres
-00022320: 7328 4174 7472 6962 7574 6545 7272 6f72  s(AttributeError
-00022330: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00022340: 2020 2065 7874 2e74 6561 7264 6f77 6e28     ext.teardown(
-00022350: 290a 2020 2020 2020 2020 6c6f 6767 6572  ).        logger
-00022360: 2e69 6e66 6f28 2253 6368 6564 756c 6572  .info("Scheduler
-00022370: 2063 6c6f 7369 6e67 2061 6c6c 2063 6f6d   closing all com
-00022380: 6d73 2229 0a0a 2020 2020 2020 2020 6675  ms")..        fu
-00022390: 7475 7265 7320 3d20 5b5d 0a20 2020 2020  tures = [].     
-000223a0: 2020 2066 6f72 205f 2c20 636f 6d6d 2069     for _, comm i
-000223b0: 6e20 6c69 7374 2873 656c 662e 7374 7265  n list(self.stre
-000223c0: 616d 5f63 6f6d 6d73 2e69 7465 6d73 2829  am_comms.items()
-000223d0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-000223e0: 2046 4958 4d45 2075 7365 2060 7365 6c66   FIXME use `self
-000223f0: 2e72 656d 6f76 655f 776f 726b 6572 2829  .remove_worker()
-00022400: 6020 696e 7374 6561 6420 6166 7465 7220  ` instead after 
-00022410: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-00022420: 6f6d 2f64 6173 6b2f 6469 7374 7269 6275  om/dask/distribu
-00022430: 7465 642f 6973 7375 6573 2f36 3339 300a  ted/issues/6390.
-00022440: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00022450: 6f74 2063 6f6d 6d2e 636c 6f73 6564 2829  ot comm.closed()
-00022460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00022470: 2020 2320 5468 6973 2063 6c6f 7365 7320    # This closes 
-00022480: 7468 6520 576f 726b 6572 2061 6e64 2065  the Worker and e
-00022490: 6e73 7572 6573 2074 6861 7420 6966 2061  nsures that if a
-000224a0: 204e 616e 6e79 2069 7320 6172 6f75 6e64   Nanny is around
-000224b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000224c0: 2020 2320 6974 2069 7320 636c 6f73 6564    # it is closed
-000224d0: 2061 7320 7765 6c6c 0a20 2020 2020 2020   as well.       
-000224e0: 2020 2020 2020 2020 2063 6f6d 6d2e 7365           comm.se
-000224f0: 6e64 287b 226f 7022 3a20 2263 6c6f 7365  nd({"op": "close
-00022500: 222c 2022 7265 6173 6f6e 223a 2022 7363  ", "reason": "sc
-00022510: 6865 6475 6c65 722d 636c 6f73 6522 7d29  heduler-close"})
-00022520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022530: 2063 6f6d 6d2e 7365 6e64 287b 226f 7022   comm.send({"op"
-00022540: 3a20 2263 6c6f 7365 2d73 7472 6561 6d22  : "close-stream"
-00022550: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
-00022560: 2020 2023 205e 2054 4f44 4f20 7265 6d6f     # ^ TODO remo
-00022570: 7665 3f20 6057 6f72 6b65 722e 636c 6f73  ve? `Worker.clos
-00022580: 6560 2077 696c 6c20 636c 6f73 6520 7468  e` will close th
-00022590: 6520 7374 7265 616d 2061 6e79 7761 792e  e stream anyway.
-000225a0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-000225b0: 6820 7375 7070 7265 7373 2841 7474 7269  h suppress(Attri
-000225c0: 6275 7465 4572 726f 7229 3a0a 2020 2020  buteError):.    
-000225d0: 2020 2020 2020 2020 2020 2020 6675 7475              futu
-000225e0: 7265 732e 6170 7065 6e64 2863 6f6d 6d2e  res.append(comm.
-000225f0: 636c 6f73 6528 2929 0a0a 2020 2020 2020  close())..      
-00022600: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-00022610: 6761 7468 6572 282a 6675 7475 7265 7329  gather(*futures)
-00022620: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00022630: 662e 6a75 7079 7465 723a 0a20 2020 2020  f.jupyter:.     
-00022640: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-00022650: 662e 5f6a 7570 7974 6572 5f73 6572 7665  f._jupyter_serve
-00022660: 725f 6170 706c 6963 6174 696f 6e2e 5f63  r_application._c
-00022670: 6c65 616e 7570 2829 0a0a 2020 2020 2020  leanup()..      
-00022680: 2020 666f 7220 636f 6d6d 2069 6e20 7365    for comm in se
-00022690: 6c66 2e63 6c69 656e 745f 636f 6d6d 732e  lf.client_comms.
-000226a0: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
-000226b0: 2020 2020 2020 636f 6d6d 2e61 626f 7274        comm.abort
-000226c0: 2829 0a0a 2020 2020 2020 2020 6177 6169  ()..        awai
-000226d0: 7420 7365 6c66 2e72 7063 2e63 6c6f 7365  t self.rpc.close
-000226e0: 2829 0a0a 2020 2020 2020 2020 7365 6c66  ()..        self
-000226f0: 2e73 7461 7475 7320 3d20 5374 6174 7573  .status = Status
-00022700: 2e63 6c6f 7365 640a 2020 2020 2020 2020  .closed.        
-00022710: 7365 6c66 2e73 746f 7028 290a 2020 2020  self.stop().    
-00022720: 2020 2020 6177 6169 7420 7375 7065 7228      await super(
-00022730: 292e 636c 6f73 6528 290a 0a20 2020 2020  ).close()..     
-00022740: 2020 2073 6574 7072 6f63 7469 746c 6528     setproctitle(
-00022750: 2264 6173 6b20 7363 6865 6475 6c65 7220  "dask scheduler 
-00022760: 5b63 6c6f 7365 645d 2229 0a20 2020 2020  [closed]").     
-00022770: 2020 2064 6973 6162 6c65 5f67 635f 6469     disable_gc_di
-00022780: 6167 6e6f 7369 7328 290a 0a20 2020 2023  agnosis()..    #
-00022790: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-000227a0: 2053 7469 6d75 6c69 2023 0a20 2020 2023   Stimuli #.    #
-000227b0: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-000227c0: 6465 6620 6865 6172 7462 6561 745f 776f  def heartbeat_wo
-000227d0: 726b 6572 280a 2020 2020 2020 2020 7365  rker(.        se
-000227e0: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
-000227f0: 3d4e 6f6e 652c 0a20 2020 2020 2020 202a  =None,.        *
-00022800: 2c0a 2020 2020 2020 2020 6164 6472 6573  ,.        addres
-00022810: 732c 0a20 2020 2020 2020 2072 6573 6f6c  s,.        resol
-00022820: 7665 5f61 6464 7265 7373 3a20 626f 6f6c  ve_address: bool
-00022830: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-00022840: 206e 6f77 3a20 666c 6f61 7420 7c20 4e6f   now: float | No
-00022850: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00022860: 2020 2072 6573 6f75 7263 6573 3a20 6469     resources: di
-00022870: 6374 5b73 7472 2c20 666c 6f61 745d 207c  ct[str, float] |
-00022880: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00022890: 2020 2020 2020 686f 7374 5f69 6e66 6f3a        host_info:
-000228a0: 2064 6963 7420 7c20 4e6f 6e65 203d 204e   dict | None = N
-000228b0: 6f6e 652c 0a20 2020 2020 2020 206d 6574  one,.        met
-000228c0: 7269 6373 3a20 6469 6374 2c0a 2020 2020  rics: dict,.    
-000228d0: 2020 2020 6578 6563 7574 696e 673a 2064      executing: d
-000228e0: 6963 745b 7374 722c 2066 6c6f 6174 5d20  ict[str, float] 
-000228f0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00022900: 2020 2020 2020 2065 7874 656e 7369 6f6e         extension
-00022910: 733a 2064 6963 7420 7c20 4e6f 6e65 203d  s: dict | None =
-00022920: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-00022930: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
-00022940: 2020 2020 2020 2020 6164 6472 6573 7320          address 
-00022950: 3d20 7365 6c66 2e63 6f65 7263 655f 6164  = self.coerce_ad
-00022960: 6472 6573 7328 6164 6472 6573 732c 2072  dress(address, r
-00022970: 6573 6f6c 7665 5f61 6464 7265 7373 290a  esolve_address).
-00022980: 2020 2020 2020 2020 6164 6472 6573 7320          address 
-00022990: 3d20 6e6f 726d 616c 697a 655f 6164 6472  = normalize_addr
-000229a0: 6573 7328 6164 6472 6573 7329 0a20 2020  ess(address).   
-000229b0: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
-000229c0: 6f72 6b65 7273 2e67 6574 2861 6464 7265  orkers.get(addre
-000229d0: 7373 290a 2020 2020 2020 2020 6966 2077  ss).        if w
-000229e0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-000229f0: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00022a00: 726e 696e 6728 6622 5265 6365 6976 6564  rning(f"Received
-00022a10: 2068 6561 7274 6265 6174 2066 726f 6d20   heartbeat from 
-00022a20: 756e 7265 6769 7374 6572 6564 2077 6f72  unregistered wor
-00022a30: 6b65 7220 7b61 6464 7265 7373 2172 7d2e  ker {address!r}.
-00022a40: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00022a50: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
-00022a60: 2022 6d69 7373 696e 6722 7d0a 0a20 2020   "missing"}..   
-00022a70: 2020 2020 2068 6f73 7420 3d20 6765 745f       host = get_
-00022a80: 6164 6472 6573 735f 686f 7374 2861 6464  address_host(add
-00022a90: 7265 7373 290a 2020 2020 2020 2020 6c6f  ress).        lo
-00022aa0: 6361 6c5f 6e6f 7720 3d20 7469 6d65 2829  cal_now = time()
-00022ab0: 0a20 2020 2020 2020 2068 6f73 745f 696e  .        host_in
-00022ac0: 666f 203d 2068 6f73 745f 696e 666f 206f  fo = host_info o
-00022ad0: 7220 7b7d 0a0a 2020 2020 2020 2020 6468  r {}..        dh
-00022ae0: 3a20 6469 6374 203d 2073 656c 662e 686f  : dict = self.ho
-00022af0: 7374 5f69 6e66 6f2e 7365 7464 6566 6175  st_info.setdefau
-00022b00: 6c74 2868 6f73 742c 207b 7d29 0a20 2020  lt(host, {}).   
-00022b10: 2020 2020 2064 685b 226c 6173 742d 7365       dh["last-se
-00022b20: 656e 225d 203d 206c 6f63 616c 5f6e 6f77  en"] = local_now
-00022b30: 0a0a 2020 2020 2020 2020 6672 6163 203d  ..        frac =
-00022b40: 2031 202f 206c 656e 2873 656c 662e 776f   1 / len(self.wo
-00022b50: 726b 6572 7329 0a20 2020 2020 2020 2073  rkers).        s
-00022b60: 656c 662e 6261 6e64 7769 6474 6820 3d20  elf.bandwidth = 
-00022b70: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00022b80: 6c66 2e62 616e 6477 6964 7468 202a 2028  lf.bandwidth * (
-00022b90: 3120 2d20 6672 6163 2920 2b20 6d65 7472  1 - frac) + metr
-00022ba0: 6963 735b 2262 616e 6477 6964 7468 225d  ics["bandwidth"]
-00022bb0: 5b22 746f 7461 6c22 5d20 2a20 6672 6163  ["total"] * frac
-00022bc0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00022bd0: 2020 2066 6f72 206f 7468 6572 2c20 2862     for other, (b
-00022be0: 772c 2063 6f75 6e74 2920 696e 206d 6574  w, count) in met
-00022bf0: 7269 6373 5b22 6261 6e64 7769 6474 6822  rics["bandwidth"
-00022c00: 5d5b 2277 6f72 6b65 7273 225d 2e69 7465  ]["workers"].ite
-00022c10: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00022c20: 2020 6966 2028 6164 6472 6573 732c 206f    if (address, o
-00022c30: 7468 6572 2920 6e6f 7420 696e 2073 656c  ther) not in sel
-00022c40: 662e 6261 6e64 7769 6474 685f 776f 726b  f.bandwidth_work
-00022c50: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-00022c60: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
-00022c70: 6474 685f 776f 726b 6572 735b 6164 6472  dth_workers[addr
-00022c80: 6573 732c 206f 7468 6572 5d20 3d20 6277  ess, other] = bw
-00022c90: 202f 2063 6f75 6e74 0a20 2020 2020 2020   / count.       
-00022ca0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00022cb0: 2020 2020 2020 2020 2020 2061 6c70 6861             alpha
-00022cc0: 203d 2028 3120 2d20 6672 6163 2920 2a2a   = (1 - frac) **
-00022cd0: 2063 6f75 6e74 0a20 2020 2020 2020 2020   count.         
-00022ce0: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
-00022cf0: 7769 6474 685f 776f 726b 6572 735b 6164  width_workers[ad
-00022d00: 6472 6573 732c 206f 7468 6572 5d20 3d20  dress, other] = 
-00022d10: 7365 6c66 2e62 616e 6477 6964 7468 5f77  self.bandwidth_w
-00022d20: 6f72 6b65 7273 5b0a 2020 2020 2020 2020  orkers[.        
-00022d30: 2020 2020 2020 2020 2020 2020 6164 6472              addr
-00022d40: 6573 732c 206f 7468 6572 0a20 2020 2020  ess, other.     
-00022d50: 2020 2020 2020 2020 2020 205d 202a 2061             ] * a
-00022d60: 6c70 6861 202b 2062 7720 2a20 2831 202d  lpha + bw * (1 -
-00022d70: 2061 6c70 6861 290a 2020 2020 2020 2020   alpha).        
-00022d80: 666f 7220 7479 702c 2028 6277 2c20 636f  for typ, (bw, co
-00022d90: 756e 7429 2069 6e20 6d65 7472 6963 735b  unt) in metrics[
-00022da0: 2262 616e 6477 6964 7468 225d 5b22 7479  "bandwidth"]["ty
-00022db0: 7065 7322 5d2e 6974 656d 7328 293a 0a20  pes"].items():. 
-00022dc0: 2020 2020 2020 2020 2020 2069 6620 7479             if ty
-00022dd0: 7020 6e6f 7420 696e 2073 656c 662e 6261  p not in self.ba
-00022de0: 6e64 7769 6474 685f 7479 7065 733a 0a20  ndwidth_types:. 
-00022df0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00022e00: 656c 662e 6261 6e64 7769 6474 685f 7479  elf.bandwidth_ty
-00022e10: 7065 735b 7479 705d 203d 2062 7720 2f20  pes[typ] = bw / 
-00022e20: 636f 756e 740a 2020 2020 2020 2020 2020  count.          
-00022e30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00022e40: 2020 2020 2020 2020 616c 7068 6120 3d20          alpha = 
-00022e50: 2831 202d 2066 7261 6329 202a 2a20 636f  (1 - frac) ** co
-00022e60: 756e 740a 2020 2020 2020 2020 2020 2020  unt.            
-00022e70: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-00022e80: 7468 5f74 7970 6573 5b74 7970 5d20 3d20  th_types[typ] = 
-00022e90: 7365 6c66 2e62 616e 6477 6964 7468 5f74  self.bandwidth_t
-00022ea0: 7970 6573 5b74 7970 5d20 2a20 616c 7068  ypes[typ] * alph
-00022eb0: 6120 2b20 6277 202a 2028 0a20 2020 2020  a + bw * (.     
-00022ec0: 2020 2020 2020 2020 2020 2020 2020 2031                 1
-00022ed0: 202d 2061 6c70 6861 0a20 2020 2020 2020   - alpha.       
-00022ee0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00022ef0: 2020 2020 7773 2e6c 6173 745f 7365 656e      ws.last_seen
-00022f00: 203d 206c 6f63 616c 5f6e 6f77 0a20 2020   = local_now.   
-00022f10: 2020 2020 2069 6620 6578 6563 7574 696e       if executin
-00022f20: 6720 6973 206e 6f74 204e 6f6e 653a 0a20  g is not None:. 
-00022f30: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
-00022f40: 453a 2074 6865 2065 7865 6375 7469 6e67  E: the executing
-00022f50: 2064 6963 7420 6973 2075 6e75 7365 640a   dict is unused.
-00022f60: 2020 2020 2020 2020 2020 2020 7773 2e65              ws.e
-00022f70: 7865 6375 7469 6e67 203d 207b 7d0a 2020  xecuting = {}.  
-00022f80: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-00022f90: 792c 2064 7572 6174 696f 6e20 696e 2065  y, duration in e
-00022fa0: 7865 6375 7469 6e67 2e69 7465 6d73 2829  xecuting.items()
-00022fb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00022fc0: 2020 6966 206b 6579 2069 6e20 7365 6c66    if key in self
-00022fd0: 2e74 6173 6b73 3a0a 2020 2020 2020 2020  .tasks:.        
-00022fe0: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-00022ff0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00023000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023010: 2020 2020 2077 732e 6578 6563 7574 696e       ws.executin
-00023020: 675b 7473 5d20 3d20 6475 7261 7469 6f6e  g[ts] = duration
-00023030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023040: 2020 2020 2074 732e 7072 6566 6978 2e61       ts.prefix.a
-00023050: 6464 5f65 7865 635f 7469 6d65 2864 7572  dd_exec_time(dur
-00023060: 6174 696f 6e29 0a0a 2020 2020 2020 2020  ation)..        
-00023070: 7773 2e6d 6574 7269 6373 203d 206d 6574  ws.metrics = met
-00023080: 7269 6373 0a0a 2020 2020 2020 2020 2320  rics..        # 
-00023090: 4361 6c63 756c 6174 6520 5253 5320 2d20  Calculate RSS - 
-000230a0: 6461 736b 206b 6579 732c 2073 6570 6172  dask keys, separ
-000230b0: 6174 696e 6720 226f 6c64 2220 616e 6420  ating "old" and 
-000230c0: 226e 6577 2220 7573 6167 650a 2020 2020  "new" usage.    
-000230d0: 2020 2020 2320 5365 6520 4d65 6d6f 7279      # See Memory
-000230e0: 5374 6174 6520 666f 7220 6465 7461 696c  State for detail
-000230f0: 730a 2020 2020 2020 2020 6d61 785f 6d65  s.        max_me
-00023100: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
-00023110: 6c64 5f68 6973 745f 6167 6520 3d20 6c6f  ld_hist_age = lo
-00023120: 6361 6c5f 6e6f 7720 2d20 7365 6c66 2e4d  cal_now - self.M
-00023130: 454d 4f52 595f 5245 4345 4e54 5f54 4f5f  EMORY_RECENT_TO_
-00023140: 4f4c 445f 5449 4d45 0a20 2020 2020 2020  OLD_TIME.       
-00023150: 206d 656d 6f72 795f 756e 6d61 6e61 6765   memory_unmanage
-00023160: 645f 6f6c 6420 3d20 7773 2e5f 6d65 6d6f  d_old = ws._memo
-00023170: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
-00023180: 0a20 2020 2020 2020 2077 6869 6c65 2077  .        while w
-00023190: 732e 5f6d 656d 6f72 795f 756e 6d61 6e61  s._memory_unmana
-000231a0: 6765 645f 6869 7374 6f72 793a 0a20 2020  ged_history:.   
-000231b0: 2020 2020 2020 2020 2074 696d 6573 7461           timesta
-000231c0: 6d70 2c20 7369 7a65 203d 2077 732e 5f6d  mp, size = ws._m
-000231d0: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-000231e0: 6869 7374 6f72 795b 305d 0a20 2020 2020  history[0].     
-000231f0: 2020 2020 2020 2069 6620 7469 6d65 7374         if timest
-00023200: 616d 7020 3e3d 206d 6178 5f6d 656d 6f72  amp >= max_memor
-00023210: 795f 756e 6d61 6e61 6765 645f 6f6c 645f  y_unmanaged_old_
-00023220: 6869 7374 5f61 6765 3a0a 2020 2020 2020  hist_age:.      
-00023230: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00023240: 2020 2020 2020 2020 2020 2020 7773 2e5f              ws._
-00023250: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-00023260: 5f68 6973 746f 7279 2e70 6f70 6c65 6674  _history.popleft
-00023270: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-00023280: 6620 7369 7a65 203d 3d20 6d65 6d6f 7279  f size == memory
-00023290: 5f75 6e6d 616e 6167 6564 5f6f 6c64 3a0a  _unmanaged_old:.
-000232a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232b0: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-000232c0: 5f6f 6c64 203d 2030 2020 2320 7265 6361  _old = 0  # reca
-000232d0: 6c63 756c 6174 6520 6d69 6e28 290a 0a20  lculate min().. 
-000232e0: 2020 2020 2020 2023 2077 732e 5f6e 6279         # ws._nby
-000232f0: 7465 7320 6973 2075 7064 6174 6564 2061  tes is updated a
-00023300: 7420 6120 6469 6666 6572 656e 7420 7469  t a different ti
-00023310: 6d65 2061 6e64 2073 697a 656f 6628 2920  me and sizeof() 
-00023320: 6d61 7920 6e6f 7420 6265 2061 6363 7572  may not be accur
-00023330: 6174 652c 0a20 2020 2020 2020 2023 2073  ate,.        # s
-00023340: 6f20 7369 7a65 206d 6179 2062 6520 2874  o size may be (t
-00023350: 656d 706f 7261 7269 6c79 2920 6e65 6761  emporarily) nega
-00023360: 7469 7665 3b20 666c 6f6f 7220 6974 2074  tive; floor it t
-00023370: 6f20 7a65 726f 2e0a 2020 2020 2020 2020  o zero..        
-00023380: 7369 7a65 203d 206d 6178 280a 2020 2020  size = max(.    
-00023390: 2020 2020 2020 2020 302c 206d 6574 7269          0, metri
-000233a0: 6373 5b22 6d65 6d6f 7279 225d 202d 2077  cs["memory"] - w
-000233b0: 732e 6e62 7974 6573 202b 206d 6574 7269  s.nbytes + metri
-000233c0: 6373 5b22 7370 696c 6c65 645f 6279 7465  cs["spilled_byte
-000233d0: 7322 5d5b 226d 656d 6f72 7922 5d0a 2020  s"]["memory"].  
-000233e0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000233f0: 2077 732e 5f6d 656d 6f72 795f 756e 6d61   ws._memory_unma
-00023400: 6e61 6765 645f 6869 7374 6f72 792e 6170  naged_history.ap
-00023410: 7065 6e64 2828 6c6f 6361 6c5f 6e6f 772c  pend((local_now,
-00023420: 2073 697a 6529 290a 2020 2020 2020 2020   size)).        
-00023430: 6966 206e 6f74 206d 656d 6f72 795f 756e  if not memory_un
-00023440: 6d61 6e61 6765 645f 6f6c 643a 0a20 2020  managed_old:.   
-00023450: 2020 2020 2020 2020 2023 2054 6865 2077           # The w
-00023460: 6f72 6b65 7220 6861 7320 6a75 7374 2062  orker has just b
-00023470: 6565 6e20 7374 6172 7465 6420 6f72 2074  een started or t
-00023480: 6865 2070 7265 7669 6f75 7320 6d69 6e69  he previous mini
-00023490: 6d75 6d20 6861 7320 6265 656e 2065 7870  mum has been exp
-000234a0: 756e 6765 640a 2020 2020 2020 2020 2020  unged.          
-000234b0: 2020 2320 6265 6361 7573 6520 746f 6f20    # because too 
-000234c0: 6f6c 642e 0a20 2020 2020 2020 2020 2020  old..           
-000234d0: 2023 204e 6f74 653a 2074 6869 7320 616c   # Note: this al
-000234e0: 676f 7269 7468 6d20 6973 2063 6170 7065  gorithm is cappe
-000234f0: 6420 746f 2032 3030 202a 204d 454d 4f52  d to 200 * MEMOR
-00023500: 595f 5245 4345 4e54 5f54 4f5f 4f4c 445f  Y_RECENT_TO_OLD_
-00023510: 5449 4d45 2065 6c65 6d65 6e74 730a 2020  TIME elements.  
-00023520: 2020 2020 2020 2020 2020 2320 636c 7573            # clus
-00023530: 7465 722d 7769 6465 2062 7920 6865 6172  ter-wide by hear
-00023540: 7462 6561 745f 696e 7465 7276 616c 2829  tbeat_interval()
-00023550: 2c20 7265 6761 7264 6c65 7373 206f 6620  , regardless of 
-00023560: 7468 6520 6e75 6d62 6572 206f 6620 776f  the number of wo
-00023570: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
-00023580: 2020 7773 2e5f 6d65 6d6f 7279 5f75 6e6d    ws._memory_unm
-00023590: 616e 6167 6564 5f6f 6c64 203d 206d 696e  anaged_old = min
-000235a0: 286d 6170 2873 6563 6f6e 642c 2077 732e  (map(second, ws.
-000235b0: 5f6d 656d 6f72 795f 756e 6d61 6e61 6765  _memory_unmanage
-000235c0: 645f 6869 7374 6f72 7929 290a 2020 2020  d_history)).    
-000235d0: 2020 2020 656c 6966 2073 697a 6520 3c20      elif size < 
-000235e0: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-000235f0: 5f6f 6c64 3a0a 2020 2020 2020 2020 2020  _old:.          
-00023600: 2020 7773 2e5f 6d65 6d6f 7279 5f75 6e6d    ws._memory_unm
-00023610: 616e 6167 6564 5f6f 6c64 203d 2073 697a  anaged_old = siz
-00023620: 650a 0a20 2020 2020 2020 2069 6620 686f  e..        if ho
-00023630: 7374 5f69 6e66 6f3a 0a20 2020 2020 2020  st_info:.       
-00023640: 2020 2020 2064 6820 3d20 7365 6c66 2e68       dh = self.h
-00023650: 6f73 745f 696e 666f 2e73 6574 6465 6661  ost_info.setdefa
-00023660: 756c 7428 686f 7374 2c20 7b7d 290a 2020  ult(host, {}).  
-00023670: 2020 2020 2020 2020 2020 6468 2e75 7064            dh.upd
-00023680: 6174 6528 686f 7374 5f69 6e66 6f29 0a0a  ate(host_info)..
-00023690: 2020 2020 2020 2020 6966 206e 6f77 3a0a          if now:.
-000236a0: 2020 2020 2020 2020 2020 2020 7773 2e74              ws.t
-000236b0: 696d 655f 6465 6c61 7920 3d20 6c6f 6361  ime_delay = loca
-000236c0: 6c5f 6e6f 7720 2d20 6e6f 770a 0a20 2020  l_now - now..   
-000236d0: 2020 2020 2069 6620 7265 736f 7572 6365       if resource
-000236e0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-000236f0: 656c 662e 6164 645f 7265 736f 7572 6365  elf.add_resource
-00023700: 7328 776f 726b 6572 3d61 6464 7265 7373  s(worker=address
-00023710: 2c20 7265 736f 7572 6365 733d 7265 736f  , resources=reso
-00023720: 7572 6365 7329 0a0a 2020 2020 2020 2020  urces)..        
-00023730: 6966 2065 7874 656e 7369 6f6e 733a 0a20  if extensions:. 
-00023740: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
-00023750: 616d 652c 2064 6174 6120 696e 2065 7874  ame, data in ext
-00023760: 656e 7369 6f6e 732e 6974 656d 7328 293a  ensions.items():
-00023770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023780: 2073 656c 662e 6578 7465 6e73 696f 6e73   self.extensions
-00023790: 5b6e 616d 655d 2e68 6561 7274 6265 6174  [name].heartbeat
-000237a0: 2877 732c 2064 6174 6129 0a0a 2020 2020  (ws, data)..    
-000237b0: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
-000237c0: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-000237d0: 223a 2022 4f4b 222c 0a20 2020 2020 2020  ": "OK",.       
-000237e0: 2020 2020 2022 7469 6d65 223a 206c 6f63       "time": loc
-000237f0: 616c 5f6e 6f77 2c0a 2020 2020 2020 2020  al_now,.        
-00023800: 2020 2020 2268 6561 7274 6265 6174 2d69      "heartbeat-i
-00023810: 6e74 6572 7661 6c22 3a20 6865 6172 7462  nterval": heartb
-00023820: 6561 745f 696e 7465 7276 616c 286c 656e  eat_interval(len
-00023830: 2873 656c 662e 776f 726b 6572 7329 292c  (self.workers)),
-00023840: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00023850: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-00023860: 6173 796e 6320 6465 6620 6164 645f 776f  async def add_wo
-00023870: 726b 6572 280a 2020 2020 2020 2020 7365  rker(.        se
-00023880: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
-00023890: 3a20 436f 6d6d 2c0a 2020 2020 2020 2020  : Comm,.        
-000238a0: 2a2c 0a20 2020 2020 2020 2061 6464 7265  *,.        addre
-000238b0: 7373 3a20 7374 722c 0a20 2020 2020 2020  ss: str,.       
-000238c0: 2073 7461 7475 733a 2073 7472 2c0a 2020   status: str,.  
-000238d0: 2020 2020 2020 7365 7276 6572 5f69 643a        server_id:
-000238e0: 2073 7472 2c0a 2020 2020 2020 2020 6b65   str,.        ke
-000238f0: 7973 3d28 292c 0a20 2020 2020 2020 206e  ys=(),.        n
-00023900: 7468 7265 6164 733d 4e6f 6e65 2c0a 2020  threads=None,.  
-00023910: 2020 2020 2020 6e61 6d65 3d4e 6f6e 652c        name=None,
-00023920: 0a20 2020 2020 2020 2072 6573 6f6c 7665  .        resolve
-00023930: 5f61 6464 7265 7373 3d54 7275 652c 0a20  _address=True,. 
-00023940: 2020 2020 2020 206e 6279 7465 733d 4e6f         nbytes=No
-00023950: 6e65 2c0a 2020 2020 2020 2020 7479 7065  ne,.        type
-00023960: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
-00023970: 6e6f 773d 4e6f 6e65 2c0a 2020 2020 2020  now=None,.      
-00023980: 2020 7265 736f 7572 6365 733d 4e6f 6e65    resources=None
-00023990: 2c0a 2020 2020 2020 2020 686f 7374 5f69  ,.        host_i
-000239a0: 6e66 6f3d 4e6f 6e65 2c0a 2020 2020 2020  nfo=None,.      
-000239b0: 2020 6d65 6d6f 7279 5f6c 696d 6974 3d4e    memory_limit=N
-000239c0: 6f6e 652c 0a20 2020 2020 2020 206d 6574  one,.        met
-000239d0: 7269 6373 3d4e 6f6e 652c 0a20 2020 2020  rics=None,.     
-000239e0: 2020 2070 6964 3d30 2c0a 2020 2020 2020     pid=0,.      
-000239f0: 2020 7365 7276 6963 6573 3d4e 6f6e 652c    services=None,
-00023a00: 0a20 2020 2020 2020 206c 6f63 616c 5f64  .        local_d
-00023a10: 6972 6563 746f 7279 3d4e 6f6e 652c 0a20  irectory=None,. 
-00023a20: 2020 2020 2020 2076 6572 7369 6f6e 733a         versions:
-00023a30: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
-00023a40: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00023a50: 2020 2020 2020 206e 616e 6e79 3d4e 6f6e         nanny=Non
-00023a60: 652c 0a20 2020 2020 2020 2065 7874 7261  e,.        extra
-00023a70: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-00023a80: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
-00023a90: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00023aa0: 2020 2020 2020 2020 2222 2241 6464 2061          """Add a
-00023ab0: 206e 6577 2077 6f72 6b65 7220 746f 2074   new worker to t
-00023ac0: 6865 2063 6c75 7374 6572 2222 220a 2020  he cluster""".  
-00023ad0: 2020 2020 2020 6164 6472 6573 7320 3d20        address = 
-00023ae0: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
-00023af0: 6573 7328 6164 6472 6573 732c 2072 6573  ess(address, res
-00023b00: 6f6c 7665 5f61 6464 7265 7373 290a 2020  olve_address).  
-00023b10: 2020 2020 2020 6164 6472 6573 7320 3d20        address = 
-00023b20: 6e6f 726d 616c 697a 655f 6164 6472 6573  normalize_addres
-00023b30: 7328 6164 6472 6573 7329 0a20 2020 2020  s(address).     
-00023b40: 2020 2068 6f73 7420 3d20 6765 745f 6164     host = get_ad
-00023b50: 6472 6573 735f 686f 7374 2861 6464 7265  dress_host(addre
-00023b60: 7373 290a 0a20 2020 2020 2020 2069 6620  ss)..        if 
-00023b70: 6164 6472 6573 7320 696e 2073 656c 662e  address in self.
-00023b80: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-00023b90: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00023ba0: 4572 726f 7228 2257 6f72 6b65 7220 616c  Error("Worker al
-00023bb0: 7265 6164 7920 6578 6973 7473 2025 7322  ready exists %s"
-00023bc0: 2025 2061 6464 7265 7373 290a 0a20 2020   % address)..   
-00023bd0: 2020 2020 2069 6620 6e62 7974 6573 3a0a       if nbytes:.
-00023be0: 2020 2020 2020 2020 2020 2020 6572 7220              err 
-00023bf0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00023c00: 2020 2020 6622 576f 726b 6572 207b 6164      f"Worker {ad
-00023c10: 6472 6573 7321 727d 2063 6f6e 6e65 6374  dress!r} connect
-00023c20: 6564 2077 6974 6820 7b6c 656e 286e 6279  ed with {len(nby
-00023c30: 7465 7329 7d20 6b65 7928 7329 2069 6e20  tes)} key(s) in 
-00023c40: 6d65 6d6f 7279 2120 576f 726b 6572 2072  memory! Worker r
-00023c50: 6563 6f6e 6e65 6374 696f 6e20 6973 206e  econnection is n
-00023c60: 6f74 2073 7570 706f 7274 6564 2e20 220a  ot supported. ".
-00023c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c80: 6622 4b65 7973 3a20 7b6c 6973 7428 6e62  f"Keys: {list(nb
-00023c90: 7974 6573 297d 220a 2020 2020 2020 2020  ytes)}".        
-00023ca0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00023cb0: 2020 6c6f 6767 6572 2e65 7272 6f72 2865    logger.error(e
-00023cc0: 7272 290a 2020 2020 2020 2020 2020 2020  rr).            
-00023cd0: 6177 6169 7420 636f 6d6d 2e77 7269 7465  await comm.write
-00023ce0: 287b 2273 7461 7475 7322 3a20 2265 7272  ({"status": "err
-00023cf0: 6f72 222c 2022 6d65 7373 6167 6522 3a20  or", "message": 
-00023d00: 6572 722c 2022 7469 6d65 223a 2074 696d  err, "time": tim
-00023d10: 6528 297d 290a 2020 2020 2020 2020 2020  e()}).          
-00023d20: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00023d30: 2020 6966 206e 616d 6520 696e 2073 656c    if name in sel
-00023d40: 662e 616c 6961 7365 733a 0a20 2020 2020  f.aliases:.     
-00023d50: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00023d60: 726e 696e 6728 2257 6f72 6b65 7220 7472  rning("Worker tr
-00023d70: 6965 6420 746f 2063 6f6e 6e65 6374 2077  ied to connect w
-00023d80: 6974 6820 6120 6475 706c 6963 6174 6520  ith a duplicate 
-00023d90: 6e61 6d65 3a20 2573 222c 206e 616d 6529  name: %s", name)
-00023da0: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
-00023db0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00023dc0: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
-00023dd0: 6572 726f 7222 2c0a 2020 2020 2020 2020  error",.        
-00023de0: 2020 2020 2020 2020 226d 6573 7361 6765          "message
-00023df0: 223a 2022 6e61 6d65 2074 616b 656e 2c20  ": "name taken, 
-00023e00: 2573 2220 2520 6e61 6d65 2c0a 2020 2020  %s" % name,.    
-00023e10: 2020 2020 2020 2020 2020 2020 2274 696d              "tim
-00023e20: 6522 3a20 7469 6d65 2829 2c0a 2020 2020  e": time(),.    
-00023e30: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00023e40: 2020 2020 2020 6177 6169 7420 636f 6d6d        await comm
-00023e50: 2e77 7269 7465 286d 7367 290a 2020 2020  .write(msg).    
-00023e60: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-00023e70: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00023e80: 5f65 7665 6e74 2861 6464 7265 7373 2c20  _event(address, 
-00023e90: 7b22 6163 7469 6f6e 223a 2022 6164 642d  {"action": "add-
-00023ea0: 776f 726b 6572 227d 290a 2020 2020 2020  worker"}).      
-00023eb0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00023ec0: 2822 616c 6c22 2c20 7b22 6163 7469 6f6e  ("all", {"action
-00023ed0: 223a 2022 6164 642d 776f 726b 6572 222c  ": "add-worker",
-00023ee0: 2022 776f 726b 6572 223a 2061 6464 7265   "worker": addre
-00023ef0: 7373 7d29 0a0a 2020 2020 2020 2020 7365  ss})..        se
-00023f00: 6c66 2e77 6f72 6b65 7273 5b61 6464 7265  lf.workers[addre
-00023f10: 7373 5d20 3d20 7773 203d 2057 6f72 6b65  ss] = ws = Worke
-00023f20: 7253 7461 7465 280a 2020 2020 2020 2020  rState(.        
-00023f30: 2020 2020 6164 6472 6573 733d 6164 6472      address=addr
-00023f40: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
-00023f50: 2073 7461 7475 733d 5374 6174 7573 2e6c   status=Status.l
-00023f60: 6f6f 6b75 705b 7374 6174 7573 5d2c 2020  ookup[status],  
-00023f70: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-00023f80: 2020 2020 2020 2020 2020 2070 6964 3d70             pid=p
-00023f90: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00023fa0: 6e74 6872 6561 6473 3d6e 7468 7265 6164  nthreads=nthread
-00023fb0: 732c 0a20 2020 2020 2020 2020 2020 206d  s,.            m
-00023fc0: 656d 6f72 795f 6c69 6d69 743d 6d65 6d6f  emory_limit=memo
-00023fd0: 7279 5f6c 696d 6974 206f 7220 302c 0a20  ry_limit or 0,. 
-00023fe0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-00023ff0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00024000: 2020 6c6f 6361 6c5f 6469 7265 6374 6f72    local_director
-00024010: 793d 6c6f 6361 6c5f 6469 7265 6374 6f72  y=local_director
-00024020: 792c 0a20 2020 2020 2020 2020 2020 2073  y,.            s
-00024030: 6572 7669 6365 733d 7365 7276 6963 6573  ervices=services
-00024040: 2c0a 2020 2020 2020 2020 2020 2020 7665  ,.            ve
-00024050: 7273 696f 6e73 3d76 6572 7369 6f6e 732c  rsions=versions,
-00024060: 0a20 2020 2020 2020 2020 2020 206e 616e  .            nan
-00024070: 6e79 3d6e 616e 6e79 2c0a 2020 2020 2020  ny=nanny,.      
-00024080: 2020 2020 2020 6578 7472 613d 6578 7472        extra=extr
-00024090: 612c 0a20 2020 2020 2020 2020 2020 2073  a,.            s
-000240a0: 6572 7665 725f 6964 3d73 6572 7665 725f  erver_id=server_
-000240b0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-000240c0: 7363 6865 6475 6c65 723d 7365 6c66 2c0a  scheduler=self,.
-000240d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000240e0: 2020 6966 2077 732e 7374 6174 7573 203d    if ws.status =
-000240f0: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-00024100: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00024110: 6c66 2e72 756e 6e69 6e67 2e61 6464 2877  lf.running.add(w
-00024120: 7329 0a0a 2020 2020 2020 2020 6468 203d  s)..        dh =
-00024130: 2073 656c 662e 686f 7374 5f69 6e66 6f2e   self.host_info.
-00024140: 6765 7428 686f 7374 290a 2020 2020 2020  get(host).      
-00024150: 2020 6966 2064 6820 6973 204e 6f6e 653a    if dh is None:
-00024160: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00024170: 662e 686f 7374 5f69 6e66 6f5b 686f 7374  f.host_info[host
-00024180: 5d20 3d20 6468 203d 207b 7d0a 0a20 2020  ] = dh = {}..   
-00024190: 2020 2020 2064 685f 6164 6472 6573 7365       dh_addresse
-000241a0: 7320 3d20 6468 2e67 6574 2822 6164 6472  s = dh.get("addr
-000241b0: 6573 7365 7322 290a 2020 2020 2020 2020  esses").        
-000241c0: 6966 2064 685f 6164 6472 6573 7365 7320  if dh_addresses 
-000241d0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000241e0: 2020 2020 2064 685b 2261 6464 7265 7373       dh["address
-000241f0: 6573 225d 203d 2064 685f 6164 6472 6573  es"] = dh_addres
-00024200: 7365 7320 3d20 7365 7428 290a 2020 2020  ses = set().    
-00024210: 2020 2020 2020 2020 6468 5b22 6e74 6872          dh["nthr
-00024220: 6561 6473 225d 203d 2030 0a0a 2020 2020  eads"] = 0..    
-00024230: 2020 2020 6468 5f61 6464 7265 7373 6573      dh_addresses
-00024240: 2e61 6464 2861 6464 7265 7373 290a 2020  .add(address).  
-00024250: 2020 2020 2020 6468 5b22 6e74 6872 6561        dh["nthrea
-00024260: 6473 225d 202b 3d20 6e74 6872 6561 6473  ds"] += nthreads
-00024270: 0a0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
-00024280: 6f74 616c 5f6e 7468 7265 6164 7320 2b3d  otal_nthreads +=
-00024290: 206e 7468 7265 6164 730a 2020 2020 2020   nthreads.      
-000242a0: 2020 7365 6c66 2e61 6c69 6173 6573 5b6e    self.aliases[n
-000242b0: 616d 655d 203d 2061 6464 7265 7373 0a0a  ame] = address..
-000242c0: 2020 2020 2020 2020 7365 6c66 2e68 6561          self.hea
-000242d0: 7274 6265 6174 5f77 6f72 6b65 7228 0a20  rtbeat_worker(. 
-000242e0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-000242f0: 7373 3d61 6464 7265 7373 2c0a 2020 2020  ss=address,.    
-00024300: 2020 2020 2020 2020 7265 736f 6c76 655f          resolve_
-00024310: 6164 6472 6573 733d 7265 736f 6c76 655f  address=resolve_
-00024320: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
-00024330: 2020 2020 206e 6f77 3d6e 6f77 2c0a 2020       now=now,.  
-00024340: 2020 2020 2020 2020 2020 7265 736f 7572            resour
-00024350: 6365 733d 7265 736f 7572 6365 732c 0a20  ces=resources,. 
-00024360: 2020 2020 2020 2020 2020 2068 6f73 745f             host_
-00024370: 696e 666f 3d68 6f73 745f 696e 666f 2c0a  info=host_info,.
-00024380: 2020 2020 2020 2020 2020 2020 6d65 7472              metr
-00024390: 6963 733d 6d65 7472 6963 732c 0a20 2020  ics=metrics,.   
-000243a0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000243b0: 2320 446f 206e 6f74 206e 6565 6420 746f  # Do not need to
-000243c0: 2061 646a 7573 7420 7365 6c66 2e74 6f74   adjust self.tot
-000243d0: 616c 5f6f 6363 7570 616e 6379 2061 7320  al_occupancy as 
-000243e0: 7365 6c66 2e6f 6363 7570 616e 6379 5b77  self.occupancy[w
-000243f0: 735d 2063 616e 6e6f 740a 2020 2020 2020  s] cannot.      
-00024400: 2020 2320 6578 6973 7420 6265 666f 7265    # exist before
-00024410: 2074 6869 732e 0a20 2020 2020 2020 2073   this..        s
-00024420: 656c 662e 6368 6563 6b5f 6964 6c65 5f73  elf.check_idle_s
-00024430: 6174 7572 6174 6564 2877 7329 0a0a 2020  aturated(ws)..  
-00024440: 2020 2020 2020 2320 666f 7220 6b65 7920        # for key 
-00024450: 696e 206b 6579 733a 2020 2320 544f 444f  in keys:  # TODO
-00024460: 0a20 2020 2020 2020 2023 2020 2020 2073  .        #     s
-00024470: 656c 662e 6d61 726b 5f6b 6579 5f69 6e5f  elf.mark_key_in_
-00024480: 6d65 6d6f 7279 286b 6579 2c20 5b61 6464  memory(key, [add
-00024490: 7265 7373 5d29 0a0a 2020 2020 2020 2020  ress])..        
-000244a0: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-000244b0: 735b 6164 6472 6573 735d 203d 2042 6174  s[address] = Bat
-000244c0: 6368 6564 5365 6e64 2869 6e74 6572 7661  chedSend(interva
-000244d0: 6c3d 2235 6d73 222c 206c 6f6f 703d 7365  l="5ms", loop=se
-000244e0: 6c66 2e6c 6f6f 7029 0a0a 2020 2020 2020  lf.loop)..      
-000244f0: 2020 666f 7220 706c 7567 696e 2069 6e20    for plugin in 
-00024500: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
-00024510: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
-00024520: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00024530: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00024540: 7375 6c74 203d 2070 6c75 6769 6e2e 6164  sult = plugin.ad
-00024550: 645f 776f 726b 6572 2873 6368 6564 756c  d_worker(schedul
-00024560: 6572 3d73 656c 662c 2077 6f72 6b65 723d  er=self, worker=
-00024570: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-00024580: 2020 2020 2020 2020 2069 6620 7265 7375           if resu
-00024590: 6c74 2069 7320 6e6f 7420 4e6f 6e65 2061  lt is not None a
-000245a0: 6e64 2069 6e73 7065 6374 2e69 7361 7761  nd inspect.isawa
-000245b0: 6974 6162 6c65 2872 6573 756c 7429 3a0a  itable(result):.
-000245c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245d0: 2020 2020 6177 6169 7420 7265 7375 6c74      await result
-000245e0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000245f0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00024600: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00024610: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
-00024620: 7469 6f6e 2865 290a 0a20 2020 2020 2020  tion(e)..       
-00024630: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
-00024640: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
-00024650: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00024660: 662e 7472 616e 7369 7469 6f6e 7328 0a20  f.transitions(. 
-00024670: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00024680: 656c 662e 6275 6c6b 5f73 6368 6564 756c  elf.bulk_schedul
-00024690: 655f 756e 7275 6e6e 6162 6c65 5f61 6674  e_unrunnable_aft
-000246a0: 6572 5f61 6464 696e 675f 776f 726b 6572  er_adding_worker
-000246b0: 2877 7329 2c20 7374 696d 756c 7573 5f69  (ws), stimulus_i
-000246c0: 640a 2020 2020 2020 2020 2020 2020 290a  d.            ).
-000246d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000246e0: 2e73 7469 6d75 6c75 735f 7175 6575 655f  .stimulus_queue_
-000246f0: 736c 6f74 735f 6d61 7962 655f 6f70 656e  slots_maybe_open
-00024700: 6564 2873 7469 6d75 6c75 735f 6964 3d73  ed(stimulus_id=s
-00024710: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
-00024720: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-00024730: 2822 5265 6769 7374 6572 2077 6f72 6b65  ("Register worke
-00024740: 7220 2573 222c 2077 7329 0a0a 2020 2020  r %s", ws)..    
-00024750: 2020 2020 6d73 6720 3d20 7b0a 2020 2020      msg = {.    
-00024760: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-00024770: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-00024780: 2020 2020 2274 696d 6522 3a20 7469 6d65      "time": time
-00024790: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-000247a0: 2268 6561 7274 6265 6174 2d69 6e74 6572  "heartbeat-inter
-000247b0: 7661 6c22 3a20 6865 6172 7462 6561 745f  val": heartbeat_
-000247c0: 696e 7465 7276 616c 286c 656e 2873 656c  interval(len(sel
-000247d0: 662e 776f 726b 6572 7329 292c 0a20 2020  f.workers)),.   
-000247e0: 2020 2020 2020 2020 2022 776f 726b 6572           "worker
-000247f0: 2d70 6c75 6769 6e73 223a 2073 656c 662e  -plugins": self.
-00024800: 776f 726b 6572 5f70 6c75 6769 6e73 2c0a  worker_plugins,.
-00024810: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00024820: 2020 2076 6572 7369 6f6e 5f77 6172 6e69     version_warni
-00024830: 6e67 203d 2076 6572 7369 6f6e 5f6d 6f64  ng = version_mod
-00024840: 756c 652e 6572 726f 725f 6d65 7373 6167  ule.error_messag
-00024850: 6528 0a20 2020 2020 2020 2020 2020 2076  e(.            v
-00024860: 6572 7369 6f6e 5f6d 6f64 756c 652e 6765  ersion_module.ge
-00024870: 745f 7665 7273 696f 6e73 2829 2c0a 2020  t_versions(),.  
-00024880: 2020 2020 2020 2020 2020 7b77 3a20 7773            {w: ws
-00024890: 2e76 6572 7369 6f6e 7320 666f 7220 772c  .versions for w,
-000248a0: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
-000248b0: 6572 732e 6974 656d 7328 297d 2c0a 2020  ers.items()},.  
-000248c0: 2020 2020 2020 2020 2020 7665 7273 696f            versio
-000248d0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-000248e0: 736f 7572 6365 5f6e 616d 653d 7374 7228  source_name=str(
-000248f0: 7773 2e73 6572 7665 725f 6964 292c 0a20  ws.server_id),. 
-00024900: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00024910: 206d 7367 2e75 7064 6174 6528 7665 7273   msg.update(vers
-00024920: 696f 6e5f 7761 726e 696e 6729 0a0a 2020  ion_warning)..  
-00024930: 2020 2020 2020 6177 6169 7420 636f 6d6d        await comm
-00024940: 2e77 7269 7465 286d 7367 290a 2020 2020  .write(msg).    
-00024950: 2020 2020 2320 5468 6973 2077 696c 6c20      # This will 
-00024960: 6b65 6570 2072 756e 6e69 6e67 2075 6e74  keep running unt
-00024970: 696c 2074 6865 2077 6f72 6b65 7220 6973  il the worker is
-00024980: 2072 656d 6f76 6564 0a20 2020 2020 2020   removed.       
-00024990: 2061 7761 6974 2073 656c 662e 6861 6e64   await self.hand
-000249a0: 6c65 5f77 6f72 6b65 7228 636f 6d6d 2c20  le_worker(comm, 
-000249b0: 6164 6472 6573 7329 0a0a 2020 2020 6173  address)..    as
-000249c0: 796e 6320 6465 6620 6164 645f 6e61 6e6e  ync def add_nann
-000249d0: 7928 7365 6c66 2920 2d3e 2064 6963 745b  y(self) -> dict[
-000249e0: 7374 722c 2041 6e79 5d3a 0a20 2020 2020  str, Any]:.     
-000249f0: 2020 206d 7367 203d 207b 0a20 2020 2020     msg = {.     
-00024a00: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
-00024a10: 2022 4f4b 222c 0a20 2020 2020 2020 2020   "OK",.         
-00024a20: 2020 2022 6e61 6e6e 792d 706c 7567 696e     "nanny-plugin
-00024a30: 7322 3a20 7365 6c66 2e6e 616e 6e79 5f70  s": self.nanny_p
-00024a40: 6c75 6769 6e73 2c0a 2020 2020 2020 2020  lugins,.        
-00024a50: 7d0a 2020 2020 2020 2020 7265 7475 726e  }.        return
-00024a60: 206d 7367 0a0a 2020 2020 6465 6620 7570   msg..    def up
-00024a70: 6461 7465 5f67 7261 7068 5f68 6c67 280a  date_graph_hlg(.
-00024a80: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00024a90: 2020 2020 2020 636c 6965 6e74 3d4e 6f6e        client=Non
-00024aa0: 652c 0a20 2020 2020 2020 2068 6c67 3d4e  e,.        hlg=N
-00024ab0: 6f6e 652c 0a20 2020 2020 2020 206b 6579  one,.        key
-00024ac0: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
-00024ad0: 6465 7065 6e64 656e 6369 6573 3d4e 6f6e  dependencies=Non
-00024ae0: 652c 0a20 2020 2020 2020 2072 6573 7472  e,.        restr
-00024af0: 6963 7469 6f6e 733d 4e6f 6e65 2c0a 2020  ictions=None,.  
-00024b00: 2020 2020 2020 7072 696f 7269 7479 3d4e        priority=N
-00024b10: 6f6e 652c 0a20 2020 2020 2020 206c 6f6f  one,.        loo
-00024b20: 7365 5f72 6573 7472 6963 7469 6f6e 733d  se_restrictions=
-00024b30: 4e6f 6e65 2c0a 2020 2020 2020 2020 7265  None,.        re
-00024b40: 736f 7572 6365 733d 4e6f 6e65 2c0a 2020  sources=None,.  
-00024b50: 2020 2020 2020 7375 626d 6974 7469 6e67        submitting
-00024b60: 5f74 6173 6b3d 4e6f 6e65 2c0a 2020 2020  _task=None,.    
-00024b70: 2020 2020 7265 7472 6965 733d 4e6f 6e65      retries=None
-00024b80: 2c0a 2020 2020 2020 2020 7573 6572 5f70  ,.        user_p
-00024b90: 7269 6f72 6974 793d 302c 0a20 2020 2020  riority=0,.     
-00024ba0: 2020 2061 6374 6f72 733d 4e6f 6e65 2c0a     actors=None,.
-00024bb0: 2020 2020 2020 2020 6669 666f 5f74 696d          fifo_tim
-00024bc0: 656f 7574 3d30 2c0a 2020 2020 2020 2020  eout=0,.        
-00024bd0: 636f 6465 3d4e 6f6e 652c 0a20 2020 2029  code=None,.    )
-00024be0: 3a0a 2020 2020 2020 2020 756e 7061 636b  :.        unpack
-00024bf0: 6564 5f67 7261 7068 203d 2048 6967 684c  ed_graph = HighL
-00024c00: 6576 656c 4772 6170 682e 5f5f 6461 736b  evelGraph.__dask
-00024c10: 5f64 6973 7472 6962 7574 6564 5f75 6e70  _distributed_unp
-00024c20: 6163 6b5f 5f28 686c 6729 0a20 2020 2020  ack__(hlg).     
-00024c30: 2020 2064 736b 203d 2075 6e70 6163 6b65     dsk = unpacke
-00024c40: 645f 6772 6170 685b 2264 736b 225d 0a20  d_graph["dsk"]. 
-00024c50: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-00024c60: 6965 7320 3d20 756e 7061 636b 6564 5f67  ies = unpacked_g
-00024c70: 7261 7068 5b22 6465 7073 225d 0a20 2020  raph["deps"].   
-00024c80: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
-00024c90: 203d 2075 6e70 6163 6b65 645f 6772 6170   = unpacked_grap
-00024ca0: 685b 2261 6e6e 6f74 6174 696f 6e73 225d  h["annotations"]
-00024cb0: 0a0a 2020 2020 2020 2020 2320 5265 6d6f  ..        # Remo
-00024cc0: 7665 2061 6e79 2073 656c 662d 6465 7065  ve any self-depe
-00024cd0: 6e64 656e 6369 6573 2028 6861 7070 656e  ndencies (happen
-00024ce0: 7320 6f6e 2074 6573 745f 7075 626c 6973  s on test_publis
-00024cf0: 685f 6261 6728 2920 616e 6420 6f74 6865  h_bag() and othe
-00024d00: 7273 290a 2020 2020 2020 2020 666f 7220  rs).        for 
-00024d10: 6b2c 2076 2069 6e20 6465 7065 6e64 656e  k, v in dependen
-00024d20: 6369 6573 2e69 7465 6d73 2829 3a0a 2020  cies.items():.  
-00024d30: 2020 2020 2020 2020 2020 6465 7073 203d            deps =
-00024d40: 2073 6574 2876 290a 2020 2020 2020 2020   set(v).        
-00024d50: 2020 2020 6966 206b 2069 6e20 6465 7073      if k in deps
-00024d60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00024d70: 2020 6465 7073 2e72 656d 6f76 6528 6b29    deps.remove(k)
-00024d80: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
-00024d90: 656e 6465 6e63 6965 735b 6b5d 203d 2064  endencies[k] = d
-00024da0: 6570 730a 0a20 2020 2020 2020 2069 6620  eps..        if 
-00024db0: 7072 696f 7269 7479 2069 7320 4e6f 6e65  priority is None
-00024dc0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00024dd0: 5265 6d6f 7669 6e67 2061 6c6c 206e 6f6e  Removing all non
-00024de0: 2d6c 6f63 616c 206b 6579 7320 6265 666f  -local keys befo
-00024df0: 7265 2063 616c 6c69 6e67 206f 7264 6572  re calling order
-00024e00: 2829 0a20 2020 2020 2020 2020 2020 2064  ().            d
-00024e10: 736b 5f6b 6579 7320 3d20 7365 7428 6473  sk_keys = set(ds
-00024e20: 6b29 2020 2320 696e 7465 7273 6563 7469  k)  # intersecti
-00024e30: 6f6e 2829 206f 6620 7365 7473 2069 7320  on() of sets is 
-00024e40: 6d75 6368 2066 6173 7465 7220 7468 616e  much faster than
-00024e50: 2064 6963 745f 6b65 7973 0a20 2020 2020   dict_keys.     
-00024e60: 2020 2020 2020 2073 7472 6970 7065 645f         stripped_
-00024e70: 6465 7073 203d 207b 0a20 2020 2020 2020  deps = {.       
-00024e80: 2020 2020 2020 2020 206b 3a20 762e 696e           k: v.in
-00024e90: 7465 7273 6563 7469 6f6e 2864 736b 5f6b  tersection(dsk_k
-00024ea0: 6579 7329 0a20 2020 2020 2020 2020 2020  eys).           
-00024eb0: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
-00024ec0: 2064 6570 656e 6465 6e63 6965 732e 6974   dependencies.it
-00024ed0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-00024ee0: 2020 2020 2020 6966 206b 2069 6e20 6473        if k in ds
-00024ef0: 6b5f 6b65 7973 0a20 2020 2020 2020 2020  k_keys.         
-00024f00: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00024f10: 2070 7269 6f72 6974 7920 3d20 6461 736b   priority = dask
-00024f20: 2e6f 7264 6572 2e6f 7264 6572 2864 736b  .order.order(dsk
-00024f30: 2c20 6465 7065 6e64 656e 6369 6573 3d73  , dependencies=s
-00024f40: 7472 6970 7065 645f 6465 7073 290a 0a20  tripped_deps).. 
-00024f50: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00024f60: 6c66 2e75 7064 6174 655f 6772 6170 6828  lf.update_graph(
-00024f70: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00024f80: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-00024f90: 2064 736b 2c0a 2020 2020 2020 2020 2020   dsk,.          
-00024fa0: 2020 6b65 7973 2c0a 2020 2020 2020 2020    keys,.        
-00024fb0: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
-00024fc0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00024fd0: 7374 7269 6374 696f 6e73 2c0a 2020 2020  strictions,.    
-00024fe0: 2020 2020 2020 2020 7072 696f 7269 7479          priority
-00024ff0: 2c0a 2020 2020 2020 2020 2020 2020 6c6f  ,.            lo
-00025000: 6f73 655f 7265 7374 7269 6374 696f 6e73  ose_restrictions
-00025010: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00025020: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
-00025030: 2020 2020 2073 7562 6d69 7474 696e 675f       submitting_
-00025040: 7461 736b 2c0a 2020 2020 2020 2020 2020  task,.          
-00025050: 2020 7265 7472 6965 732c 0a20 2020 2020    retries,.     
-00025060: 2020 2020 2020 2075 7365 725f 7072 696f         user_prio
-00025070: 7269 7479 2c0a 2020 2020 2020 2020 2020  rity,.          
-00025080: 2020 6163 746f 7273 2c0a 2020 2020 2020    actors,.      
-00025090: 2020 2020 2020 6669 666f 5f74 696d 656f        fifo_timeo
-000250a0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-000250b0: 616e 6e6f 7461 7469 6f6e 732c 0a20 2020  annotations,.   
-000250c0: 2020 2020 2020 2020 2063 6f64 653d 636f           code=co
-000250d0: 6465 2c0a 2020 2020 2020 2020 2020 2020  de,.            
-000250e0: 7374 696d 756c 7573 5f69 643d 6622 7570  stimulus_id=f"up
-000250f0: 6461 7465 2d67 7261 7068 2d7b 7469 6d65  date-graph-{time
-00025100: 2829 7d22 2c0a 2020 2020 2020 2020 290a  ()}",.        ).
-00025110: 0a20 2020 2064 6566 2075 7064 6174 655f  .    def update_
-00025120: 6772 6170 6828 0a20 2020 2020 2020 2073  graph(.        s
-00025130: 656c 662c 0a20 2020 2020 2020 2063 6c69  elf,.        cli
-00025140: 656e 743d 4e6f 6e65 2c0a 2020 2020 2020  ent=None,.      
-00025150: 2020 7461 736b 733d 4e6f 6e65 2c0a 2020    tasks=None,.  
-00025160: 2020 2020 2020 6b65 7973 3d4e 6f6e 652c        keys=None,
-00025170: 0a20 2020 2020 2020 2064 6570 656e 6465  .        depende
-00025180: 6e63 6965 733d 4e6f 6e65 2c0a 2020 2020  ncies=None,.    
-00025190: 2020 2020 7265 7374 7269 6374 696f 6e73      restrictions
-000251a0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2070  =None,.        p
-000251b0: 7269 6f72 6974 793d 4e6f 6e65 2c0a 2020  riority=None,.  
-000251c0: 2020 2020 2020 6c6f 6f73 655f 7265 7374        loose_rest
-000251d0: 7269 6374 696f 6e73 3d4e 6f6e 652c 0a20  rictions=None,. 
-000251e0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-000251f0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-00025200: 7562 6d69 7474 696e 675f 7461 736b 3d4e  ubmitting_task=N
-00025210: 6f6e 652c 0a20 2020 2020 2020 2072 6574  one,.        ret
-00025220: 7269 6573 3d4e 6f6e 652c 0a20 2020 2020  ries=None,.     
-00025230: 2020 2075 7365 725f 7072 696f 7269 7479     user_priority
-00025240: 3d30 2c0a 2020 2020 2020 2020 6163 746f  =0,.        acto
-00025250: 7273 3d4e 6f6e 652c 0a20 2020 2020 2020  rs=None,.       
-00025260: 2066 6966 6f5f 7469 6d65 6f75 743d 302c   fifo_timeout=0,
-00025270: 0a20 2020 2020 2020 2061 6e6e 6f74 6174  .        annotat
-00025280: 696f 6e73 3d4e 6f6e 652c 0a20 2020 2020  ions=None,.     
-00025290: 2020 2063 6f64 653d 4e6f 6e65 2c0a 2020     code=None,.  
-000252a0: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-000252b0: 643d 4e6f 6e65 2c0a 2020 2020 293a 0a20  d=None,.    ):. 
-000252c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000252d0: 2020 2041 6464 206e 6577 2063 6f6d 7075     Add new compu
-000252e0: 7461 7469 6f6e 7320 746f 2074 6865 2069  tations to the i
-000252f0: 6e74 6572 6e61 6c20 6461 736b 2067 7261  nternal dask gra
-00025300: 7068 0a0a 2020 2020 2020 2020 5468 6973  ph..        This
-00025310: 2068 6170 7065 6e73 2077 6865 6e65 7665   happens wheneve
-00025320: 7220 7468 6520 436c 6965 6e74 2063 616c  r the Client cal
-00025330: 6c73 2073 7562 6d69 742c 206d 6170 2c20  ls submit, map, 
-00025340: 6765 742c 206f 7220 636f 6d70 7574 652e  get, or compute.
-00025350: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00025360: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00025370: 203d 2073 7469 6d75 6c75 735f 6964 206f   = stimulus_id o
-00025380: 7220 6622 7570 6461 7465 2d67 7261 7068  r f"update-graph
-00025390: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
-000253a0: 2020 2073 7461 7274 203d 2074 696d 6528     start = time(
-000253b0: 290a 2020 2020 2020 2020 6669 666f 5f74  ).        fifo_t
-000253c0: 696d 656f 7574 203d 2070 6172 7365 5f74  imeout = parse_t
-000253d0: 696d 6564 656c 7461 2866 6966 6f5f 7469  imedelta(fifo_ti
-000253e0: 6d65 6f75 7429 0a20 2020 2020 2020 206b  meout).        k
-000253f0: 6579 7320 3d20 7365 7428 6b65 7973 290a  eys = set(keys).
-00025400: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
-00025410: 6173 6b73 2920 3e20 313a 0a20 2020 2020  asks) > 1:.     
-00025420: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-00025430: 6576 656e 7428 0a20 2020 2020 2020 2020  event(.         
-00025440: 2020 2020 2020 205b 2261 6c6c 222c 2063         ["all", c
-00025450: 6c69 656e 745d 2c20 7b22 6163 7469 6f6e  lient], {"action
-00025460: 223a 2022 7570 6461 7465 5f67 7261 7068  ": "update_graph
-00025470: 222c 2022 636f 756e 7422 3a20 6c65 6e28  ", "count": len(
-00025480: 7461 736b 7329 7d0a 2020 2020 2020 2020  tasks)}.        
-00025490: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
-000254a0: 2052 656d 6f76 6520 616c 6961 7365 730a   Remove aliases.
-000254b0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-000254c0: 206c 6973 7428 7461 736b 7329 3a0a 2020   list(tasks):.  
-000254d0: 2020 2020 2020 2020 2020 6966 2074 6173            if tas
-000254e0: 6b73 5b6b 5d20 6973 206b 3a0a 2020 2020  ks[k] is k:.    
-000254f0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-00025500: 7461 736b 735b 6b5d 0a0a 2020 2020 2020  tasks[k]..      
-00025510: 2020 6465 7065 6e64 656e 6369 6573 203d    dependencies =
-00025520: 2064 6570 656e 6465 6e63 6965 7320 6f72   dependencies or
-00025530: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
-00025540: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
-00025550: 616e 6379 203e 2031 652d 3920 616e 6420  ancy > 1e-9 and 
-00025560: 7365 6c66 2e63 6f6d 7075 7461 7469 6f6e  self.computation
-00025570: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-00025580: 2053 7469 6c6c 2077 6f72 6b69 6e67 206f   Still working o
-00025590: 6e20 736f 6d65 7468 696e 672e 2041 7373  n something. Ass
-000255a0: 6967 6e20 6e65 7720 7461 736b 7320 746f  ign new tasks to
-000255b0: 2073 616d 6520 636f 6d70 7574 6174 696f   same computatio
-000255c0: 6e0a 2020 2020 2020 2020 2020 2020 636f  n.            co
-000255d0: 6d70 7574 6174 696f 6e20 3d20 7365 6c66  mputation = self
-000255e0: 2e63 6f6d 7075 7461 7469 6f6e 735b 2d31  .computations[-1
-000255f0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-00025600: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
-00025610: 7574 6174 696f 6e20 3d20 436f 6d70 7574  utation = Comput
-00025620: 6174 696f 6e28 290a 2020 2020 2020 2020  ation().        
-00025630: 2020 2020 7365 6c66 2e63 6f6d 7075 7461      self.computa
-00025640: 7469 6f6e 732e 6170 7065 6e64 2863 6f6d  tions.append(com
-00025650: 7075 7461 7469 6f6e 290a 0a20 2020 2020  putation)..     
-00025660: 2020 2069 6620 636f 6465 2061 6e64 2063     if code and c
-00025670: 6f64 6520 6e6f 7420 696e 2063 6f6d 7075  ode not in compu
-00025680: 7461 7469 6f6e 2e63 6f64 653a 2020 2320  tation.code:  # 
-00025690: 6164 6420 6e65 7720 636f 6465 2062 6c6f  add new code blo
-000256a0: 636b 730a 2020 2020 2020 2020 2020 2020  cks.            
-000256b0: 636f 6d70 7574 6174 696f 6e2e 636f 6465  computation.code
-000256c0: 2e61 6464 2863 6f64 6529 0a0a 2020 2020  .add(code)..    
-000256d0: 2020 2020 6e20 3d20 300a 2020 2020 2020      n = 0.      
-000256e0: 2020 7768 696c 6520 6c65 6e28 7461 736b    while len(task
-000256f0: 7329 2021 3d20 6e3a 2020 2320 7761 6c6b  s) != n:  # walk
-00025700: 2074 6872 6f75 6768 206e 6577 2074 6173   through new tas
-00025710: 6b73 2c20 6361 6e63 656c 2061 6e79 2062  ks, cancel any b
-00025720: 6164 2064 6570 730a 2020 2020 2020 2020  ad deps.        
-00025730: 2020 2020 6e20 3d20 6c65 6e28 7461 736b      n = len(task
-00025740: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-00025750: 6f72 206b 2c20 6465 7073 2069 6e20 6c69  or k, deps in li
-00025760: 7374 2864 6570 656e 6465 6e63 6965 732e  st(dependencies.
-00025770: 6974 656d 7328 2929 3a0a 2020 2020 2020  items()):.      
-00025780: 2020 2020 2020 2020 2020 6966 2061 6e79            if any
-00025790: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000257a0: 2020 2020 2020 6465 7020 6e6f 7420 696e        dep not in
-000257b0: 2073 656c 662e 7461 736b 7320 616e 6420   self.tasks and 
-000257c0: 6465 7020 6e6f 7420 696e 2074 6173 6b73  dep not in tasks
-000257d0: 2066 6f72 2064 6570 2069 6e20 6465 7073   for dep in deps
-000257e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000257f0: 2029 3a20 2023 2062 6164 206b 6579 0a20   ):  # bad key. 
-00025800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025810: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-00025820: 5573 6572 2061 736b 6564 2066 6f72 2063  User asked for c
-00025830: 6f6d 7075 7461 7469 6f6e 206f 6e20 6c6f  omputation on lo
-00025840: 7374 2064 6174 612c 2025 7322 2c20 6b29  st data, %s", k)
-00025850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025860: 2020 2020 2064 656c 2074 6173 6b73 5b6b       del tasks[k
-00025870: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00025880: 2020 2020 2020 6465 6c20 6465 7065 6e64        del depend
-00025890: 656e 6369 6573 5b6b 5d0a 2020 2020 2020  encies[k].      
-000258a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000258b0: 206b 2069 6e20 6b65 7973 3a0a 2020 2020   k in keys:.    
-000258c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000258d0: 2020 2020 6b65 7973 2e72 656d 6f76 6528      keys.remove(
-000258e0: 6b29 0a20 2020 2020 2020 2020 2020 2020  k).             
-000258f0: 2020 2020 2020 2073 656c 662e 7265 706f         self.repo
-00025900: 7274 287b 226f 7022 3a20 2263 616e 6365  rt({"op": "cance
-00025910: 6c6c 6564 2d6b 6579 222c 2022 6b65 7922  lled-key", "key"
-00025920: 3a20 6b7d 2c20 636c 6965 6e74 3d63 6c69  : k}, client=cli
-00025930: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
-00025940: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
-00025950: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
-00025960: 7973 280a 2020 2020 2020 2020 2020 2020  ys(.            
-00025970: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-00025980: 3d5b 6b5d 2c20 636c 6965 6e74 3d63 6c69  =[k], client=cli
-00025990: 656e 742c 2073 7469 6d75 6c75 735f 6964  ent, stimulus_id
-000259a0: 3d73 7469 6d75 6c75 735f 6964 0a20 2020  =stimulus_id.   
-000259b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000259c0: 2029 0a0a 2020 2020 2020 2020 2320 4176   )..        # Av
-000259d0: 6f69 6420 636f 6d70 7574 6174 696f 6e20  oid computation 
-000259e0: 7468 6174 2069 7320 616c 7265 6164 7920  that is already 
-000259f0: 6669 6e69 7368 6564 0a20 2020 2020 2020  finished.       
-00025a00: 2061 6c72 6561 6479 5f69 6e5f 6d65 6d6f   already_in_memo
-00025a10: 7279 203d 2073 6574 2829 2020 2320 7461  ry = set()  # ta
-00025a20: 736b 7320 7468 6174 2061 7265 2061 6c72  sks that are alr
-00025a30: 6561 6479 2064 6f6e 650a 2020 2020 2020  eady done.      
-00025a40: 2020 666f 7220 6b2c 2076 2069 6e20 6465    for k, v in de
-00025a50: 7065 6e64 656e 6369 6573 2e69 7465 6d73  pendencies.items
-00025a60: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00025a70: 6966 2076 2061 6e64 206b 2069 6e20 7365  if v and k in se
-00025a80: 6c66 2e74 6173 6b73 3a0a 2020 2020 2020  lf.tasks:.      
-00025a90: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-00025aa0: 656c 662e 7461 736b 735b 6b5d 0a20 2020  elf.tasks[k].   
-00025ab0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00025ac0: 7473 2e73 7461 7465 2069 6e20 2822 6d65  ts.state in ("me
-00025ad0: 6d6f 7279 222c 2022 6572 7265 6422 293a  mory", "erred"):
-00025ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025af0: 2020 2020 2061 6c72 6561 6479 5f69 6e5f       already_in_
-00025b00: 6d65 6d6f 7279 2e61 6464 286b 290a 0a20  memory.add(k).. 
-00025b10: 2020 2020 2020 2069 6620 616c 7265 6164         if alread
-00025b20: 795f 696e 5f6d 656d 6f72 793a 0a20 2020  y_in_memory:.   
-00025b30: 2020 2020 2020 2020 2064 6570 656e 6465           depende
-00025b40: 6e74 7320 3d20 6461 736b 2e63 6f72 652e  nts = dask.core.
-00025b50: 7265 7665 7273 655f 6469 6374 2864 6570  reverse_dict(dep
-00025b60: 656e 6465 6e63 6965 7329 0a20 2020 2020  endencies).     
-00025b70: 2020 2020 2020 2073 7461 636b 203d 206c         stack = l
-00025b80: 6973 7428 616c 7265 6164 795f 696e 5f6d  ist(already_in_m
-00025b90: 656d 6f72 7929 0a20 2020 2020 2020 2020  emory).         
-00025ba0: 2020 2064 6f6e 6520 3d20 7365 7428 616c     done = set(al
-00025bb0: 7265 6164 795f 696e 5f6d 656d 6f72 7929  ready_in_memory)
-00025bc0: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-00025bd0: 6c65 2073 7461 636b 3a20 2023 2072 656d  le stack:  # rem
-00025be0: 6f76 6520 756e 6e65 6365 7373 6172 7920  ove unnecessary 
-00025bf0: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
-00025c00: 2020 2020 2020 2020 2020 2020 206b 6579               key
-00025c10: 203d 2073 7461 636b 2e70 6f70 2829 0a20   = stack.pop(). 
-00025c20: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00025c30: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00025c40: 2020 2020 2020 2020 6465 7073 203d 2064          deps = d
-00025c50: 6570 656e 6465 6e63 6965 735b 6b65 795d  ependencies[key]
-00025c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025c70: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-00025c80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00025c90: 2020 2020 2020 6465 7073 203d 2073 656c        deps = sel
-00025ca0: 662e 7461 736b 735b 6b65 795d 2e64 6570  f.tasks[key].dep
-00025cb0: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
-00025cc0: 2020 2020 2020 2020 2020 666f 7220 6465            for de
-00025cd0: 7020 696e 2064 6570 733a 0a20 2020 2020  p in deps:.     
-00025ce0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00025cf0: 6620 6465 7020 696e 2064 6570 656e 6465  f dep in depende
-00025d00: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00025d10: 2020 2020 2020 2020 2020 2020 2063 6869               chi
-00025d20: 6c64 5f64 6570 7320 3d20 6465 7065 6e64  ld_deps = depend
-00025d30: 656e 7473 5b64 6570 5d0a 2020 2020 2020  ents[dep].      
-00025d40: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00025d50: 6966 2064 6570 2069 6e20 7365 6c66 2e74  if dep in self.t
-00025d60: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
-00025d70: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00025d80: 696c 645f 6465 7073 203d 2073 656c 662e  ild_deps = self.
-00025d90: 7461 736b 735b 6465 705d 2e64 6570 656e  tasks[dep].depen
-00025da0: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
-00025db0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00025dc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00025dd0: 2020 2020 2020 2020 2020 6368 696c 645f            child_
-00025de0: 6465 7073 203d 2073 6574 2829 0a20 2020  deps = set().   
-00025df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025e00: 2069 6620 616c 6c28 6420 696e 2064 6f6e   if all(d in don
-00025e10: 6520 666f 7220 6420 696e 2063 6869 6c64  e for d in child
-00025e20: 5f64 6570 7329 3a0a 2020 2020 2020 2020  _deps):.        
-00025e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025e40: 6966 2064 6570 2069 6e20 7365 6c66 2e74  if dep in self.t
-00025e50: 6173 6b73 2061 6e64 2064 6570 206e 6f74  asks and dep not
-00025e60: 2069 6e20 646f 6e65 3a0a 2020 2020 2020   in done:.      
-00025e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025e80: 2020 2020 2020 646f 6e65 2e61 6464 2864        done.add(d
-00025e90: 6570 290a 2020 2020 2020 2020 2020 2020  ep).            
-00025ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025eb0: 7374 6163 6b2e 6170 7065 6e64 2864 6570  stack.append(dep
-00025ec0: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
-00025ed0: 6f72 2064 2069 6e20 646f 6e65 3a0a 2020  or d in done:.  
-00025ee0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-00025ef0: 736b 732e 706f 7028 642c 204e 6f6e 6529  sks.pop(d, None)
-00025f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025f10: 2064 6570 656e 6465 6e63 6965 732e 706f   dependencies.po
-00025f20: 7028 642c 204e 6f6e 6529 0a0a 2020 2020  p(d, None)..    
-00025f30: 2020 2020 2320 4765 7420 6f72 2063 7265      # Get or cre
-00025f40: 6174 6520 7461 736b 2073 7461 7465 730a  ate task states.
-00025f50: 2020 2020 2020 2020 7374 6163 6b20 3d20          stack = 
-00025f60: 6c69 7374 286b 6579 7329 0a20 2020 2020  list(keys).     
-00025f70: 2020 2074 6f75 6368 6564 5f6b 6579 7320     touched_keys 
-00025f80: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00025f90: 746f 7563 6865 645f 7461 736b 7320 3d20  touched_tasks = 
-00025fa0: 5b5d 0a20 2020 2020 2020 2077 6869 6c65  [].        while
-00025fb0: 2073 7461 636b 3a0a 2020 2020 2020 2020   stack:.        
-00025fc0: 2020 2020 6b20 3d20 7374 6163 6b2e 706f      k = stack.po
-00025fd0: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-00025fe0: 6966 206b 2069 6e20 746f 7563 6865 645f  if k in touched_
-00025ff0: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-00026000: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00026010: 2020 2020 2020 2020 2020 2023 2058 5858             # XXX
-00026020: 2048 6176 6520 6120 6d65 7468 6f64 2067   Have a method g
-00026030: 6574 5f74 6173 6b5f 7374 6174 6528 7365  et_task_state(se
-00026040: 6c66 2c20 6b29 203f 0a20 2020 2020 2020  lf, k) ?.       
-00026050: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00026060: 6173 6b73 2e67 6574 286b 290a 2020 2020  asks.get(k).    
-00026070: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
-00026080: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00026090: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-000260a0: 2e6e 6577 5f74 6173 6b28 6b2c 2074 6173  .new_task(k, tas
-000260b0: 6b73 2e67 6574 286b 292c 2022 7265 6c65  ks.get(k), "rele
-000260c0: 6173 6564 222c 2063 6f6d 7075 7461 7469  ased", computati
-000260d0: 6f6e 3d63 6f6d 7075 7461 7469 6f6e 290a  on=computation).
-000260e0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-000260f0: 206e 6f74 2074 732e 7275 6e5f 7370 6563   not ts.run_spec
-00026100: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00026110: 2020 7473 2e72 756e 5f73 7065 6320 3d20    ts.run_spec = 
-00026120: 7461 736b 732e 6765 7428 6b29 0a0a 2020  tasks.get(k)..  
-00026130: 2020 2020 2020 2020 2020 746f 7563 6865            touche
-00026140: 645f 6b65 7973 2e61 6464 286b 290a 2020  d_keys.add(k).  
-00026150: 2020 2020 2020 2020 2020 746f 7563 6865            touche
-00026160: 645f 7461 736b 732e 6170 7065 6e64 2874  d_tasks.append(t
-00026170: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
-00026180: 7461 636b 2e65 7874 656e 6428 6465 7065  tack.extend(depe
-00026190: 6e64 656e 6369 6573 2e67 6574 286b 2c20  ndencies.get(k, 
-000261a0: 2829 2929 0a0a 2020 2020 2020 2020 7365  ()))..        se
-000261b0: 6c66 2e63 6c69 656e 745f 6465 7369 7265  lf.client_desire
-000261c0: 735f 6b65 7973 286b 6579 733d 6b65 7973  s_keys(keys=keys
-000261d0: 2c20 636c 6965 6e74 3d63 6c69 656e 7429  , client=client)
-000261e0: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
-000261f0: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
-00026200: 2020 2020 2066 6f72 206b 6579 2c20 6465       for key, de
-00026210: 7073 2069 6e20 6465 7065 6e64 656e 6369  ps in dependenci
-00026220: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
-00026230: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00026240: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-00026250: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00026260: 7473 2069 7320 4e6f 6e65 206f 7220 7473  ts is None or ts
-00026270: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-00026280: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00026290: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-000262a0: 2020 2020 666f 7220 6465 7020 696e 2064      for dep in d
-000262b0: 6570 733a 0a20 2020 2020 2020 2020 2020  eps:.           
-000262c0: 2020 2020 2064 7473 203d 2073 656c 662e       dts = self.
-000262d0: 7461 736b 735b 6465 705d 0a20 2020 2020  tasks[dep].     
-000262e0: 2020 2020 2020 2020 2020 2074 732e 6164             ts.ad
-000262f0: 645f 6465 7065 6e64 656e 6379 2864 7473  d_dependency(dts
-00026300: 290a 0a20 2020 2020 2020 2023 2043 6f6d  )..        # Com
-00026310: 7075 7465 2070 7269 6f72 6974 6965 730a  pute priorities.
-00026320: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00026330: 7461 6e63 6528 7573 6572 5f70 7269 6f72  tance(user_prior
-00026340: 6974 792c 204e 756d 6265 7229 3a0a 2020  ity, Number):.  
-00026350: 2020 2020 2020 2020 2020 7573 6572 5f70            user_p
-00026360: 7269 6f72 6974 7920 3d20 7b6b 3a20 7573  riority = {k: us
-00026370: 6572 5f70 7269 6f72 6974 7920 666f 7220  er_priority for 
-00026380: 6b20 696e 2074 6173 6b73 7d0a 0a20 2020  k in tasks}..   
-00026390: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
-000263a0: 203d 2061 6e6e 6f74 6174 696f 6e73 206f   = annotations o
-000263b0: 7220 7b7d 0a20 2020 2020 2020 2072 6573  r {}.        res
-000263c0: 7472 6963 7469 6f6e 7320 3d20 7265 7374  trictions = rest
-000263d0: 7269 6374 696f 6e73 206f 7220 7b7d 0a20  rictions or {}. 
-000263e0: 2020 2020 2020 206c 6f6f 7365 5f72 6573         loose_res
-000263f0: 7472 6963 7469 6f6e 7320 3d20 6c6f 6f73  trictions = loos
-00026400: 655f 7265 7374 7269 6374 696f 6e73 206f  e_restrictions o
-00026410: 7220 5b5d 0a20 2020 2020 2020 2072 6573  r [].        res
-00026420: 6f75 7263 6573 203d 2072 6573 6f75 7263  ources = resourc
-00026430: 6573 206f 7220 7b7d 0a20 2020 2020 2020  es or {}.       
-00026440: 2072 6574 7269 6573 203d 2072 6574 7269   retries = retri
-00026450: 6573 206f 7220 7b7d 0a0a 2020 2020 2020  es or {}..      
-00026460: 2020 2320 4f76 6572 7269 6465 2065 7869    # Override exi
-00026470: 7374 696e 6720 7461 786f 6e6f 6d79 2077  sting taxonomy w
-00026480: 6974 6820 7065 7220 7461 736b 2061 6e6e  ith per task ann
-00026490: 6f74 6174 696f 6e73 0a20 2020 2020 2020  otations.       
-000264a0: 2069 6620 616e 6e6f 7461 7469 6f6e 733a   if annotations:
-000264b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000264c0: 2270 7269 6f72 6974 7922 2069 6e20 616e  "priority" in an
-000264d0: 6e6f 7461 7469 6f6e 733a 0a20 2020 2020  notations:.     
-000264e0: 2020 2020 2020 2020 2020 2075 7365 725f             user_
-000264f0: 7072 696f 7269 7479 2e75 7064 6174 6528  priority.update(
-00026500: 616e 6e6f 7461 7469 6f6e 735b 2270 7269  annotations["pri
-00026510: 6f72 6974 7922 5d29 0a0a 2020 2020 2020  ority"])..      
-00026520: 2020 2020 2020 6966 2022 776f 726b 6572        if "worker
-00026530: 7322 2069 6e20 616e 6e6f 7461 7469 6f6e  s" in annotation
-00026540: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00026550: 2020 2072 6573 7472 6963 7469 6f6e 732e     restrictions.
-00026560: 7570 6461 7465 2861 6e6e 6f74 6174 696f  update(annotatio
-00026570: 6e73 5b22 776f 726b 6572 7322 5d29 0a0a  ns["workers"])..
-00026580: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-00026590: 616c 6c6f 775f 6f74 6865 725f 776f 726b  allow_other_work
-000265a0: 6572 7322 2069 6e20 616e 6e6f 7461 7469  ers" in annotati
-000265b0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-000265c0: 2020 2020 206c 6f6f 7365 5f72 6573 7472       loose_restr
-000265d0: 6963 7469 6f6e 732e 6578 7465 6e64 280a  ictions.extend(.
-000265e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000265f0: 2020 2020 6b20 666f 7220 6b2c 2076 2069      k for k, v i
-00026600: 6e20 616e 6e6f 7461 7469 6f6e 735b 2261  n annotations["a
-00026610: 6c6c 6f77 5f6f 7468 6572 5f77 6f72 6b65  llow_other_worke
-00026620: 7273 225d 2e69 7465 6d73 2829 2069 6620  rs"].items() if 
-00026630: 760a 2020 2020 2020 2020 2020 2020 2020  v.              
-00026640: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00026650: 2069 6620 2272 6574 7269 6573 2220 696e   if "retries" in
-00026660: 2061 6e6e 6f74 6174 696f 6e73 3a0a 2020   annotations:.  
-00026670: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00026680: 7472 6965 732e 7570 6461 7465 2861 6e6e  tries.update(ann
-00026690: 6f74 6174 696f 6e73 5b22 7265 7472 6965  otations["retrie
-000266a0: 7322 5d29 0a0a 2020 2020 2020 2020 2020  s"])..          
-000266b0: 2020 6966 2022 7265 736f 7572 6365 7322    if "resources"
-000266c0: 2069 6e20 616e 6e6f 7461 7469 6f6e 733a   in annotations:
-000266d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000266e0: 2072 6573 6f75 7263 6573 2e75 7064 6174   resources.updat
-000266f0: 6528 616e 6e6f 7461 7469 6f6e 735b 2272  e(annotations["r
-00026700: 6573 6f75 7263 6573 225d 290a 0a20 2020  esources"])..   
-00026710: 2020 2020 2020 2020 2066 6f72 2061 2c20           for a, 
-00026720: 6b76 2069 6e20 616e 6e6f 7461 7469 6f6e  kv in annotation
-00026730: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-00026740: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00026750: 2c20 7620 696e 206b 762e 6974 656d 7328  , v in kv.items(
-00026760: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00026770: 2020 2020 2020 2023 2054 6173 6b73 206d         # Tasks m
-00026780: 6967 6874 2068 6176 6520 6265 656e 2063  ight have been c
-00026790: 756c 6c65 642c 2069 6e20 7768 6963 6820  ulled, in which 
-000267a0: 6361 7365 0a20 2020 2020 2020 2020 2020  case.           
-000267b0: 2020 2020 2020 2020 2023 2077 6520 6861           # we ha
-000267c0: 7665 206e 6f74 6869 6e67 2074 6f20 616e  ve nothing to an
-000267d0: 6e6f 7461 7465 2e0a 2020 2020 2020 2020  notate..        
-000267e0: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-000267f0: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
-00026800: 6b29 0a20 2020 2020 2020 2020 2020 2020  k).             
-00026810: 2020 2020 2020 2069 6620 7473 2069 7320         if ts is 
-00026820: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00026830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026840: 2020 7473 2e61 6e6e 6f74 6174 696f 6e73    ts.annotations
-00026850: 5b61 5d20 3d20 760a 0a20 2020 2020 2020  [a] = v..       
-00026860: 2023 2041 6464 2061 6374 6f72 730a 2020   # Add actors.  
-00026870: 2020 2020 2020 6966 2061 6374 6f72 7320        if actors 
-00026880: 6973 2054 7275 653a 0a20 2020 2020 2020  is True:.       
-00026890: 2020 2020 2061 6374 6f72 7320 3d20 6c69       actors = li
-000268a0: 7374 286b 6579 7329 0a20 2020 2020 2020  st(keys).       
-000268b0: 2066 6f72 2061 6374 6f72 2069 6e20 6163   for actor in ac
-000268c0: 746f 7273 206f 7220 5b5d 3a0a 2020 2020  tors or []:.    
-000268d0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-000268e0: 662e 7461 736b 735b 6163 746f 725d 0a20  f.tasks[actor]. 
-000268f0: 2020 2020 2020 2020 2020 2074 732e 6163             ts.ac
-00026900: 746f 7220 3d20 5472 7565 0a0a 2020 2020  tor = True..    
-00026910: 2020 2020 7072 696f 7269 7479 203d 2070      priority = p
-00026920: 7269 6f72 6974 7920 6f72 2064 6173 6b2e  riority or dask.
-00026930: 6f72 6465 722e 6f72 6465 7228 0a20 2020  order.order(.   
-00026940: 2020 2020 2020 2020 2074 6173 6b73 0a20           tasks. 
-00026950: 2020 2020 2020 2029 2020 2320 544f 444f         )  # TODO
-00026960: 3a20 6465 6669 6e65 206f 7264 6572 2077  : define order w
-00026970: 7274 206f 6c64 2067 7261 7068 0a0a 2020  rt old graph..  
-00026980: 2020 2020 2020 6966 2073 7562 6d69 7474        if submitt
-00026990: 696e 675f 7461 736b 3a20 2023 2073 7562  ing_task:  # sub
-000269a0: 2d74 6173 6b73 2067 6574 2062 6574 7465  -tasks get bette
-000269b0: 7220 7072 696f 7269 7479 2074 6861 6e20  r priority than 
-000269c0: 7061 7265 6e74 2074 6173 6b73 0a20 2020  parent tasks.   
-000269d0: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-000269e0: 6c66 2e74 6173 6b73 2e67 6574 2873 7562  lf.tasks.get(sub
-000269f0: 6d69 7474 696e 675f 7461 736b 290a 2020  mitting_task).  
-00026a00: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-00026a10: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00026a20: 2020 2020 2020 2020 2020 2020 2067 656e               gen
-00026a30: 6572 6174 696f 6e20 3d20 7473 2e70 7269  eration = ts.pri
-00026a40: 6f72 6974 795b 305d 202d 2030 2e30 310a  ority[0] - 0.01.
-00026a50: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00026a60: 3a20 2023 2073 7570 6572 2d74 6173 6b20  :  # super-task 
-00026a70: 616c 7265 6164 7920 636c 6561 6e65 6420  already cleaned 
-00026a80: 7570 0a20 2020 2020 2020 2020 2020 2020  up.             
-00026a90: 2020 2067 656e 6572 6174 696f 6e20 3d20     generation = 
-00026aa0: 7365 6c66 2e67 656e 6572 6174 696f 6e0a  self.generation.
-00026ab0: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-00026ac0: 662e 5f6c 6173 745f 7469 6d65 202b 2066  f._last_time + f
-00026ad0: 6966 6f5f 7469 6d65 6f75 7420 3c20 7374  ifo_timeout < st
-00026ae0: 6172 743a 0a20 2020 2020 2020 2020 2020  art:.           
-00026af0: 2073 656c 662e 6765 6e65 7261 7469 6f6e   self.generation
-00026b00: 202b 3d20 3120 2023 206f 6c64 6572 2067   += 1  # older g
-00026b10: 7261 7068 2067 656e 6572 6174 696f 6e73  raph generations
-00026b20: 2074 616b 6520 7072 6563 6564 656e 6365   take precedence
-00026b30: 0a20 2020 2020 2020 2020 2020 2067 656e  .            gen
-00026b40: 6572 6174 696f 6e20 3d20 7365 6c66 2e67  eration = self.g
-00026b50: 656e 6572 6174 696f 6e0a 2020 2020 2020  eneration.      
-00026b60: 2020 2020 2020 7365 6c66 2e5f 6c61 7374        self._last
-00026b70: 5f74 696d 6520 3d20 7374 6172 740a 2020  _time = start.  
-00026b80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00026b90: 2020 2020 2020 2020 6765 6e65 7261 7469          generati
-00026ba0: 6f6e 203d 2073 656c 662e 6765 6e65 7261  on = self.genera
-00026bb0: 7469 6f6e 0a0a 2020 2020 2020 2020 666f  tion..        fo
-00026bc0: 7220 6b65 7920 696e 2073 6574 2870 7269  r key in set(pri
-00026bd0: 6f72 6974 7929 2026 2074 6f75 6368 6564  ority) & touched
-00026be0: 5f6b 6579 733a 0a20 2020 2020 2020 2020  _keys:.         
-00026bf0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00026c00: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-00026c10: 2020 2020 6966 2074 732e 7072 696f 7269      if ts.priori
-00026c20: 7479 2069 7320 4e6f 6e65 3a0a 2020 2020  ty is None:.    
-00026c30: 2020 2020 2020 2020 2020 2020 7473 2e70              ts.p
-00026c40: 7269 6f72 6974 7920 3d20 282d 2875 7365  riority = (-(use
-00026c50: 725f 7072 696f 7269 7479 2e67 6574 286b  r_priority.get(k
-00026c60: 6579 2c20 3029 292c 2067 656e 6572 6174  ey, 0)), generat
-00026c70: 696f 6e2c 2070 7269 6f72 6974 795b 6b65  ion, priority[ke
-00026c80: 795d 290a 0a20 2020 2020 2020 2023 2045  y])..        # E
-00026c90: 6e73 7572 6520 616c 6c20 7275 6e6e 6162  nsure all runnab
-00026ca0: 6c65 7320 6861 7665 2061 2070 7269 6f72  les have a prior
-00026cb0: 6974 790a 2020 2020 2020 2020 7275 6e6e  ity.        runn
-00026cc0: 6162 6c65 7320 3d20 5b74 7320 666f 7220  ables = [ts for 
-00026cd0: 7473 2069 6e20 746f 7563 6865 645f 7461  ts in touched_ta
-00026ce0: 736b 7320 6966 2074 732e 7275 6e5f 7370  sks if ts.run_sp
-00026cf0: 6563 5d0a 2020 2020 2020 2020 666f 7220  ec].        for 
-00026d00: 7473 2069 6e20 7275 6e6e 6162 6c65 733a  ts in runnables:
-00026d10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00026d20: 7473 2e70 7269 6f72 6974 7920 6973 204e  ts.priority is N
-00026d30: 6f6e 6520 616e 6420 7473 2e72 756e 5f73  one and ts.run_s
-00026d40: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
-00026d50: 2020 2020 2074 732e 7072 696f 7269 7479       ts.priority
-00026d60: 203d 2028 7365 6c66 2e67 656e 6572 6174   = (self.generat
-00026d70: 696f 6e2c 2030 290a 0a20 2020 2020 2020  ion, 0)..       
-00026d80: 2069 6620 7265 7374 7269 6374 696f 6e73   if restrictions
-00026d90: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00026da0: 2a72 6573 7472 6963 7469 6f6e 732a 2069  *restrictions* i
-00026db0: 7320 6120 6469 6374 206b 6579 696e 6720  s a dict keying 
-00026dc0: 7461 736b 2069 6473 2074 6f20 6c69 7374  task ids to list
-00026dd0: 7320 6f66 0a20 2020 2020 2020 2020 2020  s of.           
-00026de0: 2023 2072 6573 7472 6963 7469 6f6e 2073   # restriction s
-00026df0: 7065 6369 6669 6361 7469 6f6e 7320 2865  pecifications (e
-00026e00: 6974 6865 7220 776f 726b 6572 206e 616d  ither worker nam
-00026e10: 6573 206f 7220 6164 6472 6573 7365 7329  es or addresses)
-00026e20: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00026e30: 206b 2c20 7620 696e 2072 6573 7472 6963   k, v in restric
-00026e40: 7469 6f6e 732e 6974 656d 7328 293a 0a20  tions.items():. 
-00026e50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00026e60: 6620 7620 6973 204e 6f6e 653a 0a20 2020  f v is None:.   
-00026e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026e80: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00026e90: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-00026ea0: 656c 662e 7461 736b 732e 6765 7428 6b29  elf.tasks.get(k)
-00026eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026ec0: 2069 6620 7473 2069 7320 4e6f 6e65 3a0a   if ts is None:.
-00026ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ee0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-00026ef0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-00026f00: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
-00026f10: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
-00026f20: 2020 2020 2020 2020 2020 7473 2e77 6f72            ts.wor
-00026f30: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-00026f40: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-00026f50: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
-00026f60: 7375 7265 2060 7660 2069 7320 6120 636f  sure `v` is a co
-00026f70: 6c6c 6563 7469 6f6e 2061 6e64 206e 6f74  llection and not
-00026f80: 2061 2073 696e 676c 6520 776f 726b 6572   a single worker
-00026f90: 206e 616d 6520 2f20 6164 6472 6573 730a   name / address.
-00026fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026fb0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00026fc0: 6528 762c 2028 6c69 7374 2c20 7475 706c  e(v, (list, tupl
-00026fd0: 652c 2073 6574 2929 3a0a 2020 2020 2020  e, set)):.      
-00026fe0: 2020 2020 2020 2020 2020 2020 2020 7620                v 
-00026ff0: 3d20 5b76 5d0a 2020 2020 2020 2020 2020  = [v].          
-00027000: 2020 2020 2020 666f 7220 7720 696e 2076        for w in v
-00027010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00027020: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00027030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027040: 2020 2077 203d 2073 656c 662e 636f 6572     w = self.coer
-00027050: 6365 5f61 6464 7265 7373 2877 290a 2020  ce_address(w).  
-00027060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027070: 2020 6578 6365 7074 2056 616c 7565 4572    except ValueEr
-00027080: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00027090: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-000270a0: 6f74 2061 2076 616c 6964 2061 6464 7265  ot a valid addre
-000270b0: 7373 2c20 6275 7420 7065 7268 6170 7320  ss, but perhaps 
-000270c0: 6974 2773 2061 2068 6f73 746e 616d 650a  it's a hostname.
+0001e570: 2020 2020 2020 2020 2023 2074 6865 2073           # the s
+0001e580: 6368 6564 756c 6572 2061 6374 6976 6974  cheduler activit
+0001e590: 792e 2048 6f77 6576 6572 2c20 6279 2061  y. However, by a
+0001e5a0: 6464 696e 6720 616e 206f 7065 6e20 4a75  dding an open Ju
+0001e5b0: 7079 7465 7220 6170 706c 6963 6174 696f  pyter applicatio
+0001e5c0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0001e5d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001e5e0: 7765 2061 7265 2061 6c6c 6f77 696e 6720  we are allowing 
+0001e5f0: 6172 6269 7472 6172 7920 7265 6d6f 7465  arbitrary remote
+0001e600: 2063 6f64 6520 6578 6563 7574 696f 6e20   code execution 
+0001e610: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
+0001e620: 2076 6961 2074 6865 0a20 2020 2020 2020   via the.       
+0001e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e640: 2020 2020 2023 2064 6173 6862 6f61 7264       # dashboard
+0001e650: 2073 6572 7665 722e 2054 6869 7320 6f70   server. This op
+0001e660: 7469 6f6e 2073 686f 756c 6420 6f6e 6c79  tion should only
+0001e670: 2062 6520 7573 6564 2077 6865 6e20 7468   be used when th
+0001e680: 6520 6461 7368 626f 6172 6420 6973 0a20  e dashboard is. 
+0001e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6a0: 2020 2020 2020 2020 2020 2023 2070 726f             # pro
+0001e6b0: 7465 6374 6564 2076 6961 206f 7468 6572  tected via other
+0001e6c0: 206d 6561 6e73 2c20 6f72 2077 6865 6e20   means, or when 
+0001e6d0: 796f 7520 646f 6e27 7420 6361 7265 2061  you don't care a
+0001e6e0: 626f 7574 2063 6c75 7374 6572 2073 6563  bout cluster sec
+0001e6f0: 7572 6974 792e 0a20 2020 2020 2020 2020  urity..         
+0001e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e710: 2020 2022 746f 6b65 6e22 3a20 2222 2c0a     "token": "",.
+0001e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e730: 2020 2020 2020 2020 2020 2020 2261 6c6c              "all
+0001e740: 6f77 5f72 656d 6f74 655f 6163 6365 7373  ow_remote_access
+0001e750: 223a 2054 7275 652c 0a20 2020 2020 2020  ": True,.       
+0001e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e770: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0001e780: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0001e790: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001e7a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001e7b0: 2020 2020 206a 2e69 6e69 7469 616c 697a       j.initializ
+0001e7c0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0001e7d0: 2020 206e 6577 5f68 7474 7073 6572 7665     new_httpserve
+0001e7e0: 723d 4661 6c73 652c 0a20 2020 2020 2020  r=False,.       
+0001e7f0: 2020 2020 2020 2020 2061 7267 763d 5b5d           argv=[]
+0001e800: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0001e810: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001e820: 2e5f 6a75 7079 7465 725f 7365 7276 6572  ._jupyter_server
+0001e830: 5f61 7070 6c69 6361 7469 6f6e 203d 206a  _application = j
+0001e840: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001e850: 662e 6874 7470 5f61 7070 6c69 6361 7469  f.http_applicati
+0001e860: 6f6e 2e61 6464 5f61 7070 6c69 6361 7469  on.add_applicati
+0001e870: 6f6e 286a 2e77 6562 5f61 7070 290a 0a20  on(j.web_app).. 
+0001e880: 2020 2020 2020 2023 2043 6f6d 6d75 6e69         # Communi
+0001e890: 6361 7469 6f6e 2073 7461 7465 0a20 2020  cation state.   
+0001e8a0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0001e8b0: 5f63 6f6d 6d73 203d 207b 7d0a 2020 2020  _comms = {}.    
+0001e8c0: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
+0001e8d0: 636f 6d6d 7320 3d20 7b7d 0a0a 2020 2020  comms = {}..    
+0001e8e0: 2020 2020 2320 5461 736b 2073 7461 7465      # Task state
+0001e8f0: 0a20 2020 2020 2020 2074 6173 6b73 203d  .        tasks =
+0001e900: 207b 7d0a 0a20 2020 2020 2020 2073 656c   {}..        sel
+0001e910: 662e 6765 6e65 7261 7469 6f6e 203d 2030  f.generation = 0
+0001e920: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+0001e930: 6173 745f 636c 6965 6e74 203d 204e 6f6e  ast_client = Non
+0001e940: 650a 2020 2020 2020 2020 7365 6c66 2e5f  e.        self._
+0001e950: 6c61 7374 5f74 696d 6520 3d20 300a 2020  last_time = 0.  
+0001e960: 2020 2020 2020 756e 7275 6e6e 6162 6c65        unrunnable
+0001e970: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+0001e980: 2071 7565 7565 643a 2048 6561 7053 6574   queued: HeapSet
+0001e990: 5b54 6173 6b53 7461 7465 5d20 3d20 4865  [TaskState] = He
+0001e9a0: 6170 5365 7428 6b65 793d 6f70 6572 6174  apSet(key=operat
+0001e9b0: 6f72 2e61 7474 7267 6574 7465 7228 2270  or.attrgetter("p
+0001e9c0: 7269 6f72 6974 7922 2929 0a0a 2020 2020  riority"))..    
+0001e9d0: 2020 2020 7365 6c66 2e64 6174 6173 6574      self.dataset
+0001e9e0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+0001e9f0: 2320 5072 6566 6978 2d6b 6579 6564 2063  # Prefix-keyed c
+0001ea00: 6f6e 7461 696e 6572 730a 0a20 2020 2020  ontainers..     
+0001ea10: 2020 2023 2043 6c69 656e 7420 7374 6174     # Client stat
+0001ea20: 650a 2020 2020 2020 2020 636c 6965 6e74  e.        client
+0001ea30: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+0001ea40: 2320 576f 726b 6572 2073 7461 7465 0a20  # Worker state. 
+0001ea50: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+0001ea60: 2053 6f72 7465 6444 6963 7428 290a 0a20   SortedDict().. 
+0001ea70: 2020 2020 2020 2068 6f73 745f 696e 666f         host_info
+0001ea80: 203d 207b 7d0a 2020 2020 2020 2020 7265   = {}.        re
+0001ea90: 736f 7572 6365 7320 3d20 7b7d 0a20 2020  sources = {}.   
+0001eaa0: 2020 2020 2061 6c69 6173 6573 203d 207b       aliases = {
+0001eab0: 7d0a 0a20 2020 2020 2020 2073 656c 662e  }..        self.
+0001eac0: 5f77 6f72 6b65 725f 636f 6c6c 6563 7469  _worker_collecti
+0001ead0: 6f6e 7320 3d20 5b0a 2020 2020 2020 2020  ons = [.        
+0001eae0: 2020 2020 776f 726b 6572 732c 0a20 2020      workers,.   
+0001eaf0: 2020 2020 2020 2020 2068 6f73 745f 696e           host_in
+0001eb00: 666f 2c0a 2020 2020 2020 2020 2020 2020  fo,.            
+0001eb10: 7265 736f 7572 6365 732c 0a20 2020 2020  resources,.     
+0001eb20: 2020 2020 2020 2061 6c69 6173 6573 2c0a         aliases,.
+0001eb30: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
+0001eb40: 2020 2073 656c 662e 6576 656e 7473 203d     self.events =
+0001eb50: 2064 6566 6175 6c74 6469 6374 280a 2020   defaultdict(.  
+0001eb60: 2020 2020 2020 2020 2020 7061 7274 6961            partia
+0001eb70: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
+0001eb80: 2020 2064 6571 7565 2c20 6d61 786c 656e     deque, maxlen
+0001eb90: 3d64 6173 6b2e 636f 6e66 6967 2e67 6574  =dask.config.get
+0001eba0: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
+0001ebb0: 6865 6475 6c65 722e 6576 656e 7473 2d6c  heduler.events-l
+0001ebc0: 6f67 2d6c 656e 6774 6822 290a 2020 2020  og-length").    
+0001ebd0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001ebe0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0001ebf0: 2e65 7665 6e74 5f63 6f75 6e74 7320 3d20  .event_counts = 
+0001ec00: 6465 6661 756c 7464 6963 7428 696e 7429  defaultdict(int)
+0001ec10: 0a20 2020 2020 2020 2073 656c 662e 6576  .        self.ev
+0001ec20: 656e 745f 7375 6273 6372 6962 6572 203d  ent_subscriber =
+0001ec30: 2064 6566 6175 6c74 6469 6374 2873 6574   defaultdict(set
+0001ec40: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+0001ec50: 6f72 6b65 725f 706c 7567 696e 7320 3d20  orker_plugins = 
+0001ec60: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0001ec70: 6e61 6e6e 795f 706c 7567 696e 7320 3d20  nanny_plugins = 
+0001ec80: 7b7d 0a0a 2020 2020 2020 2020 776f 726b  {}..        work
+0001ec90: 6572 5f68 616e 646c 6572 7320 3d20 7b0a  er_handlers = {.
+0001eca0: 2020 2020 2020 2020 2020 2020 2274 6173              "tas
+0001ecb0: 6b2d 6669 6e69 7368 6564 223a 2073 656c  k-finished": sel
+0001ecc0: 662e 6861 6e64 6c65 5f74 6173 6b5f 6669  f.handle_task_fi
+0001ecd0: 6e69 7368 6564 2c0a 2020 2020 2020 2020  nished,.        
+0001ece0: 2020 2020 2274 6173 6b2d 6572 7265 6422      "task-erred"
+0001ecf0: 3a20 7365 6c66 2e68 616e 646c 655f 7461  : self.handle_ta
+0001ed00: 736b 5f65 7272 6564 2c0a 2020 2020 2020  sk_erred,.      
+0001ed10: 2020 2020 2020 2272 656c 6561 7365 2d77        "release-w
+0001ed20: 6f72 6b65 722d 6461 7461 223a 2073 656c  orker-data": sel
+0001ed30: 662e 7265 6c65 6173 655f 776f 726b 6572  f.release_worker
+0001ed40: 5f64 6174 612c 0a20 2020 2020 2020 2020  _data,.         
+0001ed50: 2020 2022 6164 642d 6b65 7973 223a 2073     "add-keys": s
+0001ed60: 656c 662e 6164 645f 6b65 7973 2c0a 2020  elf.add_keys,.  
+0001ed70: 2020 2020 2020 2020 2020 226c 6f6e 672d            "long-
+0001ed80: 7275 6e6e 696e 6722 3a20 7365 6c66 2e68  running": self.h
+0001ed90: 616e 646c 655f 6c6f 6e67 5f72 756e 6e69  andle_long_runni
+0001eda0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
+0001edb0: 2272 6573 6368 6564 756c 6522 3a20 7365  "reschedule": se
+0001edc0: 6c66 2e5f 7265 7363 6865 6475 6c65 2c0a  lf._reschedule,.
+0001edd0: 2020 2020 2020 2020 2020 2020 226b 6565              "kee
+0001ede0: 702d 616c 6976 6522 3a20 6c61 6d62 6461  p-alive": lambda
+0001edf0: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+0001ee00: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0001ee10: 2020 2020 226c 6f67 2d65 7665 6e74 223a      "log-event":
+0001ee20: 2073 656c 662e 6c6f 675f 776f 726b 6572   self.log_worker
+0001ee30: 5f65 7665 6e74 2c0a 2020 2020 2020 2020  _event,.        
+0001ee40: 2020 2020 2277 6f72 6b65 722d 7374 6174      "worker-stat
+0001ee50: 7573 2d63 6861 6e67 6522 3a20 7365 6c66  us-change": self
+0001ee60: 2e68 616e 646c 655f 776f 726b 6572 5f73  .handle_worker_s
+0001ee70: 7461 7475 735f 6368 616e 6765 2c0a 2020  tatus_change,.  
+0001ee80: 2020 2020 2020 2020 2020 2272 6571 7565            "reque
+0001ee90: 7374 2d72 6566 7265 7368 2d77 686f 2d68  st-refresh-who-h
+0001eea0: 6173 223a 2073 656c 662e 6861 6e64 6c65  as": self.handle
+0001eeb0: 5f72 6571 7565 7374 5f72 6566 7265 7368  _request_refresh
+0001eec0: 5f77 686f 5f68 6173 2c0a 2020 2020 2020  _who_has,.      
+0001eed0: 2020 7d0a 0a20 2020 2020 2020 2063 6c69    }..        cli
+0001eee0: 656e 745f 6861 6e64 6c65 7273 203d 207b  ent_handlers = {
+0001eef0: 0a20 2020 2020 2020 2020 2020 2022 7570  .            "up
+0001ef00: 6461 7465 2d67 7261 7068 223a 2073 656c  date-graph": sel
+0001ef10: 662e 7570 6461 7465 5f67 7261 7068 2c0a  f.update_graph,.
+0001ef20: 2020 2020 2020 2020 2020 2020 2263 6c69              "cli
+0001ef30: 656e 742d 6465 7369 7265 732d 6b65 7973  ent-desires-keys
+0001ef40: 223a 2073 656c 662e 636c 6965 6e74 5f64  ": self.client_d
+0001ef50: 6573 6972 6573 5f6b 6579 732c 0a20 2020  esires_keys,.   
+0001ef60: 2020 2020 2020 2020 2022 7570 6461 7465           "update
+0001ef70: 2d64 6174 6122 3a20 7365 6c66 2e75 7064  -data": self.upd
+0001ef80: 6174 655f 6461 7461 2c0a 2020 2020 2020  ate_data,.      
+0001ef90: 2020 2020 2020 2272 6570 6f72 742d 6b65        "report-ke
+0001efa0: 7922 3a20 7365 6c66 2e72 6570 6f72 745f  y": self.report_
+0001efb0: 6f6e 5f6b 6579 2c0a 2020 2020 2020 2020  on_key,.        
+0001efc0: 2020 2020 2263 6c69 656e 742d 7265 6c65      "client-rele
+0001efd0: 6173 6573 2d6b 6579 7322 3a20 7365 6c66  ases-keys": self
+0001efe0: 2e63 6c69 656e 745f 7265 6c65 6173 6573  .client_releases
+0001eff0: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
+0001f000: 2020 2022 6865 6172 7462 6561 742d 636c     "heartbeat-cl
+0001f010: 6965 6e74 223a 2073 656c 662e 636c 6965  ient": self.clie
+0001f020: 6e74 5f68 6561 7274 6265 6174 2c0a 2020  nt_heartbeat,.  
+0001f030: 2020 2020 2020 2020 2020 2263 6c6f 7365            "close
+0001f040: 2d63 6c69 656e 7422 3a20 7365 6c66 2e72  -client": self.r
+0001f050: 656d 6f76 655f 636c 6965 6e74 2c0a 2020  emove_client,.  
+0001f060: 2020 2020 2020 2020 2020 2273 7562 7363            "subsc
+0001f070: 7269 6265 2d74 6f70 6963 223a 2073 656c  ribe-topic": sel
+0001f080: 662e 7375 6273 6372 6962 655f 746f 7069  f.subscribe_topi
+0001f090: 632c 0a20 2020 2020 2020 2020 2020 2022  c,.            "
+0001f0a0: 756e 7375 6273 6372 6962 652d 746f 7069  unsubscribe-topi
+0001f0b0: 6322 3a20 7365 6c66 2e75 6e73 7562 7363  c": self.unsubsc
+0001f0c0: 7269 6265 5f74 6f70 6963 2c0a 2020 2020  ribe_topic,.    
+0001f0d0: 2020 2020 2020 2020 2263 616e 6365 6c2d          "cancel-
+0001f0e0: 6b65 7973 223a 2073 656c 662e 7374 696d  keys": self.stim
+0001f0f0: 756c 7573 5f63 616e 6365 6c2c 0a20 2020  ulus_cancel,.   
+0001f100: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0001f110: 7365 6c66 2e68 616e 646c 6572 7320 3d20  self.handlers = 
+0001f120: 7b0a 2020 2020 2020 2020 2020 2020 2272  {.            "r
+0001f130: 6567 6973 7465 722d 636c 6965 6e74 223a  egister-client":
+0001f140: 2073 656c 662e 6164 645f 636c 6965 6e74   self.add_client
+0001f150: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0001f160: 6361 7474 6572 223a 2073 656c 662e 7363  catter": self.sc
+0001f170: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
+0001f180: 2020 2022 7265 6769 7374 6572 2d77 6f72     "register-wor
+0001f190: 6b65 7222 3a20 7365 6c66 2e61 6464 5f77  ker": self.add_w
+0001f1a0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
+0001f1b0: 2020 2022 7265 6769 7374 6572 5f6e 616e     "register_nan
+0001f1c0: 6e79 223a 2073 656c 662e 6164 645f 6e61  ny": self.add_na
+0001f1d0: 6e6e 792c 0a20 2020 2020 2020 2020 2020  nny,.           
+0001f1e0: 2022 756e 7265 6769 7374 6572 223a 2073   "unregister": s
+0001f1f0: 656c 662e 7265 6d6f 7665 5f77 6f72 6b65  elf.remove_worke
+0001f200: 722c 0a20 2020 2020 2020 2020 2020 2022  r,.            "
+0001f210: 6761 7468 6572 223a 2073 656c 662e 6761  gather": self.ga
+0001f220: 7468 6572 2c0a 2020 2020 2020 2020 2020  ther,.          
+0001f230: 2020 2272 6574 7279 223a 2073 656c 662e    "retry": self.
+0001f240: 7374 696d 756c 7573 5f72 6574 7279 2c0a  stimulus_retry,.
+0001f250: 2020 2020 2020 2020 2020 2020 2266 6565              "fee
+0001f260: 6422 3a20 7365 6c66 2e66 6565 642c 0a20  d": self.feed,. 
+0001f270: 2020 2020 2020 2020 2020 2022 7465 726d             "term
+0001f280: 696e 6174 6522 3a20 7365 6c66 2e63 6c6f  inate": self.clo
+0001f290: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+0001f2a0: 2262 726f 6164 6361 7374 223a 2073 656c  "broadcast": sel
+0001f2b0: 662e 6272 6f61 6463 6173 742c 0a20 2020  f.broadcast,.   
+0001f2c0: 2020 2020 2020 2020 2022 7072 6f78 7922           "proxy"
+0001f2d0: 3a20 7365 6c66 2e70 726f 7879 2c0a 2020  : self.proxy,.  
+0001f2e0: 2020 2020 2020 2020 2020 226e 636f 7265            "ncore
+0001f2f0: 7322 3a20 7365 6c66 2e67 6574 5f6e 636f  s": self.get_nco
+0001f300: 7265 732c 0a20 2020 2020 2020 2020 2020  res,.           
+0001f310: 2022 6e63 6f72 6573 5f72 756e 6e69 6e67   "ncores_running
+0001f320: 223a 2073 656c 662e 6765 745f 6e63 6f72  ": self.get_ncor
+0001f330: 6573 5f72 756e 6e69 6e67 2c0a 2020 2020  es_running,.    
+0001f340: 2020 2020 2020 2020 2268 6173 5f77 6861          "has_wha
+0001f350: 7422 3a20 7365 6c66 2e67 6574 5f68 6173  t": self.get_has
+0001f360: 5f77 6861 742c 0a20 2020 2020 2020 2020  _what,.         
+0001f370: 2020 2022 7768 6f5f 6861 7322 3a20 7365     "who_has": se
+0001f380: 6c66 2e67 6574 5f77 686f 5f68 6173 2c0a  lf.get_who_has,.
+0001f390: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
+0001f3a0: 6365 7373 696e 6722 3a20 7365 6c66 2e67  cessing": self.g
+0001f3b0: 6574 5f70 726f 6365 7373 696e 672c 0a20  et_processing,. 
+0001f3c0: 2020 2020 2020 2020 2020 2022 6361 6c6c             "call
+0001f3d0: 5f73 7461 636b 223a 2073 656c 662e 6765  _stack": self.ge
+0001f3e0: 745f 6361 6c6c 5f73 7461 636b 2c0a 2020  t_call_stack,.  
+0001f3f0: 2020 2020 2020 2020 2020 2270 726f 6669            "profi
+0001f400: 6c65 223a 2073 656c 662e 6765 745f 7072  le": self.get_pr
+0001f410: 6f66 696c 652c 0a20 2020 2020 2020 2020  ofile,.         
+0001f420: 2020 2022 7065 7266 6f72 6d61 6e63 655f     "performance_
+0001f430: 7265 706f 7274 223a 2073 656c 662e 7065  report": self.pe
+0001f440: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
+0001f450: 2c0a 2020 2020 2020 2020 2020 2020 2267  ,.            "g
+0001f460: 6574 5f6c 6f67 7322 3a20 7365 6c66 2e67  et_logs": self.g
+0001f470: 6574 5f6c 6f67 732c 0a20 2020 2020 2020  et_logs,.       
+0001f480: 2020 2020 2022 6c6f 6773 223a 2073 656c       "logs": sel
+0001f490: 662e 6765 745f 6c6f 6773 2c0a 2020 2020  f.get_logs,.    
+0001f4a0: 2020 2020 2020 2020 2277 6f72 6b65 725f          "worker_
+0001f4b0: 6c6f 6773 223a 2073 656c 662e 6765 745f  logs": self.get_
+0001f4c0: 776f 726b 6572 5f6c 6f67 732c 0a20 2020  worker_logs,.   
+0001f4d0: 2020 2020 2020 2020 2022 6c6f 675f 6576           "log_ev
+0001f4e0: 656e 7422 3a20 7365 6c66 2e6c 6f67 5f65  ent": self.log_e
+0001f4f0: 7665 6e74 2c0a 2020 2020 2020 2020 2020  vent,.          
+0001f500: 2020 2265 7665 6e74 7322 3a20 7365 6c66    "events": self
+0001f510: 2e67 6574 5f65 7665 6e74 732c 0a20 2020  .get_events,.   
+0001f520: 2020 2020 2020 2020 2022 6e62 7974 6573           "nbytes
+0001f530: 223a 2073 656c 662e 6765 745f 6e62 7974  ": self.get_nbyt
+0001f540: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0001f550: 2276 6572 7369 6f6e 7322 3a20 7365 6c66  "versions": self
+0001f560: 2e76 6572 7369 6f6e 732c 0a20 2020 2020  .versions,.     
+0001f570: 2020 2020 2020 2022 6164 645f 6b65 7973         "add_keys
+0001f580: 223a 2073 656c 662e 6164 645f 6b65 7973  ": self.add_keys
+0001f590: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+0001f5a0: 6562 616c 616e 6365 223a 2073 656c 662e  ebalance": self.
+0001f5b0: 7265 6261 6c61 6e63 652c 0a20 2020 2020  rebalance,.     
+0001f5c0: 2020 2020 2020 2022 7265 706c 6963 6174         "replicat
+0001f5d0: 6522 3a20 7365 6c66 2e72 6570 6c69 6361  e": self.replica
+0001f5e0: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
+0001f5f0: 2272 756e 5f66 756e 6374 696f 6e22 3a20  "run_function": 
+0001f600: 7365 6c66 2e72 756e 5f66 756e 6374 696f  self.run_functio
+0001f610: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
+0001f620: 7265 7374 6172 7422 3a20 7365 6c66 2e72  restart": self.r
+0001f630: 6573 7461 7274 2c0a 2020 2020 2020 2020  estart,.        
+0001f640: 2020 2020 2275 7064 6174 655f 6461 7461      "update_data
+0001f650: 223a 2073 656c 662e 7570 6461 7465 5f64  ": self.update_d
+0001f660: 6174 612c 0a20 2020 2020 2020 2020 2020  ata,.           
+0001f670: 2022 7365 745f 7265 736f 7572 6365 7322   "set_resources"
+0001f680: 3a20 7365 6c66 2e61 6464 5f72 6573 6f75  : self.add_resou
+0001f690: 7263 6573 2c0a 2020 2020 2020 2020 2020  rces,.          
+0001f6a0: 2020 2272 6574 6972 655f 776f 726b 6572    "retire_worker
+0001f6b0: 7322 3a20 7365 6c66 2e72 6574 6972 655f  s": self.retire_
+0001f6c0: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
+0001f6d0: 2020 2020 2022 6765 745f 6d65 7461 6461       "get_metada
+0001f6e0: 7461 223a 2073 656c 662e 6765 745f 6d65  ta": self.get_me
+0001f6f0: 7461 6461 7461 2c0a 2020 2020 2020 2020  tadata,.        
+0001f700: 2020 2020 2273 6574 5f6d 6574 6164 6174      "set_metadat
+0001f710: 6122 3a20 7365 6c66 2e73 6574 5f6d 6574  a": self.set_met
+0001f720: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
+0001f730: 2020 2022 7365 745f 7265 7374 7269 6374     "set_restrict
+0001f740: 696f 6e73 223a 2073 656c 662e 7365 745f  ions": self.set_
+0001f750: 7265 7374 7269 6374 696f 6e73 2c0a 2020  restrictions,.  
+0001f760: 2020 2020 2020 2020 2020 2268 6561 7274            "heart
+0001f770: 6265 6174 5f77 6f72 6b65 7222 3a20 7365  beat_worker": se
+0001f780: 6c66 2e68 6561 7274 6265 6174 5f77 6f72  lf.heartbeat_wor
+0001f790: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+0001f7a0: 2022 6765 745f 7461 736b 5f73 7461 7475   "get_task_statu
+0001f7b0: 7322 3a20 7365 6c66 2e67 6574 5f74 6173  s": self.get_tas
+0001f7c0: 6b5f 7374 6174 7573 2c0a 2020 2020 2020  k_status,.      
+0001f7d0: 2020 2020 2020 2267 6574 5f74 6173 6b5f        "get_task_
+0001f7e0: 7374 7265 616d 223a 2073 656c 662e 6765  stream": self.ge
+0001f7f0: 745f 7461 736b 5f73 7472 6561 6d2c 0a20  t_task_stream,. 
+0001f800: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
+0001f810: 7461 736b 5f70 7265 6669 785f 7374 6174  task_prefix_stat
+0001f820: 6573 223a 2073 656c 662e 6765 745f 7461  es": self.get_ta
+0001f830: 736b 5f70 7265 6669 785f 7374 6174 6573  sk_prefix_states
+0001f840: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+0001f850: 6567 6973 7465 725f 7363 6865 6475 6c65  egister_schedule
+0001f860: 725f 706c 7567 696e 223a 2073 656c 662e  r_plugin": self.
+0001f870: 7265 6769 7374 6572 5f73 6368 6564 756c  register_schedul
+0001f880: 6572 5f70 6c75 6769 6e2c 0a20 2020 2020  er_plugin,.     
+0001f890: 2020 2020 2020 2022 7265 6769 7374 6572         "register
+0001f8a0: 5f77 6f72 6b65 725f 706c 7567 696e 223a  _worker_plugin":
+0001f8b0: 2073 656c 662e 7265 6769 7374 6572 5f77   self.register_w
+0001f8c0: 6f72 6b65 725f 706c 7567 696e 2c0a 2020  orker_plugin,.  
+0001f8d0: 2020 2020 2020 2020 2020 2275 6e72 6567            "unreg
+0001f8e0: 6973 7465 725f 776f 726b 6572 5f70 6c75  ister_worker_plu
+0001f8f0: 6769 6e22 3a20 7365 6c66 2e75 6e72 6567  gin": self.unreg
+0001f900: 6973 7465 725f 776f 726b 6572 5f70 6c75  ister_worker_plu
+0001f910: 6769 6e2c 0a20 2020 2020 2020 2020 2020  gin,.           
+0001f920: 2022 7265 6769 7374 6572 5f6e 616e 6e79   "register_nanny
+0001f930: 5f70 6c75 6769 6e22 3a20 7365 6c66 2e72  _plugin": self.r
+0001f940: 6567 6973 7465 725f 6e61 6e6e 795f 706c  egister_nanny_pl
+0001f950: 7567 696e 2c0a 2020 2020 2020 2020 2020  ugin,.          
+0001f960: 2020 2275 6e72 6567 6973 7465 725f 6e61    "unregister_na
+0001f970: 6e6e 795f 706c 7567 696e 223a 2073 656c  nny_plugin": sel
+0001f980: 662e 756e 7265 6769 7374 6572 5f6e 616e  f.unregister_nan
+0001f990: 6e79 5f70 6c75 6769 6e2c 0a20 2020 2020  ny_plugin,.     
+0001f9a0: 2020 2020 2020 2022 6164 6170 7469 7665         "adaptive
+0001f9b0: 5f74 6172 6765 7422 3a20 7365 6c66 2e61  _target": self.a
+0001f9c0: 6461 7074 6976 655f 7461 7267 6574 2c0a  daptive_target,.
+0001f9d0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
+0001f9e0: 6b65 7273 5f74 6f5f 636c 6f73 6522 3a20  kers_to_close": 
+0001f9f0: 7365 6c66 2e77 6f72 6b65 7273 5f74 6f5f  self.workers_to_
+0001fa00: 636c 6f73 652c 0a20 2020 2020 2020 2020  close,.         
+0001fa10: 2020 2022 7375 6273 6372 6962 655f 776f     "subscribe_wo
+0001fa20: 726b 6572 5f73 7461 7475 7322 3a20 7365  rker_status": se
+0001fa30: 6c66 2e73 7562 7363 7269 6265 5f77 6f72  lf.subscribe_wor
+0001fa40: 6b65 725f 7374 6174 7573 2c0a 2020 2020  ker_status,.    
+0001fa50: 2020 2020 2020 2020 2273 7461 7274 5f74          "start_t
+0001fa60: 6173 6b5f 6d65 7461 6461 7461 223a 2073  ask_metadata": s
+0001fa70: 656c 662e 7374 6172 745f 7461 736b 5f6d  elf.start_task_m
+0001fa80: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
+0001fa90: 2020 2020 2022 7374 6f70 5f74 6173 6b5f       "stop_task_
+0001faa0: 6d65 7461 6461 7461 223a 2073 656c 662e  metadata": self.
+0001fab0: 7374 6f70 5f74 6173 6b5f 6d65 7461 6461  stop_task_metada
+0001fac0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+0001fad0: 2267 6574 5f63 6c75 7374 6572 5f73 7461  "get_cluster_sta
+0001fae0: 7465 223a 2073 656c 662e 6765 745f 636c  te": self.get_cl
+0001faf0: 7573 7465 725f 7374 6174 652c 0a20 2020  uster_state,.   
+0001fb00: 2020 2020 2020 2020 2022 6475 6d70 5f63           "dump_c
+0001fb10: 6c75 7374 6572 5f73 7461 7465 5f74 6f5f  luster_state_to_
+0001fb20: 7572 6c22 3a20 7365 6c66 2e64 756d 705f  url": self.dump_
+0001fb30: 636c 7573 7465 725f 7374 6174 655f 746f  cluster_state_to
+0001fb40: 5f75 726c 2c0a 2020 2020 2020 2020 2020  _url,.          
+0001fb50: 2020 2262 656e 6368 6d61 726b 5f68 6172    "benchmark_har
+0001fb60: 6477 6172 6522 3a20 7365 6c66 2e62 656e  dware": self.ben
+0001fb70: 6368 6d61 726b 5f68 6172 6477 6172 652c  chmark_hardware,
+0001fb80: 0a20 2020 2020 2020 2020 2020 2022 6765  .            "ge
+0001fb90: 745f 7374 6f72 7922 3a20 7365 6c66 2e67  t_story": self.g
+0001fba0: 6574 5f73 746f 7279 2c0a 2020 2020 2020  et_story,.      
+0001fbb0: 2020 2020 2020 2263 6865 636b 5f69 646c        "check_idl
+0001fbc0: 6522 3a20 7365 6c66 2e63 6865 636b 5f69  e": self.check_i
+0001fbd0: 646c 652c 0a20 2020 2020 2020 207d 0a0a  dle,.        }..
+0001fbe0: 2020 2020 2020 2020 636f 6e6e 6563 7469          connecti
+0001fbf0: 6f6e 5f6c 696d 6974 203d 2067 6574 5f66  on_limit = get_f
+0001fc00: 696c 656e 6f5f 6c69 6d69 7428 2920 2f20  ileno_limit() / 
+0001fc10: 320a 0a20 2020 2020 2020 2053 6368 6564  2..        Sched
+0001fc20: 756c 6572 5374 6174 652e 5f5f 696e 6974  ulerState.__init
+0001fc30: 5f5f 280a 2020 2020 2020 2020 2020 2020  __(.            
+0001fc40: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+0001fc50: 2020 616c 6961 7365 733d 616c 6961 7365    aliases=aliase
+0001fc60: 732c 0a20 2020 2020 2020 2020 2020 2063  s,.            c
+0001fc70: 6c69 656e 7473 3d63 6c69 656e 7473 2c0a  lients=clients,.
+0001fc80: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0001fc90: 6572 733d 776f 726b 6572 732c 0a20 2020  ers=workers,.   
+0001fca0: 2020 2020 2020 2020 2068 6f73 745f 696e           host_in
+0001fcb0: 666f 3d68 6f73 745f 696e 666f 2c0a 2020  fo=host_info,.  
+0001fcc0: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+0001fcd0: 6365 733d 7265 736f 7572 6365 732c 0a20  ces=resources,. 
+0001fce0: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
+0001fcf0: 3d74 6173 6b73 2c0a 2020 2020 2020 2020  =tasks,.        
+0001fd00: 2020 2020 756e 7275 6e6e 6162 6c65 3d75      unrunnable=u
+0001fd10: 6e72 756e 6e61 626c 652c 0a20 2020 2020  nrunnable,.     
+0001fd20: 2020 2020 2020 2071 7565 7565 643d 7175         queued=qu
+0001fd30: 6575 6564 2c0a 2020 2020 2020 2020 2020  eued,.          
+0001fd40: 2020 7661 6c69 6461 7465 3d76 616c 6964    validate=valid
+0001fd50: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
+0001fd60: 2070 6c75 6769 6e73 3d70 6c75 6769 6e73   plugins=plugins
+0001fd70: 2c0a 2020 2020 2020 2020 2020 2020 7472  ,.            tr
+0001fd80: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+0001fd90: 5f6d 6178 3d74 7261 6e73 6974 696f 6e5f  _max=transition_
+0001fda0: 636f 756e 7465 725f 6d61 782c 0a20 2020  counter_max,.   
+0001fdb0: 2020 2020 2029 0a20 2020 2020 2020 2053       ).        S
+0001fdc0: 6572 7665 724e 6f64 652e 5f5f 696e 6974  erverNode.__init
+0001fdd0: 5f5f 280a 2020 2020 2020 2020 2020 2020  __(.            
+0001fde0: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+0001fdf0: 2020 6861 6e64 6c65 7273 3d73 656c 662e    handlers=self.
+0001fe00: 6861 6e64 6c65 7273 2c0a 2020 2020 2020  handlers,.      
+0001fe10: 2020 2020 2020 7374 7265 616d 5f68 616e        stream_han
+0001fe20: 646c 6572 733d 6d65 7267 6528 776f 726b  dlers=merge(work
+0001fe30: 6572 5f68 616e 646c 6572 732c 2063 6c69  er_handlers, cli
+0001fe40: 656e 745f 6861 6e64 6c65 7273 292c 0a20  ent_handlers),. 
+0001fe50: 2020 2020 2020 2020 2020 2063 6f6e 6e65             conne
+0001fe60: 6374 696f 6e5f 6c69 6d69 743d 636f 6e6e  ction_limit=conn
+0001fe70: 6563 7469 6f6e 5f6c 696d 6974 2c0a 2020  ection_limit,.  
+0001fe80: 2020 2020 2020 2020 2020 6465 7365 7269            deseri
+0001fe90: 616c 697a 653d 4661 6c73 652c 0a20 2020  alize=False,.   
+0001fea0: 2020 2020 2020 2020 2063 6f6e 6e65 6374           connect
+0001feb0: 696f 6e5f 6172 6773 3d73 656c 662e 636f  ion_args=self.co
+0001fec0: 6e6e 6563 7469 6f6e 5f61 7267 732c 0a20  nnection_args,. 
+0001fed0: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
+0001fee0: 7267 732c 0a20 2020 2020 2020 2029 0a0a  rgs,.        )..
+0001fef0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001ff00: 776f 726b 6572 5f74 746c 3a0a 2020 2020  worker_ttl:.    
+0001ff10: 2020 2020 2020 2020 7063 203d 2050 6572          pc = Per
+0001ff20: 696f 6469 6343 616c 6c62 6163 6b28 7365  iodicCallback(se
+0001ff30: 6c66 2e63 6865 636b 5f77 6f72 6b65 725f  lf.check_worker_
+0001ff40: 7474 6c2c 2073 656c 662e 776f 726b 6572  ttl, self.worker
+0001ff50: 5f74 746c 202a 2031 3030 3029 0a20 2020  _ttl * 1000).   
+0001ff60: 2020 2020 2020 2020 2073 656c 662e 7065           self.pe
+0001ff70: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
+0001ff80: 5b22 776f 726b 6572 2d74 746c 225d 203d  ["worker-ttl"] =
+0001ff90: 2070 630a 0a20 2020 2020 2020 2070 6320   pc..        pc 
+0001ffa0: 3d20 5065 7269 6f64 6963 4361 6c6c 6261  = PeriodicCallba
+0001ffb0: 636b 2873 656c 662e 6368 6563 6b5f 6964  ck(self.check_id
+0001ffc0: 6c65 2c20 2873 656c 662e 6964 6c65 5f74  le, (self.idle_t
+0001ffd0: 696d 656f 7574 206f 7220 3129 202a 2031  imeout or 1) * 1
+0001ffe0: 3030 3020 2f20 3429 0a20 2020 2020 2020  000 / 4).       
+0001fff0: 2073 656c 662e 7065 7269 6f64 6963 5f63   self.periodic_c
+00020000: 616c 6c62 6163 6b73 5b22 6964 6c65 2d74  allbacks["idle-t
+00020010: 696d 656f 7574 225d 203d 2070 630a 0a20  imeout"] = pc.. 
+00020020: 2020 2020 2020 2069 6620 6578 7465 6e73         if extens
+00020030: 696f 6e73 2069 7320 4e6f 6e65 3a0a 2020  ions is None:.  
+00020040: 2020 2020 2020 2020 2020 6578 7465 6e73            extens
+00020050: 696f 6e73 203d 2044 4546 4155 4c54 5f45  ions = DEFAULT_E
+00020060: 5854 454e 5349 4f4e 532e 636f 7079 2829  XTENSIONS.copy()
+00020070: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00020080: 6e6f 7420 6461 736b 2e63 6f6e 6669 672e  not dask.config.
+00020090: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+000200a0: 2e73 6368 6564 756c 6572 2e77 6f72 6b2d  .scheduler.work-
+000200b0: 7374 6561 6c69 6e67 2229 3a0a 2020 2020  stealing"):.    
+000200c0: 2020 2020 2020 2020 2020 2020 6966 2022              if "
+000200d0: 7374 6561 6c69 6e67 2220 696e 2065 7874  stealing" in ext
+000200e0: 656e 7369 6f6e 733a 0a20 2020 2020 2020  ensions:.       
+000200f0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+00020100: 2065 7874 656e 7369 6f6e 735b 2273 7465   extensions["ste
+00020110: 616c 696e 6722 5d0a 0a20 2020 2020 2020  aling"]..       
+00020120: 2066 6f72 206e 616d 652c 2065 7874 656e   for name, exten
+00020130: 7369 6f6e 2069 6e20 6578 7465 6e73 696f  sion in extensio
+00020140: 6e73 2e69 7465 6d73 2829 3a0a 2020 2020  ns.items():.    
+00020150: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
+00020160: 656e 7369 6f6e 735b 6e61 6d65 5d20 3d20  ensions[name] = 
+00020170: 6578 7465 6e73 696f 6e28 7365 6c66 290a  extension(self).
+00020180: 0a20 2020 2020 2020 2073 6574 7072 6f63  .        setproc
+00020190: 7469 746c 6528 2264 6173 6b20 7363 6865  title("dask sche
+000201a0: 6475 6c65 7220 5b6e 6f74 2073 7461 7274  duler [not start
+000201b0: 6564 5d22 290a 2020 2020 2020 2020 5363  ed]").        Sc
+000201c0: 6865 6475 6c65 722e 5f69 6e73 7461 6e63  heduler._instanc
+000201d0: 6573 2e61 6464 2873 656c 6629 0a20 2020  es.add(self).   
+000201e0: 2020 2020 2073 656c 662e 7270 632e 616c       self.rpc.al
+000201f0: 6c6f 775f 6f66 666c 6f61 6420 3d20 4661  low_offload = Fa
+00020200: 6c73 650a 0a20 2020 2023 2323 2323 2323  lse..    #######
+00020210: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+00020220: 2320 4164 6d69 6e69 7374 7261 7469 6f6e  # Administration
+00020230: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
+00020240: 2323 2323 2323 2323 230a 0a20 2020 2064  #########..    d
+00020250: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
+00020260: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00020270: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+00020280: 6622 3c53 6368 6564 756c 6572 207b 7365  f"<Scheduler {se
+00020290: 6c66 2e61 6464 7265 7373 5f73 6166 6521  lf.address_safe!
+000202a0: 727d 2c20 220a 2020 2020 2020 2020 2020  r}, ".          
+000202b0: 2020 6622 776f 726b 6572 733a 207b 6c65    f"workers: {le
+000202c0: 6e28 7365 6c66 2e77 6f72 6b65 7273 297d  n(self.workers)}
+000202d0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+000202e0: 6622 636f 7265 733a 207b 7365 6c66 2e74  f"cores: {self.t
+000202f0: 6f74 616c 5f6e 7468 7265 6164 737d 2c20  otal_nthreads}, 
+00020300: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00020310: 7461 736b 733a 207b 6c65 6e28 7365 6c66  tasks: {len(self
+00020320: 2e74 6173 6b73 297d 3e22 0a20 2020 2020  .tasks)}>".     
+00020330: 2020 2029 0a0a 2020 2020 6465 6620 5f72     )..    def _r
+00020340: 6570 725f 6874 6d6c 5f28 7365 6c66 293a  epr_html_(self):
+00020350: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00020360: 6765 745f 7465 6d70 6c61 7465 2822 7363  get_template("sc
+00020370: 6865 6475 6c65 722e 6874 6d6c 2e6a 3222  heduler.html.j2"
+00020380: 292e 7265 6e64 6572 280a 2020 2020 2020  ).render(.      
+00020390: 2020 2020 2020 6164 6472 6573 733d 7365        address=se
+000203a0: 6c66 2e61 6464 7265 7373 2c0a 2020 2020  lf.address,.    
+000203b0: 2020 2020 2020 2020 776f 726b 6572 733d          workers=
+000203c0: 7365 6c66 2e77 6f72 6b65 7273 2c0a 2020  self.workers,.  
+000203d0: 2020 2020 2020 2020 2020 7468 7265 6164            thread
+000203e0: 733d 7365 6c66 2e74 6f74 616c 5f6e 7468  s=self.total_nth
+000203f0: 7265 6164 732c 0a20 2020 2020 2020 2020  reads,.         
+00020400: 2020 2074 6173 6b73 3d73 656c 662e 7461     tasks=self.ta
+00020410: 736b 732c 0a20 2020 2020 2020 2029 0a0a  sks,.        )..
+00020420: 2020 2020 6465 6620 6964 656e 7469 7479      def identity
+00020430: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00020440: 2222 2242 6173 6963 2069 6e66 6f72 6d61  """Basic informa
+00020450: 7469 6f6e 2061 626f 7574 206f 7572 7365  tion about ourse
+00020460: 6c76 6573 2061 6e64 206f 7572 2063 6c75  lves and our clu
+00020470: 7374 6572 2222 220a 2020 2020 2020 2020  ster""".        
+00020480: 6420 3d20 7b0a 2020 2020 2020 2020 2020  d = {.          
+00020490: 2020 2274 7970 6522 3a20 7479 7065 2873    "type": type(s
+000204a0: 656c 6629 2e5f 5f6e 616d 655f 5f2c 0a20  elf).__name__,. 
+000204b0: 2020 2020 2020 2020 2020 2022 6964 223a             "id":
+000204c0: 2073 7472 2873 656c 662e 6964 292c 0a20   str(self.id),. 
+000204d0: 2020 2020 2020 2020 2020 2022 6164 6472             "addr
+000204e0: 6573 7322 3a20 7365 6c66 2e61 6464 7265  ess": self.addre
+000204f0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+00020500: 2273 6572 7669 6365 7322 3a20 7b6b 6579  "services": {key
+00020510: 3a20 762e 706f 7274 2066 6f72 2028 6b65  : v.port for (ke
+00020520: 792c 2076 2920 696e 2073 656c 662e 7365  y, v) in self.se
+00020530: 7276 6963 6573 2e69 7465 6d73 2829 7d2c  rvices.items()},
+00020540: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+00020550: 6172 7465 6422 3a20 7365 6c66 2e74 696d  arted": self.tim
+00020560: 655f 7374 6172 7465 642c 0a20 2020 2020  e_started,.     
+00020570: 2020 2020 2020 2022 776f 726b 6572 7322         "workers"
+00020580: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00020590: 2020 2020 776f 726b 6572 2e61 6464 7265      worker.addre
+000205a0: 7373 3a20 776f 726b 6572 2e69 6465 6e74  ss: worker.ident
+000205b0: 6974 7928 2920 666f 7220 776f 726b 6572  ity() for worker
+000205c0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+000205d0: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
+000205e0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000205f0: 207d 0a20 2020 2020 2020 2072 6574 7572   }.        retur
+00020600: 6e20 640a 0a20 2020 2064 6566 205f 746f  n d..    def _to
+00020610: 5f64 6963 7428 7365 6c66 2c20 2a2c 2065  _dict(self, *, e
+00020620: 7863 6c75 6465 3a20 436f 6e74 6169 6e65  xclude: Containe
+00020630: 725b 7374 725d 203d 2028 2929 202d 3e20  r[str] = ()) -> 
+00020640: 6469 6374 3a0a 2020 2020 2020 2020 2222  dict:.        ""
+00020650: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
+00020660: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
+00020670: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
+00020680: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
+00020690: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
+000206a0: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
+000206b0: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
+000206c0: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
+000206d0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+000206e0: 2020 2020 2020 2053 6572 7665 722e 6964         Server.id
+000206f0: 656e 7469 7479 0a20 2020 2020 2020 2043  entity.        C
+00020700: 6c69 656e 742e 6475 6d70 5f63 6c75 7374  lient.dump_clust
+00020710: 6572 5f73 7461 7465 0a20 2020 2020 2020  er_state.       
+00020720: 2064 6973 7472 6962 7574 6564 2e75 7469   distributed.uti
+00020730: 6c73 2e72 6563 7572 7369 7665 5f74 6f5f  ls.recursive_to_
+00020740: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
+00020750: 0a20 2020 2020 2020 2069 6e66 6f20 3d20  .        info = 
+00020760: 7375 7065 7228 292e 5f74 6f5f 6469 6374  super()._to_dict
+00020770: 2865 7863 6c75 6465 3d65 7863 6c75 6465  (exclude=exclude
+00020780: 290a 2020 2020 2020 2020 6578 7472 6120  ).        extra 
+00020790: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+000207a0: 2274 7261 6e73 6974 696f 6e5f 6c6f 6722  "transition_log"
+000207b0: 3a20 7365 6c66 2e74 7261 6e73 6974 696f  : self.transitio
+000207c0: 6e5f 6c6f 672c 0a20 2020 2020 2020 2020  n_log,.         
+000207d0: 2020 2022 7472 616e 7369 7469 6f6e 5f63     "transition_c
+000207e0: 6f75 6e74 6572 223a 2073 656c 662e 7472  ounter": self.tr
+000207f0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00020800: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00020810: 6173 6b73 223a 2073 656c 662e 7461 736b  asks": self.task
+00020820: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+00020830: 7461 736b 5f67 726f 7570 7322 3a20 7365  task_groups": se
+00020840: 6c66 2e74 6173 6b5f 6772 6f75 7073 2c0a  lf.task_groups,.
+00020850: 2020 2020 2020 2020 2020 2020 2320 4f76              # Ov
+00020860: 6572 7772 6974 6520 6469 6374 206f 6620  erwrite dict of 
+00020870: 576f 726b 6572 5374 6174 652e 6964 656e  WorkerState.iden
+00020880: 7469 7479 2066 726f 6d20 696e 666f 0a20  tity from info. 
+00020890: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+000208a0: 6572 7322 3a20 7365 6c66 2e77 6f72 6b65  ers": self.worke
+000208b0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+000208c0: 2263 6c69 656e 7473 223a 2073 656c 662e  "clients": self.
+000208d0: 636c 6965 6e74 732c 0a20 2020 2020 2020  clients,.       
+000208e0: 2020 2020 2022 6d65 6d6f 7279 223a 2073       "memory": s
+000208f0: 656c 662e 6d65 6d6f 7279 2c0a 2020 2020  elf.memory,.    
+00020900: 2020 2020 2020 2020 2265 7665 6e74 7322          "events"
+00020910: 3a20 7365 6c66 2e65 7665 6e74 732c 0a20  : self.events,. 
+00020920: 2020 2020 2020 2020 2020 2022 6578 7465             "exte
+00020930: 6e73 696f 6e73 223a 2073 656c 662e 6578  nsions": self.ex
+00020940: 7465 6e73 696f 6e73 2c0a 2020 2020 2020  tensions,.      
+00020950: 2020 7d0a 2020 2020 2020 2020 6578 7472    }.        extr
+00020960: 6120 3d20 7b6b 3a20 7620 666f 7220 6b2c  a = {k: v for k,
+00020970: 2076 2069 6e20 6578 7472 612e 6974 656d   v in extra.item
+00020980: 7328 2920 6966 206b 206e 6f74 2069 6e20  s() if k not in 
+00020990: 6578 636c 7564 657d 0a20 2020 2020 2020  exclude}.       
+000209a0: 2069 6e66 6f2e 7570 6461 7465 2872 6563   info.update(rec
+000209b0: 7572 7369 7665 5f74 6f5f 6469 6374 2865  ursive_to_dict(e
+000209c0: 7874 7261 2c20 6578 636c 7564 653d 6578  xtra, exclude=ex
+000209d0: 636c 7564 6529 290a 2020 2020 2020 2020  clude)).        
+000209e0: 7265 7475 726e 2069 6e66 6f0a 0a20 2020  return info..   
+000209f0: 2061 7379 6e63 2064 6566 2067 6574 5f63   async def get_c
+00020a00: 6c75 7374 6572 5f73 7461 7465 280a 2020  luster_state(.  
+00020a10: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00020a20: 2020 2020 6578 636c 7564 653a 2022 436f      exclude: "Co
+00020a30: 6c6c 6563 7469 6f6e 5b73 7472 5d22 2c0a  llection[str]",.
+00020a40: 2020 2020 2920 2d3e 2064 6963 743a 0a20      ) -> dict:. 
+00020a50: 2020 2020 2020 2022 5072 6f64 7563 6520         "Produce 
+00020a60: 7468 6520 7374 6174 6520 6469 6374 2075  the state dict u
+00020a70: 7365 6420 696e 2061 2063 6c75 7374 6572  sed in a cluster
+00020a80: 2073 7461 7465 2064 756d 7022 0a20 2020   state dump".   
+00020a90: 2020 2020 2023 204b 6963 6b20 6f66 6620       # Kick off 
+00020aa0: 7374 6174 652d 6475 6d70 696e 6720 6f6e  state-dumping on
+00020ab0: 2077 6f72 6b65 7273 2062 6566 6f72 6520   workers before 
+00020ac0: 7765 2062 6c6f 636b 2074 6865 2065 7665  we block the eve
+00020ad0: 6e74 206c 6f6f 7020 696e 2060 7365 6c66  nt loop in `self
+00020ae0: 2e5f 746f 5f64 6963 7460 2e0a 2020 2020  ._to_dict`..    
+00020af0: 2020 2020 776f 726b 6572 735f 6675 7475      workers_futu
+00020b00: 7265 203d 2061 7379 6e63 696f 2e67 6174  re = asyncio.gat
+00020b10: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
+00020b20: 2073 656c 662e 6272 6f61 6463 6173 7428   self.broadcast(
+00020b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020b40: 206d 7367 3d7b 226f 7022 3a20 2264 756d   msg={"op": "dum
+00020b50: 705f 7374 6174 6522 2c20 2265 7863 6c75  p_state", "exclu
+00020b60: 6465 223a 2065 7863 6c75 6465 7d2c 0a20  de": exclude},. 
+00020b70: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00020b80: 6e5f 6572 726f 723d 2272 6574 7572 6e22  n_error="return"
+00020b90: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
+00020ba0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00020bb0: 662e 6272 6f61 6463 6173 7428 0a20 2020  f.broadcast(.   
+00020bc0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+00020bd0: 3d7b 226f 7022 3a20 2276 6572 7369 6f6e  ={"op": "version
+00020be0: 7322 7d2c 0a20 2020 2020 2020 2020 2020  s"},.           
+00020bf0: 2020 2020 206f 6e5f 6572 726f 723d 2269       on_error="i
+00020c00: 676e 6f72 6522 2c0a 2020 2020 2020 2020  gnore",.        
+00020c10: 2020 2020 292c 0a20 2020 2020 2020 2029      ),.        )
+00020c20: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00020c30: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
+00020c40: 6c65 725f 7374 6174 6520 3d20 7365 6c66  ler_state = self
+00020c50: 2e5f 746f 5f64 6963 7428 6578 636c 7564  ._to_dict(exclud
+00020c60: 653d 6578 636c 7564 6529 0a0a 2020 2020  e=exclude)..    
+00020c70: 2020 2020 2020 2020 776f 726b 6572 5f73          worker_s
+00020c80: 7461 7465 732c 2077 6f72 6b65 725f 7665  tates, worker_ve
+00020c90: 7273 696f 6e73 203d 2061 7761 6974 2077  rsions = await w
+00020ca0: 6f72 6b65 7273 5f66 7574 7572 650a 2020  orkers_future.  
+00020cb0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+00020cc0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+00020cd0: 7572 6520 7468 6520 7461 736b 7320 6172  ure the tasks ar
+00020ce0: 656e 2774 206c 6566 7420 7275 6e6e 696e  en't left runnin
+00020cf0: 6720 6966 2061 6e79 7468 696e 6720 6661  g if anything fa
+00020d00: 696c 732e 0a20 2020 2020 2020 2020 2020  ils..           
+00020d10: 2023 2053 6f6d 6564 6179 2028 7079 332e   # Someday (py3.
+00020d20: 3131 292c 2075 7365 2061 2074 7269 6f2d  11), use a trio-
+00020d30: 7374 796c 6520 5461 736b 4772 6f75 7020  style TaskGroup 
+00020d40: 666f 7220 7468 6973 2e0a 2020 2020 2020  for this..      
+00020d50: 2020 2020 2020 776f 726b 6572 735f 6675        workers_fu
+00020d60: 7475 7265 2e63 616e 6365 6c28 290a 0a20  ture.cancel().. 
+00020d70: 2020 2020 2020 2023 2043 6f6e 7665 7274         # Convert
+00020d80: 2061 6e79 2052 5043 2065 7272 6f72 7320   any RPC errors 
+00020d90: 746f 2073 7472 696e 6773 0a20 2020 2020  to strings.     
+00020da0: 2020 2077 6f72 6b65 725f 7374 6174 6573     worker_states
+00020db0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00020dc0: 206b 3a20 7265 7072 2876 2920 6966 2069   k: repr(v) if i
+00020dd0: 7369 6e73 7461 6e63 6528 762c 2045 7863  sinstance(v, Exc
+00020de0: 6570 7469 6f6e 2920 656c 7365 2076 0a20  eption) else v. 
+00020df0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00020e00: 2c20 7620 696e 2077 6f72 6b65 725f 7374  , v in worker_st
+00020e10: 6174 6573 2e69 7465 6d73 2829 0a20 2020  ates.items().   
+00020e20: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00020e30: 7265 7475 726e 207b 0a20 2020 2020 2020  return {.       
+00020e40: 2020 2020 2022 7363 6865 6475 6c65 7222       "scheduler"
+00020e50: 3a20 7363 6865 6475 6c65 725f 7374 6174  : scheduler_stat
+00020e60: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+00020e70: 776f 726b 6572 7322 3a20 776f 726b 6572  workers": worker
+00020e80: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00020e90: 2020 2020 2022 7665 7273 696f 6e73 223a       "versions":
+00020ea0: 207b 2273 6368 6564 756c 6572 223a 2073   {"scheduler": s
+00020eb0: 656c 662e 7665 7273 696f 6e73 2829 2c20  elf.versions(), 
+00020ec0: 2277 6f72 6b65 7273 223a 2077 6f72 6b65  "workers": worke
+00020ed0: 725f 7665 7273 696f 6e73 7d2c 0a20 2020  r_versions},.   
+00020ee0: 2020 2020 207d 0a0a 2020 2020 6173 796e       }..    asyn
+00020ef0: 6320 6465 6620 6475 6d70 5f63 6c75 7374  c def dump_clust
+00020f00: 6572 5f73 7461 7465 5f74 6f5f 7572 6c28  er_state_to_url(
+00020f10: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00020f20: 2020 2020 2020 2075 726c 3a20 7374 722c         url: str,
+00020f30: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
+00020f40: 3a20 2243 6f6c 6c65 6374 696f 6e5b 7374  : "Collection[st
+00020f50: 725d 222c 0a20 2020 2020 2020 2066 6f72  r]",.        for
+00020f60: 6d61 743a 204c 6974 6572 616c 5b22 6d73  mat: Literal["ms
+00020f70: 6770 6163 6b22 2c20 2279 616d 6c22 5d2c  gpack", "yaml"],
+00020f80: 0a20 2020 2020 2020 202a 2a73 746f 7261  .        **stora
+00020f90: 6765 5f6f 7074 696f 6e73 3a20 6469 6374  ge_options: dict
+00020fa0: 5b73 7472 2c20 416e 795d 2c0a 2020 2020  [str, Any],.    
+00020fb0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00020fc0: 2020 2022 5772 6974 6520 6120 636c 7573     "Write a clus
+00020fd0: 7465 7220 7374 6174 6520 6475 6d70 2074  ter state dump t
+00020fe0: 6f20 616e 2066 7373 7065 632d 636f 6d70  o an fsspec-comp
+00020ff0: 6174 6962 6c65 2055 524c 2e22 0a20 2020  atible URL.".   
+00021000: 2020 2020 2061 7761 6974 2063 6c75 7374       await clust
+00021010: 6572 5f64 756d 702e 7772 6974 655f 7374  er_dump.write_st
+00021020: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
+00021030: 2070 6172 7469 616c 2873 656c 662e 6765   partial(self.ge
+00021040: 745f 636c 7573 7465 725f 7374 6174 652c  t_cluster_state,
+00021050: 2065 7863 6c75 6465 292c 2075 726c 2c20   exclude), url, 
+00021060: 666f 726d 6174 2c20 2a2a 7374 6f72 6167  format, **storag
+00021070: 655f 6f70 7469 6f6e 730a 2020 2020 2020  e_options.      
+00021080: 2020 290a 0a20 2020 2064 6566 2067 6574    )..    def get
+00021090: 5f77 6f72 6b65 725f 7365 7276 6963 655f  _worker_service_
+000210a0: 6164 6472 280a 2020 2020 2020 2020 7365  addr(.        se
+000210b0: 6c66 2c20 776f 726b 6572 3a20 7374 722c  lf, worker: str,
+000210c0: 2073 6572 7669 6365 5f6e 616d 653a 2073   service_name: s
+000210d0: 7472 2c20 7072 6f74 6f63 6f6c 3a20 626f  tr, protocol: bo
+000210e0: 6f6c 203d 2046 616c 7365 0a20 2020 2029  ol = False.    )
+000210f0: 202d 3e20 7475 706c 655b 7374 722c 2069   -> tuple[str, i
+00021100: 6e74 5d20 7c20 7374 7220 7c20 4e6f 6e65  nt] | str | None
+00021110: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00021120: 2020 2020 2020 4765 7420 7468 6520 2868        Get the (h
+00021130: 6f73 742c 2070 6f72 7429 2061 6464 7265  ost, port) addre
+00021140: 7373 206f 6620 7468 6520 6e61 6d65 6420  ss of the named 
+00021150: 7365 7276 6963 6520 6f6e 2074 6865 202a  service on the *
+00021160: 776f 726b 6572 2a2e 0a20 2020 2020 2020  worker*..       
+00021170: 2052 6574 7572 6e73 204e 6f6e 6520 6966   Returns None if
+00021180: 2074 6865 2073 6572 7669 6365 2064 6f65   the service doe
+00021190: 736e 2774 2065 7869 7374 2e0a 0a20 2020  sn't exist...   
+000211a0: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
+000211b0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+000211c0: 2d2d 0a20 2020 2020 2020 2077 6f72 6b65  --.        worke
+000211d0: 7220 3a20 6164 6472 6573 730a 2020 2020  r : address.    
+000211e0: 2020 2020 7365 7276 6963 655f 6e61 6d65      service_name
+000211f0: 203a 2073 7472 0a20 2020 2020 2020 2020   : str.         
+00021200: 2020 2043 6f6d 6d6f 6e20 7365 7276 6963     Common servic
+00021210: 6573 2069 6e63 6c75 6465 2027 626f 6b65  es include 'boke
+00021220: 6827 2061 6e64 2027 6e61 6e6e 7927 0a20  h' and 'nanny'. 
+00021230: 2020 2020 2020 2070 726f 746f 636f 6c20         protocol 
+00021240: 3a20 626f 6f6c 6561 6e0a 2020 2020 2020  : boolean.      
+00021250: 2020 2020 2020 5768 6574 6865 7220 6f72        Whether or
+00021260: 206e 6f74 2074 6f20 696e 636c 7564 6520   not to include 
+00021270: 6120 6675 6c6c 2061 6464 7265 7373 2077  a full address w
+00021280: 6974 6820 7072 6f74 6f63 6f6c 2028 5472  ith protocol (Tr
+00021290: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+000212a0: 6f72 206a 7573 7420 6120 2868 6f73 742c  or just a (host,
+000212b0: 2070 6f72 7429 2070 6169 720a 2020 2020   port) pair.    
+000212c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000212d0: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
+000212e0: 735b 776f 726b 6572 5d0a 2020 2020 2020  s[worker].      
+000212f0: 2020 706f 7274 203d 2077 732e 7365 7276    port = ws.serv
+00021300: 6963 6573 2e67 6574 2873 6572 7669 6365  ices.get(service
+00021310: 5f6e 616d 6529 0a20 2020 2020 2020 2069  _name).        i
+00021320: 6620 706f 7274 2069 7320 4e6f 6e65 3a0a  f port is None:.
+00021330: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00021340: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
+00021350: 656c 6966 2070 726f 746f 636f 6c3a 0a20  elif protocol:. 
+00021360: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00021370: 6e20 2225 2870 726f 746f 636f 6c29 733a  n "%(protocol)s:
+00021380: 2f2f 2528 686f 7374 2973 3a25 2870 6f72  //%(host)s:%(por
+00021390: 7429 6422 2025 207b 0a20 2020 2020 2020  t)d" % {.       
+000213a0: 2020 2020 2020 2020 2022 7072 6f74 6f63           "protoc
+000213b0: 6f6c 223a 2077 732e 6164 6472 6573 732e  ol": ws.address.
+000213c0: 7370 6c69 7428 223a 2f2f 2229 5b30 5d2c  split("://")[0],
+000213d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000213e0: 2022 686f 7374 223a 2077 732e 686f 7374   "host": ws.host
+000213f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021400: 2020 2270 6f72 7422 3a20 706f 7274 2c0a    "port": port,.
+00021410: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00021420: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00021430: 2020 2020 2020 2020 7265 7475 726e 2077          return w
+00021440: 732e 686f 7374 2c20 706f 7274 0a0a 2020  s.host, port..  
+00021450: 2020 6173 796e 6320 6465 6620 7374 6172    async def star
+00021460: 745f 756e 7361 6665 2873 656c 6629 3a0a  t_unsafe(self):.
+00021470: 2020 2020 2020 2020 2222 2243 6c65 6172          """Clear
+00021480: 206f 7574 206f 6c64 2073 7461 7465 2061   out old state a
+00021490: 6e64 2072 6573 7461 7274 2061 6c6c 2072  nd restart all r
+000214a0: 756e 6e69 6e67 2063 6f72 6f75 7469 6e65  unning coroutine
+000214b0: 7322 2222 0a20 2020 2020 2020 2061 7761  s""".        awa
+000214c0: 6974 2073 7570 6572 2829 2e73 7461 7274  it super().start
+000214d0: 5f75 6e73 6166 6528 290a 0a20 2020 2020  _unsafe()..     
+000214e0: 2020 2065 6e61 626c 655f 6763 5f64 6961     enable_gc_dia
+000214f0: 676e 6f73 6973 2829 0a0a 2020 2020 2020  gnosis()..      
+00021500: 2020 7365 6c66 2e5f 636c 6561 725f 7461    self._clear_ta
+00021510: 736b 5f73 7461 7465 2829 0a0a 2020 2020  sk_state()..    
+00021520: 2020 2020 666f 7220 6164 6472 2069 6e20      for addr in 
+00021530: 7365 6c66 2e5f 7374 6172 745f 6164 6472  self._start_addr
+00021540: 6573 733a 0a20 2020 2020 2020 2020 2020  ess:.           
+00021550: 2061 7761 6974 2073 656c 662e 6c69 7374   await self.list
+00021560: 656e 280a 2020 2020 2020 2020 2020 2020  en(.            
+00021570: 2020 2020 6164 6472 2c0a 2020 2020 2020      addr,.      
+00021580: 2020 2020 2020 2020 2020 616c 6c6f 775f            allow_
+00021590: 6f66 666c 6f61 643d 4661 6c73 652c 0a20  offload=False,. 
+000215a0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000215b0: 616e 6473 6861 6b65 5f6f 7665 7272 6964  andshake_overrid
+000215c0: 6573 3d7b 2270 6963 6b6c 652d 7072 6f74  es={"pickle-prot
+000215d0: 6f63 6f6c 223a 2034 2c20 2263 6f6d 7072  ocol": 4, "compr
+000215e0: 6573 7369 6f6e 223a 204e 6f6e 657d 2c0a  ession": None},.
+000215f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021600: 2a2a 7365 6c66 2e73 6563 7572 6974 792e  **self.security.
+00021610: 6765 745f 6c69 7374 656e 5f61 7267 7328  get_listen_args(
+00021620: 2273 6368 6564 756c 6572 2229 2c0a 2020  "scheduler"),.  
+00021630: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00021640: 2020 2020 2020 2020 7365 6c66 2e69 7020          self.ip 
+00021650: 3d20 6765 745f 6164 6472 6573 735f 686f  = get_address_ho
+00021660: 7374 2873 656c 662e 6c69 7374 656e 5f61  st(self.listen_a
+00021670: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+00021680: 2020 2020 6c69 7374 656e 5f69 7020 3d20      listen_ip = 
+00021690: 7365 6c66 2e69 700a 0a20 2020 2020 2020  self.ip..       
+000216a0: 2020 2020 2069 6620 6c69 7374 656e 5f69       if listen_i
+000216b0: 7020 3d3d 2022 302e 302e 302e 3022 3a0a  p == "0.0.0.0":.
+000216c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000216d0: 6c69 7374 656e 5f69 7020 3d20 2222 0a0a  listen_ip = ""..
+000216e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000216f0: 6164 6472 6573 732e 7374 6172 7473 7769  address.startswi
+00021700: 7468 2822 696e 7072 6f63 3a2f 2f22 293a  th("inproc://"):
+00021710: 0a20 2020 2020 2020 2020 2020 206c 6973  .            lis
+00021720: 7465 6e5f 6970 203d 2022 6c6f 6361 6c68  ten_ip = "localh
+00021730: 6f73 7422 0a0a 2020 2020 2020 2020 2320  ost"..        # 
+00021740: 5365 7276 6963 6573 206c 6973 7465 6e20  Services listen 
+00021750: 6f6e 2061 6c6c 2061 6464 7265 7373 6573  on all addresses
+00021760: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00021770: 6172 745f 7365 7276 6963 6573 286c 6973  art_services(lis
+00021780: 7465 6e5f 6970 290a 0a20 2020 2020 2020  ten_ip)..       
+00021790: 2066 6f72 206c 6973 7465 6e65 7220 696e   for listener in
+000217a0: 2073 656c 662e 6c69 7374 656e 6572 733a   self.listeners:
+000217b0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000217c0: 6765 722e 696e 666f 2822 2020 5363 6865  ger.info("  Sche
+000217d0: 6475 6c65 7220 6174 3a20 2532 3573 222c  duler at: %25s",
+000217e0: 206c 6973 7465 6e65 722e 636f 6e74 6163   listener.contac
+000217f0: 745f 6164 6472 6573 7329 0a20 2020 2020  t_address).     
+00021800: 2020 2066 6f72 206e 616d 652c 2073 6572     for name, ser
+00021810: 7665 7220 696e 2073 656c 662e 7365 7276  ver in self.serv
+00021820: 6963 6573 2e69 7465 6d73 2829 3a0a 2020  ices.items():.  
+00021830: 2020 2020 2020 2020 2020 6966 206e 616d            if nam
+00021840: 6520 3d3d 2022 6461 7368 626f 6172 6422  e == "dashboard"
+00021850: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021860: 2020 6164 6472 203d 2067 6574 5f61 6464    addr = get_add
+00021870: 7265 7373 5f68 6f73 7428 6c69 7374 656e  ress_host(listen
+00021880: 6572 2e63 6f6e 7461 6374 5f61 6464 7265  er.contact_addre
+00021890: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
+000218a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000218b0: 2020 2020 2020 2020 2020 2020 206c 696e               lin
+000218c0: 6b20 3d20 666f 726d 6174 5f64 6173 6862  k = format_dashb
+000218d0: 6f61 7264 5f6c 696e 6b28 6164 6472 2c20  oard_link(addr, 
+000218e0: 7365 7276 6572 2e70 6f72 7429 0a20 2020  server.port).   
+000218f0: 2020 2020 2020 2020 2020 2020 2023 2066               # f
+00021900: 6f72 6d61 7474 696e 6720 6461 7368 626f  ormatting dashbo
+00021910: 6172 6420 6c69 6e6b 2063 616e 2066 6169  ard link can fai
+00021920: 6c20 6966 2064 6973 7472 6962 7574 6564  l if distributed
+00021930: 2e64 6173 6862 6f61 7264 2e6c 696e 6b0a  .dashboard.link.
+00021940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021950: 2320 7265 6665 7273 2074 6f20 6e6f 6e2d  # refers to non-
+00021960: 6578 6973 7461 6e74 2065 6e76 2076 6172  existant env var
+00021970: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
+00021980: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+00021990: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
+000219a0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+000219b0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+000219c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219d0: 2020 2020 2066 2246 6169 6c65 6420 746f       f"Failed to
+000219e0: 2066 6f72 6d61 7420 6461 7368 626f 6172   format dashboar
+000219f0: 6420 6c69 6e6b 2c20 756e 6b6e 6f77 6e20  d link, unknown 
+00021a00: 7661 6c75 653a 207b 657d 220a 2020 2020  value: {e}".    
+00021a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021a20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00021a30: 2020 2020 2020 6c69 6e6b 203d 2066 223a        link = f":
+00021a40: 7b73 6572 7665 722e 706f 7274 7d22 0a20  {server.port}". 
+00021a50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00021a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021a70: 206c 696e 6b20 3d20 6622 7b6c 6973 7465   link = f"{liste
+00021a80: 6e5f 6970 7d3a 7b73 6572 7665 722e 706f  n_ip}:{server.po
+00021a90: 7274 7d22 0a20 2020 2020 2020 2020 2020  rt}".           
+00021aa0: 206c 6f67 6765 722e 696e 666f 2822 2531   logger.info("%1
+00021ab0: 3173 2061 743a 2020 2532 3573 222c 206e  1s at:  %25s", n
+00021ac0: 616d 652c 206c 696e 6b29 0a0a 2020 2020  ame, link)..    
+00021ad0: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
+00021ae0: 6475 6c65 725f 6669 6c65 3a0a 2020 2020  duler_file:.    
+00021af0: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+00021b00: 6e28 7365 6c66 2e73 6368 6564 756c 6572  n(self.scheduler
+00021b10: 5f66 696c 652c 2022 7722 2920 6173 2066  _file, "w") as f
+00021b20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021b30: 2020 6a73 6f6e 2e64 756d 7028 7365 6c66    json.dump(self
+00021b40: 2e69 6465 6e74 6974 7928 292c 2066 2c20  .identity(), f, 
+00021b50: 696e 6465 6e74 3d32 290a 0a20 2020 2020  indent=2)..     
+00021b60: 2020 2020 2020 2066 6e20 3d20 7365 6c66         fn = self
+00021b70: 2e73 6368 6564 756c 6572 5f66 696c 6520  .scheduler_file 
+00021b80: 2023 2072 656d 6f76 6520 6669 6c65 2077   # remove file w
+00021b90: 6865 6e20 7765 2063 6c6f 7365 2074 6865  hen we close the
+00021ba0: 2070 726f 6365 7373 0a0a 2020 2020 2020   process..      
+00021bb0: 2020 2020 2020 6465 6620 6465 6c5f 7363        def del_sc
+00021bc0: 6865 6475 6c65 725f 6669 6c65 2829 3a0a  heduler_file():.
+00021bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021be0: 6966 206f 732e 7061 7468 2e65 7869 7374  if os.path.exist
+00021bf0: 7328 666e 293a 0a20 2020 2020 2020 2020  s(fn):.         
+00021c00: 2020 2020 2020 2020 2020 206f 732e 7265             os.re
+00021c10: 6d6f 7665 2866 6e29 0a0a 2020 2020 2020  move(fn)..      
+00021c20: 2020 2020 2020 7765 616b 7265 662e 6669        weakref.fi
+00021c30: 6e61 6c69 7a65 2873 656c 662c 2064 656c  nalize(self, del
+00021c40: 5f73 6368 6564 756c 6572 5f66 696c 6529  _scheduler_file)
+00021c50: 0a0a 2020 2020 2020 2020 666f 7220 7072  ..        for pr
+00021c60: 656c 6f61 6420 696e 2073 656c 662e 7072  eload in self.pr
+00021c70: 656c 6f61 6473 3a0a 2020 2020 2020 2020  eloads:.        
+00021c80: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00021c90: 2020 2020 2020 2020 2061 7761 6974 2070           await p
+00021ca0: 7265 6c6f 6164 2e73 7461 7274 2829 0a20  reload.start(). 
+00021cb0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00021cc0: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+00021cd0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00021ce0: 6765 722e 6578 6365 7074 696f 6e28 2246  ger.exception("F
+00021cf0: 6169 6c65 6420 746f 2073 7461 7274 2070  ailed to start p
+00021d00: 7265 6c6f 6164 2229 0a0a 2020 2020 2020  reload")..      
+00021d10: 2020 6966 2073 656c 662e 6a75 7079 7465    if self.jupyte
+00021d20: 723a 0a20 2020 2020 2020 2020 2020 2023  r:.            #
+00021d30: 2041 6c6c 6f77 2069 6e73 6563 7572 6520   Allow insecure 
+00021d40: 636f 6d6d 756e 6963 6174 696f 6e73 2066  communications f
+00021d50: 726f 6d20 6c6f 6361 6c20 7573 6572 730a  rom local users.
+00021d60: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00021d70: 656c 662e 6164 6472 6573 732e 7374 6172  elf.address.star
+00021d80: 7473 7769 7468 2822 746c 733a 2f2f 2229  tswith("tls://")
+00021d90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021da0: 2020 6177 6169 7420 7365 6c66 2e6c 6973    await self.lis
+00021db0: 7465 6e28 2274 6370 3a2f 2f6c 6f63 616c  ten("tcp://local
+00021dc0: 686f 7374 3a30 2229 0a20 2020 2020 2020  host:0").       
+00021dd0: 2020 2020 206f 732e 656e 7669 726f 6e5b       os.environ[
+00021de0: 2244 4153 4b5f 5343 4845 4455 4c45 525f  "DASK_SCHEDULER_
+00021df0: 4144 4452 4553 5322 5d20 3d20 7365 6c66  ADDRESS"] = self
+00021e00: 2e6c 6973 7465 6e65 7273 5b2d 315d 2e63  .listeners[-1].c
+00021e10: 6f6e 7461 6374 5f61 6464 7265 7373 0a0a  ontact_address..
+00021e20: 2020 2020 2020 2020 6177 6169 7420 6173          await as
+00021e30: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
+00021e40: 2020 2020 2020 2020 2020 2a5b 706c 7567            *[plug
+00021e50: 696e 2e73 7461 7274 2873 656c 6629 2066  in.start(self) f
+00021e60: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
+00021e70: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
+00021e80: 616c 7565 7328 2929 5d0a 2020 2020 2020  alues())].      
+00021e90: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00021ea0: 662e 7374 6172 745f 7065 7269 6f64 6963  f.start_periodic
+00021eb0: 5f63 616c 6c62 6163 6b73 2829 0a0a 2020  _callbacks()..  
+00021ec0: 2020 2020 2020 7365 7470 726f 6374 6974        setproctit
+00021ed0: 6c65 2866 2264 6173 6b20 7363 6865 6475  le(f"dask schedu
+00021ee0: 6c65 7220 5b7b 7365 6c66 2e61 6464 7265  ler [{self.addre
+00021ef0: 7373 7d5d 2229 0a20 2020 2020 2020 2072  ss}]").        r
+00021f00: 6574 7572 6e20 7365 6c66 0a0a 2020 2020  eturn self..    
+00021f10: 6173 796e 6320 6465 6620 636c 6f73 6528  async def close(
+00021f20: 7365 6c66 2c20 6661 7374 3d4e 6f6e 652c  self, fast=None,
+00021f30: 2063 6c6f 7365 5f77 6f72 6b65 7273 3d4e   close_workers=N
+00021f40: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
+00021f50: 2253 656e 6420 636c 6561 6e75 7020 7369  "Send cleanup si
+00021f60: 676e 616c 2074 6f20 616c 6c20 636f 726f  gnal to all coro
+00021f70: 7574 696e 6573 2074 6865 6e20 7761 6974  utines then wait
+00021f80: 2075 6e74 696c 2066 696e 6973 6865 640a   until finished.
+00021f90: 0a20 2020 2020 2020 2053 6565 2041 6c73  .        See Als
+00021fa0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+00021fb0: 2d2d 0a20 2020 2020 2020 2053 6368 6564  --.        Sched
+00021fc0: 756c 6572 2e63 6c65 616e 7570 0a20 2020  uler.cleanup.   
+00021fd0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00021fe0: 2069 6620 6661 7374 2069 7320 6e6f 7420   if fast is not 
+00021ff0: 4e6f 6e65 206f 7220 636c 6f73 655f 776f  None or close_wo
+00022000: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
+00022010: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00022020: 6172 6e69 6e67 732e 7761 726e 280a 2020  arnings.warn(.  
+00022030: 2020 2020 2020 2020 2020 2020 2020 2254                "T
+00022040: 6865 2027 6661 7374 2720 616e 6420 2763  he 'fast' and 'c
+00022050: 6c6f 7365 5f77 6f72 6b65 7273 2720 7061  lose_workers' pa
+00022060: 7261 6d65 7465 7273 2069 6e20 5363 6865  rameters in Sche
+00022070: 6475 6c65 722e 636c 6f73 6520 6861 7665  duler.close have
+00022080: 206e 6f20 6566 6665 6374 2061 6e64 2077   no effect and w
+00022090: 696c 6c20 6265 2072 656d 6f76 6564 2069  ill be removed i
+000220a0: 6e20 6120 6675 7475 7265 2076 6572 7369  n a future versi
+000220b0: 6f6e 206f 6620 6469 7374 7269 6275 7465  on of distribute
+000220c0: 642e 222c 0a20 2020 2020 2020 2020 2020  d.",.           
+000220d0: 2020 2020 2046 7574 7572 6557 6172 6e69       FutureWarni
+000220e0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
+000220f0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+00022100: 662e 7374 6174 7573 2069 6e20 2853 7461  f.status in (Sta
+00022110: 7475 732e 636c 6f73 696e 672c 2053 7461  tus.closing, Sta
+00022120: 7475 732e 636c 6f73 6564 293a 0a20 2020  tus.closed):.   
+00022130: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+00022140: 656c 662e 6669 6e69 7368 6564 2829 0a20  elf.finished(). 
+00022150: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00022160: 6e0a 0a20 2020 2020 2020 2061 7379 6e63  n..        async
+00022170: 2064 6566 206c 6f67 5f65 7272 6f72 7328   def log_errors(
+00022180: 6675 6e63 293a 0a20 2020 2020 2020 2020  func):.         
+00022190: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000221a0: 2020 2020 2020 2020 6177 6169 7420 6675          await fu
+000221b0: 6e63 2829 0a20 2020 2020 2020 2020 2020  nc().           
+000221c0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000221d0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+000221e0: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+000221f0: 696f 6e28 2250 6c75 6769 6e20 6361 6c6c  ion("Plugin call
+00022200: 2066 6169 6c65 6420 6475 7269 6e67 2073   failed during s
+00022210: 6368 6564 756c 6572 2e63 6c6f 7365 2229  cheduler.close")
+00022220: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
+00022230: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+00022240: 2020 2020 2020 2020 2020 2020 2a5b 6c6f              *[lo
+00022250: 675f 6572 726f 7273 2870 6c75 6769 6e2e  g_errors(plugin.
+00022260: 6265 666f 7265 5f63 6c6f 7365 2920 666f  before_close) fo
+00022270: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
+00022280: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
+00022290: 6c75 6573 2829 295d 0a20 2020 2020 2020  lues())].       
+000222a0: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+000222b0: 2e73 7461 7475 7320 3d20 5374 6174 7573  .status = Status
+000222c0: 2e63 6c6f 7369 6e67 0a0a 2020 2020 2020  .closing..      
+000222d0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2253    logger.info("S
+000222e0: 6368 6564 756c 6572 2063 6c6f 7369 6e67  cheduler closing
+000222f0: 2e2e 2e22 290a 2020 2020 2020 2020 7365  ...").        se
+00022300: 7470 726f 6374 6974 6c65 2822 6461 736b  tproctitle("dask
+00022310: 2073 6368 6564 756c 6572 205b 636c 6f73   scheduler [clos
+00022320: 696e 675d 2229 0a0a 2020 2020 2020 2020  ing]")..        
+00022330: 666f 7220 7072 656c 6f61 6420 696e 2073  for preload in s
+00022340: 656c 662e 7072 656c 6f61 6473 3a0a 2020  elf.preloads:.  
+00022350: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00022360: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00022370: 7761 6974 2070 7265 6c6f 6164 2e74 6561  wait preload.tea
+00022380: 7264 6f77 6e28 290a 2020 2020 2020 2020  rdown().        
+00022390: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000223a0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+000223b0: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
+000223c0: 6570 7469 6f6e 2822 4661 696c 6564 2074  eption("Failed t
+000223d0: 6f20 7465 6172 2064 6f77 6e20 7072 656c  o tear down prel
+000223e0: 6f61 6422 290a 0a20 2020 2020 2020 2061  oad")..        a
+000223f0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+00022400: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
+00022410: 202a 5b6c 6f67 5f65 7272 6f72 7328 706c   *[log_errors(pl
+00022420: 7567 696e 2e63 6c6f 7365 2920 666f 7220  ugin.close) for 
+00022430: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
+00022440: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
+00022450: 6573 2829 295d 0a20 2020 2020 2020 2029  es())].        )
+00022460: 0a0a 2020 2020 2020 2020 666f 7220 7063  ..        for pc
+00022470: 2069 6e20 7365 6c66 2e70 6572 696f 6469   in self.periodi
+00022480: 635f 6361 6c6c 6261 636b 732e 7661 6c75  c_callbacks.valu
+00022490: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+000224a0: 2020 7063 2e73 746f 7028 290a 2020 2020    pc.stop().    
+000224b0: 2020 2020 7365 6c66 2e70 6572 696f 6469      self.periodi
+000224c0: 635f 6361 6c6c 6261 636b 732e 636c 6561  c_callbacks.clea
+000224d0: 7228 290a 0a20 2020 2020 2020 2073 656c  r()..        sel
+000224e0: 662e 7374 6f70 5f73 6572 7669 6365 7328  f.stop_services(
+000224f0: 290a 0a20 2020 2020 2020 2066 6f72 2065  )..        for e
+00022500: 7874 2069 6e20 7365 6c66 2e65 7874 656e  xt in self.exten
+00022510: 7369 6f6e 732e 7661 6c75 6573 2829 3a0a  sions.values():.
+00022520: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00022530: 2073 7570 7072 6573 7328 4174 7472 6962   suppress(Attrib
+00022540: 7574 6545 7272 6f72 293a 0a20 2020 2020  uteError):.     
+00022550: 2020 2020 2020 2020 2020 2065 7874 2e74             ext.t
+00022560: 6561 7264 6f77 6e28 290a 2020 2020 2020  eardown().      
+00022570: 2020 6c6f 6767 6572 2e69 6e66 6f28 2253    logger.info("S
+00022580: 6368 6564 756c 6572 2063 6c6f 7369 6e67  cheduler closing
+00022590: 2061 6c6c 2063 6f6d 6d73 2229 0a0a 2020   all comms")..  
+000225a0: 2020 2020 2020 6675 7475 7265 7320 3d20        futures = 
+000225b0: 5b5d 0a20 2020 2020 2020 2066 6f72 205f  [].        for _
+000225c0: 2c20 636f 6d6d 2069 6e20 6c69 7374 2873  , comm in list(s
+000225d0: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
+000225e0: 2e69 7465 6d73 2829 293a 0a20 2020 2020  .items()):.     
+000225f0: 2020 2020 2020 2023 2046 4958 4d45 2075         # FIXME u
+00022600: 7365 2060 7365 6c66 2e72 656d 6f76 655f  se `self.remove_
+00022610: 776f 726b 6572 2829 6020 696e 7374 6561  worker()` instea
+00022620: 6420 6166 7465 7220 6874 7470 733a 2f2f  d after https://
+00022630: 6769 7468 7562 2e63 6f6d 2f64 6173 6b2f  github.com/dask/
+00022640: 6469 7374 7269 6275 7465 642f 6973 7375  distributed/issu
+00022650: 6573 2f36 3339 300a 2020 2020 2020 2020  es/6390.        
+00022660: 2020 2020 6966 206e 6f74 2063 6f6d 6d2e      if not comm.
+00022670: 636c 6f73 6564 2829 3a0a 2020 2020 2020  closed():.      
+00022680: 2020 2020 2020 2020 2020 2320 5468 6973            # This
+00022690: 2063 6c6f 7365 7320 7468 6520 576f 726b   closes the Work
+000226a0: 6572 2061 6e64 2065 6e73 7572 6573 2074  er and ensures t
+000226b0: 6861 7420 6966 2061 204e 616e 6e79 2069  hat if a Nanny i
+000226c0: 7320 6172 6f75 6e64 2c0a 2020 2020 2020  s around,.      
+000226d0: 2020 2020 2020 2020 2020 2320 6974 2069            # it i
+000226e0: 7320 636c 6f73 6564 2061 7320 7765 6c6c  s closed as well
+000226f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022700: 2063 6f6d 6d2e 7365 6e64 287b 226f 7022   comm.send({"op"
+00022710: 3a20 2263 6c6f 7365 222c 2022 7265 6173  : "close", "reas
+00022720: 6f6e 223a 2022 7363 6865 6475 6c65 722d  on": "scheduler-
+00022730: 636c 6f73 6522 7d29 0a20 2020 2020 2020  close"}).       
+00022740: 2020 2020 2020 2020 2063 6f6d 6d2e 7365           comm.se
+00022750: 6e64 287b 226f 7022 3a20 2263 6c6f 7365  nd({"op": "close
+00022760: 2d73 7472 6561 6d22 7d29 0a20 2020 2020  -stream"}).     
+00022770: 2020 2020 2020 2020 2020 2023 205e 2054             # ^ T
+00022780: 4f44 4f20 7265 6d6f 7665 3f20 6057 6f72  ODO remove? `Wor
+00022790: 6b65 722e 636c 6f73 6560 2077 696c 6c20  ker.close` will 
+000227a0: 636c 6f73 6520 7468 6520 7374 7265 616d  close the stream
+000227b0: 2061 6e79 7761 792e 0a20 2020 2020 2020   anyway..       
+000227c0: 2020 2020 2077 6974 6820 7375 7070 7265       with suppre
+000227d0: 7373 2841 7474 7269 6275 7465 4572 726f  ss(AttributeErro
+000227e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000227f0: 2020 2020 6675 7475 7265 732e 6170 7065      futures.appe
+00022800: 6e64 2863 6f6d 6d2e 636c 6f73 6528 2929  nd(comm.close())
+00022810: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
+00022820: 6173 796e 6369 6f2e 6761 7468 6572 282a  asyncio.gather(*
+00022830: 6675 7475 7265 7329 0a0a 2020 2020 2020  futures)..      
+00022840: 2020 6966 2073 656c 662e 6a75 7079 7465    if self.jupyte
+00022850: 723a 0a20 2020 2020 2020 2020 2020 2061  r:.            a
+00022860: 7761 6974 2073 656c 662e 5f6a 7570 7974  wait self._jupyt
+00022870: 6572 5f73 6572 7665 725f 6170 706c 6963  er_server_applic
+00022880: 6174 696f 6e2e 5f63 6c65 616e 7570 2829  ation._cleanup()
+00022890: 0a0a 2020 2020 2020 2020 666f 7220 636f  ..        for co
+000228a0: 6d6d 2069 6e20 7365 6c66 2e63 6c69 656e  mm in self.clien
+000228b0: 745f 636f 6d6d 732e 7661 6c75 6573 2829  t_comms.values()
+000228c0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+000228d0: 6d6d 2e61 626f 7274 2829 0a0a 2020 2020  mm.abort()..    
+000228e0: 2020 2020 6177 6169 7420 7365 6c66 2e72      await self.r
+000228f0: 7063 2e63 6c6f 7365 2829 0a0a 2020 2020  pc.close()..    
+00022900: 2020 2020 7365 6c66 2e73 7461 7475 7320      self.status 
+00022910: 3d20 5374 6174 7573 2e63 6c6f 7365 640a  = Status.closed.
+00022920: 2020 2020 2020 2020 7365 6c66 2e73 746f          self.sto
+00022930: 7028 290a 2020 2020 2020 2020 6177 6169  p().        awai
+00022940: 7420 7375 7065 7228 292e 636c 6f73 6528  t super().close(
+00022950: 290a 0a20 2020 2020 2020 2073 6574 7072  )..        setpr
+00022960: 6f63 7469 746c 6528 2264 6173 6b20 7363  octitle("dask sc
+00022970: 6865 6475 6c65 7220 5b63 6c6f 7365 645d  heduler [closed]
+00022980: 2229 0a20 2020 2020 2020 2064 6973 6162  ").        disab
+00022990: 6c65 5f67 635f 6469 6167 6e6f 7369 7328  le_gc_diagnosis(
+000229a0: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
+000229b0: 2323 0a20 2020 2023 2053 7469 6d75 6c69  ##.    # Stimuli
+000229c0: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
+000229d0: 2323 0a0a 2020 2020 6465 6620 6865 6172  ##..    def hear
+000229e0: 7462 6561 745f 776f 726b 6572 280a 2020  tbeat_worker(.  
+000229f0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00022a00: 2020 2020 2a2c 0a20 2020 2020 2020 2061      *,.        a
+00022a10: 6464 7265 7373 3a20 7374 722c 0a20 2020  ddress: str,.   
+00022a20: 2020 2020 2072 6573 6f6c 7665 5f61 6464       resolve_add
+00022a30: 7265 7373 3a20 626f 6f6c 203d 2054 7275  ress: bool = Tru
+00022a40: 652c 0a20 2020 2020 2020 206e 6f77 3a20  e,.        now: 
+00022a50: 666c 6f61 7420 7c20 4e6f 6e65 203d 204e  float | None = N
+00022a60: 6f6e 652c 0a20 2020 2020 2020 2072 6573  one,.        res
+00022a70: 6f75 7263 6573 3a20 6469 6374 5b73 7472  ources: dict[str
+00022a80: 2c20 666c 6f61 745d 207c 204e 6f6e 6520  , float] | None 
+00022a90: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00022aa0: 686f 7374 5f69 6e66 6f3a 2064 6963 7420  host_info: dict 
+00022ab0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00022ac0: 2020 2020 2020 206d 6574 7269 6373 3a20         metrics: 
+00022ad0: 6469 6374 2c0a 2020 2020 2020 2020 6578  dict,.        ex
+00022ae0: 6563 7574 696e 673a 2064 6963 745b 7374  ecuting: dict[st
+00022af0: 722c 2066 6c6f 6174 5d20 7c20 4e6f 6e65  r, float] | None
+00022b00: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00022b10: 2065 7874 656e 7369 6f6e 733a 2064 6963   extensions: dic
+00022b20: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
+00022b30: 0a20 2020 2029 202d 3e20 6469 6374 5b73  .    ) -> dict[s
+00022b40: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
+00022b50: 2020 6164 6472 6573 7320 3d20 7365 6c66    address = self
+00022b60: 2e63 6f65 7263 655f 6164 6472 6573 7328  .coerce_address(
+00022b70: 6164 6472 6573 732c 2072 6573 6f6c 7665  address, resolve
+00022b80: 5f61 6464 7265 7373 290a 2020 2020 2020  _address).      
+00022b90: 2020 6164 6472 6573 7320 3d20 6e6f 726d    address = norm
+00022ba0: 616c 697a 655f 6164 6472 6573 7328 6164  alize_address(ad
+00022bb0: 6472 6573 7329 0a20 2020 2020 2020 2077  dress).        w
+00022bc0: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
+00022bd0: 2e67 6574 2861 6464 7265 7373 290a 2020  .get(address).  
+00022be0: 2020 2020 2020 6966 2077 7320 6973 204e        if ws is N
+00022bf0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00022c00: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+00022c10: 6622 5265 6365 6976 6564 2068 6561 7274  f"Received heart
+00022c20: 6265 6174 2066 726f 6d20 756e 7265 6769  beat from unregi
+00022c30: 7374 6572 6564 2077 6f72 6b65 7220 7b61  stered worker {a
+00022c40: 6464 7265 7373 2172 7d2e 2229 0a20 2020  ddress!r}.").   
+00022c50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00022c60: 7b22 7374 6174 7573 223a 2022 6d69 7373  {"status": "miss
+00022c70: 696e 6722 7d0a 0a20 2020 2020 2020 2068  ing"}..        h
+00022c80: 6f73 7420 3d20 6765 745f 6164 6472 6573  ost = get_addres
+00022c90: 735f 686f 7374 2861 6464 7265 7373 290a  s_host(address).
+00022ca0: 2020 2020 2020 2020 6c6f 6361 6c5f 6e6f          local_no
+00022cb0: 7720 3d20 7469 6d65 2829 0a20 2020 2020  w = time().     
+00022cc0: 2020 2068 6f73 745f 696e 666f 203d 2068     host_info = h
+00022cd0: 6f73 745f 696e 666f 206f 7220 7b7d 0a0a  ost_info or {}..
+00022ce0: 2020 2020 2020 2020 6468 3a20 6469 6374          dh: dict
+00022cf0: 203d 2073 656c 662e 686f 7374 5f69 6e66   = self.host_inf
+00022d00: 6f2e 7365 7464 6566 6175 6c74 2868 6f73  o.setdefault(hos
+00022d10: 742c 207b 7d29 0a20 2020 2020 2020 2064  t, {}).        d
+00022d20: 685b 226c 6173 742d 7365 656e 225d 203d  h["last-seen"] =
+00022d30: 206c 6f63 616c 5f6e 6f77 0a0a 2020 2020   local_now..    
+00022d40: 2020 2020 6672 6163 203d 2031 202f 206c      frac = 1 / l
+00022d50: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
+00022d60: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+00022d70: 6e64 7769 6474 6820 3d20 280a 2020 2020  ndwidth = (.    
+00022d80: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+00022d90: 6477 6964 7468 202a 2028 3120 2d20 6672  dwidth * (1 - fr
+00022da0: 6163 2920 2b20 6d65 7472 6963 735b 2262  ac) + metrics["b
+00022db0: 616e 6477 6964 7468 225d 5b22 746f 7461  andwidth"]["tota
+00022dc0: 6c22 5d20 2a20 6672 6163 0a20 2020 2020  l"] * frac.     
+00022dd0: 2020 2029 0a20 2020 2020 2020 2066 6f72     ).        for
+00022de0: 206f 7468 6572 2c20 2862 772c 2063 6f75   other, (bw, cou
+00022df0: 6e74 2920 696e 206d 6574 7269 6373 5b22  nt) in metrics["
+00022e00: 6261 6e64 7769 6474 6822 5d5b 2277 6f72  bandwidth"]["wor
+00022e10: 6b65 7273 225d 2e69 7465 6d73 2829 3a0a  kers"].items():.
+00022e20: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00022e30: 6164 6472 6573 732c 206f 7468 6572 2920  address, other) 
+00022e40: 6e6f 7420 696e 2073 656c 662e 6261 6e64  not in self.band
+00022e50: 7769 6474 685f 776f 726b 6572 733a 0a20  width_workers:. 
+00022e60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00022e70: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
+00022e80: 726b 6572 735b 6164 6472 6573 732c 206f  rkers[address, o
+00022e90: 7468 6572 5d20 3d20 6277 202f 2063 6f75  ther] = bw / cou
+00022ea0: 6e74 0a20 2020 2020 2020 2020 2020 2065  nt.            e
+00022eb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00022ec0: 2020 2020 2061 6c70 6861 203d 2028 3120       alpha = (1 
+00022ed0: 2d20 6672 6163 2920 2a2a 2063 6f75 6e74  - frac) ** count
+00022ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022ef0: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
+00022f00: 776f 726b 6572 735b 6164 6472 6573 732c  workers[address,
+00022f10: 206f 7468 6572 5d20 3d20 7365 6c66 2e62   other] = self.b
+00022f20: 616e 6477 6964 7468 5f77 6f72 6b65 7273  andwidth_workers
+00022f30: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00022f40: 2020 2020 2020 6164 6472 6573 732c 206f        address, o
+00022f50: 7468 6572 0a20 2020 2020 2020 2020 2020  ther.           
+00022f60: 2020 2020 205d 202a 2061 6c70 6861 202b       ] * alpha +
+00022f70: 2062 7720 2a20 2831 202d 2061 6c70 6861   bw * (1 - alpha
+00022f80: 290a 2020 2020 2020 2020 666f 7220 7479  ).        for ty
+00022f90: 702c 2028 6277 2c20 636f 756e 7429 2069  p, (bw, count) i
+00022fa0: 6e20 6d65 7472 6963 735b 2262 616e 6477  n metrics["bandw
+00022fb0: 6964 7468 225d 5b22 7479 7065 7322 5d2e  idth"]["types"].
+00022fc0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00022fd0: 2020 2020 2069 6620 7479 7020 6e6f 7420       if typ not 
+00022fe0: 696e 2073 656c 662e 6261 6e64 7769 6474  in self.bandwidt
+00022ff0: 685f 7479 7065 733a 0a20 2020 2020 2020  h_types:.       
+00023000: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+00023010: 6e64 7769 6474 685f 7479 7065 735b 7479  ndwidth_types[ty
+00023020: 705d 203d 2062 7720 2f20 636f 756e 740a  p] = bw / count.
+00023030: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00023040: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023050: 2020 616c 7068 6120 3d20 2831 202d 2066    alpha = (1 - f
+00023060: 7261 6329 202a 2a20 636f 756e 740a 2020  rac) ** count.  
+00023070: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00023080: 6c66 2e62 616e 6477 6964 7468 5f74 7970  lf.bandwidth_typ
+00023090: 6573 5b74 7970 5d20 3d20 7365 6c66 2e62  es[typ] = self.b
+000230a0: 616e 6477 6964 7468 5f74 7970 6573 5b74  andwidth_types[t
+000230b0: 7970 5d20 2a20 616c 7068 6120 2b20 6277  yp] * alpha + bw
+000230c0: 202a 2028 0a20 2020 2020 2020 2020 2020   * (.           
+000230d0: 2020 2020 2020 2020 2031 202d 2061 6c70           1 - alp
+000230e0: 6861 0a20 2020 2020 2020 2020 2020 2020  ha.             
+000230f0: 2020 2029 0a0a 2020 2020 2020 2020 7773     )..        ws
+00023100: 2e6c 6173 745f 7365 656e 203d 206c 6f63  .last_seen = loc
+00023110: 616c 5f6e 6f77 0a20 2020 2020 2020 2069  al_now.        i
+00023120: 6620 6578 6563 7574 696e 6720 6973 206e  f executing is n
+00023130: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00023140: 2020 2020 2023 204e 4f54 453a 2074 6865       # NOTE: the
+00023150: 2065 7865 6375 7469 6e67 2064 6963 7420   executing dict 
+00023160: 6973 2075 6e75 7365 640a 2020 2020 2020  is unused.      
+00023170: 2020 2020 2020 7773 2e65 7865 6375 7469        ws.executi
+00023180: 6e67 203d 207b 7d0a 2020 2020 2020 2020  ng = {}.        
+00023190: 2020 2020 666f 7220 6b65 792c 2064 7572      for key, dur
+000231a0: 6174 696f 6e20 696e 2065 7865 6375 7469  ation in executi
+000231b0: 6e67 2e69 7465 6d73 2829 3a0a 2020 2020  ng.items():.    
+000231c0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+000231d0: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
+000231e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000231f0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00023200: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+00023210: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00023220: 732e 6578 6563 7574 696e 675b 7473 5d20  s.executing[ts] 
+00023230: 3d20 6475 7261 7469 6f6e 0a20 2020 2020  = duration.     
+00023240: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00023250: 732e 7072 6566 6978 2e61 6464 5f65 7865  s.prefix.add_exe
+00023260: 635f 7469 6d65 2864 7572 6174 696f 6e29  c_time(duration)
+00023270: 0a0a 2020 2020 2020 2020 666f 7220 6e61  ..        for na
+00023280: 6d65 2c20 7661 6c75 6520 696e 206d 6574  me, value in met
+00023290: 7269 6373 5b22 6469 6765 7374 735f 746f  rics["digests_to
+000232a0: 7461 6c5f 7369 6e63 655f 6865 6172 7462  tal_since_heartb
+000232b0: 6561 7422 5d2e 6974 656d 7328 293a 0a20  eat"].items():. 
+000232c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000232d0: 6375 6d75 6c61 7469 7665 5f77 6f72 6b65  cumulative_worke
+000232e0: 725f 6d65 7472 6963 735b 6e61 6d65 5d20  r_metrics[name] 
+000232f0: 2b3d 2076 616c 7565 0a0a 2020 2020 2020  += value..      
+00023300: 2020 7773 2e6d 6574 7269 6373 203d 206d    ws.metrics = m
+00023310: 6574 7269 6373 0a0a 2020 2020 2020 2020  etrics..        
+00023320: 2320 4361 6c63 756c 6174 6520 5253 5320  # Calculate RSS 
+00023330: 2d20 6461 736b 206b 6579 732c 2073 6570  - dask keys, sep
+00023340: 6172 6174 696e 6720 226f 6c64 2220 616e  arating "old" an
+00023350: 6420 226e 6577 2220 7573 6167 650a 2020  d "new" usage.  
+00023360: 2020 2020 2020 2320 5365 6520 4d65 6d6f        # See Memo
+00023370: 7279 5374 6174 6520 666f 7220 6465 7461  ryState for deta
+00023380: 696c 730a 2020 2020 2020 2020 6d61 785f  ils.        max_
+00023390: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
+000233a0: 5f6f 6c64 5f68 6973 745f 6167 6520 3d20  _old_hist_age = 
+000233b0: 6c6f 6361 6c5f 6e6f 7720 2d20 7365 6c66  local_now - self
+000233c0: 2e4d 454d 4f52 595f 5245 4345 4e54 5f54  .MEMORY_RECENT_T
+000233d0: 4f5f 4f4c 445f 5449 4d45 0a20 2020 2020  O_OLD_TIME.     
+000233e0: 2020 206d 656d 6f72 795f 756e 6d61 6e61     memory_unmana
+000233f0: 6765 645f 6f6c 6420 3d20 7773 2e5f 6d65  ged_old = ws._me
+00023400: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
+00023410: 6c64 0a20 2020 2020 2020 2077 6869 6c65  ld.        while
+00023420: 2077 732e 5f6d 656d 6f72 795f 756e 6d61   ws._memory_unma
+00023430: 6e61 6765 645f 6869 7374 6f72 793a 0a20  naged_history:. 
+00023440: 2020 2020 2020 2020 2020 2074 696d 6573             times
+00023450: 7461 6d70 2c20 7369 7a65 203d 2077 732e  tamp, size = ws.
+00023460: 5f6d 656d 6f72 795f 756e 6d61 6e61 6765  _memory_unmanage
+00023470: 645f 6869 7374 6f72 795b 305d 0a20 2020  d_history[0].   
+00023480: 2020 2020 2020 2020 2069 6620 7469 6d65           if time
+00023490: 7374 616d 7020 3e3d 206d 6178 5f6d 656d  stamp >= max_mem
+000234a0: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
+000234b0: 645f 6869 7374 5f61 6765 3a0a 2020 2020  d_hist_age:.    
+000234c0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+000234d0: 6b0a 2020 2020 2020 2020 2020 2020 7773  k.            ws
+000234e0: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
+000234f0: 6564 5f68 6973 746f 7279 2e70 6f70 6c65  ed_history.pople
+00023500: 6674 2829 0a20 2020 2020 2020 2020 2020  ft().           
+00023510: 2069 6620 7369 7a65 203d 3d20 6d65 6d6f   if size == memo
+00023520: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
+00023530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023540: 2020 6d65 6d6f 7279 5f75 6e6d 616e 6167    memory_unmanag
+00023550: 6564 5f6f 6c64 203d 2030 2020 2320 7265  ed_old = 0  # re
+00023560: 6361 6c63 756c 6174 6520 6d69 6e28 290a  calculate min().
+00023570: 0a20 2020 2020 2020 2023 2077 732e 5f6e  .        # ws._n
+00023580: 6279 7465 7320 6973 2075 7064 6174 6564  bytes is updated
+00023590: 2061 7420 6120 6469 6666 6572 656e 7420   at a different 
+000235a0: 7469 6d65 2061 6e64 2073 697a 656f 6628  time and sizeof(
+000235b0: 2920 6d61 7920 6e6f 7420 6265 2061 6363  ) may not be acc
+000235c0: 7572 6174 652c 0a20 2020 2020 2020 2023  urate,.        #
+000235d0: 2073 6f20 7369 7a65 206d 6179 2062 6520   so size may be 
+000235e0: 2874 656d 706f 7261 7269 6c79 2920 6e65  (temporarily) ne
+000235f0: 6761 7469 7665 3b20 666c 6f6f 7220 6974  gative; floor it
+00023600: 2074 6f20 7a65 726f 2e0a 2020 2020 2020   to zero..      
+00023610: 2020 7369 7a65 203d 206d 6178 280a 2020    size = max(.  
+00023620: 2020 2020 2020 2020 2020 302c 206d 6574            0, met
+00023630: 7269 6373 5b22 6d65 6d6f 7279 225d 202d  rics["memory"] -
+00023640: 2077 732e 6e62 7974 6573 202b 206d 6574   ws.nbytes + met
+00023650: 7269 6373 5b22 7370 696c 6c65 645f 6279  rics["spilled_by
+00023660: 7465 7322 5d5b 226d 656d 6f72 7922 5d0a  tes"]["memory"].
+00023670: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00023680: 2020 2077 732e 5f6d 656d 6f72 795f 756e     ws._memory_un
+00023690: 6d61 6e61 6765 645f 6869 7374 6f72 792e  managed_history.
+000236a0: 6170 7065 6e64 2828 6c6f 6361 6c5f 6e6f  append((local_no
+000236b0: 772c 2073 697a 6529 290a 2020 2020 2020  w, size)).      
+000236c0: 2020 6966 206e 6f74 206d 656d 6f72 795f    if not memory_
+000236d0: 756e 6d61 6e61 6765 645f 6f6c 643a 0a20  unmanaged_old:. 
+000236e0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+000236f0: 2077 6f72 6b65 7220 6861 7320 6a75 7374   worker has just
+00023700: 2062 6565 6e20 7374 6172 7465 6420 6f72   been started or
+00023710: 2074 6865 2070 7265 7669 6f75 7320 6d69   the previous mi
+00023720: 6e69 6d75 6d20 6861 7320 6265 656e 2065  nimum has been e
+00023730: 7870 756e 6765 640a 2020 2020 2020 2020  xpunged.        
+00023740: 2020 2020 2320 6265 6361 7573 6520 746f      # because to
+00023750: 6f20 6f6c 642e 0a20 2020 2020 2020 2020  o old..         
+00023760: 2020 2023 204e 6f74 653a 2074 6869 7320     # Note: this 
+00023770: 616c 676f 7269 7468 6d20 6973 2063 6170  algorithm is cap
+00023780: 7065 6420 746f 2032 3030 202a 204d 454d  ped to 200 * MEM
+00023790: 4f52 595f 5245 4345 4e54 5f54 4f5f 4f4c  ORY_RECENT_TO_OL
+000237a0: 445f 5449 4d45 2065 6c65 6d65 6e74 730a  D_TIME elements.
+000237b0: 2020 2020 2020 2020 2020 2020 2320 636c              # cl
+000237c0: 7573 7465 722d 7769 6465 2062 7920 6865  uster-wide by he
+000237d0: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
+000237e0: 2829 2c20 7265 6761 7264 6c65 7373 206f  (), regardless o
+000237f0: 6620 7468 6520 6e75 6d62 6572 206f 6620  f the number of 
+00023800: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+00023810: 2020 2020 7773 2e5f 6d65 6d6f 7279 5f75      ws._memory_u
+00023820: 6e6d 616e 6167 6564 5f6f 6c64 203d 206d  nmanaged_old = m
+00023830: 696e 286d 6170 2873 6563 6f6e 642c 2077  in(map(second, w
+00023840: 732e 5f6d 656d 6f72 795f 756e 6d61 6e61  s._memory_unmana
+00023850: 6765 645f 6869 7374 6f72 7929 290a 2020  ged_history)).  
+00023860: 2020 2020 2020 656c 6966 2073 697a 6520        elif size 
+00023870: 3c20 6d65 6d6f 7279 5f75 6e6d 616e 6167  < memory_unmanag
+00023880: 6564 5f6f 6c64 3a0a 2020 2020 2020 2020  ed_old:.        
+00023890: 2020 2020 7773 2e5f 6d65 6d6f 7279 5f75      ws._memory_u
+000238a0: 6e6d 616e 6167 6564 5f6f 6c64 203d 2073  nmanaged_old = s
+000238b0: 697a 650a 0a20 2020 2020 2020 2069 6620  ize..        if 
+000238c0: 686f 7374 5f69 6e66 6f3a 0a20 2020 2020  host_info:.     
+000238d0: 2020 2020 2020 2064 6820 3d20 7365 6c66         dh = self
+000238e0: 2e68 6f73 745f 696e 666f 2e73 6574 6465  .host_info.setde
+000238f0: 6661 756c 7428 686f 7374 2c20 7b7d 290a  fault(host, {}).
+00023900: 2020 2020 2020 2020 2020 2020 6468 2e75              dh.u
+00023910: 7064 6174 6528 686f 7374 5f69 6e66 6f29  pdate(host_info)
+00023920: 0a0a 2020 2020 2020 2020 6966 206e 6f77  ..        if now
+00023930: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
+00023940: 2e74 696d 655f 6465 6c61 7920 3d20 6c6f  .time_delay = lo
+00023950: 6361 6c5f 6e6f 7720 2d20 6e6f 770a 0a20  cal_now - now.. 
+00023960: 2020 2020 2020 2069 6620 7265 736f 7572         if resour
+00023970: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+00023980: 2073 656c 662e 6164 645f 7265 736f 7572   self.add_resour
+00023990: 6365 7328 776f 726b 6572 3d61 6464 7265  ces(worker=addre
+000239a0: 7373 2c20 7265 736f 7572 6365 733d 7265  ss, resources=re
+000239b0: 736f 7572 6365 7329 0a0a 2020 2020 2020  sources)..      
+000239c0: 2020 6966 2065 7874 656e 7369 6f6e 733a    if extensions:
+000239d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000239e0: 206e 616d 652c 2064 6174 6120 696e 2065   name, data in e
+000239f0: 7874 656e 7369 6f6e 732e 6974 656d 7328  xtensions.items(
+00023a00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00023a10: 2020 2073 656c 662e 6578 7465 6e73 696f     self.extensio
+00023a20: 6e73 5b6e 616d 655d 2e68 6561 7274 6265  ns[name].heartbe
+00023a30: 6174 2877 732c 2064 6174 6129 0a0a 2020  at(ws, data)..  
+00023a40: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
+00023a50: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00023a60: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
+00023a70: 2020 2020 2020 2022 7469 6d65 223a 206c         "time": l
+00023a80: 6f63 616c 5f6e 6f77 2c0a 2020 2020 2020  ocal_now,.      
+00023a90: 2020 2020 2020 2268 6561 7274 6265 6174        "heartbeat
+00023aa0: 2d69 6e74 6572 7661 6c22 3a20 6865 6172  -interval": hear
+00023ab0: 7462 6561 745f 696e 7465 7276 616c 286c  tbeat_interval(l
+00023ac0: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
+00023ad0: 292c 0a20 2020 2020 2020 207d 0a0a 2020  ),.        }..  
+00023ae0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+00023af0: 2020 6173 796e 6320 6465 6620 6164 645f    async def add_
+00023b00: 776f 726b 6572 280a 2020 2020 2020 2020  worker(.        
+00023b10: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
+00023b20: 6d6d 3a20 436f 6d6d 2c0a 2020 2020 2020  mm: Comm,.      
+00023b30: 2020 2a2c 0a20 2020 2020 2020 2061 6464    *,.        add
+00023b40: 7265 7373 3a20 7374 722c 0a20 2020 2020  ress: str,.     
+00023b50: 2020 2073 7461 7475 733a 2073 7472 2c0a     status: str,.
+00023b60: 2020 2020 2020 2020 7365 7276 6572 5f69          server_i
+00023b70: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
+00023b80: 6e74 6872 6561 6473 3a20 696e 742c 0a20  nthreads: int,. 
+00023b90: 2020 2020 2020 206e 616d 653a 2073 7472         name: str
+00023ba0: 2c0a 2020 2020 2020 2020 7265 736f 6c76  ,.        resolv
+00023bb0: 655f 6164 6472 6573 733a 2062 6f6f 6c20  e_address: bool 
+00023bc0: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+00023bd0: 6e6f 773a 2066 6c6f 6174 2c0a 2020 2020  now: float,.    
+00023be0: 2020 2020 7265 736f 7572 6365 733a 2064      resources: d
+00023bf0: 6963 745b 7374 722c 2066 6c6f 6174 5d2c  ict[str, float],
+00023c00: 0a20 2020 2020 2020 2023 2046 4958 4d45  .        # FIXME
+00023c10: 3a20 5468 6973 2069 7320 6e65 7665 7220  : This is never 
+00023c20: 7375 626d 6974 7465 6420 6279 2074 6865  submitted by the
+00023c30: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
+00023c40: 686f 7374 5f69 6e66 6f3a 204e 6f6e 6520  host_info: None 
+00023c50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00023c60: 6d65 6d6f 7279 5f6c 696d 6974 3a20 696e  memory_limit: in
+00023c70: 7420 7c20 4e6f 6e65 2c0a 2020 2020 2020  t | None,.      
+00023c80: 2020 6d65 7472 6963 733a 2064 6963 745b    metrics: dict[
+00023c90: 7374 722c 2041 6e79 5d2c 0a20 2020 2020  str, Any],.     
+00023ca0: 2020 2070 6964 3a20 696e 7420 3d20 302c     pid: int = 0,
+00023cb0: 0a20 2020 2020 2020 2073 6572 7669 6365  .        service
+00023cc0: 733a 2064 6963 745b 7374 722c 2069 6e74  s: dict[str, int
+00023cd0: 5d2c 0a20 2020 2020 2020 206c 6f63 616c  ],.        local
+00023ce0: 5f64 6972 6563 746f 7279 3a20 7374 722c  _directory: str,
+00023cf0: 0a20 2020 2020 2020 2076 6572 7369 6f6e  .        version
+00023d00: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
+00023d10: 5d2c 0a20 2020 2020 2020 206e 616e 6e79  ],.        nanny
+00023d20: 3a20 7374 722c 0a20 2020 2020 2020 2065  : str,.        e
+00023d30: 7874 7261 3a20 6469 6374 2c0a 2020 2020  xtra: dict,.    
+00023d40: 2020 2020 7374 696d 756c 7573 5f69 643a      stimulus_id:
+00023d50: 2073 7472 2c0a 2020 2020 2920 2d3e 204e   str,.    ) -> N
+00023d60: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00023d70: 4164 6420 6120 6e65 7720 776f 726b 6572  Add a new worker
+00023d80: 2074 6f20 7468 6520 636c 7573 7465 7222   to the cluster"
+00023d90: 2222 0a20 2020 2020 2020 2061 6464 7265  "".        addre
+00023da0: 7373 203d 2073 656c 662e 636f 6572 6365  ss = self.coerce
+00023db0: 5f61 6464 7265 7373 2861 6464 7265 7373  _address(address
+00023dc0: 2c20 7265 736f 6c76 655f 6164 6472 6573  , resolve_addres
+00023dd0: 7329 0a20 2020 2020 2020 2061 6464 7265  s).        addre
+00023de0: 7373 203d 206e 6f72 6d61 6c69 7a65 5f61  ss = normalize_a
+00023df0: 6464 7265 7373 2861 6464 7265 7373 290a  ddress(address).
+00023e00: 2020 2020 2020 2020 686f 7374 203d 2067          host = g
+00023e10: 6574 5f61 6464 7265 7373 5f68 6f73 7428  et_address_host(
+00023e20: 6164 6472 6573 7329 0a0a 2020 2020 2020  address)..      
+00023e30: 2020 6966 2061 6464 7265 7373 2069 6e20    if address in 
+00023e40: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
+00023e50: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00023e60: 5661 6c75 6545 7272 6f72 2822 576f 726b  ValueError("Work
+00023e70: 6572 2061 6c72 6561 6479 2065 7869 7374  er already exist
+00023e80: 7320 2573 2220 2520 6164 6472 6573 7329  s %s" % address)
+00023e90: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
+00023ea0: 6520 696e 2073 656c 662e 616c 6961 7365  e in self.aliase
+00023eb0: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
+00023ec0: 6f67 6765 722e 7761 726e 696e 6728 2257  ogger.warning("W
+00023ed0: 6f72 6b65 7220 7472 6965 6420 746f 2063  orker tried to c
+00023ee0: 6f6e 6e65 6374 2077 6974 6820 6120 6475  onnect with a du
+00023ef0: 706c 6963 6174 6520 6e61 6d65 3a20 2573  plicate name: %s
+00023f00: 222c 206e 616d 6529 0a20 2020 2020 2020  ", name).       
+00023f10: 2020 2020 206d 7367 203d 207b 0a20 2020       msg = {.   
+00023f20: 2020 2020 2020 2020 2020 2020 2022 7374               "st
+00023f30: 6174 7573 223a 2022 6572 726f 7222 2c0a  atus": "error",.
+00023f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f50: 226d 6573 7361 6765 223a 2022 6e61 6d65  "message": "name
+00023f60: 2074 616b 656e 2c20 2573 2220 2520 6e61   taken, %s" % na
+00023f70: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00023f80: 2020 2020 2274 696d 6522 3a20 7469 6d65      "time": time
+00023f90: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00023fa0: 7d0a 2020 2020 2020 2020 2020 2020 6177  }.            aw
+00023fb0: 6169 7420 636f 6d6d 2e77 7269 7465 286d  ait comm.write(m
+00023fc0: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
+00023fd0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+00023fe0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2861  self.log_event(a
+00023ff0: 6464 7265 7373 2c20 7b22 6163 7469 6f6e  ddress, {"action
+00024000: 223a 2022 6164 642d 776f 726b 6572 227d  ": "add-worker"}
+00024010: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
+00024020: 6f67 5f65 7665 6e74 2822 616c 6c22 2c20  og_event("all", 
+00024030: 7b22 6163 7469 6f6e 223a 2022 6164 642d  {"action": "add-
+00024040: 776f 726b 6572 222c 2022 776f 726b 6572  worker", "worker
+00024050: 223a 2061 6464 7265 7373 7d29 0a0a 2020  ": address})..  
+00024060: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
+00024070: 7273 5b61 6464 7265 7373 5d20 3d20 7773  rs[address] = ws
+00024080: 203d 2057 6f72 6b65 7253 7461 7465 280a   = WorkerState(.
+00024090: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+000240a0: 6573 733d 6164 6472 6573 732c 0a20 2020  ess=address,.   
+000240b0: 2020 2020 2020 2020 2073 7461 7475 733d           status=
+000240c0: 5374 6174 7573 2e6c 6f6f 6b75 705b 7374  Status.lookup[st
+000240d0: 6174 7573 5d2c 2020 2320 7479 7065 3a20  atus],  # type: 
+000240e0: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
+000240f0: 2020 2070 6964 3d70 6964 2c0a 2020 2020     pid=pid,.    
+00024100: 2020 2020 2020 2020 6e74 6872 6561 6473          nthreads
+00024110: 3d6e 7468 7265 6164 732c 0a20 2020 2020  =nthreads,.     
+00024120: 2020 2020 2020 206d 656d 6f72 795f 6c69         memory_li
+00024130: 6d69 743d 6d65 6d6f 7279 5f6c 696d 6974  mit=memory_limit
+00024140: 206f 7220 302c 0a20 2020 2020 2020 2020   or 0,.         
+00024150: 2020 206e 616d 653d 6e61 6d65 2c0a 2020     name=name,.  
+00024160: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
+00024170: 6469 7265 6374 6f72 793d 6c6f 6361 6c5f  directory=local_
+00024180: 6469 7265 6374 6f72 792c 0a20 2020 2020  directory,.     
+00024190: 2020 2020 2020 2073 6572 7669 6365 733d         services=
+000241a0: 7365 7276 6963 6573 2c0a 2020 2020 2020  services,.      
+000241b0: 2020 2020 2020 7665 7273 696f 6e73 3d76        versions=v
+000241c0: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
+000241d0: 2020 2020 206e 616e 6e79 3d6e 616e 6e79       nanny=nanny
+000241e0: 2c0a 2020 2020 2020 2020 2020 2020 6578  ,.            ex
+000241f0: 7472 613d 6578 7472 612c 0a20 2020 2020  tra=extra,.     
+00024200: 2020 2020 2020 2073 6572 7665 725f 6964         server_id
+00024210: 3d73 6572 7665 725f 6964 2c0a 2020 2020  =server_id,.    
+00024220: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+00024230: 723d 7365 6c66 2c0a 2020 2020 2020 2020  r=self,.        
+00024240: 290a 2020 2020 2020 2020 6966 2077 732e  ).        if ws.
+00024250: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+00024260: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
+00024270: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
+00024280: 6e67 2e61 6464 2877 7329 0a0a 2020 2020  ng.add(ws)..    
+00024290: 2020 2020 6468 203d 2073 656c 662e 686f      dh = self.ho
+000242a0: 7374 5f69 6e66 6f2e 6765 7428 686f 7374  st_info.get(host
+000242b0: 290a 2020 2020 2020 2020 6966 2064 6820  ).        if dh 
+000242c0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+000242d0: 2020 2020 2073 656c 662e 686f 7374 5f69       self.host_i
+000242e0: 6e66 6f5b 686f 7374 5d20 3d20 6468 203d  nfo[host] = dh =
+000242f0: 207b 7d0a 0a20 2020 2020 2020 2064 685f   {}..        dh_
+00024300: 6164 6472 6573 7365 7320 3d20 6468 2e67  addresses = dh.g
+00024310: 6574 2822 6164 6472 6573 7365 7322 290a  et("addresses").
+00024320: 2020 2020 2020 2020 6966 2064 685f 6164          if dh_ad
+00024330: 6472 6573 7365 7320 6973 204e 6f6e 653a  dresses is None:
+00024340: 0a20 2020 2020 2020 2020 2020 2064 685b  .            dh[
+00024350: 2261 6464 7265 7373 6573 225d 203d 2064  "addresses"] = d
+00024360: 685f 6164 6472 6573 7365 7320 3d20 7365  h_addresses = se
+00024370: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00024380: 6468 5b22 6e74 6872 6561 6473 225d 203d  dh["nthreads"] =
+00024390: 2030 0a0a 2020 2020 2020 2020 6468 5f61   0..        dh_a
+000243a0: 6464 7265 7373 6573 2e61 6464 2861 6464  ddresses.add(add
+000243b0: 7265 7373 290a 2020 2020 2020 2020 6468  ress).        dh
+000243c0: 5b22 6e74 6872 6561 6473 225d 202b 3d20  ["nthreads"] += 
+000243d0: 6e74 6872 6561 6473 0a0a 2020 2020 2020  nthreads..      
+000243e0: 2020 7365 6c66 2e74 6f74 616c 5f6e 7468    self.total_nth
+000243f0: 7265 6164 7320 2b3d 206e 7468 7265 6164  reads += nthread
+00024400: 730a 2020 2020 2020 2020 7365 6c66 2e61  s.        self.a
+00024410: 6c69 6173 6573 5b6e 616d 655d 203d 2061  liases[name] = a
+00024420: 6464 7265 7373 0a0a 2020 2020 2020 2020  ddress..        
+00024430: 7365 6c66 2e68 6561 7274 6265 6174 5f77  self.heartbeat_w
+00024440: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
+00024450: 2020 2061 6464 7265 7373 3d61 6464 7265     address=addre
+00024460: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+00024470: 7265 736f 6c76 655f 6164 6472 6573 733d  resolve_address=
+00024480: 7265 736f 6c76 655f 6164 6472 6573 732c  resolve_address,
+00024490: 0a20 2020 2020 2020 2020 2020 206e 6f77  .            now
+000244a0: 3d6e 6f77 2c0a 2020 2020 2020 2020 2020  =now,.          
+000244b0: 2020 7265 736f 7572 6365 733d 7265 736f    resources=reso
+000244c0: 7572 6365 732c 0a20 2020 2020 2020 2020  urces,.         
+000244d0: 2020 2068 6f73 745f 696e 666f 3d68 6f73     host_info=hos
+000244e0: 745f 696e 666f 2c0a 2020 2020 2020 2020  t_info,.        
+000244f0: 2020 2020 6d65 7472 6963 733d 6d65 7472      metrics=metr
+00024500: 6963 732c 0a20 2020 2020 2020 2029 0a0a  ics,.        )..
+00024510: 2020 2020 2020 2020 2320 446f 206e 6f74          # Do not
+00024520: 206e 6565 6420 746f 2061 646a 7573 7420   need to adjust 
+00024530: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
+00024540: 616e 6379 2061 7320 7365 6c66 2e6f 6363  ancy as self.occ
+00024550: 7570 616e 6379 5b77 735d 2063 616e 6e6f  upancy[ws] canno
+00024560: 740a 2020 2020 2020 2020 2320 6578 6973  t.        # exis
+00024570: 7420 6265 666f 7265 2074 6869 732e 0a20  t before this.. 
+00024580: 2020 2020 2020 2073 656c 662e 6368 6563         self.chec
+00024590: 6b5f 6964 6c65 5f73 6174 7572 6174 6564  k_idle_saturated
+000245a0: 2877 7329 0a0a 2020 2020 2020 2020 7365  (ws)..        se
+000245b0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
+000245c0: 6164 6472 6573 735d 203d 2042 6174 6368  address] = Batch
+000245d0: 6564 5365 6e64 2869 6e74 6572 7661 6c3d  edSend(interval=
+000245e0: 2235 6d73 222c 206c 6f6f 703d 7365 6c66  "5ms", loop=self
+000245f0: 2e6c 6f6f 7029 0a0a 2020 2020 2020 2020  .loop)..        
+00024600: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
+00024610: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
+00024620: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
+00024630: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00024640: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00024650: 6c74 203d 2070 6c75 6769 6e2e 6164 645f  lt = plugin.add_
+00024660: 776f 726b 6572 2873 6368 6564 756c 6572  worker(scheduler
+00024670: 3d73 656c 662c 2077 6f72 6b65 723d 6164  =self, worker=ad
+00024680: 6472 6573 7329 0a20 2020 2020 2020 2020  dress).         
+00024690: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
+000246a0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+000246b0: 2069 6e73 7065 6374 2e69 7361 7761 6974   inspect.isawait
+000246c0: 6162 6c65 2872 6573 756c 7429 3a0a 2020  able(result):.  
+000246d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000246e0: 2020 6177 6169 7420 7265 7375 6c74 0a20    await result. 
+000246f0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00024700: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00024710: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024720: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+00024730: 6f6e 2865 290a 0a20 2020 2020 2020 2069  on(e)..        i
+00024740: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
+00024750: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
+00024760: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00024770: 7472 616e 7369 7469 6f6e 7328 0a20 2020  transitions(.   
+00024780: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00024790: 662e 6275 6c6b 5f73 6368 6564 756c 655f  f.bulk_schedule_
+000247a0: 756e 7275 6e6e 6162 6c65 5f61 6674 6572  unrunnable_after
+000247b0: 5f61 6464 696e 675f 776f 726b 6572 2877  _adding_worker(w
+000247c0: 7329 2c20 7374 696d 756c 7573 5f69 640a  s), stimulus_id.
+000247d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000247e0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+000247f0: 7469 6d75 6c75 735f 7175 6575 655f 736c  timulus_queue_sl
+00024800: 6f74 735f 6d61 7962 655f 6f70 656e 6564  ots_maybe_opened
+00024810: 2873 7469 6d75 6c75 735f 6964 3d73 7469  (stimulus_id=sti
+00024820: 6d75 6c75 735f 6964 290a 0a20 2020 2020  mulus_id)..     
+00024830: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+00024840: 5265 6769 7374 6572 2077 6f72 6b65 7220  Register worker 
+00024850: 2573 222c 2077 7329 0a0a 2020 2020 2020  %s", ws)..      
+00024860: 2020 6d73 6720 3d20 7b0a 2020 2020 2020    msg = {.      
+00024870: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
+00024880: 224f 4b22 2c0a 2020 2020 2020 2020 2020  "OK",.          
+00024890: 2020 2274 696d 6522 3a20 7469 6d65 2829    "time": time()
+000248a0: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+000248b0: 6561 7274 6265 6174 2d69 6e74 6572 7661  eartbeat-interva
+000248c0: 6c22 3a20 6865 6172 7462 6561 745f 696e  l": heartbeat_in
+000248d0: 7465 7276 616c 286c 656e 2873 656c 662e  terval(len(self.
+000248e0: 776f 726b 6572 7329 292c 0a20 2020 2020  workers)),.     
+000248f0: 2020 2020 2020 2022 776f 726b 6572 2d70         "worker-p
+00024900: 6c75 6769 6e73 223a 2073 656c 662e 776f  lugins": self.wo
+00024910: 726b 6572 5f70 6c75 6769 6e73 2c0a 2020  rker_plugins,.  
+00024920: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00024930: 2076 6572 7369 6f6e 5f77 6172 6e69 6e67   version_warning
+00024940: 203d 2076 6572 7369 6f6e 5f6d 6f64 756c   = version_modul
+00024950: 652e 6572 726f 725f 6d65 7373 6167 6528  e.error_message(
+00024960: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
+00024970: 7369 6f6e 5f6d 6f64 756c 652e 6765 745f  sion_module.get_
+00024980: 7665 7273 696f 6e73 2829 2c0a 2020 2020  versions(),.    
+00024990: 2020 2020 2020 2020 7b77 3a20 7773 2e76          {w: ws.v
+000249a0: 6572 7369 6f6e 7320 666f 7220 772c 2077  ersions for w, w
+000249b0: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
+000249c0: 732e 6974 656d 7328 297d 2c0a 2020 2020  s.items()},.    
+000249d0: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+000249e0: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
+000249f0: 7572 6365 5f6e 616d 653d 7374 7228 7773  urce_name=str(ws
+00024a00: 2e73 6572 7665 725f 6964 292c 0a20 2020  .server_id),.   
+00024a10: 2020 2020 2029 0a20 2020 2020 2020 206d       ).        m
+00024a20: 7367 2e75 7064 6174 6528 7665 7273 696f  sg.update(versio
+00024a30: 6e5f 7761 726e 696e 6729 0a0a 2020 2020  n_warning)..    
+00024a40: 2020 2020 6177 6169 7420 636f 6d6d 2e77      await comm.w
+00024a50: 7269 7465 286d 7367 290a 2020 2020 2020  rite(msg).      
+00024a60: 2020 2320 5468 6973 2077 696c 6c20 6b65    # This will ke
+00024a70: 6570 2072 756e 6e69 6e67 2075 6e74 696c  ep running until
+00024a80: 2074 6865 2077 6f72 6b65 7220 6973 2072   the worker is r
+00024a90: 656d 6f76 6564 0a20 2020 2020 2020 2061  emoved.        a
+00024aa0: 7761 6974 2073 656c 662e 6861 6e64 6c65  wait self.handle
+00024ab0: 5f77 6f72 6b65 7228 636f 6d6d 2c20 6164  _worker(comm, ad
+00024ac0: 6472 6573 7329 0a0a 2020 2020 6173 796e  dress)..    asyn
+00024ad0: 6320 6465 6620 6164 645f 6e61 6e6e 7928  c def add_nanny(
+00024ae0: 7365 6c66 2920 2d3e 2064 6963 745b 7374  self) -> dict[st
+00024af0: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
+00024b00: 206d 7367 203d 207b 0a20 2020 2020 2020   msg = {.       
+00024b10: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
+00024b20: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
+00024b30: 2022 6e61 6e6e 792d 706c 7567 696e 7322   "nanny-plugins"
+00024b40: 3a20 7365 6c66 2e6e 616e 6e79 5f70 6c75  : self.nanny_plu
+00024b50: 6769 6e73 2c0a 2020 2020 2020 2020 7d0a  gins,.        }.
+00024b60: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+00024b70: 7367 0a0a 2020 2020 6465 6620 7570 6461  sg..    def upda
+00024b80: 7465 5f67 7261 7068 280a 2020 2020 2020  te_graph(.      
+00024b90: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00024ba0: 636c 6965 6e74 3a20 7374 722c 0a20 2020  client: str,.   
+00024bb0: 2020 2020 2067 7261 7068 5f68 6561 6465       graph_heade
+00024bc0: 723a 2064 6963 742c 0a20 2020 2020 2020  r: dict,.       
+00024bd0: 2067 7261 7068 5f66 7261 6d65 733a 206c   graph_frames: l
+00024be0: 6973 745b 6279 7465 735d 2c0a 2020 2020  ist[bytes],.    
+00024bf0: 2020 2020 6b65 7973 3a20 6c69 7374 5b73      keys: list[s
+00024c00: 7472 5d2c 0a20 2020 2020 2020 2069 6e74  tr],.        int
+00024c10: 6572 6e61 6c5f 7072 696f 7269 7479 3a20  ernal_priority: 
+00024c20: 6469 6374 5b73 7472 2c20 696e 745d 207c  dict[str, int] |
+00024c30: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
+00024c40: 7562 6d69 7474 696e 675f 7461 736b 3a20  ubmitting_task: 
+00024c50: 7374 7220 7c20 4e6f 6e65 2c0a 2020 2020  str | None,.    
+00024c60: 2020 2020 7573 6572 5f70 7269 6f72 6974      user_priorit
+00024c70: 793a 2069 6e74 207c 2064 6963 745b 7374  y: int | dict[st
+00024c80: 722c 2069 6e74 5d20 3d20 302c 0a20 2020  r, int] = 0,.   
+00024c90: 2020 2020 2061 6374 6f72 733a 2062 6f6f       actors: boo
+00024ca0: 6c20 7c20 6c69 7374 5b73 7472 5d20 7c20  l | list[str] | 
+00024cb0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00024cc0: 2020 2020 2066 6966 6f5f 7469 6d65 6f75       fifo_timeou
+00024cd0: 743a 2066 6c6f 6174 203d 2030 2e30 2c0a  t: float = 0.0,.
+00024ce0: 2020 2020 2020 2020 636f 6465 3a20 7374          code: st
+00024cf0: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+00024d00: 0a20 2020 2020 2020 2061 6e6e 6f74 6174  .        annotat
+00024d10: 696f 6e73 3a20 6469 6374 207c 204e 6f6e  ions: dict | Non
+00024d20: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00024d30: 2020 7374 696d 756c 7573 5f69 643a 2073    stimulus_id: s
+00024d40: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+00024d50: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
+00024d60: 0a20 2020 2020 2020 2073 7461 7274 203d  .        start =
+00024d70: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
+00024d80: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00024d90: 2023 2054 4f44 4f3a 2064 6573 6572 6961   # TODO: deseria
+00024da0: 6c69 7a61 7469 6f6e 202b 206d 6174 6572  lization + mater
+00024db0: 6961 6c69 7a61 7469 6f6e 2073 686f 756c  ialization shoul
+00024dc0: 6420 6265 206f 6666 6c6f 6164 6564 2074  d be offloaded t
+00024dd0: 6f20 610a 2020 2020 2020 2020 2020 2020  o a.            
+00024de0: 2320 7468 7265 6164 2073 696e 6365 2074  # thread since t
+00024df0: 6869 7320 6973 206e 6f6e 2d74 7269 7669  his is non-trivi
+00024e00: 616c 2063 6f6d 7075 7465 2074 696d 6520  al compute time 
+00024e10: 7468 6174 2062 6c6f 636b 7320 7468 650a  that blocks the.
+00024e20: 2020 2020 2020 2020 2020 2020 2320 6576              # ev
+00024e30: 656e 7420 6c6f 6f70 2e20 5468 6973 206c  ent loop. This l
+00024e40: 696b 656c 7920 7265 7175 6972 6573 2075  ikely requires u
+00024e50: 7320 746f 2075 7365 2061 206c 6f63 6b20  s to use a lock 
+00024e60: 7369 6e63 6520 7765 206e 6565 6420 746f  since we need to
+00024e70: 0a20 2020 2020 2020 2020 2020 2023 2067  .            # g
+00024e80: 7561 7261 6e74 6565 206f 7264 6572 696e  uarantee orderin
+00024e90: 6720 6f66 2075 7064 6174 655f 6772 6170  g of update_grap
+00024ea0: 6820 6361 6c6c 7320 2861 7320 6c6f 6e67  h calls (as long
+00024eb0: 2061 7320 7468 6572 6520 6973 206a 7573   as there is jus
+00024ec0: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+00024ed0: 6120 7369 6e67 6c65 206f 6666 6c6f 6164  a single offload
+00024ee0: 2074 6872 6561 642c 2074 6869 7320 6973   thread, this is
+00024ef0: 206e 6f74 2061 2070 726f 626c 656d 290a   not a problem).
+00024f00: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+00024f10: 2064 6973 7472 6962 7574 6564 2e70 726f   distributed.pro
+00024f20: 746f 636f 6c20 696d 706f 7274 2064 6573  tocol import des
+00024f30: 6572 6961 6c69 7a65 0a0a 2020 2020 2020  erialize..      
+00024f40: 2020 2020 2020 6772 6170 6820 3d20 6465        graph = de
+00024f50: 7365 7269 616c 697a 6528 6772 6170 685f  serialize(graph_
+00024f60: 6865 6164 6572 2c20 6772 6170 685f 6672  header, graph_fr
+00024f70: 616d 6573 292e 6461 7461 0a20 2020 2020  ames).data.     
+00024f80: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00024f90: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+00024fa0: 2020 2020 2020 6d73 6720 3d20 2222 225c        msg = """\
+00024fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024fc0: 2045 7272 6f72 2064 7572 696e 6720 6465   Error during de
+00024fd0: 7365 7269 616c 697a 6174 696f 6e20 6f66  serialization of
+00024fe0: 2074 6865 2074 6173 6b20 6772 6170 682e   the task graph.
+00024ff0: 2054 6869 7320 6672 6571 7565 6e74 6c79   This frequently
+00025000: 206f 6363 7572 7320 6966 2074 6865 2053   occurs if the S
+00025010: 6368 6564 756c 6572 2061 6e64 2043 6c69  cheduler and Cli
+00025020: 656e 7420 6861 7665 2064 6966 6665 7265  ent have differe
+00025030: 6e74 2065 6e76 6972 6f6e 6d65 6e74 732e  nt environments.
+00025040: 2046 6f72 206d 6f72 6520 696e 666f 726d   For more inform
+00025050: 6174 696f 6e2c 2073 6565 2068 7474 7073  ation, see https
+00025060: 3a2f 2f64 6f63 732e 6461 736b 2e6f 7267  ://docs.dask.org
+00025070: 2f65 6e2f 7374 6162 6c65 2f64 6570 6c6f  /en/stable/deplo
+00025080: 796d 656e 742d 636f 6e73 6964 6572 6174  yment-considerat
+00025090: 696f 6e73 2e68 746d 6c23 636f 6e73 6973  ions.html#consis
+000250a0: 7465 6e74 2d73 6f66 7477 6172 652d 656e  tent-software-en
+000250b0: 7669 726f 6e6d 656e 7473 0a20 2020 2020  vironments.     
+000250c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000250d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000250e0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000250f0: 6520 5275 6e74 696d 6545 7272 6f72 2874  e RuntimeError(t
+00025100: 6578 7477 7261 702e 6465 6465 6e74 286d  extwrap.dedent(m
+00025110: 7367 2929 2066 726f 6d20 650a 2020 2020  sg)) from e.    
+00025120: 2020 2020 2020 2020 6578 6365 7074 2052          except R
+00025130: 756e 7469 6d65 4572 726f 7220 6173 2065  untimeError as e
+00025140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00025150: 2020 6572 7220 3d20 6572 726f 725f 6d65    err = error_me
+00025160: 7373 6167 6528 6529 0a20 2020 2020 2020  ssage(e).       
+00025170: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+00025180: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
+00025190: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000251a0: 6c66 2e72 6570 6f72 7428 0a20 2020 2020  lf.report(.     
+000251b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000251c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000251d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000251e0: 2022 6f70 223a 2022 7461 736b 2d65 7272   "op": "task-err
+000251f0: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+00025200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025210: 2022 6b65 7922 3a20 6b65 792c 0a20 2020   "key": key,.   
+00025220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025230: 2020 2020 2020 2020 2022 6578 6365 7074           "except
+00025240: 696f 6e22 3a20 6572 725b 2265 7863 6570  ion": err["excep
+00025250: 7469 6f6e 225d 2c0a 2020 2020 2020 2020  tion"],.        
+00025260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025270: 2020 2020 2274 7261 6365 6261 636b 223a      "traceback":
+00025280: 2065 7272 5b22 7472 6163 6562 6163 6b22   err["traceback"
+00025290: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000252a0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000252b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000252c0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+000252d0: 7265 7475 726e 0a20 2020 2020 2020 2061  return.        a
+000252e0: 6e6e 6f74 6174 696f 6e73 203d 2061 6e6e  nnotations = ann
+000252f0: 6f74 6174 696f 6e73 206f 7220 7b7d 0a20  otations or {}. 
+00025300: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00025310: 616e 6365 2861 6e6e 6f74 6174 696f 6e73  ance(annotations
+00025320: 2c20 546f 5069 636b 6c65 293a 2020 2320  , ToPickle):  # 
+00025330: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
+00025340: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
+00025350: 3a20 7768 6174 2074 6865 2068 6563 6b3f  : what the heck?
+00025360: 0a20 2020 2020 2020 2020 2020 2061 6e6e  .            ann
+00025370: 6f74 6174 696f 6e73 203d 2061 6e6e 6f74  otations = annot
+00025380: 6174 696f 6e73 2e64 6174 6120 2023 2074  ations.data  # t
+00025390: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+000253a0: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
+000253b0: 3d20 7374 696d 756c 7573 5f69 6420 6f72  = stimulus_id or
+000253c0: 2066 2275 7064 6174 652d 6772 6170 682d   f"update-graph-
+000253d0: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
+000253e0: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
+000253f0: 6473 6b2c 0a20 2020 2020 2020 2020 2020  dsk,.           
+00025400: 2064 6570 656e 6465 6e63 6965 732c 0a20   dependencies,. 
+00025410: 2020 2020 2020 2020 2020 206c 6179 6572             layer
+00025420: 5f61 6e6e 6f74 6174 696f 6e73 2c0a 2020  _annotations,.  
+00025430: 2020 2020 2020 2020 2020 7072 655f 7374            pre_st
+00025440: 7269 6e67 6966 6965 645f 6b65 7973 2c0a  ringified_keys,.
+00025450: 2020 2020 2020 2020 2920 3d20 7365 6c66          ) = self
+00025460: 2e6d 6174 6572 6961 6c69 7a65 5f67 7261  .materialize_gra
+00025470: 7068 2867 7261 7068 290a 0a20 2020 2020  ph(graph)..     
+00025480: 2020 2072 6571 7565 7374 6564 5f6b 6579     requested_key
+00025490: 7320 3d20 7365 7428 6b65 7973 290a 2020  s = set(keys).  
+000254a0: 2020 2020 2020 6465 6c20 6b65 7973 0a20        del keys. 
+000254b0: 2020 2020 2020 2069 6620 6c65 6e28 6473         if len(ds
+000254c0: 6b29 203e 2031 3a0a 2020 2020 2020 2020  k) > 1:.        
+000254d0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+000254e0: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
+000254f0: 2020 2020 5b22 616c 6c22 2c20 636c 6965      ["all", clie
+00025500: 6e74 5d2c 207b 2261 6374 696f 6e22 3a20  nt], {"action": 
+00025510: 2275 7064 6174 655f 6772 6170 6822 2c20  "update_graph", 
+00025520: 2263 6f75 6e74 223a 206c 656e 2864 736b  "count": len(dsk
+00025530: 297d 0a20 2020 2020 2020 2020 2020 2029  )}.            )
+00025540: 0a20 2020 2020 2020 2073 656c 662e 5f70  .        self._p
+00025550: 6f70 5f6b 6e6f 776e 5f74 6173 6b73 2864  op_known_tasks(d
+00025560: 736b 2c20 6465 7065 6e64 656e 6369 6573  sk, dependencies
+00025570: 290a 0a20 2020 2020 2020 2069 6620 6c6f  )..        if lo
+00025580: 7374 5f6b 6579 7320 3a3d 2073 656c 662e  st_keys := self.
+00025590: 5f70 6f70 5f6c 6f73 745f 7461 736b 7328  _pop_lost_tasks(
+000255a0: 6473 6b2c 2064 6570 656e 6465 6e63 6965  dsk, dependencie
+000255b0: 732c 2072 6571 7565 7374 6564 5f6b 6579  s, requested_key
+000255c0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+000255d0: 7365 6c66 2e72 6570 6f72 7428 7b22 6f70  self.report({"op
+000255e0: 223a 2022 6361 6e63 656c 6c65 642d 6b65  ": "cancelled-ke
+000255f0: 7973 222c 2022 6b65 7973 223a 206c 6f73  ys", "keys": los
+00025600: 745f 6b65 7973 7d2c 2063 6c69 656e 743d  t_keys}, client=
+00025610: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
+00025620: 2020 2020 7365 6c66 2e63 6c69 656e 745f      self.client_
+00025630: 7265 6c65 6173 6573 5f6b 6579 7328 0a20  releases_keys(. 
+00025640: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00025650: 6579 733d 6c6f 7374 5f6b 6579 732c 2063  eys=lost_keys, c
+00025660: 6c69 656e 743d 636c 6965 6e74 2c20 7374  lient=client, st
+00025670: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+00025680: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
+00025690: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
+000256a0: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
+000256b0: 616e 6379 203e 2031 652d 3920 616e 6420  ancy > 1e-9 and 
+000256c0: 7365 6c66 2e63 6f6d 7075 7461 7469 6f6e  self.computation
+000256d0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
+000256e0: 2053 7469 6c6c 2077 6f72 6b69 6e67 206f   Still working o
+000256f0: 6e20 736f 6d65 7468 696e 672e 2041 7373  n something. Ass
+00025700: 6967 6e20 6e65 7720 7461 736b 7320 746f  ign new tasks to
+00025710: 2073 616d 6520 636f 6d70 7574 6174 696f   same computatio
+00025720: 6e0a 2020 2020 2020 2020 2020 2020 636f  n.            co
+00025730: 6d70 7574 6174 696f 6e20 3d20 7365 6c66  mputation = self
+00025740: 2e63 6f6d 7075 7461 7469 6f6e 735b 2d31  .computations[-1
+00025750: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
+00025760: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
+00025770: 7574 6174 696f 6e20 3d20 436f 6d70 7574  utation = Comput
+00025780: 6174 696f 6e28 290a 2020 2020 2020 2020  ation().        
+00025790: 2020 2020 7365 6c66 2e63 6f6d 7075 7461      self.computa
+000257a0: 7469 6f6e 732e 6170 7065 6e64 2863 6f6d  tions.append(com
+000257b0: 7075 7461 7469 6f6e 290a 0a20 2020 2020  putation)..     
+000257c0: 2020 2069 6620 636f 6465 3a20 2023 2061     if code:  # a
+000257d0: 6464 206e 6577 2063 6f64 6520 626c 6f63  dd new code bloc
+000257e0: 6b73 0a20 2020 2020 2020 2020 2020 2063  ks.            c
+000257f0: 6f6d 7075 7461 7469 6f6e 2e63 6f64 652e  omputation.code.
+00025800: 6164 6428 636f 6465 290a 2020 2020 2020  add(code).      
+00025810: 2020 6966 2061 6e6e 6f74 6174 696f 6e73    if annotations
+00025820: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00025830: 6d70 7574 6174 696f 6e2e 616e 6e6f 7461  mputation.annota
+00025840: 7469 6f6e 732e 7570 6461 7465 2861 6e6e  tions.update(ann
+00025850: 6f74 6174 696f 6e73 290a 0a20 2020 2020  otations)..     
+00025860: 2020 2072 756e 6e61 626c 652c 2074 6f75     runnable, tou
+00025870: 6368 6564 5f74 6173 6b73 2c20 6e65 775f  ched_tasks, new_
+00025880: 7461 736b 7320 3d20 7365 6c66 2e5f 6765  tasks = self._ge
+00025890: 6e65 7261 7465 5f74 6173 6b73 7461 7465  nerate_taskstate
+000258a0: 7328 0a20 2020 2020 2020 2020 2020 206b  s(.            k
+000258b0: 6579 733d 7265 7175 6573 7465 645f 6b65  eys=requested_ke
+000258c0: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
+000258d0: 6473 6b3d 6473 6b2c 0a20 2020 2020 2020  dsk=dsk,.       
+000258e0: 2020 2020 2064 6570 656e 6465 6e63 6965       dependencie
+000258f0: 733d 6465 7065 6e64 656e 6369 6573 2c0a  s=dependencies,.
+00025900: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
+00025910: 7574 6174 696f 6e3d 636f 6d70 7574 6174  utation=computat
+00025920: 696f 6e2c 0a20 2020 2020 2020 2029 0a20  ion,.        ). 
+00025930: 2020 2020 2020 2023 2046 4958 4d45 3a20         # FIXME: 
+00025940: 5468 6573 6520 2272 6573 6f6c 7665 645f  These "resolved_
+00025950: 616e 6e6f 7461 7469 6f6e 7322 2061 7265  annotations" are
+00025960: 2061 2062 6967 2064 7570 6c69 6361 7469   a big duplicati
+00025970: 6f6e 2061 6e64 2061 7265 206f 6e6c 790a  on and are only.
+00025980: 2020 2020 2020 2020 2320 7265 7175 6972          # requir
+00025990: 6564 2074 6f20 7361 7469 7366 7920 7468  ed to satisfy th
+000259a0: 6520 6375 7272 656e 7420 706c 7567 696e  e current plugin
+000259b0: 2041 5049 2e20 5468 6973 2073 686f 756c   API. This shoul
+000259c0: 6420 6265 0a20 2020 2020 2020 2023 2072  d be.        # r
+000259d0: 6563 6f6e 7369 6465 7265 642e 0a20 2020  econsidered..   
+000259e0: 2020 2020 2072 6573 6f6c 7665 645f 616e       resolved_an
+000259f0: 6e6f 7461 7469 6f6e 7320 3d20 7365 6c66  notations = self
+00025a00: 2e5f 7061 7273 655f 616e 645f 6170 706c  ._parse_and_appl
+00025a10: 795f 616e 6e6f 7461 7469 6f6e 7328 0a20  y_annotations(. 
+00025a20: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
+00025a30: 3d6e 6577 5f74 6173 6b73 2c0a 2020 2020  =new_tasks,.    
+00025a40: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
+00025a50: 6f6e 733d 616e 6e6f 7461 7469 6f6e 732c  ons=annotations,
+00025a60: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
+00025a70: 6572 5f61 6e6e 6f74 6174 696f 6e73 3d6c  er_annotations=l
+00025a80: 6179 6572 5f61 6e6e 6f74 6174 696f 6e73  ayer_annotations
+00025a90: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+00025aa0: 655f 7374 7269 6e67 6966 6965 645f 6b65  e_stringified_ke
+00025ab0: 7973 3d70 7265 5f73 7472 696e 6769 6669  ys=pre_stringifi
+00025ac0: 6564 5f6b 6579 732c 0a20 2020 2020 2020  ed_keys,.       
+00025ad0: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+00025ae0: 2e5f 7365 745f 7072 696f 7269 7469 6573  ._set_priorities
+00025af0: 280a 2020 2020 2020 2020 2020 2020 696e  (.            in
+00025b00: 7465 726e 616c 5f70 7269 6f72 6974 793d  ternal_priority=
+00025b10: 696e 7465 726e 616c 5f70 7269 6f72 6974  internal_priorit
+00025b20: 792c 0a20 2020 2020 2020 2020 2020 2073  y,.            s
+00025b30: 7562 6d69 7474 696e 675f 7461 736b 3d73  ubmitting_task=s
+00025b40: 7562 6d69 7474 696e 675f 7461 736b 2c0a  ubmitting_task,.
+00025b50: 2020 2020 2020 2020 2020 2020 7573 6572              user
+00025b60: 5f70 7269 6f72 6974 793d 7573 6572 5f70  _priority=user_p
+00025b70: 7269 6f72 6974 792c 0a20 2020 2020 2020  riority,.       
+00025b80: 2020 2020 2066 6966 6f5f 7469 6d65 6f75       fifo_timeou
+00025b90: 743d 6669 666f 5f74 696d 656f 7574 2c0a  t=fifo_timeout,.
+00025ba0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00025bb0: 743d 7374 6172 742c 0a20 2020 2020 2020  t=start,.       
+00025bc0: 2020 2020 2064 736b 3d64 736b 2c0a 2020       dsk=dsk,.  
+00025bd0: 2020 2020 2020 2020 2020 7461 736b 733d            tasks=
+00025be0: 7275 6e6e 6162 6c65 2c0a 2020 2020 2020  runnable,.      
+00025bf0: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
+00025c00: 6573 3d64 6570 656e 6465 6e63 6965 732c  es=dependencies,
+00025c10: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00025c20: 2020 2020 7365 6c66 2e63 6c69 656e 745f      self.client_
+00025c30: 6465 7369 7265 735f 6b65 7973 286b 6579  desires_keys(key
+00025c40: 733d 7265 7175 6573 7465 645f 6b65 7973  s=requested_keys
+00025c50: 2c20 636c 6965 6e74 3d63 6c69 656e 7429  , client=client)
+00025c60: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
+00025c70: 6163 746f 7273 0a20 2020 2020 2020 2069  actors.        i
+00025c80: 6620 6163 746f 7273 2069 7320 5472 7565  f actors is True
+00025c90: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
+00025ca0: 746f 7273 203d 206c 6973 7428 7265 7175  tors = list(requ
+00025cb0: 6573 7465 645f 6b65 7973 290a 2020 2020  ested_keys).    
+00025cc0: 2020 2020 666f 7220 6163 746f 7220 696e      for actor in
+00025cd0: 2061 6374 6f72 7320 6f72 205b 5d3a 0a20   actors or []:. 
+00025ce0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+00025cf0: 7365 6c66 2e74 6173 6b73 5b61 6374 6f72  self.tasks[actor
+00025d00: 5d0a 2020 2020 2020 2020 2020 2020 7473  ].            ts
+00025d10: 2e61 6374 6f72 203d 2054 7275 650a 0a20  .actor = True.. 
+00025d20: 2020 2020 2020 2023 2043 6f6d 7075 7465         # Compute
+00025d30: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00025d40: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00025d50: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00025d60: 207b 7d0a 2020 2020 2020 2020 7072 696f   {}.        prio
+00025d70: 7269 7479 203d 2064 6963 7428 290a 2020  rity = dict().  
+00025d80: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+00025d90: 736f 7274 6564 280a 2020 2020 2020 2020  sorted(.        
+00025da0: 2020 2020 7275 6e6e 6162 6c65 2c0a 2020      runnable,.  
+00025db0: 2020 2020 2020 2020 2020 6b65 793d 6f70            key=op
+00025dc0: 6572 6174 6f72 2e61 7474 7267 6574 7465  erator.attrgette
+00025dd0: 7228 2270 7269 6f72 6974 7922 292c 0a20  r("priority"),. 
+00025de0: 2020 2020 2020 2020 2020 2072 6576 6572             rever
+00025df0: 7365 3d54 7275 652c 0a20 2020 2020 2020  se=True,.       
+00025e00: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00025e10: 6173 7365 7274 2074 732e 7072 696f 7269  assert ts.priori
+00025e20: 7479 2020 2320 6d79 7079 0a20 2020 2020  ty  # mypy.     
+00025e30: 2020 2020 2020 2070 7269 6f72 6974 795b         priority[
+00025e40: 7473 2e6b 6579 5d20 3d20 7473 2e70 7269  ts.key] = ts.pri
+00025e50: 6f72 6974 790a 2020 2020 2020 2020 2020  ority.          
+00025e60: 2020 6173 7365 7274 2074 732e 7275 6e5f    assert ts.run_
+00025e70: 7370 6563 0a20 2020 2020 2020 2020 2020  spec.           
+00025e80: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
+00025e90: 2272 656c 6561 7365 6422 3a0a 2020 2020  "released":.    
+00025ea0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00025eb0: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
+00025ec0: 6579 5d20 3d20 2277 6169 7469 6e67 220a  ey] = "waiting".
+00025ed0: 0a20 2020 2020 2020 2066 6f72 2074 7320  .        for ts 
+00025ee0: 696e 2072 756e 6e61 626c 653a 0a20 2020  in runnable:.   
+00025ef0: 2020 2020 2020 2020 2066 6f72 2064 7473           for dts
+00025f00: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+00025f10: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00025f20: 2020 2020 2069 6620 6474 732e 6578 6365       if dts.exce
+00025f30: 7074 696f 6e5f 626c 616d 653a 0a20 2020  ption_blame:.   
+00025f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025f50: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
+00025f60: 616d 6520 3d20 6474 732e 6578 6365 7074  ame = dts.except
+00025f70: 696f 6e5f 626c 616d 650a 2020 2020 2020  ion_blame.      
+00025f80: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00025f90: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
+00025fa0: 2e6b 6579 5d20 3d20 2265 7272 6564 220a  .key] = "erred".
+00025fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025fc0: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+00025fd0: 2020 2066 6f72 2070 6c75 6769 6e20 696e     for plugin in
+00025fe0: 206c 6973 7428 7365 6c66 2e70 6c75 6769   list(self.plugi
+00025ff0: 6e73 2e76 616c 7565 7328 2929 3a0a 2020  ns.values()):.  
+00026000: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00026010: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00026020: 6c75 6769 6e2e 7570 6461 7465 5f67 7261  lugin.update_gra
+00026030: 7068 280a 2020 2020 2020 2020 2020 2020  ph(.            
+00026040: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00026050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026060: 2020 636c 6965 6e74 3d63 6c69 656e 742c    client=client,
+00026070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026080: 2020 2020 2074 6173 6b73 3d5b 7473 2e6b       tasks=[ts.k
+00026090: 6579 2066 6f72 2074 7320 696e 2074 6f75  ey for ts in tou
+000260a0: 6368 6564 5f74 6173 6b73 5d2c 0a20 2020  ched_tasks],.   
+000260b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000260c0: 206b 6579 733d 7265 7175 6573 7465 645f   keys=requested_
+000260d0: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
+000260e0: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
+000260f0: 656e 6369 6573 3d64 6570 656e 6465 6e63  encies=dependenc
+00026100: 6965 732c 0a20 2020 2020 2020 2020 2020  ies,.           
+00026110: 2020 2020 2020 2020 2061 6e6e 6f74 6174           annotat
+00026120: 696f 6e73 3d72 6573 6f6c 7665 645f 616e  ions=resolved_an
+00026130: 6e6f 7461 7469 6f6e 732c 0a20 2020 2020  notations,.     
+00026140: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00026150: 7269 6f72 6974 793d 7072 696f 7269 7479  riority=priority
+00026160: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00026170: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00026180: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00026190: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+000261a0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
+000261b0: 6365 7074 696f 6e28 6529 0a0a 2020 2020  ception(e)..    
+000261c0: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
+000261d0: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
+000261e0: 696f 6e73 2c20 7374 696d 756c 7573 5f69  ions, stimulus_i
+000261f0: 6429 0a0a 2020 2020 2020 2020 666f 7220  d)..        for 
+00026200: 7473 2069 6e20 746f 7563 6865 645f 7461  ts in touched_ta
+00026210: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+00026220: 2069 6620 7473 2e73 7461 7465 2069 6e20   if ts.state in 
+00026230: 2822 6d65 6d6f 7279 222c 2022 6572 7265  ("memory", "erre
+00026240: 6422 293a 0a20 2020 2020 2020 2020 2020  d"):.           
+00026250: 2020 2020 2073 656c 662e 7265 706f 7274       self.report
+00026260: 5f6f 6e5f 6b65 7928 7473 3d74 732c 2063  _on_key(ts=ts, c
+00026270: 6c69 656e 743d 636c 6965 6e74 290a 0a20  lient=client).. 
+00026280: 2020 2020 2020 2065 6e64 203d 2074 696d         end = tim
+00026290: 6528 290a 2020 2020 2020 2020 7365 6c66  e().        self
+000262a0: 2e64 6967 6573 745f 6d65 7472 6963 2822  .digest_metric("
+000262b0: 7570 6461 7465 2d67 7261 7068 2d64 7572  update-graph-dur
+000262c0: 6174 696f 6e22 2c20 656e 6420 2d20 7374  ation", end - st
+000262d0: 6172 7429 0a0a 2020 2020 6465 6620 5f67  art)..    def _g
+000262e0: 656e 6572 6174 655f 7461 736b 7374 6174  enerate_taskstat
+000262f0: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
+00026300: 2c20 6b65 7973 3a20 7365 745b 7374 725d  , keys: set[str]
+00026310: 2c20 6473 6b3a 2064 6963 742c 2064 6570  , dsk: dict, dep
+00026320: 656e 6465 6e63 6965 733a 2064 6963 742c  endencies: dict,
+00026330: 2063 6f6d 7075 7461 7469 6f6e 3a20 436f   computation: Co
+00026340: 6d70 7574 6174 696f 6e0a 2020 2020 2920  mputation.    ) 
+00026350: 2d3e 2074 7570 6c65 3a0a 2020 2020 2020  -> tuple:.      
+00026360: 2020 2320 4765 7420 6f72 2063 7265 6174    # Get or creat
+00026370: 6520 7461 736b 2073 7461 7465 730a 2020  e task states.  
+00026380: 2020 2020 2020 7275 6e6e 6162 6c65 203d        runnable =
+00026390: 205b 5d0a 2020 2020 2020 2020 6e65 775f   [].        new_
+000263a0: 7461 736b 7320 3d20 5b5d 0a20 2020 2020  tasks = [].     
+000263b0: 2020 2073 7461 636b 203d 206c 6973 7428     stack = list(
+000263c0: 6b65 7973 290a 2020 2020 2020 2020 7461  keys).        ta
+000263d0: 736b 7320 3d20 5b5d 0a20 2020 2020 2020  sks = [].       
+000263e0: 2074 6f75 6368 6564 5f6b 6579 7320 3d20   touched_keys = 
+000263f0: 7365 7428 290a 2020 2020 2020 2020 746f  set().        to
+00026400: 7563 6865 645f 7461 736b 7320 3d20 5b5d  uched_tasks = []
+00026410: 0a20 2020 2020 2020 2077 6869 6c65 2073  .        while s
+00026420: 7461 636b 3a0a 2020 2020 2020 2020 2020  tack:.          
+00026430: 2020 6b20 3d20 7374 6163 6b2e 706f 7028    k = stack.pop(
+00026440: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00026450: 206b 2069 6e20 746f 7563 6865 645f 6b65   k in touched_ke
+00026460: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00026470: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00026480: 2020 2020 2020 2020 2023 2058 5858 2048           # XXX H
+00026490: 6176 6520 6120 6d65 7468 6f64 2067 6574  ave a method get
+000264a0: 5f74 6173 6b5f 7374 6174 6528 7365 6c66  _task_state(self
+000264b0: 2c20 6b29 203f 0a20 2020 2020 2020 2020  , k) ?.         
+000264c0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+000264d0: 6b73 2e67 6574 286b 290a 2020 2020 2020  ks.get(k).      
+000264e0: 2020 2020 2020 7461 736b 732e 6170 7065        tasks.appe
+000264f0: 6e64 2874 7329 0a20 2020 2020 2020 2020  nd(ts).         
+00026500: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
+00026510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026520: 2020 7473 203d 2073 656c 662e 6e65 775f    ts = self.new_
+00026530: 7461 736b 286b 2c20 6473 6b2e 6765 7428  task(k, dsk.get(
+00026540: 6b29 2c20 2272 656c 6561 7365 6422 2c20  k), "released", 
+00026550: 636f 6d70 7574 6174 696f 6e3d 636f 6d70  computation=comp
+00026560: 7574 6174 696f 6e29 0a20 2020 2020 2020  utation).       
+00026570: 2020 2020 2020 2020 206e 6577 5f74 6173           new_tas
+00026580: 6b73 2e61 7070 656e 6428 7473 290a 2020  ks.append(ts).  
+00026590: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+000265a0: 6f74 2074 732e 7275 6e5f 7370 6563 3a0a  ot ts.run_spec:.
+000265b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000265c0: 7473 2e72 756e 5f73 7065 6320 3d20 6473  ts.run_spec = ds
+000265d0: 6b2e 6765 7428 6b29 0a0a 2020 2020 2020  k.get(k)..      
+000265e0: 2020 2020 2020 6966 2074 732e 7275 6e5f        if ts.run_
+000265f0: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
+00026600: 2020 2020 2020 7275 6e6e 6162 6c65 2e61        runnable.a
+00026610: 7070 656e 6428 7473 290a 2020 2020 2020  ppend(ts).      
+00026620: 2020 2020 2020 746f 7563 6865 645f 6b65        touched_ke
+00026630: 7973 2e61 6464 286b 290a 2020 2020 2020  ys.add(k).      
+00026640: 2020 2020 2020 746f 7563 6865 645f 7461        touched_ta
+00026650: 736b 732e 6170 7065 6e64 2874 7329 0a20  sks.append(ts). 
+00026660: 2020 2020 2020 2020 2020 2073 7461 636b             stack
+00026670: 2e65 7874 656e 6428 6465 7065 6e64 656e  .extend(dependen
+00026680: 6369 6573 2e67 6574 286b 2c20 2829 2929  cies.get(k, ()))
+00026690: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
+000266a0: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
+000266b0: 2020 2020 2066 6f72 206b 6579 2c20 6465       for key, de
+000266c0: 7073 2069 6e20 6465 7065 6e64 656e 6369  ps in dependenci
+000266d0: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
+000266e0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+000266f0: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
+00026700: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00026710: 7473 2069 7320 4e6f 6e65 206f 7220 7473  ts is None or ts
+00026720: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+00026730: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00026740: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00026750: 2020 2020 666f 7220 6465 7020 696e 2064      for dep in d
+00026760: 6570 733a 0a20 2020 2020 2020 2020 2020  eps:.           
+00026770: 2020 2020 2064 7473 203d 2073 656c 662e       dts = self.
+00026780: 7461 736b 735b 6465 705d 0a20 2020 2020  tasks[dep].     
+00026790: 2020 2020 2020 2020 2020 2074 732e 6164             ts.ad
+000267a0: 645f 6465 7065 6e64 656e 6379 2864 7473  d_dependency(dts
+000267b0: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
+000267c0: 6e28 746f 7563 6865 645f 7461 736b 7329  n(touched_tasks)
+000267d0: 203c 206c 656e 286b 6579 7329 3a0a 2020   < len(keys):.  
+000267e0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000267f0: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
+00026800: 2020 2020 2020 2022 5375 626d 6974 7465         "Submitte
+00026810: 6420 6772 6170 6820 7769 7468 206c 656e  d graph with len
+00026820: 6774 6820 2573 2062 7574 2072 6571 7565  gth %s but reque
+00026830: 7374 6564 2067 7261 7068 206f 6e6c 7920  sted graph only 
+00026840: 696e 636c 7564 6573 2025 7320 6b65 7973  includes %s keys
+00026850: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00026860: 2020 206c 656e 2874 6f75 6368 6564 5f74     len(touched_t
+00026870: 6173 6b73 292c 0a20 2020 2020 2020 2020  asks),.         
+00026880: 2020 2020 2020 206c 656e 286b 6579 7329         len(keys)
+00026890: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000268a0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+000268b0: 756e 6e61 626c 652c 2074 6f75 6368 6564  unnable, touched
+000268c0: 5f74 6173 6b73 2c20 6e65 775f 7461 736b  _tasks, new_task
+000268d0: 730a 0a20 2020 2064 6566 205f 7061 7273  s..    def _pars
+000268e0: 655f 616e 645f 6170 706c 795f 616e 6e6f  e_and_apply_anno
+000268f0: 7461 7469 6f6e 7328 0a20 2020 2020 2020  tations(.       
+00026900: 2073 656c 662c 0a20 2020 2020 2020 2074   self,.        t
+00026910: 6173 6b73 3a20 4974 6572 6162 6c65 5b54  asks: Iterable[T
+00026920: 6173 6b53 7461 7465 5d2c 0a20 2020 2020  askState],.     
+00026930: 2020 2061 6e6e 6f74 6174 696f 6e73 3a20     annotations: 
+00026940: 6469 6374 2c0a 2020 2020 2020 2020 6c61  dict,.        la
+00026950: 7965 725f 616e 6e6f 7461 7469 6f6e 733a  yer_annotations:
+00026960: 2064 6963 745b 7374 722c 2064 6963 745d   dict[str, dict]
+00026970: 2c0a 2020 2020 2020 2020 7072 655f 7374  ,.        pre_st
+00026980: 7269 6e67 6966 6965 645f 6b65 7973 3a20  ringified_keys: 
+00026990: 6469 6374 5b48 6173 6861 626c 652c 2073  dict[Hashable, s
+000269a0: 7472 5d2c 0a20 2020 2029 202d 3e20 6469  tr],.    ) -> di
+000269b0: 6374 5b73 7472 2c20 6469 6374 5b73 7472  ct[str, dict[str
+000269c0: 2c20 416e 795d 5d3a 0a20 2020 2020 2020  , Any]]:.       
+000269d0: 2022 2222 4170 706c 7920 7468 6520 7072   """Apply the pr
+000269e0: 6f76 6964 6564 2061 6e6e 6f74 6174 696f  ovided annotatio
+000269f0: 6e73 2074 6f20 7468 6520 7072 6f76 6964  ns to the provid
+00026a00: 6564 2060 5461 736b 5374 6174 6560 206f  ed `TaskState` o
+00026a10: 626a 6563 7473 2e0a 0a20 2020 2020 2020  bjects...       
+00026a20: 2054 6865 2072 6177 2061 6e6e 6f74 6174   The raw annotat
+00026a30: 696f 6e73 2077 696c 6c20 6265 2073 746f  ions will be sto
+00026a40: 7265 6420 696e 2074 6865 2060 616e 6e6f  red in the `anno
+00026a50: 7461 7469 6f6e 7360 2061 7474 7269 6275  tations` attribu
+00026a60: 7465 2e0a 0a20 2020 2020 2020 204c 6179  te...        Lay
+00026a70: 6572 202f 206b 6579 2073 7065 6369 6669  er / key specifi
+00026a80: 6320 616e 6e6f 7461 7469 6f6e 7320 7769  c annotations wi
+00026a90: 6c6c 2074 616b 6520 7072 6563 6564 656e  ll take preceden
+00026aa0: 6365 206f 7665 7220 676c 6f62 616c 202f  ce over global /
+00026ab0: 2067 656e 6572 6963 2061 6e6e 6f74 6174   generic annotat
+00026ac0: 696f 6e73 2e0a 0a20 2020 2020 2020 2050  ions...        P
+00026ad0: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+00026ae0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00026af0: 2020 2020 2074 6173 6b73 203a 2049 7465       tasks : Ite
+00026b00: 7261 626c 655b 5461 736b 5374 6174 655d  rable[TaskState]
+00026b10: 0a20 2020 2020 2020 2020 2020 205f 6465  .            _de
+00026b20: 7363 7269 7074 696f 6e5f 0a20 2020 2020  scription_.     
+00026b30: 2020 2061 6e6e 6f74 6174 696f 6e73 203a     annotations :
+00026b40: 2064 6963 740a 2020 2020 2020 2020 2020   dict.          
+00026b50: 2020 5f64 6573 6372 6970 7469 6f6e 5f0a    _description_.
+00026b60: 2020 2020 2020 2020 6c61 7965 725f 616e          layer_an
+00026b70: 6e6f 7461 7469 6f6e 7320 3a20 6469 6374  notations : dict
+00026b80: 5b73 7472 2c20 6469 6374 5d0a 2020 2020  [str, dict].    
+00026b90: 2020 2020 2020 2020 5f64 6573 6372 6970          _descrip
+00026ba0: 7469 6f6e 5f0a 0a20 2020 2020 2020 2052  tion_..        R
+00026bb0: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+00026bc0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2072  ------.        r
+00026bd0: 6573 6f6c 7665 645f 616e 6e6f 7461 7469  esolved_annotati
+00026be0: 6f6e 733a 2064 6963 740a 2020 2020 2020  ons: dict.      
+00026bf0: 2020 2020 2020 4120 6d61 7070 696e 6720        A mapping 
+00026c00: 6f66 2061 6c6c 2072 6573 6f6c 7665 6420  of all resolved 
+00026c10: 616e 6e6f 7461 7469 6f6e 7320 696e 2074  annotations in t
+00026c20: 6865 2066 6f72 6d61 743a 3a0a 0a20 2020  he format::..   
+00026c30: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00026c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c50: 2020 2022 616e 6e6f 7461 7469 6f6e 223a     "annotation":
+00026c60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00026c70: 2020 2020 2020 2020 2020 2022 6b65 7922             "key"
+00026c80: 3a20 7661 6c75 652c 0a20 2020 2020 2020  : value,.       
+00026c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ca0: 202e 2e2e 0a20 2020 2020 2020 2020 2020   ....           
+00026cb0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+00026cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026cd0: 2e2e 2e0a 2020 2020 2020 2020 2020 2020  ....            
+00026ce0: 2020 2020 7d0a 2020 2020 2020 2020 2222      }.        ""
+00026cf0: 220a 2020 2020 2020 2020 7265 736f 6c76  ".        resolv
+00026d00: 6564 5f61 6e6e 6f74 6174 696f 6e73 3a20  ed_annotations: 
+00026d10: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
+00026d20: 7472 2c20 416e 795d 5d20 3d20 6465 6661  tr, Any]] = defa
+00026d30: 756c 7464 6963 7428 6469 6374 290a 2020  ultdict(dict).  
+00026d40: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+00026d50: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+00026d60: 2020 206b 6579 203d 2074 732e 6b65 790a     key = ts.key.
+00026d70: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00026d80: 6973 2063 6f75 6c64 2062 6520 6120 7479  is could be a ty
+00026d90: 7065 6420 6469 6374 0a20 2020 2020 2020  ped dict.       
+00026da0: 2020 2020 2069 6620 6e6f 7420 616e 6e6f       if not anno
+00026db0: 7461 7469 6f6e 7320 616e 6420 6b65 7920  tations and key 
+00026dc0: 6e6f 7420 696e 206c 6179 6572 5f61 6e6e  not in layer_ann
+00026dd0: 6f74 6174 696f 6e73 3a0a 2020 2020 2020  otations:.      
+00026de0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00026df0: 7565 0a20 2020 2020 2020 2020 2020 206f  ue.            o
+00026e00: 7574 203d 2061 6e6e 6f74 6174 696f 6e73  ut = annotations
+00026e10: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+00026e20: 2020 2020 6f75 742e 7570 6461 7465 286c      out.update(l
+00026e30: 6179 6572 5f61 6e6e 6f74 6174 696f 6e73  ayer_annotations
+00026e40: 2e67 6574 286b 6579 2c20 7b7d 2929 0a20  .get(key, {})). 
+00026e50: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+00026e60: 6e6e 6f74 2c20 7661 6c75 6520 696e 206f  nnot, value in o
+00026e70: 7574 2e69 7465 6d73 2829 3a0a 2020 2020  ut.items():.    
+00026e80: 2020 2020 2020 2020 2020 2020 2320 506f              # Po
+00026e90: 7020 7468 6520 6b65 7920 7369 6e63 6520  p the key since 
+00026ea0: 6e61 6d65 7320 646f 6e27 7420 616c 7761  names don't alwa
+00026eb0: 7973 206d 6174 6368 2061 7474 7269 6275  ys match attribu
+00026ec0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+00026ed0: 2020 2020 6966 2063 616c 6c61 626c 6528      if callable(
+00026ee0: 7661 6c75 6529 3a0a 2020 2020 2020 2020  value):.        
+00026ef0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+00026f00: 6520 3d20 7661 6c75 6528 7072 655f 7374  e = value(pre_st
+00026f10: 7269 6e67 6966 6965 645f 6b65 7973 5b6b  ringified_keys[k
+00026f20: 6579 5d29 0a20 2020 2020 2020 2020 2020  ey]).           
+00026f30: 2020 2020 206f 7574 5b61 6e6e 6f74 5d20       out[annot] 
+00026f40: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
+00026f50: 2020 2020 2020 2020 7265 736f 6c76 6564          resolved
+00026f60: 5f61 6e6e 6f74 6174 696f 6e73 5b61 6e6e  _annotations[ann
+00026f70: 6f74 5d5b 6b65 795d 203d 2076 616c 7565  ot][key] = value
+00026f80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00026f90: 2020 6966 2061 6e6e 6f74 2069 6e20 2822    if annot in ("
+00026fa0: 7265 7374 7269 6374 696f 6e73 222c 2022  restrictions", "
+00026fb0: 776f 726b 6572 7322 293a 0a20 2020 2020  workers"):.     
+00026fc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00026fd0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00026fe0: 2876 616c 7565 2c20 286c 6973 742c 2074  (value, (list, t
+00026ff0: 7570 6c65 2c20 7365 7429 293a 0a20 2020  uple, set)):.   
+00027000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027010: 2020 2020 2076 616c 7565 203d 205b 7661       value = [va
+00027020: 6c75 655d 0a20 2020 2020 2020 2020 2020  lue].           
+00027030: 2020 2020 2020 2020 2068 6f73 745f 7265           host_re
+00027040: 7374 7269 6374 696f 6e73 203d 2073 6574  strictions = set
+00027050: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00027060: 2020 2020 2020 2077 6f72 6b65 725f 7265         worker_re
+00027070: 7374 7269 6374 696f 6e73 203d 2073 6574  strictions = set
+00027080: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00027090: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+000270a0: 7661 6c75 653a 0a20 2020 2020 2020 2020  value:.         
+000270b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000270c0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
 000270d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000270e0: 2020 2020 2020 2020 7473 2e68 6f73 745f          ts.host_
-000270f0: 7265 7374 7269 6374 696f 6e73 2e61 6464  restrictions.add
-00027100: 2877 290a 2020 2020 2020 2020 2020 2020  (w).            
-00027110: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00027120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027130: 2020 2020 2020 7473 2e77 6f72 6b65 725f        ts.worker_
-00027140: 7265 7374 7269 6374 696f 6e73 2e61 6464  restrictions.add
-00027150: 2877 290a 0a20 2020 2020 2020 2020 2020  (w)..           
-00027160: 2069 6620 6c6f 6f73 655f 7265 7374 7269   if loose_restri
-00027170: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
-00027180: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-00027190: 206c 6f6f 7365 5f72 6573 7472 6963 7469   loose_restricti
-000271a0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-000271b0: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-000271c0: 6c66 2e74 6173 6b73 5b6b 5d0a 2020 2020  lf.tasks[k].    
+000270e0: 7720 3d20 7365 6c66 2e63 6f65 7263 655f  w = self.coerce_
+000270f0: 6164 6472 6573 7328 7729 0a20 2020 2020  address(w).     
+00027100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027110: 2020 2065 7863 6570 7420 5661 6c75 6545     except ValueE
+00027120: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00027130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027140: 2020 2320 4e6f 7420 6120 7661 6c69 6420    # Not a valid 
+00027150: 6164 6472 6573 732c 2062 7574 2070 6572  address, but per
+00027160: 6861 7073 2069 7427 7320 6120 686f 7374  haps it's a host
+00027170: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
+00027180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027190: 2068 6f73 745f 7265 7374 7269 6374 696f   host_restrictio
+000271a0: 6e73 2e61 6464 2877 290a 2020 2020 2020  ns.add(w).      
+000271b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000271c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
 000271d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000271e0: 7473 2e6c 6f6f 7365 5f72 6573 7472 6963  ts.loose_restric
-000271f0: 7469 6f6e 7320 3d20 5472 7565 0a0a 2020  tions = True..  
-00027200: 2020 2020 2020 6966 2072 6573 6f75 7263        if resourc
-00027210: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00027220: 666f 7220 6b2c 2076 2069 6e20 7265 736f  for k, v in reso
-00027230: 7572 6365 732e 6974 656d 7328 293a 0a20  urces.items():. 
-00027240: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00027250: 6620 7620 6973 204e 6f6e 653a 0a20 2020  f v is None:.   
-00027260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027270: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00027280: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00027290: 2069 7369 6e73 7461 6e63 6528 762c 2064   isinstance(v, d
-000272a0: 6963 7429 0a20 2020 2020 2020 2020 2020  ict).           
-000272b0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-000272c0: 6173 6b73 2e67 6574 286b 290a 2020 2020  asks.get(k).    
-000272d0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-000272e0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-000272f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00027300: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00027310: 2020 2020 2020 2020 7473 2e72 6573 6f75          ts.resou
-00027320: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-00027330: 203d 2076 0a0a 2020 2020 2020 2020 6966   = v..        if
-00027340: 2072 6574 7269 6573 3a0a 2020 2020 2020   retries:.      
-00027350: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
-00027360: 6e20 7265 7472 6965 732e 6974 656d 7328  n retries.items(
-00027370: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00027380: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-00027390: 616e 6365 2876 2c20 696e 7429 0a20 2020  ance(v, int).   
-000273a0: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
-000273b0: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
-000273c0: 286b 290a 2020 2020 2020 2020 2020 2020  (k).            
-000273d0: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
-000273e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000273f0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00027400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027410: 7473 2e72 6574 7269 6573 203d 2076 0a0a  ts.retries = v..
-00027420: 2020 2020 2020 2020 2320 436f 6d70 7574          # Comput
-00027430: 6520 7265 636f 6d6d 656e 6461 7469 6f6e  e recommendation
-00027440: 730a 2020 2020 2020 2020 7265 636f 6d6d  s.        recomm
-00027450: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
-00027460: 3d20 7b7d 0a0a 2020 2020 2020 2020 666f  = {}..        fo
-00027470: 7220 7473 2069 6e20 736f 7274 6564 2872  r ts in sorted(r
-00027480: 756e 6e61 626c 6573 2c20 6b65 793d 6f70  unnables, key=op
-00027490: 6572 6174 6f72 2e61 7474 7267 6574 7465  erator.attrgette
-000274a0: 7228 2270 7269 6f72 6974 7922 292c 2072  r("priority"), r
-000274b0: 6576 6572 7365 3d54 7275 6529 3a0a 2020  everse=True):.  
-000274c0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
-000274d0: 7374 6174 6520 3d3d 2022 7265 6c65 6173  state == "releas
-000274e0: 6564 2220 616e 6420 7473 2e72 756e 5f73  ed" and ts.run_s
-000274f0: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
-00027500: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00027510: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
-00027520: 7761 6974 696e 6722 0a0a 2020 2020 2020  waiting"..      
-00027530: 2020 666f 7220 7473 2069 6e20 746f 7563    for ts in touc
-00027540: 6865 645f 7461 736b 733a 0a20 2020 2020  hed_tasks:.     
-00027550: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
-00027560: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-00027570: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00027580: 2020 2069 6620 6474 732e 6578 6365 7074     if dts.except
-00027590: 696f 6e5f 626c 616d 653a 0a20 2020 2020  ion_blame:.     
-000275a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000275b0: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-000275c0: 6520 3d20 6474 732e 6578 6365 7074 696f  e = dts.exceptio
-000275d0: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
-000275e0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-000275f0: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
-00027600: 6579 5d20 3d20 2265 7272 6564 220a 2020  ey] = "erred".  
-00027610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027620: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-00027630: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
-00027640: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
-00027650: 2e76 616c 7565 7328 2929 3a0a 2020 2020  .values()):.    
-00027660: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00027670: 2020 2020 2020 2020 2020 2020 2070 6c75               plu
-00027680: 6769 6e2e 7570 6461 7465 5f67 7261 7068  gin.update_graph
-00027690: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000276a0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000276b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000276c0: 636c 6965 6e74 3d63 6c69 656e 742c 0a20  client=client,. 
-000276d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000276e0: 2020 2074 6173 6b73 3d74 6173 6b73 2c0a     tasks=tasks,.
-000276f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027700: 2020 2020 6b65 7973 3d6b 6579 732c 0a20      keys=keys,. 
-00027710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027720: 2020 2072 6573 7472 6963 7469 6f6e 733d     restrictions=
-00027730: 7265 7374 7269 6374 696f 6e73 206f 7220  restrictions or 
-00027740: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
-00027750: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
-00027760: 6369 6573 3d64 6570 656e 6465 6e63 6965  cies=dependencie
-00027770: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00027780: 2020 2020 2020 2070 7269 6f72 6974 793d         priority=
-00027790: 7072 696f 7269 7479 2c0a 2020 2020 2020  priority,.      
-000277a0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-000277b0: 6f73 655f 7265 7374 7269 6374 696f 6e73  ose_restrictions
-000277c0: 3d6c 6f6f 7365 5f72 6573 7472 6963 7469  =loose_restricti
-000277d0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-000277e0: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-000277f0: 6573 3d72 6573 6f75 7263 6573 2c0a 2020  es=resources,.  
-00027800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027810: 2020 616e 6e6f 7461 7469 6f6e 733d 616e    annotations=an
-00027820: 6e6f 7461 7469 6f6e 732c 0a20 2020 2020  notations,.     
-00027830: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00027840: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00027850: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-00027860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027870: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
-00027880: 2865 290a 0a20 2020 2020 2020 2073 656c  (e)..        sel
-00027890: 662e 7472 616e 7369 7469 6f6e 7328 7265  f.transitions(re
-000278a0: 636f 6d6d 656e 6461 7469 6f6e 732c 2073  commendations, s
-000278b0: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
-000278c0: 2020 2020 2066 6f72 2074 7320 696e 2074       for ts in t
-000278d0: 6f75 6368 6564 5f74 6173 6b73 3a0a 2020  ouched_tasks:.  
-000278e0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
-000278f0: 7374 6174 6520 696e 2028 226d 656d 6f72  state in ("memor
-00027900: 7922 2c20 2265 7272 6564 2229 3a0a 2020  y", "erred"):.  
-00027910: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00027920: 6c66 2e72 6570 6f72 745f 6f6e 5f6b 6579  lf.report_on_key
-00027930: 2874 733d 7473 2c20 636c 6965 6e74 3d63  (ts=ts, client=c
-00027940: 6c69 656e 7429 0a0a 2020 2020 2020 2020  lient)..        
-00027950: 656e 6420 3d20 7469 6d65 2829 0a20 2020  end = time().   
-00027960: 2020 2020 2073 656c 662e 6469 6765 7374       self.digest
-00027970: 5f6d 6574 7269 6328 2275 7064 6174 652d  _metric("update-
-00027980: 6772 6170 682d 6475 7261 7469 6f6e 222c  graph-duration",
-00027990: 2065 6e64 202d 2073 7461 7274 290a 0a20   end - start).. 
-000279a0: 2020 2020 2020 2023 2054 4f44 4f3a 2062         # TODO: b
-000279b0: 616c 616e 6365 2077 6f72 6b65 7273 0a0a  alance workers..
-000279c0: 2020 2020 6465 6620 7374 696d 756c 7573      def stimulus
-000279d0: 5f71 7565 7565 5f73 6c6f 7473 5f6d 6179  _queue_slots_may
-000279e0: 6265 5f6f 7065 6e65 6428 7365 6c66 2c20  be_opened(self, 
-000279f0: 2a2c 2073 7469 6d75 6c75 735f 6964 3a20  *, stimulus_id: 
-00027a00: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-00027a10: 2020 2020 2020 2222 2252 6573 706f 6e64        """Respond
-00027a20: 2074 6f20 616e 2065 7665 6e74 2077 6869   to an event whi
-00027a30: 6368 206d 6179 2068 6176 6520 6f70 656e  ch may have open
-00027a40: 6564 2073 706f 7473 206f 6e20 776f 726b  ed spots on work
-00027a50: 6572 2074 6872 6561 6470 6f6f 6c73 0a0a  er threadpools..
-00027a60: 2020 2020 2020 2020 5365 6c65 6374 7320          Selects 
-00027a70: 7468 6520 6170 7072 6f70 7269 6174 6520  the appropriate 
-00027a80: 6e75 6d62 6572 206f 6620 7461 736b 7320  number of tasks 
-00027a90: 6672 6f6d 2074 6865 2066 726f 6e74 206f  from the front o
-00027aa0: 6620 7468 6520 7175 6575 6520 6163 636f  f the queue acco
-00027ab0: 7264 696e 6720 746f 0a20 2020 2020 2020  rding to.       
-00027ac0: 2074 6865 2074 6f74 616c 206e 756d 6265   the total numbe
-00027ad0: 7220 6f66 2074 6173 6b20 736c 6f74 7320  r of task slots 
-00027ae0: 6176 6169 6c61 626c 6520 6f6e 2077 6f72  available on wor
-00027af0: 6b65 7273 2028 706f 7465 6e74 6961 6c6c  kers (potentiall
-00027b00: 7920 3029 2c20 616e 640a 2020 2020 2020  y 0), and.      
-00027b10: 2020 7472 616e 7369 7469 6f6e 7320 7468    transitions th
-00027b20: 656d 2074 6f20 6060 7072 6f63 6573 7369  em to ``processi
-00027b30: 6e67 6060 2e0a 0a20 2020 2020 2020 204e  ng``...        N
-00027b40: 6f74 6573 0a20 2020 2020 2020 202d 2d2d  otes.        ---
-00027b50: 2d2d 0a20 2020 2020 2020 204f 7468 6572  --.        Other
-00027b60: 2074 7261 6e73 6974 696f 6e73 2072 656c   transitions rel
-00027b70: 6174 6564 2074 6f20 7468 6973 2073 7469  ated to this sti
-00027b80: 6d75 6c75 7320 7368 6f75 6c64 2062 6520  mulus should be 
-00027b90: 6675 6c6c 7920 7072 6f63 6573 7365 6420  fully processed 
-00027ba0: 6265 666f 7265 6861 6e64 2c0a 2020 2020  beforehand,.    
-00027bb0: 2020 2020 736f 2061 6e79 2074 6173 6b73      so any tasks
-00027bc0: 2074 6861 7420 6265 6361 6d65 2072 756e   that became run
-00027bd0: 6e61 626c 6520 6172 6520 616c 7265 6164  nable are alread
-00027be0: 7920 696e 2060 6070 726f 6365 7373 696e  y in ``processin
-00027bf0: 6760 602e 204f 7468 6572 7769 7365 2c0a  g``. Otherwise,.
-00027c00: 2020 2020 2020 2020 6f76 6572 7072 6f64          overprod
-00027c10: 7563 7469 6f6e 2063 616e 206f 6363 7572  uction can occur
-00027c20: 2069 6620 7175 6575 6564 2074 6173 6b73   if queued tasks
-00027c30: 2067 6574 2073 6368 6564 756c 6564 2062   get scheduled b
-00027c40: 6566 6f72 6520 646f 776e 7374 7265 616d  efore downstream
-00027c50: 2074 6173 6b73 2e0a 0a20 2020 2020 2020   tasks...       
-00027c60: 204d 7573 7420 6265 2063 616c 6c65 6420   Must be called 
-00027c70: 6166 7465 7220 6063 6865 636b 5f69 646c  after `check_idl
-00027c80: 655f 7361 7475 7261 7465 6460 3b20 692e  e_saturated`; i.
-00027c90: 652e 2060 6964 6c65 5f74 6173 6b5f 636f  e. `idle_task_co
-00027ca0: 756e 7460 206d 7573 7420 6265 2075 700a  unt` must be up.
-00027cb0: 2020 2020 2020 2020 746f 2064 6174 652e          to date.
-00027cc0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00027cd0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00027ce0: 2e71 7565 7565 643a 0a20 2020 2020 2020  .queued:.       
-00027cf0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00027d00: 2020 2020 736c 6f74 735f 6176 6169 6c61      slots_availa
-00027d10: 626c 6520 3d20 7375 6d28 0a20 2020 2020  ble = sum(.     
-00027d20: 2020 2020 2020 205f 7461 736b 5f73 6c6f         _task_slo
-00027d30: 7473 5f61 7661 696c 6162 6c65 2877 732c  ts_available(ws,
-00027d40: 2073 656c 662e 574f 524b 4552 5f53 4154   self.WORKER_SAT
-00027d50: 5552 4154 494f 4e29 0a20 2020 2020 2020  URATION).       
-00027d60: 2020 2020 2066 6f72 2077 7320 696e 2073       for ws in s
-00027d70: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
-00027d80: 756e 740a 2020 2020 2020 2020 290a 2020  unt.        ).  
-00027d90: 2020 2020 2020 6966 2073 6c6f 7473 5f61        if slots_a
-00027da0: 7661 696c 6162 6c65 203d 3d20 303a 0a20  vailable == 0:. 
-00027db0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00027dc0: 6e0a 0a20 2020 2020 2020 2072 6563 6f6d  n..        recom
-00027dd0: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-00027de0: 203d 207b 7d0a 2020 2020 2020 2020 666f   = {}.        fo
-00027df0: 7220 7174 7320 696e 2073 656c 662e 7175  r qts in self.qu
-00027e00: 6575 6564 2e70 6565 6b6e 2873 6c6f 7473  eued.peekn(slots
-00027e10: 5f61 7661 696c 6162 6c65 293a 0a20 2020  _available):.   
-00027e20: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00027e30: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00027e40: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00027e50: 7420 7174 732e 7374 6174 6520 3d3d 2022  t qts.state == "
-00027e60: 7175 6575 6564 222c 2071 7473 2e73 7461  queued", qts.sta
-00027e70: 7465 0a20 2020 2020 2020 2020 2020 2020  te.             
-00027e80: 2020 2061 7373 6572 7420 6e6f 7420 7174     assert not qt
-00027e90: 732e 7072 6f63 6573 7369 6e67 5f6f 6e2c  s.processing_on,
-00027ea0: 2028 7174 732c 2071 7473 2e70 726f 6365   (qts, qts.proce
-00027eb0: 7373 696e 675f 6f6e 290a 2020 2020 2020  ssing_on).      
-00027ec0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00027ed0: 206e 6f74 2071 7473 2e77 6169 7469 6e67   not qts.waiting
-00027ee0: 5f6f 6e2c 2028 7174 732c 2071 7473 2e70  _on, (qts, qts.p
-00027ef0: 726f 6365 7373 696e 675f 6f6e 290a 2020  rocessing_on).  
-00027f00: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00027f10: 7365 7274 2071 7473 2e77 686f 5f77 616e  sert qts.who_wan
-00027f20: 7473 206f 7220 7174 732e 7761 6974 6572  ts or qts.waiter
-00027f30: 732c 2071 7473 0a20 2020 2020 2020 2020  s, qts.         
-00027f40: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00027f50: 6e73 5b71 7473 2e6b 6579 5d20 3d20 2270  ns[qts.key] = "p
-00027f60: 726f 6365 7373 696e 6722 0a0a 2020 2020  rocessing"..    
-00027f70: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
-00027f80: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
-00027f90: 696f 6e73 2c20 7374 696d 756c 7573 5f69  ions, stimulus_i
-00027fa0: 6429 0a0a 2020 2020 6465 6620 7374 696d  d)..    def stim
-00027fb0: 756c 7573 5f74 6173 6b5f 6669 6e69 7368  ulus_task_finish
-00027fc0: 6564 2873 656c 662c 206b 6579 2c20 776f  ed(self, key, wo
-00027fd0: 726b 6572 2c20 7374 696d 756c 7573 5f69  rker, stimulus_i
-00027fe0: 642c 2072 756e 5f69 642c 202a 2a6b 7761  d, run_id, **kwa
-00027ff0: 7267 7329 3a0a 2020 2020 2020 2020 2222  rgs):.        ""
-00028000: 224d 6172 6b20 7468 6174 2061 2074 6173  "Mark that a tas
-00028010: 6b20 6861 7320 6669 6e69 7368 6564 2065  k has finished e
-00028020: 7865 6375 7469 6f6e 206f 6e20 6120 7061  xecution on a pa
-00028030: 7274 6963 756c 6172 2077 6f72 6b65 7222  rticular worker"
-00028040: 2222 0a20 2020 2020 2020 206c 6f67 6765  "".        logge
-00028050: 722e 6465 6275 6728 2253 7469 6d75 6c75  r.debug("Stimulu
-00028060: 7320 7461 736b 2066 696e 6973 6865 6420  s task finished 
-00028070: 2573 5b25 645d 2025 7322 2c20 6b65 792c  %s[%d] %s", key,
-00028080: 2072 756e 5f69 642c 2077 6f72 6b65 7229   run_id, worker)
-00028090: 0a0a 2020 2020 2020 2020 7265 636f 6d6d  ..        recomm
-000280a0: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
-000280b0: 3d20 7b7d 0a20 2020 2020 2020 2063 6c69  = {}.        cli
-000280c0: 656e 745f 6d73 6773 3a20 4d73 6773 203d  ent_msgs: Msgs =
-000280d0: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
-000280e0: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
-000280f0: 7b7d 0a0a 2020 2020 2020 2020 7773 3a20  {}..        ws: 
-00028100: 576f 726b 6572 5374 6174 6520 3d20 7365  WorkerState = se
-00028110: 6c66 2e77 6f72 6b65 7273 5b77 6f72 6b65  lf.workers[worke
-00028120: 725d 0a20 2020 2020 2020 2074 733a 2054  r].        ts: T
-00028130: 6173 6b53 7461 7465 203d 2073 656c 662e  askState = self.
-00028140: 7461 736b 732e 6765 7428 6b65 7929 0a20  tasks.get(key). 
-00028150: 2020 2020 2020 2069 6620 7473 2069 7320         if ts is 
-00028160: 4e6f 6e65 206f 7220 7473 2e73 7461 7465  None or ts.state
-00028170: 2069 6e20 2822 7265 6c65 6173 6564 222c   in ("released",
-00028180: 2022 7175 6575 6564 2229 3a0a 2020 2020   "queued"):.    
-00028190: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-000281a0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-000281b0: 2020 2020 2020 2252 6563 6569 7665 6420        "Received 
-000281c0: 616c 7265 6164 7920 636f 6d70 7574 6564  already computed
-000281d0: 2074 6173 6b2c 2077 6f72 6b65 723a 2025   task, worker: %
-000281e0: 732c 2073 7461 7465 3a20 2573 220a 2020  s, state: %s".  
-000281f0: 2020 2020 2020 2020 2020 2020 2020 222c                ",
-00028200: 206b 6579 3a20 2573 2c20 7768 6f5f 6861   key: %s, who_ha
-00028210: 733a 2025 7322 2c0a 2020 2020 2020 2020  s: %s",.        
-00028220: 2020 2020 2020 2020 776f 726b 6572 2c0a          worker,.
-00028230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028240: 7473 2e73 7461 7465 2069 6620 7473 2065  ts.state if ts e
-00028250: 6c73 6520 2266 6f72 676f 7474 656e 222c  lse "forgotten",
-00028260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028270: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
-00028280: 2020 2020 2020 7473 2e77 686f 5f68 6173        ts.who_has
-00028290: 2069 6620 7473 2065 6c73 6520 7b7d 2c0a   if ts else {},.
-000282a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000282b0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-000282c0: 5f6d 7367 735b 776f 726b 6572 5d20 3d20  _msgs[worker] = 
-000282d0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-000282e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000282f0: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
-00028300: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
-00028310: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00028320: 6b65 7973 223a 205b 6b65 795d 2c0a 2020  keys": [key],.  
-00028330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028340: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-00028350: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-00028360: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00028370: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00028380: 2020 2020 2020 656c 6966 2074 732e 7275        elif ts.ru
-00028390: 6e5f 6964 2021 3d20 7275 6e5f 6964 3a0a  n_id != run_id:.
-000283a0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000283b0: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
-000283c0: 5f6f 6e20 6f72 2074 732e 7072 6f63 6573  _on or ts.proces
-000283d0: 7369 6e67 5f6f 6e2e 6164 6472 6573 7320  sing_on.address 
-000283e0: 213d 2077 6f72 6b65 723a 0a20 2020 2020  != worker:.     
-000283f0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00028400: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-00028410: 2020 2020 2020 2020 2020 2020 2022 5265               "Re
-00028420: 6365 6976 6564 2073 7461 6c65 2074 6173  ceived stale tas
-00028430: 6b20 7275 6e2c 2077 6f72 6b65 723a 2025  k run, worker: %
-00028440: 732c 206b 6579 3a20 2573 2c20 7275 6e5f  s, key: %s, run_
-00028450: 6964 3a20 2564 2028 2564 2922 2c0a 2020  id: %d (%d)",.  
-00028460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028470: 2020 776f 726b 6572 2c0a 2020 2020 2020    worker,.      
-00028480: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00028490: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-000284a0: 2020 2020 2020 2072 756e 5f69 642c 0a20         run_id,. 
-000284b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284c0: 2020 2074 732e 7275 6e5f 6964 2c0a 2020     ts.run_id,.  
-000284d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000284e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284f0: 776f 726b 6572 5f6d 7367 735b 776f 726b  worker_msgs[work
-00028500: 6572 5d20 3d20 5b0a 2020 2020 2020 2020  er] = [.        
-00028510: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000271e0: 2020 2020 776f 726b 6572 5f72 6573 7472      worker_restr
+000271f0: 6963 7469 6f6e 732e 6164 6428 7729 0a20  ictions.add(w). 
+00027200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027210: 2020 2069 6620 686f 7374 5f72 6573 7472     if host_restr
+00027220: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
+00027230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027240: 2074 732e 686f 7374 5f72 6573 7472 6963   ts.host_restric
+00027250: 7469 6f6e 7320 3d20 686f 7374 5f72 6573  tions = host_res
+00027260: 7472 6963 7469 6f6e 730a 2020 2020 2020  trictions.      
+00027270: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00027280: 2077 6f72 6b65 725f 7265 7374 7269 6374   worker_restrict
+00027290: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+000272a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+000272b0: 2e77 6f72 6b65 725f 7265 7374 7269 6374  .worker_restrict
+000272c0: 696f 6e73 203d 2077 6f72 6b65 725f 7265  ions = worker_re
+000272d0: 7374 7269 6374 696f 6e73 0a20 2020 2020  strictions.     
+000272e0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000272f0: 616e 6e6f 7420 696e 2028 226c 6f6f 7365  annot in ("loose
+00027300: 5f72 6573 7472 6963 7469 6f6e 7322 2c20  _restrictions", 
+00027310: 2261 6c6c 6f77 5f6f 7468 6572 5f77 6f72  "allow_other_wor
+00027320: 6b65 7273 2229 3a0a 2020 2020 2020 2020  kers"):.        
+00027330: 2020 2020 2020 2020 2020 2020 7473 2e6c              ts.l
+00027340: 6f6f 7365 5f72 6573 7472 6963 7469 6f6e  oose_restriction
+00027350: 7320 3d20 7661 6c75 650a 2020 2020 2020  s = value.      
+00027360: 2020 2020 2020 2020 2020 656c 6966 2061            elif a
+00027370: 6e6e 6f74 203d 3d20 2272 6573 6f75 7263  nnot == "resourc
+00027380: 6573 223a 0a20 2020 2020 2020 2020 2020  es":.           
+00027390: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000273a0: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
+000273b0: 2c20 6469 6374 290a 2020 2020 2020 2020  , dict).        
+000273c0: 2020 2020 2020 2020 2020 2020 7473 2e72              ts.r
+000273d0: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
+000273e0: 696f 6e73 203d 2076 616c 7565 0a20 2020  ions = value.   
+000273f0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00027400: 6620 616e 6e6f 7420 3d3d 2022 7072 696f  f annot == "prio
+00027410: 7269 7479 223a 0a20 2020 2020 2020 2020  rity":.         
+00027420: 2020 2020 2020 2020 2020 2023 2053 6565             # See
+00027430: 2053 6368 6564 756c 6572 2e5f 7365 745f   Scheduler._set_
+00027440: 7072 696f 7269 7469 6573 0a20 2020 2020  priorities.     
+00027450: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00027460: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00027470: 2020 2020 2020 2020 656c 6966 2061 6e6e          elif ann
+00027480: 6f74 203d 3d20 2272 6574 7269 6573 223a  ot == "retries":
+00027490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000274a0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+000274b0: 7374 616e 6365 2876 616c 7565 2c20 696e  stance(value, in
+000274c0: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+000274d0: 2020 2020 2020 2074 732e 7265 7472 6965         ts.retrie
+000274e0: 7320 3d20 7661 6c75 650a 2020 2020 2020  s = value.      
+000274f0: 2020 2020 2020 7473 2e61 6e6e 6f74 6174        ts.annotat
+00027500: 696f 6e73 203d 206f 7574 0a20 2020 2020  ions = out.     
+00027510: 2020 2072 6574 7572 6e20 6469 6374 2872     return dict(r
+00027520: 6573 6f6c 7665 645f 616e 6e6f 7461 7469  esolved_annotati
+00027530: 6f6e 7329 0a0a 2020 2020 6465 6620 5f73  ons)..    def _s
+00027540: 6574 5f70 7269 6f72 6974 6965 7328 0a20  et_priorities(. 
+00027550: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00027560: 2020 2020 2069 6e74 6572 6e61 6c5f 7072       internal_pr
+00027570: 696f 7269 7479 3a20 6469 6374 5b73 7472  iority: dict[str
+00027580: 2c20 696e 745d 207c 204e 6f6e 652c 0a20  , int] | None,. 
+00027590: 2020 2020 2020 2073 7562 6d69 7474 696e         submittin
+000275a0: 675f 7461 736b 3a20 7374 7220 7c20 4e6f  g_task: str | No
+000275b0: 6e65 2c0a 2020 2020 2020 2020 7573 6572  ne,.        user
+000275c0: 5f70 7269 6f72 6974 793a 2069 6e74 207c  _priority: int |
+000275d0: 2064 6963 745b 7374 722c 2069 6e74 5d2c   dict[str, int],
+000275e0: 0a20 2020 2020 2020 2066 6966 6f5f 7469  .        fifo_ti
+000275f0: 6d65 6f75 743a 2069 6e74 207c 2066 6c6f  meout: int | flo
+00027600: 6174 207c 2073 7472 2c0a 2020 2020 2020  at | str,.      
+00027610: 2020 7374 6172 743a 2066 6c6f 6174 2c0a    start: float,.
+00027620: 2020 2020 2020 2020 6473 6b3a 2064 6963          dsk: dic
+00027630: 742c 0a20 2020 2020 2020 2074 6173 6b73  t,.        tasks
+00027640: 3a20 6c69 7374 5b54 6173 6b53 7461 7465  : list[TaskState
+00027650: 5d2c 0a20 2020 2020 2020 2064 6570 656e  ],.        depen
+00027660: 6465 6e63 6965 733a 2064 6963 742c 0a20  dencies: dict,. 
+00027670: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00027680: 2020 2020 2020 6669 666f 5f74 696d 656f        fifo_timeo
+00027690: 7574 203d 2070 6172 7365 5f74 696d 6564  ut = parse_timed
+000276a0: 656c 7461 2866 6966 6f5f 7469 6d65 6f75  elta(fifo_timeou
+000276b0: 7429 0a20 2020 2020 2020 2069 6620 7375  t).        if su
+000276c0: 626d 6974 7469 6e67 5f74 6173 6b3a 2020  bmitting_task:  
+000276d0: 2320 7375 622d 7461 736b 7320 6765 7420  # sub-tasks get 
+000276e0: 6265 7474 6572 2070 7269 6f72 6974 7920  better priority 
+000276f0: 7468 616e 2070 6172 656e 7420 7461 736b  than parent task
+00027700: 730a 2020 2020 2020 2020 2020 2020 7374  s.            st
+00027710: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+00027720: 6574 2873 7562 6d69 7474 696e 675f 7461  et(submitting_ta
+00027730: 736b 290a 2020 2020 2020 2020 2020 2020  sk).            
+00027740: 6966 2073 7473 2069 7320 6e6f 7420 4e6f  if sts is not No
+00027750: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00027760: 2020 2020 6173 7365 7274 2073 7473 2e70      assert sts.p
+00027770: 7269 6f72 6974 790a 2020 2020 2020 2020  riority.        
+00027780: 2020 2020 2020 2020 6765 6e65 7261 7469          generati
+00027790: 6f6e 203d 2073 7473 2e70 7269 6f72 6974  on = sts.priorit
+000277a0: 795b 305d 202d 2030 2e30 310a 2020 2020  y[0] - 0.01.    
+000277b0: 2020 2020 2020 2020 656c 7365 3a20 2023          else:  #
+000277c0: 2073 7570 6572 2d74 6173 6b20 616c 7265   super-task alre
+000277d0: 6164 7920 636c 6561 6e65 6420 7570 0a20  ady cleaned up. 
+000277e0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000277f0: 656e 6572 6174 696f 6e20 3d20 7365 6c66  eneration = self
+00027800: 2e67 656e 6572 6174 696f 6e0a 2020 2020  .generation.    
+00027810: 2020 2020 656c 6966 2073 656c 662e 5f6c      elif self._l
+00027820: 6173 745f 7469 6d65 202b 2066 6966 6f5f  ast_time + fifo_
+00027830: 7469 6d65 6f75 7420 3c20 7374 6172 743a  timeout < start:
+00027840: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00027850: 662e 6765 6e65 7261 7469 6f6e 202b 3d20  f.generation += 
+00027860: 3120 2023 206f 6c64 6572 2067 7261 7068  1  # older graph
+00027870: 2067 656e 6572 6174 696f 6e73 2074 616b   generations tak
+00027880: 6520 7072 6563 6564 656e 6365 0a20 2020  e precedence.   
+00027890: 2020 2020 2020 2020 2067 656e 6572 6174           generat
+000278a0: 696f 6e20 3d20 7365 6c66 2e67 656e 6572  ion = self.gener
+000278b0: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
+000278c0: 2020 7365 6c66 2e5f 6c61 7374 5f74 696d    self._last_tim
+000278d0: 6520 3d20 7374 6172 740a 2020 2020 2020  e = start.      
+000278e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000278f0: 2020 2020 6765 6e65 7261 7469 6f6e 203d      generation =
+00027900: 2073 656c 662e 6765 6e65 7261 7469 6f6e   self.generation
+00027910: 0a0a 2020 2020 2020 2020 6966 2069 6e74  ..        if int
+00027920: 6572 6e61 6c5f 7072 696f 7269 7479 2069  ernal_priority i
+00027930: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00027940: 2020 2020 2320 5265 6d6f 7669 6e67 2061      # Removing a
+00027950: 6c6c 206e 6f6e 2d6c 6f63 616c 206b 6579  ll non-local key
+00027960: 7320 6265 666f 7265 2063 616c 6c69 6e67  s before calling
+00027970: 206f 7264 6572 2829 0a20 2020 2020 2020   order().       
+00027980: 2020 2020 2064 736b 5f6b 6579 7320 3d20       dsk_keys = 
+00027990: 7365 7428 6473 6b29 2020 2320 696e 7465  set(dsk)  # inte
+000279a0: 7273 6563 7469 6f6e 2829 206f 6620 7365  rsection() of se
+000279b0: 7473 2069 7320 6d75 6368 2066 6173 7465  ts is much faste
+000279c0: 7220 7468 616e 2064 6963 745f 6b65 7973  r than dict_keys
+000279d0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+000279e0: 6970 7065 645f 6465 7073 203d 207b 0a20  ipped_deps = {. 
+000279f0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00027a00: 3a20 762e 696e 7465 7273 6563 7469 6f6e  : v.intersection
+00027a10: 2864 736b 5f6b 6579 7329 0a20 2020 2020  (dsk_keys).     
+00027a20: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00027a30: 2c20 7620 696e 2064 6570 656e 6465 6e63  , v in dependenc
+00027a40: 6965 732e 6974 656d 7328 290a 2020 2020  ies.items().    
+00027a50: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00027a60: 2069 6e20 6473 6b5f 6b65 7973 0a20 2020   in dsk_keys.   
+00027a70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00027a80: 2020 2020 2020 2069 6e74 6572 6e61 6c5f         internal_
+00027a90: 7072 696f 7269 7479 203d 2064 6173 6b2e  priority = dask.
+00027aa0: 6f72 6465 722e 6f72 6465 7228 6473 6b2c  order.order(dsk,
+00027ab0: 2064 6570 656e 6465 6e63 6965 733d 7374   dependencies=st
+00027ac0: 7269 7070 6564 5f64 6570 7329 0a0a 2020  ripped_deps)..  
+00027ad0: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+00027ae0: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+00027af0: 2020 2023 204e 6f74 653a 2055 6e64 6572     # Note: Under
+00027b00: 2077 6869 6368 2063 6972 6375 6d73 7461   which circumsta
+00027b10: 6e63 6573 2077 6f75 6c64 2061 2074 6173  nces would a tas
+00027b20: 6b20 6e6f 7420 6861 7665 2061 0a20 2020  k not have a.   
+00027b30: 2020 2020 2020 2020 2023 2070 7269 6f72           # prior
+00027b40: 6974 6979 2061 7373 6967 6e65 6420 6279  itiy assigned by
+00027b50: 206e 6f77 3f20 4172 6520 7468 6573 6520   now? Are these 
+00027b60: 7363 6174 7465 7265 6420 7461 736b 730a  scattered tasks.
+00027b70: 2020 2020 2020 2020 2020 2020 2320 6578              # ex
+00027b80: 636c 7573 6976 656c 7920 6f72 2073 6f6d  clusively or som
+00027b90: 6574 6869 6e67 2065 6c73 653f 0a20 2020  ething else?.   
+00027ba0: 2020 2020 2020 2020 2074 6173 6b5f 7573           task_us
+00027bb0: 6572 5f70 7269 6f20 3d20 7573 6572 5f70  er_prio = user_p
+00027bc0: 7269 6f72 6974 790a 2020 2020 2020 2020  riority.        
+00027bd0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00027be0: 6528 7573 6572 5f70 7269 6f72 6974 792c  e(user_priority,
+00027bf0: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+00027c00: 2020 2020 2020 2020 7461 736b 5f75 7365          task_use
+00027c10: 725f 7072 696f 203d 2075 7365 725f 7072  r_prio = user_pr
+00027c20: 696f 7269 7479 2e67 6574 2874 732e 6b65  iority.get(ts.ke
+00027c30: 792c 2030 290a 2020 2020 2020 2020 2020  y, 0).          
+00027c40: 2020 616e 6e6f 7461 7465 645f 7072 696f    annotated_prio
+00027c50: 203d 2074 732e 616e 6e6f 7461 7469 6f6e   = ts.annotation
+00027c60: 732e 6765 7428 2270 7269 6f72 6974 7922  s.get("priority"
+00027c70: 2c20 7b7d 290a 2020 2020 2020 2020 2020  , {}).          
+00027c80: 2020 6966 206e 6f74 2061 6e6e 6f74 6174    if not annotat
+00027c90: 6564 5f70 7269 6f3a 0a20 2020 2020 2020  ed_prio:.       
+00027ca0: 2020 2020 2020 2020 2061 6e6e 6f74 6174           annotat
+00027cb0: 6564 5f70 7269 6f20 3d20 7461 736b 5f75  ed_prio = task_u
+00027cc0: 7365 725f 7072 696f 0a0a 2020 2020 2020  ser_prio..      
+00027cd0: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
+00027ce0: 7072 696f 7269 7479 2061 6e64 2074 732e  priority and ts.
+00027cf0: 6b65 7920 696e 2069 6e74 6572 6e61 6c5f  key in internal_
+00027d00: 7072 696f 7269 7479 3a0a 2020 2020 2020  priority:.      
+00027d10: 2020 2020 2020 2020 2020 7473 2e70 7269            ts.pri
+00027d20: 6f72 6974 7920 3d20 280a 2020 2020 2020  ority = (.      
+00027d30: 2020 2020 2020 2020 2020 2020 2020 2d61                -a
+00027d40: 6e6e 6f74 6174 6564 5f70 7269 6f2c 0a20  nnotated_prio,. 
+00027d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d60: 2020 2067 656e 6572 6174 696f 6e2c 0a20     generation,. 
+00027d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d80: 2020 2069 6e74 6572 6e61 6c5f 7072 696f     internal_prio
+00027d90: 7269 7479 5b74 732e 6b65 795d 2c0a 2020  rity[ts.key],.  
+00027da0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00027db0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00027dc0: 7365 6c66 2e76 616c 6964 6174 6520 616e  self.validate an
+00027dd0: 6420 7473 2e72 756e 5f73 7065 633a 0a20  d ts.run_spec:. 
+00027de0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00027df0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00027e00: 2874 732e 7072 696f 7269 7479 2c20 7475  (ts.priority, tu
+00027e10: 706c 6529 2061 6e64 2061 6c6c 280a 2020  ple) and all(.  
+00027e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e30: 2020 6973 696e 7374 616e 6365 2865 6c2c    isinstance(el,
+00027e40: 2028 696e 742c 2066 6c6f 6174 2929 2066   (int, float)) f
+00027e50: 6f72 2065 6c20 696e 2074 732e 7072 696f  or el in ts.prio
+00027e60: 7269 7479 0a20 2020 2020 2020 2020 2020  rity.           
+00027e70: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00027e80: 5f70 6f70 5f6c 6f73 745f 7461 736b 7328  _pop_lost_tasks(
+00027e90: 0a20 2020 2020 2020 2073 656c 662c 2064  .        self, d
+00027ea0: 736b 3a20 6469 6374 2c20 6465 7065 6e64  sk: dict, depend
+00027eb0: 656e 6369 6573 3a20 6469 6374 2c20 6b65  encies: dict, ke
+00027ec0: 7973 3a20 7365 745b 7374 725d 0a20 2020  ys: set[str].   
+00027ed0: 2029 202d 3e20 7365 745b 7374 725d 3a0a   ) -> set[str]:.
+00027ee0: 2020 2020 2020 2020 6e20 3d20 300a 2020          n = 0.  
+00027ef0: 2020 2020 2020 6f75 7420 3d20 7365 7428        out = set(
+00027f00: 290a 2020 2020 2020 2020 7768 696c 6520  ).        while 
+00027f10: 6c65 6e28 6473 6b29 2021 3d20 6e3a 2020  len(dsk) != n:  
+00027f20: 2320 7761 6c6b 2074 6872 6f75 6768 206e  # walk through n
+00027f30: 6577 2074 6173 6b73 2c20 6361 6e63 656c  ew tasks, cancel
+00027f40: 2061 6e79 2062 6164 2064 6570 730a 2020   any bad deps.  
+00027f50: 2020 2020 2020 2020 2020 6e20 3d20 6c65            n = le
+00027f60: 6e28 6473 6b29 0a20 2020 2020 2020 2020  n(dsk).         
+00027f70: 2020 2066 6f72 206b 2c20 6465 7073 2069     for k, deps i
+00027f80: 6e20 6c69 7374 2864 6570 656e 6465 6e63  n list(dependenc
+00027f90: 6965 732e 6974 656d 7328 2929 3a0a 2020  ies.items()):.  
+00027fa0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00027fb0: 2061 6e79 280a 2020 2020 2020 2020 2020   any(.          
+00027fc0: 2020 2020 2020 2020 2020 6465 7020 6e6f            dep no
+00027fd0: 7420 696e 2073 656c 662e 7461 736b 7320  t in self.tasks 
+00027fe0: 616e 6420 6465 7020 6e6f 7420 696e 2064  and dep not in d
+00027ff0: 736b 2066 6f72 2064 6570 2069 6e20 6465  sk for dep in de
+00028000: 7073 0a20 2020 2020 2020 2020 2020 2020  ps.             
+00028010: 2020 2029 3a20 2023 2062 6164 206b 6579     ):  # bad key
+00028020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028030: 2020 2020 206f 7574 2e61 6464 286b 290a       out.add(k).
+00028040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028050: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00028060: 2255 7365 7220 6173 6b65 6420 666f 7220  "User asked for 
+00028070: 636f 6d70 7574 6174 696f 6e20 6f6e 206c  computation on l
+00028080: 6f73 7420 6461 7461 2c20 2573 222c 206b  ost data, %s", k
+00028090: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000280a0: 2020 2020 2020 6465 6c20 6473 6b5b 6b5d        del dsk[k]
+000280b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000280c0: 2020 2020 2064 656c 2064 6570 656e 6465       del depende
+000280d0: 6e63 6965 735b 6b5d 0a20 2020 2020 2020  ncies[k].       
+000280e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000280f0: 6b20 696e 206b 6579 733a 0a20 2020 2020  k in keys:.     
+00028100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028110: 2020 206b 6579 732e 7265 6d6f 7665 286b     keys.remove(k
+00028120: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00028130: 206f 7574 0a0a 2020 2020 6465 6620 5f70   out..    def _p
+00028140: 6f70 5f6b 6e6f 776e 5f74 6173 6b73 2873  op_known_tasks(s
+00028150: 656c 662c 2064 736b 3a20 6469 6374 2c20  elf, dsk: dict, 
+00028160: 6465 7065 6e64 656e 6369 6573 3a20 6469  dependencies: di
+00028170: 6374 2920 2d3e 2073 6574 5b73 7472 5d3a  ct) -> set[str]:
+00028180: 0a20 2020 2020 2020 2023 2041 766f 6964  .        # Avoid
+00028190: 2063 6f6d 7075 7461 7469 6f6e 2074 6861   computation tha
+000281a0: 7420 6973 2061 6c72 6561 6479 2066 696e  t is already fin
+000281b0: 6973 6865 640a 2020 2020 2020 2020 616c  ished.        al
+000281c0: 7265 6164 795f 696e 5f6d 656d 6f72 7920  ready_in_memory 
+000281d0: 3d20 7365 7428 2920 2023 2074 6173 6b73  = set()  # tasks
+000281e0: 2074 6861 7420 6172 6520 616c 7265 6164   that are alread
+000281f0: 7920 646f 6e65 0a20 2020 2020 2020 2066  y done.        f
+00028200: 6f72 206b 2c20 7620 696e 2064 6570 656e  or k, v in depen
+00028210: 6465 6e63 6965 732e 6974 656d 7328 293a  dencies.items():
+00028220: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00028230: 7620 616e 6420 6b20 696e 2073 656c 662e  v and k in self.
+00028240: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+00028250: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00028260: 2e74 6173 6b73 5b6b 5d0a 2020 2020 2020  .tasks[k].      
+00028270: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+00028280: 7374 6174 6520 696e 2028 226d 656d 6f72  state in ("memor
+00028290: 7922 2c20 2265 7272 6564 2229 3a0a 2020  y", "erred"):.  
+000282a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000282b0: 2020 616c 7265 6164 795f 696e 5f6d 656d    already_in_mem
+000282c0: 6f72 792e 6164 6428 6b29 0a0a 2020 2020  ory.add(k)..    
+000282d0: 2020 2020 646f 6e65 203d 2073 6574 2861      done = set(a
+000282e0: 6c72 6561 6479 5f69 6e5f 6d65 6d6f 7279  lready_in_memory
+000282f0: 290a 2020 2020 2020 2020 6966 2061 6c72  ).        if alr
+00028300: 6561 6479 5f69 6e5f 6d65 6d6f 7279 3a0a  eady_in_memory:.
+00028310: 2020 2020 2020 2020 2020 2020 6465 7065              depe
+00028320: 6e64 656e 7473 203d 2064 6173 6b2e 636f  ndents = dask.co
+00028330: 7265 2e72 6576 6572 7365 5f64 6963 7428  re.reverse_dict(
+00028340: 6465 7065 6e64 656e 6369 6573 290a 2020  dependencies).  
+00028350: 2020 2020 2020 2020 2020 7374 6163 6b20            stack 
+00028360: 3d20 6c69 7374 2861 6c72 6561 6479 5f69  = list(already_i
+00028370: 6e5f 6d65 6d6f 7279 290a 2020 2020 2020  n_memory).      
+00028380: 2020 2020 2020 7768 696c 6520 7374 6163        while stac
+00028390: 6b3a 2020 2320 7265 6d6f 7665 2075 6e6e  k:  # remove unn
+000283a0: 6563 6573 7361 7279 2064 6570 656e 6465  ecessary depende
+000283b0: 6e63 6965 730a 2020 2020 2020 2020 2020  ncies.          
+000283c0: 2020 2020 2020 6b65 7920 3d20 7374 6163        key = stac
+000283d0: 6b2e 706f 7028 290a 2020 2020 2020 2020  k.pop().        
+000283e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000283f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028400: 2064 6570 7320 3d20 6465 7065 6e64 656e   deps = dependen
+00028410: 6369 6573 5b6b 6579 5d0a 2020 2020 2020  cies[key].      
+00028420: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00028430: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
+00028440: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00028450: 6570 7320 3d20 7365 6c66 2e74 6173 6b73  eps = self.tasks
+00028460: 5b6b 6579 5d2e 6465 7065 6e64 656e 6369  [key].dependenci
+00028470: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00028480: 2020 2066 6f72 2064 6570 2069 6e20 6465     for dep in de
+00028490: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+000284a0: 2020 2020 2020 2020 6966 2064 6570 2069          if dep i
+000284b0: 6e20 6465 7065 6e64 656e 7473 3a0a 2020  n dependents:.  
+000284c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000284d0: 2020 2020 2020 6368 696c 645f 6465 7073        child_deps
+000284e0: 203d 2064 6570 656e 6465 6e74 735b 6465   = dependents[de
+000284f0: 705d 0a20 2020 2020 2020 2020 2020 2020  p].             
+00028500: 2020 2020 2020 2065 6c69 6620 6465 7020         elif dep 
+00028510: 696e 2073 656c 662e 7461 736b 733a 0a20  in self.tasks:. 
 00028520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028530: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
-00028540: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
-00028550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028560: 2022 6b65 7973 223a 205b 6b65 795d 2c0a   "keys": [key],.
-00028570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028580: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
-00028590: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
-000285a0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-000285b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000285c0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-000285d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000285e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000285f0: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
-00028600: 2e6b 6579 5d20 3d20 2272 656c 6561 7365  .key] = "release
-00028610: 6422 0a20 2020 2020 2020 2065 6c69 6620  d".        elif 
-00028620: 7473 2e73 7461 7465 203d 3d20 226d 656d  ts.state == "mem
-00028630: 6f72 7922 3a0a 2020 2020 2020 2020 2020  ory":.          
-00028640: 2020 7365 6c66 2e61 6464 5f6b 6579 7328    self.add_keys(
-00028650: 776f 726b 6572 3d77 6f72 6b65 722c 206b  worker=worker, k
-00028660: 6579 733d 5b6b 6579 5d29 0a20 2020 2020  eys=[key]).     
-00028670: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00028680: 2020 2020 2074 732e 6d65 7461 6461 7461       ts.metadata
-00028690: 2e75 7064 6174 6528 6b77 6172 6773 5b22  .update(kwargs["
-000286a0: 6d65 7461 6461 7461 225d 290a 2020 2020  metadata"]).    
-000286b0: 2020 2020 2020 2020 723a 2074 7570 6c65          r: tuple
-000286c0: 203d 2073 656c 662e 5f74 7261 6e73 6974   = self._transit
-000286d0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-000286e0: 2020 2020 206b 6579 2c20 226d 656d 6f72       key, "memor
-000286f0: 7922 2c20 7374 696d 756c 7573 5f69 642c  y", stimulus_id,
-00028700: 2077 6f72 6b65 723d 776f 726b 6572 2c20   worker=worker, 
-00028710: 2a2a 6b77 6172 6773 0a20 2020 2020 2020  **kwargs.       
-00028720: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00028730: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00028740: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
-00028750: 2077 6f72 6b65 725f 6d73 6773 203d 2072   worker_msgs = r
-00028760: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00028770: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
-00028780: 6d6f 7279 223a 0a20 2020 2020 2020 2020  mory":.         
-00028790: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-000287a0: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
-000287b0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-000287c0: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
-000287d0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
-000287e0: 6572 5f6d 7367 730a 0a20 2020 2064 6566  er_msgs..    def
-000287f0: 2073 7469 6d75 6c75 735f 7461 736b 5f65   stimulus_task_e
-00028800: 7272 6564 280a 2020 2020 2020 2020 7365  rred(.        se
-00028810: 6c66 2c0a 2020 2020 2020 2020 6b65 793d  lf,.        key=
-00028820: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
-00028830: 726b 6572 3d4e 6f6e 652c 0a20 2020 2020  rker=None,.     
-00028840: 2020 2065 7863 6570 7469 6f6e 3d4e 6f6e     exception=Non
-00028850: 652c 0a20 2020 2020 2020 2073 7469 6d75  e,.        stimu
-00028860: 6c75 735f 6964 3d4e 6f6e 652c 0a20 2020  lus_id=None,.   
-00028870: 2020 2020 2074 7261 6365 6261 636b 3d4e       traceback=N
-00028880: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-00028890: 7761 7267 732c 0a20 2020 2029 3a0a 2020  wargs,.    ):.  
-000288a0: 2020 2020 2020 2222 224d 6172 6b20 7468        """Mark th
-000288b0: 6174 2061 2074 6173 6b20 6861 7320 6572  at a task has er
-000288c0: 7265 6420 6f6e 2061 2070 6172 7469 6375  red on a particu
-000288d0: 6c61 7220 776f 726b 6572 2222 220a 2020  lar worker""".  
-000288e0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-000288f0: 7567 2822 5374 696d 756c 7573 2074 6173  ug("Stimulus tas
-00028900: 6b20 6572 7265 6420 2573 2c20 2573 222c  k erred %s, %s",
-00028910: 206b 6579 2c20 776f 726b 6572 290a 0a20   key, worker).. 
-00028920: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
-00028930: 7461 7465 203d 2073 656c 662e 7461 736b  tate = self.task
-00028940: 732e 6765 7428 6b65 7929 0a20 2020 2020  s.get(key).     
-00028950: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
-00028960: 206f 7220 7473 2e73 7461 7465 2021 3d20   or ts.state != 
-00028970: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
-00028980: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00028990: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
-000289a0: 2020 2020 2069 6620 7473 2e72 6574 7269       if ts.retri
-000289b0: 6573 203e 2030 3a0a 2020 2020 2020 2020  es > 0:.        
-000289c0: 2020 2020 7473 2e72 6574 7269 6573 202d      ts.retries -
-000289d0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-000289e0: 7265 7475 726e 2073 656c 662e 5f74 7261  return self._tra
-000289f0: 6e73 6974 696f 6e28 6b65 792c 2022 7761  nsition(key, "wa
-00028a00: 6974 696e 6722 2c20 7374 696d 756c 7573  iting", stimulus
-00028a10: 5f69 6429 0a20 2020 2020 2020 2065 6c73  _id).        els
-00028a20: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00028a30: 6574 7572 6e20 7365 6c66 2e5f 7472 616e  eturn self._tran
-00028a40: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
-00028a50: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
-00028a60: 2020 2020 2020 2020 2020 2020 2022 6572               "er
-00028a70: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
-00028a80: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-00028a90: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00028aa0: 2020 2063 6175 7365 3d6b 6579 2c0a 2020     cause=key,.  
-00028ab0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00028ac0: 6365 7074 696f 6e3d 6578 6365 7074 696f  ception=exceptio
-00028ad0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-00028ae0: 2020 2074 7261 6365 6261 636b 3d74 7261     traceback=tra
-00028af0: 6365 6261 636b 2c0a 2020 2020 2020 2020  ceback,.        
-00028b00: 2020 2020 2020 2020 776f 726b 6572 3d77          worker=w
-00028b10: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
-00028b20: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-00028b30: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00028b40: 2020 2020 6465 6620 7374 696d 756c 7573      def stimulus
-00028b50: 5f72 6574 7279 2873 656c 662c 206b 6579  _retry(self, key
-00028b60: 732c 2063 6c69 656e 743d 4e6f 6e65 293a  s, client=None):
-00028b70: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-00028b80: 696e 666f 2822 436c 6965 6e74 2025 7320  info("Client %s 
-00028b90: 7265 7175 6573 7473 2074 6f20 7265 7472  requests to retr
-00028ba0: 7920 2564 206b 6579 7322 2c20 636c 6965  y %d keys", clie
-00028bb0: 6e74 2c20 6c65 6e28 6b65 7973 2929 0a20  nt, len(keys)). 
-00028bc0: 2020 2020 2020 2069 6620 636c 6965 6e74         if client
-00028bd0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00028be0: 6c66 2e6c 6f67 5f65 7665 6e74 2863 6c69  lf.log_event(cli
-00028bf0: 656e 742c 207b 2261 6374 696f 6e22 3a20  ent, {"action": 
-00028c00: 2272 6574 7279 222c 2022 636f 756e 7422  "retry", "count"
-00028c10: 3a20 6c65 6e28 6b65 7973 297d 290a 0a20  : len(keys)}).. 
-00028c20: 2020 2020 2020 2073 7461 636b 203d 206c         stack = l
-00028c30: 6973 7428 6b65 7973 290a 2020 2020 2020  ist(keys).      
-00028c40: 2020 7365 656e 203d 2073 6574 2829 0a20    seen = set(). 
-00028c50: 2020 2020 2020 2072 6f6f 7473 203d 205b         roots = [
-00028c60: 5d0a 2020 2020 2020 2020 7768 696c 6520  ].        while 
-00028c70: 7374 6163 6b3a 0a20 2020 2020 2020 2020  stack:.         
-00028c80: 2020 206b 6579 203d 2073 7461 636b 2e70     key = stack.p
-00028c90: 6f70 2829 0a20 2020 2020 2020 2020 2020  op().           
-00028ca0: 2073 6565 6e2e 6164 6428 6b65 7929 0a20   seen.add(key). 
-00028cb0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-00028cc0: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00028cd0: 2020 2020 2020 2020 2020 2020 6572 7265              erre
-00028ce0: 645f 6465 7073 203d 205b 6474 732e 6b65  d_deps = [dts.ke
-00028cf0: 7920 666f 7220 6474 7320 696e 2074 732e  y for dts in ts.
-00028d00: 6465 7065 6e64 656e 6369 6573 2069 6620  dependencies if 
-00028d10: 6474 732e 7374 6174 6520 3d3d 2022 6572  dts.state == "er
-00028d20: 7265 6422 5d0a 2020 2020 2020 2020 2020  red"].          
-00028d30: 2020 6966 2065 7272 6564 5f64 6570 733a    if erred_deps:
-00028d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028d50: 2073 7461 636b 2e65 7874 656e 6428 6572   stack.extend(er
-00028d60: 7265 645f 6465 7073 290a 2020 2020 2020  red_deps).      
-00028d70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00028d80: 2020 2020 2020 2020 2020 2020 726f 6f74              root
-00028d90: 732e 6170 7065 6e64 286b 6579 290a 0a20  s.append(key).. 
-00028da0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00028db0: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
-00028dc0: 6b65 793a 2022 7761 6974 696e 6722 2066  key: "waiting" f
-00028dd0: 6f72 206b 6579 2069 6e20 726f 6f74 737d  or key in roots}
-00028de0: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
-00028df0: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
-00028e00: 656e 6461 7469 6f6e 732c 2066 2273 7469  endations, f"sti
-00028e10: 6d75 6c75 732d 7265 7472 792d 7b74 696d  mulus-retry-{tim
-00028e20: 6528 297d 2229 0a0a 2020 2020 2020 2020  e()}")..        
-00028e30: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00028e40: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00028e50: 7220 6b65 7920 696e 2073 6565 6e3a 0a20  r key in seen:. 
-00028e60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00028e70: 7373 6572 7420 6e6f 7420 7365 6c66 2e74  ssert not self.t
-00028e80: 6173 6b73 5b6b 6579 5d2e 6578 6365 7074  asks[key].except
-00028e90: 696f 6e5f 626c 616d 650a 0a20 2020 2020  ion_blame..     
-00028ea0: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
-00028eb0: 7365 656e 290a 0a20 2020 2064 6566 2063  seen)..    def c
-00028ec0: 6c6f 7365 5f77 6f72 6b65 7228 7365 6c66  lose_worker(self
-00028ed0: 2c20 776f 726b 6572 3a20 7374 7229 202d  , worker: str) -
-00028ee0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00028ef0: 2222 2241 736b 2061 2077 6f72 6b65 7220  """Ask a worker 
-00028f00: 746f 2073 6875 7420 6974 7365 6c66 2064  to shut itself d
-00028f10: 6f77 6e2e 2044 6f20 6e6f 7420 7761 6974  own. Do not wait
-00028f20: 2066 6f72 2069 7420 746f 2074 616b 6520   for it to take 
-00028f30: 6566 6665 6374 2e0a 2020 2020 2020 2020  effect..        
-00028f40: 4e6f 7465 2074 6861 7420 7468 6572 6520  Note that there 
-00028f50: 6973 206e 6f20 6775 6172 616e 7465 6520  is no guarantee 
-00028f60: 7468 6174 2074 6865 2077 6f72 6b65 7220  that the worker 
-00028f70: 7769 6c6c 2061 6374 7561 6c6c 7920 6163  will actually ac
-00028f80: 6365 7074 2074 6865 0a20 2020 2020 2020  cept the.       
-00028f90: 2063 6f6d 6d61 6e64 2e0a 0a20 2020 2020   command...     
-00028fa0: 2020 204e 6f74 6520 7468 6174 203a 6d65     Note that :me
-00028fb0: 7468 3a60 7265 6d6f 7665 5f77 6f72 6b65  th:`remove_worke
-00028fc0: 7260 2073 656e 6473 2074 6865 2073 616d  r` sends the sam
-00028fd0: 6520 636f 6d6d 616e 6420 696e 7465 726e  e command intern
-00028fe0: 616c 6c79 2069 6620 636c 6f73 653d 5472  ally if close=Tr
-00028ff0: 7565 2e0a 0a20 2020 2020 2020 2053 6565  ue...        See
-00029000: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
-00029010: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2072  ------.        r
-00029020: 6574 6972 655f 776f 726b 6572 730a 2020  etire_workers.  
-00029030: 2020 2020 2020 7265 6d6f 7665 5f77 6f72        remove_wor
-00029040: 6b65 720a 2020 2020 2020 2020 2222 220a  ker.        """.
-00029050: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
-00029060: 7220 6e6f 7420 696e 2073 656c 662e 776f  r not in self.wo
-00029070: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
-00029080: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00029090: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-000290a0: 436c 6f73 696e 6720 776f 726b 6572 2025  Closing worker %
-000290b0: 7322 2c20 776f 726b 6572 290a 2020 2020  s", worker).    
-000290c0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-000290d0: 6e74 2877 6f72 6b65 722c 207b 2261 6374  nt(worker, {"act
-000290e0: 696f 6e22 3a20 2263 6c6f 7365 2d77 6f72  ion": "close-wor
-000290f0: 6b65 7222 7d29 0a20 2020 2020 2020 2073  ker"}).        s
-00029100: 656c 662e 776f 726b 6572 5f73 656e 6428  elf.worker_send(
-00029110: 776f 726b 6572 2c20 7b22 6f70 223a 2022  worker, {"op": "
-00029120: 636c 6f73 6522 2c20 2272 6561 736f 6e22  close", "reason"
-00029130: 3a20 2273 6368 6564 756c 6572 2d63 6c6f  : "scheduler-clo
-00029140: 7365 2d77 6f72 6b65 7222 7d29 0a0a 2020  se-worker"})..  
-00029150: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-00029160: 2020 6173 796e 6320 6465 6620 7265 6d6f    async def remo
-00029170: 7665 5f77 6f72 6b65 7228 0a20 2020 2020  ve_worker(.     
-00029180: 2020 2073 656c 662c 2061 6464 7265 7373     self, address
-00029190: 3a20 7374 722c 202a 2c20 7374 696d 756c  : str, *, stimul
-000291a0: 7573 5f69 643a 2073 7472 2c20 7361 6665  us_id: str, safe
-000291b0: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
-000291c0: 636c 6f73 653a 2062 6f6f 6c20 3d20 5472  close: bool = Tr
-000291d0: 7565 0a20 2020 2029 202d 3e20 4c69 7465  ue.    ) -> Lite
-000291e0: 7261 6c5b 224f 4b22 2c20 2261 6c72 6561  ral["OK", "alrea
-000291f0: 6479 2d72 656d 6f76 6564 225d 3a0a 2020  dy-removed"]:.  
-00029200: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
-00029210: 776f 726b 6572 2066 726f 6d20 636c 7573  worker from clus
-00029220: 7465 722e 0a0a 2020 2020 2020 2020 5765  ter...        We
-00029230: 2064 6f20 7468 6973 2077 6865 6e20 6120   do this when a 
-00029240: 776f 726b 6572 2072 6570 6f72 7473 2074  worker reports t
-00029250: 6861 7420 6974 2070 6c61 6e73 2074 6f20  hat it plans to 
-00029260: 6c65 6176 6520 6f72 2077 6865 6e20 6974  leave or when it
-00029270: 2061 7070 6561 7273 2074 6f20 6265 0a20   appears to be. 
-00029280: 2020 2020 2020 2075 6e72 6573 706f 6e73         unrespons
-00029290: 6976 652e 2054 6869 7320 6d61 7920 7365  ive. This may se
-000292a0: 6e64 2069 7473 2074 6173 6b73 2062 6163  nd its tasks bac
-000292b0: 6b20 746f 2061 2072 656c 6561 7365 6420  k to a released 
-000292c0: 7374 6174 652e 0a0a 2020 2020 2020 2020  state...        
-000292d0: 5365 6520 616c 736f 0a20 2020 2020 2020  See also.       
-000292e0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
-000292f0: 2020 7265 7469 7265 5f77 6f72 6b65 7273    retire_workers
-00029300: 0a20 2020 2020 2020 2063 6c6f 7365 5f77  .        close_w
-00029310: 6f72 6b65 720a 2020 2020 2020 2020 2222  orker.        ""
-00029320: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-00029330: 662e 7374 6174 7573 203d 3d20 5374 6174  f.status == Stat
-00029340: 7573 2e63 6c6f 7365 643a 0a20 2020 2020  us.closed:.     
-00029350: 2020 2020 2020 2072 6574 7572 6e20 2261         return "a
-00029360: 6c72 6561 6479 2d72 656d 6f76 6564 220a  lready-removed".
-00029370: 0a20 2020 2020 2020 2061 6464 7265 7373  .        address
-00029380: 203d 2073 656c 662e 636f 6572 6365 5f61   = self.coerce_a
-00029390: 6464 7265 7373 2861 6464 7265 7373 290a  ddress(address).
-000293a0: 0a20 2020 2020 2020 2069 6620 6164 6472  .        if addr
-000293b0: 6573 7320 6e6f 7420 696e 2073 656c 662e  ess not in self.
-000293c0: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-000293d0: 2020 2020 2072 6574 7572 6e20 2261 6c72       return "alr
-000293e0: 6561 6479 2d72 656d 6f76 6564 220a 0a20  eady-removed".. 
-000293f0: 2020 2020 2020 2068 6f73 7420 3d20 6765         host = ge
-00029400: 745f 6164 6472 6573 735f 686f 7374 2861  t_address_host(a
-00029410: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
-00029420: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
-00029430: 203d 2073 656c 662e 776f 726b 6572 735b   = self.workers[
-00029440: 6164 6472 6573 735d 0a0a 2020 2020 2020  address]..      
-00029450: 2020 6576 656e 745f 6d73 6720 3d20 7b0a    event_msg = {.
-00029460: 2020 2020 2020 2020 2020 2020 2261 6374              "act
-00029470: 696f 6e22 3a20 2272 656d 6f76 652d 776f  ion": "remove-wo
-00029480: 726b 6572 222c 0a20 2020 2020 2020 2020  rker",.         
-00029490: 2020 2022 7072 6f63 6573 7369 6e67 2d74     "processing-t
-000294a0: 6173 6b73 223a 207b 7473 2e6b 6579 2066  asks": {ts.key f
-000294b0: 6f72 2074 7320 696e 2077 732e 7072 6f63  or ts in ws.proc
-000294c0: 6573 7369 6e67 7d2c 0a20 2020 2020 2020  essing},.       
-000294d0: 207d 0a20 2020 2020 2020 2073 656c 662e   }.        self.
-000294e0: 6c6f 675f 6576 656e 7428 6164 6472 6573  log_event(addres
-000294f0: 732c 2065 7665 6e74 5f6d 7367 2e63 6f70  s, event_msg.cop
-00029500: 7928 2929 0a20 2020 2020 2020 2065 7665  y()).        eve
-00029510: 6e74 5f6d 7367 5b22 776f 726b 6572 225d  nt_msg["worker"]
-00029520: 203d 2061 6464 7265 7373 0a20 2020 2020   = address.     
-00029530: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-00029540: 7428 2261 6c6c 222c 2065 7665 6e74 5f6d  t("all", event_m
-00029550: 7367 290a 0a20 2020 2020 2020 206c 6f67  sg)..        log
-00029560: 6765 722e 696e 666f 2822 5265 6d6f 7665  ger.info("Remove
-00029570: 2077 6f72 6b65 7220 2573 222c 2077 7329   worker %s", ws)
-00029580: 0a20 2020 2020 2020 2069 6620 636c 6f73  .        if clos
-00029590: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-000295a0: 6974 6820 7375 7070 7265 7373 2841 7474  ith suppress(Att
-000295b0: 7269 6275 7465 4572 726f 722c 2043 6f6d  ributeError, Com
-000295c0: 6d43 6c6f 7365 6445 7272 6f72 293a 0a20  mClosedError):. 
-000295d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000295e0: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
-000295f0: 5b61 6464 7265 7373 5d2e 7365 6e64 280a  [address].send(.
-00029600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029610: 2020 2020 7b22 6f70 223a 2022 636c 6f73      {"op": "clos
-00029620: 6522 2c20 2272 6561 736f 6e22 3a20 2273  e", "reason": "s
-00029630: 6368 6564 756c 6572 2d72 656d 6f76 652d  cheduler-remove-
-00029640: 776f 726b 6572 227d 0a20 2020 2020 2020  worker"}.       
-00029650: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00029660: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-00029670: 7265 736f 7572 6365 7328 6164 6472 6573  resources(addres
-00029680: 7329 0a0a 2020 2020 2020 2020 6468 3a20  s)..        dh: 
-00029690: 6469 6374 203d 2073 656c 662e 686f 7374  dict = self.host
-000296a0: 5f69 6e66 6f5b 686f 7374 5d0a 2020 2020  _info[host].    
-000296b0: 2020 2020 6468 5f61 6464 7265 7373 6573      dh_addresses
-000296c0: 3a20 7365 7420 3d20 6468 5b22 6164 6472  : set = dh["addr
-000296d0: 6573 7365 7322 5d0a 2020 2020 2020 2020  esses"].        
-000296e0: 6468 5f61 6464 7265 7373 6573 2e72 656d  dh_addresses.rem
-000296f0: 6f76 6528 6164 6472 6573 7329 0a20 2020  ove(address).   
-00029700: 2020 2020 2064 685b 226e 7468 7265 6164       dh["nthread
-00029710: 7322 5d20 2d3d 2077 732e 6e74 6872 6561  s"] -= ws.nthrea
-00029720: 6473 0a20 2020 2020 2020 2073 656c 662e  ds.        self.
-00029730: 746f 7461 6c5f 6e74 6872 6561 6473 202d  total_nthreads -
-00029740: 3d20 7773 2e6e 7468 7265 6164 730a 2020  = ws.nthreads.  
-00029750: 2020 2020 2020 6966 206e 6f74 2064 685f        if not dh_
-00029760: 6164 6472 6573 7365 733a 0a20 2020 2020  addresses:.     
-00029770: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
-00029780: 686f 7374 5f69 6e66 6f5b 686f 7374 5d0a  host_info[host].
-00029790: 0a20 2020 2020 2020 2073 656c 662e 7270  .        self.rp
-000297a0: 632e 7265 6d6f 7665 2861 6464 7265 7373  c.remove(address
-000297b0: 290a 2020 2020 2020 2020 6465 6c20 7365  ).        del se
-000297c0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-000297d0: 6164 6472 6573 735d 0a20 2020 2020 2020  address].       
-000297e0: 2064 656c 2073 656c 662e 616c 6961 7365   del self.aliase
-000297f0: 735b 7773 2e6e 616d 655d 0a20 2020 2020  s[ws.name].     
-00029800: 2020 2073 656c 662e 6964 6c65 2e70 6f70     self.idle.pop
-00029810: 2877 732e 6164 6472 6573 732c 204e 6f6e  (ws.address, Non
-00029820: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00029830: 6964 6c65 5f74 6173 6b5f 636f 756e 742e  idle_task_count.
-00029840: 6469 7363 6172 6428 7773 290a 2020 2020  discard(ws).    
-00029850: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
-00029860: 6564 2e64 6973 6361 7264 2877 7329 0a20  ed.discard(ws). 
-00029870: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
-00029880: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
-00029890: 0a20 2020 2020 2020 2077 732e 7374 6174  .        ws.stat
-000298a0: 7573 203d 2053 7461 7475 732e 636c 6f73  us = Status.clos
-000298b0: 6564 0a20 2020 2020 2020 2073 656c 662e  ed.        self.
-000298c0: 7275 6e6e 696e 672e 6469 7363 6172 6428  running.discard(
-000298d0: 7773 290a 0a20 2020 2020 2020 2072 6563  ws)..        rec
-000298e0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-000298f0: 6373 203d 207b 7d0a 0a20 2020 2020 2020  cs = {}..       
-00029900: 2074 733a 2054 6173 6b53 7461 7465 0a20   ts: TaskState. 
-00029910: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
-00029920: 206c 6973 7428 7773 2e70 726f 6365 7373   list(ws.process
-00029930: 696e 6729 3a0a 2020 2020 2020 2020 2020  ing):.          
-00029940: 2020 6b20 3d20 7473 2e6b 6579 0a20 2020    k = ts.key.   
-00029950: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-00029960: 6e64 6174 696f 6e73 5b6b 5d20 3d20 2272  ndations[k] = "r
-00029970: 656c 6561 7365 6422 0a20 2020 2020 2020  eleased".       
-00029980: 2020 2020 2069 6620 6e6f 7420 7361 6665       if not safe
-00029990: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000299a0: 2020 7473 2e73 7573 7069 6369 6f75 7320    ts.suspicious 
-000299b0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-000299c0: 2020 2020 2074 732e 7072 6566 6978 2e73       ts.prefix.s
-000299d0: 7573 7069 6369 6f75 7320 2b3d 2031 0a20  uspicious += 1. 
-000299e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000299f0: 6620 7473 2e73 7573 7069 6369 6f75 7320  f ts.suspicious 
-00029a00: 3e20 7365 6c66 2e61 6c6c 6f77 6564 5f66  > self.allowed_f
-00029a10: 6169 6c75 7265 733a 0a20 2020 2020 2020  ailures:.       
-00029a20: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00029a30: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00029a40: 5b6b 5d0a 2020 2020 2020 2020 2020 2020  [k].            
-00029a50: 2020 2020 2020 2020 6520 3d20 7069 636b          e = pick
-00029a60: 6c65 2e64 756d 7073 280a 2020 2020 2020  le.dumps(.      
-00029a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029a80: 2020 4b69 6c6c 6564 576f 726b 6572 280a    KilledWorker(.
-00029a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029aa0: 2020 2020 2020 2020 2020 2020 7461 736b              task
-00029ab0: 3d6b 2c0a 2020 2020 2020 2020 2020 2020  =k,.            
-00029ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ad0: 6c61 7374 5f77 6f72 6b65 723d 7773 2e63  last_worker=ws.c
-00029ae0: 6c65 616e 2829 2c0a 2020 2020 2020 2020  lean(),.        
-00029af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b00: 2020 2020 616c 6c6f 7765 645f 6661 696c      allowed_fail
-00029b10: 7572 6573 3d73 656c 662e 616c 6c6f 7765  ures=self.allowe
-00029b20: 645f 6661 696c 7572 6573 2c0a 2020 2020  d_failures,.    
-00029b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b40: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00029b50: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00029b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b70: 2072 203d 2073 656c 662e 7472 616e 7369   r = self.transi
-00029b80: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-00029b90: 2020 2020 2020 2020 2020 2020 2020 6b2c                k,
-00029ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029bb0: 2020 2020 2020 2020 2022 6572 7265 6422           "erred"
-00029bc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00029bd0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00029be0: 696f 6e3d 652c 0a20 2020 2020 2020 2020  ion=e,.         
-00029bf0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00029c00: 6175 7365 3d6b 2c0a 2020 2020 2020 2020  ause=k,.        
-00029c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029c20: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
-00029c30: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
-00029c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029c50: 2077 6f72 6b65 723d 6164 6472 6573 732c   worker=address,
-00029c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029c70: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00029c80: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00029c90: 6d65 6e64 6174 696f 6e73 2e75 7064 6174  mendations.updat
-00029ca0: 6528 7229 0a20 2020 2020 2020 2020 2020  e(r).           
-00029cb0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00029cc0: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-00029cd0: 2020 2020 2020 2020 2020 2020 2020 2254                "T
-00029ce0: 6173 6b20 2573 206d 6172 6b65 6420 6173  ask %s marked as
-00029cf0: 2066 6169 6c65 6420 6265 6361 7573 6520   failed because 
-00029d00: 2564 2077 6f72 6b65 7273 2064 6965 6422  %d workers died"
-00029d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029d20: 2020 2020 2020 2020 2022 2077 6869 6c65           " while
-00029d30: 2074 7279 696e 6720 746f 2072 756e 2069   trying to run i
-00029d40: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-00029d50: 2020 2020 2020 2020 2020 2020 7473 2e6b              ts.k
-00029d60: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-00029d70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00029d80: 2e61 6c6c 6f77 6564 5f66 6169 6c75 7265  .allowed_failure
-00029d90: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00029da0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00029db0: 2020 666f 7220 7473 2069 6e20 6c69 7374    for ts in list
-00029dc0: 2877 732e 6861 735f 7768 6174 293a 0a20  (ws.has_what):. 
-00029dd0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00029de0: 7265 6d6f 7665 5f72 6570 6c69 6361 2874  remove_replica(t
-00029df0: 732c 2077 7329 0a20 2020 2020 2020 2020  s, ws).         
-00029e00: 2020 2069 6620 6e6f 7420 7473 2e77 686f     if not ts.who
-00029e10: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
-00029e20: 2020 2020 2020 6966 2074 732e 7275 6e5f        if ts.run_
-00029e30: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
-00029e40: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-00029e50: 656e 6461 7469 6f6e 735b 7473 2e6b 6579  endations[ts.key
-00029e60: 5d20 3d20 2272 656c 6561 7365 6422 0a20  ] = "released". 
-00029e70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00029e80: 6c73 653a 2020 2320 7075 7265 2064 6174  lse:  # pure dat
-00029e90: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
-00029ea0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00029eb0: 7469 6f6e 735b 7473 2e6b 6579 5d20 3d20  tions[ts.key] = 
-00029ec0: 2266 6f72 676f 7474 656e 220a 0a20 2020  "forgotten"..   
-00029ed0: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
-00029ee0: 7469 6f6e 7328 7265 636f 6d6d 656e 6461  tions(recommenda
-00029ef0: 7469 6f6e 732c 2073 7469 6d75 6c75 735f  tions, stimulus_
-00029f00: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
-00029f10: 0a20 2020 2020 2020 2066 6f72 2070 6c75  .        for plu
-00029f20: 6769 6e20 696e 206c 6973 7428 7365 6c66  gin in list(self
-00029f30: 2e70 6c75 6769 6e73 2e76 616c 7565 7328  .plugins.values(
-00029f40: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00029f50: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00029f60: 2020 2020 2072 6573 756c 7420 3d20 706c       result = pl
-00029f70: 7567 696e 2e72 656d 6f76 655f 776f 726b  ugin.remove_work
-00029f80: 6572 2873 6368 6564 756c 6572 3d73 656c  er(scheduler=sel
-00029f90: 662c 2077 6f72 6b65 723d 6164 6472 6573  f, worker=addres
-00029fa0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00029fb0: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
-00029fc0: 6177 6169 7461 626c 6528 7265 7375 6c74  awaitable(result
-00029fd0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00029fe0: 2020 2020 2020 2061 7761 6974 2072 6573         await res
-00029ff0: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
-0002a000: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0002a010: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0002a020: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-0002a030: 6365 7074 696f 6e28 6529 0a0a 2020 2020  ception(e)..    
-0002a040: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-0002a050: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-0002a060: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-0002a070: 2822 4c6f 7374 2061 6c6c 2077 6f72 6b65  ("Lost all worke
-0002a080: 7273 2229 0a0a 2020 2020 2020 2020 666f  rs")..        fo
-0002a090: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
-0002a0a0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-0002a0b0: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
-0002a0c0: 776f 726b 6572 732e 706f 7028 2861 6464  workers.pop((add
-0002a0d0: 7265 7373 2c20 7729 2c20 4e6f 6e65 290a  ress, w), None).
-0002a0e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002a0f0: 2e62 616e 6477 6964 7468 5f77 6f72 6b65  .bandwidth_worke
-0002a100: 7273 2e70 6f70 2828 772c 2061 6464 7265  rs.pop((w, addre
-0002a110: 7373 292c 204e 6f6e 6529 0a0a 2020 2020  ss), None)..    
-0002a120: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
-0002a130: 6d6f 7665 5f77 6f72 6b65 725f 6672 6f6d  move_worker_from
-0002a140: 5f65 7665 6e74 7328 2920 2d3e 204e 6f6e  _events() -> Non
-0002a150: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0002a160: 2049 6620 7468 6520 776f 726b 6572 2069   If the worker i
-0002a170: 736e 2774 2072 6567 6973 7465 7265 6420  sn't registered 
-0002a180: 616e 796d 6f72 6520 6166 7465 7220 7468  anymore after th
-0002a190: 6520 6465 6c61 792c 2072 656d 6f76 6520  e delay, remove 
-0002a1a0: 6672 6f6d 2065 7665 6e74 730a 2020 2020  from events.    
-0002a1b0: 2020 2020 2020 2020 6966 2061 6464 7265          if addre
-0002a1c0: 7373 206e 6f74 2069 6e20 7365 6c66 2e77  ss not in self.w
-0002a1d0: 6f72 6b65 7273 2061 6e64 2061 6464 7265  orkers and addre
-0002a1e0: 7373 2069 6e20 7365 6c66 2e65 7665 6e74  ss in self.event
-0002a1f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0002a200: 2020 2064 656c 2073 656c 662e 6576 656e     del self.even
-0002a210: 7473 5b61 6464 7265 7373 5d0a 0a20 2020  ts[address]..   
-0002a220: 2020 2020 2063 6c65 616e 7570 5f64 656c       cleanup_del
-0002a230: 6179 203d 2070 6172 7365 5f74 696d 6564  ay = parse_timed
-0002a240: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-0002a250: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
-0002a260: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0002a270: 6368 6564 756c 6572 2e65 7665 6e74 732d  cheduler.events-
-0002a280: 636c 6561 6e75 702d 6465 6c61 7922 290a  cleanup-delay").
-0002a290: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0002a2a0: 2020 2073 656c 662e 5f6f 6e67 6f69 6e67     self._ongoing
-0002a2b0: 5f62 6163 6b67 726f 756e 645f 7461 736b  _background_task
-0002a2c0: 732e 6361 6c6c 5f6c 6174 6572 280a 2020  s.call_later(.  
-0002a2d0: 2020 2020 2020 2020 2020 636c 6561 6e75            cleanu
-0002a2e0: 705f 6465 6c61 792c 2072 656d 6f76 655f  p_delay, remove_
-0002a2f0: 776f 726b 6572 5f66 726f 6d5f 6576 656e  worker_from_even
-0002a300: 7473 0a20 2020 2020 2020 2029 0a20 2020  ts.        ).   
-0002a310: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-0002a320: 6728 2252 656d 6f76 6564 2077 6f72 6b65  g("Removed worke
-0002a330: 7220 2573 222c 2077 7329 0a0a 2020 2020  r %s", ws)..    
-0002a340: 2020 2020 666f 7220 7720 696e 2073 656c      for w in sel
-0002a350: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
-0002a360: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
-0002a370: 6572 5f73 656e 6428 0a20 2020 2020 2020  er_send(.       
-0002a380: 2020 2020 2020 2020 2077 2c0a 2020 2020           w,.    
-0002a390: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0002a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3b0: 2020 226f 7022 3a20 2272 656d 6f76 652d    "op": "remove-
-0002a3c0: 776f 726b 6572 222c 0a20 2020 2020 2020  worker",.       
-0002a3d0: 2020 2020 2020 2020 2020 2020 2022 776f               "wo
-0002a3e0: 726b 6572 223a 2061 6464 7265 7373 2c0a  rker": address,.
-0002a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a400: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
-0002a410: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
-0002a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a430: 7d2c 0a20 2020 2020 2020 2020 2020 2029  },.            )
-0002a440: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0002a450: 2022 4f4b 220a 0a20 2020 2064 6566 2073   "OK"..    def s
-0002a460: 7469 6d75 6c75 735f 6361 6e63 656c 280a  timulus_cancel(.
-0002a470: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
-0002a480: 7973 3a20 5365 7175 656e 6365 5b73 7472  ys: Sequence[str
-0002a490: 5d2c 2063 6c69 656e 743a 2073 7472 2c20  ], client: str, 
-0002a4a0: 666f 7263 653a 2062 6f6f 6c20 3d20 4661  force: bool = Fa
-0002a4b0: 6c73 650a 2020 2020 2920 2d3e 204e 6f6e  lse.    ) -> Non
-0002a4c0: 653a 0a20 2020 2020 2020 2022 2222 5374  e:.        """St
-0002a4d0: 6f70 2065 7865 6375 7469 6f6e 206f 6e20  op execution on 
-0002a4e0: 6120 6c69 7374 206f 6620 6b65 7973 2222  a list of keys""
-0002a4f0: 220a 2020 2020 2020 2020 6c6f 6767 6572  ".        logger
-0002a500: 2e69 6e66 6f28 2243 6c69 656e 7420 2573  .info("Client %s
-0002a510: 2072 6571 7565 7374 7320 746f 2063 616e   requests to can
-0002a520: 6365 6c20 2564 206b 6579 7322 2c20 636c  cel %d keys", cl
-0002a530: 6965 6e74 2c20 6c65 6e28 6b65 7973 2929  ient, len(keys))
-0002a540: 0a20 2020 2020 2020 2069 6620 636c 6965  .        if clie
-0002a550: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-0002a560: 7365 6c66 2e6c 6f67 5f65 7665 6e74 280a  self.log_event(.
-0002a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a580: 636c 6965 6e74 2c20 7b22 6163 7469 6f6e  client, {"action
-0002a590: 223a 2022 6361 6e63 656c 222c 2022 636f  ": "cancel", "co
-0002a5a0: 756e 7422 3a20 6c65 6e28 6b65 7973 292c  unt": len(keys),
-0002a5b0: 2022 666f 7263 6522 3a20 666f 7263 657d   "force": force}
-0002a5c0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002a5d0: 2020 2020 2020 2063 616e 6365 6c6c 6564         cancelled
-0002a5e0: 5f6b 6579 7320 3d20 5b5d 0a20 2020 2020  _keys = [].     
-0002a5f0: 2020 2063 6c69 656e 7473 203d 205b 5d0a     clients = [].
-0002a600: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-0002a610: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
-0002a620: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
-0002a630: 7465 207c 204e 6f6e 6520 3d20 7365 6c66  te | None = self
-0002a640: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
-0002a650: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002a660: 6f74 2074 733a 0a20 2020 2020 2020 2020  ot ts:.         
-0002a670: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0002a680: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0002a690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a6a0: 2063 733a 2043 6c69 656e 7453 7461 7465   cs: ClientState
-0002a6b0: 203d 2073 656c 662e 636c 6965 6e74 735b   = self.clients[
-0002a6c0: 636c 6965 6e74 5d0a 2020 2020 2020 2020  client].        
-0002a6d0: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
-0002a6e0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0002a6f0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0002a700: 2020 2020 2020 2020 2069 6620 666f 7263           if forc
-0002a710: 6520 6f72 2074 732e 7768 6f5f 7761 6e74  e or ts.who_want
-0002a720: 7320 3d3d 207b 6373 7d3a 2020 2320 6e6f  s == {cs}:  # no
-0002a730: 206f 6e65 2065 6c73 6520 7761 6e74 7320   one else wants 
-0002a740: 7468 6973 206b 6579 0a20 2020 2020 2020  this key.       
-0002a750: 2020 2020 2020 2020 2069 6620 7473 2e64           if ts.d
-0002a760: 6570 656e 6465 6e74 733a 0a20 2020 2020  ependents:.     
-0002a770: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002a780: 656c 662e 7374 696d 756c 7573 5f63 616e  elf.stimulus_can
-0002a790: 6365 6c28 0a20 2020 2020 2020 2020 2020  cel(.           
-0002a7a0: 2020 2020 2020 2020 2020 2020 205b 6474               [dt
-0002a7b0: 732e 6b65 7920 666f 7220 6474 7320 696e  s.key for dts in
-0002a7c0: 2074 732e 6465 7065 6e64 656e 7473 5d2c   ts.dependents],
-0002a7d0: 2063 6c69 656e 742c 2066 6f72 6365 3d66   client, force=f
-0002a7e0: 6f72 6365 0a20 2020 2020 2020 2020 2020  orce.           
-0002a7f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002a800: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0002a810: 722e 696e 666f 2822 5363 6865 6475 6c65  r.info("Schedule
-0002a820: 7220 6361 6e63 656c 7320 6b65 7920 2573  r cancels key %s
-0002a830: 2e20 2046 6f72 6365 3d25 7322 2c20 6b65  .  Force=%s", ke
-0002a840: 792c 2066 6f72 6365 290a 2020 2020 2020  y, force).      
-0002a850: 2020 2020 2020 2020 2020 6361 6e63 656c            cancel
-0002a860: 6c65 645f 6b65 7973 2e61 7070 656e 6428  led_keys.append(
-0002a870: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-0002a880: 2063 6c69 656e 7473 2e65 7874 656e 6428   clients.extend(
-0002a890: 6c69 7374 2874 732e 7768 6f5f 7761 6e74  list(ts.who_want
-0002a8a0: 7329 2069 6620 666f 7263 6520 656c 7365  s) if force else
-0002a8b0: 205b 6373 5d29 0a20 2020 2020 2020 2066   [cs]).        f
-0002a8c0: 6f72 2063 7320 696e 2063 6c69 656e 7473  or cs in clients
-0002a8d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0002a8e0: 6c66 2e63 6c69 656e 745f 7265 6c65 6173  lf.client_releas
-0002a8f0: 6573 5f6b 6579 7328 0a20 2020 2020 2020  es_keys(.       
-0002a900: 2020 2020 2020 2020 206b 6579 733d 6361           keys=ca
-0002a910: 6e63 656c 6c65 645f 6b65 7973 2c0a 2020  ncelled_keys,.  
-0002a920: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-0002a930: 6965 6e74 3d63 732e 636c 6965 6e74 5f6b  ient=cs.client_k
-0002a940: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-0002a950: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
-0002a960: 6622 6361 6e63 656c 2d6b 6579 2d7b 7469  f"cancel-key-{ti
-0002a970: 6d65 2829 7d22 2c0a 2020 2020 2020 2020  me()}",.        
-0002a980: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0002a990: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
-0002a9a0: 2022 6361 6e63 656c 6c65 642d 6b65 7973   "cancelled-keys
-0002a9b0: 222c 2022 6b65 7973 223a 2063 616e 6365  ", "keys": cance
-0002a9c0: 6c6c 6564 5f6b 6579 737d 290a 0a20 2020  lled_keys})..   
-0002a9d0: 2064 6566 2063 6c69 656e 745f 6465 7369   def client_desi
-0002a9e0: 7265 735f 6b65 7973 2873 656c 662c 206b  res_keys(self, k
-0002a9f0: 6579 733d 4e6f 6e65 2c20 636c 6965 6e74  eys=None, client
-0002aa00: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
-0002aa10: 6373 3a20 436c 6965 6e74 5374 6174 6520  cs: ClientState 
-0002aa20: 3d20 7365 6c66 2e63 6c69 656e 7473 2e67  = self.clients.g
-0002aa30: 6574 2863 6c69 656e 7429 0a20 2020 2020  et(client).     
-0002aa40: 2020 2069 6620 6373 2069 7320 4e6f 6e65     if cs is None
-0002aa50: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0002aa60: 466f 7220 7075 626c 6973 682c 2071 7565  For publish, que
-0002aa70: 7565 7320 6574 632e 0a20 2020 2020 2020  ues etc..       
-0002aa80: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0002aa90: 735b 636c 6965 6e74 5d20 3d20 6373 203d  s[client] = cs =
-0002aaa0: 2043 6c69 656e 7453 7461 7465 2863 6c69   ClientState(cli
-0002aab0: 656e 7429 0a20 2020 2020 2020 2066 6f72  ent).        for
-0002aac0: 206b 2069 6e20 6b65 7973 3a0a 2020 2020   k in keys:.    
-0002aad0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0002aae0: 662e 7461 736b 732e 6765 7428 6b29 0a20  f.tasks.get(k). 
-0002aaf0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0002ab00: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002ab10: 2020 2020 2020 2020 2020 2320 466f 7220            # For 
-0002ab20: 7075 626c 6973 682c 2071 7565 7565 7320  publish, queues 
-0002ab30: 6574 632e 0a20 2020 2020 2020 2020 2020  etc..           
-0002ab40: 2020 2020 2074 7320 3d20 7365 6c66 2e6e       ts = self.n
-0002ab50: 6577 5f74 6173 6b28 6b2c 204e 6f6e 652c  ew_task(k, None,
-0002ab60: 2022 7265 6c65 6173 6564 2229 0a20 2020   "released").   
-0002ab70: 2020 2020 2020 2020 2074 732e 7768 6f5f           ts.who_
-0002ab80: 7761 6e74 732e 6164 6428 6373 290a 2020  wants.add(cs).  
-0002ab90: 2020 2020 2020 2020 2020 6373 2e77 616e            cs.wan
-0002aba0: 7473 5f77 6861 742e 6164 6428 7473 290a  ts_what.add(ts).
-0002abb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002abc0: 7473 2e73 7461 7465 2069 6e20 2822 6d65  ts.state in ("me
-0002abd0: 6d6f 7279 222c 2022 6572 7265 6422 293a  mory", "erred"):
-0002abe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002abf0: 2073 656c 662e 7265 706f 7274 5f6f 6e5f   self.report_on_
-0002ac00: 6b65 7928 7473 3d74 732c 2063 6c69 656e  key(ts=ts, clien
-0002ac10: 743d 636c 6965 6e74 290a 0a20 2020 2064  t=client)..    d
-0002ac20: 6566 2063 6c69 656e 745f 7265 6c65 6173  ef client_releas
-0002ac30: 6573 5f6b 6579 7328 7365 6c66 2c20 6b65  es_keys(self, ke
-0002ac40: 7973 3d4e 6f6e 652c 2063 6c69 656e 743d  ys=None, client=
-0002ac50: 4e6f 6e65 2c20 7374 696d 756c 7573 5f69  None, stimulus_i
-0002ac60: 643d 4e6f 6e65 293a 0a20 2020 2020 2020  d=None):.       
-0002ac70: 2022 2222 5265 6d6f 7665 206b 6579 7320   """Remove keys 
-0002ac80: 6672 6f6d 2063 6c69 656e 7420 6465 7369  from client desi
-0002ac90: 7265 6420 6c69 7374 2222 220a 2020 2020  red list""".    
-0002aca0: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
-0002acb0: 3d20 7374 696d 756c 7573 5f69 6420 6f72  = stimulus_id or
-0002acc0: 2066 2263 6c69 656e 742d 7265 6c65 6173   f"client-releas
-0002acd0: 6573 2d6b 6579 732d 7b74 696d 6528 297d  es-keys-{time()}
-0002ace0: 220a 2020 2020 2020 2020 6966 206e 6f74  ".        if not
-0002acf0: 2069 7369 6e73 7461 6e63 6528 6b65 7973   isinstance(keys
-0002ad00: 2c20 6c69 7374 293a 0a20 2020 2020 2020  , list):.       
-0002ad10: 2020 2020 206b 6579 7320 3d20 6c69 7374       keys = list
-0002ad20: 286b 6579 7329 0a20 2020 2020 2020 2063  (keys).        c
-0002ad30: 7320 3d20 7365 6c66 2e63 6c69 656e 7473  s = self.clients
-0002ad40: 5b63 6c69 656e 745d 0a20 2020 2020 2020  [client].       
-0002ad50: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0002ad60: 3a20 5265 6373 203d 207b 7d0a 0a20 2020  : Recs = {}..   
-0002ad70: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
-0002ad80: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
-0002ad90: 6b65 7973 3d6b 6579 732c 2063 733d 6373  keys=keys, cs=cs
-0002ada0: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
-0002adb0: 733d 7265 636f 6d6d 656e 6461 7469 6f6e  s=recommendation
-0002adc0: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-0002add0: 7472 616e 7369 7469 6f6e 7328 7265 636f  transitions(reco
-0002ade0: 6d6d 656e 6461 7469 6f6e 732c 2073 7469  mmendations, sti
-0002adf0: 6d75 6c75 735f 6964 290a 0a20 2020 2020  mulus_id)..     
-0002ae00: 2020 2073 656c 662e 7374 696d 756c 7573     self.stimulus
-0002ae10: 5f71 7565 7565 5f73 6c6f 7473 5f6d 6179  _queue_slots_may
-0002ae20: 6265 5f6f 7065 6e65 6428 7374 696d 756c  be_opened(stimul
-0002ae30: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-0002ae40: 6429 0a0a 2020 2020 6465 6620 636c 6965  d)..    def clie
-0002ae50: 6e74 5f68 6561 7274 6265 6174 2873 656c  nt_heartbeat(sel
-0002ae60: 662c 2063 6c69 656e 743d 4e6f 6e65 293a  f, client=None):
-0002ae70: 0a20 2020 2020 2020 2022 2222 4861 6e64  .        """Hand
-0002ae80: 6c65 2068 6561 7274 6265 6174 7320 6672  le heartbeats fr
-0002ae90: 6f6d 2043 6c69 656e 7422 2222 0a20 2020  om Client""".   
-0002aea0: 2020 2020 2063 733a 2043 6c69 656e 7453       cs: ClientS
-0002aeb0: 7461 7465 203d 2073 656c 662e 636c 6965  tate = self.clie
-0002aec0: 6e74 735b 636c 6965 6e74 5d0a 2020 2020  nts[client].    
-0002aed0: 2020 2020 6373 2e6c 6173 745f 7365 656e      cs.last_seen
-0002aee0: 203d 2074 696d 6528 290a 0a20 2020 2023   = time()..    #
-0002aef0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002af00: 2323 0a20 2020 2023 2054 6173 6b20 5661  ##.    # Task Va
-0002af10: 6c69 6461 7469 6f6e 2023 0a20 2020 2023  lidation #.    #
-0002af20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002af30: 2323 0a0a 2020 2020 6465 6620 7661 6c69  ##..    def vali
-0002af40: 6461 7465 5f72 656c 6561 7365 6428 7365  date_released(se
-0002af50: 6c66 2c20 6b65 7929 3a0a 2020 2020 2020  lf, key):.      
-0002af60: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
-0002af70: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-0002af80: 5d0a 2020 2020 2020 2020 6173 7365 7274  ].        assert
-0002af90: 2074 732e 7374 6174 6520 3d3d 2022 7265   ts.state == "re
-0002afa0: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
-0002afb0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-0002afc0: 6974 6572 730a 2020 2020 2020 2020 6173  iters.        as
-0002afd0: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-0002afe0: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-0002aff0: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-0002b000: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
-0002b010: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-0002b020: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-0002b030: 2061 7373 6572 7420 6e6f 7420 616e 7928   assert not any(
-0002b040: 5b74 7320 696e 2064 7473 2e77 6169 7465  [ts in dts.waite
-0002b050: 7273 2066 6f72 2064 7473 2069 6e20 7473  rs for dts in ts
-0002b060: 2e64 6570 656e 6465 6e63 6965 735d 290a  .dependencies]).
-0002b070: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002b080: 7320 6e6f 7420 696e 2073 656c 662e 756e  s not in self.un
-0002b090: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
-0002b0a0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-0002b0b0: 6e20 7365 6c66 2e71 7565 7565 640a 0a20  n self.queued.. 
-0002b0c0: 2020 2064 6566 2076 616c 6964 6174 655f     def validate_
-0002b0d0: 7761 6974 696e 6728 7365 6c66 2c20 6b65  waiting(self, ke
-0002b0e0: 7929 3a0a 2020 2020 2020 2020 7473 3a20  y):.        ts: 
-0002b0f0: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
-0002b100: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-0002b110: 2020 2020 6173 7365 7274 2074 732e 7761      assert ts.wa
-0002b120: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
-0002b130: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-0002b140: 686f 5f68 6173 0a20 2020 2020 2020 2061  ho_has.        a
-0002b150: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-0002b160: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-0002b170: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-0002b180: 2069 6e20 7365 6c66 2e75 6e72 756e 6e61   in self.unrunna
-0002b190: 626c 650a 2020 2020 2020 2020 6173 7365  ble.        asse
-0002b1a0: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
-0002b1b0: 662e 7175 6575 6564 0a20 2020 2020 2020  f.queued.       
-0002b1c0: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-0002b1d0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-0002b1e0: 2020 2020 2020 2020 2023 2057 6520 6172           # We ar
-0002b1f0: 6520 7761 6974 696e 6720 6f6e 2061 2064  e waiting on a d
-0002b200: 6570 656e 6465 6e63 7920 6966 6620 6974  ependency iff it
-0002b210: 2773 206e 6f74 2073 746f 7265 640a 2020  's not stored.  
-0002b220: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002b230: 2062 6f6f 6c28 6474 732e 7768 6f5f 6861   bool(dts.who_ha
-0002b240: 7329 2021 3d20 2864 7473 2069 6e20 7473  s) != (dts in ts
-0002b250: 2e77 6169 7469 6e67 5f6f 6e29 0a20 2020  .waiting_on).   
-0002b260: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002b270: 7473 2069 6e20 6474 732e 7761 6974 6572  ts in dts.waiter
-0002b280: 7320 2023 2058 5858 2065 7665 6e20 6966  s  # XXX even if
-0002b290: 2064 7473 2e5f 7768 6f5f 6861 733f 0a0a   dts._who_has?..
-0002b2a0: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
-0002b2b0: 5f71 7565 7565 6428 7365 6c66 2c20 6b65  _queued(self, ke
-0002b2c0: 7929 3a0a 2020 2020 2020 2020 7473 3a20  y):.        ts: 
-0002b2d0: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
-0002b2e0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-0002b2f0: 2020 2020 6474 733a 2054 6173 6b53 7461      dts: TaskSta
-0002b300: 7465 0a20 2020 2020 2020 2061 7373 6572  te.        asser
-0002b310: 7420 7473 2069 6e20 7365 6c66 2e71 7565  t ts in self.que
-0002b320: 7565 640a 2020 2020 2020 2020 6173 7365  ued.        asse
-0002b330: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-0002b340: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
-0002b350: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
-0002b360: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
-0002b370: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-0002b380: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-0002b390: 7373 6572 7420 6e6f 7420 280a 2020 2020  ssert not (.    
-0002b3a0: 2020 2020 2020 2020 7473 2e77 6f72 6b65          ts.worke
-0002b3b0: 725f 7265 7374 7269 6374 696f 6e73 206f  r_restrictions o
-0002b3c0: 7220 7473 2e68 6f73 745f 7265 7374 7269  r ts.host_restri
-0002b3d0: 6374 696f 6e73 206f 7220 7473 2e72 6573  ctions or ts.res
-0002b3e0: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-0002b3f0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
-0002b400: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-0002b410: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
-0002b420: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0002b430: 6572 7420 6474 732e 7768 6f5f 6861 730a  ert dts.who_has.
-0002b440: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002b450: 7274 2074 7320 696e 2064 7473 2e77 6169  rt ts in dts.wai
-0002b460: 7465 7273 0a0a 2020 2020 6465 6620 7661  ters..    def va
-0002b470: 6c69 6461 7465 5f70 726f 6365 7373 696e  lidate_processin
-0002b480: 6728 7365 6c66 2c20 6b65 7929 3a0a 2020  g(self, key):.  
-0002b490: 2020 2020 2020 7473 3a20 5461 736b 5374        ts: TaskSt
-0002b4a0: 6174 6520 3d20 7365 6c66 2e74 6173 6b73  ate = self.tasks
-0002b4b0: 5b6b 6579 5d0a 2020 2020 2020 2020 6474  [key].        dt
-0002b4c0: 733a 2054 6173 6b53 7461 7465 0a20 2020  s: TaskState.   
-0002b4d0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002b4e0: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
-0002b4f0: 2020 2020 2020 7773 203d 2074 732e 7072        ws = ts.pr
-0002b500: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-0002b510: 2020 2020 6173 7365 7274 2077 730a 2020      assert ws.  
-0002b520: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002b530: 696e 2077 732e 7072 6f63 6573 7369 6e67  in ws.processing
-0002b540: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002b550: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
-0002b560: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0002b570: 206e 6f74 2069 6e20 7365 6c66 2e71 7565   not in self.que
-0002b580: 7565 640a 2020 2020 2020 2020 666f 7220  ued.        for 
-0002b590: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-0002b5a0: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-0002b5b0: 2020 2020 6173 7365 7274 2064 7473 2e77      assert dts.w
-0002b5c0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
-0002b5d0: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-0002b5e0: 6474 732e 7761 6974 6572 730a 0a20 2020  dts.waiters..   
-0002b5f0: 2064 6566 2076 616c 6964 6174 655f 6d65   def validate_me
-0002b600: 6d6f 7279 2873 656c 662c 206b 6579 293a  mory(self, key):
-0002b610: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
-0002b620: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
-0002b630: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-0002b640: 2064 7473 3a20 5461 736b 5374 6174 650a   dts: TaskState.
-0002b650: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002b660: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-0002b670: 2020 6173 7365 7274 2062 6f6f 6c28 7473    assert bool(ts
-0002b680: 2069 6e20 7365 6c66 2e72 6570 6c69 6361   in self.replica
-0002b690: 7465 645f 7461 736b 7329 203d 3d20 286c  ted_tasks) == (l
-0002b6a0: 656e 2874 732e 7768 6f5f 6861 7329 203e  en(ts.who_has) >
-0002b6b0: 2031 290a 2020 2020 2020 2020 6173 7365   1).        asse
-0002b6c0: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
-0002b6d0: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-0002b6e0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-0002b6f0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
-0002b700: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-0002b710: 6e20 7365 6c66 2e75 6e72 756e 6e61 626c  n self.unrunnabl
-0002b720: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
-0002b730: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
-0002b740: 7175 6575 6564 0a20 2020 2020 2020 2066  queued.        f
-0002b750: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0002b760: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
-0002b770: 2020 2020 2061 7373 6572 7420 2864 7473       assert (dts
-0002b780: 2069 6e20 7473 2e77 6169 7465 7273 2920   in ts.waiters) 
-0002b790: 3d3d 2028 0a20 2020 2020 2020 2020 2020  == (.           
-0002b7a0: 2020 2020 2064 7473 2e73 7461 7465 2069       dts.state i
-0002b7b0: 6e20 2822 7761 6974 696e 6722 2c20 2271  n ("waiting", "q
-0002b7c0: 7565 7565 6422 2c20 2270 726f 6365 7373  ueued", "process
-0002b7d0: 696e 6722 2c20 226e 6f2d 776f 726b 6572  ing", "no-worker
-0002b7e0: 2229 0a20 2020 2020 2020 2020 2020 2029  ").            )
-0002b7f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0002b800: 6572 7420 7473 206e 6f74 2069 6e20 6474  ert ts not in dt
-0002b810: 732e 7761 6974 696e 675f 6f6e 0a0a 2020  s.waiting_on..  
-0002b820: 2020 6465 6620 7661 6c69 6461 7465 5f6e    def validate_n
-0002b830: 6f5f 776f 726b 6572 2873 656c 662c 206b  o_worker(self, k
-0002b840: 6579 293a 0a20 2020 2020 2020 2074 733a  ey):.        ts:
-0002b850: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
-0002b860: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-0002b870: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
-0002b880: 6e20 7365 6c66 2e75 6e72 756e 6e61 626c  n self.unrunnabl
-0002b890: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
-0002b8a0: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
-0002b8b0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-0002b8c0: 7420 7473 2069 6e20 7365 6c66 2e75 6e72  t ts in self.unr
-0002b8d0: 756e 6e61 626c 650a 2020 2020 2020 2020  unnable.        
-0002b8e0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-0002b8f0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-0002b900: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-0002b910: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-0002b920: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
-0002b930: 696e 2073 656c 662e 7175 6575 6564 0a20  in self.queued. 
-0002b940: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
-0002b950: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-0002b960: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
-0002b970: 7373 6572 7420 6474 732e 7768 6f5f 6861  ssert dts.who_ha
-0002b980: 730a 0a20 2020 2064 6566 2076 616c 6964  s..    def valid
-0002b990: 6174 655f 6572 7265 6428 7365 6c66 2c20  ate_erred(self, 
-0002b9a0: 6b65 7929 3a0a 2020 2020 2020 2020 7473  key):.        ts
-0002b9b0: 3a20 5461 736b 5374 6174 6520 3d20 7365  : TaskState = se
-0002b9c0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-0002b9d0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-0002b9e0: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
-0002b9f0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-0002ba00: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
-0002ba10: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002ba20: 6e6f 7420 696e 2073 656c 662e 7175 6575  not in self.queu
-0002ba30: 6564 0a0a 2020 2020 6465 6620 7661 6c69  ed..    def vali
-0002ba40: 6461 7465 5f6b 6579 2873 656c 662c 206b  date_key(self, k
-0002ba50: 6579 2c20 7473 3a20 5461 736b 5374 6174  ey, ts: TaskStat
-0002ba60: 6520 7c20 4e6f 6e65 203d 204e 6f6e 6529  e | None = None)
-0002ba70: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-0002ba80: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0002ba90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002baa0: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-0002bab0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-0002bac0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-0002bad0: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
-0002bae0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002baf0: 6767 6572 2e64 6562 7567 2822 4b65 7920  gger.debug("Key 
-0002bb00: 6c6f 7374 3a20 2573 222c 206b 6579 290a  lost: %s", key).
-0002bb10: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0002bb20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002bb30: 2020 7473 2e76 616c 6964 6174 6528 290a    ts.validate().
-0002bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb50: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0002bb60: 2020 2020 2020 2020 2066 756e 6320 3d20           func = 
-0002bb70: 6765 7461 7474 7228 7365 6c66 2c20 2276  getattr(self, "v
-0002bb80: 616c 6964 6174 655f 2220 2b20 7473 2e73  alidate_" + ts.s
-0002bb90: 7461 7465 2e72 6570 6c61 6365 2822 2d22  tate.replace("-"
-0002bba0: 2c20 225f 2229 290a 2020 2020 2020 2020  , "_")).        
-0002bbb0: 2020 2020 2020 2020 6578 6365 7074 2041          except A
-0002bbc0: 7474 7269 6275 7465 4572 726f 723a 0a20  ttributeError:. 
-0002bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bbe0: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
-0002bbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002bc00: 2020 2020 2020 2020 2022 7365 6c66 2e76           "self.v
-0002bc10: 616c 6964 6174 655f 2573 206e 6f74 2066  alidate_%s not f
-0002bc20: 6f75 6e64 222c 2074 732e 7374 6174 652e  ound", ts.state.
-0002bc30: 7265 706c 6163 6528 222d 222c 2022 5f22  replace("-", "_"
-0002bc40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002bc50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002bc60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bc80: 2020 6675 6e63 286b 6579 290a 2020 2020    func(key).    
-0002bc90: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0002bca0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0002bcb0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-0002bcc0: 6365 7074 696f 6e28 6529 0a20 2020 2020  ception(e).     
-0002bcd0: 2020 2020 2020 2069 6620 4c4f 475f 5044         if LOG_PD
-0002bce0: 423a 0a20 2020 2020 2020 2020 2020 2020  B:.             
-0002bcf0: 2020 2069 6d70 6f72 7420 7064 620a 0a20     import pdb.. 
-0002bd00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0002bd10: 6462 2e73 6574 5f74 7261 6365 2829 0a20  db.set_trace(). 
-0002bd20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0002bd30: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-0002bd40: 7465 5f73 7461 7465 2873 656c 662c 2061  te_state(self, a
-0002bd50: 6c6c 6f77 5f6f 7665 726c 6170 3a20 626f  llow_overlap: bo
-0002bd60: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
-0002bd70: 6f6e 653a 0a20 2020 2020 2020 2076 616c  one:.        val
-0002bd80: 6964 6174 655f 7374 6174 6528 7365 6c66  idate_state(self
-0002bd90: 2e74 6173 6b73 2c20 7365 6c66 2e77 6f72  .tasks, self.wor
-0002bda0: 6b65 7273 2c20 7365 6c66 2e63 6c69 656e  kers, self.clien
-0002bdb0: 7473 290a 0a20 2020 2020 2020 2069 6620  ts)..        if 
-0002bdc0: 6e6f 7420 2873 6574 2873 656c 662e 776f  not (set(self.wo
-0002bdd0: 726b 6572 7329 203d 3d20 7365 7428 7365  rkers) == set(se
-0002bde0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 7329  lf.stream_comms)
-0002bdf0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0002be00: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0002be10: 2257 6f72 6b65 7273 206e 6f74 2074 6865  "Workers not the
-0002be20: 2073 616d 6520 696e 2061 6c6c 2063 6f6c   same in all col
-0002be30: 6c65 6374 696f 6e73 2229 0a0a 2020 2020  lections")..    
-0002be40: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-0002be50: 7275 6e6e 696e 672e 6973 7375 7065 7273  running.issupers
-0002be60: 6574 2873 656c 662e 6964 6c65 2e76 616c  et(self.idle.val
-0002be70: 7565 7328 2929 2c20 280a 2020 2020 2020  ues()), (.      
-0002be80: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
-0002be90: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
-0002bea0: 2020 2020 2020 2073 6574 2873 656c 662e         set(self.
-0002beb0: 6964 6c65 2e76 616c 7565 7328 2929 2c0a  idle.values()),.
-0002bec0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002bed0: 2020 6173 7365 7274 2073 656c 662e 7275    assert self.ru
-0002bee0: 6e6e 696e 672e 6973 7375 7065 7273 6574  nning.issuperset
-0002bef0: 2873 656c 662e 6964 6c65 5f74 6173 6b5f  (self.idle_task_
-0002bf00: 636f 756e 7429 2c20 280a 2020 2020 2020  count), (.      
-0002bf10: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
-0002bf20: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
-0002bf30: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-0002bf40: 5f74 6173 6b5f 636f 756e 742e 636f 7079  _task_count.copy
-0002bf50: 2829 2c0a 2020 2020 2020 2020 290a 2020  (),.        ).  
-0002bf60: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-0002bf70: 662e 7275 6e6e 696e 672e 6973 7375 7065  f.running.issupe
-0002bf80: 7273 6574 2873 656c 662e 7361 7475 7261  rset(self.satura
-0002bf90: 7465 6429 2c20 280a 2020 2020 2020 2020  ted), (.        
-0002bfa0: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
-0002bfb0: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-0002bfc0: 2020 2020 2073 656c 662e 7361 7475 7261       self.satura
-0002bfd0: 7465 642e 636f 7079 2829 2c0a 2020 2020  ted.copy(),.    
-0002bfe0: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
-0002bff0: 7365 7274 2073 656c 662e 7361 7475 7261  sert self.satura
-0002c000: 7465 642e 6973 6469 736a 6f69 6e74 2873  ted.isdisjoint(s
-0002c010: 656c 662e 6964 6c65 2e76 616c 7565 7328  elf.idle.values(
-0002c020: 2929 2c20 280a 2020 2020 2020 2020 2020  )), (.          
-0002c030: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
-0002c040: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-0002c050: 2020 2020 2073 6574 2873 656c 662e 6964       set(self.id
-0002c060: 6c65 2e76 616c 7565 7328 2929 2c0a 2020  le.values()),.  
-0002c070: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0002c080: 2074 6173 6b5f 7072 6566 6978 5f63 6f75   task_prefix_cou
-0002c090: 6e74 733a 2064 6566 6175 6c74 6469 6374  nts: defaultdict
-0002c0a0: 5b73 7472 2c20 696e 745d 203d 2064 6566  [str, int] = def
-0002c0b0: 6175 6c74 6469 6374 2869 6e74 290a 2020  aultdict(int).  
-0002c0c0: 2020 2020 2020 666f 7220 772c 2077 7320        for w, ws 
-0002c0d0: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-0002c0e0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0002c0f0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0002c100: 7374 616e 6365 2877 2c20 7374 7229 2c20  stance(w, str), 
-0002c110: 2874 7970 6528 7729 2c20 7729 0a20 2020  (type(w), w).   
-0002c120: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002c130: 6973 696e 7374 616e 6365 2877 732c 2057  isinstance(ws, W
-0002c140: 6f72 6b65 7253 7461 7465 292c 2028 7479  orkerState), (ty
-0002c150: 7065 2877 7329 2c20 7773 290a 2020 2020  pe(ws), ws).    
-0002c160: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-0002c170: 732e 6164 6472 6573 7320 3d3d 2077 0a0a  s.address == w..
-0002c180: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-0002c190: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-0002c1a0: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
-0002c1b0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002c1c0: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
-0002c1d0: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-0002c1e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002c1f0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-0002c200: 7320 6e6f 7420 696e 2073 656c 662e 7275  s not in self.ru
-0002c210: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-0002c220: 2020 2020 2020 6173 7365 7274 2077 732e        assert ws.
-0002c230: 6164 6472 6573 7320 6e6f 7420 696e 2073  address not in s
-0002c240: 656c 662e 6964 6c65 0a20 2020 2020 2020  elf.idle.       
-0002c250: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002c260: 7773 206e 6f74 2069 6e20 7365 6c66 2e73  ws not in self.s
-0002c270: 6174 7572 6174 6564 0a0a 2020 2020 2020  aturated..      
-0002c280: 2020 2020 2020 6173 7365 7274 2077 732e        assert ws.
-0002c290: 6c6f 6e67 5f72 756e 6e69 6e67 2e69 7373  long_running.iss
-0002c2a0: 7562 7365 7428 7773 2e70 726f 6365 7373  ubset(ws.process
-0002c2b0: 696e 6729 0a20 2020 2020 2020 2020 2020  ing).           
-0002c2c0: 2069 6620 6e6f 7420 7773 2e70 726f 6365   if not ws.proce
-0002c2d0: 7373 696e 673a 0a20 2020 2020 2020 2020  ssing:.         
-0002c2e0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0002c2f0: 7420 7773 2e6f 6363 7570 616e 6379 0a20  t ws.occupancy. 
-0002c300: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002c310: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-0002c320: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-0002c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c340: 2020 2061 7373 6572 7420 7773 2e61 6464     assert ws.add
-0002c350: 7265 7373 2069 6e20 7365 6c66 2e69 646c  ress in self.idl
-0002c360: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
-0002c370: 7365 7274 206e 6f74 2077 732e 6e65 6564  sert not ws.need
-0002c380: 735f 7768 6174 2e6b 6579 7328 2920 2620  s_what.keys() & 
-0002c390: 7773 2e68 6173 5f77 6861 740a 2020 2020  ws.has_what.    
-0002c3a0: 2020 2020 2020 2020 6163 7475 616c 5f6e          actual_n
-0002c3b0: 6565 6473 5f77 6861 743a 2064 6566 6175  eeds_what: defau
-0002c3c0: 6c74 6469 6374 5b54 6173 6b53 7461 7465  ltdict[TaskState
-0002c3d0: 2c20 696e 745d 203d 2064 6566 6175 6c74  , int] = default
-0002c3e0: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
-0002c3f0: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-0002c400: 7773 2e70 726f 6365 7373 696e 673a 0a20  ws.processing:. 
-0002c410: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002c420: 6f72 2074 7373 2069 6e20 7473 2e64 6570  or tss in ts.dep
-0002c430: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-0002c440: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002c450: 6620 7473 7320 6e6f 7420 696e 2077 732e  f tss not in ws.
-0002c460: 6861 735f 7768 6174 3a0a 2020 2020 2020  has_what:.      
-0002c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c480: 2020 6163 7475 616c 5f6e 6565 6473 5f77    actual_needs_w
-0002c490: 6861 745b 7473 735d 202b 3d20 310a 2020  hat[tss] += 1.  
-0002c4a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002c4b0: 2061 6374 7561 6c5f 6e65 6564 735f 7768   actual_needs_wh
-0002c4c0: 6174 203d 3d20 7773 2e6e 6565 6473 5f77  at == ws.needs_w
-0002c4d0: 6861 740a 2020 2020 2020 2020 2020 2020  hat.            
-0002c4e0: 6173 7365 7274 2028 7773 2e73 7461 7475  assert (ws.statu
-0002c4f0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-0002c500: 696e 6729 203d 3d20 2877 7320 696e 2073  ing) == (ws in s
-0002c510: 656c 662e 7275 6e6e 696e 6729 0a20 2020  elf.running).   
-0002c520: 2020 2020 2020 2020 2066 6f72 206e 616d           for nam
-0002c530: 652c 2063 6f75 6e74 2069 6e20 7773 2e74  e, count in ws.t
-0002c540: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-0002c550: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0002c560: 2020 2020 2020 2020 2020 7461 736b 5f70            task_p
-0002c570: 7265 6669 785f 636f 756e 7473 5b6e 616d  refix_counts[nam
-0002c580: 655d 202b 3d20 636f 756e 740a 0a20 2020  e] += count..   
-0002c590: 2020 2020 2061 7373 6572 7420 7461 736b       assert task
-0002c5a0: 5f70 7265 6669 785f 636f 756e 7473 2e6b  _prefix_counts.k
-0002c5b0: 6579 7328 2920 3d3d 2073 656c 662e 5f74  eys() == self._t
-0002c5c0: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-0002c5d0: 5f67 6c6f 6261 6c2e 6b65 7973 2829 0a20  _global.keys(). 
-0002c5e0: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
-0002c5f0: 2067 6c6f 6261 6c5f 636f 756e 7420 696e   global_count in
-0002c600: 2073 656c 662e 5f74 6173 6b5f 7072 6566   self._task_pref
-0002c610: 6978 5f63 6f75 6e74 5f67 6c6f 6261 6c2e  ix_count_global.
-0002c620: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0002c630: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
-0002c640: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-0002c650: 736b 5f70 7265 6669 785f 636f 756e 7473  sk_prefix_counts
-0002c660: 5b6e 616d 655d 203d 3d20 676c 6f62 616c  [name] == global
-0002c670: 5f63 6f75 6e74 0a20 2020 2020 2020 2020  _count.         
-0002c680: 2020 2029 2c20 6622 7b6e 616d 657d 3a20     ), f"{name}: 
-0002c690: 7b74 6173 6b5f 7072 6566 6978 5f63 6f75  {task_prefix_cou
-0002c6a0: 6e74 735b 6e61 6d65 5d7d 2028 7773 7329  nts[name]} (wss)
-0002c6b0: 2c20 7b67 6c6f 6261 6c5f 636f 756e 747d  , {global_count}
-0002c6c0: 2028 676c 6f62 616c 2922 0a0a 2020 2020   (global)"..    
-0002c6d0: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
-0002c6e0: 6c66 2e72 756e 6e69 6e67 3a0a 2020 2020  lf.running:.    
-0002c6f0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-0002c700: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-0002c710: 7573 2e72 756e 6e69 6e67 0a20 2020 2020  us.running.     
-0002c720: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-0002c730: 2e61 6464 7265 7373 2069 6e20 7365 6c66  .address in self
-0002c740: 2e77 6f72 6b65 7273 0a0a 2020 2020 2020  .workers..      
-0002c750: 2020 666f 7220 6b2c 2074 7320 696e 2073    for k, ts in s
-0002c760: 656c 662e 7461 736b 732e 6974 656d 7328  elf.tasks.items(
-0002c770: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
-0002c780: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-0002c790: 2874 732c 2054 6173 6b53 7461 7465 292c  (ts, TaskState),
-0002c7a0: 2028 7479 7065 2874 7329 2c20 7473 290a   (type(ts), ts).
-0002c7b0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002c7c0: 7274 2074 732e 6b65 7920 3d3d 206b 0a20  rt ts.key == k. 
-0002c7d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002c7e0: 7420 626f 6f6c 2874 7320 696e 2073 656c  t bool(ts in sel
-0002c7f0: 662e 7265 706c 6963 6174 6564 5f74 6173  f.replicated_tas
-0002c800: 6b73 2920 3d3d 2028 6c65 6e28 7473 2e77  ks) == (len(ts.w
-0002c810: 686f 5f68 6173 2920 3e20 3129 0a20 2020  ho_has) > 1).   
-0002c820: 2020 2020 2020 2020 2073 656c 662e 7661           self.va
-0002c830: 6c69 6461 7465 5f6b 6579 286b 2c20 7473  lidate_key(k, ts
-0002c840: 290a 0a20 2020 2020 2020 2066 6f72 2074  )..        for t
-0002c850: 7320 696e 2073 656c 662e 7265 706c 6963  s in self.replic
-0002c860: 6174 6564 5f74 6173 6b73 3a0a 2020 2020  ated_tasks:.    
-0002c870: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002c880: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
-0002c890: 7279 220a 2020 2020 2020 2020 2020 2020  ry".            
-0002c8a0: 6173 7365 7274 2074 732e 6b65 7920 696e  assert ts.key in
-0002c8b0: 2073 656c 662e 7461 736b 730a 0a20 2020   self.tasks..   
-0002c8c0: 2020 2020 2066 6f72 2063 2c20 6373 2069       for c, cs i
-0002c8d0: 6e20 7365 6c66 2e63 6c69 656e 7473 2e69  n self.clients.i
-0002c8e0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-0002c8f0: 2020 2020 2320 636c 6965 6e74 3d4e 6f6e      # client=Non
-0002c900: 6520 6973 206f 6674 656e 2075 7365 6420  e is often used 
-0002c910: 696e 2074 6573 7473 2e2e 2e0a 2020 2020  in tests....    
-0002c920: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-0002c930: 2069 7320 4e6f 6e65 206f 7220 7479 7065   is None or type
-0002c940: 2863 2920 3d3d 2073 7472 2c20 2874 7970  (c) == str, (typ
-0002c950: 6528 6329 2c20 6329 0a20 2020 2020 2020  e(c), c).       
-0002c960: 2020 2020 2061 7373 6572 7420 7479 7065       assert type
-0002c970: 2863 7329 203d 3d20 436c 6965 6e74 5374  (cs) == ClientSt
-0002c980: 6174 652c 2028 7479 7065 2863 7329 2c20  ate, (type(cs), 
-0002c990: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
-0002c9a0: 6173 7365 7274 2063 732e 636c 6965 6e74  assert cs.client
-0002c9b0: 5f6b 6579 203d 3d20 630a 0a20 2020 2020  _key == c..     
-0002c9c0: 2020 2061 203d 207b 773a 2077 732e 6e62     a = {w: ws.nb
-0002c9d0: 7974 6573 2066 6f72 2077 2c20 7773 2069  ytes for w, ws i
-0002c9e0: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e69  n self.workers.i
-0002c9f0: 7465 6d73 2829 7d0a 2020 2020 2020 2020  tems()}.        
-0002ca00: 6220 3d20 7b0a 2020 2020 2020 2020 2020  b = {.          
-0002ca10: 2020 773a 2073 756d 2874 732e 6765 745f    w: sum(ts.get_
-0002ca20: 6e62 7974 6573 2829 2066 6f72 2074 7320  nbytes() for ts 
-0002ca30: 696e 2077 732e 6861 735f 7768 6174 290a  in ws.has_what).
-0002ca40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002ca50: 772c 2077 7320 696e 2073 656c 662e 776f  w, ws in self.wo
-0002ca60: 726b 6572 732e 6974 656d 7328 290a 2020  rkers.items().  
-0002ca70: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0002ca80: 6173 7365 7274 2061 203d 3d20 622c 2028  assert a == b, (
-0002ca90: 612c 2062 290a 0a20 2020 2020 2020 2069  a, b)..        i
-0002caa0: 6620 7365 6c66 2e74 7261 6e73 6974 696f  f self.transitio
-0002cab0: 6e5f 636f 756e 7465 725f 6d61 783a 0a20  n_counter_max:. 
-0002cac0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002cad0: 7420 7365 6c66 2e74 7261 6e73 6974 696f  t self.transitio
-0002cae0: 6e5f 636f 756e 7465 7220 3c20 7365 6c66  n_counter < self
-0002caf0: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-0002cb00: 7465 725f 6d61 780a 0a20 2020 2023 2323  ter_max..    ###
-0002cb10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002cb20: 0a20 2020 2023 204d 616e 6167 6520 4d65  .    # Manage Me
-0002cb30: 7373 6167 6573 2023 0a20 2020 2023 2323  ssages #.    ###
-0002cb40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002cb50: 0a0a 2020 2020 6465 6620 7265 706f 7274  ..    def report
-0002cb60: 2873 656c 662c 206d 7367 3a20 6469 6374  (self, msg: dict
-0002cb70: 2c20 7473 3a20 5461 736b 5374 6174 6520  , ts: TaskState 
-0002cb80: 7c20 4e6f 6e65 203d 204e 6f6e 652c 2063  | None = None, c
-0002cb90: 6c69 656e 743a 2073 7472 207c 204e 6f6e  lient: str | Non
-0002cba0: 6520 3d20 4e6f 6e65 293a 0a20 2020 2020  e = None):.     
-0002cbb0: 2020 2022 2222 0a20 2020 2020 2020 2050     """.        P
-0002cbc0: 7562 6c69 7368 2075 7064 6174 6573 2074  ublish updates t
-0002cbd0: 6f20 616c 6c20 6c69 7374 656e 696e 6720  o all listening 
-0002cbe0: 5175 6575 6573 2061 6e64 2043 6f6d 6d73  Queues and Comms
-0002cbf0: 0a0a 2020 2020 2020 2020 4966 2074 6865  ..        If the
-0002cc00: 206d 6573 7361 6765 2063 6f6e 7461 696e   message contain
-0002cc10: 7320 6120 6b65 7920 7468 656e 2077 6520  s a key then we 
-0002cc20: 6f6e 6c79 2073 656e 6420 7468 6520 6d65  only send the me
-0002cc30: 7373 6167 6520 746f 2074 686f 7365 0a20  ssage to those. 
-0002cc40: 2020 2020 2020 2063 6f6d 6d73 2074 6861         comms tha
-0002cc50: 7420 6361 7265 2061 626f 7574 2074 6865  t care about the
-0002cc60: 206b 6579 2e0a 2020 2020 2020 2020 2222   key..        ""
-0002cc70: 220a 2020 2020 2020 2020 6966 2074 7320  ".        if ts 
-0002cc80: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0002cc90: 2020 2020 206d 7367 5f6b 6579 203d 206d       msg_key = m
-0002cca0: 7367 2e67 6574 2822 6b65 7922 290a 2020  sg.get("key").  
-0002ccb0: 2020 2020 2020 2020 2020 6966 206d 7367            if msg
-0002ccc0: 5f6b 6579 2069 7320 6e6f 7420 4e6f 6e65  _key is not None
-0002ccd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002cce0: 2020 7461 736b 733a 2064 6963 7420 3d20    tasks: dict = 
-0002ccf0: 7365 6c66 2e74 6173 6b73 0a20 2020 2020  self.tasks.     
-0002cd00: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-0002cd10: 7461 736b 732e 6765 7428 6d73 675f 6b65  tasks.get(msg_ke
-0002cd20: 7929 0a0a 2020 2020 2020 2020 636c 6965  y)..        clie
-0002cd30: 6e74 5f63 6f6d 6d73 3a20 6469 6374 203d  nt_comms: dict =
-0002cd40: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
-0002cd50: 6d73 0a20 2020 2020 2020 2069 6620 7473  ms.        if ts
-0002cd60: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002cd70: 2020 2020 2020 2320 4e6f 7469 6679 2061        # Notify a
-0002cd80: 6c6c 2063 6c69 656e 7473 0a20 2020 2020  ll clients.     
-0002cd90: 2020 2020 2020 2063 6c69 656e 745f 6b65         client_ke
-0002cda0: 7973 203d 206c 6973 7428 636c 6965 6e74  ys = list(client
-0002cdb0: 5f63 6f6d 6d73 290a 2020 2020 2020 2020  _comms).        
-0002cdc0: 656c 6966 2063 6c69 656e 7420 6973 204e  elif client is N
-0002cdd0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002cde0: 2023 204e 6f74 6966 7920 636c 6965 6e74   # Notify client
-0002cdf0: 7320 696e 7465 7265 7374 6564 2069 6e20  s interested in 
-0002ce00: 6b65 790a 2020 2020 2020 2020 2020 2020  key.            
-0002ce10: 636c 6965 6e74 5f6b 6579 7320 3d20 5b63  client_keys = [c
-0002ce20: 732e 636c 6965 6e74 5f6b 6579 2066 6f72  s.client_key for
-0002ce30: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
-0002ce40: 6e74 735d 0a20 2020 2020 2020 2065 6c73  nts].        els
-0002ce50: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0002ce60: 204e 6f74 6966 7920 636c 6965 6e74 7320   Notify clients 
-0002ce70: 696e 7465 7265 7374 6564 2069 6e20 6b65  interested in ke
-0002ce80: 7920 2869 6e63 6c75 6469 6e67 2060 636c  y (including `cl
-0002ce90: 6965 6e74 6029 0a20 2020 2020 2020 2020  ient`).         
-0002cea0: 2020 2063 6c69 656e 745f 6b65 7973 203d     client_keys =
-0002ceb0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0002cec0: 2020 2063 732e 636c 6965 6e74 5f6b 6579     cs.client_key
-0002ced0: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
-0002cee0: 6f5f 7761 6e74 7320 6966 2063 732e 636c  o_wants if cs.cl
-0002cef0: 6965 6e74 5f6b 6579 2021 3d20 636c 6965  ient_key != clie
-0002cf00: 6e74 0a20 2020 2020 2020 2020 2020 205d  nt.            ]
-0002cf10: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0002cf20: 656e 745f 6b65 7973 2e61 7070 656e 6428  ent_keys.append(
-0002cf30: 636c 6965 6e74 290a 0a20 2020 2020 2020  client)..       
-0002cf40: 206b 3a20 7374 720a 2020 2020 2020 2020   k: str.        
-0002cf50: 666f 7220 6b20 696e 2063 6c69 656e 745f  for k in client_
-0002cf60: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-0002cf70: 2020 6320 3d20 636c 6965 6e74 5f63 6f6d    c = client_com
-0002cf80: 6d73 2e67 6574 286b 290a 2020 2020 2020  ms.get(k).      
-0002cf90: 2020 2020 2020 6966 2063 2069 7320 4e6f        if c is No
-0002cfa0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0002cfb0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-0002cfc0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0002cfd0: 2020 2020 2020 2020 2020 2020 2020 632e                c.
-0002cfe0: 7365 6e64 286d 7367 290a 2020 2020 2020  send(msg).      
-0002cff0: 2020 2020 2020 2020 2020 2320 6c6f 6767            # logg
-0002d000: 6572 2e64 6562 7567 2822 5363 6865 6475  er.debug("Schedu
-0002d010: 6c65 7220 7365 6e64 7320 6d65 7373 6167  ler sends messag
-0002d020: 6520 746f 2063 6c69 656e 7420 2573 222c  e to client %s",
-0002d030: 206d 7367 290a 2020 2020 2020 2020 2020   msg).          
-0002d040: 2020 6578 6365 7074 2043 6f6d 6d43 6c6f    except CommClo
-0002d050: 7365 6445 7272 6f72 3a0a 2020 2020 2020  sedError:.      
-0002d060: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0002d070: 662e 7374 6174 7573 203d 3d20 5374 6174  f.status == Stat
-0002d080: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
+00028530: 2020 2020 2020 2063 6869 6c64 5f64 6570         child_dep
+00028540: 7320 3d20 7365 6c66 2e74 6173 6b73 5b64  s = self.tasks[d
+00028550: 6570 5d2e 6465 7065 6e64 656e 6369 6573  ep].dependencies
+00028560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028570: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00028580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028590: 2020 2063 6869 6c64 5f64 6570 7320 3d20     child_deps = 
+000285a0: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
+000285b0: 2020 2020 2020 2020 2020 6966 2061 6c6c            if all
+000285c0: 2864 2069 6e20 646f 6e65 2066 6f72 2064  (d in done for d
+000285d0: 2069 6e20 6368 696c 645f 6465 7073 293a   in child_deps):
+000285e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000285f0: 2020 2020 2020 2020 2069 6620 6465 7020           if dep 
+00028600: 696e 2073 656c 662e 7461 736b 7320 616e  in self.tasks an
+00028610: 6420 6465 7020 6e6f 7420 696e 2064 6f6e  d dep not in don
+00028620: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00028630: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00028640: 6f6e 652e 6164 6428 6465 7029 0a20 2020  one.add(dep).   
+00028650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028660: 2020 2020 2020 2020 2073 7461 636b 2e61           stack.a
+00028670: 7070 656e 6428 6465 7029 0a20 2020 2020  ppend(dep).     
+00028680: 2020 2066 6f72 2061 6e63 2069 6e20 646f     for anc in do
+00028690: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000286a0: 6473 6b2e 706f 7028 616e 632c 204e 6f6e  dsk.pop(anc, Non
+000286b0: 6529 0a20 2020 2020 2020 2020 2020 2064  e).            d
+000286c0: 6570 656e 6465 6e63 6965 732e 706f 7028  ependencies.pop(
+000286d0: 616e 632c 204e 6f6e 6529 0a20 2020 2020  anc, None).     
+000286e0: 2020 2072 6574 7572 6e20 646f 6e65 0a0a     return done..
+000286f0: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+00028700: 640a 2020 2020 6465 6620 6d61 7465 7269  d.    def materi
+00028710: 616c 697a 655f 6772 6170 6828 686c 673a  alize_graph(hlg:
+00028720: 2048 6967 684c 6576 656c 4772 6170 6829   HighLevelGraph)
+00028730: 202d 3e20 7475 706c 655b 6469 6374 2c20   -> tuple[dict, 
+00028740: 6469 6374 2c20 6469 6374 2c20 6469 6374  dict, dict, dict
+00028750: 5d3a 0a20 2020 2020 2020 2066 726f 6d20  ]:.        from 
+00028760: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+00028770: 6572 2069 6d70 6f72 7420 6475 6d70 735f  er import dumps_
+00028780: 7461 736b 0a0a 2020 2020 2020 2020 6b65  task..        ke
+00028790: 795f 616e 6e6f 7461 7469 6f6e 7320 3d20  y_annotations = 
+000287a0: 7b7d 0a20 2020 2020 2020 2064 736b 203d  {}.        dsk =
+000287b0: 2064 6173 6b2e 7574 696c 732e 656e 7375   dask.utils.ensu
+000287c0: 7265 5f64 6963 7428 686c 6729 0a0a 2020  re_dict(hlg)..  
+000287d0: 2020 2020 2020 666f 7220 6c61 7965 7220        for layer 
+000287e0: 696e 2068 6c67 2e6c 6179 6572 732e 7661  in hlg.layers.va
+000287f0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00028800: 2020 2020 6966 206c 6179 6572 2e61 6e6e      if layer.ann
+00028810: 6f74 6174 696f 6e73 3a0a 2020 2020 2020  otations:.      
+00028820: 2020 2020 2020 2020 2020 616e 6e6f 7420            annot 
+00028830: 3d20 6c61 7965 722e 616e 6e6f 7461 7469  = layer.annotati
+00028840: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
+00028850: 2020 2020 6b65 795f 616e 6e6f 7461 7469      key_annotati
+00028860: 6f6e 732e 7570 6461 7465 287b 7374 7269  ons.update({stri
+00028870: 6e67 6966 7928 6b29 3a20 616e 6e6f 7420  ngify(k): annot 
+00028880: 666f 7220 6b20 696e 206c 6179 6572 7d29  for k in layer})
+00028890: 0a0a 2020 2020 2020 2020 6465 7065 6e64  ..        depend
+000288a0: 656e 6369 6573 2c20 5f20 3d20 6765 745f  encies, _ = get_
+000288b0: 6465 7073 2864 736b 290a 0a20 2020 2020  deps(dsk)..     
+000288c0: 2020 2023 2052 656d 6f76 6520 6046 7574     # Remove `Fut
+000288d0: 7572 6560 206f 626a 6563 7473 2066 726f  ure` objects fro
+000288e0: 6d20 6772 6170 6820 616e 6420 6e6f 7465  m graph and note
+000288f0: 2061 6e79 2066 7574 7572 6520 6465 7065   any future depe
+00028900: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
+00028910: 2064 736b 3220 3d20 7b7d 0a20 2020 2020   dsk2 = {}.     
+00028920: 2020 2066 7574 5f64 6570 7320 3d20 7b7d     fut_deps = {}
+00028930: 0a20 2020 2020 2020 2066 6f72 206b 2c20  .        for k, 
+00028940: 7620 696e 2064 736b 2e69 7465 6d73 2829  v in dsk.items()
+00028950: 3a0a 2020 2020 2020 2020 2020 2020 6473  :.            ds
+00028960: 6b32 5b6b 5d2c 2066 7574 7320 3d20 756e  k2[k], futs = un
+00028970: 7061 636b 5f72 656d 6f74 6564 6174 6128  pack_remotedata(
+00028980: 762c 2062 7974 655f 6b65 7973 3d54 7275  v, byte_keys=Tru
+00028990: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+000289a0: 6620 6675 7473 3a0a 2020 2020 2020 2020  f futs:.        
+000289b0: 2020 2020 2020 2020 6675 745f 6465 7073          fut_deps
+000289c0: 5b6b 5d20 3d20 6675 7473 0a20 2020 2020  [k] = futs.     
+000289d0: 2020 2064 736b 203d 2064 736b 320a 0a20     dsk = dsk2.. 
+000289e0: 2020 2020 2020 2023 202d 2041 6464 2069         # - Add i
+000289f0: 6e20 6465 7073 2066 6f72 2061 6e79 2074  n deps for any t
+00028a00: 6173 6b73 2074 6861 7420 6465 7065 6e64  asks that depend
+00028a10: 206f 6e20 6675 7475 7265 730a 2020 2020   on futures.    
+00028a20: 2020 2020 666f 7220 6b2c 2066 7574 7572      for k, futur
+00028a30: 6573 2069 6e20 6675 745f 6465 7073 2e69  es in fut_deps.i
+00028a40: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00028a50: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
+00028a60: 5b6b 5d2e 7570 6461 7465 2866 2e6b 6579  [k].update(f.key
+00028a70: 2066 6f72 2066 2069 6e20 6675 7475 7265   for f in future
+00028a80: 7329 0a20 2020 2020 2020 206e 6577 5f64  s).        new_d
+00028a90: 736b 203d 207b 7d0a 2020 2020 2020 2020  sk = {}.        
+00028aa0: 2320 416e 6e6f 7461 7469 6f6e 2063 616c  # Annotation cal
+00028ab0: 6c61 626c 6573 2061 7265 2065 7661 6c75  lables are evalu
+00028ac0: 6174 6564 206f 6e20 7468 6520 6e6f 6e2d  ated on the non-
+00028ad0: 7374 7269 6e67 6966 6965 6420 7665 7273  stringified vers
+00028ae0: 696f 6e20 6f66 0a20 2020 2020 2020 2023  ion of.        #
+00028af0: 2074 6865 206b 6579 730a 2020 2020 2020   the keys.      
+00028b00: 2020 7072 655f 7374 7269 6e67 6966 6965    pre_stringifie
+00028b10: 645f 6b65 7973 203d 207b 7d0a 2020 2020  d_keys = {}.    
+00028b20: 2020 2020 6578 636c 7573 6976 6520 3d20      exclusive = 
+00028b30: 7365 7428 686c 6729 0a20 2020 2020 2020  set(hlg).       
+00028b40: 2066 6f72 206b 2c20 7620 696e 2064 736b   for k, v in dsk
+00028b50: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00028b60: 2020 2020 2020 6e65 775f 6b20 3d20 7374        new_k = st
+00028b70: 7269 6e67 6966 7928 6b29 0a20 2020 2020  ringify(k).     
+00028b80: 2020 2020 2020 2070 7265 5f73 7472 696e         pre_strin
+00028b90: 6769 6669 6564 5f6b 6579 735b 6e65 775f  gified_keys[new_
+00028ba0: 6b5d 203d 206b 0a20 2020 2020 2020 2020  k] = k.         
+00028bb0: 2020 206e 6577 5f64 736b 5b6e 6577 5f6b     new_dsk[new_k
+00028bc0: 5d20 3d20 7374 7269 6e67 6966 7928 762c  ] = stringify(v,
+00028bd0: 2065 7863 6c75 7369 7665 3d65 7863 6c75   exclusive=exclu
+00028be0: 7369 7665 290a 2020 2020 2020 2020 6173  sive).        as
+00028bf0: 7365 7274 206c 656e 286e 6577 5f64 736b  sert len(new_dsk
+00028c00: 2920 3d3d 206c 656e 2870 7265 5f73 7472  ) == len(pre_str
+00028c10: 696e 6769 6669 6564 5f6b 6579 7329 0a20  ingified_keys). 
+00028c20: 2020 2020 2020 2064 736b 203d 206e 6577         dsk = new
+00028c30: 5f64 736b 0a20 2020 2020 2020 2064 6570  _dsk.        dep
+00028c40: 656e 6465 6e63 6965 7320 3d20 7b0a 2020  endencies = {.  
+00028c50: 2020 2020 2020 2020 2020 7374 7269 6e67            string
+00028c60: 6966 7928 6b29 3a20 7b73 7472 696e 6769  ify(k): {stringi
+00028c70: 6679 2864 6570 2920 666f 7220 6465 7020  fy(dep) for dep 
+00028c80: 696e 2064 6570 737d 0a20 2020 2020 2020  in deps}.       
+00028c90: 2020 2020 2066 6f72 206b 2c20 6465 7073       for k, deps
+00028ca0: 2069 6e20 6465 7065 6e64 656e 6369 6573   in dependencies
+00028cb0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
+00028cc0: 207d 0a0a 2020 2020 2020 2020 2320 5265   }..        # Re
+00028cd0: 6d6f 7665 2061 6e79 2073 656c 662d 6465  move any self-de
+00028ce0: 7065 6e64 656e 6369 6573 2028 6861 7070  pendencies (happ
+00028cf0: 656e 7320 6f6e 2074 6573 745f 7075 626c  ens on test_publ
+00028d00: 6973 685f 6261 6728 2920 616e 6420 6f74  ish_bag() and ot
+00028d10: 6865 7273 290a 2020 2020 2020 2020 666f  hers).        fo
+00028d20: 7220 6b2c 2076 2069 6e20 6465 7065 6e64  r k, v in depend
+00028d30: 656e 6369 6573 2e69 7465 6d73 2829 3a0a  encies.items():.
+00028d40: 2020 2020 2020 2020 2020 2020 6465 7073              deps
+00028d50: 203d 2073 6574 2876 290a 2020 2020 2020   = set(v).      
+00028d60: 2020 2020 2020 6966 206b 2069 6e20 6465        if k in de
+00028d70: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+00028d80: 2020 2020 6465 7073 2e72 656d 6f76 6528      deps.remove(
+00028d90: 6b29 0a20 2020 2020 2020 2020 2020 2064  k).            d
+00028da0: 6570 656e 6465 6e63 6965 735b 6b5d 203d  ependencies[k] =
+00028db0: 2064 6570 730a 0a20 2020 2020 2020 2023   deps..        #
+00028dc0: 2052 656d 6f76 6520 616c 6961 7365 730a   Remove aliases.
+00028dd0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
+00028de0: 206c 6973 7428 6473 6b29 3a0a 2020 2020   list(dsk):.    
+00028df0: 2020 2020 2020 2020 6966 2064 736b 5b6b          if dsk[k
+00028e00: 5d20 6973 206b 3a0a 2020 2020 2020 2020  ] is k:.        
+00028e10: 2020 2020 2020 2020 6465 6c20 6473 6b5b          del dsk[
+00028e20: 6b5d 0a20 2020 2020 2020 2064 736b 203d  k].        dsk =
+00028e30: 2076 616c 6d61 7028 6475 6d70 735f 7461   valmap(dumps_ta
+00028e40: 736b 2c20 6473 6b29 0a20 2020 2020 2020  sk, dsk).       
+00028e50: 2072 6574 7572 6e20 6473 6b2c 2064 6570   return dsk, dep
+00028e60: 656e 6465 6e63 6965 732c 206b 6579 5f61  endencies, key_a
+00028e70: 6e6e 6f74 6174 696f 6e73 2c20 7072 655f  nnotations, pre_
+00028e80: 7374 7269 6e67 6966 6965 645f 6b65 7973  stringified_keys
+00028e90: 0a0a 2020 2020 6465 6620 7374 696d 756c  ..    def stimul
+00028ea0: 7573 5f71 7565 7565 5f73 6c6f 7473 5f6d  us_queue_slots_m
+00028eb0: 6179 6265 5f6f 7065 6e65 6428 7365 6c66  aybe_opened(self
+00028ec0: 2c20 2a2c 2073 7469 6d75 6c75 735f 6964  , *, stimulus_id
+00028ed0: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+00028ee0: 2020 2020 2020 2020 2222 2252 6573 706f          """Respo
+00028ef0: 6e64 2074 6f20 616e 2065 7665 6e74 2077  nd to an event w
+00028f00: 6869 6368 206d 6179 2068 6176 6520 6f70  hich may have op
+00028f10: 656e 6564 2073 706f 7473 206f 6e20 776f  ened spots on wo
+00028f20: 726b 6572 2074 6872 6561 6470 6f6f 6c73  rker threadpools
+00028f30: 0a0a 2020 2020 2020 2020 5365 6c65 6374  ..        Select
+00028f40: 7320 7468 6520 6170 7072 6f70 7269 6174  s the appropriat
+00028f50: 6520 6e75 6d62 6572 206f 6620 7461 736b  e number of task
+00028f60: 7320 6672 6f6d 2074 6865 2066 726f 6e74  s from the front
+00028f70: 206f 6620 7468 6520 7175 6575 6520 6163   of the queue ac
+00028f80: 636f 7264 696e 6720 746f 0a20 2020 2020  cording to.     
+00028f90: 2020 2074 6865 2074 6f74 616c 206e 756d     the total num
+00028fa0: 6265 7220 6f66 2074 6173 6b20 736c 6f74  ber of task slot
+00028fb0: 7320 6176 6169 6c61 626c 6520 6f6e 2077  s available on w
+00028fc0: 6f72 6b65 7273 2028 706f 7465 6e74 6961  orkers (potentia
+00028fd0: 6c6c 7920 3029 2c20 616e 640a 2020 2020  lly 0), and.    
+00028fe0: 2020 2020 7472 616e 7369 7469 6f6e 7320      transitions 
+00028ff0: 7468 656d 2074 6f20 6060 7072 6f63 6573  them to ``proces
+00029000: 7369 6e67 6060 2e0a 0a20 2020 2020 2020  sing``...       
+00029010: 204e 6f74 6573 0a20 2020 2020 2020 202d   Notes.        -
+00029020: 2d2d 2d2d 0a20 2020 2020 2020 204f 7468  ----.        Oth
+00029030: 6572 2074 7261 6e73 6974 696f 6e73 2072  er transitions r
+00029040: 656c 6174 6564 2074 6f20 7468 6973 2073  elated to this s
+00029050: 7469 6d75 6c75 7320 7368 6f75 6c64 2062  timulus should b
+00029060: 6520 6675 6c6c 7920 7072 6f63 6573 7365  e fully processe
+00029070: 6420 6265 666f 7265 6861 6e64 2c0a 2020  d beforehand,.  
+00029080: 2020 2020 2020 736f 2061 6e79 2074 6173        so any tas
+00029090: 6b73 2074 6861 7420 6265 6361 6d65 2072  ks that became r
+000290a0: 756e 6e61 626c 6520 6172 6520 616c 7265  unnable are alre
+000290b0: 6164 7920 696e 2060 6070 726f 6365 7373  ady in ``process
+000290c0: 696e 6760 602e 204f 7468 6572 7769 7365  ing``. Otherwise
+000290d0: 2c0a 2020 2020 2020 2020 6f76 6572 7072  ,.        overpr
+000290e0: 6f64 7563 7469 6f6e 2063 616e 206f 6363  oduction can occ
+000290f0: 7572 2069 6620 7175 6575 6564 2074 6173  ur if queued tas
+00029100: 6b73 2067 6574 2073 6368 6564 756c 6564  ks get scheduled
+00029110: 2062 6566 6f72 6520 646f 776e 7374 7265   before downstre
+00029120: 616d 2074 6173 6b73 2e0a 0a20 2020 2020  am tasks...     
+00029130: 2020 204d 7573 7420 6265 2063 616c 6c65     Must be calle
+00029140: 6420 6166 7465 7220 6063 6865 636b 5f69  d after `check_i
+00029150: 646c 655f 7361 7475 7261 7465 6460 3b20  dle_saturated`; 
+00029160: 692e 652e 2060 6964 6c65 5f74 6173 6b5f  i.e. `idle_task_
+00029170: 636f 756e 7460 206d 7573 7420 6265 2075  count` must be u
+00029180: 700a 2020 2020 2020 2020 746f 2064 6174  p.        to dat
+00029190: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
+000291a0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+000291b0: 6c66 2e71 7565 7565 643a 0a20 2020 2020  lf.queued:.     
+000291c0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+000291d0: 2020 2020 2020 736c 6f74 735f 6176 6169        slots_avai
+000291e0: 6c61 626c 6520 3d20 7375 6d28 0a20 2020  lable = sum(.   
+000291f0: 2020 2020 2020 2020 205f 7461 736b 5f73           _task_s
+00029200: 6c6f 7473 5f61 7661 696c 6162 6c65 2877  lots_available(w
+00029210: 732c 2073 656c 662e 574f 524b 4552 5f53  s, self.WORKER_S
+00029220: 4154 5552 4154 494f 4e29 0a20 2020 2020  ATURATION).     
+00029230: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+00029240: 2073 656c 662e 6964 6c65 5f74 6173 6b5f   self.idle_task_
+00029250: 636f 756e 740a 2020 2020 2020 2020 290a  count.        ).
+00029260: 2020 2020 2020 2020 6966 2073 6c6f 7473          if slots
+00029270: 5f61 7661 696c 6162 6c65 203d 3d20 303a  _available == 0:
+00029280: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00029290: 7572 6e0a 0a20 2020 2020 2020 2072 6563  urn..        rec
+000292a0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+000292b0: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
+000292c0: 666f 7220 7174 7320 696e 2073 656c 662e  for qts in self.
+000292d0: 7175 6575 6564 2e70 6565 6b6e 2873 6c6f  queued.peekn(slo
+000292e0: 7473 5f61 7661 696c 6162 6c65 293a 0a20  ts_available):. 
+000292f0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00029300: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00029310: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00029320: 6572 7420 7174 732e 7374 6174 6520 3d3d  ert qts.state ==
+00029330: 2022 7175 6575 6564 222c 2071 7473 2e73   "queued", qts.s
+00029340: 7461 7465 0a20 2020 2020 2020 2020 2020  tate.           
+00029350: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00029360: 7174 732e 7072 6f63 6573 7369 6e67 5f6f  qts.processing_o
+00029370: 6e2c 2028 7174 732c 2071 7473 2e70 726f  n, (qts, qts.pro
+00029380: 6365 7373 696e 675f 6f6e 290a 2020 2020  cessing_on).    
+00029390: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000293a0: 7274 206e 6f74 2071 7473 2e77 6169 7469  rt not qts.waiti
+000293b0: 6e67 5f6f 6e2c 2028 7174 732c 2071 7473  ng_on, (qts, qts
+000293c0: 2e70 726f 6365 7373 696e 675f 6f6e 290a  .processing_on).
+000293d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293e0: 6173 7365 7274 2071 7473 2e77 686f 5f77  assert qts.who_w
+000293f0: 616e 7473 206f 7220 7174 732e 7761 6974  ants or qts.wait
+00029400: 6572 732c 2071 7473 0a20 2020 2020 2020  ers, qts.       
+00029410: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00029420: 696f 6e73 5b71 7473 2e6b 6579 5d20 3d20  ions[qts.key] = 
+00029430: 2270 726f 6365 7373 696e 6722 0a0a 2020  "processing"..  
+00029440: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+00029450: 6974 696f 6e73 2872 6563 6f6d 6d65 6e64  itions(recommend
+00029460: 6174 696f 6e73 2c20 7374 696d 756c 7573  ations, stimulus
+00029470: 5f69 6429 0a0a 2020 2020 6465 6620 7374  _id)..    def st
+00029480: 696d 756c 7573 5f74 6173 6b5f 6669 6e69  imulus_task_fini
+00029490: 7368 6564 2873 656c 662c 206b 6579 2c20  shed(self, key, 
+000294a0: 776f 726b 6572 2c20 7374 696d 756c 7573  worker, stimulus
+000294b0: 5f69 642c 2072 756e 5f69 642c 202a 2a6b  _id, run_id, **k
+000294c0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+000294d0: 2222 224d 6172 6b20 7468 6174 2061 2074  """Mark that a t
+000294e0: 6173 6b20 6861 7320 6669 6e69 7368 6564  ask has finished
+000294f0: 2065 7865 6375 7469 6f6e 206f 6e20 6120   execution on a 
+00029500: 7061 7274 6963 756c 6172 2077 6f72 6b65  particular worke
+00029510: 7222 2222 0a20 2020 2020 2020 206c 6f67  r""".        log
+00029520: 6765 722e 6465 6275 6728 2253 7469 6d75  ger.debug("Stimu
+00029530: 6c75 7320 7461 736b 2066 696e 6973 6865  lus task finishe
+00029540: 6420 2573 5b25 645d 2025 7322 2c20 6b65  d %s[%d] %s", ke
+00029550: 792c 2072 756e 5f69 642c 2077 6f72 6b65  y, run_id, worke
+00029560: 7229 0a0a 2020 2020 2020 2020 7265 636f  r)..        reco
+00029570: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+00029580: 7320 3d20 7b7d 0a20 2020 2020 2020 2063  s = {}.        c
+00029590: 6c69 656e 745f 6d73 6773 3a20 4d73 6773  lient_msgs: Msgs
+000295a0: 203d 207b 7d0a 2020 2020 2020 2020 776f   = {}.        wo
+000295b0: 726b 6572 5f6d 7367 733a 204d 7367 7320  rker_msgs: Msgs 
+000295c0: 3d20 7b7d 0a0a 2020 2020 2020 2020 7773  = {}..        ws
+000295d0: 3a20 576f 726b 6572 5374 6174 6520 3d20  : WorkerState = 
+000295e0: 7365 6c66 2e77 6f72 6b65 7273 5b77 6f72  self.workers[wor
+000295f0: 6b65 725d 0a20 2020 2020 2020 2074 733a  ker].        ts:
+00029600: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
+00029610: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
+00029620: 0a20 2020 2020 2020 2069 6620 7473 2069  .        if ts i
+00029630: 7320 4e6f 6e65 206f 7220 7473 2e73 7461  s None or ts.sta
+00029640: 7465 2069 6e20 2822 7265 6c65 6173 6564  te in ("released
+00029650: 222c 2022 7175 6575 6564 2229 3a0a 2020  ", "queued"):.  
+00029660: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00029670: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00029680: 2020 2020 2020 2020 2252 6563 6569 7665          "Receive
+00029690: 6420 616c 7265 6164 7920 636f 6d70 7574  d already comput
+000296a0: 6564 2074 6173 6b2c 2077 6f72 6b65 723a  ed task, worker:
+000296b0: 2025 732c 2073 7461 7465 3a20 2573 220a   %s, state: %s".
+000296c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296d0: 222c 206b 6579 3a20 2573 2c20 7768 6f5f  ", key: %s, who_
+000296e0: 6861 733a 2025 7322 2c0a 2020 2020 2020  has: %s",.      
+000296f0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00029700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029710: 2020 7473 2e73 7461 7465 2069 6620 7473    ts.state if ts
+00029720: 2065 6c73 6520 2266 6f72 676f 7474 656e   else "forgotten
+00029730: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00029740: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
+00029750: 2020 2020 2020 2020 7473 2e77 686f 5f68          ts.who_h
+00029760: 6173 2069 6620 7473 2065 6c73 6520 7b7d  as if ts else {}
+00029770: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00029780: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00029790: 6572 5f6d 7367 735b 776f 726b 6572 5d20  er_msgs[worker] 
+000297a0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+000297b0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000297c0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+000297d0: 2266 7265 652d 6b65 7973 222c 0a20 2020  "free-keys",.   
+000297e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000297f0: 2022 6b65 7973 223a 205b 6b65 795d 2c0a   "keys": [key],.
+00029800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029810: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
+00029820: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
+00029830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029840: 7d0a 2020 2020 2020 2020 2020 2020 5d0a  }.            ].
+00029850: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
+00029860: 7275 6e5f 6964 2021 3d20 7275 6e5f 6964  run_id != run_id
+00029870: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00029880: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
+00029890: 6e67 5f6f 6e20 6f72 2074 732e 7072 6f63  ng_on or ts.proc
+000298a0: 6573 7369 6e67 5f6f 6e2e 6164 6472 6573  essing_on.addres
+000298b0: 7320 213d 2077 6f72 6b65 723a 0a20 2020  s != worker:.   
+000298c0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+000298d0: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
+000298e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000298f0: 5265 6365 6976 6564 2073 7461 6c65 2074  Received stale t
+00029900: 6173 6b20 7275 6e2c 2077 6f72 6b65 723a  ask run, worker:
+00029910: 2025 732c 206b 6579 3a20 2573 2c20 7275   %s, key: %s, ru
+00029920: 6e5f 6964 3a20 2564 2028 2564 2922 2c0a  n_id: %d (%d)",.
+00029930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029940: 2020 2020 776f 726b 6572 2c0a 2020 2020      worker,.    
+00029950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029960: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+00029970: 2020 2020 2020 2020 2072 756e 5f69 642c           run_id,
+00029980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029990: 2020 2020 2074 732e 7275 6e5f 6964 2c0a       ts.run_id,.
+000299a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000299b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000299c0: 2020 776f 726b 6572 5f6d 7367 735b 776f    worker_msgs[wo
+000299d0: 726b 6572 5d20 3d20 5b0a 2020 2020 2020  rker] = [.      
+000299e0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+000299f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029a00: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
+00029a10: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
+00029a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029a30: 2020 2022 6b65 7973 223a 205b 6b65 795d     "keys": [key]
+00029a40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029a50: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
+00029a60: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
+00029a70: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
+00029a80: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00029a90: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+00029aa0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00029ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029ac0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+00029ad0: 7473 2e6b 6579 5d20 3d20 2272 656c 6561  ts.key] = "relea
+00029ae0: 7365 6422 0a20 2020 2020 2020 2065 6c69  sed".        eli
+00029af0: 6620 7473 2e73 7461 7465 203d 3d20 226d  f ts.state == "m
+00029b00: 656d 6f72 7922 3a0a 2020 2020 2020 2020  emory":.        
+00029b10: 2020 2020 7365 6c66 2e61 6464 5f6b 6579      self.add_key
+00029b20: 7328 776f 726b 6572 3d77 6f72 6b65 722c  s(worker=worker,
+00029b30: 206b 6579 733d 5b6b 6579 5d29 0a20 2020   keys=[key]).   
+00029b40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00029b50: 2020 2020 2020 2074 732e 6d65 7461 6461         ts.metada
+00029b60: 7461 2e75 7064 6174 6528 6b77 6172 6773  ta.update(kwargs
+00029b70: 5b22 6d65 7461 6461 7461 225d 290a 2020  ["metadata"]).  
+00029b80: 2020 2020 2020 2020 2020 723a 2074 7570            r: tup
+00029b90: 6c65 203d 2073 656c 662e 5f74 7261 6e73  le = self._trans
+00029ba0: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
+00029bb0: 2020 2020 2020 206b 6579 2c20 226d 656d         key, "mem
+00029bc0: 6f72 7922 2c20 7374 696d 756c 7573 5f69  ory", stimulus_i
+00029bd0: 642c 2077 6f72 6b65 723d 776f 726b 6572  d, worker=worker
+00029be0: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
+00029bf0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00029c00: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00029c10: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+00029c20: 732c 2077 6f72 6b65 725f 6d73 6773 203d  s, worker_msgs =
+00029c30: 2072 0a0a 2020 2020 2020 2020 2020 2020   r..            
+00029c40: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
+00029c50: 6d65 6d6f 7279 223a 0a20 2020 2020 2020  memory":.       
+00029c60: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00029c70: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
+00029c80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00029c90: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00029ca0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+00029cb0: 726b 6572 5f6d 7367 730a 0a20 2020 2064  rker_msgs..    d
+00029cc0: 6566 2073 7469 6d75 6c75 735f 7461 736b  ef stimulus_task
+00029cd0: 5f65 7272 6564 280a 2020 2020 2020 2020  _erred(.        
+00029ce0: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
+00029cf0: 793d 4e6f 6e65 2c0a 2020 2020 2020 2020  y=None,.        
+00029d00: 776f 726b 6572 3d4e 6f6e 652c 0a20 2020  worker=None,.   
+00029d10: 2020 2020 2065 7863 6570 7469 6f6e 3d4e       exception=N
+00029d20: 6f6e 652c 0a20 2020 2020 2020 2073 7469  one,.        sti
+00029d30: 6d75 6c75 735f 6964 3d4e 6f6e 652c 0a20  mulus_id=None,. 
+00029d40: 2020 2020 2020 2074 7261 6365 6261 636b         traceback
+00029d50: 3d4e 6f6e 652c 0a20 2020 2020 2020 202a  =None,.        *
+00029d60: 2a6b 7761 7267 732c 0a20 2020 2029 3a0a  *kwargs,.    ):.
+00029d70: 2020 2020 2020 2020 2222 224d 6172 6b20          """Mark 
+00029d80: 7468 6174 2061 2074 6173 6b20 6861 7320  that a task has 
+00029d90: 6572 7265 6420 6f6e 2061 2070 6172 7469  erred on a parti
+00029da0: 6375 6c61 7220 776f 726b 6572 2222 220a  cular worker""".
+00029db0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+00029dc0: 6562 7567 2822 5374 696d 756c 7573 2074  ebug("Stimulus t
+00029dd0: 6173 6b20 6572 7265 6420 2573 2c20 2573  ask erred %s, %s
+00029de0: 222c 206b 6579 2c20 776f 726b 6572 290a  ", key, worker).
+00029df0: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
+00029e00: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
+00029e10: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+00029e20: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
+00029e30: 6e65 206f 7220 7473 2e73 7461 7465 2021  ne or ts.state !
+00029e40: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
+00029e50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00029e60: 726e 207b 7d2c 207b 7d2c 207b 7d0a 0a20  rn {}, {}, {}.. 
+00029e70: 2020 2020 2020 2069 6620 7473 2e72 6574         if ts.ret
+00029e80: 7269 6573 203e 2030 3a0a 2020 2020 2020  ries > 0:.      
+00029e90: 2020 2020 2020 7473 2e72 6574 7269 6573        ts.retries
+00029ea0: 202d 3d20 310a 2020 2020 2020 2020 2020   -= 1.          
+00029eb0: 2020 7265 7475 726e 2073 656c 662e 5f74    return self._t
+00029ec0: 7261 6e73 6974 696f 6e28 6b65 792c 2022  ransition(key, "
+00029ed0: 7761 6974 696e 6722 2c20 7374 696d 756c  waiting", stimul
+00029ee0: 7573 5f69 6429 0a20 2020 2020 2020 2065  us_id).        e
+00029ef0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00029f00: 2072 6574 7572 6e20 7365 6c66 2e5f 7472   return self._tr
+00029f10: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
+00029f20: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
+00029f30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00029f40: 6572 7265 6422 2c0a 2020 2020 2020 2020  erred",.        
+00029f50: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+00029f60: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+00029f70: 2020 2020 2063 6175 7365 3d6b 6579 2c0a       cause=key,.
+00029f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029f90: 6578 6365 7074 696f 6e3d 6578 6365 7074  exception=except
+00029fa0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+00029fb0: 2020 2020 2074 7261 6365 6261 636b 3d74       traceback=t
+00029fc0: 7261 6365 6261 636b 2c0a 2020 2020 2020  raceback,.      
+00029fd0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00029fe0: 3d77 6f72 6b65 722c 0a20 2020 2020 2020  =worker,.       
+00029ff0: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+0002a000: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+0002a010: 0a0a 2020 2020 6465 6620 7374 696d 756c  ..    def stimul
+0002a020: 7573 5f72 6574 7279 2873 656c 662c 206b  us_retry(self, k
+0002a030: 6579 732c 2063 6c69 656e 743d 4e6f 6e65  eys, client=None
+0002a040: 293a 0a20 2020 2020 2020 206c 6f67 6765  ):.        logge
+0002a050: 722e 696e 666f 2822 436c 6965 6e74 2025  r.info("Client %
+0002a060: 7320 7265 7175 6573 7473 2074 6f20 7265  s requests to re
+0002a070: 7472 7920 2564 206b 6579 7322 2c20 636c  try %d keys", cl
+0002a080: 6965 6e74 2c20 6c65 6e28 6b65 7973 2929  ient, len(keys))
+0002a090: 0a20 2020 2020 2020 2069 6620 636c 6965  .        if clie
+0002a0a0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+0002a0b0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2863  self.log_event(c
+0002a0c0: 6c69 656e 742c 207b 2261 6374 696f 6e22  lient, {"action"
+0002a0d0: 3a20 2272 6574 7279 222c 2022 636f 756e  : "retry", "coun
+0002a0e0: 7422 3a20 6c65 6e28 6b65 7973 297d 290a  t": len(keys)}).
+0002a0f0: 0a20 2020 2020 2020 2073 7461 636b 203d  .        stack =
+0002a100: 206c 6973 7428 6b65 7973 290a 2020 2020   list(keys).    
+0002a110: 2020 2020 7365 656e 203d 2073 6574 2829      seen = set()
+0002a120: 0a20 2020 2020 2020 2072 6f6f 7473 203d  .        roots =
+0002a130: 205b 5d0a 2020 2020 2020 2020 7768 696c   [].        whil
+0002a140: 6520 7374 6163 6b3a 0a20 2020 2020 2020  e stack:.       
+0002a150: 2020 2020 206b 6579 203d 2073 7461 636b       key = stack
+0002a160: 2e70 6f70 2829 0a20 2020 2020 2020 2020  .pop().         
+0002a170: 2020 2073 6565 6e2e 6164 6428 6b65 7929     seen.add(key)
+0002a180: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
+0002a190: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+0002a1a0: 5d0a 2020 2020 2020 2020 2020 2020 6572  ].            er
+0002a1b0: 7265 645f 6465 7073 203d 205b 6474 732e  red_deps = [dts.
+0002a1c0: 6b65 7920 666f 7220 6474 7320 696e 2074  key for dts in t
+0002a1d0: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
+0002a1e0: 6620 6474 732e 7374 6174 6520 3d3d 2022  f dts.state == "
+0002a1f0: 6572 7265 6422 5d0a 2020 2020 2020 2020  erred"].        
+0002a200: 2020 2020 6966 2065 7272 6564 5f64 6570      if erred_dep
+0002a210: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002a220: 2020 2073 7461 636b 2e65 7874 656e 6428     stack.extend(
+0002a230: 6572 7265 645f 6465 7073 290a 2020 2020  erred_deps).    
+0002a240: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002a250: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+0002a260: 6f74 732e 6170 7065 6e64 286b 6579 290a  ots.append(key).
+0002a270: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+0002a280: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+0002a290: 207b 6b65 793a 2022 7761 6974 696e 6722   {key: "waiting"
+0002a2a0: 2066 6f72 206b 6579 2069 6e20 726f 6f74   for key in root
+0002a2b0: 737d 0a20 2020 2020 2020 2073 656c 662e  s}.        self.
+0002a2c0: 7472 616e 7369 7469 6f6e 7328 7265 636f  transitions(reco
+0002a2d0: 6d6d 656e 6461 7469 6f6e 732c 2066 2273  mmendations, f"s
+0002a2e0: 7469 6d75 6c75 732d 7265 7472 792d 7b74  timulus-retry-{t
+0002a2f0: 696d 6528 297d 2229 0a0a 2020 2020 2020  ime()}")..      
+0002a300: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+0002a310: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+0002a320: 666f 7220 6b65 7920 696e 2073 6565 6e3a  for key in seen:
+0002a330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a340: 2061 7373 6572 7420 6e6f 7420 7365 6c66   assert not self
+0002a350: 2e74 6173 6b73 5b6b 6579 5d2e 6578 6365  .tasks[key].exce
+0002a360: 7074 696f 6e5f 626c 616d 650a 0a20 2020  ption_blame..   
+0002a370: 2020 2020 2072 6574 7572 6e20 7475 706c       return tupl
+0002a380: 6528 7365 656e 290a 0a20 2020 2064 6566  e(seen)..    def
+0002a390: 2063 6c6f 7365 5f77 6f72 6b65 7228 7365   close_worker(se
+0002a3a0: 6c66 2c20 776f 726b 6572 3a20 7374 7229  lf, worker: str)
+0002a3b0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002a3c0: 2020 2222 2241 736b 2061 2077 6f72 6b65    """Ask a worke
+0002a3d0: 7220 746f 2073 6875 7420 6974 7365 6c66  r to shut itself
+0002a3e0: 2064 6f77 6e2e 2044 6f20 6e6f 7420 7761   down. Do not wa
+0002a3f0: 6974 2066 6f72 2069 7420 746f 2074 616b  it for it to tak
+0002a400: 6520 6566 6665 6374 2e0a 2020 2020 2020  e effect..      
+0002a410: 2020 4e6f 7465 2074 6861 7420 7468 6572    Note that ther
+0002a420: 6520 6973 206e 6f20 6775 6172 616e 7465  e is no guarante
+0002a430: 6520 7468 6174 2074 6865 2077 6f72 6b65  e that the worke
+0002a440: 7220 7769 6c6c 2061 6374 7561 6c6c 7920  r will actually 
+0002a450: 6163 6365 7074 2074 6865 0a20 2020 2020  accept the.     
+0002a460: 2020 2063 6f6d 6d61 6e64 2e0a 0a20 2020     command...   
+0002a470: 2020 2020 204e 6f74 6520 7468 6174 203a       Note that :
+0002a480: 6d65 7468 3a60 7265 6d6f 7665 5f77 6f72  meth:`remove_wor
+0002a490: 6b65 7260 2073 656e 6473 2074 6865 2073  ker` sends the s
+0002a4a0: 616d 6520 636f 6d6d 616e 6420 696e 7465  ame command inte
+0002a4b0: 726e 616c 6c79 2069 6620 636c 6f73 653d  rnally if close=
+0002a4c0: 5472 7565 2e0a 0a20 2020 2020 2020 2053  True...        S
+0002a4d0: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
+0002a4e0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0002a4f0: 2072 6574 6972 655f 776f 726b 6572 730a   retire_workers.
+0002a500: 2020 2020 2020 2020 7265 6d6f 7665 5f77          remove_w
+0002a510: 6f72 6b65 720a 2020 2020 2020 2020 2222  orker.        ""
+0002a520: 220a 2020 2020 2020 2020 6966 2077 6f72  ".        if wor
+0002a530: 6b65 7220 6e6f 7420 696e 2073 656c 662e  ker not in self.
+0002a540: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+0002a550: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+0002a560: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0002a570: 2822 436c 6f73 696e 6720 776f 726b 6572  ("Closing worker
+0002a580: 2025 7322 2c20 776f 726b 6572 290a 2020   %s", worker).  
+0002a590: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+0002a5a0: 7665 6e74 2877 6f72 6b65 722c 207b 2261  vent(worker, {"a
+0002a5b0: 6374 696f 6e22 3a20 2263 6c6f 7365 2d77  ction": "close-w
+0002a5c0: 6f72 6b65 7222 7d29 0a20 2020 2020 2020  orker"}).       
+0002a5d0: 2073 656c 662e 776f 726b 6572 5f73 656e   self.worker_sen
+0002a5e0: 6428 776f 726b 6572 2c20 7b22 6f70 223a  d(worker, {"op":
+0002a5f0: 2022 636c 6f73 6522 2c20 2272 6561 736f   "close", "reaso
+0002a600: 6e22 3a20 2273 6368 6564 756c 6572 2d63  n": "scheduler-c
+0002a610: 6c6f 7365 2d77 6f72 6b65 7222 7d29 0a0a  lose-worker"})..
+0002a620: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+0002a630: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
+0002a640: 6d6f 7665 5f77 6f72 6b65 7228 0a20 2020  move_worker(.   
+0002a650: 2020 2020 2073 656c 662c 2061 6464 7265       self, addre
+0002a660: 7373 3a20 7374 722c 202a 2c20 7374 696d  ss: str, *, stim
+0002a670: 756c 7573 5f69 643a 2073 7472 2c20 7361  ulus_id: str, sa
+0002a680: 6665 3a20 626f 6f6c 203d 2046 616c 7365  fe: bool = False
+0002a690: 2c20 636c 6f73 653a 2062 6f6f 6c20 3d20  , close: bool = 
+0002a6a0: 5472 7565 0a20 2020 2029 202d 3e20 4c69  True.    ) -> Li
+0002a6b0: 7465 7261 6c5b 224f 4b22 2c20 2261 6c72  teral["OK", "alr
+0002a6c0: 6561 6479 2d72 656d 6f76 6564 225d 3a0a  eady-removed"]:.
+0002a6d0: 2020 2020 2020 2020 2222 2252 656d 6f76          """Remov
+0002a6e0: 6520 776f 726b 6572 2066 726f 6d20 636c  e worker from cl
+0002a6f0: 7573 7465 722e 0a0a 2020 2020 2020 2020  uster...        
+0002a700: 5765 2064 6f20 7468 6973 2077 6865 6e20  We do this when 
+0002a710: 6120 776f 726b 6572 2072 6570 6f72 7473  a worker reports
+0002a720: 2074 6861 7420 6974 2070 6c61 6e73 2074   that it plans t
+0002a730: 6f20 6c65 6176 6520 6f72 2077 6865 6e20  o leave or when 
+0002a740: 6974 2061 7070 6561 7273 2074 6f20 6265  it appears to be
+0002a750: 0a20 2020 2020 2020 2075 6e72 6573 706f  .        unrespo
+0002a760: 6e73 6976 652e 2054 6869 7320 6d61 7920  nsive. This may 
+0002a770: 7365 6e64 2069 7473 2074 6173 6b73 2062  send its tasks b
+0002a780: 6163 6b20 746f 2061 2072 656c 6561 7365  ack to a release
+0002a790: 6420 7374 6174 652e 0a0a 2020 2020 2020  d state...      
+0002a7a0: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+0002a7b0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+0002a7c0: 2020 2020 7265 7469 7265 5f77 6f72 6b65      retire_worke
+0002a7d0: 7273 0a20 2020 2020 2020 2063 6c6f 7365  rs.        close
+0002a7e0: 5f77 6f72 6b65 720a 2020 2020 2020 2020  _worker.        
+0002a7f0: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+0002a800: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
+0002a810: 6174 7573 2e63 6c6f 7365 643a 0a20 2020  atus.closed:.   
+0002a820: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002a830: 2261 6c72 6561 6479 2d72 656d 6f76 6564  "already-removed
+0002a840: 220a 0a20 2020 2020 2020 2061 6464 7265  "..        addre
+0002a850: 7373 203d 2073 656c 662e 636f 6572 6365  ss = self.coerce
+0002a860: 5f61 6464 7265 7373 2861 6464 7265 7373  _address(address
+0002a870: 290a 0a20 2020 2020 2020 2069 6620 6164  )..        if ad
+0002a880: 6472 6573 7320 6e6f 7420 696e 2073 656c  dress not in sel
+0002a890: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
+0002a8a0: 2020 2020 2020 2072 6574 7572 6e20 2261         return "a
+0002a8b0: 6c72 6561 6479 2d72 656d 6f76 6564 220a  lready-removed".
+0002a8c0: 0a20 2020 2020 2020 2068 6f73 7420 3d20  .        host = 
+0002a8d0: 6765 745f 6164 6472 6573 735f 686f 7374  get_address_host
+0002a8e0: 2861 6464 7265 7373 290a 0a20 2020 2020  (address)..     
+0002a8f0: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
+0002a900: 7465 203d 2073 656c 662e 776f 726b 6572  te = self.worker
+0002a910: 735b 6164 6472 6573 735d 0a0a 2020 2020  s[address]..    
+0002a920: 2020 2020 6576 656e 745f 6d73 6720 3d20      event_msg = 
+0002a930: 7b0a 2020 2020 2020 2020 2020 2020 2261  {.            "a
+0002a940: 6374 696f 6e22 3a20 2272 656d 6f76 652d  ction": "remove-
+0002a950: 776f 726b 6572 222c 0a20 2020 2020 2020  worker",.       
+0002a960: 2020 2020 2022 7072 6f63 6573 7369 6e67       "processing
+0002a970: 2d74 6173 6b73 223a 207b 7473 2e6b 6579  -tasks": {ts.key
+0002a980: 2066 6f72 2074 7320 696e 2077 732e 7072   for ts in ws.pr
+0002a990: 6f63 6573 7369 6e67 7d2c 0a20 2020 2020  ocessing},.     
+0002a9a0: 2020 207d 0a20 2020 2020 2020 2073 656c     }.        sel
+0002a9b0: 662e 6c6f 675f 6576 656e 7428 6164 6472  f.log_event(addr
+0002a9c0: 6573 732c 2065 7665 6e74 5f6d 7367 2e63  ess, event_msg.c
+0002a9d0: 6f70 7928 2929 0a20 2020 2020 2020 2065  opy()).        e
+0002a9e0: 7665 6e74 5f6d 7367 5b22 776f 726b 6572  vent_msg["worker
+0002a9f0: 225d 203d 2061 6464 7265 7373 0a20 2020  "] = address.   
+0002aa00: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
+0002aa10: 656e 7428 2261 6c6c 222c 2065 7665 6e74  ent("all", event
+0002aa20: 5f6d 7367 290a 0a20 2020 2020 2020 206c  _msg)..        l
+0002aa30: 6f67 6765 722e 696e 666f 2822 5265 6d6f  ogger.info("Remo
+0002aa40: 7665 2077 6f72 6b65 7220 2573 222c 2077  ve worker %s", w
+0002aa50: 7329 0a20 2020 2020 2020 2069 6620 636c  s).        if cl
+0002aa60: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0002aa70: 2077 6974 6820 7375 7070 7265 7373 2841   with suppress(A
+0002aa80: 7474 7269 6275 7465 4572 726f 722c 2043  ttributeError, C
+0002aa90: 6f6d 6d43 6c6f 7365 6445 7272 6f72 293a  ommClosedError):
+0002aaa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002aab0: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
+0002aac0: 6d73 5b61 6464 7265 7373 5d2e 7365 6e64  ms[address].send
+0002aad0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002aae0: 2020 2020 2020 7b22 6f70 223a 2022 636c        {"op": "cl
+0002aaf0: 6f73 6522 2c20 2272 6561 736f 6e22 3a20  ose", "reason": 
+0002ab00: 2273 6368 6564 756c 6572 2d72 656d 6f76  "scheduler-remov
+0002ab10: 652d 776f 726b 6572 227d 0a20 2020 2020  e-worker"}.     
+0002ab20: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0002ab30: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
+0002ab40: 655f 7265 736f 7572 6365 7328 6164 6472  e_resources(addr
+0002ab50: 6573 7329 0a0a 2020 2020 2020 2020 6468  ess)..        dh
+0002ab60: 3a20 6469 6374 203d 2073 656c 662e 686f  : dict = self.ho
+0002ab70: 7374 5f69 6e66 6f5b 686f 7374 5d0a 2020  st_info[host].  
+0002ab80: 2020 2020 2020 6468 5f61 6464 7265 7373        dh_address
+0002ab90: 6573 3a20 7365 7420 3d20 6468 5b22 6164  es: set = dh["ad
+0002aba0: 6472 6573 7365 7322 5d0a 2020 2020 2020  dresses"].      
+0002abb0: 2020 6468 5f61 6464 7265 7373 6573 2e72    dh_addresses.r
+0002abc0: 656d 6f76 6528 6164 6472 6573 7329 0a20  emove(address). 
+0002abd0: 2020 2020 2020 2064 685b 226e 7468 7265         dh["nthre
+0002abe0: 6164 7322 5d20 2d3d 2077 732e 6e74 6872  ads"] -= ws.nthr
+0002abf0: 6561 6473 0a20 2020 2020 2020 2073 656c  eads.        sel
+0002ac00: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
+0002ac10: 202d 3d20 7773 2e6e 7468 7265 6164 730a   -= ws.nthreads.
+0002ac20: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
+0002ac30: 685f 6164 6472 6573 7365 733a 0a20 2020  h_addresses:.   
+0002ac40: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
+0002ac50: 662e 686f 7374 5f69 6e66 6f5b 686f 7374  f.host_info[host
+0002ac60: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
+0002ac70: 7270 632e 7265 6d6f 7665 2861 6464 7265  rpc.remove(addre
+0002ac80: 7373 290a 2020 2020 2020 2020 6465 6c20  ss).        del 
+0002ac90: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
+0002aca0: 735b 6164 6472 6573 735d 0a20 2020 2020  s[address].     
+0002acb0: 2020 2064 656c 2073 656c 662e 616c 6961     del self.alia
+0002acc0: 7365 735b 7773 2e6e 616d 655d 0a20 2020  ses[ws.name].   
+0002acd0: 2020 2020 2073 656c 662e 6964 6c65 2e70       self.idle.p
+0002ace0: 6f70 2877 732e 6164 6472 6573 732c 204e  op(ws.address, N
+0002acf0: 6f6e 6529 0a20 2020 2020 2020 2073 656c  one).        sel
+0002ad00: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
+0002ad10: 742e 6469 7363 6172 6428 7773 290a 2020  t.discard(ws).  
+0002ad20: 2020 2020 2020 7365 6c66 2e73 6174 7572        self.satur
+0002ad30: 6174 6564 2e64 6973 6361 7264 2877 7329  ated.discard(ws)
+0002ad40: 0a20 2020 2020 2020 2064 656c 2073 656c  .        del sel
+0002ad50: 662e 776f 726b 6572 735b 6164 6472 6573  f.workers[addres
+0002ad60: 735d 0a20 2020 2020 2020 2077 732e 7374  s].        ws.st
+0002ad70: 6174 7573 203d 2053 7461 7475 732e 636c  atus = Status.cl
+0002ad80: 6f73 6564 0a20 2020 2020 2020 2073 656c  osed.        sel
+0002ad90: 662e 7275 6e6e 696e 672e 6469 7363 6172  f.running.discar
+0002ada0: 6428 7773 290a 0a20 2020 2020 2020 2072  d(ws)..        r
+0002adb0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+0002adc0: 5265 6373 203d 207b 7d0a 0a20 2020 2020  Recs = {}..     
+0002add0: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
+0002ade0: 0a20 2020 2020 2020 2066 6f72 2074 7320  .        for ts 
+0002adf0: 696e 206c 6973 7428 7773 2e70 726f 6365  in list(ws.proce
+0002ae00: 7373 696e 6729 3a0a 2020 2020 2020 2020  ssing):.        
+0002ae10: 2020 2020 6b20 3d20 7473 2e6b 6579 0a20      k = ts.key. 
+0002ae20: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+0002ae30: 6d65 6e64 6174 696f 6e73 5b6b 5d20 3d20  mendations[k] = 
+0002ae40: 2272 656c 6561 7365 6422 0a20 2020 2020  "released".     
+0002ae50: 2020 2020 2020 2069 6620 6e6f 7420 7361         if not sa
+0002ae60: 6665 3a0a 2020 2020 2020 2020 2020 2020  fe:.            
+0002ae70: 2020 2020 7473 2e73 7573 7069 6369 6f75      ts.suspiciou
+0002ae80: 7320 2b3d 2031 0a20 2020 2020 2020 2020  s += 1.         
+0002ae90: 2020 2020 2020 2074 732e 7072 6566 6978         ts.prefix
+0002aea0: 2e73 7573 7069 6369 6f75 7320 2b3d 2031  .suspicious += 1
+0002aeb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002aec0: 2069 6620 7473 2e73 7573 7069 6369 6f75   if ts.suspiciou
+0002aed0: 7320 3e20 7365 6c66 2e61 6c6c 6f77 6564  s > self.allowed
+0002aee0: 5f66 6169 6c75 7265 733a 0a20 2020 2020  _failures:.     
+0002aef0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002af00: 656c 2072 6563 6f6d 6d65 6e64 6174 696f  el recommendatio
+0002af10: 6e73 5b6b 5d0a 2020 2020 2020 2020 2020  ns[k].          
+0002af20: 2020 2020 2020 2020 2020 6520 3d20 7069            e = pi
+0002af30: 636b 6c65 2e64 756d 7073 280a 2020 2020  ckle.dumps(.    
+0002af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af50: 2020 2020 4b69 6c6c 6564 576f 726b 6572      KilledWorker
+0002af60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002af70: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0002af80: 736b 3d6b 2c0a 2020 2020 2020 2020 2020  sk=k,.          
+0002af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002afa0: 2020 6c61 7374 5f77 6f72 6b65 723d 7773    last_worker=ws
+0002afb0: 2e63 6c65 616e 2829 2c0a 2020 2020 2020  .clean(),.      
+0002afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002afd0: 2020 2020 2020 616c 6c6f 7765 645f 6661        allowed_fa
+0002afe0: 696c 7572 6573 3d73 656c 662e 616c 6c6f  ilures=self.allo
+0002aff0: 7765 645f 6661 696c 7572 6573 2c0a 2020  wed_failures,.  
+0002b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b010: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+0002b020: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0002b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b040: 2020 2072 203d 2073 656c 662e 7472 616e     r = self.tran
+0002b050: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
+0002b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b070: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+0002b080: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
+0002b090: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+0002b0a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0002b0b0: 7074 696f 6e3d 652c 0a20 2020 2020 2020  ption=e,.       
+0002b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0d0: 2063 6175 7365 3d6b 2c0a 2020 2020 2020   cause=k,.      
+0002b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0f0: 2020 7374 696d 756c 7573 5f69 643d 7374    stimulus_id=st
+0002b100: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+0002b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b120: 2020 2077 6f72 6b65 723d 6164 6472 6573     worker=addres
+0002b130: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0002b140: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002b150: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+0002b160: 6f6d 6d65 6e64 6174 696f 6e73 2e75 7064  ommendations.upd
+0002b170: 6174 6528 7229 0a20 2020 2020 2020 2020  ate(r).         
+0002b180: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0002b190: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
+0002b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1b0: 2254 6173 6b20 2573 206d 6172 6b65 6420  "Task %s marked 
+0002b1c0: 6173 2066 6169 6c65 6420 6265 6361 7573  as failed becaus
+0002b1d0: 6520 2564 2077 6f72 6b65 7273 2064 6965  e %d workers die
+0002b1e0: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
+0002b1f0: 2020 2020 2020 2020 2020 2022 2077 6869             " whi
+0002b200: 6c65 2074 7279 696e 6720 746f 2072 756e  le trying to run
+0002b210: 2069 7422 2c0a 2020 2020 2020 2020 2020   it",.          
+0002b220: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0002b230: 2e6b 6579 2c0a 2020 2020 2020 2020 2020  .key,.          
+0002b240: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0002b250: 6c66 2e61 6c6c 6f77 6564 5f66 6169 6c75  lf.allowed_failu
+0002b260: 7265 732c 0a20 2020 2020 2020 2020 2020  res,.           
+0002b270: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0002b280: 2020 2020 666f 7220 7473 2069 6e20 6c69      for ts in li
+0002b290: 7374 2877 732e 6861 735f 7768 6174 293a  st(ws.has_what):
+0002b2a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002b2b0: 662e 7265 6d6f 7665 5f72 6570 6c69 6361  f.remove_replica
+0002b2c0: 2874 732c 2077 7329 0a20 2020 2020 2020  (ts, ws).       
+0002b2d0: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
+0002b2e0: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
+0002b2f0: 2020 2020 2020 2020 6966 2074 732e 7275          if ts.ru
+0002b300: 6e5f 7370 6563 3a0a 2020 2020 2020 2020  n_spec:.        
+0002b310: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0002b320: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
+0002b330: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
+0002b340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b350: 2065 6c73 653a 2020 2320 7075 7265 2064   else:  # pure d
+0002b360: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+0002b370: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0002b380: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
+0002b390: 3d20 2266 6f72 676f 7474 656e 220a 0a20  = "forgotten".. 
+0002b3a0: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
+0002b3b0: 7369 7469 6f6e 7328 7265 636f 6d6d 656e  sitions(recommen
+0002b3c0: 6461 7469 6f6e 732c 2073 7469 6d75 6c75  dations, stimulu
+0002b3d0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+0002b3e0: 290a 0a20 2020 2020 2020 2066 6f72 2070  )..        for p
+0002b3f0: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
+0002b400: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
+0002b410: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+0002b420: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0002b430: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+0002b440: 706c 7567 696e 2e72 656d 6f76 655f 776f  plugin.remove_wo
+0002b450: 726b 6572 2873 6368 6564 756c 6572 3d73  rker(scheduler=s
+0002b460: 656c 662c 2077 6f72 6b65 723d 6164 6472  elf, worker=addr
+0002b470: 6573 7329 0a20 2020 2020 2020 2020 2020  ess).           
+0002b480: 2020 2020 2069 6620 696e 7370 6563 742e       if inspect.
+0002b490: 6973 6177 6169 7461 626c 6528 7265 7375  isawaitable(resu
+0002b4a0: 6c74 293a 0a20 2020 2020 2020 2020 2020  lt):.           
+0002b4b0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
+0002b4c0: 6573 756c 740a 2020 2020 2020 2020 2020  esult.          
+0002b4d0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0002b4e0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0002b4f0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0002b500: 6578 6365 7074 696f 6e28 6529 0a0a 2020  exception(e)..  
+0002b510: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+0002b520: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
+0002b530: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0002b540: 666f 2822 4c6f 7374 2061 6c6c 2077 6f72  fo("Lost all wor
+0002b550: 6b65 7273 2229 0a0a 2020 2020 2020 2020  kers")..        
+0002b560: 666f 7220 7720 696e 2073 656c 662e 776f  for w in self.wo
+0002b570: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
+0002b580: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+0002b590: 685f 776f 726b 6572 732e 706f 7028 2861  h_workers.pop((a
+0002b5a0: 6464 7265 7373 2c20 7729 2c20 4e6f 6e65  ddress, w), None
+0002b5b0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0002b5c0: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
+0002b5d0: 6b65 7273 2e70 6f70 2828 772c 2061 6464  kers.pop((w, add
+0002b5e0: 7265 7373 292c 204e 6f6e 6529 0a0a 2020  ress), None)..  
+0002b5f0: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
+0002b600: 7265 6d6f 7665 5f77 6f72 6b65 725f 6672  remove_worker_fr
+0002b610: 6f6d 5f65 7665 6e74 7328 2920 2d3e 204e  om_events() -> N
+0002b620: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0002b630: 2023 2049 6620 7468 6520 776f 726b 6572   # If the worker
+0002b640: 2069 736e 2774 2072 6567 6973 7465 7265   isn't registere
+0002b650: 6420 616e 796d 6f72 6520 6166 7465 7220  d anymore after 
+0002b660: 7468 6520 6465 6c61 792c 2072 656d 6f76  the delay, remov
+0002b670: 6520 6672 6f6d 2065 7665 6e74 730a 2020  e from events.  
+0002b680: 2020 2020 2020 2020 2020 6966 2061 6464            if add
+0002b690: 7265 7373 206e 6f74 2069 6e20 7365 6c66  ress not in self
+0002b6a0: 2e77 6f72 6b65 7273 2061 6e64 2061 6464  .workers and add
+0002b6b0: 7265 7373 2069 6e20 7365 6c66 2e65 7665  ress in self.eve
+0002b6c0: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0002b6d0: 2020 2020 2064 656c 2073 656c 662e 6576       del self.ev
+0002b6e0: 656e 7473 5b61 6464 7265 7373 5d0a 0a20  ents[address].. 
+0002b6f0: 2020 2020 2020 2063 6c65 616e 7570 5f64         cleanup_d
+0002b700: 656c 6179 203d 2070 6172 7365 5f74 696d  elay = parse_tim
+0002b710: 6564 656c 7461 280a 2020 2020 2020 2020  edelta(.        
+0002b720: 2020 2020 6461 736b 2e63 6f6e 6669 672e      dask.config.
+0002b730: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+0002b740: 2e73 6368 6564 756c 6572 2e65 7665 6e74  .scheduler.event
+0002b750: 732d 636c 6561 6e75 702d 6465 6c61 7922  s-cleanup-delay"
+0002b760: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
+0002b770: 2020 2020 2073 656c 662e 5f6f 6e67 6f69       self._ongoi
+0002b780: 6e67 5f62 6163 6b67 726f 756e 645f 7461  ng_background_ta
+0002b790: 736b 732e 6361 6c6c 5f6c 6174 6572 280a  sks.call_later(.
+0002b7a0: 2020 2020 2020 2020 2020 2020 636c 6561              clea
+0002b7b0: 6e75 705f 6465 6c61 792c 2072 656d 6f76  nup_delay, remov
+0002b7c0: 655f 776f 726b 6572 5f66 726f 6d5f 6576  e_worker_from_ev
+0002b7d0: 656e 7473 0a20 2020 2020 2020 2029 0a20  ents.        ). 
+0002b7e0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+0002b7f0: 6275 6728 2252 656d 6f76 6564 2077 6f72  bug("Removed wor
+0002b800: 6b65 7220 2573 222c 2077 7329 0a0a 2020  ker %s", ws)..  
+0002b810: 2020 2020 2020 666f 7220 7720 696e 2073        for w in s
+0002b820: 656c 662e 776f 726b 6572 733a 0a20 2020  elf.workers:.   
+0002b830: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
+0002b840: 726b 6572 5f73 656e 6428 0a20 2020 2020  rker_send(.     
+0002b850: 2020 2020 2020 2020 2020 2077 2c0a 2020             w,.  
+0002b860: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+0002b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b880: 2020 2020 226f 7022 3a20 2272 656d 6f76      "op": "remov
+0002b890: 652d 776f 726b 6572 222c 0a20 2020 2020  e-worker",.     
+0002b8a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002b8b0: 776f 726b 6572 223a 2061 6464 7265 7373  worker": address
+0002b8c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b8d0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
+0002b8e0: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
+0002b8f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b900: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0002b910: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
+0002b920: 726e 2022 4f4b 220a 0a20 2020 2064 6566  rn "OK"..    def
+0002b930: 2073 7469 6d75 6c75 735f 6361 6e63 656c   stimulus_cancel
+0002b940: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0002b950: 6b65 7973 3a20 5365 7175 656e 6365 5b73  keys: Sequence[s
+0002b960: 7472 5d2c 2063 6c69 656e 743a 2073 7472  tr], client: str
+0002b970: 2c20 666f 7263 653a 2062 6f6f 6c20 3d20  , force: bool = 
+0002b980: 4661 6c73 650a 2020 2020 2920 2d3e 204e  False.    ) -> N
+0002b990: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0002b9a0: 5374 6f70 2065 7865 6375 7469 6f6e 206f  Stop execution o
+0002b9b0: 6e20 6120 6c69 7374 206f 6620 6b65 7973  n a list of keys
+0002b9c0: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
+0002b9d0: 6572 2e69 6e66 6f28 2243 6c69 656e 7420  er.info("Client 
+0002b9e0: 2573 2072 6571 7565 7374 7320 746f 2063  %s requests to c
+0002b9f0: 616e 6365 6c20 2564 206b 6579 7322 2c20  ancel %d keys", 
+0002ba00: 636c 6965 6e74 2c20 6c65 6e28 6b65 7973  client, len(keys
+0002ba10: 2929 0a20 2020 2020 2020 2069 6620 636c  )).        if cl
+0002ba20: 6965 6e74 3a0a 2020 2020 2020 2020 2020  ient:.          
+0002ba30: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+0002ba40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002ba50: 2020 636c 6965 6e74 2c20 7b22 6163 7469    client, {"acti
+0002ba60: 6f6e 223a 2022 6361 6e63 656c 222c 2022  on": "cancel", "
+0002ba70: 636f 756e 7422 3a20 6c65 6e28 6b65 7973  count": len(keys
+0002ba80: 292c 2022 666f 7263 6522 3a20 666f 7263  ), "force": forc
+0002ba90: 657d 0a20 2020 2020 2020 2020 2020 2029  e}.            )
+0002baa0: 0a20 2020 2020 2020 2063 616e 6365 6c6c  .        cancell
+0002bab0: 6564 5f6b 6579 7320 3d20 5b5d 0a20 2020  ed_keys = [].   
+0002bac0: 2020 2020 2063 6c69 656e 7473 203d 205b       clients = [
+0002bad0: 5d0a 2020 2020 2020 2020 666f 7220 6b65  ].        for ke
+0002bae0: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
+0002baf0: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
+0002bb00: 7461 7465 207c 204e 6f6e 6520 3d20 7365  tate | None = se
+0002bb10: 6c66 2e74 6173 6b73 2e67 6574 286b 6579  lf.tasks.get(key
+0002bb20: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002bb30: 206e 6f74 2074 733a 0a20 2020 2020 2020   not ts:.       
+0002bb40: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0002bb50: 650a 2020 2020 2020 2020 2020 2020 7472  e.            tr
+0002bb60: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0002bb70: 2020 2063 733a 2043 6c69 656e 7453 7461     cs: ClientSta
+0002bb80: 7465 203d 2073 656c 662e 636c 6965 6e74  te = self.client
+0002bb90: 735b 636c 6965 6e74 5d0a 2020 2020 2020  s[client].      
+0002bba0: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
+0002bbb0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0002bbc0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+0002bbd0: 2020 2020 2020 2020 2020 2069 6620 666f             if fo
+0002bbe0: 7263 6520 6f72 2074 732e 7768 6f5f 7761  rce or ts.who_wa
+0002bbf0: 6e74 7320 3d3d 207b 6373 7d3a 2020 2320  nts == {cs}:  # 
+0002bc00: 6e6f 206f 6e65 2065 6c73 6520 7761 6e74  no one else want
+0002bc10: 7320 7468 6973 206b 6579 0a20 2020 2020  s this key.     
+0002bc20: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+0002bc30: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+0002bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bc50: 2073 656c 662e 7374 696d 756c 7573 5f63   self.stimulus_c
+0002bc60: 616e 6365 6c28 0a20 2020 2020 2020 2020  ancel(.         
+0002bc70: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0002bc80: 6474 732e 6b65 7920 666f 7220 6474 7320  dts.key for dts 
+0002bc90: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
+0002bca0: 5d2c 2063 6c69 656e 742c 2066 6f72 6365  ], client, force
+0002bcb0: 3d66 6f72 6365 0a20 2020 2020 2020 2020  =force.         
+0002bcc0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002bcd0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002bce0: 6765 722e 696e 666f 2822 5363 6865 6475  ger.info("Schedu
+0002bcf0: 6c65 7220 6361 6e63 656c 7320 6b65 7920  ler cancels key 
+0002bd00: 2573 2e20 2046 6f72 6365 3d25 7322 2c20  %s.  Force=%s", 
+0002bd10: 6b65 792c 2066 6f72 6365 290a 2020 2020  key, force).    
+0002bd20: 2020 2020 2020 2020 2020 2020 6361 6e63              canc
+0002bd30: 656c 6c65 645f 6b65 7973 2e61 7070 656e  elled_keys.appen
+0002bd40: 6428 6b65 7929 0a20 2020 2020 2020 2020  d(key).         
+0002bd50: 2020 2063 6c69 656e 7473 2e65 7874 656e     clients.exten
+0002bd60: 6428 6c69 7374 2874 732e 7768 6f5f 7761  d(list(ts.who_wa
+0002bd70: 6e74 7329 2069 6620 666f 7263 6520 656c  nts) if force el
+0002bd80: 7365 205b 6373 5d29 0a20 2020 2020 2020  se [cs]).       
+0002bd90: 2066 6f72 2063 7320 696e 2063 6c69 656e   for cs in clien
+0002bda0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0002bdb0: 7365 6c66 2e63 6c69 656e 745f 7265 6c65  self.client_rele
+0002bdc0: 6173 6573 5f6b 6579 7328 0a20 2020 2020  ases_keys(.     
+0002bdd0: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
+0002bde0: 6361 6e63 656c 6c65 645f 6b65 7973 2c0a  cancelled_keys,.
+0002bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002be00: 636c 6965 6e74 3d63 732e 636c 6965 6e74  client=cs.client
+0002be10: 5f6b 6579 2c0a 2020 2020 2020 2020 2020  _key,.          
+0002be20: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+0002be30: 643d 6622 6361 6e63 656c 2d6b 6579 2d7b  d=f"cancel-key-{
+0002be40: 7469 6d65 2829 7d22 2c0a 2020 2020 2020  time()}",.      
+0002be50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002be60: 7365 6c66 2e72 6570 6f72 7428 7b22 6f70  self.report({"op
+0002be70: 223a 2022 6361 6e63 656c 6c65 642d 6b65  ": "cancelled-ke
+0002be80: 7973 222c 2022 6b65 7973 223a 2063 616e  ys", "keys": can
+0002be90: 6365 6c6c 6564 5f6b 6579 737d 290a 0a20  celled_keys}).. 
+0002bea0: 2020 2064 6566 2063 6c69 656e 745f 6465     def client_de
+0002beb0: 7369 7265 735f 6b65 7973 2873 656c 662c  sires_keys(self,
+0002bec0: 206b 6579 733d 4e6f 6e65 2c20 636c 6965   keys=None, clie
+0002bed0: 6e74 3d4e 6f6e 6529 3a0a 2020 2020 2020  nt=None):.      
+0002bee0: 2020 6373 3a20 436c 6965 6e74 5374 6174    cs: ClientStat
+0002bef0: 6520 3d20 7365 6c66 2e63 6c69 656e 7473  e = self.clients
+0002bf00: 2e67 6574 2863 6c69 656e 7429 0a20 2020  .get(client).   
+0002bf10: 2020 2020 2069 6620 6373 2069 7320 4e6f       if cs is No
+0002bf20: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0002bf30: 2320 466f 7220 7075 626c 6973 682c 2071  # For publish, q
+0002bf40: 7565 7565 7320 6574 632e 0a20 2020 2020  ueues etc..     
+0002bf50: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+0002bf60: 6e74 735b 636c 6965 6e74 5d20 3d20 6373  nts[client] = cs
+0002bf70: 203d 2043 6c69 656e 7453 7461 7465 2863   = ClientState(c
+0002bf80: 6c69 656e 7429 0a20 2020 2020 2020 2066  lient).        f
+0002bf90: 6f72 206b 2069 6e20 6b65 7973 3a0a 2020  or k in keys:.  
+0002bfa0: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+0002bfb0: 656c 662e 7461 736b 732e 6765 7428 6b29  elf.tasks.get(k)
+0002bfc0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002bfd0: 7473 2069 7320 4e6f 6e65 3a0a 2020 2020  ts is None:.    
+0002bfe0: 2020 2020 2020 2020 2020 2020 2320 466f              # Fo
+0002bff0: 7220 7075 626c 6973 682c 2071 7565 7565  r publish, queue
+0002c000: 7320 6574 632e 0a20 2020 2020 2020 2020  s etc..         
+0002c010: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+0002c020: 2e6e 6577 5f74 6173 6b28 6b2c 204e 6f6e  .new_task(k, Non
+0002c030: 652c 2022 7265 6c65 6173 6564 2229 0a20  e, "released"). 
+0002c040: 2020 2020 2020 2020 2020 2074 732e 7768             ts.wh
+0002c050: 6f5f 7761 6e74 732e 6164 6428 6373 290a  o_wants.add(cs).
+0002c060: 2020 2020 2020 2020 2020 2020 6373 2e77              cs.w
+0002c070: 616e 7473 5f77 6861 742e 6164 6428 7473  ants_what.add(ts
+0002c080: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0002c090: 6620 7473 2e73 7461 7465 2069 6e20 2822  f ts.state in ("
+0002c0a0: 6d65 6d6f 7279 222c 2022 6572 7265 6422  memory", "erred"
+0002c0b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002c0c0: 2020 2073 656c 662e 7265 706f 7274 5f6f     self.report_o
+0002c0d0: 6e5f 6b65 7928 7473 3d74 732c 2063 6c69  n_key(ts=ts, cli
+0002c0e0: 656e 743d 636c 6965 6e74 290a 0a20 2020  ent=client)..   
+0002c0f0: 2064 6566 2063 6c69 656e 745f 7265 6c65   def client_rele
+0002c100: 6173 6573 5f6b 6579 7328 7365 6c66 2c20  ases_keys(self, 
+0002c110: 6b65 7973 3d4e 6f6e 652c 2063 6c69 656e  keys=None, clien
+0002c120: 743d 4e6f 6e65 2c20 7374 696d 756c 7573  t=None, stimulus
+0002c130: 5f69 643d 4e6f 6e65 293a 0a20 2020 2020  _id=None):.     
+0002c140: 2020 2022 2222 5265 6d6f 7665 206b 6579     """Remove key
+0002c150: 7320 6672 6f6d 2063 6c69 656e 7420 6465  s from client de
+0002c160: 7369 7265 6420 6c69 7374 2222 220a 2020  sired list""".  
+0002c170: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+0002c180: 6420 3d20 7374 696d 756c 7573 5f69 6420  d = stimulus_id 
+0002c190: 6f72 2066 2263 6c69 656e 742d 7265 6c65  or f"client-rele
+0002c1a0: 6173 6573 2d6b 6579 732d 7b74 696d 6528  ases-keys-{time(
+0002c1b0: 297d 220a 2020 2020 2020 2020 6966 206e  )}".        if n
+0002c1c0: 6f74 2069 7369 6e73 7461 6e63 6528 6b65  ot isinstance(ke
+0002c1d0: 7973 2c20 6c69 7374 293a 0a20 2020 2020  ys, list):.     
+0002c1e0: 2020 2020 2020 206b 6579 7320 3d20 6c69         keys = li
+0002c1f0: 7374 286b 6579 7329 0a20 2020 2020 2020  st(keys).       
+0002c200: 2063 7320 3d20 7365 6c66 2e63 6c69 656e   cs = self.clien
+0002c210: 7473 5b63 6c69 656e 745d 0a20 2020 2020  ts[client].     
+0002c220: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0002c230: 6e73 3a20 5265 6373 203d 207b 7d0a 0a20  ns: Recs = {}.. 
+0002c240: 2020 2020 2020 2073 656c 662e 5f63 6c69         self._cli
+0002c250: 656e 745f 7265 6c65 6173 6573 5f6b 6579  ent_releases_key
+0002c260: 7328 6b65 7973 3d6b 6579 732c 2063 733d  s(keys=keys, cs=
+0002c270: 6373 2c20 7265 636f 6d6d 656e 6461 7469  cs, recommendati
+0002c280: 6f6e 733d 7265 636f 6d6d 656e 6461 7469  ons=recommendati
+0002c290: 6f6e 7329 0a20 2020 2020 2020 2073 656c  ons).        sel
+0002c2a0: 662e 7472 616e 7369 7469 6f6e 7328 7265  f.transitions(re
+0002c2b0: 636f 6d6d 656e 6461 7469 6f6e 732c 2073  commendations, s
+0002c2c0: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+0002c2d0: 2020 2020 2073 656c 662e 7374 696d 756c       self.stimul
+0002c2e0: 7573 5f71 7565 7565 5f73 6c6f 7473 5f6d  us_queue_slots_m
+0002c2f0: 6179 6265 5f6f 7065 6e65 6428 7374 696d  aybe_opened(stim
+0002c300: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+0002c310: 5f69 6429 0a0a 2020 2020 6465 6620 636c  _id)..    def cl
+0002c320: 6965 6e74 5f68 6561 7274 6265 6174 2873  ient_heartbeat(s
+0002c330: 656c 662c 2063 6c69 656e 743d 4e6f 6e65  elf, client=None
+0002c340: 293a 0a20 2020 2020 2020 2022 2222 4861  ):.        """Ha
+0002c350: 6e64 6c65 2068 6561 7274 6265 6174 7320  ndle heartbeats 
+0002c360: 6672 6f6d 2043 6c69 656e 7422 2222 0a20  from Client""". 
+0002c370: 2020 2020 2020 2063 733a 2043 6c69 656e         cs: Clien
+0002c380: 7453 7461 7465 203d 2073 656c 662e 636c  tState = self.cl
+0002c390: 6965 6e74 735b 636c 6965 6e74 5d0a 2020  ients[client].  
+0002c3a0: 2020 2020 2020 6373 2e6c 6173 745f 7365        cs.last_se
+0002c3b0: 656e 203d 2074 696d 6528 290a 0a20 2020  en = time()..   
+0002c3c0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+0002c3d0: 2323 2323 0a20 2020 2023 2054 6173 6b20  ####.    # Task 
+0002c3e0: 5661 6c69 6461 7469 6f6e 2023 0a20 2020  Validation #.   
+0002c3f0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+0002c400: 2323 2323 0a0a 2020 2020 6465 6620 7661  ####..    def va
+0002c410: 6c69 6461 7465 5f72 656c 6561 7365 6428  lidate_released(
+0002c420: 7365 6c66 2c20 6b65 793a 2073 7472 2920  self, key: str) 
+0002c430: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0002c440: 2074 733a 2054 6173 6b53 7461 7465 203d   ts: TaskState =
+0002c450: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+0002c460: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002c470: 7473 2e73 7461 7465 203d 3d20 2272 656c  ts.state == "rel
+0002c480: 6561 7365 6422 0a20 2020 2020 2020 2061  eased".        a
+0002c490: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+0002c4a0: 7465 7273 0a20 2020 2020 2020 2061 7373  ters.        ass
+0002c4b0: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+0002c4c0: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
+0002c4d0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+0002c4e0: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
+0002c4f0: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+0002c500: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+0002c510: 6173 7365 7274 206e 6f74 2061 6e79 285b  assert not any([
+0002c520: 7473 2069 6e20 6474 732e 7761 6974 6572  ts in dts.waiter
+0002c530: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
+0002c540: 6465 7065 6e64 656e 6369 6573 5d29 0a20  dependencies]). 
+0002c550: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0002c560: 206e 6f74 2069 6e20 7365 6c66 2e75 6e72   not in self.unr
+0002c570: 756e 6e61 626c 650a 2020 2020 2020 2020  unnable.        
+0002c580: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
+0002c590: 2073 656c 662e 7175 6575 6564 0a0a 2020   self.queued..  
+0002c5a0: 2020 6465 6620 7661 6c69 6461 7465 5f77    def validate_w
+0002c5b0: 6169 7469 6e67 2873 656c 662c 206b 6579  aiting(self, key
+0002c5c0: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+0002c5d0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
+0002c5e0: 5374 6174 6520 3d20 7365 6c66 2e74 6173  State = self.tas
+0002c5f0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+0002c600: 6173 7365 7274 2074 732e 7761 6974 696e  assert ts.waitin
+0002c610: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
+0002c620: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+0002c630: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
+0002c640: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+0002c650: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+0002c660: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
+0002c670: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
+0002c680: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0002c690: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
+0002c6a0: 6575 6564 0a20 2020 2020 2020 2066 6f72  eued.        for
+0002c6b0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0002c6c0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+0002c6d0: 2020 2020 2023 2057 6520 6172 6520 7761       # We are wa
+0002c6e0: 6974 696e 6720 6f6e 2061 2064 6570 656e  iting on a depen
+0002c6f0: 6465 6e63 7920 6966 6620 6974 2773 206e  dency iff it's n
+0002c700: 6f74 2073 746f 7265 640a 2020 2020 2020  ot stored.      
+0002c710: 2020 2020 2020 6173 7365 7274 2062 6f6f        assert boo
+0002c720: 6c28 6474 732e 7768 6f5f 6861 7329 2021  l(dts.who_has) !
+0002c730: 3d20 2864 7473 2069 6e20 7473 2e77 6169  = (dts in ts.wai
+0002c740: 7469 6e67 5f6f 6e29 0a20 2020 2020 2020  ting_on).       
+0002c750: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
+0002c760: 6e20 6474 732e 7761 6974 6572 7320 2023  n dts.waiters  #
+0002c770: 2058 5858 2065 7665 6e20 6966 2064 7473   XXX even if dts
+0002c780: 2e5f 7768 6f5f 6861 733f 0a0a 2020 2020  ._who_has?..    
+0002c790: 6465 6620 7661 6c69 6461 7465 5f71 7565  def validate_que
+0002c7a0: 7565 6428 7365 6c66 2c20 6b65 793a 2073  ued(self, key: s
+0002c7b0: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+0002c7c0: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+0002c7d0: 7465 203d 2073 656c 662e 7461 736b 735b  te = self.tasks[
+0002c7e0: 6b65 795d 0a20 2020 2020 2020 2064 7473  key].        dts
+0002c7f0: 3a20 5461 736b 5374 6174 650a 2020 2020  : TaskState.    
+0002c800: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+0002c810: 2073 656c 662e 7175 6575 6564 0a20 2020   self.queued.   
+0002c820: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002c830: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
+0002c840: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002c850: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+0002c860: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+0002c870: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
+0002c880: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+0002c890: 6f74 2028 0a20 2020 2020 2020 2020 2020  ot (.           
+0002c8a0: 2074 732e 776f 726b 6572 5f72 6573 7472   ts.worker_restr
+0002c8b0: 6963 7469 6f6e 7320 6f72 2074 732e 686f  ictions or ts.ho
+0002c8c0: 7374 5f72 6573 7472 6963 7469 6f6e 7320  st_restrictions 
+0002c8d0: 6f72 2074 732e 7265 736f 7572 6365 5f72  or ts.resource_r
+0002c8e0: 6573 7472 6963 7469 6f6e 730a 2020 2020  estrictions.    
+0002c8f0: 2020 2020 290a 2020 2020 2020 2020 666f      ).        fo
+0002c900: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+0002c910: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+0002c920: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
+0002c930: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+0002c940: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
+0002c950: 6e20 6474 732e 7761 6974 6572 730a 0a20  n dts.waiters.. 
+0002c960: 2020 2064 6566 2076 616c 6964 6174 655f     def validate_
+0002c970: 7072 6f63 6573 7369 6e67 2873 656c 662c  processing(self,
+0002c980: 206b 6579 3a20 7374 7229 202d 3e20 4e6f   key: str) -> No
+0002c990: 6e65 3a0a 2020 2020 2020 2020 7473 3a20  ne:.        ts: 
+0002c9a0: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
+0002c9b0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+0002c9c0: 2020 2020 6474 733a 2054 6173 6b53 7461      dts: TaskSta
+0002c9d0: 7465 0a20 2020 2020 2020 2061 7373 6572  te.        asser
+0002c9e0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+0002c9f0: 5f6f 6e0a 2020 2020 2020 2020 7773 203d  _on.        ws =
+0002ca00: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+0002ca10: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
+0002ca20: 2077 730a 2020 2020 2020 2020 6173 7365   ws.        asse
+0002ca30: 7274 2074 7320 696e 2077 732e 7072 6f63  rt ts in ws.proc
+0002ca40: 6573 7369 6e67 0a20 2020 2020 2020 2061  essing.        a
+0002ca50: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+0002ca60: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
+0002ca70: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
+0002ca80: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
+0002ca90: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+0002caa0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+0002cab0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002cac0: 2064 7473 2e77 686f 5f68 6173 0a20 2020   dts.who_has.   
+0002cad0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002cae0: 7473 2069 6e20 6474 732e 7761 6974 6572  ts in dts.waiter
+0002caf0: 730a 0a20 2020 2064 6566 2076 616c 6964  s..    def valid
+0002cb00: 6174 655f 6d65 6d6f 7279 2873 656c 662c  ate_memory(self,
+0002cb10: 206b 6579 3a20 7374 7229 202d 3e20 4e6f   key: str) -> No
+0002cb20: 6e65 3a0a 2020 2020 2020 2020 7473 3a20  ne:.        ts: 
+0002cb30: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
+0002cb40: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+0002cb50: 2020 2020 6474 733a 2054 6173 6b53 7461      dts: TaskSta
+0002cb60: 7465 0a20 2020 2020 2020 2061 7373 6572  te.        asser
+0002cb70: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
+0002cb80: 2020 2020 2061 7373 6572 7420 626f 6f6c       assert bool
+0002cb90: 2874 7320 696e 2073 656c 662e 7265 706c  (ts in self.repl
+0002cba0: 6963 6174 6564 5f74 6173 6b73 2920 3d3d  icated_tasks) ==
+0002cbb0: 2028 6c65 6e28 7473 2e77 686f 5f68 6173   (len(ts.who_has
+0002cbc0: 2920 3e20 3129 0a20 2020 2020 2020 2061  ) > 1).        a
+0002cbd0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+0002cbe0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+0002cbf0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+0002cc00: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+0002cc10: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
+0002cc20: 7420 696e 2073 656c 662e 756e 7275 6e6e  t in self.unrunn
+0002cc30: 6162 6c65 0a20 2020 2020 2020 2061 7373  able.        ass
+0002cc40: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
+0002cc50: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
+0002cc60: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+0002cc70: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+0002cc80: 2020 2020 2020 2020 6173 7365 7274 2028          assert (
+0002cc90: 6474 7320 696e 2074 732e 7761 6974 6572  dts in ts.waiter
+0002cca0: 7329 203d 3d20 280a 2020 2020 2020 2020  s) == (.        
+0002ccb0: 2020 2020 2020 2020 6474 732e 7374 6174          dts.stat
+0002ccc0: 6520 696e 2028 2277 6169 7469 6e67 222c  e in ("waiting",
+0002ccd0: 2022 7175 6575 6564 222c 2022 7072 6f63   "queued", "proc
+0002cce0: 6573 7369 6e67 222c 2022 6e6f 2d77 6f72  essing", "no-wor
+0002ccf0: 6b65 7222 290a 2020 2020 2020 2020 2020  ker").          
+0002cd00: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002cd10: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
+0002cd20: 2064 7473 2e77 6169 7469 6e67 5f6f 6e0a   dts.waiting_on.
+0002cd30: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
+0002cd40: 655f 6e6f 5f77 6f72 6b65 7228 7365 6c66  e_no_worker(self
+0002cd50: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
+0002cd60: 6f6e 653a 0a20 2020 2020 2020 2074 733a  one:.        ts:
+0002cd70: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
+0002cd80: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
+0002cd90: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
+0002cda0: 6e20 7365 6c66 2e75 6e72 756e 6e61 626c  n self.unrunnabl
+0002cdb0: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
+0002cdc0: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+0002cdd0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+0002cde0: 7420 7473 2069 6e20 7365 6c66 2e75 6e72  t ts in self.unr
+0002cdf0: 756e 6e61 626c 650a 2020 2020 2020 2020  unnable.        
+0002ce00: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+0002ce10: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+0002ce20: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+0002ce30: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+0002ce40: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+0002ce50: 696e 2073 656c 662e 7175 6575 6564 0a20  in self.queued. 
+0002ce60: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
+0002ce70: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+0002ce80: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+0002ce90: 7373 6572 7420 6474 732e 7768 6f5f 6861  ssert dts.who_ha
+0002cea0: 730a 0a20 2020 2064 6566 2076 616c 6964  s..    def valid
+0002ceb0: 6174 655f 6572 7265 6428 7365 6c66 2c20  ate_erred(self, 
+0002cec0: 6b65 793a 2073 7472 2920 2d3e 204e 6f6e  key: str) -> Non
+0002ced0: 653a 0a20 2020 2020 2020 2074 733a 2054  e:.        ts: T
+0002cee0: 6173 6b53 7461 7465 203d 2073 656c 662e  askState = self.
+0002cef0: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+0002cf00: 2020 2061 7373 6572 7420 7473 2e65 7863     assert ts.exc
+0002cf10: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
+0002cf20: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002cf30: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+0002cf40: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
+0002cf50: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
+0002cf60: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
+0002cf70: 655f 6b65 7928 7365 6c66 2c20 6b65 793a  e_key(self, key:
+0002cf80: 2073 7472 2c20 7473 3a20 5461 736b 5374   str, ts: TaskSt
+0002cf90: 6174 6520 7c20 4e6f 6e65 203d 204e 6f6e  ate | None = Non
+0002cfa0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+0002cfb0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0002cfc0: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
+0002cfd0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0002cfe0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0002cff0: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+0002d000: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+0002d010: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0002d020: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0002d030: 6562 7567 2822 4b65 7920 6c6f 7374 3a20  ebug("Key lost: 
+0002d040: 2573 222c 206b 6579 290a 2020 2020 2020  %s", key).      
+0002d050: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002d060: 2020 2020 2020 2020 2020 2020 7473 2e76              ts.v
+0002d070: 616c 6964 6174 6528 290a 2020 2020 2020  alidate().      
+0002d080: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
 0002d090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d0a0: 6c6f 6767 6572 2e63 7269 7469 6361 6c28  logger.critical(
-0002d0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d0c0: 2020 2020 2020 2020 2022 436c 6f73 6564           "Closed
-0002d0d0: 2063 6f6d 6d20 2572 2077 6869 6c65 2074   comm %r while t
-0002d0e0: 7279 696e 6720 746f 2077 7269 7465 2025  rying to write %
-0002d0f0: 7322 2c20 632c 206d 7367 2c20 6578 635f  s", c, msg, exc_
-0002d100: 696e 666f 3d54 7275 650a 2020 2020 2020  info=True.      
-0002d110: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0002d120: 0a20 2020 2061 7379 6e63 2064 6566 2061  .    async def a
-0002d130: 6464 5f63 6c69 656e 7428 0a20 2020 2020  dd_client(.     
-0002d140: 2020 2073 656c 662c 2063 6f6d 6d3a 2043     self, comm: C
-0002d150: 6f6d 6d2c 2063 6c69 656e 743a 2073 7472  omm, client: str
-0002d160: 2c20 7665 7273 696f 6e73 3a20 6469 6374  , versions: dict
-0002d170: 5b73 7472 2c20 416e 795d 0a20 2020 2029  [str, Any].    )
-0002d180: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002d190: 2020 2222 2241 6464 2063 6c69 656e 7420    """Add client 
-0002d1a0: 746f 206e 6574 776f 726b 0a0a 2020 2020  to network..    
-0002d1b0: 2020 2020 5765 206c 6973 7465 6e20 746f      We listen to
-0002d1c0: 2061 6c6c 2066 7574 7572 6520 6d65 7373   all future mess
-0002d1d0: 6167 6573 2066 726f 6d20 7468 6973 2043  ages from this C
-0002d1e0: 6f6d 6d2e 0a20 2020 2020 2020 2022 2222  omm..        """
-0002d1f0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002d200: 636c 6965 6e74 2069 7320 6e6f 7420 4e6f  client is not No
-0002d210: 6e65 0a20 2020 2020 2020 2063 6f6d 6d2e  ne.        comm.
-0002d220: 6e61 6d65 203d 2022 5363 6865 6475 6c65  name = "Schedule
-0002d230: 722d 3e43 6c69 656e 7422 0a20 2020 2020  r->Client".     
-0002d240: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-0002d250: 5265 6365 6976 6520 636c 6965 6e74 2063  Receive client c
-0002d260: 6f6e 6e65 6374 696f 6e3a 2025 7322 2c20  onnection: %s", 
-0002d270: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
-0002d280: 7365 6c66 2e6c 6f67 5f65 7665 6e74 285b  self.log_event([
-0002d290: 2261 6c6c 222c 2063 6c69 656e 745d 2c20  "all", client], 
-0002d2a0: 7b22 6163 7469 6f6e 223a 2022 6164 642d  {"action": "add-
-0002d2b0: 636c 6965 6e74 222c 2022 636c 6965 6e74  client", "client
-0002d2c0: 223a 2063 6c69 656e 747d 290a 2020 2020  ": client}).    
-0002d2d0: 2020 2020 7365 6c66 2e63 6c69 656e 7473      self.clients
-0002d2e0: 5b63 6c69 656e 745d 203d 2043 6c69 656e  [client] = Clien
-0002d2f0: 7453 7461 7465 2863 6c69 656e 742c 2076  tState(client, v
-0002d300: 6572 7369 6f6e 733d 7665 7273 696f 6e73  ersions=versions
-0002d310: 290a 0a20 2020 2020 2020 2066 6f72 2070  )..        for p
-0002d320: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
-0002d330: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
-0002d340: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-0002d350: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0002d360: 2020 2020 2020 2070 6c75 6769 6e2e 6164         plugin.ad
-0002d370: 645f 636c 6965 6e74 2873 6368 6564 756c  d_client(schedul
-0002d380: 6572 3d73 656c 662c 2063 6c69 656e 743d  er=self, client=
-0002d390: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
-0002d3a0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0002d3b0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0002d3c0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0002d3d0: 722e 6578 6365 7074 696f 6e28 6529 0a0a  r.exception(e)..
-0002d3e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002d3f0: 2020 2020 2020 2020 2062 636f 6d6d 203d           bcomm =
-0002d400: 2042 6174 6368 6564 5365 6e64 2869 6e74   BatchedSend(int
-0002d410: 6572 7661 6c3d 2232 6d73 222c 206c 6f6f  erval="2ms", loo
-0002d420: 703d 7365 6c66 2e6c 6f6f 7029 0a20 2020  p=self.loop).   
-0002d430: 2020 2020 2020 2020 2062 636f 6d6d 2e73           bcomm.s
-0002d440: 7461 7274 2863 6f6d 6d29 0a20 2020 2020  tart(comm).     
-0002d450: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0002d460: 6e74 5f63 6f6d 6d73 5b63 6c69 656e 745d  nt_comms[client]
-0002d470: 203d 2062 636f 6d6d 0a20 2020 2020 2020   = bcomm.       
-0002d480: 2020 2020 206d 7367 203d 207b 226f 7022       msg = {"op"
-0002d490: 3a20 2273 7472 6561 6d2d 7374 6172 7422  : "stream-start"
-0002d4a0: 7d0a 2020 2020 2020 2020 2020 2020 7665  }.            ve
-0002d4b0: 7273 696f 6e5f 7761 726e 696e 6720 3d20  rsion_warning = 
-0002d4c0: 7665 7273 696f 6e5f 6d6f 6475 6c65 2e65  version_module.e
-0002d4d0: 7272 6f72 5f6d 6573 7361 6765 280a 2020  rror_message(.  
-0002d4e0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-0002d4f0: 7273 696f 6e5f 6d6f 6475 6c65 2e67 6574  rsion_module.get
-0002d500: 5f76 6572 7369 6f6e 7328 292c 0a20 2020  _versions(),.   
-0002d510: 2020 2020 2020 2020 2020 2020 207b 773a               {w:
-0002d520: 2077 732e 7665 7273 696f 6e73 2066 6f72   ws.versions for
-0002d530: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
-0002d540: 6f72 6b65 7273 2e69 7465 6d73 2829 7d2c  orkers.items()},
-0002d550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d560: 2076 6572 7369 6f6e 732c 0a20 2020 2020   versions,.     
-0002d570: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002d580: 2020 2020 206d 7367 2e75 7064 6174 6528       msg.update(
-0002d590: 7665 7273 696f 6e5f 7761 726e 696e 6729  version_warning)
-0002d5a0: 0a20 2020 2020 2020 2020 2020 2062 636f  .            bco
-0002d5b0: 6d6d 2e73 656e 6428 6d73 6729 0a0a 2020  mm.send(msg)..  
-0002d5c0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0002d5d0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002d5e0: 7761 6974 2073 656c 662e 6861 6e64 6c65  wait self.handle
-0002d5f0: 5f73 7472 6561 6d28 636f 6d6d 3d63 6f6d  _stream(comm=com
-0002d600: 6d2c 2065 7874 7261 3d7b 2263 6c69 656e  m, extra={"clien
-0002d610: 7422 3a20 636c 6965 6e74 7d29 0a20 2020  t": client}).   
-0002d620: 2020 2020 2020 2020 2066 696e 616c 6c79           finally
-0002d630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002d640: 2020 7365 6c66 2e72 656d 6f76 655f 636c    self.remove_cl
-0002d650: 6965 6e74 2863 6c69 656e 743d 636c 6965  ient(client=clie
-0002d660: 6e74 2c20 7374 696d 756c 7573 5f69 643d  nt, stimulus_id=
-0002d670: 6622 7265 6d6f 7665 2d63 6c69 656e 742d  f"remove-client-
-0002d680: 7b74 696d 6528 297d 2229 0a20 2020 2020  {time()}").     
-0002d690: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0002d6a0: 722e 6465 6275 6728 2246 696e 6973 6865  r.debug("Finishe
-0002d6b0: 6420 6861 6e64 6c69 6e67 2063 6c69 656e  d handling clien
-0002d6c0: 7420 2573 222c 2063 6c69 656e 7429 0a20  t %s", client). 
-0002d6d0: 2020 2020 2020 2066 696e 616c 6c79 3a0a         finally:.
-0002d6e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002d6f0: 6f74 2063 6f6d 6d2e 636c 6f73 6564 2829  ot comm.closed()
-0002d700: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002d710: 2020 7365 6c66 2e63 6c69 656e 745f 636f    self.client_co
-0002d720: 6d6d 735b 636c 6965 6e74 5d2e 7365 6e64  mms[client].send
-0002d730: 287b 226f 7022 3a20 2273 7472 6561 6d2d  ({"op": "stream-
-0002d740: 636c 6f73 6564 227d 290a 2020 2020 2020  closed"}).      
-0002d750: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0002d760: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0002d770: 7420 7379 732e 6973 5f66 696e 616c 697a  t sys.is_finaliz
-0002d780: 696e 6728 293a 0a20 2020 2020 2020 2020  ing():.         
-0002d790: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0002d7a0: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
-0002d7b0: 6d73 5b63 6c69 656e 745d 2e63 6c6f 7365  ms[client].close
-0002d7c0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0002d7d0: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
-0002d7e0: 636c 6965 6e74 5f63 6f6d 6d73 5b63 6c69  client_comms[cli
-0002d7f0: 656e 745d 0a20 2020 2020 2020 2020 2020  ent].           
-0002d800: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0002d810: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
-0002d820: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
-0002d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d840: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-0002d850: 436c 6f73 6520 636c 6965 6e74 2063 6f6e  Close client con
-0002d860: 6e65 6374 696f 6e3a 2025 7322 2c20 636c  nection: %s", cl
-0002d870: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
-0002d880: 2020 6578 6365 7074 2054 7970 6545 7272    except TypeErr
-0002d890: 6f72 3a20 2023 2063 6f6d 6d20 6265 636f  or:  # comm beco
-0002d8a0: 6d65 7320 4e6f 6e65 2064 7572 696e 6720  mes None during 
-0002d8b0: 4743 0a20 2020 2020 2020 2020 2020 2020  GC.             
-0002d8c0: 2020 2070 6173 730a 0a20 2020 2064 6566     pass..    def
-0002d8d0: 2072 656d 6f76 655f 636c 6965 6e74 2873   remove_client(s
-0002d8e0: 656c 662c 2063 6c69 656e 743a 2073 7472  elf, client: str
-0002d8f0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-0002d900: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-0002d910: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002d920: 2020 2022 2222 5265 6d6f 7665 2063 6c69     """Remove cli
-0002d930: 656e 7420 6672 6f6d 206e 6574 776f 726b  ent from network
-0002d940: 2222 220a 2020 2020 2020 2020 7374 696d  """.        stim
-0002d950: 756c 7573 5f69 6420 3d20 7374 696d 756c  ulus_id = stimul
-0002d960: 7573 5f69 6420 6f72 2066 2272 656d 6f76  us_id or f"remov
-0002d970: 652d 636c 6965 6e74 2d7b 7469 6d65 2829  e-client-{time()
-0002d980: 7d22 0a20 2020 2020 2020 2069 6620 7365  }".        if se
-0002d990: 6c66 2e73 7461 7475 7320 3d3d 2053 7461  lf.status == Sta
-0002d9a0: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
-0002d9b0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0002d9c0: 696e 666f 2822 5265 6d6f 7665 2063 6c69  info("Remove cli
-0002d9d0: 656e 7420 2573 222c 2063 6c69 656e 7429  ent %s", client)
-0002d9e0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-0002d9f0: 675f 6576 656e 7428 5b22 616c 6c22 2c20  g_event(["all", 
-0002da00: 636c 6965 6e74 5d2c 207b 2261 6374 696f  client], {"actio
-0002da10: 6e22 3a20 2272 656d 6f76 652d 636c 6965  n": "remove-clie
-0002da20: 6e74 222c 2022 636c 6965 6e74 223a 2063  nt", "client": c
-0002da30: 6c69 656e 747d 290a 2020 2020 2020 2020  lient}).        
-0002da40: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0002da50: 2063 733a 2043 6c69 656e 7453 7461 7465   cs: ClientState
-0002da60: 203d 2073 656c 662e 636c 6965 6e74 735b   = self.clients[
-0002da70: 636c 6965 6e74 5d0a 2020 2020 2020 2020  client].        
-0002da80: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-0002da90: 0a20 2020 2020 2020 2020 2020 2023 2058  .            # X
-0002daa0: 5858 2069 7320 7468 6973 2061 206c 6567  XX is this a leg
-0002dab0: 6974 696d 6174 6520 636f 6e64 6974 696f  itimate conditio
-0002dac0: 6e3f 0a20 2020 2020 2020 2020 2020 2070  n?.            p
-0002dad0: 6173 730a 2020 2020 2020 2020 656c 7365  ass.        else
-0002dae0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0002daf0: 6c66 2e63 6c69 656e 745f 7265 6c65 6173  lf.client_releas
-0002db00: 6573 5f6b 6579 7328 0a20 2020 2020 2020  es_keys(.       
-0002db10: 2020 2020 2020 2020 206b 6579 733d 5b74           keys=[t
-0002db20: 732e 6b65 7920 666f 7220 7473 2069 6e20  s.key for ts in 
-0002db30: 6373 2e77 616e 7473 5f77 6861 745d 2c0a  cs.wants_what],.
-0002db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002db50: 636c 6965 6e74 3d63 732e 636c 6965 6e74  client=cs.client
-0002db60: 5f6b 6579 2c0a 2020 2020 2020 2020 2020  _key,.          
-0002db70: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-0002db80: 643d 7374 696d 756c 7573 5f69 642c 0a20  d=stimulus_id,. 
-0002db90: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002dba0: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
-0002dbb0: 662e 636c 6965 6e74 735b 636c 6965 6e74  f.clients[client
-0002dbc0: 5d0a 0a20 2020 2020 2020 2020 2020 2066  ]..            f
-0002dbd0: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
-0002dbe0: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
-0002dbf0: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
-0002dc00: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0002dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc20: 2020 2070 6c75 6769 6e2e 7265 6d6f 7665     plugin.remove
-0002dc30: 5f63 6c69 656e 7428 7363 6865 6475 6c65  _client(schedule
-0002dc40: 723d 7365 6c66 2c20 636c 6965 6e74 3d63  r=self, client=c
-0002dc50: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
-0002dc60: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0002dc70: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-0002dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc90: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-0002dca0: 6f6e 2865 290a 0a20 2020 2020 2020 2061  on(e)..        a
-0002dcb0: 7379 6e63 2064 6566 2072 656d 6f76 655f  sync def remove_
-0002dcc0: 636c 6965 6e74 5f66 726f 6d5f 6576 656e  client_from_even
-0002dcd0: 7473 2829 3a0a 2020 2020 2020 2020 2020  ts():.          
-0002dce0: 2020 2320 4966 2074 6865 2063 6c69 656e    # If the clien
-0002dcf0: 7420 6973 6e27 7420 7265 6769 7374 6572  t isn't register
-0002dd00: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
-0002dd10: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
-0002dd20: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
-0002dd30: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
-0002dd40: 6965 6e74 206e 6f74 2069 6e20 7365 6c66  ient not in self
-0002dd50: 2e63 6c69 656e 7473 2061 6e64 2063 6c69  .clients and cli
-0002dd60: 656e 7420 696e 2073 656c 662e 6576 656e  ent in self.even
-0002dd70: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0002dd80: 2020 2020 6465 6c20 7365 6c66 2e65 7665      del self.eve
-0002dd90: 6e74 735b 636c 6965 6e74 5d0a 0a20 2020  nts[client]..   
-0002dda0: 2020 2020 2063 6c65 616e 7570 5f64 656c       cleanup_del
-0002ddb0: 6179 203d 2070 6172 7365 5f74 696d 6564  ay = parse_timed
-0002ddc0: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-0002ddd0: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
-0002dde0: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0002ddf0: 6368 6564 756c 6572 2e65 7665 6e74 732d  cheduler.events-
-0002de00: 636c 6561 6e75 702d 6465 6c61 7922 290a  cleanup-delay").
-0002de10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002de20: 2020 6966 206e 6f74 2073 656c 662e 5f6f    if not self._o
-0002de30: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
-0002de40: 645f 7461 736b 732e 636c 6f73 6564 3a0a  d_tasks.closed:.
-0002de50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002de60: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
-0002de70: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
-0002de80: 6c61 7465 7228 0a20 2020 2020 2020 2020  later(.         
-0002de90: 2020 2020 2020 2063 6c65 616e 7570 5f64         cleanup_d
-0002dea0: 656c 6179 2c20 7265 6d6f 7665 5f63 6c69  elay, remove_cli
-0002deb0: 656e 745f 6672 6f6d 5f65 7665 6e74 730a  ent_from_events.
-0002dec0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0002ded0: 2020 2064 6566 2073 656e 645f 7461 736b     def send_task
-0002dee0: 5f74 6f5f 776f 726b 6572 280a 2020 2020  _to_worker(.    
-0002def0: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
-0002df00: 3a20 7374 722c 2074 733a 2054 6173 6b53  : str, ts: TaskS
-0002df10: 7461 7465 2c20 6475 7261 7469 6f6e 3a20  tate, duration: 
-0002df20: 666c 6f61 7420 3d20 2d31 0a20 2020 2029  float = -1.    )
-0002df30: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002df40: 2020 2222 2253 656e 6420 6120 7369 6e67    """Send a sing
-0002df50: 6c65 2063 6f6d 7075 7461 7469 6f6e 616c  le computational
-0002df60: 2074 6173 6b20 746f 2061 2077 6f72 6b65   task to a worke
-0002df70: 7222 2222 0a20 2020 2020 2020 2074 7279  r""".        try
-0002df80: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
-0002df90: 673a 2064 6963 7420 3d20 7365 6c66 2e5f  g: dict = self._
-0002dfa0: 7461 736b 5f74 6f5f 6d73 6728 7473 2c20  task_to_msg(ts, 
-0002dfb0: 6475 7261 7469 6f6e 290a 2020 2020 2020  duration).      
-0002dfc0: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-0002dfd0: 725f 7365 6e64 2877 6f72 6b65 722c 206d  r_send(worker, m
-0002dfe0: 7367 290a 2020 2020 2020 2020 6578 6365  sg).        exce
-0002dff0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-0002e000: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-0002e010: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-0002e020: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
-0002e030: 6620 4c4f 475f 5044 423a 0a20 2020 2020  f LOG_PDB:.     
-0002e040: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
-0002e050: 7420 7064 620a 0a20 2020 2020 2020 2020  t pdb..         
-0002e060: 2020 2020 2020 2070 6462 2e73 6574 5f74         pdb.set_t
-0002e070: 7261 6365 2829 0a20 2020 2020 2020 2020  race().         
-0002e080: 2020 2072 6169 7365 0a0a 2020 2020 6465     raise..    de
-0002e090: 6620 6861 6e64 6c65 5f75 6e63 6175 6768  f handle_uncaugh
-0002e0a0: 745f 6572 726f 7228 7365 6c66 2c20 2a2a  t_error(self, **
-0002e0b0: 6d73 6729 3a0a 2020 2020 2020 2020 6c6f  msg):.        lo
-0002e0c0: 6767 6572 2e65 7863 6570 7469 6f6e 2863  gger.exception(c
-0002e0d0: 6c65 616e 5f65 7863 6570 7469 6f6e 282a  lean_exception(*
-0002e0e0: 2a6d 7367 295b 315d 290a 0a20 2020 2064  *msg)[1])..    d
-0002e0f0: 6566 2068 616e 646c 655f 7461 736b 5f66  ef handle_task_f
-0002e100: 696e 6973 6865 6428 0a20 2020 2020 2020  inished(.       
-0002e110: 2073 656c 662c 206b 6579 3a20 7374 722c   self, key: str,
-0002e120: 2077 6f72 6b65 723a 2073 7472 2c20 7374   worker: str, st
-0002e130: 696d 756c 7573 5f69 643a 2073 7472 2c20  imulus_id: str, 
-0002e140: 2a2a 6d73 670a 2020 2020 2920 2d3e 204e  **msg.    ) -> N
-0002e150: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-0002e160: 776f 726b 6572 206e 6f74 2069 6e20 7365  worker not in se
-0002e170: 6c66 2e77 6f72 6b65 7273 3a0a 2020 2020  lf.workers:.    
-0002e180: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0002e190: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
-0002e1a0: 6b65 7928 6b65 7929 0a0a 2020 2020 2020  key(key)..      
-0002e1b0: 2020 723a 2074 7570 6c65 203d 2073 656c    r: tuple = sel
-0002e1c0: 662e 7374 696d 756c 7573 5f74 6173 6b5f  f.stimulus_task_
-0002e1d0: 6669 6e69 7368 6564 280a 2020 2020 2020  finished(.      
-0002e1e0: 2020 2020 2020 6b65 793d 6b65 792c 2077        key=key, w
-0002e1f0: 6f72 6b65 723d 776f 726b 6572 2c20 7374  orker=worker, st
-0002e200: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
-0002e210: 7573 5f69 642c 202a 2a6d 7367 0a20 2020  us_id, **msg.   
-0002e220: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0002e230: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-0002e240: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-0002e250: 6b65 725f 6d73 6773 203d 2072 0a20 2020  ker_msgs = r.   
-0002e260: 2020 2020 2073 656c 662e 5f74 7261 6e73       self._trans
-0002e270: 6974 696f 6e73 2872 6563 6f6d 6d65 6e64  itions(recommend
-0002e280: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
-0002e290: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-0002e2a0: 2c20 7374 696d 756c 7573 5f69 6429 0a20  , stimulus_id). 
-0002e2b0: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
-0002e2c0: 5f61 6c6c 2863 6c69 656e 745f 6d73 6773  _all(client_msgs
-0002e2d0: 2c20 776f 726b 6572 5f6d 7367 7329 0a0a  , worker_msgs)..
-0002e2e0: 2020 2020 2020 2020 7365 6c66 2e73 7469          self.sti
-0002e2f0: 6d75 6c75 735f 7175 6575 655f 736c 6f74  mulus_queue_slot
-0002e300: 735f 6d61 7962 655f 6f70 656e 6564 2873  s_maybe_opened(s
-0002e310: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-0002e320: 6c75 735f 6964 290a 0a20 2020 2064 6566  lus_id)..    def
-0002e330: 2068 616e 646c 655f 7461 736b 5f65 7272   handle_task_err
-0002e340: 6564 2873 656c 662c 206b 6579 3a20 7374  ed(self, key: st
-0002e350: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
-0002e360: 7374 722c 202a 2a6d 7367 2920 2d3e 204e  str, **msg) -> N
-0002e370: 6f6e 653a 0a20 2020 2020 2020 2072 3a20  one:.        r: 
-0002e380: 7475 706c 6520 3d20 7365 6c66 2e73 7469  tuple = self.sti
-0002e390: 6d75 6c75 735f 7461 736b 5f65 7272 6564  mulus_task_erred
-0002e3a0: 286b 6579 3d6b 6579 2c20 7374 696d 756c  (key=key, stimul
-0002e3b0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-0002e3c0: 642c 202a 2a6d 7367 290a 2020 2020 2020  d, **msg).      
-0002e3d0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0002e3e0: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-0002e3f0: 776f 726b 6572 5f6d 7367 7320 3d20 720a  worker_msgs = r.
-0002e400: 2020 2020 2020 2020 7365 6c66 2e5f 7472          self._tr
-0002e410: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
-0002e420: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-0002e430: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-0002e440: 7367 732c 2073 7469 6d75 6c75 735f 6964  sgs, stimulus_id
-0002e450: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0002e460: 656e 645f 616c 6c28 636c 6965 6e74 5f6d  end_all(client_m
-0002e470: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-0002e480: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0002e490: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
-0002e4a0: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
-0002e4b0: 6428 7374 696d 756c 7573 5f69 643d 7374  d(stimulus_id=st
-0002e4c0: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-0002e4d0: 6465 6620 7265 6c65 6173 655f 776f 726b  def release_work
-0002e4e0: 6572 5f64 6174 6128 7365 6c66 2c20 6b65  er_data(self, ke
-0002e4f0: 793a 2073 7472 2c20 776f 726b 6572 3a20  y: str, worker: 
-0002e500: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
-0002e510: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-0002e520: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0002e530: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-0002e540: 0a20 2020 2020 2020 2077 7320 3d20 7365  .        ws = se
-0002e550: 6c66 2e77 6f72 6b65 7273 2e67 6574 2877  lf.workers.get(w
-0002e560: 6f72 6b65 7229 0a20 2020 2020 2020 2069  orker).        i
-0002e570: 6620 6e6f 7420 7473 206f 7220 6e6f 7420  f not ts or not 
-0002e580: 7773 206f 7220 7773 206e 6f74 2069 6e20  ws or ws not in 
-0002e590: 7473 2e77 686f 5f68 6173 3a0a 2020 2020  ts.who_has:.    
-0002e5a0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-0002e5b0: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
-0002e5c0: 6f76 655f 7265 706c 6963 6128 7473 2c20  ove_replica(ts, 
-0002e5d0: 7773 290a 2020 2020 2020 2020 6966 206e  ws).        if n
-0002e5e0: 6f74 2074 732e 7768 6f5f 6861 733a 0a20  ot ts.who_has:. 
-0002e5f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0002e600: 7472 616e 7369 7469 6f6e 7328 7b6b 6579  transitions({key
-0002e610: 3a20 2272 656c 6561 7365 6422 7d2c 2073  : "released"}, s
-0002e620: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
-0002e630: 2064 6566 2068 616e 646c 655f 6c6f 6e67   def handle_long
-0002e640: 5f72 756e 6e69 6e67 280a 2020 2020 2020  _running(.      
-0002e650: 2020 7365 6c66 2c20 6b65 793a 2073 7472    self, key: str
-0002e660: 2c20 776f 726b 6572 3a20 7374 722c 2063  , worker: str, c
-0002e670: 6f6d 7075 7465 5f64 7572 6174 696f 6e3a  ompute_duration:
-0002e680: 2066 6c6f 6174 207c 204e 6f6e 652c 2073   float | None, s
-0002e690: 7469 6d75 6c75 735f 6964 3a20 7374 720a  timulus_id: str.
-0002e6a0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-0002e6b0: 2020 2020 2020 2022 2222 4120 7461 736b         """A task
-0002e6c0: 2068 6173 2073 6563 6564 6564 2066 726f   has seceded fro
-0002e6d0: 6d20 7468 6520 7468 7265 6164 2070 6f6f  m the thread poo
-0002e6e0: 6c0a 0a20 2020 2020 2020 2057 6520 7374  l..        We st
-0002e6f0: 6f70 2074 6865 2074 6173 6b20 6672 6f6d  op the task from
-0002e700: 2062 6569 6e67 2073 746f 6c65 6e20 696e   being stolen in
-0002e710: 2074 6865 2066 7574 7572 652c 2061 6e64   the future, and
-0002e720: 2063 6861 6e67 6520 7461 736b 0a20 2020   change task.   
-0002e730: 2020 2020 2064 7572 6174 696f 6e20 6163       duration ac
-0002e740: 636f 756e 7469 6e67 2061 7320 6966 2074  counting as if t
-0002e750: 6865 2074 6173 6b20 6861 7320 7374 6f70  he task has stop
-0002e760: 7065 642e 0a20 2020 2020 2020 2022 2222  ped..        """
-0002e770: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-0002e780: 6e6f 7420 696e 2073 656c 662e 7461 736b  not in self.task
-0002e790: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
-0002e7a0: 6f67 6765 722e 6465 6275 6728 2253 6b69  ogger.debug("Ski
-0002e7b0: 7070 696e 6720 6c6f 6e67 5f72 756e 6e69  pping long_runni
-0002e7c0: 6e67 2073 696e 6365 206b 6579 2025 7320  ng since key %s 
-0002e7d0: 7761 7320 616c 7265 6164 7920 7265 6c65  was already rele
-0002e7e0: 6173 6564 222c 206b 6579 290a 2020 2020  ased", key).    
-0002e7f0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0002e800: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-0002e810: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-0002e820: 2020 2020 7374 6561 6c20 3d20 7365 6c66      steal = self
-0002e830: 2e65 7874 656e 7369 6f6e 732e 6765 7428  .extensions.get(
-0002e840: 2273 7465 616c 696e 6722 290a 2020 2020  "stealing").    
-0002e850: 2020 2020 6966 2073 7465 616c 2069 7320      if steal is 
-0002e860: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0002e870: 2020 2020 2020 7374 6561 6c2e 7265 6d6f        steal.remo
-0002e880: 7665 5f6b 6579 5f66 726f 6d5f 7374 6561  ve_key_from_stea
-0002e890: 6c61 626c 6528 7473 290a 0a20 2020 2020  lable(ts)..     
-0002e8a0: 2020 2077 7320 3d20 7473 2e70 726f 6365     ws = ts.proce
-0002e8b0: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-0002e8c0: 2069 6620 7773 2069 7320 4e6f 6e65 3a0a   if ws is None:.
-0002e8d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002e8e0: 6572 2e64 6562 7567 2822 5265 6365 6976  er.debug("Receiv
-0002e8f0: 6564 206c 6f6e 672d 7275 6e6e 696e 6720  ed long-running 
-0002e900: 7369 676e 616c 2066 726f 6d20 6475 706c  signal from dupl
-0002e910: 6963 6174 6520 7461 736b 2e20 4967 6e6f  icate task. Igno
-0002e920: 7269 6e67 2e22 290a 2020 2020 2020 2020  ring.").        
-0002e930: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0002e940: 2020 2020 6966 2063 6f6d 7075 7465 5f64      if compute_d
-0002e950: 7572 6174 696f 6e20 6973 206e 6f74 204e  uration is not N
-0002e960: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002e970: 206f 6c64 5f64 7572 6174 696f 6e20 3d20   old_duration = 
-0002e980: 7473 2e70 7265 6669 782e 6475 7261 7469  ts.prefix.durati
-0002e990: 6f6e 5f61 7665 7261 6765 0a20 2020 2020  on_average.     
-0002e9a0: 2020 2020 2020 2069 6620 6f6c 645f 6475         if old_du
-0002e9b0: 7261 7469 6f6e 203c 2030 3a0a 2020 2020  ration < 0:.    
-0002e9c0: 2020 2020 2020 2020 2020 2020 7473 2e70              ts.p
-0002e9d0: 7265 6669 782e 6475 7261 7469 6f6e 5f61  refix.duration_a
-0002e9e0: 7665 7261 6765 203d 2063 6f6d 7075 7465  verage = compute
-0002e9f0: 5f64 7572 6174 696f 6e0a 2020 2020 2020  _duration.      
-0002ea00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002ea10: 2020 2020 2020 2020 2020 2020 7473 2e70              ts.p
-0002ea20: 7265 6669 782e 6475 7261 7469 6f6e 5f61  refix.duration_a
-0002ea30: 7665 7261 6765 203d 2028 6f6c 645f 6475  verage = (old_du
-0002ea40: 7261 7469 6f6e 202b 2063 6f6d 7075 7465  ration + compute
-0002ea50: 5f64 7572 6174 696f 6e29 202f 2032 0a0a  _duration) / 2..
-0002ea60: 2020 2020 2020 2020 7773 2e61 6464 5f74          ws.add_t
-0002ea70: 6f5f 6c6f 6e67 5f72 756e 6e69 6e67 2874  o_long_running(t
-0002ea80: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-0002ea90: 6368 6563 6b5f 6964 6c65 5f73 6174 7572  check_idle_satur
-0002eaa0: 6174 6564 2877 7329 0a0a 2020 2020 2020  ated(ws)..      
-0002eab0: 2020 7365 6c66 2e73 7469 6d75 6c75 735f    self.stimulus_
-0002eac0: 7175 6575 655f 736c 6f74 735f 6d61 7962  queue_slots_mayb
-0002ead0: 655f 6f70 656e 6564 2873 7469 6d75 6c75  e_opened(stimulu
-0002eae0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-0002eaf0: 290a 0a20 2020 2064 6566 2068 616e 646c  )..    def handl
-0002eb00: 655f 776f 726b 6572 5f73 7461 7475 735f  e_worker_status_
-0002eb10: 6368 616e 6765 280a 2020 2020 2020 2020  change(.        
-0002eb20: 7365 6c66 2c20 7374 6174 7573 3a20 7374  self, status: st
-0002eb30: 7220 7c20 5374 6174 7573 2c20 776f 726b  r | Status, work
-0002eb40: 6572 3a20 7374 7220 7c20 576f 726b 6572  er: str | Worker
-0002eb50: 5374 6174 652c 2073 7469 6d75 6c75 735f  State, stimulus_
-0002eb60: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-0002eb70: 204e 6f6e 653a 0a20 2020 2020 2020 2077   None:.        w
-0002eb80: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-0002eb90: 2e67 6574 2877 6f72 6b65 7229 2069 6620  .get(worker) if 
-0002eba0: 6973 696e 7374 616e 6365 2877 6f72 6b65  isinstance(worke
-0002ebb0: 722c 2073 7472 2920 656c 7365 2077 6f72  r, str) else wor
-0002ebc0: 6b65 720a 2020 2020 2020 2020 6966 206e  ker.        if n
-0002ebd0: 6f74 2077 733a 0a20 2020 2020 2020 2020  ot ws:.         
-0002ebe0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0002ebf0: 2020 7072 6576 5f73 7461 7475 7320 3d20    prev_status = 
-0002ec00: 7773 2e73 7461 7475 730a 2020 2020 2020  ws.status.      
-0002ec10: 2020 7773 2e73 7461 7475 7320 3d20 5374    ws.status = St
-0002ec20: 6174 7573 5b73 7461 7475 735d 2069 6620  atus[status] if 
-0002ec30: 6973 696e 7374 616e 6365 2873 7461 7475  isinstance(statu
-0002ec40: 732c 2073 7472 2920 656c 7365 2073 7461  s, str) else sta
-0002ec50: 7475 730a 2020 2020 2020 2020 6966 2077  tus.        if w
-0002ec60: 732e 7374 6174 7573 203d 3d20 7072 6576  s.status == prev
-0002ec70: 5f73 7461 7475 733a 0a20 2020 2020 2020  _status:.       
-0002ec80: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0002ec90: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-0002eca0: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
-0002ecb0: 2077 732e 6164 6472 6573 732c 0a20 2020   ws.address,.   
-0002ecc0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0002ecd0: 2020 2020 2020 2020 2020 2022 6163 7469             "acti
-0002ece0: 6f6e 223a 2022 776f 726b 6572 2d73 7461  on": "worker-sta
-0002ecf0: 7475 732d 6368 616e 6765 222c 0a20 2020  tus-change",.   
-0002ed00: 2020 2020 2020 2020 2020 2020 2022 7072               "pr
-0002ed10: 6576 2d73 7461 7475 7322 3a20 7072 6576  ev-status": prev
-0002ed20: 5f73 7461 7475 732e 6e61 6d65 2c0a 2020  _status.name,.  
-0002ed30: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0002ed40: 7461 7475 7322 3a20 7773 2e73 7461 7475  tatus": ws.statu
-0002ed50: 732e 6e61 6d65 2c0a 2020 2020 2020 2020  s.name,.        
-0002ed60: 2020 2020 7d2c 0a20 2020 2020 2020 2029      },.        )
-0002ed70: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0002ed80: 6465 6275 6728 6622 576f 726b 6572 2073  debug(f"Worker s
-0002ed90: 7461 7475 7320 7b70 7265 765f 7374 6174  tatus {prev_stat
-0002eda0: 7573 2e6e 616d 657d 202d 3e20 7b73 7461  us.name} -> {sta
-0002edb0: 7475 737d 202d 207b 7773 7d22 290a 0a20  tus} - {ws}").. 
-0002edc0: 2020 2020 2020 2069 6620 7773 2e73 7461         if ws.sta
-0002edd0: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
-0002ede0: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-0002edf0: 2020 2073 656c 662e 7275 6e6e 696e 672e     self.running.
-0002ee00: 6164 6428 7773 290a 2020 2020 2020 2020  add(ws).        
-0002ee10: 2020 2020 7365 6c66 2e63 6865 636b 5f69      self.check_i
-0002ee20: 646c 655f 7361 7475 7261 7465 6428 7773  dle_saturated(ws
-0002ee30: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0002ee40: 6c66 2e74 7261 6e73 6974 696f 6e73 280a  lf.transitions(.
-0002ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ee60: 7365 6c66 2e62 756c 6b5f 7363 6865 6475  self.bulk_schedu
-0002ee70: 6c65 5f75 6e72 756e 6e61 626c 655f 6166  le_unrunnable_af
-0002ee80: 7465 725f 6164 6469 6e67 5f77 6f72 6b65  ter_adding_worke
-0002ee90: 7228 7773 292c 2073 7469 6d75 6c75 735f  r(ws), stimulus_
-0002eea0: 6964 0a20 2020 2020 2020 2020 2020 2029  id.            )
-0002eeb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002eec0: 662e 7374 696d 756c 7573 5f71 7565 7565  f.stimulus_queue
-0002eed0: 5f73 6c6f 7473 5f6d 6179 6265 5f6f 7065  _slots_maybe_ope
-0002eee0: 6e65 6428 7374 696d 756c 7573 5f69 643d  ned(stimulus_id=
-0002eef0: 7374 696d 756c 7573 5f69 6429 0a20 2020  stimulus_id).   
-0002ef00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002ef10: 2020 2020 2020 2073 656c 662e 7275 6e6e         self.runn
-0002ef20: 696e 672e 6469 7363 6172 6428 7773 290a  ing.discard(ws).
-0002ef30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002ef40: 2e69 646c 652e 706f 7028 7773 2e61 6464  .idle.pop(ws.add
-0002ef50: 7265 7373 2c20 4e6f 6e65 290a 2020 2020  ress, None).    
-0002ef60: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
-0002ef70: 655f 7461 736b 5f63 6f75 6e74 2e64 6973  e_task_count.dis
-0002ef80: 6361 7264 2877 7329 0a20 2020 2020 2020  card(ws).       
-0002ef90: 2020 2020 2073 656c 662e 7361 7475 7261       self.satura
-0002efa0: 7465 642e 6469 7363 6172 6428 7773 290a  ted.discard(ws).
-0002efb0: 0a20 2020 2061 7379 6e63 2064 6566 2068  .    async def h
-0002efc0: 616e 646c 655f 7265 7175 6573 745f 7265  andle_request_re
-0002efd0: 6672 6573 685f 7768 6f5f 6861 7328 0a20  fresh_who_has(. 
-0002efe0: 2020 2020 2020 2073 656c 662c 206b 6579         self, key
-0002eff0: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
-0002f000: 2c20 776f 726b 6572 3a20 7374 722c 2073  , worker: str, s
-0002f010: 7469 6d75 6c75 735f 6964 3a20 7374 720a  timulus_id: str.
-0002f020: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-0002f030: 2020 2020 2020 2022 2222 4173 796e 6368         """Asynch
-0002f040: 726f 6e6f 7573 2072 6571 7565 7374 2028  ronous request (
-0002f050: 7468 726f 7567 6820 6275 6c6b 2063 6f6d  through bulk com
-0002f060: 6d73 2920 6672 6f6d 2061 2057 6f72 6b65  ms) from a Worke
-0002f070: 7220 746f 2072 6566 7265 7368 2074 6865  r to refresh the
-0002f080: 0a20 2020 2020 2020 2077 686f 5f68 6173  .        who_has
-0002f090: 2066 6f72 2073 6f6d 6520 6b65 7973 2e20   for some keys. 
-0002f0a0: 4e6f 7420 746f 2062 6520 636f 6e66 7573  Not to be confus
-0002f0b0: 6564 2077 6974 6820 7363 6865 6475 6c65  ed with schedule
-0002f0c0: 722e 7768 6f5f 6861 732c 2077 6869 6368  r.who_has, which
-0002f0d0: 2069 7320 610a 2020 2020 2020 2020 7379   is a.        sy
-0002f0e0: 6e63 6872 6f6e 6f75 7320 5250 4320 7265  nchronous RPC re
-0002f0f0: 7175 6573 7420 6672 6f6d 2061 2043 6c69  quest from a Cli
-0002f100: 656e 742e 0a20 2020 2020 2020 2022 2222  ent..        """
-0002f110: 0a20 2020 2020 2020 2077 686f 5f68 6173  .        who_has
-0002f120: 203d 207b 7d0a 2020 2020 2020 2020 6672   = {}.        fr
-0002f130: 6565 5f6b 6579 7320 3d20 5b5d 0a20 2020  ee_keys = [].   
-0002f140: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-0002f150: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-0002f160: 2020 6966 206b 6579 2069 6e20 7365 6c66    if key in self
-0002f170: 2e74 6173 6b73 3a0a 2020 2020 2020 2020  .tasks:.        
-0002f180: 2020 2020 2020 2020 7768 6f5f 6861 735b          who_has[
-0002f190: 6b65 795d 203d 205b 7773 2e61 6464 7265  key] = [ws.addre
-0002f1a0: 7373 2066 6f72 2077 7320 696e 2073 656c  ss for ws in sel
-0002f1b0: 662e 7461 736b 735b 6b65 795d 2e77 686f  f.tasks[key].who
-0002f1c0: 5f68 6173 5d0a 2020 2020 2020 2020 2020  _has].          
-0002f1d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002f1e0: 2020 2020 2020 2020 6672 6565 5f6b 6579          free_key
-0002f1f0: 732e 6170 7065 6e64 286b 6579 290a 0a20  s.append(key).. 
-0002f200: 2020 2020 2020 2069 6620 7768 6f5f 6861         if who_ha
-0002f210: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-0002f220: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
-0002f230: 5b77 6f72 6b65 725d 2e73 656e 6428 0a20  [worker].send(. 
-0002f240: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0002f250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f260: 2020 2020 2022 6f70 223a 2022 7265 6672       "op": "refr
-0002f270: 6573 682d 7768 6f2d 6861 7322 2c0a 2020  esh-who-has",.  
-0002f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f290: 2020 2277 686f 5f68 6173 223a 2077 686f    "who_has": who
-0002f2a0: 5f68 6173 2c0a 2020 2020 2020 2020 2020  _has,.          
-0002f2b0: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
-0002f2c0: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
-0002f2d0: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
-0002f2e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0002f2f0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
-0002f300: 2066 7265 655f 6b65 7973 3a0a 2020 2020   free_keys:.    
-0002f310: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
-0002f320: 6561 6d5f 636f 6d6d 735b 776f 726b 6572  eam_comms[worker
-0002f330: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
-0002f340: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0002f350: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-0002f360: 7022 3a20 2266 7265 652d 6b65 7973 222c  p": "free-keys",
-0002f370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f380: 2020 2020 2022 6b65 7973 223a 2066 7265       "keys": fre
-0002f390: 655f 6b65 7973 2c0a 2020 2020 2020 2020  e_keys,.        
-0002f3a0: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-0002f3b0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-0002f3c0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-0002f3d0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0002f3e0: 2020 2020 2020 290a 0a20 2020 2061 7379        )..    asy
-0002f3f0: 6e63 2064 6566 2068 616e 646c 655f 776f  nc def handle_wo
-0002f400: 726b 6572 2873 656c 662c 2063 6f6d 6d3a  rker(self, comm:
-0002f410: 2043 6f6d 6d2c 2077 6f72 6b65 723a 2073   Comm, worker: s
-0002f420: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
-0002f430: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0002f440: 204c 6973 7465 6e20 746f 2072 6573 706f   Listen to respo
-0002f450: 6e73 6573 2066 726f 6d20 6120 7369 6e67  nses from a sing
-0002f460: 6c65 2077 6f72 6b65 720a 0a20 2020 2020  le worker..     
-0002f470: 2020 2054 6869 7320 6973 2074 6865 206d     This is the m
-0002f480: 6169 6e20 6c6f 6f70 2066 6f72 2073 6368  ain loop for sch
-0002f490: 6564 756c 6572 2d77 6f72 6b65 7220 696e  eduler-worker in
-0002f4a0: 7465 7261 6374 696f 6e0a 0a20 2020 2020  teraction..     
-0002f4b0: 2020 2053 6565 2041 6c73 6f0a 2020 2020     See Also.    
-0002f4c0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-0002f4d0: 2020 2020 2053 6368 6564 756c 6572 2e68       Scheduler.h
-0002f4e0: 616e 646c 655f 636c 6965 6e74 3a20 4571  andle_client: Eq
-0002f4f0: 7569 7661 6c65 6e74 2063 6f72 6f75 7469  uivalent corouti
-0002f500: 6e65 2066 6f72 2063 6c69 656e 7473 0a20  ne for clients. 
-0002f510: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0002f520: 2020 2063 6f6d 6d2e 6e61 6d65 203d 2022     comm.name = "
-0002f530: 5363 6865 6475 6c65 7220 636f 6e6e 6563  Scheduler connec
-0002f540: 7469 6f6e 2074 6f20 776f 726b 6572 220a  tion to worker".
-0002f550: 2020 2020 2020 2020 776f 726b 6572 5f63          worker_c
-0002f560: 6f6d 6d20 3d20 7365 6c66 2e73 7472 6561  omm = self.strea
-0002f570: 6d5f 636f 6d6d 735b 776f 726b 6572 5d0a  m_comms[worker].
-0002f580: 2020 2020 2020 2020 776f 726b 6572 5f63          worker_c
-0002f590: 6f6d 6d2e 7374 6172 7428 636f 6d6d 290a  omm.start(comm).
-0002f5a0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0002f5b0: 6e66 6f28 2253 7461 7274 696e 6720 776f  nfo("Starting wo
-0002f5c0: 726b 6572 2063 6f6d 7075 7465 2073 7472  rker compute str
-0002f5d0: 6561 6d2c 2025 7322 2c20 776f 726b 6572  eam, %s", worker
-0002f5e0: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-0002f5f0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0002f600: 2073 656c 662e 6861 6e64 6c65 5f73 7472   self.handle_str
-0002f610: 6561 6d28 636f 6d6d 3d63 6f6d 6d2c 2065  eam(comm=comm, e
-0002f620: 7874 7261 3d7b 2277 6f72 6b65 7222 3a20  xtra={"worker": 
-0002f630: 776f 726b 6572 7d29 0a20 2020 2020 2020  worker}).       
-0002f640: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-0002f650: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
-0002f660: 696e 2073 656c 662e 7374 7265 616d 5f63  in self.stream_c
-0002f670: 6f6d 6d73 3a0a 2020 2020 2020 2020 2020  omms:.          
-0002f680: 2020 2020 2020 776f 726b 6572 5f63 6f6d        worker_com
-0002f690: 6d2e 6162 6f72 7428 290a 2020 2020 2020  m.abort().      
-0002f6a0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0002f6b0: 7365 6c66 2e72 656d 6f76 655f 776f 726b  self.remove_work
-0002f6c0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-0002f6d0: 2020 2020 2020 2020 776f 726b 6572 2c20          worker, 
-0002f6e0: 7374 696d 756c 7573 5f69 643d 6622 6861  stimulus_id=f"ha
-0002f6f0: 6e64 6c65 2d77 6f72 6b65 722d 636c 6561  ndle-worker-clea
-0002f700: 6e75 702d 7b74 696d 6528 297d 220a 2020  nup-{time()}".  
-0002f710: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0002f720: 0a20 2020 2064 6566 2061 6464 5f70 6c75  .    def add_plu
-0002f730: 6769 6e28 0a20 2020 2020 2020 2073 656c  gin(.        sel
-0002f740: 662c 0a20 2020 2020 2020 2070 6c75 6769  f,.        plugi
-0002f750: 6e3a 2053 6368 6564 756c 6572 506c 7567  n: SchedulerPlug
-0002f760: 696e 2c0a 2020 2020 2020 2020 2a2c 0a20  in,.        *,. 
-0002f770: 2020 2020 2020 2069 6465 6d70 6f74 656e         idempoten
-0002f780: 743a 2062 6f6f 6c20 3d20 4661 6c73 652c  t: bool = False,
-0002f790: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
-0002f7a0: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-0002f7b0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-0002f7c0: 6773 2c0a 2020 2020 293a 0a20 2020 2020  gs,.    ):.     
-0002f7d0: 2020 2022 2222 4164 6420 6578 7465 726e     """Add extern
-0002f7e0: 616c 2070 6c75 6769 6e20 746f 2073 6368  al plugin to sch
-0002f7f0: 6564 756c 6572 2e0a 0a20 2020 2020 2020  eduler...       
-0002f800: 2053 6565 2068 7474 7073 3a2f 2f64 6973   See https://dis
-0002f810: 7472 6962 7574 6564 2e72 6561 6474 6865  tributed.readthe
-0002f820: 646f 6373 2e69 6f2f 656e 2f6c 6174 6573  docs.io/en/lates
-0002f830: 742f 706c 7567 696e 732e 6874 6d6c 0a0a  t/plugins.html..
-0002f840: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-0002f850: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-0002f860: 2d2d 2d2d 2d0a 2020 2020 2020 2020 706c  -----.        pl
-0002f870: 7567 696e 203a 2053 6368 6564 756c 6572  ugin : Scheduler
-0002f880: 506c 7567 696e 0a20 2020 2020 2020 2020  Plugin.         
-0002f890: 2020 2053 6368 6564 756c 6572 506c 7567     SchedulerPlug
-0002f8a0: 696e 2069 6e73 7461 6e63 6520 746f 2061  in instance to a
-0002f8b0: 6464 0a20 2020 2020 2020 2069 6465 6d70  dd.        idemp
-0002f8c0: 6f74 656e 7420 3a20 626f 6f6c 0a20 2020  otent : bool.   
-0002f8d0: 2020 2020 2020 2020 2049 6620 7472 7565           If true
-0002f8e0: 2c20 7468 6520 706c 7567 696e 2069 7320  , the plugin is 
-0002f8f0: 6173 7375 6d65 6420 746f 2061 6c72 6561  assumed to alrea
-0002f900: 6479 2065 7869 7374 2061 6e64 206e 6f0a  dy exist and no.
-0002f910: 2020 2020 2020 2020 2020 2020 6163 7469              acti
-0002f920: 6f6e 2069 7320 7461 6b65 6e2e 0a20 2020  on is taken..   
-0002f930: 2020 2020 206e 616d 6520 3a20 7374 720a       name : str.
-0002f940: 2020 2020 2020 2020 2020 2020 4120 6e61              A na
-0002f950: 6d65 2066 6f72 2074 6865 2070 6c75 6769  me for the plugi
-0002f960: 6e2c 2069 6620 4e6f 6e65 2c20 7468 6520  n, if None, the 
-0002f970: 6e61 6d65 2061 7474 7269 6275 7465 2069  name attribute i
-0002f980: 730a 2020 2020 2020 2020 2020 2020 6368  s.            ch
-0002f990: 6563 6b65 6420 6f6e 2074 6865 2050 6c75  ecked on the Plu
-0002f9a0: 6769 6e20 696e 7374 616e 6365 2061 6e64  gin instance and
-0002f9b0: 2067 656e 6572 6174 6564 2069 6620 6e6f   generated if no
-0002f9c0: 740a 2020 2020 2020 2020 2020 2020 6469  t.            di
-0002f9d0: 7363 6f76 6572 6564 2e0a 2020 2020 2020  scovered..      
-0002f9e0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-0002f9f0: 206e 616d 6520 6973 204e 6f6e 653a 0a20   name is None:. 
-0002fa00: 2020 2020 2020 2020 2020 206e 616d 6520             name 
-0002fa10: 3d20 5f67 6574 5f70 6c75 6769 6e5f 6e61  = _get_plugin_na
-0002fa20: 6d65 2870 6c75 6769 6e29 0a0a 2020 2020  me(plugin)..    
-0002fa30: 2020 2020 6966 206e 616d 6520 696e 2073      if name in s
-0002fa40: 656c 662e 706c 7567 696e 733a 0a20 2020  elf.plugins:.   
-0002fa50: 2020 2020 2020 2020 2069 6620 6964 656d           if idem
-0002fa60: 706f 7465 6e74 3a0a 2020 2020 2020 2020  potent:.        
-0002fa70: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0002fa80: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
-0002fa90: 6e67 732e 7761 726e 280a 2020 2020 2020  ngs.warn(.      
-0002faa0: 2020 2020 2020 2020 2020 6622 5363 6865            f"Sche
-0002fab0: 6475 6c65 7220 616c 7265 6164 7920 636f  duler already co
-0002fac0: 6e74 6169 6e73 2061 2070 6c75 6769 6e20  ntains a plugin 
-0002fad0: 7769 7468 206e 616d 6520 7b6e 616d 657d  with name {name}
-0002fae0: 3b20 6f76 6572 7772 6974 696e 672e 222c  ; overwriting.",
-0002faf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fb00: 2063 6174 6567 6f72 793d 5573 6572 5761   category=UserWa
-0002fb10: 726e 696e 672c 0a20 2020 2020 2020 2020  rning,.         
-0002fb20: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-0002fb30: 6c66 2e70 6c75 6769 6e73 5b6e 616d 655d  lf.plugins[name]
-0002fb40: 203d 2070 6c75 6769 6e0a 0a20 2020 2064   = plugin..    d
-0002fb50: 6566 2072 656d 6f76 655f 706c 7567 696e  ef remove_plugin
-0002fb60: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0002fb70: 2020 2020 2020 2020 6e61 6d65 3a20 7374          name: st
-0002fb80: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-0002fb90: 0a20 2020 2020 2020 2070 6c75 6769 6e3a  .        plugin:
-0002fba0: 2053 6368 6564 756c 6572 506c 7567 696e   SchedulerPlugin
-0002fbb0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0002fbc0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-0002fbd0: 2020 2020 2020 2022 2222 5265 6d6f 7665         """Remove
-0002fbe0: 2065 7874 6572 6e61 6c20 706c 7567 696e   external plugin
-0002fbf0: 2066 726f 6d20 7363 6865 6475 6c65 720a   from scheduler.
-0002fc00: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-0002fc10: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-0002fc20: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206e  ------.        n
-0002fc30: 616d 6520 3a20 7374 720a 2020 2020 2020  ame : str.      
-0002fc40: 2020 2020 2020 4e61 6d65 206f 6620 7468        Name of th
-0002fc50: 6520 706c 7567 696e 2074 6f20 7265 6d6f  e plugin to remo
-0002fc60: 7665 0a20 2020 2020 2020 2022 2222 0a20  ve.        """. 
-0002fc70: 2020 2020 2020 2061 7373 6572 7420 6e61         assert na
-0002fc80: 6d65 2069 7320 6e6f 7420 4e6f 6e65 0a0a  me is not None..
-0002fc90: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002fca0: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
-0002fcb0: 662e 706c 7567 696e 735b 6e61 6d65 5d0a  f.plugins[name].
-0002fcc0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-0002fcd0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-0002fce0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0002fcf0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0002fd00: 2020 2020 2020 2066 2243 6f75 6c64 206e         f"Could n
-0002fd10: 6f74 2066 696e 6420 706c 7567 696e 207b  ot find plugin {
-0002fd20: 6e61 6d65 2172 7d20 616d 6f6e 6720 7468  name!r} among th
-0002fd30: 6520 6375 7272 656e 7420 7363 6865 6475  e current schedu
-0002fd40: 6c65 7220 706c 7567 696e 7322 0a20 2020  ler plugins".   
-0002fd50: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0002fd60: 6173 796e 6320 6465 6620 7265 6769 7374  async def regist
-0002fd70: 6572 5f73 6368 6564 756c 6572 5f70 6c75  er_scheduler_plu
-0002fd80: 6769 6e28 7365 6c66 2c20 706c 7567 696e  gin(self, plugin
-0002fd90: 2c20 6e61 6d65 3d4e 6f6e 652c 2069 6465  , name=None, ide
-0002fda0: 6d70 6f74 656e 743d 4e6f 6e65 293a 0a20  mpotent=None):. 
-0002fdb0: 2020 2020 2020 2022 2222 5265 6769 7374         """Regist
-0002fdc0: 6572 2061 2070 6c75 6769 6e20 6f6e 2074  er a plugin on t
-0002fdd0: 6865 2073 6368 6564 756c 6572 2e22 2222  he scheduler."""
-0002fde0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0002fdf0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0002fe00: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-0002fe10: 6564 756c 6572 2e70 6963 6b6c 6522 293a  eduler.pickle"):
-0002fe20: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0002fe30: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-0002fe40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002fe50: 4361 6e6e 6f74 2072 6567 6973 7465 7220  Cannot register 
-0002fe60: 6120 7363 6865 6475 6c65 7220 706c 7567  a scheduler plug
-0002fe70: 696e 2061 7320 7468 6520 7363 6865 6475  in as the schedu
-0002fe80: 6c65 7220 220a 2020 2020 2020 2020 2020  ler ".          
-0002fe90: 2020 2020 2020 2268 6173 2062 6565 6e20        "has been 
-0002fea0: 6578 706c 6963 6974 6c79 2064 6973 616c  explicitly disal
-0002feb0: 6c6f 7765 6420 6672 6f6d 2064 6573 6572  lowed from deser
-0002fec0: 6961 6c69 7a69 6e67 2022 0a20 2020 2020  ializing ".     
-0002fed0: 2020 2020 2020 2020 2020 2022 6172 6269             "arbi
-0002fee0: 7472 6172 7920 6279 7465 7374 7269 6e67  trary bytestring
-0002fef0: 7320 7573 696e 6720 7069 636b 6c65 2076  s using pickle v
-0002ff00: 6961 2074 6865 2022 0a20 2020 2020 2020  ia the ".       
-0002ff10: 2020 2020 2020 2020 2022 2764 6973 7472           "'distr
-0002ff20: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0002ff30: 2e70 6963 6b6c 6527 2063 6f6e 6669 6775  .pickle' configu
-0002ff40: 7261 7469 6f6e 2073 6574 7469 6e67 2e22  ration setting."
-0002ff50: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002ff60: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0002ff70: 696e 7374 616e 6365 2870 6c75 6769 6e2c  instance(plugin,
-0002ff80: 2053 6368 6564 756c 6572 506c 7567 696e   SchedulerPlugin
-0002ff90: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-0002ffa0: 6c75 6769 6e20 3d20 6c6f 6164 7328 706c  lugin = loads(pl
-0002ffb0: 7567 696e 290a 0a20 2020 2020 2020 2069  ugin)..        i
-0002ffc0: 6620 6e61 6d65 2069 7320 4e6f 6e65 3a0a  f name is None:.
-0002ffd0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0002ffe0: 203d 205f 6765 745f 706c 7567 696e 5f6e   = _get_plugin_n
-0002fff0: 616d 6528 706c 7567 696e 290a 0a20 2020  ame(plugin)..   
-00030000: 2020 2020 2069 6620 6e61 6d65 2069 6e20       if name in 
-00030010: 7365 6c66 2e70 6c75 6769 6e73 2061 6e64  self.plugins and
-00030020: 2069 6465 6d70 6f74 656e 743a 0a20 2020   idempotent:.   
-00030030: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00030040: 0a20 2020 2020 2020 2069 6620 6861 7361  .        if hasa
-00030050: 7474 7228 706c 7567 696e 2c20 2273 7461  ttr(plugin, "sta
-00030060: 7274 2229 3a0a 2020 2020 2020 2020 2020  rt"):.          
-00030070: 2020 7265 7375 6c74 203d 2070 6c75 6769    result = plugi
-00030080: 6e2e 7374 6172 7428 7365 6c66 290a 2020  n.start(self).  
-00030090: 2020 2020 2020 2020 2020 6966 2069 6e73            if ins
-000300a0: 7065 6374 2e69 7361 7761 6974 6162 6c65  pect.isawaitable
-000300b0: 2872 6573 756c 7429 3a0a 2020 2020 2020  (result):.      
-000300c0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-000300d0: 7265 7375 6c74 0a0a 2020 2020 2020 2020  result..        
-000300e0: 7365 6c66 2e61 6464 5f70 6c75 6769 6e28  self.add_plugin(
-000300f0: 706c 7567 696e 2c20 6e61 6d65 3d6e 616d  plugin, name=nam
-00030100: 652c 2069 6465 6d70 6f74 656e 743d 6964  e, idempotent=id
-00030110: 656d 706f 7465 6e74 290a 0a20 2020 2064  empotent)..    d
-00030120: 6566 2077 6f72 6b65 725f 7365 6e64 2873  ef worker_send(s
-00030130: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
-00030140: 2c20 6d73 673a 2064 6963 745b 7374 722c  , msg: dict[str,
-00030150: 2041 6e79 5d29 202d 3e20 4e6f 6e65 3a0a   Any]) -> None:.
-00030160: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
-00030170: 6d65 7373 6167 6520 746f 2077 6f72 6b65  message to worke
-00030180: 720a 0a20 2020 2020 2020 2054 6869 7320  r..        This 
-00030190: 616c 736f 2068 616e 646c 6573 2063 6f6e  also handles con
-000301a0: 6e65 6374 696f 6e20 6661 696c 7572 6573  nection failures
-000301b0: 2062 7920 6164 6469 6e67 2061 2063 616c   by adding a cal
-000301c0: 6c62 6163 6b20 746f 2072 656d 6f76 650a  lback to remove.
-000301d0: 2020 2020 2020 2020 7468 6520 776f 726b          the work
-000301e0: 6572 206f 6e20 7468 6520 6e65 7874 2063  er on the next c
-000301f0: 7963 6c65 2e0a 2020 2020 2020 2020 2222  ycle..        ""
-00030200: 220a 2020 2020 2020 2020 7374 7265 616d  ".        stream
-00030210: 5f63 6f6d 6d73 3a20 6469 6374 203d 2073  _comms: dict = s
-00030220: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
-00030230: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00030240: 2020 2020 2020 2020 2020 7374 7265 616d            stream
-00030250: 5f63 6f6d 6d73 5b77 6f72 6b65 725d 2e73  _comms[worker].s
-00030260: 656e 6428 6d73 6729 0a20 2020 2020 2020  end(msg).       
-00030270: 2065 7863 6570 7420 2843 6f6d 6d43 6c6f   except (CommClo
-00030280: 7365 6445 7272 6f72 2c20 4174 7472 6962  sedError, Attrib
-00030290: 7574 6545 7272 6f72 293a 0a20 2020 2020  uteError):.     
-000302a0: 2020 2020 2020 2073 656c 662e 5f6f 6e67         self._ong
-000302b0: 6f69 6e67 5f62 6163 6b67 726f 756e 645f  oing_background_
-000302c0: 7461 736b 732e 6361 6c6c 5f73 6f6f 6e28  tasks.call_soon(
-000302d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000302e0: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
-000302f0: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-00030300: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
-00030310: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-00030320: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00030330: 3d66 2277 6f72 6b65 722d 7365 6e64 2d63  =f"worker-send-c
-00030340: 6f6d 6d2d 6661 696c 2d7b 7469 6d65 2829  omm-fail-{time()
-00030350: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-00030360: 290a 0a20 2020 2064 6566 2063 6c69 656e  )..    def clien
-00030370: 745f 7365 6e64 2873 656c 662c 2063 6c69  t_send(self, cli
-00030380: 656e 742c 206d 7367 293a 0a20 2020 2020  ent, msg):.     
-00030390: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
-000303a0: 6765 2074 6f20 636c 6965 6e74 2222 220a  ge to client""".
-000303b0: 2020 2020 2020 2020 636c 6965 6e74 5f63          client_c
-000303c0: 6f6d 6d73 3a20 6469 6374 203d 2073 656c  omms: dict = sel
-000303d0: 662e 636c 6965 6e74 5f63 6f6d 6d73 0a20  f.client_comms. 
-000303e0: 2020 2020 2020 2063 203d 2063 6c69 656e         c = clien
-000303f0: 745f 636f 6d6d 732e 6765 7428 636c 6965  t_comms.get(clie
-00030400: 6e74 290a 2020 2020 2020 2020 6966 2063  nt).        if c
-00030410: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00030420: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00030430: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00030440: 2020 2020 2020 632e 7365 6e64 286d 7367        c.send(msg
-00030450: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00030460: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
-00030470: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00030480: 2073 656c 662e 7374 6174 7573 203d 3d20   self.status == 
-00030490: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
-000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304b0: 6c6f 6767 6572 2e63 7269 7469 6361 6c28  logger.critical(
-000304c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000304d0: 2020 2020 2022 436c 6f73 6564 2063 6f6d       "Closed com
-000304e0: 6d20 2572 2077 6869 6c65 2074 7279 696e  m %r while tryin
-000304f0: 6720 746f 2077 7269 7465 2025 7322 2c20  g to write %s", 
-00030500: 632c 206d 7367 2c20 6578 635f 696e 666f  c, msg, exc_info
-00030510: 3d54 7275 650a 2020 2020 2020 2020 2020  =True.          
-00030520: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00030530: 2073 656e 645f 616c 6c28 7365 6c66 2c20   send_all(self, 
-00030540: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
-00030550: 732c 2077 6f72 6b65 725f 6d73 6773 3a20  s, worker_msgs: 
-00030560: 4d73 6773 2920 2d3e 204e 6f6e 653a 0a20  Msgs) -> None:. 
-00030570: 2020 2020 2020 2022 2222 5365 6e64 206d         """Send m
-00030580: 6573 7361 6765 7320 746f 2063 6c69 656e  essages to clien
-00030590: 7420 616e 6420 776f 726b 6572 7322 2222  t and workers"""
-000305a0: 0a0a 2020 2020 2020 2020 666f 7220 636c  ..        for cl
-000305b0: 6965 6e74 2c20 6d73 6773 2069 6e20 636c  ient, msgs in cl
-000305c0: 6965 6e74 5f6d 7367 732e 6974 656d 7328  ient_msgs.items(
-000305d0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-000305e0: 203d 2073 656c 662e 636c 6965 6e74 5f63   = self.client_c
-000305f0: 6f6d 6d73 2e67 6574 2863 6c69 656e 7429  omms.get(client)
-00030600: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00030610: 6320 6973 204e 6f6e 653a 0a20 2020 2020  c is None:.     
-00030620: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00030630: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-00030640: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00030650: 2020 2020 2063 2e73 656e 6428 2a6d 7367       c.send(*msg
-00030660: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
-00030670: 7863 6570 7420 436f 6d6d 436c 6f73 6564  xcept CommClosed
-00030680: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00030690: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-000306a0: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-000306b0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-000306c0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-000306d0: 6765 722e 6372 6974 6963 616c 280a 2020  ger.critical(.  
-000306e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000306f0: 2020 2020 2020 2243 6c6f 7365 6420 636f        "Closed co
-00030700: 6d6d 2025 7220 7768 696c 6520 7472 7969  mm %r while tryi
-00030710: 6e67 2074 6f20 7772 6974 6520 2573 222c  ng to write %s",
-00030720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030730: 2020 2020 2020 2020 2063 2c0a 2020 2020           c,.    
-00030740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030750: 2020 2020 6d73 6773 2c0a 2020 2020 2020      msgs,.      
-00030760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030770: 2020 6578 635f 696e 666f 3d54 7275 652c    exc_info=True,
-00030780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030790: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000307a0: 666f 7220 776f 726b 6572 2c20 6d73 6773  for worker, msgs
-000307b0: 2069 6e20 776f 726b 6572 5f6d 7367 732e   in worker_msgs.
-000307c0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-000307d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000307e0: 2020 2020 2020 2020 2020 7720 3d20 7365            w = se
-000307f0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-00030800: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-00030810: 2020 2020 2020 2020 772e 7365 6e64 282a          w.send(*
-00030820: 6d73 6773 290a 2020 2020 2020 2020 2020  msgs).          
-00030830: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-00030840: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00030850: 2020 2023 2077 6f72 6b65 7220 616c 7265     # worker alre
-00030860: 6164 7920 676f 6e65 0a20 2020 2020 2020  ady gone.       
-00030870: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-00030880: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00030890: 2028 436f 6d6d 436c 6f73 6564 4572 726f   (CommClosedErro
-000308a0: 722c 2041 7474 7269 6275 7465 4572 726f  r, AttributeErro
-000308b0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-000308c0: 2020 2020 7365 6c66 2e5f 6f6e 676f 696e      self._ongoin
-000308d0: 675f 6261 636b 6772 6f75 6e64 5f74 6173  g_background_tas
-000308e0: 6b73 2e63 616c 6c5f 736f 6f6e 280a 2020  ks.call_soon(.  
-000308f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030900: 2020 7365 6c66 2e72 656d 6f76 655f 776f    self.remove_wo
-00030910: 726b 6572 2c0a 2020 2020 2020 2020 2020  rker,.          
-00030920: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-00030930: 733d 776f 726b 6572 2c0a 2020 2020 2020  s=worker,.      
-00030940: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00030950: 696d 756c 7573 5f69 643d 6622 7365 6e64  imulus_id=f"send
-00030960: 2d61 6c6c 2d63 6f6d 6d2d 6661 696c 2d7b  -all-comm-fail-{
-00030970: 7469 6d65 2829 7d22 2c0a 2020 2020 2020  time()}",.      
-00030980: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00030990: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-000309a0: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-000309b0: 2020 2320 4c65 7373 2063 6f6d 6d6f 6e20    # Less common 
-000309c0: 696e 7465 7261 6374 696f 6e73 2023 0a20  interactions #. 
-000309d0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-000309e0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-000309f0: 0a20 2020 2061 7379 6e63 2064 6566 2073  .    async def s
-00030a00: 6361 7474 6572 280a 2020 2020 2020 2020  catter(.        
-00030a10: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
-00030a20: 6d6d 3d4e 6f6e 652c 0a20 2020 2020 2020  mm=None,.       
-00030a30: 2064 6174 613d 4e6f 6e65 2c0a 2020 2020   data=None,.    
-00030a40: 2020 2020 776f 726b 6572 733d 4e6f 6e65      workers=None
-00030a50: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
-00030a60: 3d4e 6f6e 652c 0a20 2020 2020 2020 2062  =None,.        b
-00030a70: 726f 6164 6361 7374 3d46 616c 7365 2c0a  roadcast=False,.
-00030a80: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00030a90: 322c 0a20 2020 2029 3a0a 2020 2020 2020  2,.    ):.      
-00030aa0: 2020 2222 2253 656e 6420 6461 7461 206f    """Send data o
-00030ab0: 7574 2074 6f20 776f 726b 6572 730a 0a20  ut to workers.. 
-00030ac0: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
-00030ad0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00030ae0: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
-00030af0: 6572 2e62 726f 6164 6361 7374 3a0a 2020  er.broadcast:.  
-00030b00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00030b10: 2020 7374 6172 7420 3d20 7469 6d65 2829    start = time()
-00030b20: 0a20 2020 2020 2020 2077 6869 6c65 2054  .        while T
-00030b30: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-00030b40: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
-00030b50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00030b60: 2020 2020 2077 7373 203d 2073 656c 662e       wss = self.
-00030b70: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-00030b80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00030b90: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00030ba0: 7320 3d20 5b73 656c 662e 636f 6572 6365  s = [self.coerce
-00030bb0: 5f61 6464 7265 7373 2877 2920 666f 7220  _address(w) for 
-00030bc0: 7720 696e 2077 6f72 6b65 7273 5d0a 2020  w in workers].  
-00030bd0: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-00030be0: 7320 3d20 7b73 656c 662e 776f 726b 6572  s = {self.worker
-00030bf0: 735b 775d 2066 6f72 2077 2069 6e20 776f  s[w] for w in wo
-00030c00: 726b 6572 737d 0a20 2020 2020 2020 2020  rkers}.         
-00030c10: 2020 2020 2020 2077 7373 203d 207b 7773         wss = {ws
-00030c20: 2066 6f72 2077 7320 696e 2077 7373 2069   for ws in wss i
-00030c30: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-00030c40: 7461 7475 732e 7275 6e6e 696e 677d 0a0a  tatus.running}..
-00030c50: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-00030c60: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
-00030c70: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00030c80: 2020 2020 2020 6966 2074 696d 6528 2920        if time() 
-00030c90: 3e20 7374 6172 7420 2b20 7469 6d65 6f75  > start + timeou
-00030ca0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00030cb0: 2020 2072 6169 7365 2054 696d 656f 7574     raise Timeout
-00030cc0: 4572 726f 7228 224e 6f20 7661 6c69 6420  Error("No valid 
-00030cd0: 776f 726b 6572 7320 666f 756e 6422 290a  workers found").
-00030ce0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00030cf0: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
-00030d00: 302e 3129 0a0a 2020 2020 2020 2020 6e74  0.1)..        nt
-00030d10: 6872 6561 6473 203d 207b 7773 2e61 6464  hreads = {ws.add
-00030d20: 7265 7373 3a20 7773 2e6e 7468 7265 6164  ress: ws.nthread
-00030d30: 7320 666f 7220 7773 2069 6e20 7773 737d  s for ws in wss}
-00030d40: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
-00030d50: 2069 7369 6e73 7461 6e63 6528 6461 7461   isinstance(data
-00030d60: 2c20 6469 6374 290a 0a20 2020 2020 2020  , dict)..       
-00030d70: 206b 6579 732c 2077 686f 5f68 6173 2c20   keys, who_has, 
-00030d80: 6e62 7974 6573 203d 2061 7761 6974 2073  nbytes = await s
-00030d90: 6361 7474 6572 5f74 6f5f 776f 726b 6572  catter_to_worker
-00030da0: 7328 6e74 6872 6561 6473 2c20 6461 7461  s(nthreads, data
-00030db0: 2c20 7270 633d 7365 6c66 2e72 7063 290a  , rpc=self.rpc).
-00030dc0: 0a20 2020 2020 2020 2073 656c 662e 7570  .        self.up
-00030dd0: 6461 7465 5f64 6174 6128 7768 6f5f 6861  date_data(who_ha
-00030de0: 733d 7768 6f5f 6861 732c 206e 6279 7465  s=who_has, nbyte
-00030df0: 733d 6e62 7974 6573 2c20 636c 6965 6e74  s=nbytes, client
-00030e00: 3d63 6c69 656e 7429 0a0a 2020 2020 2020  =client)..      
-00030e10: 2020 6966 2062 726f 6164 6361 7374 3a0a    if broadcast:.
-00030e20: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
-00030e30: 6c65 6e28 6e74 6872 6561 6473 2920 6966  len(nthreads) if
-00030e40: 2062 726f 6164 6361 7374 2069 7320 5472   broadcast is Tr
-00030e50: 7565 2065 6c73 6520 6272 6f61 6463 6173  ue else broadcas
-00030e60: 740a 2020 2020 2020 2020 2020 2020 6177  t.            aw
-00030e70: 6169 7420 7365 6c66 2e72 6570 6c69 6361  ait self.replica
-00030e80: 7465 286b 6579 733d 6b65 7973 2c20 776f  te(keys=keys, wo
-00030e90: 726b 6572 733d 776f 726b 6572 732c 206e  rkers=workers, n
-00030ea0: 3d6e 290a 0a20 2020 2020 2020 2073 656c  =n)..        sel
-00030eb0: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
-00030ec0: 2020 2020 2020 2020 205b 636c 6965 6e74           [client
-00030ed0: 2c20 2261 6c6c 225d 2c20 7b22 6163 7469  , "all"], {"acti
-00030ee0: 6f6e 223a 2022 7363 6174 7465 7222 2c20  on": "scatter", 
-00030ef0: 2263 6c69 656e 7422 3a20 636c 6965 6e74  "client": client
-00030f00: 2c20 2263 6f75 6e74 223a 206c 656e 2864  , "count": len(d
-00030f10: 6174 6129 7d0a 2020 2020 2020 2020 290a  ata)}.        ).
-00030f20: 2020 2020 2020 2020 7265 7475 726e 206b          return k
-00030f30: 6579 730a 0a20 2020 2061 7379 6e63 2064  eys..    async d
-00030f40: 6566 2067 6174 6865 7228 7365 6c66 2c20  ef gather(self, 
-00030f50: 6b65 7973 2c20 7365 7269 616c 697a 6572  keys, serializer
-00030f60: 733d 4e6f 6e65 293a 0a20 2020 2020 2020  s=None):.       
-00030f70: 2022 2222 436f 6c6c 6563 7420 6461 7461   """Collect data
-00030f80: 2066 726f 6d20 776f 726b 6572 7320 746f   from workers to
-00030f90: 2074 6865 2073 6368 6564 756c 6572 2222   the scheduler""
-00030fa0: 220a 2020 2020 2020 2020 7374 696d 756c  ".        stimul
-00030fb0: 7573 5f69 6420 3d20 6622 6761 7468 6572  us_id = f"gather
-00030fc0: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
-00030fd0: 2020 206b 6579 7320 3d20 6c69 7374 286b     keys = list(k
-00030fe0: 6579 7329 0a20 2020 2020 2020 2077 686f  eys).        who
-00030ff0: 5f68 6173 203d 207b 7d0a 2020 2020 2020  _has = {}.      
-00031000: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-00031010: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-00031020: 733a 2054 6173 6b53 7461 7465 203d 2073  s: TaskState = s
-00031030: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-00031040: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-00031050: 6620 7473 2069 7320 6e6f 7420 4e6f 6e65  f ts is not None
-00031060: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031070: 2020 7768 6f5f 6861 735b 6b65 795d 203d    who_has[key] =
-00031080: 205b 7773 2e61 6464 7265 7373 2066 6f72   [ws.address for
-00031090: 2077 7320 696e 2074 732e 7768 6f5f 6861   ws in ts.who_ha
-000310a0: 735d 0a20 2020 2020 2020 2020 2020 2065  s].            e
-000310b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000310c0: 2020 2020 2077 686f 5f68 6173 5b6b 6579       who_has[key
-000310d0: 5d20 3d20 5b5d 0a0a 2020 2020 2020 2020  ] = []..        
-000310e0: 6461 7461 2c20 6d69 7373 696e 675f 6b65  data, missing_ke
-000310f0: 7973 2c20 6d69 7373 696e 675f 776f 726b  ys, missing_work
-00031100: 6572 7320 3d20 6177 6169 7420 6761 7468  ers = await gath
-00031110: 6572 5f66 726f 6d5f 776f 726b 6572 7328  er_from_workers(
-00031120: 0a20 2020 2020 2020 2020 2020 2077 686f  .            who
-00031130: 5f68 6173 2c20 7270 633d 7365 6c66 2e72  _has, rpc=self.r
-00031140: 7063 2c20 636c 6f73 653d 4661 6c73 652c  pc, close=False,
-00031150: 2073 6572 6961 6c69 7a65 7273 3d73 6572   serializers=ser
-00031160: 6961 6c69 7a65 7273 0a20 2020 2020 2020  ializers.       
-00031170: 2029 0a20 2020 2020 2020 2069 6620 6e6f   ).        if no
-00031180: 7420 6d69 7373 696e 675f 6b65 7973 3a0a  t missing_keys:.
-00031190: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-000311a0: 6c74 203d 207b 2273 7461 7475 7322 3a20  lt = {"status": 
-000311b0: 224f 4b22 2c20 2264 6174 6122 3a20 6461  "OK", "data": da
-000311c0: 7461 7d0a 2020 2020 2020 2020 656c 7365  ta}.        else
-000311d0: 3a0a 2020 2020 2020 2020 2020 2020 6d69  :.            mi
-000311e0: 7373 696e 675f 7374 6174 6573 203d 205b  ssing_states = [
-000311f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031200: 2028 7365 6c66 2e74 6173 6b73 5b6b 6579   (self.tasks[key
-00031210: 5d2e 7374 6174 6520 6966 206b 6579 2069  ].state if key i
-00031220: 6e20 7365 6c66 2e74 6173 6b73 2065 6c73  n self.tasks els
-00031230: 6520 4e6f 6e65 290a 2020 2020 2020 2020  e None).        
-00031240: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00031250: 696e 206d 6973 7369 6e67 5f6b 6579 730a  in missing_keys.
-00031260: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00031270: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00031280: 2e65 7863 6570 7469 6f6e 280a 2020 2020  .exception(.    
-00031290: 2020 2020 2020 2020 2020 2020 2243 6f75              "Cou
-000312a0: 6c64 6e27 7420 6761 7468 6572 206b 6579  ldn't gather key
-000312b0: 7320 2573 2073 7461 7465 3a20 2573 2077  s %s state: %s w
-000312c0: 6f72 6b65 7273 3a20 2573 222c 0a20 2020  orkers: %s",.   
-000312d0: 2020 2020 2020 2020 2020 2020 206d 6973               mis
-000312e0: 7369 6e67 5f6b 6579 732c 0a20 2020 2020  sing_keys,.     
-000312f0: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-00031300: 6e67 5f73 7461 7465 732c 0a20 2020 2020  ng_states,.     
-00031310: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-00031320: 6e67 5f77 6f72 6b65 7273 2c0a 2020 2020  ng_workers,.    
-00031330: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00031340: 2020 2020 2020 7265 7375 6c74 203d 207b        result = {
-00031350: 2273 7461 7475 7322 3a20 2265 7272 6f72  "status": "error
-00031360: 222c 2022 6b65 7973 223a 206d 6973 7369  ", "keys": missi
-00031370: 6e67 5f6b 6579 737d 0a20 2020 2020 2020  ng_keys}.       
-00031380: 2020 2020 2077 6974 6820 6c6f 675f 6572       with log_er
-00031390: 726f 7273 2829 3a0a 2020 2020 2020 2020  rors():.        
-000313a0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-000313b0: 2073 7573 7069 6369 6f75 7320 776f 726b   suspicious work
-000313c0: 6572 7320 6672 6f6d 2074 6865 2073 6368  ers from the sch
-000313d0: 6564 756c 6572 2061 6e64 2073 6875 7420  eduler and shut 
-000313e0: 7468 656d 2064 6f77 6e2e 0a20 2020 2020  them down..     
-000313f0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00031400: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00031410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031420: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
-00031430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031440: 7365 6c66 2e72 656d 6f76 655f 776f 726b  self.remove_work
-00031450: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-00031460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031470: 6164 6472 6573 733d 776f 726b 6572 2c20  address=worker, 
-00031480: 636c 6f73 653d 5472 7565 2c20 7374 696d  close=True, stim
-00031490: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-000314a0: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-000314b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000314c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314d0: 2020 2020 2020 666f 7220 776f 726b 6572        for worker
-000314e0: 2069 6e20 6d69 7373 696e 675f 776f 726b   in missing_work
-000314f0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-00031500: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00031510: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00031520: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00031530: 6b65 792c 2077 6f72 6b65 7273 2069 6e20  key, workers in 
-00031540: 6d69 7373 696e 675f 6b65 7973 2e69 7465  missing_keys.ite
-00031550: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00031560: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00031570: 2e65 7863 6570 7469 6f6e 280a 2020 2020  .exception(.    
-00031580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031590: 2020 2020 2253 6875 7420 646f 776e 2077      "Shut down w
-000315a0: 6f72 6b65 7273 2074 6861 7420 646f 6e27  orkers that don'
-000315b0: 7420 6861 7665 2070 726f 6d69 7365 6420  t have promised 
-000315c0: 6b65 793a 2025 732c 2025 7322 2c0a 2020  key: %s, %s",.  
-000315d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315e0: 2020 2020 2020 7374 7228 776f 726b 6572        str(worker
-000315f0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00031600: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00031610: 6b65 7929 2c0a 2020 2020 2020 2020 2020  key),.          
-00031620: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00031630: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-00031640: 656e 7428 2261 6c6c 222c 207b 2261 6374  ent("all", {"act
-00031650: 696f 6e22 3a20 2267 6174 6865 7222 2c20  ion": "gather", 
-00031660: 2263 6f75 6e74 223a 206c 656e 286b 6579  "count": len(key
-00031670: 7329 7d29 0a20 2020 2020 2020 2072 6574  s)}).        ret
-00031680: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
-00031690: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-000316a0: 6173 796e 6320 6465 6620 7265 7374 6172  async def restar
-000316b0: 7428 7365 6c66 2c20 636c 6965 6e74 3d4e  t(self, client=N
-000316c0: 6f6e 652c 2074 696d 656f 7574 3d33 302c  one, timeout=30,
-000316d0: 2077 6169 745f 666f 725f 776f 726b 6572   wait_for_worker
-000316e0: 733d 5472 7565 293a 0a20 2020 2020 2020  s=True):.       
-000316f0: 2022 2222 0a20 2020 2020 2020 2052 6573   """.        Res
-00031700: 7461 7274 2061 6c6c 2077 6f72 6b65 7273  tart all workers
-00031710: 2e20 5265 7365 7420 6c6f 6361 6c20 7374  . Reset local st
-00031720: 6174 652e 204f 7074 696f 6e61 6c6c 7920  ate. Optionally 
-00031730: 7761 6974 2066 6f72 2077 6f72 6b65 7273  wait for workers
-00031740: 2074 6f20 7265 7475 726e 2e0a 0a20 2020   to return...   
-00031750: 2020 2020 2057 6f72 6b65 7273 2077 6974       Workers wit
-00031760: 686f 7574 206e 616e 6e69 6573 2061 7265  hout nannies are
-00031770: 2073 6875 7420 646f 776e 2c20 686f 7069   shut down, hopi
-00031780: 6e67 2061 6e20 6578 7465 726e 616c 2064  ng an external d
-00031790: 6570 6c6f 796d 656e 7420 7379 7374 656d  eployment system
-000317a0: 0a20 2020 2020 2020 2077 696c 6c20 7265  .        will re
-000317b0: 7374 6172 7420 7468 656d 2e20 5468 6572  start them. Ther
-000317c0: 6566 6f72 652c 2069 6620 6e6f 7420 7573  efore, if not us
-000317d0: 696e 6720 6e61 6e6e 6965 7320 616e 6420  ing nannies and 
-000317e0: 796f 7572 2064 6570 6c6f 796d 656e 7420  your deployment 
-000317f0: 7379 7374 656d 0a20 2020 2020 2020 2064  system.        d
-00031800: 6f65 7320 6e6f 7420 6175 746f 6d61 7469  oes not automati
-00031810: 6361 6c6c 7920 7265 7374 6172 7420 776f  cally restart wo
-00031820: 726b 6572 732c 2060 6072 6573 7461 7274  rkers, ``restart
-00031830: 6060 2077 696c 6c20 6a75 7374 2073 6875  `` will just shu
-00031840: 7420 646f 776e 2061 6c6c 0a20 2020 2020  t down all.     
-00031850: 2020 2077 6f72 6b65 7273 2c20 7468 656e     workers, then
-00031860: 2074 696d 6520 6f75 7421 0a0a 2020 2020   time out!..    
-00031870: 2020 2020 4166 7465 7220 6060 7265 7374      After ``rest
-00031880: 6172 7460 602c 2061 6c6c 2063 6f6e 6e65  art``, all conne
-00031890: 6374 6564 2077 6f72 6b65 7273 2061 7265  cted workers are
-000318a0: 206e 6577 2c20 7265 6761 7264 6c65 7373   new, regardless
-000318b0: 206f 6620 7768 6574 6865 7220 6060 5469   of whether ``Ti
-000318c0: 6d65 6f75 7445 7272 6f72 6060 0a20 2020  meoutError``.   
-000318d0: 2020 2020 2077 6173 2072 6169 7365 642e       was raised.
-000318e0: 2041 6e79 2077 6f72 6b65 7273 2074 6861   Any workers tha
-000318f0: 7420 6661 696c 6564 2074 6f20 7368 7574  t failed to shut
-00031900: 2064 6f77 6e20 696e 2074 696d 6520 6172   down in time ar
-00031910: 6520 7265 6d6f 7665 642c 2061 6e64 0a20  e removed, and. 
-00031920: 2020 2020 2020 206d 6179 206f 7220 6d61         may or ma
-00031930: 7920 6e6f 7420 7368 7574 2064 6f77 6e20  y not shut down 
-00031940: 6f6e 2074 6865 6972 206f 776e 2069 6e20  on their own in 
-00031950: 7468 6520 6675 7475 7265 2e0a 0a20 2020  the future...   
-00031960: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
-00031970: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00031980: 2d2d 0a20 2020 2020 2020 2074 696d 656f  --.        timeo
-00031990: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
-000319a0: 486f 7720 6c6f 6e67 2074 6f20 7761 6974  How long to wait
-000319b0: 2066 6f72 2077 6f72 6b65 7273 2074 6f20   for workers to 
-000319c0: 7368 7574 2064 6f77 6e20 616e 6420 636f  shut down and co
-000319d0: 6d65 2062 6163 6b2c 2069 6620 6060 7761  me back, if ``wa
-000319e0: 6974 5f66 6f72 5f77 6f72 6b65 7273 6060  it_for_workers``
-000319f0: 0a20 2020 2020 2020 2020 2020 2069 7320  .            is 
-00031a00: 5472 7565 2c20 6f74 6865 7277 6973 6520  True, otherwise 
-00031a10: 6a75 7374 2068 6f77 206c 6f6e 6720 746f  just how long to
-00031a20: 2077 6169 7420 666f 7220 776f 726b 6572   wait for worker
-00031a30: 7320 746f 2073 6875 7420 646f 776e 2e0a  s to shut down..
-00031a40: 2020 2020 2020 2020 2020 2020 5261 6973              Rais
-00031a50: 6573 2060 6061 7379 6e63 696f 2e54 696d  es ``asyncio.Tim
-00031a60: 656f 7574 4572 726f 7260 6020 6966 2074  eoutError`` if t
-00031a70: 6869 7320 6973 2065 7863 6565 6465 642e  his is exceeded.
-00031a80: 0a20 2020 2020 2020 2077 6169 745f 666f  .        wait_fo
-00031a90: 725f 776f 726b 6572 733a 0a20 2020 2020  r_workers:.     
-00031aa0: 2020 2020 2020 2057 6865 7468 6572 2074         Whether t
-00031ab0: 6f20 7761 6974 2066 6f72 2061 6c6c 2077  o wait for all w
-00031ac0: 6f72 6b65 7273 2074 6f20 7265 636f 6e6e  orkers to reconn
-00031ad0: 6563 742c 206f 7220 6a75 7374 2066 6f72  ect, or just for
-00031ae0: 2074 6865 6d20 746f 2073 6875 7420 646f   them to shut do
-00031af0: 776e 0a20 2020 2020 2020 2020 2020 2028  wn.            (
-00031b00: 6465 6661 756c 7420 5472 7565 292e 2055  default True). U
-00031b10: 7365 2060 6072 6573 7461 7274 2877 6169  se ``restart(wai
-00031b20: 745f 666f 725f 776f 726b 6572 733d 4661  t_for_workers=Fa
-00031b30: 6c73 6529 6060 2063 6f6d 6269 6e65 6420  lse)`` combined 
-00031b40: 7769 7468 0a20 2020 2020 2020 2020 2020  with.           
-00031b50: 203a 6d65 7468 3a60 436c 6965 6e74 2e77   :meth:`Client.w
-00031b60: 6169 745f 666f 725f 776f 726b 6572 7360  ait_for_workers`
-00031b70: 2066 6f72 2067 7261 6e75 6c61 7220 636f   for granular co
-00031b80: 6e74 726f 6c20 6f76 6572 2068 6f77 206d  ntrol over how m
-00031b90: 616e 7920 776f 726b 6572 7320 746f 0a20  any workers to. 
-00031ba0: 2020 2020 2020 2020 2020 2077 6169 7420             wait 
-00031bb0: 666f 722e 0a0a 2020 2020 2020 2020 5365  for...        Se
-00031bc0: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
-00031bd0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00031be0: 436c 6965 6e74 2e72 6573 7461 7274 0a20  Client.restart. 
-00031bf0: 2020 2020 2020 2043 6c69 656e 742e 7265         Client.re
-00031c00: 7374 6172 745f 776f 726b 6572 730a 2020  start_workers.  
-00031c10: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00031c20: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-00031c30: 6622 7265 7374 6172 742d 7b74 696d 6528  f"restart-{time(
-00031c40: 297d 220a 0a20 2020 2020 2020 206c 6f67  )}"..        log
-00031c50: 6765 722e 696e 666f 2822 5265 7374 6172  ger.info("Restar
-00031c60: 7469 6e67 2077 6f72 6b65 7273 2061 6e64  ting workers and
-00031c70: 2072 656c 6561 7369 6e67 2061 6c6c 206b   releasing all k
-00031c80: 6579 732e 2229 0a20 2020 2020 2020 2066  eys.").        f
-00031c90: 6f72 2063 7320 696e 2073 656c 662e 636c  or cs in self.cl
-00031ca0: 6965 6e74 732e 7661 6c75 6573 2829 3a0a  ients.values():.
-00031cb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00031cc0: 2e63 6c69 656e 745f 7265 6c65 6173 6573  .client_releases
-00031cd0: 5f6b 6579 7328 0a20 2020 2020 2020 2020  _keys(.         
-00031ce0: 2020 2020 2020 206b 6579 733d 5b74 732e         keys=[ts.
-00031cf0: 6b65 7920 666f 7220 7473 2069 6e20 6373  key for ts in cs
-00031d00: 2e77 616e 7473 5f77 6861 745d 2c0a 2020  .wants_what],.  
-00031d10: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00031d20: 6965 6e74 3d63 732e 636c 6965 6e74 5f6b  ient=cs.client_k
-00031d30: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-00031d40: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
-00031d50: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
-00031d60: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00031d70: 2020 2020 7365 6c66 2e5f 636c 6561 725f      self._clear_
-00031d80: 7461 736b 5f73 7461 7465 2829 0a20 2020  task_state().   
-00031d90: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00031da0: 7365 6c66 2e74 6173 6b73 0a20 2020 2020  self.tasks.     
-00031db0: 2020 2073 656c 662e 7265 706f 7274 287b     self.report({
-00031dc0: 226f 7022 3a20 2272 6573 7461 7274 227d  "op": "restart"}
-00031dd0: 290a 0a20 2020 2020 2020 2066 6f72 2070  )..        for p
-00031de0: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
-00031df0: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
-00031e00: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-00031e10: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00031e20: 2020 2020 2020 2070 6c75 6769 6e2e 7265         plugin.re
-00031e30: 7374 6172 7428 7365 6c66 290a 2020 2020  start(self).    
-00031e40: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00031e50: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-00031e60: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00031e70: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-00031e80: 6529 0a0a 2020 2020 2020 2020 6e5f 776f  e)..        n_wo
-00031e90: 726b 6572 7320 3d20 6c65 6e28 7365 6c66  rkers = len(self
-00031ea0: 2e77 6f72 6b65 7273 290a 2020 2020 2020  .workers).      
-00031eb0: 2020 6e61 6e6e 795f 776f 726b 6572 7320    nanny_workers 
-00031ec0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00031ed0: 6164 6472 3a20 7773 2e6e 616e 6e79 2066  addr: ws.nanny f
-00031ee0: 6f72 2061 6464 722c 2077 7320 696e 2073  or addr, ws in s
-00031ef0: 656c 662e 776f 726b 6572 732e 6974 656d  elf.workers.item
-00031f00: 7328 2920 6966 2077 732e 6e61 6e6e 790a  s() if ws.nanny.
-00031f10: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00031f20: 2020 2320 436c 6f73 6520 6e6f 6e2d 4e61    # Close non-Na
-00031f30: 6e6e 7920 776f 726b 6572 732e 2057 6520  nny workers. We 
-00031f40: 6861 7665 206e 6f20 7761 7920 746f 2072  have no way to r
-00031f50: 6573 7461 7274 2074 6865 6d2c 2073 6f20  estart them, so 
-00031f60: 7765 206a 7573 7420 6c65 7420 7468 656d  we just let them
-00031f70: 2067 6f2c 0a20 2020 2020 2020 2023 2061   go,.        # a
-00031f80: 6e64 2061 7373 756d 6520 6120 6465 706c  nd assume a depl
-00031f90: 6f79 6d65 6e74 2073 7973 7465 6d20 6973  oyment system is
-00031fa0: 2067 6f69 6e67 2074 6f20 7265 7374 6172   going to restar
-00031fb0: 7420 7468 656d 2066 6f72 2075 732e 0a20  t them for us.. 
-00031fc0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-00031fd0: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-00031fe0: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
-00031ff0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00032000: 2e72 656d 6f76 655f 776f 726b 6572 2861  .remove_worker(a
-00032010: 6464 7265 7373 3d61 6464 722c 2073 7469  ddress=addr, sti
-00032020: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-00032030: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
-00032040: 2020 2020 2020 666f 7220 6164 6472 2069        for addr i
-00032050: 6e20 7365 6c66 2e77 6f72 6b65 7273 0a20  n self.workers. 
-00032060: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00032070: 6620 6164 6472 206e 6f74 2069 6e20 6e61  f addr not in na
-00032080: 6e6e 795f 776f 726b 6572 730a 2020 2020  nny_workers.    
-00032090: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000320a0: 2020 290a 0a20 2020 2020 2020 206c 6f67    )..        log
-000320b0: 6765 722e 6465 6275 6728 2253 656e 6420  ger.debug("Send 
-000320c0: 6b69 6c6c 2073 6967 6e61 6c20 746f 206e  kill signal to n
-000320d0: 616e 6e69 6573 3a20 2573 222c 206e 616e  annies: %s", nan
-000320e0: 6e79 5f77 6f72 6b65 7273 290a 2020 2020  ny_workers).    
-000320f0: 2020 2020 6173 796e 6320 7769 7468 2063      async with c
-00032100: 6f6e 7465 7874 6c69 622e 4173 796e 6345  ontextlib.AsyncE
-00032110: 7869 7453 7461 636b 2829 2061 7320 7374  xitStack() as st
-00032120: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
-00032130: 206e 616e 6e69 6573 203d 2061 7761 6974   nannies = await
-00032140: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00032150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032160: 202a 280a 2020 2020 2020 2020 2020 2020   *(.            
-00032170: 2020 2020 2020 2020 7374 6163 6b2e 656e          stack.en
-00032180: 7465 725f 6173 796e 635f 636f 6e74 6578  ter_async_contex
-00032190: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-000321a0: 2020 2020 2020 2020 2020 2072 7063 286e             rpc(n
-000321b0: 616e 6e79 5f61 6464 7265 7373 2c20 636f  anny_address, co
-000321c0: 6e6e 6563 7469 6f6e 5f61 7267 733d 7365  nnection_args=se
-000321d0: 6c66 2e63 6f6e 6e65 6374 696f 6e5f 6172  lf.connection_ar
-000321e0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-000321f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00032200: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00032210: 7220 6e61 6e6e 795f 6164 6472 6573 7320  r nanny_address 
-00032220: 696e 206e 616e 6e79 5f77 6f72 6b65 7273  in nanny_workers
-00032230: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
-00032240: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00032250: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00032260: 2020 2020 2020 2073 7461 7274 203d 206d         start = m
-00032270: 6f6e 6f74 6f6e 6963 2829 0a20 2020 2020  onotonic().     
-00032280: 2020 2020 2020 2072 6573 7073 203d 2061         resps = a
-00032290: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-000322a0: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-000322b0: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
-000322c0: 2020 2020 2020 2020 2020 2020 7761 6974              wait
-000322d0: 5f66 6f72 280a 2020 2020 2020 2020 2020  _for(.          
-000322e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000322f0: 4649 584d 4520 646f 6573 206e 6f74 2072  FIXME does not r
-00032300: 6169 7365 2069 6620 7468 6520 7072 6f63  aise if the proc
-00032310: 6573 7320 6661 696c 7320 746f 2073 6875  ess fails to shu
-00032320: 7420 646f 776e 2c0a 2020 2020 2020 2020  t down,.        
-00032330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032340: 2320 7365 6520 6874 7470 733a 2f2f 6769  # see https://gi
-00032350: 7468 7562 2e63 6f6d 2f64 6173 6b2f 6469  thub.com/dask/di
-00032360: 7374 7269 6275 7465 642f 7075 6c6c 2f36  stributed/pull/6
-00032370: 3432 372f 6669 6c65 7323 7238 3934 3931  427/files#r89491
-00032380: 3734 3234 0a20 2020 2020 2020 2020 2020  7424.           
-00032390: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-000323a0: 4f54 453a 204e 616e 6e79 2077 696c 6c20  OTE: Nanny will 
-000323b0: 6175 746f 6d61 7469 6361 6c6c 7920 7265  automatically re
-000323c0: 7374 6172 7420 776f 726b 6572 2070 726f  start worker pro
-000323d0: 6365 7373 2077 6865 6e20 6974 2773 206b  cess when it's k
-000323e0: 696c 6c65 640a 2020 2020 2020 2020 2020  illed.          
-000323f0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-00032400: 6e6e 792e 6b69 6c6c 280a 2020 2020 2020  nny.kill(.      
-00032410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032420: 2020 2020 2020 7265 6173 6f6e 3d22 7363        reason="sc
-00032430: 6865 6475 6c65 722d 7265 7374 6172 7422  heduler-restart"
-00032440: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032450: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-00032460: 6d65 6f75 743d 7469 6d65 6f75 742c 0a20  meout=timeout,. 
-00032470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032480: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00032490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000324a0: 2020 7469 6d65 6f75 742c 0a20 2020 2020    timeout,.     
-000324b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000324c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000324d0: 2020 2020 2066 6f72 206e 616e 6e79 2069       for nanny i
-000324e0: 6e20 6e61 6e6e 6965 730a 2020 2020 2020  n nannies.      
-000324f0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00032500: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00032510: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
-00032520: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00032530: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
-00032540: 204e 4f54 453a 2074 6865 2060 576f 726b   NOTE: the `Work
-00032550: 6572 5374 6174 6560 2065 6e74 7269 6573  erState` entries
-00032560: 2066 6f72 2074 6865 7365 2077 6f72 6b65   for these worke
-00032570: 7273 2077 696c 6c20 6265 2072 656d 6f76  rs will be remov
-00032580: 6564 0a20 2020 2020 2020 2020 2020 2023  ed.            #
-00032590: 206e 6174 7572 616c 6c79 2077 6865 6e20   naturally when 
-000325a0: 7468 6579 2064 6973 636f 6e6e 6563 7420  they disconnect 
-000325b0: 6672 6f6d 2074 6865 2073 6368 6564 756c  from the schedul
-000325c0: 6572 2e0a 0a20 2020 2020 2020 2020 2020  er...           
-000325d0: 2023 2052 656d 6f76 6520 616e 7920 776f   # Remove any wo
-000325e0: 726b 6572 7320 7468 6174 2066 6169 6c65  rkers that faile
-000325f0: 6420 746f 2073 6875 7420 646f 776e 2c20  d to shut down, 
-00032600: 736f 2077 6520 6361 6e20 6775 6172 616e  so we can guaran
-00032610: 7465 650a 2020 2020 2020 2020 2020 2020  tee.            
-00032620: 2320 7468 6174 2061 6674 6572 2060 7265  # that after `re
-00032630: 7374 6172 7460 2c20 7468 6572 6520 6172  start`, there ar
-00032640: 6520 6e6f 206f 6c64 2077 6f72 6b65 7273  e no old workers
-00032650: 2061 726f 756e 642e 0a20 2020 2020 2020   around..       
-00032660: 2020 2020 2062 6164 5f6e 616e 6e69 6573       bad_nannies
-00032670: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00032680: 2020 2020 2061 6464 7220 666f 7220 6164       addr for ad
-00032690: 6472 2c20 7265 7370 2069 6e20 7a69 7028  dr, resp in zip(
-000326a0: 6e61 6e6e 795f 776f 726b 6572 732c 2072  nanny_workers, r
-000326b0: 6573 7073 2920 6966 2072 6573 7020 6973  esps) if resp is
-000326c0: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
-000326d0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-000326e0: 2020 2020 6966 2062 6164 5f6e 616e 6e69      if bad_nanni
-000326f0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00032700: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-00032710: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-00032720: 2020 2020 2020 2020 2020 2020 2020 2a28                *(
-00032730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032740: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-00032750: 6d6f 7665 5f77 6f72 6b65 7228 6164 6472  move_worker(addr
-00032760: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
-00032770: 696d 756c 7573 5f69 6429 0a20 2020 2020  imulus_id).     
-00032780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032790: 2020 2066 6f72 2061 6464 7220 696e 2062     for addr in b
-000327a0: 6164 5f6e 616e 6e69 6573 0a20 2020 2020  ad_nannies.     
-000327b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000327c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000327d0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-000327e0: 2020 2020 7261 6973 6520 5469 6d65 6f75      raise Timeou
-000327f0: 7445 7272 6f72 280a 2020 2020 2020 2020  tError(.        
-00032800: 2020 2020 2020 2020 2020 2020 6622 7b6c              f"{l
-00032810: 656e 2862 6164 5f6e 616e 6e69 6573 297d  en(bad_nannies)}
-00032820: 2f7b 6c65 6e28 6e61 6e6e 6965 7329 7d20  /{len(nannies)} 
-00032830: 6e61 6e6e 7920 776f 726b 6572 2873 2920  nanny worker(s) 
-00032840: 6469 6420 6e6f 7420 7368 7574 2064 6f77  did not shut dow
-00032850: 6e20 7769 7468 696e 207b 7469 6d65 6f75  n within {timeou
-00032860: 747d 7322 0a20 2020 2020 2020 2020 2020  t}s".           
-00032870: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00032880: 7365 6c66 2e6c 6f67 5f65 7665 6e74 285b  self.log_event([
-00032890: 636c 6965 6e74 2c20 2261 6c6c 225d 2c20  client, "all"], 
-000328a0: 7b22 6163 7469 6f6e 223a 2022 7265 7374  {"action": "rest
-000328b0: 6172 7422 2c20 2263 6c69 656e 7422 3a20  art", "client": 
-000328c0: 636c 6965 6e74 7d29 0a0a 2020 2020 2020  client})..      
-000328d0: 2020 6966 2077 6169 745f 666f 725f 776f    if wait_for_wo
-000328e0: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
-000328f0: 2020 2077 6869 6c65 206c 656e 2873 656c     while len(sel
-00032900: 662e 776f 726b 6572 7329 203c 206e 5f77  f.workers) < n_w
-00032910: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00032920: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
-00032930: 6966 206e 6577 2028 756e 7265 6c61 7465  if new (unrelate
-00032940: 6429 2077 6f72 6b65 7273 206a 6f69 6e20  d) workers join 
-00032950: 7768 696c 6520 7765 2772 6520 7761 6974  while we're wait
-00032960: 696e 672c 2077 6520 6d61 7920 7265 7475  ing, we may retu
-00032970: 726e 2062 6566 6f72 650a 2020 2020 2020  rn before.      
-00032980: 2020 2020 2020 2020 2020 2320 6f75 7220            # our 
-00032990: 7368 7574 2d64 6f77 6e20 776f 726b 6572  shut-down worker
-000329a0: 7320 6861 7665 2063 6f6d 6520 6261 636b  s have come back
-000329b0: 2075 702e 2054 6861 7427 7320 6669 6e65   up. That's fine
-000329c0: 3b20 776f 726b 6572 7320 6172 6520 696e  ; workers are in
-000329d0: 7465 7263 6861 6e67 6561 626c 652e 0a20  terchangeable.. 
-000329e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000329f0: 6620 6d6f 6e6f 746f 6e69 6328 2920 3c20  f monotonic() < 
-00032a00: 7374 6172 7420 2b20 7469 6d65 6f75 743a  start + timeout:
-00032a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032a20: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-00032a30: 696f 2e73 6c65 6570 2830 2e32 290a 2020  io.sleep(0.2).  
-00032a40: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00032a50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00032a60: 2020 2020 2020 2020 6d73 6720 3d20 280a          msg = (.
-00032a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032a80: 2020 2020 2020 2020 6622 5761 6974 6564          f"Waited
-00032a90: 2066 6f72 207b 6e5f 776f 726b 6572 737d   for {n_workers}
-00032aa0: 2077 6f72 6b65 7228 7329 2074 6f20 7265   worker(s) to re
-00032ab0: 636f 6e6e 6563 7420 6166 7465 7220 7265  connect after re
-00032ac0: 7374 6172 7469 6e67 2c20 220a 2020 2020  starting, ".    
+0002d0a0: 2020 2066 756e 6320 3d20 6765 7461 7474     func = getatt
+0002d0b0: 7228 7365 6c66 2c20 2276 616c 6964 6174  r(self, "validat
+0002d0c0: 655f 2220 2b20 7473 2e73 7461 7465 2e72  e_" + ts.state.r
+0002d0d0: 6570 6c61 6365 2822 2d22 2c20 225f 2229  eplace("-", "_")
+0002d0e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002d0f0: 2020 6578 6365 7074 2041 7474 7269 6275    except Attribu
+0002d100: 7465 4572 726f 723a 0a20 2020 2020 2020  teError:.       
+0002d110: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002d120: 6765 722e 6572 726f 7228 0a20 2020 2020  ger.error(.     
+0002d130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d140: 2020 2022 7365 6c66 2e76 616c 6964 6174     "self.validat
+0002d150: 655f 2573 206e 6f74 2066 6f75 6e64 222c  e_%s not found",
+0002d160: 2074 732e 7374 6174 652e 7265 706c 6163   ts.state.replac
+0002d170: 6528 222d 222c 2022 5f22 290a 2020 2020  e("-", "_").    
+0002d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d190: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002d1a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002d1b0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
+0002d1c0: 286b 6579 290a 2020 2020 2020 2020 6578  (key).        ex
+0002d1d0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0002d1e0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0002d1f0: 206c 6f67 6765 722e 6578 6365 7074 696f   logger.exceptio
+0002d200: 6e28 6529 0a20 2020 2020 2020 2020 2020  n(e).           
+0002d210: 2069 6620 4c4f 475f 5044 423a 0a20 2020   if LOG_PDB:.   
+0002d220: 2020 2020 2020 2020 2020 2020 2069 6d70               imp
+0002d230: 6f72 7420 7064 620a 0a20 2020 2020 2020  ort pdb..       
+0002d240: 2020 2020 2020 2020 2070 6462 2e73 6574           pdb.set
+0002d250: 5f74 7261 6365 2829 0a20 2020 2020 2020  _trace().       
+0002d260: 2020 2020 2072 6169 7365 0a0a 2020 2020       raise..    
+0002d270: 6465 6620 7661 6c69 6461 7465 5f73 7461  def validate_sta
+0002d280: 7465 2873 656c 662c 2061 6c6c 6f77 5f6f  te(self, allow_o
+0002d290: 7665 726c 6170 3a20 626f 6f6c 203d 2046  verlap: bool = F
+0002d2a0: 616c 7365 2920 2d3e 204e 6f6e 653a 0a20  alse) -> None:. 
+0002d2b0: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
+0002d2c0: 7374 6174 6528 7365 6c66 2e74 6173 6b73  state(self.tasks
+0002d2d0: 2c20 7365 6c66 2e77 6f72 6b65 7273 2c20  , self.workers, 
+0002d2e0: 7365 6c66 2e63 6c69 656e 7473 290a 0a20  self.clients).. 
+0002d2f0: 2020 2020 2020 2069 6620 6e6f 7420 2873         if not (s
+0002d300: 6574 2873 656c 662e 776f 726b 6572 7329  et(self.workers)
+0002d310: 203d 3d20 7365 7428 7365 6c66 2e73 7472   == set(self.str
+0002d320: 6561 6d5f 636f 6d6d 7329 293a 0a20 2020  eam_comms)):.   
+0002d330: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0002d340: 616c 7565 4572 726f 7228 2257 6f72 6b65  alueError("Worke
+0002d350: 7273 206e 6f74 2074 6865 2073 616d 6520  rs not the same 
+0002d360: 696e 2061 6c6c 2063 6f6c 6c65 6374 696f  in all collectio
+0002d370: 6e73 2229 0a0a 2020 2020 2020 2020 6173  ns")..        as
+0002d380: 7365 7274 2073 656c 662e 7275 6e6e 696e  sert self.runnin
+0002d390: 672e 6973 7375 7065 7273 6574 2873 656c  g.issuperset(sel
+0002d3a0: 662e 6964 6c65 2e76 616c 7565 7328 2929  f.idle.values())
+0002d3b0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+0002d3c0: 7365 6c66 2e72 756e 6e69 6e67 2e63 6f70  self.running.cop
+0002d3d0: 7928 292c 0a20 2020 2020 2020 2020 2020  y(),.           
+0002d3e0: 2073 6574 2873 656c 662e 6964 6c65 2e76   set(self.idle.v
+0002d3f0: 616c 7565 7328 2929 2c0a 2020 2020 2020  alues()),.      
+0002d400: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
+0002d410: 7274 2073 656c 662e 7275 6e6e 696e 672e  rt self.running.
+0002d420: 6973 7375 7065 7273 6574 2873 656c 662e  issuperset(self.
+0002d430: 6964 6c65 5f74 6173 6b5f 636f 756e 7429  idle_task_count)
+0002d440: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+0002d450: 7365 6c66 2e72 756e 6e69 6e67 2e63 6f70  self.running.cop
+0002d460: 7928 292c 0a20 2020 2020 2020 2020 2020  y(),.           
+0002d470: 2073 656c 662e 6964 6c65 5f74 6173 6b5f   self.idle_task_
+0002d480: 636f 756e 742e 636f 7079 2829 2c0a 2020  count.copy(),.  
+0002d490: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002d4a0: 6173 7365 7274 2073 656c 662e 7275 6e6e  assert self.runn
+0002d4b0: 696e 672e 6973 7375 7065 7273 6574 2873  ing.issuperset(s
+0002d4c0: 656c 662e 7361 7475 7261 7465 6429 2c20  elf.saturated), 
+0002d4d0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+0002d4e0: 6c66 2e72 756e 6e69 6e67 2e63 6f70 7928  lf.running.copy(
+0002d4f0: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
+0002d500: 656c 662e 7361 7475 7261 7465 642e 636f  elf.saturated.co
+0002d510: 7079 2829 2c0a 2020 2020 2020 2020 290a  py(),.        ).
+0002d520: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+0002d530: 656c 662e 7361 7475 7261 7465 642e 6973  elf.saturated.is
+0002d540: 6469 736a 6f69 6e74 2873 656c 662e 6964  disjoint(self.id
+0002d550: 6c65 2e76 616c 7565 7328 2929 2c20 280a  le.values()), (.
+0002d560: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002d570: 2e73 6174 7572 6174 6564 2e63 6f70 7928  .saturated.copy(
+0002d580: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
+0002d590: 6574 2873 656c 662e 6964 6c65 2e76 616c  et(self.idle.val
+0002d5a0: 7565 7328 2929 2c0a 2020 2020 2020 2020  ues()),.        
+0002d5b0: 290a 0a20 2020 2020 2020 2074 6173 6b5f  )..        task_
+0002d5c0: 7072 6566 6978 5f63 6f75 6e74 733a 2064  prefix_counts: d
+0002d5d0: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
+0002d5e0: 696e 745d 203d 2064 6566 6175 6c74 6469  int] = defaultdi
+0002d5f0: 6374 2869 6e74 290a 2020 2020 2020 2020  ct(int).        
+0002d600: 666f 7220 772c 2077 7320 696e 2073 656c  for w, ws in sel
+0002d610: 662e 776f 726b 6572 732e 6974 656d 7328  f.workers.items(
+0002d620: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+0002d630: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0002d640: 2877 2c20 7374 7229 2c20 2874 7970 6528  (w, str), (type(
+0002d650: 7729 2c20 7729 0a20 2020 2020 2020 2020  w), w).         
+0002d660: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0002d670: 616e 6365 2877 732c 2057 6f72 6b65 7253  ance(ws, WorkerS
+0002d680: 7461 7465 292c 2028 7479 7065 2877 7329  tate), (type(ws)
+0002d690: 2c20 7773 290a 2020 2020 2020 2020 2020  , ws).          
+0002d6a0: 2020 6173 7365 7274 2077 732e 6164 6472    assert ws.addr
+0002d6b0: 6573 7320 3d3d 2077 0a0a 2020 2020 2020  ess == w..      
+0002d6c0: 2020 2020 2020 6966 2077 732e 7374 6174        if ws.stat
+0002d6d0: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+0002d6e0: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+0002d6f0: 2020 2020 2020 6173 7365 7274 2077 7320        assert ws 
+0002d700: 696e 2073 656c 662e 7275 6e6e 696e 670a  in self.running.
+0002d710: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002d720: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002d730: 2020 6173 7365 7274 2077 7320 6e6f 7420    assert ws not 
+0002d740: 696e 2073 656c 662e 7275 6e6e 696e 670a  in self.running.
+0002d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d760: 6173 7365 7274 2077 732e 6164 6472 6573  assert ws.addres
+0002d770: 7320 6e6f 7420 696e 2073 656c 662e 6964  s not in self.id
+0002d780: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
+0002d790: 2020 2061 7373 6572 7420 7773 206e 6f74     assert ws not
+0002d7a0: 2069 6e20 7365 6c66 2e73 6174 7572 6174   in self.saturat
+0002d7b0: 6564 0a0a 2020 2020 2020 2020 2020 2020  ed..            
+0002d7c0: 6173 7365 7274 2077 732e 6c6f 6e67 5f72  assert ws.long_r
+0002d7d0: 756e 6e69 6e67 2e69 7373 7562 7365 7428  unning.issubset(
+0002d7e0: 7773 2e70 726f 6365 7373 696e 6729 0a20  ws.processing). 
+0002d7f0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0002d800: 7420 7773 2e70 726f 6365 7373 696e 673a  t ws.processing:
+0002d810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d820: 2061 7373 6572 7420 6e6f 7420 7773 2e6f   assert not ws.o
+0002d830: 6363 7570 616e 6379 0a20 2020 2020 2020  ccupancy.       
+0002d840: 2020 2020 2020 2020 2069 6620 7773 2e73           if ws.s
+0002d850: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+0002d860: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+0002d870: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0002d880: 6572 7420 7773 2e61 6464 7265 7373 2069  ert ws.address i
+0002d890: 6e20 7365 6c66 2e69 646c 650a 2020 2020  n self.idle.    
+0002d8a0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+0002d8b0: 6f74 2077 732e 6e65 6564 735f 7768 6174  ot ws.needs_what
+0002d8c0: 2e6b 6579 7328 2920 2620 7773 2e68 6173  .keys() & ws.has
+0002d8d0: 5f77 6861 740a 2020 2020 2020 2020 2020  _what.          
+0002d8e0: 2020 6163 7475 616c 5f6e 6565 6473 5f77    actual_needs_w
+0002d8f0: 6861 743a 2064 6566 6175 6c74 6469 6374  hat: defaultdict
+0002d900: 5b54 6173 6b53 7461 7465 2c20 696e 745d  [TaskState, int]
+0002d910: 203d 2064 6566 6175 6c74 6469 6374 2869   = defaultdict(i
+0002d920: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+0002d930: 666f 7220 7473 2069 6e20 7773 2e70 726f  for ts in ws.pro
+0002d940: 6365 7373 696e 673a 0a20 2020 2020 2020  cessing:.       
+0002d950: 2020 2020 2020 2020 2066 6f72 2074 7373           for tss
+0002d960: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+0002d970: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+0002d980: 2020 2020 2020 2020 2069 6620 7473 7320           if tss 
+0002d990: 6e6f 7420 696e 2077 732e 6861 735f 7768  not in ws.has_wh
+0002d9a0: 6174 3a0a 2020 2020 2020 2020 2020 2020  at:.            
+0002d9b0: 2020 2020 2020 2020 2020 2020 6163 7475              actu
+0002d9c0: 616c 5f6e 6565 6473 5f77 6861 745b 7473  al_needs_what[ts
+0002d9d0: 735d 202b 3d20 310a 2020 2020 2020 2020  s] += 1.        
+0002d9e0: 2020 2020 6173 7365 7274 2061 6374 7561      assert actua
+0002d9f0: 6c5f 6e65 6564 735f 7768 6174 203d 3d20  l_needs_what == 
+0002da00: 7773 2e6e 6565 6473 5f77 6861 740a 2020  ws.needs_what.  
+0002da10: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002da20: 2028 7773 2e73 7461 7475 7320 3d3d 2053   (ws.status == S
+0002da30: 7461 7475 732e 7275 6e6e 696e 6729 203d  tatus.running) =
+0002da40: 3d20 2877 7320 696e 2073 656c 662e 7275  = (ws in self.ru
+0002da50: 6e6e 696e 6729 0a20 2020 2020 2020 2020  nning).         
+0002da60: 2020 2066 6f72 206e 616d 652c 2063 6f75     for name, cou
+0002da70: 6e74 2069 6e20 7773 2e74 6173 6b5f 7072  nt in ws.task_pr
+0002da80: 6566 6978 5f63 6f75 6e74 2e69 7465 6d73  efix_count.items
+0002da90: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0002daa0: 2020 2020 7461 736b 5f70 7265 6669 785f      task_prefix_
+0002dab0: 636f 756e 7473 5b6e 616d 655d 202b 3d20  counts[name] += 
+0002dac0: 636f 756e 740a 0a20 2020 2020 2020 2061  count..        a
+0002dad0: 7373 6572 7420 7461 736b 5f70 7265 6669  ssert task_prefi
+0002dae0: 785f 636f 756e 7473 2e6b 6579 7328 2920  x_counts.keys() 
+0002daf0: 3d3d 2073 656c 662e 5f74 6173 6b5f 7072  == self._task_pr
+0002db00: 6566 6978 5f63 6f75 6e74 5f67 6c6f 6261  efix_count_globa
+0002db10: 6c2e 6b65 7973 2829 0a20 2020 2020 2020  l.keys().       
+0002db20: 2066 6f72 206e 616d 652c 2067 6c6f 6261   for name, globa
+0002db30: 6c5f 636f 756e 7420 696e 2073 656c 662e  l_count in self.
+0002db40: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
+0002db50: 6e74 5f67 6c6f 6261 6c2e 6974 656d 7328  nt_global.items(
+0002db60: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+0002db70: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
+0002db80: 2020 2020 2020 2020 7461 736b 5f70 7265          task_pre
+0002db90: 6669 785f 636f 756e 7473 5b6e 616d 655d  fix_counts[name]
+0002dba0: 203d 3d20 676c 6f62 616c 5f63 6f75 6e74   == global_count
+0002dbb0: 0a20 2020 2020 2020 2020 2020 2029 2c20  .            ), 
+0002dbc0: 6622 7b6e 616d 657d 3a20 7b74 6173 6b5f  f"{name}: {task_
+0002dbd0: 7072 6566 6978 5f63 6f75 6e74 735b 6e61  prefix_counts[na
+0002dbe0: 6d65 5d7d 2028 7773 7329 2c20 7b67 6c6f  me]} (wss), {glo
+0002dbf0: 6261 6c5f 636f 756e 747d 2028 676c 6f62  bal_count} (glob
+0002dc00: 616c 2922 0a0a 2020 2020 2020 2020 666f  al)"..        fo
+0002dc10: 7220 7773 2069 6e20 7365 6c66 2e72 756e  r ws in self.run
+0002dc20: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+0002dc30: 2020 6173 7365 7274 2077 732e 7374 6174    assert ws.stat
+0002dc40: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+0002dc50: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
+0002dc60: 2061 7373 6572 7420 7773 2e61 6464 7265   assert ws.addre
+0002dc70: 7373 2069 6e20 7365 6c66 2e77 6f72 6b65  ss in self.worke
+0002dc80: 7273 0a0a 2020 2020 2020 2020 666f 7220  rs..        for 
+0002dc90: 6b2c 2074 7320 696e 2073 656c 662e 7461  k, ts in self.ta
+0002dca0: 736b 732e 6974 656d 7328 293a 0a20 2020  sks.items():.   
+0002dcb0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002dcc0: 6973 696e 7374 616e 6365 2874 732c 2054  isinstance(ts, T
+0002dcd0: 6173 6b53 7461 7465 292c 2028 7479 7065  askState), (type
+0002dce0: 2874 7329 2c20 7473 290a 2020 2020 2020  (ts), ts).      
+0002dcf0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+0002dd00: 6b65 7920 3d3d 206b 0a20 2020 2020 2020  key == k.       
+0002dd10: 2020 2020 2061 7373 6572 7420 626f 6f6c       assert bool
+0002dd20: 2874 7320 696e 2073 656c 662e 7265 706c  (ts in self.repl
+0002dd30: 6963 6174 6564 5f74 6173 6b73 2920 3d3d  icated_tasks) ==
+0002dd40: 2028 6c65 6e28 7473 2e77 686f 5f68 6173   (len(ts.who_has
+0002dd50: 2920 3e20 3129 0a20 2020 2020 2020 2020  ) > 1).         
+0002dd60: 2020 2073 656c 662e 7661 6c69 6461 7465     self.validate
+0002dd70: 5f6b 6579 286b 2c20 7473 290a 0a20 2020  _key(k, ts)..   
+0002dd80: 2020 2020 2066 6f72 2074 7320 696e 2073       for ts in s
+0002dd90: 656c 662e 7265 706c 6963 6174 6564 5f74  elf.replicated_t
+0002dda0: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
+0002ddb0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+0002ddc0: 6520 3d3d 2022 6d65 6d6f 7279 220a 2020  e == "memory".  
+0002ddd0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002dde0: 2074 732e 6b65 7920 696e 2073 656c 662e   ts.key in self.
+0002ddf0: 7461 736b 730a 0a20 2020 2020 2020 2066  tasks..        f
+0002de00: 6f72 2063 2c20 6373 2069 6e20 7365 6c66  or c, cs in self
+0002de10: 2e63 6c69 656e 7473 2e69 7465 6d73 2829  .clients.items()
+0002de20: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0002de30: 636c 6965 6e74 3d4e 6f6e 6520 6973 206f  client=None is o
+0002de40: 6674 656e 2075 7365 6420 696e 2074 6573  ften used in tes
+0002de50: 7473 2e2e 2e0a 2020 2020 2020 2020 2020  ts....          
+0002de60: 2020 6173 7365 7274 2063 2069 7320 4e6f    assert c is No
+0002de70: 6e65 206f 7220 7479 7065 2863 2920 3d3d  ne or type(c) ==
+0002de80: 2073 7472 2c20 2874 7970 6528 6329 2c20   str, (type(c), 
+0002de90: 6329 0a20 2020 2020 2020 2020 2020 2061  c).            a
+0002dea0: 7373 6572 7420 7479 7065 2863 7329 203d  ssert type(cs) =
+0002deb0: 3d20 436c 6965 6e74 5374 6174 652c 2028  = ClientState, (
+0002dec0: 7479 7065 2863 7329 2c20 6373 290a 2020  type(cs), cs).  
+0002ded0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002dee0: 2063 732e 636c 6965 6e74 5f6b 6579 203d   cs.client_key =
+0002def0: 3d20 630a 0a20 2020 2020 2020 2061 203d  = c..        a =
+0002df00: 207b 773a 2077 732e 6e62 7974 6573 2066   {w: ws.nbytes f
+0002df10: 6f72 2077 2c20 7773 2069 6e20 7365 6c66  or w, ws in self
+0002df20: 2e77 6f72 6b65 7273 2e69 7465 6d73 2829  .workers.items()
+0002df30: 7d0a 2020 2020 2020 2020 6220 3d20 7b0a  }.        b = {.
+0002df40: 2020 2020 2020 2020 2020 2020 773a 2073              w: s
+0002df50: 756d 2874 732e 6765 745f 6e62 7974 6573  um(ts.get_nbytes
+0002df60: 2829 2066 6f72 2074 7320 696e 2077 732e  () for ts in ws.
+0002df70: 6861 735f 7768 6174 290a 2020 2020 2020  has_what).      
+0002df80: 2020 2020 2020 666f 7220 772c 2077 7320        for w, ws 
+0002df90: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+0002dfa0: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+0002dfb0: 7d0a 2020 2020 2020 2020 6173 7365 7274  }.        assert
+0002dfc0: 2061 203d 3d20 622c 2028 612c 2062 290a   a == b, (a, b).
+0002dfd0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0002dfe0: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+0002dff0: 7465 725f 6d61 783a 0a20 2020 2020 2020  ter_max:.       
+0002e000: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+0002e010: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+0002e020: 7465 7220 3c20 7365 6c66 2e74 7261 6e73  ter < self.trans
+0002e030: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
+0002e040: 780a 0a20 2020 2023 2323 2323 2323 2323  x..    #########
+0002e050: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+0002e060: 204d 616e 6167 6520 4d65 7373 6167 6573   Manage Messages
+0002e070: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
+0002e080: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
+0002e090: 6465 6620 7265 706f 7274 280a 2020 2020  def report(.    
+0002e0a0: 2020 2020 7365 6c66 2c20 6d73 673a 2064      self, msg: d
+0002e0b0: 6963 742c 2074 733a 2054 6173 6b53 7461  ict, ts: TaskSta
+0002e0c0: 7465 207c 204e 6f6e 6520 3d20 4e6f 6e65  te | None = None
+0002e0d0: 2c20 636c 6965 6e74 3a20 7374 7220 7c20  , client: str | 
+0002e0e0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+0002e0f0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002e100: 2020 2022 2222 0a20 2020 2020 2020 2050     """.        P
+0002e110: 7562 6c69 7368 2075 7064 6174 6573 2074  ublish updates t
+0002e120: 6f20 616c 6c20 6c69 7374 656e 696e 6720  o all listening 
+0002e130: 5175 6575 6573 2061 6e64 2043 6f6d 6d73  Queues and Comms
+0002e140: 0a0a 2020 2020 2020 2020 4966 2074 6865  ..        If the
+0002e150: 206d 6573 7361 6765 2063 6f6e 7461 696e   message contain
+0002e160: 7320 6120 6b65 7920 7468 656e 2077 6520  s a key then we 
+0002e170: 6f6e 6c79 2073 656e 6420 7468 6520 6d65  only send the me
+0002e180: 7373 6167 6520 746f 2074 686f 7365 0a20  ssage to those. 
+0002e190: 2020 2020 2020 2063 6f6d 6d73 2074 6861         comms tha
+0002e1a0: 7420 6361 7265 2061 626f 7574 2074 6865  t care about the
+0002e1b0: 206b 6579 2e0a 2020 2020 2020 2020 2222   key..        ""
+0002e1c0: 220a 2020 2020 2020 2020 6966 2074 7320  ".        if ts 
+0002e1d0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002e1e0: 2020 2020 206d 7367 5f6b 6579 203d 206d       msg_key = m
+0002e1f0: 7367 2e67 6574 2822 6b65 7922 290a 2020  sg.get("key").  
+0002e200: 2020 2020 2020 2020 2020 6966 206d 7367            if msg
+0002e210: 5f6b 6579 2069 7320 6e6f 7420 4e6f 6e65  _key is not None
+0002e220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002e230: 2020 7461 736b 733a 2064 6963 7420 3d20    tasks: dict = 
+0002e240: 7365 6c66 2e74 6173 6b73 0a20 2020 2020  self.tasks.     
+0002e250: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+0002e260: 7461 736b 732e 6765 7428 6d73 675f 6b65  tasks.get(msg_ke
+0002e270: 7929 0a0a 2020 2020 2020 2020 636c 6965  y)..        clie
+0002e280: 6e74 5f63 6f6d 6d73 3a20 6469 6374 203d  nt_comms: dict =
+0002e290: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
+0002e2a0: 6d73 0a20 2020 2020 2020 2069 6620 7473  ms.        if ts
+0002e2b0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0002e2c0: 2020 2020 2020 2320 4e6f 7469 6679 2061        # Notify a
+0002e2d0: 6c6c 2063 6c69 656e 7473 0a20 2020 2020  ll clients.     
+0002e2e0: 2020 2020 2020 2063 6c69 656e 745f 6b65         client_ke
+0002e2f0: 7973 203d 206c 6973 7428 636c 6965 6e74  ys = list(client
+0002e300: 5f63 6f6d 6d73 290a 2020 2020 2020 2020  _comms).        
+0002e310: 656c 6966 2063 6c69 656e 7420 6973 204e  elif client is N
+0002e320: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0002e330: 2023 204e 6f74 6966 7920 636c 6965 6e74   # Notify client
+0002e340: 7320 696e 7465 7265 7374 6564 2069 6e20  s interested in 
+0002e350: 6b65 790a 2020 2020 2020 2020 2020 2020  key.            
+0002e360: 636c 6965 6e74 5f6b 6579 7320 3d20 5b63  client_keys = [c
+0002e370: 732e 636c 6965 6e74 5f6b 6579 2066 6f72  s.client_key for
+0002e380: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
+0002e390: 6e74 735d 0a20 2020 2020 2020 2065 6c73  nts].        els
+0002e3a0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0002e3b0: 204e 6f74 6966 7920 636c 6965 6e74 7320   Notify clients 
+0002e3c0: 696e 7465 7265 7374 6564 2069 6e20 6b65  interested in ke
+0002e3d0: 7920 2869 6e63 6c75 6469 6e67 2060 636c  y (including `cl
+0002e3e0: 6965 6e74 6029 0a20 2020 2020 2020 2020  ient`).         
+0002e3f0: 2020 2063 6c69 656e 745f 6b65 7973 203d     client_keys =
+0002e400: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0002e410: 2020 2063 732e 636c 6965 6e74 5f6b 6579     cs.client_key
+0002e420: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
+0002e430: 6f5f 7761 6e74 7320 6966 2063 732e 636c  o_wants if cs.cl
+0002e440: 6965 6e74 5f6b 6579 2021 3d20 636c 6965  ient_key != clie
+0002e450: 6e74 0a20 2020 2020 2020 2020 2020 205d  nt.            ]
+0002e460: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0002e470: 656e 745f 6b65 7973 2e61 7070 656e 6428  ent_keys.append(
+0002e480: 636c 6965 6e74 290a 0a20 2020 2020 2020  client)..       
+0002e490: 206b 3a20 7374 720a 2020 2020 2020 2020   k: str.        
+0002e4a0: 666f 7220 6b20 696e 2063 6c69 656e 745f  for k in client_
+0002e4b0: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
+0002e4c0: 2020 6320 3d20 636c 6965 6e74 5f63 6f6d    c = client_com
+0002e4d0: 6d73 2e67 6574 286b 290a 2020 2020 2020  ms.get(k).      
+0002e4e0: 2020 2020 2020 6966 2063 2069 7320 4e6f        if c is No
+0002e4f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0002e500: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+0002e510: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0002e520: 2020 2020 2020 2020 2020 2020 2020 632e                c.
+0002e530: 7365 6e64 286d 7367 290a 2020 2020 2020  send(msg).      
+0002e540: 2020 2020 2020 2020 2020 2320 6c6f 6767            # logg
+0002e550: 6572 2e64 6562 7567 2822 5363 6865 6475  er.debug("Schedu
+0002e560: 6c65 7220 7365 6e64 7320 6d65 7373 6167  ler sends messag
+0002e570: 6520 746f 2063 6c69 656e 7420 2573 222c  e to client %s",
+0002e580: 206d 7367 290a 2020 2020 2020 2020 2020   msg).          
+0002e590: 2020 6578 6365 7074 2043 6f6d 6d43 6c6f    except CommClo
+0002e5a0: 7365 6445 7272 6f72 3a0a 2020 2020 2020  sedError:.      
+0002e5b0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0002e5c0: 662e 7374 6174 7573 203d 3d20 5374 6174  f.status == Stat
+0002e5d0: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
+0002e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e5f0: 6c6f 6767 6572 2e63 7269 7469 6361 6c28  logger.critical(
+0002e600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e610: 2020 2020 2020 2020 2022 436c 6f73 6564           "Closed
+0002e620: 2063 6f6d 6d20 2572 2077 6869 6c65 2074   comm %r while t
+0002e630: 7279 696e 6720 746f 2077 7269 7465 2025  rying to write %
+0002e640: 7322 2c20 632c 206d 7367 2c20 6578 635f  s", c, msg, exc_
+0002e650: 696e 666f 3d54 7275 650a 2020 2020 2020  info=True.      
+0002e660: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0002e670: 0a20 2020 2061 7379 6e63 2064 6566 2061  .    async def a
+0002e680: 6464 5f63 6c69 656e 7428 0a20 2020 2020  dd_client(.     
+0002e690: 2020 2073 656c 662c 2063 6f6d 6d3a 2043     self, comm: C
+0002e6a0: 6f6d 6d2c 2063 6c69 656e 743a 2073 7472  omm, client: str
+0002e6b0: 2c20 7665 7273 696f 6e73 3a20 6469 6374  , versions: dict
+0002e6c0: 5b73 7472 2c20 416e 795d 0a20 2020 2029  [str, Any].    )
+0002e6d0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002e6e0: 2020 2222 2241 6464 2063 6c69 656e 7420    """Add client 
+0002e6f0: 746f 206e 6574 776f 726b 0a0a 2020 2020  to network..    
+0002e700: 2020 2020 5765 206c 6973 7465 6e20 746f      We listen to
+0002e710: 2061 6c6c 2066 7574 7572 6520 6d65 7373   all future mess
+0002e720: 6167 6573 2066 726f 6d20 7468 6973 2043  ages from this C
+0002e730: 6f6d 6d2e 0a20 2020 2020 2020 2022 2222  omm..        """
+0002e740: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002e750: 636c 6965 6e74 2069 7320 6e6f 7420 4e6f  client is not No
+0002e760: 6e65 0a20 2020 2020 2020 2063 6f6d 6d2e  ne.        comm.
+0002e770: 6e61 6d65 203d 2022 5363 6865 6475 6c65  name = "Schedule
+0002e780: 722d 3e43 6c69 656e 7422 0a20 2020 2020  r->Client".     
+0002e790: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+0002e7a0: 5265 6365 6976 6520 636c 6965 6e74 2063  Receive client c
+0002e7b0: 6f6e 6e65 6374 696f 6e3a 2025 7322 2c20  onnection: %s", 
+0002e7c0: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
+0002e7d0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 285b  self.log_event([
+0002e7e0: 2261 6c6c 222c 2063 6c69 656e 745d 2c20  "all", client], 
+0002e7f0: 7b22 6163 7469 6f6e 223a 2022 6164 642d  {"action": "add-
+0002e800: 636c 6965 6e74 222c 2022 636c 6965 6e74  client", "client
+0002e810: 223a 2063 6c69 656e 747d 290a 2020 2020  ": client}).    
+0002e820: 2020 2020 7365 6c66 2e63 6c69 656e 7473      self.clients
+0002e830: 5b63 6c69 656e 745d 203d 2043 6c69 656e  [client] = Clien
+0002e840: 7453 7461 7465 2863 6c69 656e 742c 2076  tState(client, v
+0002e850: 6572 7369 6f6e 733d 7665 7273 696f 6e73  ersions=versions
+0002e860: 290a 0a20 2020 2020 2020 2066 6f72 2070  )..        for p
+0002e870: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
+0002e880: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
+0002e890: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+0002e8a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0002e8b0: 2020 2020 2020 2070 6c75 6769 6e2e 6164         plugin.ad
+0002e8c0: 645f 636c 6965 6e74 2873 6368 6564 756c  d_client(schedul
+0002e8d0: 6572 3d73 656c 662c 2063 6c69 656e 743d  er=self, client=
+0002e8e0: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
+0002e8f0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0002e900: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+0002e910: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0002e920: 722e 6578 6365 7074 696f 6e28 6529 0a0a  r.exception(e)..
+0002e930: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0002e940: 2020 2020 2020 2020 2062 636f 6d6d 203d           bcomm =
+0002e950: 2042 6174 6368 6564 5365 6e64 2869 6e74   BatchedSend(int
+0002e960: 6572 7661 6c3d 2232 6d73 222c 206c 6f6f  erval="2ms", loo
+0002e970: 703d 7365 6c66 2e6c 6f6f 7029 0a20 2020  p=self.loop).   
+0002e980: 2020 2020 2020 2020 2062 636f 6d6d 2e73           bcomm.s
+0002e990: 7461 7274 2863 6f6d 6d29 0a20 2020 2020  tart(comm).     
+0002e9a0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+0002e9b0: 6e74 5f63 6f6d 6d73 5b63 6c69 656e 745d  nt_comms[client]
+0002e9c0: 203d 2062 636f 6d6d 0a20 2020 2020 2020   = bcomm.       
+0002e9d0: 2020 2020 206d 7367 203d 207b 226f 7022       msg = {"op"
+0002e9e0: 3a20 2273 7472 6561 6d2d 7374 6172 7422  : "stream-start"
+0002e9f0: 7d0a 2020 2020 2020 2020 2020 2020 7665  }.            ve
+0002ea00: 7273 696f 6e5f 7761 726e 696e 6720 3d20  rsion_warning = 
+0002ea10: 7665 7273 696f 6e5f 6d6f 6475 6c65 2e65  version_module.e
+0002ea20: 7272 6f72 5f6d 6573 7361 6765 280a 2020  rror_message(.  
+0002ea30: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+0002ea40: 7273 696f 6e5f 6d6f 6475 6c65 2e67 6574  rsion_module.get
+0002ea50: 5f76 6572 7369 6f6e 7328 292c 0a20 2020  _versions(),.   
+0002ea60: 2020 2020 2020 2020 2020 2020 207b 773a               {w:
+0002ea70: 2077 732e 7665 7273 696f 6e73 2066 6f72   ws.versions for
+0002ea80: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
+0002ea90: 6f72 6b65 7273 2e69 7465 6d73 2829 7d2c  orkers.items()},
+0002eaa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002eab0: 2076 6572 7369 6f6e 732c 0a20 2020 2020   versions,.     
+0002eac0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002ead0: 2020 2020 206d 7367 2e75 7064 6174 6528       msg.update(
+0002eae0: 7665 7273 696f 6e5f 7761 726e 696e 6729  version_warning)
+0002eaf0: 0a20 2020 2020 2020 2020 2020 2062 636f  .            bco
+0002eb00: 6d6d 2e73 656e 6428 6d73 6729 0a0a 2020  mm.send(msg)..  
+0002eb10: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0002eb20: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0002eb30: 7761 6974 2073 656c 662e 6861 6e64 6c65  wait self.handle
+0002eb40: 5f73 7472 6561 6d28 636f 6d6d 3d63 6f6d  _stream(comm=com
+0002eb50: 6d2c 2065 7874 7261 3d7b 2263 6c69 656e  m, extra={"clien
+0002eb60: 7422 3a20 636c 6965 6e74 7d29 0a20 2020  t": client}).   
+0002eb70: 2020 2020 2020 2020 2066 696e 616c 6c79           finally
+0002eb80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002eb90: 2020 7365 6c66 2e72 656d 6f76 655f 636c    self.remove_cl
+0002eba0: 6965 6e74 2863 6c69 656e 743d 636c 6965  ient(client=clie
+0002ebb0: 6e74 2c20 7374 696d 756c 7573 5f69 643d  nt, stimulus_id=
+0002ebc0: 6622 7265 6d6f 7665 2d63 6c69 656e 742d  f"remove-client-
+0002ebd0: 7b74 696d 6528 297d 2229 0a20 2020 2020  {time()}").     
+0002ebe0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0002ebf0: 722e 6465 6275 6728 2246 696e 6973 6865  r.debug("Finishe
+0002ec00: 6420 6861 6e64 6c69 6e67 2063 6c69 656e  d handling clien
+0002ec10: 7420 2573 222c 2063 6c69 656e 7429 0a20  t %s", client). 
+0002ec20: 2020 2020 2020 2066 696e 616c 6c79 3a0a         finally:.
+0002ec30: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0002ec40: 6f74 2063 6f6d 6d2e 636c 6f73 6564 2829  ot comm.closed()
+0002ec50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ec60: 2020 7365 6c66 2e63 6c69 656e 745f 636f    self.client_co
+0002ec70: 6d6d 735b 636c 6965 6e74 5d2e 7365 6e64  mms[client].send
+0002ec80: 287b 226f 7022 3a20 2273 7472 6561 6d2d  ({"op": "stream-
+0002ec90: 636c 6f73 6564 227d 290a 2020 2020 2020  closed"}).      
+0002eca0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0002ecb0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0002ecc0: 7420 7379 732e 6973 5f66 696e 616c 697a  t sys.is_finaliz
+0002ecd0: 696e 6728 293a 0a20 2020 2020 2020 2020  ing():.         
+0002ece0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0002ecf0: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
+0002ed00: 6d73 5b63 6c69 656e 745d 2e63 6c6f 7365  ms[client].close
+0002ed10: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0002ed20: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
+0002ed30: 636c 6965 6e74 5f63 6f6d 6d73 5b63 6c69  client_comms[cli
+0002ed40: 656e 745d 0a20 2020 2020 2020 2020 2020  ent].           
+0002ed50: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0002ed60: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
+0002ed70: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
+0002ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ed90: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+0002eda0: 436c 6f73 6520 636c 6965 6e74 2063 6f6e  Close client con
+0002edb0: 6e65 6374 696f 6e3a 2025 7322 2c20 636c  nection: %s", cl
+0002edc0: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
+0002edd0: 2020 6578 6365 7074 2054 7970 6545 7272    except TypeErr
+0002ede0: 6f72 3a20 2023 2063 6f6d 6d20 6265 636f  or:  # comm beco
+0002edf0: 6d65 7320 4e6f 6e65 2064 7572 696e 6720  mes None during 
+0002ee00: 4743 0a20 2020 2020 2020 2020 2020 2020  GC.             
+0002ee10: 2020 2070 6173 730a 0a20 2020 2064 6566     pass..    def
+0002ee20: 2072 656d 6f76 655f 636c 6965 6e74 2873   remove_client(s
+0002ee30: 656c 662c 2063 6c69 656e 743a 2073 7472  elf, client: str
+0002ee40: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+0002ee50: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+0002ee60: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002ee70: 2020 2022 2222 5265 6d6f 7665 2063 6c69     """Remove cli
+0002ee80: 656e 7420 6672 6f6d 206e 6574 776f 726b  ent from network
+0002ee90: 2222 220a 2020 2020 2020 2020 7374 696d  """.        stim
+0002eea0: 756c 7573 5f69 6420 3d20 7374 696d 756c  ulus_id = stimul
+0002eeb0: 7573 5f69 6420 6f72 2066 2272 656d 6f76  us_id or f"remov
+0002eec0: 652d 636c 6965 6e74 2d7b 7469 6d65 2829  e-client-{time()
+0002eed0: 7d22 0a20 2020 2020 2020 2069 6620 7365  }".        if se
+0002eee0: 6c66 2e73 7461 7475 7320 3d3d 2053 7461  lf.status == Sta
+0002eef0: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
+0002ef00: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0002ef10: 696e 666f 2822 5265 6d6f 7665 2063 6c69  info("Remove cli
+0002ef20: 656e 7420 2573 222c 2063 6c69 656e 7429  ent %s", client)
+0002ef30: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+0002ef40: 675f 6576 656e 7428 5b22 616c 6c22 2c20  g_event(["all", 
+0002ef50: 636c 6965 6e74 5d2c 207b 2261 6374 696f  client], {"actio
+0002ef60: 6e22 3a20 2272 656d 6f76 652d 636c 6965  n": "remove-clie
+0002ef70: 6e74 222c 2022 636c 6965 6e74 223a 2063  nt", "client": c
+0002ef80: 6c69 656e 747d 290a 2020 2020 2020 2020  lient}).        
+0002ef90: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0002efa0: 2063 733a 2043 6c69 656e 7453 7461 7465   cs: ClientState
+0002efb0: 203d 2073 656c 662e 636c 6965 6e74 735b   = self.clients[
+0002efc0: 636c 6965 6e74 5d0a 2020 2020 2020 2020  client].        
+0002efd0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+0002efe0: 0a20 2020 2020 2020 2020 2020 2023 2058  .            # X
+0002eff0: 5858 2069 7320 7468 6973 2061 206c 6567  XX is this a leg
+0002f000: 6974 696d 6174 6520 636f 6e64 6974 696f  itimate conditio
+0002f010: 6e3f 0a20 2020 2020 2020 2020 2020 2070  n?.            p
+0002f020: 6173 730a 2020 2020 2020 2020 656c 7365  ass.        else
+0002f030: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0002f040: 6c66 2e63 6c69 656e 745f 7265 6c65 6173  lf.client_releas
+0002f050: 6573 5f6b 6579 7328 0a20 2020 2020 2020  es_keys(.       
+0002f060: 2020 2020 2020 2020 206b 6579 733d 5b74           keys=[t
+0002f070: 732e 6b65 7920 666f 7220 7473 2069 6e20  s.key for ts in 
+0002f080: 6373 2e77 616e 7473 5f77 6861 745d 2c0a  cs.wants_what],.
+0002f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f0a0: 636c 6965 6e74 3d63 732e 636c 6965 6e74  client=cs.client
+0002f0b0: 5f6b 6579 2c0a 2020 2020 2020 2020 2020  _key,.          
+0002f0c0: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+0002f0d0: 643d 7374 696d 756c 7573 5f69 642c 0a20  d=stimulus_id,. 
+0002f0e0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002f0f0: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
+0002f100: 662e 636c 6965 6e74 735b 636c 6965 6e74  f.clients[client
+0002f110: 5d0a 0a20 2020 2020 2020 2020 2020 2066  ]..            f
+0002f120: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
+0002f130: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
+0002f140: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
+0002f150: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0002f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f170: 2020 2070 6c75 6769 6e2e 7265 6d6f 7665     plugin.remove
+0002f180: 5f63 6c69 656e 7428 7363 6865 6475 6c65  _client(schedule
+0002f190: 723d 7365 6c66 2c20 636c 6965 6e74 3d63  r=self, client=c
+0002f1a0: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
+0002f1b0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+0002f1c0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+0002f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f1e0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+0002f1f0: 6f6e 2865 290a 0a20 2020 2020 2020 2061  on(e)..        a
+0002f200: 7379 6e63 2064 6566 2072 656d 6f76 655f  sync def remove_
+0002f210: 636c 6965 6e74 5f66 726f 6d5f 6576 656e  client_from_even
+0002f220: 7473 2829 3a0a 2020 2020 2020 2020 2020  ts():.          
+0002f230: 2020 2320 4966 2074 6865 2063 6c69 656e    # If the clien
+0002f240: 7420 6973 6e27 7420 7265 6769 7374 6572  t isn't register
+0002f250: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
+0002f260: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
+0002f270: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
+0002f280: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
+0002f290: 6965 6e74 206e 6f74 2069 6e20 7365 6c66  ient not in self
+0002f2a0: 2e63 6c69 656e 7473 2061 6e64 2063 6c69  .clients and cli
+0002f2b0: 656e 7420 696e 2073 656c 662e 6576 656e  ent in self.even
+0002f2c0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0002f2d0: 2020 2020 6465 6c20 7365 6c66 2e65 7665      del self.eve
+0002f2e0: 6e74 735b 636c 6965 6e74 5d0a 0a20 2020  nts[client]..   
+0002f2f0: 2020 2020 2063 6c65 616e 7570 5f64 656c       cleanup_del
+0002f300: 6179 203d 2070 6172 7365 5f74 696d 6564  ay = parse_timed
+0002f310: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
+0002f320: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
+0002f330: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+0002f340: 6368 6564 756c 6572 2e65 7665 6e74 732d  cheduler.events-
+0002f350: 636c 6561 6e75 702d 6465 6c61 7922 290a  cleanup-delay").
+0002f360: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002f370: 2020 6966 206e 6f74 2073 656c 662e 5f6f    if not self._o
+0002f380: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
+0002f390: 645f 7461 736b 732e 636c 6f73 6564 3a0a  d_tasks.closed:.
+0002f3a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002f3b0: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
+0002f3c0: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
+0002f3d0: 6c61 7465 7228 0a20 2020 2020 2020 2020  later(.         
+0002f3e0: 2020 2020 2020 2063 6c65 616e 7570 5f64         cleanup_d
+0002f3f0: 656c 6179 2c20 7265 6d6f 7665 5f63 6c69  elay, remove_cli
+0002f400: 656e 745f 6672 6f6d 5f65 7665 6e74 730a  ent_from_events.
+0002f410: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0002f420: 2020 2064 6566 2073 656e 645f 7461 736b     def send_task
+0002f430: 5f74 6f5f 776f 726b 6572 280a 2020 2020  _to_worker(.    
+0002f440: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
+0002f450: 3a20 7374 722c 2074 733a 2054 6173 6b53  : str, ts: TaskS
+0002f460: 7461 7465 2c20 6475 7261 7469 6f6e 3a20  tate, duration: 
+0002f470: 666c 6f61 7420 3d20 2d31 0a20 2020 2029  float = -1.    )
+0002f480: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002f490: 2020 2222 2253 656e 6420 6120 7369 6e67    """Send a sing
+0002f4a0: 6c65 2063 6f6d 7075 7461 7469 6f6e 616c  le computational
+0002f4b0: 2074 6173 6b20 746f 2061 2077 6f72 6b65   task to a worke
+0002f4c0: 7222 2222 0a20 2020 2020 2020 2074 7279  r""".        try
+0002f4d0: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
+0002f4e0: 673a 2064 6963 7420 3d20 7365 6c66 2e5f  g: dict = self._
+0002f4f0: 7461 736b 5f74 6f5f 6d73 6728 7473 2c20  task_to_msg(ts, 
+0002f500: 6475 7261 7469 6f6e 290a 2020 2020 2020  duration).      
+0002f510: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
+0002f520: 725f 7365 6e64 2877 6f72 6b65 722c 206d  r_send(worker, m
+0002f530: 7367 290a 2020 2020 2020 2020 6578 6365  sg).        exce
+0002f540: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+0002f550: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
+0002f560: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+0002f570: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+0002f580: 6620 4c4f 475f 5044 423a 0a20 2020 2020  f LOG_PDB:.     
+0002f590: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
+0002f5a0: 7420 7064 620a 0a20 2020 2020 2020 2020  t pdb..         
+0002f5b0: 2020 2020 2020 2070 6462 2e73 6574 5f74         pdb.set_t
+0002f5c0: 7261 6365 2829 0a20 2020 2020 2020 2020  race().         
+0002f5d0: 2020 2072 6169 7365 0a0a 2020 2020 6465     raise..    de
+0002f5e0: 6620 6861 6e64 6c65 5f75 6e63 6175 6768  f handle_uncaugh
+0002f5f0: 745f 6572 726f 7228 7365 6c66 2c20 2a2a  t_error(self, **
+0002f600: 6d73 673a 2041 6e79 2920 2d3e 204e 6f6e  msg: Any) -> Non
+0002f610: 653a 0a20 2020 2020 2020 206c 6f67 6765  e:.        logge
+0002f620: 722e 6578 6365 7074 696f 6e28 636c 6561  r.exception(clea
+0002f630: 6e5f 6578 6365 7074 696f 6e28 2a2a 6d73  n_exception(**ms
+0002f640: 6729 5b31 5d29 0a0a 2020 2020 6465 6620  g)[1])..    def 
+0002f650: 6861 6e64 6c65 5f74 6173 6b5f 6669 6e69  handle_task_fini
+0002f660: 7368 6564 280a 2020 2020 2020 2020 7365  shed(.        se
+0002f670: 6c66 2c20 6b65 793a 2073 7472 2c20 776f  lf, key: str, wo
+0002f680: 726b 6572 3a20 7374 722c 2073 7469 6d75  rker: str, stimu
+0002f690: 6c75 735f 6964 3a20 7374 722c 202a 2a6d  lus_id: str, **m
+0002f6a0: 7367 3a20 416e 790a 2020 2020 2920 2d3e  sg: Any.    ) ->
+0002f6b0: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+0002f6c0: 6620 776f 726b 6572 206e 6f74 2069 6e20  f worker not in 
+0002f6d0: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
+0002f6e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002f6f0: 0a20 2020 2020 2020 2076 616c 6964 6174  .        validat
+0002f700: 655f 6b65 7928 6b65 7929 0a0a 2020 2020  e_key(key)..    
+0002f710: 2020 2020 723a 2074 7570 6c65 203d 2073      r: tuple = s
+0002f720: 656c 662e 7374 696d 756c 7573 5f74 6173  elf.stimulus_tas
+0002f730: 6b5f 6669 6e69 7368 6564 280a 2020 2020  k_finished(.    
+0002f740: 2020 2020 2020 2020 6b65 793d 6b65 792c          key=key,
+0002f750: 2077 6f72 6b65 723d 776f 726b 6572 2c20   worker=worker, 
+0002f760: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+0002f770: 756c 7573 5f69 642c 202a 2a6d 7367 0a20  ulus_id, **msg. 
+0002f780: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002f790: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0002f7a0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
+0002f7b0: 6f72 6b65 725f 6d73 6773 203d 2072 0a20  orker_msgs = r. 
+0002f7c0: 2020 2020 2020 2073 656c 662e 5f74 7261         self._tra
+0002f7d0: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
+0002f7e0: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+0002f7f0: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
+0002f800: 6773 2c20 7374 696d 756c 7573 5f69 6429  gs, stimulus_id)
+0002f810: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+0002f820: 6e64 5f61 6c6c 2863 6c69 656e 745f 6d73  nd_all(client_ms
+0002f830: 6773 2c20 776f 726b 6572 5f6d 7367 7329  gs, worker_msgs)
+0002f840: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+0002f850: 7469 6d75 6c75 735f 7175 6575 655f 736c  timulus_queue_sl
+0002f860: 6f74 735f 6d61 7962 655f 6f70 656e 6564  ots_maybe_opened
+0002f870: 2873 7469 6d75 6c75 735f 6964 3d73 7469  (stimulus_id=sti
+0002f880: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
+0002f890: 6566 2068 616e 646c 655f 7461 736b 5f65  ef handle_task_e
+0002f8a0: 7272 6564 2873 656c 662c 206b 6579 3a20  rred(self, key: 
+0002f8b0: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+0002f8c0: 3a20 7374 722c 202a 2a6d 7367 3a20 416e  : str, **msg: An
+0002f8d0: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
+0002f8e0: 2020 2020 723a 2074 7570 6c65 203d 2073      r: tuple = s
+0002f8f0: 656c 662e 7374 696d 756c 7573 5f74 6173  elf.stimulus_tas
+0002f900: 6b5f 6572 7265 6428 6b65 793d 6b65 792c  k_erred(key=key,
+0002f910: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+0002f920: 6d75 6c75 735f 6964 2c20 2a2a 6d73 6729  mulus_id, **msg)
+0002f930: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+0002f940: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+0002f950: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
+0002f960: 6773 203d 2072 0a20 2020 2020 2020 2073  gs = r.        s
+0002f970: 656c 662e 5f74 7261 6e73 6974 696f 6e73  elf._transitions
+0002f980: 2872 6563 6f6d 6d65 6e64 6174 696f 6e73  (recommendations
+0002f990: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
+0002f9a0: 6f72 6b65 725f 6d73 6773 2c20 7374 696d  orker_msgs, stim
+0002f9b0: 756c 7573 5f69 6429 0a20 2020 2020 2020  ulus_id).       
+0002f9c0: 2073 656c 662e 7365 6e64 5f61 6c6c 2863   self.send_all(c
+0002f9d0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+0002f9e0: 6572 5f6d 7367 7329 0a0a 2020 2020 2020  er_msgs)..      
+0002f9f0: 2020 7365 6c66 2e73 7469 6d75 6c75 735f    self.stimulus_
+0002fa00: 7175 6575 655f 736c 6f74 735f 6d61 7962  queue_slots_mayb
+0002fa10: 655f 6f70 656e 6564 2873 7469 6d75 6c75  e_opened(stimulu
+0002fa20: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+0002fa30: 290a 0a20 2020 2064 6566 2072 656c 6561  )..    def relea
+0002fa40: 7365 5f77 6f72 6b65 725f 6461 7461 2873  se_worker_data(s
+0002fa50: 656c 662c 206b 6579 3a20 7374 722c 2077  elf, key: str, w
+0002fa60: 6f72 6b65 723a 2073 7472 2c20 7374 696d  orker: str, stim
+0002fa70: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
+0002fa80: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+0002fa90: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+0002faa0: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+0002fab0: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
+0002fac0: 732e 6765 7428 776f 726b 6572 290a 2020  s.get(worker).  
+0002fad0: 2020 2020 2020 6966 206e 6f74 2074 7320        if not ts 
+0002fae0: 6f72 206e 6f74 2077 7320 6f72 2077 7320  or not ws or ws 
+0002faf0: 6e6f 7420 696e 2074 732e 7768 6f5f 6861  not in ts.who_ha
+0002fb00: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+0002fb10: 6574 7572 6e0a 0a20 2020 2020 2020 2073  eturn..        s
+0002fb20: 656c 662e 7265 6d6f 7665 5f72 6570 6c69  elf.remove_repli
+0002fb30: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
+0002fb40: 2020 2069 6620 6e6f 7420 7473 2e77 686f     if not ts.who
+0002fb50: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+0002fb60: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
+0002fb70: 6e73 287b 6b65 793a 2022 7265 6c65 6173  ns({key: "releas
+0002fb80: 6564 227d 2c20 7374 696d 756c 7573 5f69  ed"}, stimulus_i
+0002fb90: 6429 0a0a 2020 2020 6465 6620 6861 6e64  d)..    def hand
+0002fba0: 6c65 5f6c 6f6e 675f 7275 6e6e 696e 6728  le_long_running(
+0002fbb0: 0a20 2020 2020 2020 2073 656c 662c 206b  .        self, k
+0002fbc0: 6579 3a20 7374 722c 2077 6f72 6b65 723a  ey: str, worker:
+0002fbd0: 2073 7472 2c20 636f 6d70 7574 655f 6475   str, compute_du
+0002fbe0: 7261 7469 6f6e 3a20 666c 6f61 7420 7c20  ration: float | 
+0002fbf0: 4e6f 6e65 2c20 7374 696d 756c 7573 5f69  None, stimulus_i
+0002fc00: 643a 2073 7472 0a20 2020 2029 202d 3e20  d: str.    ) -> 
+0002fc10: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0002fc20: 2241 2074 6173 6b20 6861 7320 7365 6365  "A task has sece
+0002fc30: 6465 6420 6672 6f6d 2074 6865 2074 6872  ded from the thr
+0002fc40: 6561 6420 706f 6f6c 0a0a 2020 2020 2020  ead pool..      
+0002fc50: 2020 5765 2073 746f 7020 7468 6520 7461    We stop the ta
+0002fc60: 736b 2066 726f 6d20 6265 696e 6720 7374  sk from being st
+0002fc70: 6f6c 656e 2069 6e20 7468 6520 6675 7475  olen in the futu
+0002fc80: 7265 2c20 616e 6420 6368 616e 6765 2074  re, and change t
+0002fc90: 6173 6b0a 2020 2020 2020 2020 6475 7261  ask.        dura
+0002fca0: 7469 6f6e 2061 6363 6f75 6e74 696e 6720  tion accounting 
+0002fcb0: 6173 2069 6620 7468 6520 7461 736b 2068  as if the task h
+0002fcc0: 6173 2073 746f 7070 6564 2e0a 2020 2020  as stopped..    
+0002fcd0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0002fce0: 6966 206b 6579 206e 6f74 2069 6e20 7365  if key not in se
+0002fcf0: 6c66 2e74 6173 6b73 3a0a 2020 2020 2020  lf.tasks:.      
+0002fd00: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+0002fd10: 7567 2822 536b 6970 7069 6e67 206c 6f6e  ug("Skipping lon
+0002fd20: 675f 7275 6e6e 696e 6720 7369 6e63 6520  g_running since 
+0002fd30: 6b65 7920 2573 2077 6173 2061 6c72 6561  key %s was alrea
+0002fd40: 6479 2072 656c 6561 7365 6422 2c20 6b65  dy released", ke
+0002fd50: 7929 0a20 2020 2020 2020 2020 2020 2072  y).            r
+0002fd60: 6574 7572 6e0a 2020 2020 2020 2020 7473  eturn.        ts
+0002fd70: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+0002fd80: 795d 0a20 2020 2020 2020 2073 7465 616c  y].        steal
+0002fd90: 203d 2073 656c 662e 6578 7465 6e73 696f   = self.extensio
+0002fda0: 6e73 2e67 6574 2822 7374 6561 6c69 6e67  ns.get("stealing
+0002fdb0: 2229 0a20 2020 2020 2020 2069 6620 7374  ").        if st
+0002fdc0: 6561 6c20 6973 206e 6f74 204e 6f6e 653a  eal is not None:
+0002fdd0: 0a20 2020 2020 2020 2020 2020 2073 7465  .            ste
+0002fde0: 616c 2e72 656d 6f76 655f 6b65 795f 6672  al.remove_key_fr
+0002fdf0: 6f6d 5f73 7465 616c 6162 6c65 2874 7329  om_stealable(ts)
+0002fe00: 0a0a 2020 2020 2020 2020 7773 203d 2074  ..        ws = t
+0002fe10: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
+0002fe20: 2020 2020 2020 2020 6966 2077 7320 6973          if ws is
+0002fe30: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0002fe40: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0002fe50: 2252 6563 6569 7665 6420 6c6f 6e67 2d72  "Received long-r
+0002fe60: 756e 6e69 6e67 2073 6967 6e61 6c20 6672  unning signal fr
+0002fe70: 6f6d 2064 7570 6c69 6361 7465 2074 6173  om duplicate tas
+0002fe80: 6b2e 2049 676e 6f72 696e 672e 2229 0a20  k. Ignoring."). 
+0002fe90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002fea0: 6e0a 0a20 2020 2020 2020 2069 6620 636f  n..        if co
+0002feb0: 6d70 7574 655f 6475 7261 7469 6f6e 2069  mpute_duration i
+0002fec0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0002fed0: 2020 2020 2020 2020 6f6c 645f 6475 7261          old_dura
+0002fee0: 7469 6f6e 203d 2074 732e 7072 6566 6978  tion = ts.prefix
+0002fef0: 2e64 7572 6174 696f 6e5f 6176 6572 6167  .duration_averag
+0002ff00: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+0002ff10: 206f 6c64 5f64 7572 6174 696f 6e20 3c20   old_duration < 
+0002ff20: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0002ff30: 2020 2074 732e 7072 6566 6978 2e64 7572     ts.prefix.dur
+0002ff40: 6174 696f 6e5f 6176 6572 6167 6520 3d20  ation_average = 
+0002ff50: 636f 6d70 7574 655f 6475 7261 7469 6f6e  compute_duration
+0002ff60: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0002ff70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002ff80: 2020 2074 732e 7072 6566 6978 2e64 7572     ts.prefix.dur
+0002ff90: 6174 696f 6e5f 6176 6572 6167 6520 3d20  ation_average = 
+0002ffa0: 286f 6c64 5f64 7572 6174 696f 6e20 2b20  (old_duration + 
+0002ffb0: 636f 6d70 7574 655f 6475 7261 7469 6f6e  compute_duration
+0002ffc0: 2920 2f20 320a 0a20 2020 2020 2020 2077  ) / 2..        w
+0002ffd0: 732e 6164 645f 746f 5f6c 6f6e 675f 7275  s.add_to_long_ru
+0002ffe0: 6e6e 696e 6728 7473 290a 2020 2020 2020  nning(ts).      
+0002fff0: 2020 7365 6c66 2e63 6865 636b 5f69 646c    self.check_idl
+00030000: 655f 7361 7475 7261 7465 6428 7773 290a  e_saturated(ws).
+00030010: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00030020: 696d 756c 7573 5f71 7565 7565 5f73 6c6f  imulus_queue_slo
+00030030: 7473 5f6d 6179 6265 5f6f 7065 6e65 6428  ts_maybe_opened(
+00030040: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+00030050: 756c 7573 5f69 6429 0a0a 2020 2020 6465  ulus_id)..    de
+00030060: 6620 6861 6e64 6c65 5f77 6f72 6b65 725f  f handle_worker_
+00030070: 7374 6174 7573 5f63 6861 6e67 6528 0a20  status_change(. 
+00030080: 2020 2020 2020 2073 656c 662c 2073 7461         self, sta
+00030090: 7475 733a 2073 7472 207c 2053 7461 7475  tus: str | Statu
+000300a0: 732c 2077 6f72 6b65 723a 2073 7472 207c  s, worker: str |
+000300b0: 2057 6f72 6b65 7253 7461 7465 2c20 7374   WorkerState, st
+000300c0: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+000300d0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+000300e0: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
+000300f0: 776f 726b 6572 732e 6765 7428 776f 726b  workers.get(work
+00030100: 6572 2920 6966 2069 7369 6e73 7461 6e63  er) if isinstanc
+00030110: 6528 776f 726b 6572 2c20 7374 7229 2065  e(worker, str) e
+00030120: 6c73 6520 776f 726b 6572 0a20 2020 2020  lse worker.     
+00030130: 2020 2069 6620 6e6f 7420 7773 3a0a 2020     if not ws:.  
+00030140: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00030150: 0a20 2020 2020 2020 2070 7265 765f 7374  .        prev_st
+00030160: 6174 7573 203d 2077 732e 7374 6174 7573  atus = ws.status
+00030170: 0a20 2020 2020 2020 2077 732e 7374 6174  .        ws.stat
+00030180: 7573 203d 2053 7461 7475 735b 7374 6174  us = Status[stat
+00030190: 7573 5d20 6966 2069 7369 6e73 7461 6e63  us] if isinstanc
+000301a0: 6528 7374 6174 7573 2c20 7374 7229 2065  e(status, str) e
+000301b0: 6c73 6520 7374 6174 7573 0a20 2020 2020  lse status.     
+000301c0: 2020 2069 6620 7773 2e73 7461 7475 7320     if ws.status 
+000301d0: 3d3d 2070 7265 765f 7374 6174 7573 3a0a  == prev_status:.
+000301e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000301f0: 726e 0a0a 2020 2020 2020 2020 7365 6c66  rn..        self
+00030200: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
+00030210: 2020 2020 2020 2020 7773 2e61 6464 7265          ws.addre
+00030220: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+00030230: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00030240: 2020 2261 6374 696f 6e22 3a20 2277 6f72    "action": "wor
+00030250: 6b65 722d 7374 6174 7573 2d63 6861 6e67  ker-status-chang
+00030260: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00030270: 2020 2020 2270 7265 762d 7374 6174 7573      "prev-status
+00030280: 223a 2070 7265 765f 7374 6174 7573 2e6e  ": prev_status.n
+00030290: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+000302a0: 2020 2020 2022 7374 6174 7573 223a 2077       "status": w
+000302b0: 732e 7374 6174 7573 2e6e 616d 652c 0a20  s.status.name,. 
+000302c0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+000302d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000302e0: 6c6f 6767 6572 2e64 6562 7567 2866 2257  logger.debug(f"W
+000302f0: 6f72 6b65 7220 7374 6174 7573 207b 7072  orker status {pr
+00030300: 6576 5f73 7461 7475 732e 6e61 6d65 7d20  ev_status.name} 
+00030310: 2d3e 207b 7374 6174 7573 7d20 2d20 7b77  -> {status} - {w
+00030320: 737d 2229 0a0a 2020 2020 2020 2020 6966  s}")..        if
+00030330: 2077 732e 7374 6174 7573 203d 3d20 5374   ws.status == St
+00030340: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
+00030350: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00030360: 756e 6e69 6e67 2e61 6464 2877 7329 0a20  unning.add(ws). 
+00030370: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00030380: 6368 6563 6b5f 6964 6c65 5f73 6174 7572  check_idle_satur
+00030390: 6174 6564 2877 7329 0a20 2020 2020 2020  ated(ws).       
+000303a0: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
+000303b0: 7469 6f6e 7328 0a20 2020 2020 2020 2020  tions(.         
+000303c0: 2020 2020 2020 2073 656c 662e 6275 6c6b         self.bulk
+000303d0: 5f73 6368 6564 756c 655f 756e 7275 6e6e  _schedule_unrunn
+000303e0: 6162 6c65 5f61 6674 6572 5f61 6464 696e  able_after_addin
+000303f0: 675f 776f 726b 6572 2877 7329 2c20 7374  g_worker(ws), st
+00030400: 696d 756c 7573 5f69 640a 2020 2020 2020  imulus_id.      
+00030410: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00030420: 2020 2020 7365 6c66 2e73 7469 6d75 6c75      self.stimulu
+00030430: 735f 7175 6575 655f 736c 6f74 735f 6d61  s_queue_slots_ma
+00030440: 7962 655f 6f70 656e 6564 2873 7469 6d75  ybe_opened(stimu
+00030450: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+00030460: 6964 290a 2020 2020 2020 2020 656c 7365  id).        else
+00030470: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00030480: 6c66 2e72 756e 6e69 6e67 2e64 6973 6361  lf.running.disca
+00030490: 7264 2877 7329 0a20 2020 2020 2020 2020  rd(ws).         
+000304a0: 2020 2073 656c 662e 6964 6c65 2e70 6f70     self.idle.pop
+000304b0: 2877 732e 6164 6472 6573 732c 204e 6f6e  (ws.address, Non
+000304c0: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+000304d0: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
+000304e0: 756e 742e 6469 7363 6172 6428 7773 290a  unt.discard(ws).
+000304f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00030500: 2e73 6174 7572 6174 6564 2e64 6973 6361  .saturated.disca
+00030510: 7264 2877 7329 0a0a 2020 2020 6173 796e  rd(ws)..    asyn
+00030520: 6320 6465 6620 6861 6e64 6c65 5f72 6571  c def handle_req
+00030530: 7565 7374 5f72 6566 7265 7368 5f77 686f  uest_refresh_who
+00030540: 5f68 6173 280a 2020 2020 2020 2020 7365  _has(.        se
+00030550: 6c66 2c20 6b65 7973 3a20 4974 6572 6162  lf, keys: Iterab
+00030560: 6c65 5b73 7472 5d2c 2077 6f72 6b65 723a  le[str], worker:
+00030570: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00030580: 643a 2073 7472 0a20 2020 2029 202d 3e20  d: str.    ) -> 
+00030590: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+000305a0: 2241 7379 6e63 6872 6f6e 6f75 7320 7265  "Asynchronous re
+000305b0: 7175 6573 7420 2874 6872 6f75 6768 2062  quest (through b
+000305c0: 756c 6b20 636f 6d6d 7329 2066 726f 6d20  ulk comms) from 
+000305d0: 6120 576f 726b 6572 2074 6f20 7265 6672  a Worker to refr
+000305e0: 6573 6820 7468 650a 2020 2020 2020 2020  esh the.        
+000305f0: 7768 6f5f 6861 7320 666f 7220 736f 6d65  who_has for some
+00030600: 206b 6579 732e 204e 6f74 2074 6f20 6265   keys. Not to be
+00030610: 2063 6f6e 6675 7365 6420 7769 7468 2073   confused with s
+00030620: 6368 6564 756c 6572 2e77 686f 5f68 6173  cheduler.who_has
+00030630: 2c20 7768 6963 6820 6973 2061 0a20 2020  , which is a.   
+00030640: 2020 2020 2073 796e 6368 726f 6e6f 7573       synchronous
+00030650: 2052 5043 2072 6571 7565 7374 2066 726f   RPC request fro
+00030660: 6d20 6120 436c 6965 6e74 2e0a 2020 2020  m a Client..    
+00030670: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00030680: 7768 6f5f 6861 7320 3d20 7b7d 0a20 2020  who_has = {}.   
+00030690: 2020 2020 2066 7265 655f 6b65 7973 203d       free_keys =
+000306a0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+000306b0: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
+000306c0: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+000306d0: 696e 2073 656c 662e 7461 736b 733a 0a20  in self.tasks:. 
+000306e0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000306f0: 686f 5f68 6173 5b6b 6579 5d20 3d20 5b77  ho_has[key] = [w
+00030700: 732e 6164 6472 6573 7320 666f 7220 7773  s.address for ws
+00030710: 2069 6e20 7365 6c66 2e74 6173 6b73 5b6b   in self.tasks[k
+00030720: 6579 5d2e 7768 6f5f 6861 735d 0a20 2020  ey].who_has].   
+00030730: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00030740: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00030750: 7265 655f 6b65 7973 2e61 7070 656e 6428  ree_keys.append(
+00030760: 6b65 7929 0a0a 2020 2020 2020 2020 6966  key)..        if
+00030770: 2077 686f 5f68 6173 3a0a 2020 2020 2020   who_has:.      
+00030780: 2020 2020 2020 7365 6c66 2e73 7472 6561        self.strea
+00030790: 6d5f 636f 6d6d 735b 776f 726b 6572 5d2e  m_comms[worker].
+000307a0: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
+000307b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000307c0: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
+000307d0: 3a20 2272 6566 7265 7368 2d77 686f 2d68  : "refresh-who-h
+000307e0: 6173 222c 0a20 2020 2020 2020 2020 2020  as",.           
+000307f0: 2020 2020 2020 2020 2022 7768 6f5f 6861           "who_ha
+00030800: 7322 3a20 7768 6f5f 6861 732c 0a20 2020  s": who_has,.   
+00030810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030820: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+00030830: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+00030840: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00030850: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00030860: 2020 2020 2069 6620 6672 6565 5f6b 6579       if free_key
+00030870: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+00030880: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
+00030890: 5b77 6f72 6b65 725d 2e73 656e 6428 0a20  [worker].send(. 
+000308a0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+000308b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000308c0: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
+000308d0: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
+000308e0: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+000308f0: 7322 3a20 6672 6565 5f6b 6579 732c 0a20  s": free_keys,. 
+00030900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030910: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
+00030920: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
+00030930: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00030940: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00030950: 2020 2020 6173 796e 6320 6465 6620 6861      async def ha
+00030960: 6e64 6c65 5f77 6f72 6b65 7228 7365 6c66  ndle_worker(self
+00030970: 2c20 636f 6d6d 3a20 436f 6d6d 2c20 776f  , comm: Comm, wo
+00030980: 726b 6572 3a20 7374 7229 202d 3e20 4e6f  rker: str) -> No
+00030990: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
+000309a0: 2020 2020 2020 2020 4c69 7374 656e 2074          Listen t
+000309b0: 6f20 7265 7370 6f6e 7365 7320 6672 6f6d  o responses from
+000309c0: 2061 2073 696e 676c 6520 776f 726b 6572   a single worker
+000309d0: 0a0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
+000309e0: 7320 7468 6520 6d61 696e 206c 6f6f 7020  s the main loop 
+000309f0: 666f 7220 7363 6865 6475 6c65 722d 776f  for scheduler-wo
+00030a00: 726b 6572 2069 6e74 6572 6163 7469 6f6e  rker interaction
+00030a10: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
+00030a20: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+00030a30: 2d2d 2d0a 2020 2020 2020 2020 5363 6865  ---.        Sche
+00030a40: 6475 6c65 722e 6861 6e64 6c65 5f63 6c69  duler.handle_cli
+00030a50: 656e 743a 2045 7175 6976 616c 656e 7420  ent: Equivalent 
+00030a60: 636f 726f 7574 696e 6520 666f 7220 636c  coroutine for cl
+00030a70: 6965 6e74 730a 2020 2020 2020 2020 2222  ients.        ""
+00030a80: 220a 2020 2020 2020 2020 636f 6d6d 2e6e  ".        comm.n
+00030a90: 616d 6520 3d20 2253 6368 6564 756c 6572  ame = "Scheduler
+00030aa0: 2063 6f6e 6e65 6374 696f 6e20 746f 2077   connection to w
+00030ab0: 6f72 6b65 7222 0a20 2020 2020 2020 2077  orker".        w
+00030ac0: 6f72 6b65 725f 636f 6d6d 203d 2073 656c  orker_comm = sel
+00030ad0: 662e 7374 7265 616d 5f63 6f6d 6d73 5b77  f.stream_comms[w
+00030ae0: 6f72 6b65 725d 0a20 2020 2020 2020 2077  orker].        w
+00030af0: 6f72 6b65 725f 636f 6d6d 2e73 7461 7274  orker_comm.start
+00030b00: 2863 6f6d 6d29 0a20 2020 2020 2020 206c  (comm).        l
+00030b10: 6f67 6765 722e 696e 666f 2822 5374 6172  ogger.info("Star
+00030b20: 7469 6e67 2077 6f72 6b65 7220 636f 6d70  ting worker comp
+00030b30: 7574 6520 7374 7265 616d 2c20 2573 222c  ute stream, %s",
+00030b40: 2077 6f72 6b65 7229 0a20 2020 2020 2020   worker).       
+00030b50: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00030b60: 2020 6177 6169 7420 7365 6c66 2e68 616e    await self.han
+00030b70: 646c 655f 7374 7265 616d 2863 6f6d 6d3d  dle_stream(comm=
+00030b80: 636f 6d6d 2c20 6578 7472 613d 7b22 776f  comm, extra={"wo
+00030b90: 726b 6572 223a 2077 6f72 6b65 727d 290a  rker": worker}).
+00030ba0: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
+00030bb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00030bc0: 776f 726b 6572 2069 6e20 7365 6c66 2e73  worker in self.s
+00030bd0: 7472 6561 6d5f 636f 6d6d 733a 0a20 2020  tream_comms:.   
+00030be0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+00030bf0: 6b65 725f 636f 6d6d 2e61 626f 7274 2829  ker_comm.abort()
+00030c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030c10: 2061 7761 6974 2073 656c 662e 7265 6d6f   await self.remo
+00030c20: 7665 5f77 6f72 6b65 7228 0a20 2020 2020  ve_worker(.     
+00030c30: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00030c40: 6f72 6b65 722c 2073 7469 6d75 6c75 735f  orker, stimulus_
+00030c50: 6964 3d66 2268 616e 646c 652d 776f 726b  id=f"handle-work
+00030c60: 6572 2d63 6c65 616e 7570 2d7b 7469 6d65  er-cleanup-{time
+00030c70: 2829 7d22 0a20 2020 2020 2020 2020 2020  ()}".           
+00030c80: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00030c90: 6164 645f 706c 7567 696e 280a 2020 2020  add_plugin(.    
+00030ca0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00030cb0: 2020 706c 7567 696e 3a20 5363 6865 6475    plugin: Schedu
+00030cc0: 6c65 7250 6c75 6769 6e2c 0a20 2020 2020  lerPlugin,.     
+00030cd0: 2020 202a 2c0a 2020 2020 2020 2020 6964     *,.        id
+00030ce0: 656d 706f 7465 6e74 3a20 626f 6f6c 203d  empotent: bool =
+00030cf0: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
+00030d00: 6e61 6d65 3a20 7374 7220 7c20 4e6f 6e65  name: str | None
+00030d10: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00030d20: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+00030d30: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+00030d40: 2020 2020 2020 2022 2222 4164 6420 6578         """Add ex
+00030d50: 7465 726e 616c 2070 6c75 6769 6e20 746f  ternal plugin to
+00030d60: 2073 6368 6564 756c 6572 2e0a 0a20 2020   scheduler...   
+00030d70: 2020 2020 2053 6565 2068 7474 7073 3a2f       See https:/
+00030d80: 2f64 6973 7472 6962 7574 6564 2e72 6561  /distributed.rea
+00030d90: 6474 6865 646f 6373 2e69 6f2f 656e 2f6c  dthedocs.io/en/l
+00030da0: 6174 6573 742f 706c 7567 696e 732e 6874  atest/plugins.ht
+00030db0: 6d6c 0a0a 2020 2020 2020 2020 5061 7261  ml..        Para
+00030dc0: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
+00030dd0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
+00030de0: 2020 706c 7567 696e 203a 2053 6368 6564    plugin : Sched
+00030df0: 756c 6572 506c 7567 696e 0a20 2020 2020  ulerPlugin.     
+00030e00: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
+00030e10: 506c 7567 696e 2069 6e73 7461 6e63 6520  Plugin instance 
+00030e20: 746f 2061 6464 0a20 2020 2020 2020 2069  to add.        i
+00030e30: 6465 6d70 6f74 656e 7420 3a20 626f 6f6c  dempotent : bool
+00030e40: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
+00030e50: 7472 7565 2c20 7468 6520 706c 7567 696e  true, the plugin
+00030e60: 2069 7320 6173 7375 6d65 6420 746f 2061   is assumed to a
+00030e70: 6c72 6561 6479 2065 7869 7374 2061 6e64  lready exist and
+00030e80: 206e 6f0a 2020 2020 2020 2020 2020 2020   no.            
+00030e90: 6163 7469 6f6e 2069 7320 7461 6b65 6e2e  action is taken.
+00030ea0: 0a20 2020 2020 2020 206e 616d 6520 3a20  .        name : 
+00030eb0: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
+00030ec0: 4120 6e61 6d65 2066 6f72 2074 6865 2070  A name for the p
+00030ed0: 6c75 6769 6e2c 2069 6620 4e6f 6e65 2c20  lugin, if None, 
+00030ee0: 7468 6520 6e61 6d65 2061 7474 7269 6275  the name attribu
+00030ef0: 7465 2069 730a 2020 2020 2020 2020 2020  te is.          
+00030f00: 2020 6368 6563 6b65 6420 6f6e 2074 6865    checked on the
+00030f10: 2050 6c75 6769 6e20 696e 7374 616e 6365   Plugin instance
+00030f20: 2061 6e64 2067 656e 6572 6174 6564 2069   and generated i
+00030f30: 6620 6e6f 740a 2020 2020 2020 2020 2020  f not.          
+00030f40: 2020 6469 7363 6f76 6572 6564 2e0a 2020    discovered..  
+00030f50: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00030f60: 2020 6966 206e 616d 6520 6973 204e 6f6e    if name is Non
+00030f70: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+00030f80: 616d 6520 3d20 5f67 6574 5f70 6c75 6769  ame = _get_plugi
+00030f90: 6e5f 6e61 6d65 2870 6c75 6769 6e29 0a0a  n_name(plugin)..
+00030fa0: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
+00030fb0: 696e 2073 656c 662e 706c 7567 696e 733a  in self.plugins:
+00030fc0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00030fd0: 6964 656d 706f 7465 6e74 3a0a 2020 2020  idempotent:.    
+00030fe0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00030ff0: 726e 0a20 2020 2020 2020 2020 2020 2077  rn.            w
+00031000: 6172 6e69 6e67 732e 7761 726e 280a 2020  arnings.warn(.  
+00031010: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00031020: 5363 6865 6475 6c65 7220 616c 7265 6164  Scheduler alread
+00031030: 7920 636f 6e74 6169 6e73 2061 2070 6c75  y contains a plu
+00031040: 6769 6e20 7769 7468 206e 616d 6520 7b6e  gin with name {n
+00031050: 616d 657d 3b20 6f76 6572 7772 6974 696e  ame}; overwritin
+00031060: 672e 222c 0a20 2020 2020 2020 2020 2020  g.",.           
+00031070: 2020 2020 2063 6174 6567 6f72 793d 5573       category=Us
+00031080: 6572 5761 726e 696e 672c 0a20 2020 2020  erWarning,.     
+00031090: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000310a0: 2020 7365 6c66 2e70 6c75 6769 6e73 5b6e    self.plugins[n
+000310b0: 616d 655d 203d 2070 6c75 6769 6e0a 0a20  ame] = plugin.. 
+000310c0: 2020 2064 6566 2072 656d 6f76 655f 706c     def remove_pl
+000310d0: 7567 696e 280a 2020 2020 2020 2020 7365  ugin(.        se
+000310e0: 6c66 2c0a 2020 2020 2020 2020 6e61 6d65  lf,.        name
+000310f0: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+00031100: 6f6e 652c 0a20 2020 2020 2020 2070 6c75  one,.        plu
+00031110: 6769 6e3a 2053 6368 6564 756c 6572 506c  gin: SchedulerPl
+00031120: 7567 696e 207c 204e 6f6e 6520 3d20 4e6f  ugin | None = No
+00031130: 6e65 2c0a 2020 2020 2920 2d3e 204e 6f6e  ne,.    ) -> Non
+00031140: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
+00031150: 6d6f 7665 2065 7874 6572 6e61 6c20 706c  move external pl
+00031160: 7567 696e 2066 726f 6d20 7363 6865 6475  ugin from schedu
+00031170: 6c65 720a 0a20 2020 2020 2020 2050 6172  ler..        Par
+00031180: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+00031190: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+000311a0: 2020 206e 616d 6520 3a20 7374 720a 2020     name : str.  
+000311b0: 2020 2020 2020 2020 2020 4e61 6d65 206f            Name o
+000311c0: 6620 7468 6520 706c 7567 696e 2074 6f20  f the plugin to 
+000311d0: 7265 6d6f 7665 0a20 2020 2020 2020 2022  remove.        "
+000311e0: 2222 0a20 2020 2020 2020 2061 7373 6572  "".        asser
+000311f0: 7420 6e61 6d65 2069 7320 6e6f 7420 4e6f  t name is not No
+00031200: 6e65 0a0a 2020 2020 2020 2020 7472 793a  ne..        try:
+00031210: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
+00031220: 2073 656c 662e 706c 7567 696e 735b 6e61   self.plugins[na
+00031230: 6d65 5d0a 2020 2020 2020 2020 6578 6365  me].        exce
+00031240: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+00031250: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00031260: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+00031270: 2020 2020 2020 2020 2020 2066 2243 6f75             f"Cou
+00031280: 6c64 206e 6f74 2066 696e 6420 706c 7567  ld not find plug
+00031290: 696e 207b 6e61 6d65 2172 7d20 616d 6f6e  in {name!r} amon
+000312a0: 6720 7468 6520 6375 7272 656e 7420 7363  g the current sc
+000312b0: 6865 6475 6c65 7220 706c 7567 696e 7322  heduler plugins"
+000312c0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+000312d0: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
+000312e0: 6769 7374 6572 5f73 6368 6564 756c 6572  gister_scheduler
+000312f0: 5f70 6c75 6769 6e28 0a20 2020 2020 2020  _plugin(.       
+00031300: 2073 656c 662c 0a20 2020 2020 2020 2070   self,.        p
+00031310: 6c75 6769 6e3a 2062 7974 6573 207c 2053  lugin: bytes | S
+00031320: 6368 6564 756c 6572 506c 7567 696e 2c0a  chedulerPlugin,.
+00031330: 2020 2020 2020 2020 6e61 6d65 3a20 7374          name: st
+00031340: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+00031350: 0a20 2020 2020 2020 2069 6465 6d70 6f74  .        idempot
+00031360: 656e 743a 2062 6f6f 6c20 3d20 4661 6c73  ent: bool = Fals
+00031370: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
+00031380: 3a0a 2020 2020 2020 2020 2222 2252 6567  :.        """Reg
+00031390: 6973 7465 7220 6120 706c 7567 696e 206f  ister a plugin o
+000313a0: 6e20 7468 6520 7363 6865 6475 6c65 722e  n the scheduler.
+000313b0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
+000313c0: 6f74 2064 6173 6b2e 636f 6e66 6967 2e67  ot dask.config.g
+000313d0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+000313e0: 7363 6865 6475 6c65 722e 7069 636b 6c65  scheduler.pickle
+000313f0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00031400: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00031410: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00031420: 2020 2243 616e 6e6f 7420 7265 6769 7374    "Cannot regist
+00031430: 6572 2061 2073 6368 6564 756c 6572 2070  er a scheduler p
+00031440: 6c75 6769 6e20 6173 2074 6865 2073 6368  lugin as the sch
+00031450: 6564 756c 6572 2022 0a20 2020 2020 2020  eduler ".       
+00031460: 2020 2020 2020 2020 2022 6861 7320 6265           "has be
+00031470: 656e 2065 7870 6c69 6369 746c 7920 6469  en explicitly di
+00031480: 7361 6c6c 6f77 6564 2066 726f 6d20 6465  sallowed from de
+00031490: 7365 7269 616c 697a 696e 6720 220a 2020  serializing ".  
+000314a0: 2020 2020 2020 2020 2020 2020 2020 2261                "a
+000314b0: 7262 6974 7261 7279 2062 7974 6573 7472  rbitrary bytestr
+000314c0: 696e 6773 2075 7369 6e67 2070 6963 6b6c  ings using pickl
+000314d0: 6520 7669 6120 7468 6520 220a 2020 2020  e via the ".    
+000314e0: 2020 2020 2020 2020 2020 2020 2227 6469              "'di
+000314f0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+00031500: 6c65 722e 7069 636b 6c65 2720 636f 6e66  ler.pickle' conf
+00031510: 6967 7572 6174 696f 6e20 7365 7474 696e  iguration settin
+00031520: 672e 220a 2020 2020 2020 2020 2020 2020  g.".            
+00031530: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00031540: 2069 7369 6e73 7461 6e63 6528 706c 7567   isinstance(plug
+00031550: 696e 2c20 5363 6865 6475 6c65 7250 6c75  in, SchedulerPlu
+00031560: 6769 6e29 3a0a 2020 2020 2020 2020 2020  gin):.          
+00031570: 2020 706c 7567 696e 203d 206c 6f61 6473    plugin = loads
+00031580: 2870 6c75 6769 6e29 0a20 2020 2020 2020  (plugin).       
+00031590: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+000315a0: 7374 616e 6365 2870 6c75 6769 6e2c 2053  stance(plugin, S
+000315b0: 6368 6564 756c 6572 506c 7567 696e 290a  chedulerPlugin).
+000315c0: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
+000315d0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000315e0: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
+000315f0: 745f 706c 7567 696e 5f6e 616d 6528 706c  t_plugin_name(pl
+00031600: 7567 696e 290a 0a20 2020 2020 2020 2069  ugin)..        i
+00031610: 6620 6e61 6d65 2069 6e20 7365 6c66 2e70  f name in self.p
+00031620: 6c75 6769 6e73 2061 6e64 2069 6465 6d70  lugins and idemp
+00031630: 6f74 656e 743a 0a20 2020 2020 2020 2020  otent:.         
+00031640: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+00031650: 2020 2069 6620 6861 7361 7474 7228 706c     if hasattr(pl
+00031660: 7567 696e 2c20 2273 7461 7274 2229 3a0a  ugin, "start"):.
+00031670: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00031680: 6c74 203d 2070 6c75 6769 6e2e 7374 6172  lt = plugin.star
+00031690: 7428 7365 6c66 290a 2020 2020 2020 2020  t(self).        
+000316a0: 2020 2020 6966 2069 6e73 7065 6374 2e69      if inspect.i
+000316b0: 7361 7761 6974 6162 6c65 2872 6573 756c  sawaitable(resul
+000316c0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+000316d0: 2020 2020 6177 6169 7420 7265 7375 6c74      await result
+000316e0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+000316f0: 6464 5f70 6c75 6769 6e28 706c 7567 696e  dd_plugin(plugin
+00031700: 2c20 6e61 6d65 3d6e 616d 652c 2069 6465  , name=name, ide
+00031710: 6d70 6f74 656e 743d 6964 656d 706f 7465  mpotent=idempote
+00031720: 6e74 290a 0a20 2020 2064 6566 2077 6f72  nt)..    def wor
+00031730: 6b65 725f 7365 6e64 2873 656c 662c 2077  ker_send(self, w
+00031740: 6f72 6b65 723a 2073 7472 2c20 6d73 673a  orker: str, msg:
+00031750: 2064 6963 745b 7374 722c 2041 6e79 5d29   dict[str, Any])
+00031760: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00031770: 2020 2222 2253 656e 6420 6d65 7373 6167    """Send messag
+00031780: 6520 746f 2077 6f72 6b65 720a 0a20 2020  e to worker..   
+00031790: 2020 2020 2054 6869 7320 616c 736f 2068       This also h
+000317a0: 616e 646c 6573 2063 6f6e 6e65 6374 696f  andles connectio
+000317b0: 6e20 6661 696c 7572 6573 2062 7920 6164  n failures by ad
+000317c0: 6469 6e67 2061 2063 616c 6c62 6163 6b20  ding a callback 
+000317d0: 746f 2072 656d 6f76 650a 2020 2020 2020  to remove.      
+000317e0: 2020 7468 6520 776f 726b 6572 206f 6e20    the worker on 
+000317f0: 7468 6520 6e65 7874 2063 7963 6c65 2e0a  the next cycle..
+00031800: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00031810: 2020 2020 7374 7265 616d 5f63 6f6d 6d73      stream_comms
+00031820: 3a20 6469 6374 203d 2073 656c 662e 7374  : dict = self.st
+00031830: 7265 616d 5f63 6f6d 6d73 0a20 2020 2020  ream_comms.     
+00031840: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00031850: 2020 2020 7374 7265 616d 5f63 6f6d 6d73      stream_comms
+00031860: 5b77 6f72 6b65 725d 2e73 656e 6428 6d73  [worker].send(ms
+00031870: 6729 0a20 2020 2020 2020 2065 7863 6570  g).        excep
+00031880: 7420 2843 6f6d 6d43 6c6f 7365 6445 7272  t (CommClosedErr
+00031890: 6f72 2c20 4174 7472 6962 7574 6545 7272  or, AttributeErr
+000318a0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000318b0: 2073 656c 662e 5f6f 6e67 6f69 6e67 5f62   self._ongoing_b
+000318c0: 6163 6b67 726f 756e 645f 7461 736b 732e  ackground_tasks.
+000318d0: 6361 6c6c 5f73 6f6f 6e28 0a20 2020 2020  call_soon(.     
+000318e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000318f0: 7265 6d6f 7665 5f77 6f72 6b65 722c 0a20  remove_worker,. 
+00031900: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00031910: 6464 7265 7373 3d77 6f72 6b65 722c 0a20  ddress=worker,. 
+00031920: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00031930: 7469 6d75 6c75 735f 6964 3d66 2277 6f72  timulus_id=f"wor
+00031940: 6b65 722d 7365 6e64 2d63 6f6d 6d2d 6661  ker-send-comm-fa
+00031950: 696c 2d7b 7469 6d65 2829 7d22 2c0a 2020  il-{time()}",.  
+00031960: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00031970: 2064 6566 2063 6c69 656e 745f 7365 6e64   def client_send
+00031980: 2873 656c 662c 2063 6c69 656e 742c 206d  (self, client, m
+00031990: 7367 293a 0a20 2020 2020 2020 2022 2222  sg):.        """
+000319a0: 5365 6e64 206d 6573 7361 6765 2074 6f20  Send message to 
+000319b0: 636c 6965 6e74 2222 220a 2020 2020 2020  client""".      
+000319c0: 2020 636c 6965 6e74 5f63 6f6d 6d73 3a20    client_comms: 
+000319d0: 6469 6374 203d 2073 656c 662e 636c 6965  dict = self.clie
+000319e0: 6e74 5f63 6f6d 6d73 0a20 2020 2020 2020  nt_comms.       
+000319f0: 2063 203d 2063 6c69 656e 745f 636f 6d6d   c = client_comm
+00031a00: 732e 6765 7428 636c 6965 6e74 290a 2020  s.get(client).  
+00031a10: 2020 2020 2020 6966 2063 2069 7320 4e6f        if c is No
+00031a20: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00031a30: 7265 7475 726e 0a20 2020 2020 2020 2074  return.        t
+00031a40: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00031a50: 632e 7365 6e64 286d 7367 290a 2020 2020  c.send(msg).    
+00031a60: 2020 2020 6578 6365 7074 2043 6f6d 6d43      except CommC
+00031a70: 6c6f 7365 6445 7272 6f72 3a0a 2020 2020  losedError:.    
+00031a80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00031a90: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+00031aa0: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
+00031ab0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00031ac0: 2e63 7269 7469 6361 6c28 0a20 2020 2020  .critical(.     
+00031ad0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00031ae0: 436c 6f73 6564 2063 6f6d 6d20 2572 2077  Closed comm %r w
+00031af0: 6869 6c65 2074 7279 696e 6720 746f 2077  hile trying to w
+00031b00: 7269 7465 2025 7322 2c20 632c 206d 7367  rite %s", c, msg
+00031b10: 2c20 6578 635f 696e 666f 3d54 7275 650a  , exc_info=True.
+00031b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b30: 290a 0a20 2020 2064 6566 2073 656e 645f  )..    def send_
+00031b40: 616c 6c28 7365 6c66 2c20 636c 6965 6e74  all(self, client
+00031b50: 5f6d 7367 733a 204d 7367 732c 2077 6f72  _msgs: Msgs, wor
+00031b60: 6b65 725f 6d73 6773 3a20 4d73 6773 2920  ker_msgs: Msgs) 
+00031b70: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00031b80: 2022 2222 5365 6e64 206d 6573 7361 6765   """Send message
+00031b90: 7320 746f 2063 6c69 656e 7420 616e 6420  s to client and 
+00031ba0: 776f 726b 6572 7322 2222 0a0a 2020 2020  workers"""..    
+00031bb0: 2020 2020 666f 7220 636c 6965 6e74 2c20      for client, 
+00031bc0: 6d73 6773 2069 6e20 636c 6965 6e74 5f6d  msgs in client_m
+00031bd0: 7367 732e 6974 656d 7328 293a 0a20 2020  sgs.items():.   
+00031be0: 2020 2020 2020 2020 2063 203d 2073 656c           c = sel
+00031bf0: 662e 636c 6965 6e74 5f63 6f6d 6d73 2e67  f.client_comms.g
+00031c00: 6574 2863 6c69 656e 7429 0a20 2020 2020  et(client).     
+00031c10: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
+00031c20: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00031c30: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00031c40: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00031c50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00031c60: 2e73 656e 6428 2a6d 7367 7329 0a20 2020  .send(*msgs).   
+00031c70: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00031c80: 436f 6d6d 436c 6f73 6564 4572 726f 723a  CommClosedError:
+00031c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031ca0: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
+00031cb0: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
+00031cc0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+00031cd0: 2020 2020 2020 206c 6f67 6765 722e 6372         logger.cr
+00031ce0: 6974 6963 616c 280a 2020 2020 2020 2020  itical(.        
+00031cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d00: 2243 6c6f 7365 6420 636f 6d6d 2025 7220  "Closed comm %r 
+00031d10: 7768 696c 6520 7472 7969 6e67 2074 6f20  while trying to 
+00031d20: 7772 6974 6520 2573 222c 0a20 2020 2020  write %s",.     
+00031d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d40: 2020 2063 2c0a 2020 2020 2020 2020 2020     c,.          
+00031d50: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00031d60: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+00031d70: 2020 2020 2020 2020 2020 2020 6578 635f              exc_
+00031d80: 696e 666f 3d54 7275 652c 0a20 2020 2020  info=True,.     
+00031d90: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00031da0: 0a0a 2020 2020 2020 2020 666f 7220 776f  ..        for wo
+00031db0: 726b 6572 2c20 6d73 6773 2069 6e20 776f  rker, msgs in wo
+00031dc0: 726b 6572 5f6d 7367 732e 6974 656d 7328  rker_msgs.items(
+00031dd0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00031de0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00031df0: 2020 2020 7720 3d20 7365 6c66 2e73 7472      w = self.str
+00031e00: 6561 6d5f 636f 6d6d 735b 776f 726b 6572  eam_comms[worker
+00031e10: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00031e20: 2020 772e 7365 6e64 282a 6d73 6773 290a    w.send(*msgs).
+00031e30: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00031e40: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+00031e50: 2020 2020 2020 2020 2020 2020 2023 2077               # w
+00031e60: 6f72 6b65 7220 616c 7265 6164 7920 676f  orker already go
+00031e70: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+00031e80: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+00031e90: 2020 2020 6578 6365 7074 2028 436f 6d6d      except (Comm
+00031ea0: 436c 6f73 6564 4572 726f 722c 2041 7474  ClosedError, Att
+00031eb0: 7269 6275 7465 4572 726f 7229 3a0a 2020  ributeError):.  
+00031ec0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00031ed0: 6c66 2e5f 6f6e 676f 696e 675f 6261 636b  lf._ongoing_back
+00031ee0: 6772 6f75 6e64 5f74 6173 6b73 2e63 616c  ground_tasks.cal
+00031ef0: 6c5f 736f 6f6e 280a 2020 2020 2020 2020  l_soon(.        
+00031f00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00031f10: 2e72 656d 6f76 655f 776f 726b 6572 2c0a  .remove_worker,.
+00031f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031f30: 2020 2020 6164 6472 6573 733d 776f 726b      address=work
+00031f40: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00031f50: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+00031f60: 5f69 643d 6622 7365 6e64 2d61 6c6c 2d63  _id=f"send-all-c
+00031f70: 6f6d 6d2d 6661 696c 2d7b 7469 6d65 2829  omm-fail-{time()
+00031f80: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
+00031f90: 2020 2020 290a 0a20 2020 2023 2323 2323      )..    #####
+00031fa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00031fb0: 2323 2323 2323 230a 2020 2020 2320 4c65  #######.    # Le
+00031fc0: 7373 2063 6f6d 6d6f 6e20 696e 7465 7261  ss common intera
+00031fd0: 6374 696f 6e73 2023 0a20 2020 2023 2323  ctions #.    ###
+00031fe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00031ff0: 2323 2323 2323 2323 230a 0a20 2020 2061  #########..    a
+00032000: 7379 6e63 2064 6566 2073 6361 7474 6572  sync def scatter
+00032010: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00032020: 2020 2020 2020 2020 636f 6d6d 3d4e 6f6e          comm=Non
+00032030: 652c 0a20 2020 2020 2020 2064 6174 613d  e,.        data=
+00032040: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
+00032050: 726b 6572 733d 4e6f 6e65 2c0a 2020 2020  rkers=None,.    
+00032060: 2020 2020 636c 6965 6e74 3d4e 6f6e 652c      client=None,
+00032070: 0a20 2020 2020 2020 2062 726f 6164 6361  .        broadca
+00032080: 7374 3d46 616c 7365 2c0a 2020 2020 2020  st=False,.      
+00032090: 2020 7469 6d65 6f75 743d 322c 0a20 2020    timeout=2,.   
+000320a0: 2029 3a0a 2020 2020 2020 2020 2222 2253   ):.        """S
+000320b0: 656e 6420 6461 7461 206f 7574 2074 6f20  end data out to 
+000320c0: 776f 726b 6572 730a 0a20 2020 2020 2020  workers..       
+000320d0: 2053 6565 2061 6c73 6f0a 2020 2020 2020   See also.      
+000320e0: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
+000320f0: 2020 2053 6368 6564 756c 6572 2e62 726f     Scheduler.bro
+00032100: 6164 6361 7374 3a0a 2020 2020 2020 2020  adcast:.        
+00032110: 2222 220a 2020 2020 2020 2020 7374 6172  """.        star
+00032120: 7420 3d20 7469 6d65 2829 0a20 2020 2020  t = time().     
+00032130: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+00032140: 2020 2020 2020 2020 2020 2069 6620 776f             if wo
+00032150: 726b 6572 7320 6973 204e 6f6e 653a 0a20  rkers is None:. 
+00032160: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00032170: 7373 203d 2073 656c 662e 7275 6e6e 696e  ss = self.runnin
+00032180: 670a 2020 2020 2020 2020 2020 2020 656c  g.            el
+00032190: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000321a0: 2020 2020 776f 726b 6572 7320 3d20 5b73      workers = [s
+000321b0: 656c 662e 636f 6572 6365 5f61 6464 7265  elf.coerce_addre
+000321c0: 7373 2877 2920 666f 7220 7720 696e 2077  ss(w) for w in w
+000321d0: 6f72 6b65 7273 5d0a 2020 2020 2020 2020  orkers].        
+000321e0: 2020 2020 2020 2020 7773 7320 3d20 7b73          wss = {s
+000321f0: 656c 662e 776f 726b 6572 735b 775d 2066  elf.workers[w] f
+00032200: 6f72 2077 2069 6e20 776f 726b 6572 737d  or w in workers}
+00032210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032220: 2077 7373 203d 207b 7773 2066 6f72 2077   wss = {ws for w
+00032230: 7320 696e 2077 7373 2069 6620 7773 2e73  s in wss if ws.s
+00032240: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+00032250: 7275 6e6e 696e 677d 0a0a 2020 2020 2020  running}..      
+00032260: 2020 2020 2020 6966 2077 7373 3a0a 2020        if wss:.  
+00032270: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00032280: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
+00032290: 6966 2074 696d 6528 2920 3e20 7374 6172  if time() > star
+000322a0: 7420 2b20 7469 6d65 6f75 743a 0a20 2020  t + timeout:.   
+000322b0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+000322c0: 7365 2054 696d 656f 7574 4572 726f 7228  se TimeoutError(
+000322d0: 224e 6f20 7661 6c69 6420 776f 726b 6572  "No valid worker
+000322e0: 7320 666f 756e 6422 290a 2020 2020 2020  s found").      
+000322f0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+00032300: 6369 6f2e 736c 6565 7028 302e 3129 0a0a  cio.sleep(0.1)..
+00032310: 2020 2020 2020 2020 6e74 6872 6561 6473          nthreads
+00032320: 203d 207b 7773 2e61 6464 7265 7373 3a20   = {ws.address: 
+00032330: 7773 2e6e 7468 7265 6164 7320 666f 7220  ws.nthreads for 
+00032340: 7773 2069 6e20 7773 737d 0a0a 2020 2020  ws in wss}..    
+00032350: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00032360: 7461 6e63 6528 6461 7461 2c20 6469 6374  tance(data, dict
+00032370: 290a 0a20 2020 2020 2020 206b 6579 732c  )..        keys,
+00032380: 2077 686f 5f68 6173 2c20 6e62 7974 6573   who_has, nbytes
+00032390: 203d 2061 7761 6974 2073 6361 7474 6572   = await scatter
+000323a0: 5f74 6f5f 776f 726b 6572 7328 6e74 6872  _to_workers(nthr
+000323b0: 6561 6473 2c20 6461 7461 2c20 7270 633d  eads, data, rpc=
+000323c0: 7365 6c66 2e72 7063 290a 0a20 2020 2020  self.rpc)..     
+000323d0: 2020 2073 656c 662e 7570 6461 7465 5f64     self.update_d
+000323e0: 6174 6128 7768 6f5f 6861 733d 7768 6f5f  ata(who_has=who_
+000323f0: 6861 732c 206e 6279 7465 733d 6e62 7974  has, nbytes=nbyt
+00032400: 6573 2c20 636c 6965 6e74 3d63 6c69 656e  es, client=clien
+00032410: 7429 0a0a 2020 2020 2020 2020 6966 2062  t)..        if b
+00032420: 726f 6164 6361 7374 3a0a 2020 2020 2020  roadcast:.      
+00032430: 2020 2020 2020 6e20 3d20 6c65 6e28 6e74        n = len(nt
+00032440: 6872 6561 6473 2920 6966 2062 726f 6164  hreads) if broad
+00032450: 6361 7374 2069 7320 5472 7565 2065 6c73  cast is True els
+00032460: 6520 6272 6f61 6463 6173 740a 2020 2020  e broadcast.    
+00032470: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+00032480: 6c66 2e72 6570 6c69 6361 7465 286b 6579  lf.replicate(key
+00032490: 733d 6b65 7973 2c20 776f 726b 6572 733d  s=keys, workers=
+000324a0: 776f 726b 6572 732c 206e 3d6e 290a 0a20  workers, n=n).. 
+000324b0: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+000324c0: 6576 656e 7428 0a20 2020 2020 2020 2020  event(.         
+000324d0: 2020 205b 636c 6965 6e74 2c20 2261 6c6c     [client, "all
+000324e0: 225d 2c20 7b22 6163 7469 6f6e 223a 2022  "], {"action": "
+000324f0: 7363 6174 7465 7222 2c20 2263 6c69 656e  scatter", "clien
+00032500: 7422 3a20 636c 6965 6e74 2c20 2263 6f75  t": client, "cou
+00032510: 6e74 223a 206c 656e 2864 6174 6129 7d0a  nt": len(data)}.
+00032520: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00032530: 2020 7265 7475 726e 206b 6579 730a 0a20    return keys.. 
+00032540: 2020 2061 7379 6e63 2064 6566 2067 6174     async def gat
+00032550: 6865 7228 7365 6c66 2c20 6b65 7973 2c20  her(self, keys, 
+00032560: 7365 7269 616c 697a 6572 733d 4e6f 6e65  serializers=None
+00032570: 293a 0a20 2020 2020 2020 2022 2222 436f  ):.        """Co
+00032580: 6c6c 6563 7420 6461 7461 2066 726f 6d20  llect data from 
+00032590: 776f 726b 6572 7320 746f 2074 6865 2073  workers to the s
+000325a0: 6368 6564 756c 6572 2222 220a 2020 2020  cheduler""".    
+000325b0: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
+000325c0: 3d20 6622 6761 7468 6572 2d7b 7469 6d65  = f"gather-{time
+000325d0: 2829 7d22 0a20 2020 2020 2020 206b 6579  ()}".        key
+000325e0: 7320 3d20 6c69 7374 286b 6579 7329 0a20  s = list(keys). 
+000325f0: 2020 2020 2020 2077 686f 5f68 6173 203d         who_has =
+00032600: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
+00032610: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
+00032620: 2020 2020 2020 2020 2074 733a 2054 6173           ts: Tas
+00032630: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
+00032640: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+00032650: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+00032660: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00032670: 2020 2020 2020 2020 2020 2020 7768 6f5f              who_
+00032680: 6861 735b 6b65 795d 203d 205b 7773 2e61  has[key] = [ws.a
+00032690: 6464 7265 7373 2066 6f72 2077 7320 696e  ddress for ws in
+000326a0: 2074 732e 7768 6f5f 6861 735d 0a20 2020   ts.who_has].   
+000326b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000326c0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000326d0: 686f 5f68 6173 5b6b 6579 5d20 3d20 5b5d  ho_has[key] = []
+000326e0: 0a0a 2020 2020 2020 2020 6461 7461 2c20  ..        data, 
+000326f0: 6d69 7373 696e 675f 6b65 7973 2c20 6d69  missing_keys, mi
+00032700: 7373 696e 675f 776f 726b 6572 7320 3d20  ssing_workers = 
+00032710: 6177 6169 7420 6761 7468 6572 5f66 726f  await gather_fro
+00032720: 6d5f 776f 726b 6572 7328 0a20 2020 2020  m_workers(.     
+00032730: 2020 2020 2020 2077 686f 5f68 6173 2c20         who_has, 
+00032740: 7270 633d 7365 6c66 2e72 7063 2c20 636c  rpc=self.rpc, cl
+00032750: 6f73 653d 4661 6c73 652c 2073 6572 6961  ose=False, seria
+00032760: 6c69 7a65 7273 3d73 6572 6961 6c69 7a65  lizers=serialize
+00032770: 7273 0a20 2020 2020 2020 2029 0a20 2020  rs.        ).   
+00032780: 2020 2020 2069 6620 6e6f 7420 6d69 7373       if not miss
+00032790: 696e 675f 6b65 7973 3a0a 2020 2020 2020  ing_keys:.      
+000327a0: 2020 2020 2020 7265 7375 6c74 203d 207b        result = {
+000327b0: 2273 7461 7475 7322 3a20 224f 4b22 2c20  "status": "OK", 
+000327c0: 2264 6174 6122 3a20 6461 7461 7d0a 2020  "data": data}.  
+000327d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000327e0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
+000327f0: 7374 6174 6573 203d 205b 0a20 2020 2020  states = [.     
+00032800: 2020 2020 2020 2020 2020 2028 7365 6c66             (self
+00032810: 2e74 6173 6b73 5b6b 6579 5d2e 7374 6174  .tasks[key].stat
+00032820: 6520 6966 206b 6579 2069 6e20 7365 6c66  e if key in self
+00032830: 2e74 6173 6b73 2065 6c73 6520 4e6f 6e65  .tasks else None
+00032840: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00032850: 2020 666f 7220 6b65 7920 696e 206d 6973    for key in mis
+00032860: 7369 6e67 5f6b 6579 730a 2020 2020 2020  sing_keys.      
+00032870: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00032880: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
+00032890: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+000328a0: 2020 2020 2020 2243 6f75 6c64 6e27 7420        "Couldn't 
+000328b0: 6761 7468 6572 206b 6579 7320 2573 2073  gather keys %s s
+000328c0: 7461 7465 3a20 2573 2077 6f72 6b65 7273  tate: %s workers
+000328d0: 3a20 2573 222c 0a20 2020 2020 2020 2020  : %s",.         
+000328e0: 2020 2020 2020 206d 6973 7369 6e67 5f6b         missing_k
+000328f0: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
+00032900: 2020 2020 206d 6973 7369 6e67 5f73 7461       missing_sta
+00032910: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+00032920: 2020 2020 206d 6973 7369 6e67 5f77 6f72       missing_wor
+00032930: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
+00032940: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00032950: 7265 7375 6c74 203d 207b 2273 7461 7475  result = {"statu
+00032960: 7322 3a20 2265 7272 6f72 222c 2022 6b65  s": "error", "ke
+00032970: 7973 223a 206d 6973 7369 6e67 5f6b 6579  ys": missing_key
+00032980: 737d 0a20 2020 2020 2020 2020 2020 2077  s}.            w
+00032990: 6974 6820 6c6f 675f 6572 726f 7273 2829  ith log_errors()
+000329a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000329b0: 2020 2320 5265 6d6f 7665 2073 7573 7069    # Remove suspi
+000329c0: 6369 6f75 7320 776f 726b 6572 7320 6672  cious workers fr
+000329d0: 6f6d 2074 6865 2073 6368 6564 756c 6572  om the scheduler
+000329e0: 2061 6e64 2073 6875 7420 7468 656d 2064   and shut them d
+000329f0: 6f77 6e2e 0a20 2020 2020 2020 2020 2020  own..           
+00032a00: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00032a10: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00032a20: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00032a30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00032a40: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00032a50: 656d 6f76 655f 776f 726b 6572 280a 2020  emove_worker(.  
+00032a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a70: 2020 2020 2020 2020 2020 6164 6472 6573            addres
+00032a80: 733d 776f 726b 6572 2c20 636c 6f73 653d  s=worker, close=
+00032a90: 5472 7565 2c20 7374 696d 756c 7573 5f69  True, stimulus_i
+00032aa0: 643d 7374 696d 756c 7573 5f69 640a 2020  d=stimulus_id.  
+00032ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ac0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
 00032ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ae0: 2020 2020 6622 6275 7420 6166 7465 7220      f"but after 
-00032af0: 7b74 696d 656f 7574 7d73 2c20 6f6e 6c79  {timeout}s, only
-00032b00: 207b 6c65 6e28 7365 6c66 2e77 6f72 6b65   {len(self.worke
-00032b10: 7273 297d 2068 6176 6520 7265 7475 726e  rs)} have return
-00032b20: 6564 2e20 220a 2020 2020 2020 2020 2020  ed. ".          
-00032b30: 2020 2020 2020 2020 2020 2020 2020 2243                "C
-00032b40: 6f6e 7369 6465 7220 6120 6c6f 6e67 6572  onsider a longer
-00032b50: 2074 696d 656f 7574 2c20 6f72 2060 7761   timeout, or `wa
-00032b60: 6974 5f66 6f72 5f77 6f72 6b65 7273 3d46  it_for_workers=F
-00032b70: 616c 7365 602e 220a 2020 2020 2020 2020  alse`.".        
-00032b80: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00032b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ba0: 2020 2069 6620 286e 5f6e 616e 6e79 203a     if (n_nanny :
-00032bb0: 3d20 6c65 6e28 6e61 6e6e 795f 776f 726b  = len(nanny_work
-00032bc0: 6572 7329 2920 3c20 6e5f 776f 726b 6572  ers)) < n_worker
-00032bd0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00032be0: 2020 2020 2020 2020 2020 206d 7367 202b             msg +
-00032bf0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00032ae0: 666f 7220 776f 726b 6572 2069 6e20 6d69  for worker in mi
+00032af0: 7373 696e 675f 776f 726b 6572 730a 2020  ssing_workers.  
+00032b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b10: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00032b20: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00032b30: 2020 2020 2020 666f 7220 6b65 792c 2077        for key, w
+00032b40: 6f72 6b65 7273 2069 6e20 6d69 7373 696e  orkers in missin
+00032b50: 675f 6b65 7973 2e69 7465 6d73 2829 3a0a  g_keys.items():.
+00032b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b70: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
+00032b80: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+00032b90: 2020 2020 2020 2020 2020 2020 2020 2253                "S
+00032ba0: 6875 7420 646f 776e 2077 6f72 6b65 7273  hut down workers
+00032bb0: 2074 6861 7420 646f 6e27 7420 6861 7665   that don't have
+00032bc0: 2070 726f 6d69 7365 6420 6b65 793a 2025   promised key: %
+00032bd0: 732c 2025 7322 2c0a 2020 2020 2020 2020  s, %s",.        
+00032be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032bf0: 7374 7228 776f 726b 6572 7329 2c0a 2020  str(workers),.  
 00032c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032c10: 6622 2054 6865 207b 6e5f 776f 726b 6572  f" The {n_worker
-00032c20: 7320 2d20 6e5f 6e61 6e6e 797d 2077 6f72  s - n_nanny} wor
-00032c30: 6b65 7228 7329 206e 6f74 2075 7369 6e67  ker(s) not using
-00032c40: 204e 616e 6e69 6573 2077 6572 6520 6a75   Nannies were ju
-00032c50: 7374 2073 6875 7420 220a 2020 2020 2020  st shut ".      
-00032c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032c70: 2020 2020 2020 2264 6f77 6e20 696e 7374        "down inst
-00032c80: 6561 6420 6f66 2072 6573 7461 7274 6564  ead of restarted
-00032c90: 2028 7265 7374 6172 7420 6973 206f 6e6c   (restart is onl
-00032ca0: 7920 706f 7373 6962 6c65 2077 6974 6820  y possible with 
-00032cb0: 4e61 6e6e 6965 7329 2e20 4966 2022 0a20  Nannies). If ". 
-00032cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032cd0: 2020 2020 2020 2020 2020 2022 796f 7572             "your
-00032ce0: 2064 6570 6c6f 796d 656e 7420 7379 7374   deployment syst
-00032cf0: 656d 2064 6f65 7320 6e6f 7420 6175 746f  em does not auto
-00032d00: 6d61 7469 6361 6c6c 7920 7265 2d6c 6175  matically re-lau
-00032d10: 6e63 6820 7465 726d 696e 6174 6564 2022  nch terminated "
-00032d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032d30: 2020 2020 2020 2020 2020 2020 2022 7072               "pr
-00032d40: 6f63 6573 7365 732c 2074 6865 6e20 7468  ocesses, then th
-00032d50: 6f73 6520 776f 726b 6572 7320 7769 6c6c  ose workers will
-00032d60: 206e 6576 6572 2063 6f6d 6520 6261 636b   never come back
-00032d70: 2c20 616e 6420 6043 6c69 656e 742e 7265  , and `Client.re
-00032d80: 7374 6172 7460 2022 0a20 2020 2020 2020  start` ".       
-00032d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032da0: 2020 2020 2022 7769 6c6c 2061 6c77 6179       "will alway
-00032db0: 7320 7469 6d65 206f 7574 2e20 446f 206e  s time out. Do n
-00032dc0: 6f74 2075 7365 2060 436c 6965 6e74 2e72  ot use `Client.r
-00032dd0: 6573 7461 7274 6020 696e 2074 6861 7420  estart` in that 
-00032de0: 6361 7365 2e22 0a20 2020 2020 2020 2020  case.".         
-00032df0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00032e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032e10: 2020 2020 2072 6169 7365 2054 696d 656f       raise Timeo
-00032e20: 7574 4572 726f 7228 6d73 6729 2066 726f  utError(msg) fro
-00032e30: 6d20 4e6f 6e65 0a20 2020 2020 2020 206c  m None.        l
-00032e40: 6f67 6765 722e 696e 666f 2822 5265 7374  ogger.info("Rest
-00032e50: 6172 7469 6e67 2066 696e 6973 6865 642e  arting finished.
-00032e60: 2229 0a0a 2020 2020 6173 796e 6320 6465  ")..    async de
-00032e70: 6620 6272 6f61 6463 6173 7428 0a20 2020  f broadcast(.   
-00032e80: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00032e90: 2020 2063 6f6d 6d3d 4e6f 6e65 2c0a 2020     comm=None,.  
-00032ea0: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00032eb0: 206d 7367 3a20 6469 6374 2c0a 2020 2020   msg: dict,.    
-00032ec0: 2020 2020 776f 726b 6572 733a 2022 6c69      workers: "li
-00032ed0: 7374 5b73 7472 5d20 7c20 4e6f 6e65 2220  st[str] | None" 
-00032ee0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00032ef0: 686f 7374 733a 2022 6c69 7374 5b73 7472  hosts: "list[str
-00032f00: 5d20 7c20 4e6f 6e65 2220 3d20 4e6f 6e65  ] | None" = None
-00032f10: 2c0a 2020 2020 2020 2020 6e61 6e6e 793a  ,.        nanny:
-00032f20: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00032f30: 2020 2020 2020 2073 6572 6961 6c69 7a65         serialize
-00032f40: 7273 3d4e 6f6e 652c 0a20 2020 2020 2020  rs=None,.       
-00032f50: 206f 6e5f 6572 726f 723a 2022 4c69 7465   on_error: "Lite
-00032f60: 7261 6c5b 2772 6169 7365 272c 2027 7265  ral['raise', 're
-00032f70: 7475 726e 272c 2027 7265 7475 726e 5f70  turn', 'return_p
-00032f80: 6963 6b6c 6527 2c20 2769 676e 6f72 6527  ickle', 'ignore'
-00032f90: 5d22 203d 2022 7261 6973 6522 2c0a 2020  ]" = "raise",.  
-00032fa0: 2020 2920 2d3e 2064 6963 743a 2020 2320    ) -> dict:  # 
-00032fb0: 6469 6374 5b73 7472 2c20 416e 795d 0a20  dict[str, Any]. 
-00032fc0: 2020 2020 2020 2022 2222 4272 6f61 6463         """Broadc
-00032fd0: 6173 7420 6d65 7373 6167 6520 746f 2077  ast message to w
-00032fe0: 6f72 6b65 7273 2c20 7265 7475 726e 2061  orkers, return a
-00032ff0: 6c6c 2072 6573 756c 7473 2222 220a 2020  ll results""".  
-00033000: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
-00033010: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00033020: 2020 2020 2020 6966 2068 6f73 7473 2069        if hosts i
-00033030: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00033040: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-00033050: 3d20 6c69 7374 2873 656c 662e 776f 726b  = list(self.work
-00033060: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-00033070: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00033080: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-00033090: 205b 5d0a 2020 2020 2020 2020 6966 2068   [].        if h
-000330a0: 6f73 7473 2069 7320 6e6f 7420 4e6f 6e65  osts is not None
-000330b0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-000330c0: 7220 686f 7374 2069 6e20 686f 7374 733a  r host in hosts:
-000330d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000330e0: 2064 683a 2064 6963 7420 3d20 7365 6c66   dh: dict = self
-000330f0: 2e68 6f73 745f 696e 666f 2e67 6574 2868  .host_info.get(h
-00033100: 6f73 7429 2020 2320 7479 7065 3a20 6967  ost)  # type: ig
-00033110: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
-00033120: 2020 2020 2069 6620 6468 2069 7320 6e6f       if dh is no
-00033130: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00033140: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00033150: 6572 732e 6578 7465 6e64 2864 685b 2261  ers.extend(dh["a
-00033160: 6464 7265 7373 6573 225d 290a 2020 2020  ddresses"]).    
-00033170: 2020 2020 2320 544f 444f 2072 6570 6c61      # TODO repla
-00033180: 6365 2077 6974 6820 776f 726b 6572 5f6c  ce with worker_l
-00033190: 6973 740a 0a20 2020 2020 2020 2069 6620  ist..        if 
-000331a0: 6e61 6e6e 793a 0a20 2020 2020 2020 2020  nanny:.         
-000331b0: 2020 2061 6464 7265 7373 6573 203d 205b     addresses = [
-000331c0: 7365 6c66 2e77 6f72 6b65 7273 5b77 5d2e  self.workers[w].
-000331d0: 6e61 6e6e 7920 666f 7220 7720 696e 2077  nanny for w in w
-000331e0: 6f72 6b65 7273 5d0a 2020 2020 2020 2020  orkers].        
-000331f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00033200: 2020 6164 6472 6573 7365 7320 3d20 776f    addresses = wo
-00033210: 726b 6572 730a 0a20 2020 2020 2020 2045  rkers..        E
-00033220: 5252 4f52 203d 206f 626a 6563 7428 290a  RROR = object().
-00033230: 0a20 2020 2020 2020 2061 7379 6e63 2064  .        async d
-00033240: 6566 2073 656e 645f 6d65 7373 6167 6528  ef send_message(
-00033250: 6164 6472 293a 0a20 2020 2020 2020 2020  addr):.         
-00033260: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00033270: 2020 2020 2020 2020 636f 6d6d 203d 2061          comm = a
-00033280: 7761 6974 2073 656c 662e 7270 632e 636f  wait self.rpc.co
-00033290: 6e6e 6563 7428 6164 6472 290a 2020 2020  nnect(addr).    
-000332a0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-000332b0: 2e6e 616d 6520 3d20 2253 6368 6564 756c  .name = "Schedul
-000332c0: 6572 2042 726f 6164 6361 7374 220a 2020  er Broadcast".  
-000332d0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-000332e0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-000332f0: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
-00033300: 6169 7420 7365 6e64 5f72 6563 7628 0a20  ait send_recv(. 
-00033310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033320: 2020 2020 2020 2063 6f6d 6d2c 2063 6c6f         comm, clo
-00033330: 7365 3d54 7275 652c 2073 6572 6961 6c69  se=True, seriali
-00033340: 7a65 7273 3d73 6572 6961 6c69 7a65 7273  zers=serializers
-00033350: 2c20 2a2a 6d73 670a 2020 2020 2020 2020  , **msg.        
-00033360: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00033370: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00033380: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
-00033390: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000333a0: 7270 632e 7265 7573 6528 6164 6472 2c20  rpc.reuse(addr, 
-000333b0: 636f 6d6d 290a 2020 2020 2020 2020 2020  comm).          
-000333c0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-000333d0: 700a 2020 2020 2020 2020 2020 2020 6578  p.            ex
-000333e0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-000333f0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00033400: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
-00033410: 7228 6622 6272 6f61 6463 6173 7420 746f  r(f"broadcast to
-00033420: 207b 6164 6472 7d20 6661 696c 6564 3a20   {addr} failed: 
-00033430: 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  {e.__class__.__n
-00033440: 616d 655f 5f7d 3a20 7b65 7d22 290a 2020  ame__}: {e}").  
-00033450: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00033460: 206f 6e5f 6572 726f 7220 3d3d 2022 7261   on_error == "ra
-00033470: 6973 6522 3a0a 2020 2020 2020 2020 2020  ise":.          
-00033480: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
-00033490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000334a0: 656c 6966 206f 6e5f 6572 726f 7220 3d3d  elif on_error ==
-000334b0: 2022 7265 7475 726e 223a 0a20 2020 2020   "return":.     
-000334c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000334d0: 6574 7572 6e20 650a 2020 2020 2020 2020  eturn e.        
-000334e0: 2020 2020 2020 2020 656c 6966 206f 6e5f          elif on_
-000334f0: 6572 726f 7220 3d3d 2022 7265 7475 726e  error == "return
-00033500: 5f70 6963 6b6c 6522 3a0a 2020 2020 2020  _pickle":.      
-00033510: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00033520: 7475 726e 2064 756d 7073 2865 290a 2020  turn dumps(e).  
-00033530: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00033540: 6966 206f 6e5f 6572 726f 7220 3d3d 2022  if on_error == "
-00033550: 6967 6e6f 7265 223a 0a20 2020 2020 2020  ignore":.       
-00033560: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00033570: 7572 6e20 4552 524f 520a 2020 2020 2020  urn ERROR.      
-00033580: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00033590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000335a0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-000335b0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-000335c0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-000335d0: 6e5f 6572 726f 7220 6d75 7374 2062 6520  n_error must be 
-000335e0: 2772 6169 7365 272c 2027 7265 7475 726e  'raise', 'return
-000335f0: 272c 2027 7265 7475 726e 5f70 6963 6b6c  ', 'return_pickl
-00033600: 6527 2c20 220a 2020 2020 2020 2020 2020  e', ".          
-00033610: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00033620: 6f72 2027 6967 6e6f 7265 273b 2067 6f74  or 'ignore'; got
-00033630: 207b 6f6e 5f65 7272 6f72 2172 7d22 0a20   {on_error!r}". 
+00032c10: 2020 2020 2020 7374 7228 6b65 7929 2c0a        str(key),.
+00032c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032c30: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+00032c40: 656c 662e 6c6f 675f 6576 656e 7428 2261  elf.log_event("a
+00032c50: 6c6c 222c 207b 2261 6374 696f 6e22 3a20  ll", {"action": 
+00032c60: 2267 6174 6865 7222 2c20 2263 6f75 6e74  "gather", "count
+00032c70: 223a 206c 656e 286b 6579 7329 7d29 0a20  ": len(keys)}). 
+00032c80: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00032c90: 7375 6c74 0a0a 2020 2020 406c 6f67 5f65  sult..    @log_e
+00032ca0: 7272 6f72 730a 2020 2020 6173 796e 6320  rrors.    async 
+00032cb0: 6465 6620 7265 7374 6172 7428 7365 6c66  def restart(self
+00032cc0: 2c20 636c 6965 6e74 3d4e 6f6e 652c 2074  , client=None, t
+00032cd0: 696d 656f 7574 3d33 302c 2077 6169 745f  imeout=30, wait_
+00032ce0: 666f 725f 776f 726b 6572 733d 5472 7565  for_workers=True
+00032cf0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00032d00: 2020 2020 2020 2052 6573 7461 7274 2061         Restart a
+00032d10: 6c6c 2077 6f72 6b65 7273 2e20 5265 7365  ll workers. Rese
+00032d20: 7420 6c6f 6361 6c20 7374 6174 652e 204f  t local state. O
+00032d30: 7074 696f 6e61 6c6c 7920 7761 6974 2066  ptionally wait f
+00032d40: 6f72 2077 6f72 6b65 7273 2074 6f20 7265  or workers to re
+00032d50: 7475 726e 2e0a 0a20 2020 2020 2020 2057  turn...        W
+00032d60: 6f72 6b65 7273 2077 6974 686f 7574 206e  orkers without n
+00032d70: 616e 6e69 6573 2061 7265 2073 6875 7420  annies are shut 
+00032d80: 646f 776e 2c20 686f 7069 6e67 2061 6e20  down, hoping an 
+00032d90: 6578 7465 726e 616c 2064 6570 6c6f 796d  external deploym
+00032da0: 656e 7420 7379 7374 656d 0a20 2020 2020  ent system.     
+00032db0: 2020 2077 696c 6c20 7265 7374 6172 7420     will restart 
+00032dc0: 7468 656d 2e20 5468 6572 6566 6f72 652c  them. Therefore,
+00032dd0: 2069 6620 6e6f 7420 7573 696e 6720 6e61   if not using na
+00032de0: 6e6e 6965 7320 616e 6420 796f 7572 2064  nnies and your d
+00032df0: 6570 6c6f 796d 656e 7420 7379 7374 656d  eployment system
+00032e00: 0a20 2020 2020 2020 2064 6f65 7320 6e6f  .        does no
+00032e10: 7420 6175 746f 6d61 7469 6361 6c6c 7920  t automatically 
+00032e20: 7265 7374 6172 7420 776f 726b 6572 732c  restart workers,
+00032e30: 2060 6072 6573 7461 7274 6060 2077 696c   ``restart`` wil
+00032e40: 6c20 6a75 7374 2073 6875 7420 646f 776e  l just shut down
+00032e50: 2061 6c6c 0a20 2020 2020 2020 2077 6f72   all.        wor
+00032e60: 6b65 7273 2c20 7468 656e 2074 696d 6520  kers, then time 
+00032e70: 6f75 7421 0a0a 2020 2020 2020 2020 4166  out!..        Af
+00032e80: 7465 7220 6060 7265 7374 6172 7460 602c  ter ``restart``,
+00032e90: 2061 6c6c 2063 6f6e 6e65 6374 6564 2077   all connected w
+00032ea0: 6f72 6b65 7273 2061 7265 206e 6577 2c20  orkers are new, 
+00032eb0: 7265 6761 7264 6c65 7373 206f 6620 7768  regardless of wh
+00032ec0: 6574 6865 7220 6060 5469 6d65 6f75 7445  ether ``TimeoutE
+00032ed0: 7272 6f72 6060 0a20 2020 2020 2020 2077  rror``.        w
+00032ee0: 6173 2072 6169 7365 642e 2041 6e79 2077  as raised. Any w
+00032ef0: 6f72 6b65 7273 2074 6861 7420 6661 696c  orkers that fail
+00032f00: 6564 2074 6f20 7368 7574 2064 6f77 6e20  ed to shut down 
+00032f10: 696e 2074 696d 6520 6172 6520 7265 6d6f  in time are remo
+00032f20: 7665 642c 2061 6e64 0a20 2020 2020 2020  ved, and.       
+00032f30: 206d 6179 206f 7220 6d61 7920 6e6f 7420   may or may not 
+00032f40: 7368 7574 2064 6f77 6e20 6f6e 2074 6865  shut down on the
+00032f50: 6972 206f 776e 2069 6e20 7468 6520 6675  ir own in the fu
+00032f60: 7475 7265 2e0a 0a20 2020 2020 2020 2050  ture...        P
+00032f70: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+00032f80: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00032f90: 2020 2020 2074 696d 656f 7574 3a0a 2020       timeout:.  
+00032fa0: 2020 2020 2020 2020 2020 486f 7720 6c6f            How lo
+00032fb0: 6e67 2074 6f20 7761 6974 2066 6f72 2077  ng to wait for w
+00032fc0: 6f72 6b65 7273 2074 6f20 7368 7574 2064  orkers to shut d
+00032fd0: 6f77 6e20 616e 6420 636f 6d65 2062 6163  own and come bac
+00032fe0: 6b2c 2069 6620 6060 7761 6974 5f66 6f72  k, if ``wait_for
+00032ff0: 5f77 6f72 6b65 7273 6060 0a20 2020 2020  _workers``.     
+00033000: 2020 2020 2020 2069 7320 5472 7565 2c20         is True, 
+00033010: 6f74 6865 7277 6973 6520 6a75 7374 2068  otherwise just h
+00033020: 6f77 206c 6f6e 6720 746f 2077 6169 7420  ow long to wait 
+00033030: 666f 7220 776f 726b 6572 7320 746f 2073  for workers to s
+00033040: 6875 7420 646f 776e 2e0a 2020 2020 2020  hut down..      
+00033050: 2020 2020 2020 5261 6973 6573 2060 6061        Raises ``a
+00033060: 7379 6e63 696f 2e54 696d 656f 7574 4572  syncio.TimeoutEr
+00033070: 726f 7260 6020 6966 2074 6869 7320 6973  ror`` if this is
+00033080: 2065 7863 6565 6465 642e 0a20 2020 2020   exceeded..     
+00033090: 2020 2077 6169 745f 666f 725f 776f 726b     wait_for_work
+000330a0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000330b0: 2057 6865 7468 6572 2074 6f20 7761 6974   Whether to wait
+000330c0: 2066 6f72 2061 6c6c 2077 6f72 6b65 7273   for all workers
+000330d0: 2074 6f20 7265 636f 6e6e 6563 742c 206f   to reconnect, o
+000330e0: 7220 6a75 7374 2066 6f72 2074 6865 6d20  r just for them 
+000330f0: 746f 2073 6875 7420 646f 776e 0a20 2020  to shut down.   
+00033100: 2020 2020 2020 2020 2028 6465 6661 756c           (defaul
+00033110: 7420 5472 7565 292e 2055 7365 2060 6072  t True). Use ``r
+00033120: 6573 7461 7274 2877 6169 745f 666f 725f  estart(wait_for_
+00033130: 776f 726b 6572 733d 4661 6c73 6529 6060  workers=False)``
+00033140: 2063 6f6d 6269 6e65 6420 7769 7468 0a20   combined with. 
+00033150: 2020 2020 2020 2020 2020 203a 6d65 7468             :meth
+00033160: 3a60 436c 6965 6e74 2e77 6169 745f 666f  :`Client.wait_fo
+00033170: 725f 776f 726b 6572 7360 2066 6f72 2067  r_workers` for g
+00033180: 7261 6e75 6c61 7220 636f 6e74 726f 6c20  ranular control 
+00033190: 6f76 6572 2068 6f77 206d 616e 7920 776f  over how many wo
+000331a0: 726b 6572 7320 746f 0a20 2020 2020 2020  rkers to.       
+000331b0: 2020 2020 2077 6169 7420 666f 722e 0a0a       wait for...
+000331c0: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+000331d0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+000331e0: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
+000331f0: 2e72 6573 7461 7274 0a20 2020 2020 2020  .restart.       
+00033200: 2043 6c69 656e 742e 7265 7374 6172 745f   Client.restart_
+00033210: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+00033220: 2222 220a 2020 2020 2020 2020 7374 696d  """.        stim
+00033230: 756c 7573 5f69 6420 3d20 6622 7265 7374  ulus_id = f"rest
+00033240: 6172 742d 7b74 696d 6528 297d 220a 0a20  art-{time()}".. 
+00033250: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00033260: 666f 2822 5265 7374 6172 7469 6e67 2077  fo("Restarting w
+00033270: 6f72 6b65 7273 2061 6e64 2072 656c 6561  orkers and relea
+00033280: 7369 6e67 2061 6c6c 206b 6579 732e 2229  sing all keys.")
+00033290: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
+000332a0: 696e 2073 656c 662e 636c 6965 6e74 732e  in self.clients.
+000332b0: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+000332c0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+000332d0: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
+000332e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000332f0: 206b 6579 733d 5b74 732e 6b65 7920 666f   keys=[ts.key fo
+00033300: 7220 7473 2069 6e20 6373 2e77 616e 7473  r ts in cs.wants
+00033310: 5f77 6861 745d 2c0a 2020 2020 2020 2020  _what],.        
+00033320: 2020 2020 2020 2020 636c 6965 6e74 3d63          client=c
+00033330: 732e 636c 6965 6e74 5f6b 6579 2c0a 2020  s.client_key,.  
+00033340: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00033350: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+00033360: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
+00033370: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00033380: 6c66 2e5f 636c 6561 725f 7461 736b 5f73  lf._clear_task_s
+00033390: 7461 7465 2829 0a20 2020 2020 2020 2061  tate().        a
+000333a0: 7373 6572 7420 6e6f 7420 7365 6c66 2e74  ssert not self.t
+000333b0: 6173 6b73 0a20 2020 2020 2020 2073 656c  asks.        sel
+000333c0: 662e 7265 706f 7274 287b 226f 7022 3a20  f.report({"op": 
+000333d0: 2272 6573 7461 7274 227d 290a 0a20 2020  "restart"})..   
+000333e0: 2020 2020 2066 6f72 2070 6c75 6769 6e20       for plugin 
+000333f0: 696e 206c 6973 7428 7365 6c66 2e70 6c75  in list(self.plu
+00033400: 6769 6e73 2e76 616c 7565 7328 2929 3a0a  gins.values()):.
+00033410: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00033420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033430: 2070 6c75 6769 6e2e 7265 7374 6172 7428   plugin.restart(
+00033440: 7365 6c66 290a 2020 2020 2020 2020 2020  self).          
+00033450: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00033460: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00033470: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00033480: 6578 6365 7074 696f 6e28 6529 0a0a 2020  exception(e)..  
+00033490: 2020 2020 2020 6e5f 776f 726b 6572 7320        n_workers 
+000334a0: 3d20 6c65 6e28 7365 6c66 2e77 6f72 6b65  = len(self.worke
+000334b0: 7273 290a 2020 2020 2020 2020 6e61 6e6e  rs).        nann
+000334c0: 795f 776f 726b 6572 7320 3d20 7b0a 2020  y_workers = {.  
+000334d0: 2020 2020 2020 2020 2020 6164 6472 3a20            addr: 
+000334e0: 7773 2e6e 616e 6e79 2066 6f72 2061 6464  ws.nanny for add
+000334f0: 722c 2077 7320 696e 2073 656c 662e 776f  r, ws in self.wo
+00033500: 726b 6572 732e 6974 656d 7328 2920 6966  rkers.items() if
+00033510: 2077 732e 6e61 6e6e 790a 2020 2020 2020   ws.nanny.      
+00033520: 2020 7d0a 2020 2020 2020 2020 2320 436c    }.        # Cl
+00033530: 6f73 6520 6e6f 6e2d 4e61 6e6e 7920 776f  ose non-Nanny wo
+00033540: 726b 6572 732e 2057 6520 6861 7665 206e  rkers. We have n
+00033550: 6f20 7761 7920 746f 2072 6573 7461 7274  o way to restart
+00033560: 2074 6865 6d2c 2073 6f20 7765 206a 7573   them, so we jus
+00033570: 7420 6c65 7420 7468 656d 2067 6f2c 0a20  t let them go,. 
+00033580: 2020 2020 2020 2023 2061 6e64 2061 7373         # and ass
+00033590: 756d 6520 6120 6465 706c 6f79 6d65 6e74  ume a deployment
+000335a0: 2073 7973 7465 6d20 6973 2067 6f69 6e67   system is going
+000335b0: 2074 6f20 7265 7374 6172 7420 7468 656d   to restart them
+000335c0: 2066 6f72 2075 732e 0a20 2020 2020 2020   for us..       
+000335d0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+000335e0: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+000335f0: 2020 202a 280a 2020 2020 2020 2020 2020     *(.          
+00033600: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
+00033610: 655f 776f 726b 6572 2861 6464 7265 7373  e_worker(address
+00033620: 3d61 6464 722c 2073 7469 6d75 6c75 735f  =addr, stimulus_
+00033630: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
 00033640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033650: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
-00033660: 7375 6c74 7320 3d20 6177 6169 7420 416c  sults = await Al
-00033670: 6c28 0a20 2020 2020 2020 2020 2020 205b  l(.            [
-00033680: 7365 6e64 5f6d 6573 7361 6765 2861 6464  send_message(add
-00033690: 7265 7373 2920 666f 7220 6164 6472 6573  ress) for addres
-000336a0: 7320 696e 2061 6464 7265 7373 6573 2069  s in addresses i
-000336b0: 6620 6164 6472 6573 7320 6973 206e 6f74  f address is not
-000336c0: 204e 6f6e 655d 0a20 2020 2020 2020 2029   None].        )
-000336d0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000336e0: 207b 6b3a 2076 2066 6f72 206b 2c20 7620   {k: v for k, v 
-000336f0: 696e 207a 6970 2877 6f72 6b65 7273 2c20  in zip(workers, 
-00033700: 7265 7375 6c74 7329 2069 6620 7620 6973  results) if v is
-00033710: 206e 6f74 2045 5252 4f52 7d0a 0a20 2020   not ERROR}..   
-00033720: 2061 7379 6e63 2064 6566 2070 726f 7879   async def proxy
-00033730: 2873 656c 662c 2063 6f6d 6d3d 4e6f 6e65  (self, comm=None
-00033740: 2c20 6d73 673d 4e6f 6e65 2c20 776f 726b  , msg=None, work
-00033750: 6572 3d4e 6f6e 652c 2073 6572 6961 6c69  er=None, seriali
-00033760: 7a65 7273 3d4e 6f6e 6529 3a0a 2020 2020  zers=None):.    
-00033770: 2020 2020 2222 2250 726f 7879 2061 2063      """Proxy a c
-00033780: 6f6d 6d75 6e69 6361 7469 6f6e 2074 6872  ommunication thr
-00033790: 6f75 6768 2074 6865 2073 6368 6564 756c  ough the schedul
-000337a0: 6572 2074 6f20 736f 6d65 206f 7468 6572  er to some other
-000337b0: 2077 6f72 6b65 7222 2222 0a20 2020 2020   worker""".     
-000337c0: 2020 2064 203d 2061 7761 6974 2073 656c     d = await sel
-000337d0: 662e 6272 6f61 6463 6173 7428 0a20 2020  f.broadcast(.   
-000337e0: 2020 2020 2020 2020 2063 6f6d 6d3d 636f           comm=co
-000337f0: 6d6d 2c20 6d73 673d 6d73 672c 2077 6f72  mm, msg=msg, wor
-00033800: 6b65 7273 3d5b 776f 726b 6572 5d2c 2073  kers=[worker], s
-00033810: 6572 6961 6c69 7a65 7273 3d73 6572 6961  erializers=seria
-00033820: 6c69 7a65 7273 0a20 2020 2020 2020 2029  lizers.        )
-00033830: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00033840: 645b 776f 726b 6572 5d0a 0a20 2020 2061  d[worker]..    a
-00033850: 7379 6e63 2064 6566 2067 6174 6865 725f  sync def gather_
-00033860: 6f6e 5f77 6f72 6b65 7228 0a20 2020 2020  on_worker(.     
-00033870: 2020 2073 656c 662c 2077 6f72 6b65 725f     self, worker_
-00033880: 6164 6472 6573 733a 2073 7472 2c20 7768  address: str, wh
-00033890: 6f5f 6861 733a 2022 6469 6374 5b73 7472  o_has: "dict[str
-000338a0: 2c20 6c69 7374 5b73 7472 5d5d 220a 2020  , list[str]]".  
-000338b0: 2020 2920 2d3e 2073 6574 3a0a 2020 2020    ) -> set:.    
-000338c0: 2020 2020 2222 2250 6565 722d 746f 2d70      """Peer-to-p
-000338d0: 6565 7220 636f 7079 206f 6620 6b65 7973  eer copy of keys
-000338e0: 2066 726f 6d20 6d75 6c74 6970 6c65 2077   from multiple w
-000338f0: 6f72 6b65 7273 2074 6f20 6120 7369 6e67  orkers to a sing
-00033900: 6c65 2077 6f72 6b65 720a 0a20 2020 2020  le worker..     
-00033910: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00033920: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-00033930: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00033940: 6164 6472 6573 733a 2073 7472 0a20 2020  address: str.   
-00033950: 2020 2020 2020 2020 2052 6563 6970 6965           Recipie
-00033960: 6e74 2077 6f72 6b65 7220 6164 6472 6573  nt worker addres
-00033970: 7320 746f 2063 6f70 7920 6b65 7973 2074  s to copy keys t
-00033980: 6f0a 2020 2020 2020 2020 7768 6f5f 6861  o.        who_ha
-00033990: 733a 2064 6963 745b 4861 7368 6162 6c65  s: dict[Hashable
-000339a0: 2c20 6c69 7374 5b73 7472 5d5d 0a20 2020  , list[str]].   
-000339b0: 2020 2020 2020 2020 207b 6b65 793a 205b           {key: [
-000339c0: 7365 6e64 6572 2061 6464 7265 7373 2c20  sender address, 
-000339d0: 7365 6e64 6572 2061 6464 7265 7373 2c20  sender address, 
-000339e0: 2e2e 2e5d 2c20 6b65 793a 202e 2e2e 7d0a  ...], key: ...}.
-000339f0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00033a00: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00033a10: 0a20 2020 2020 2020 2072 6574 7572 6e73  .        returns
-00033a20: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00033a30: 7420 6f66 206b 6579 7320 7468 6174 2066  t of keys that f
-00033a40: 6169 6c65 6420 746f 2062 6520 636f 7069  ailed to be copi
-00033a50: 6564 0a20 2020 2020 2020 2022 2222 0a20  ed.        """. 
-00033a60: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00033a70: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00033a80: 2061 7761 6974 2072 6574 7279 5f6f 7065   await retry_ope
-00033a90: 7261 7469 6f6e 280a 2020 2020 2020 2020  ration(.        
-00033aa0: 2020 2020 2020 2020 7365 6c66 2e72 7063          self.rpc
-00033ab0: 2861 6464 723d 776f 726b 6572 5f61 6464  (addr=worker_add
-00033ac0: 7265 7373 292e 6761 7468 6572 2c20 7768  ress).gather, wh
-00033ad0: 6f5f 6861 733d 7768 6f5f 6861 730a 2020  o_has=who_has.  
-00033ae0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00033af0: 2020 2020 6578 6365 7074 204f 5345 7272      except OSErr
-00033b00: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-00033b10: 2020 2020 2023 2054 6869 7320 6361 6e20       # This can 
-00033b20: 6861 7070 656e 2065 2e67 2e20 6966 2074  happen e.g. if t
-00033b30: 6865 2077 6f72 6b65 7220 6973 2067 6f69  he worker is goi
-00033b40: 6e67 2074 6872 6f75 6768 2063 6f6e 7472  ng through contr
-00033b50: 6f6c 6c65 6420 7368 7574 646f 776e 3b0a  olled shutdown;.
-00033b60: 2020 2020 2020 2020 2020 2020 2320 6974              # it
-00033b70: 2064 6f65 736e 2774 206e 6563 6573 7361   doesn't necessa
-00033b80: 7269 6c79 206d 6561 6e20 7468 6174 2069  rily mean that i
-00033b90: 7420 7765 6e74 2075 6e65 7870 6563 7465  t went unexpecte
-00033ba0: 646c 7920 6d69 7373 696e 670a 2020 2020  dly missing.    
-00033bb0: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
-00033bc0: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-00033bd0: 2020 2020 2020 2020 6622 436f 6d6d 756e          f"Commun
-00033be0: 6963 6174 696f 6e20 7769 7468 2077 6f72  ication with wor
-00033bf0: 6b65 7220 7b77 6f72 6b65 725f 6164 6472  ker {worker_addr
-00033c00: 6573 737d 2066 6169 6c65 6420 6475 7269  ess} failed duri
-00033c10: 6e67 2022 0a20 2020 2020 2020 2020 2020  ng ".           
-00033c20: 2020 2020 2066 2272 6570 6c69 6361 7469       f"replicati
-00033c30: 6f6e 3a20 7b65 2e5f 5f63 6c61 7373 5f5f  on: {e.__class__
-00033c40: 2e5f 5f6e 616d 655f 5f7d 3a20 7b65 7d22  .__name__}: {e}"
-00033c50: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00033c60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00033c70: 6e20 7365 7428 7768 6f5f 6861 7329 0a0a  n set(who_has)..
-00033c80: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
-00033c90: 662e 776f 726b 6572 732e 6765 7428 776f  f.workers.get(wo
-00033ca0: 726b 6572 5f61 6464 7265 7373 290a 0a20  rker_address).. 
-00033cb0: 2020 2020 2020 2069 6620 6e6f 7420 7773         if not ws
-00033cc0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00033cd0: 6767 6572 2e77 6172 6e69 6e67 2866 2257  gger.warning(f"W
-00033ce0: 6f72 6b65 7220 7b77 6f72 6b65 725f 6164  orker {worker_ad
-00033cf0: 6472 6573 737d 206c 6f73 7420 6475 7269  dress} lost duri
-00033d00: 6e67 2072 6570 6c69 6361 7469 6f6e 2229  ng replication")
-00033d10: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00033d20: 7572 6e20 7365 7428 7768 6f5f 6861 7329  urn set(who_has)
-00033d30: 0a20 2020 2020 2020 2065 6c69 6620 7265  .        elif re
-00033d40: 7375 6c74 5b22 7374 6174 7573 225d 203d  sult["status"] =
-00033d50: 3d20 224f 4b22 3a0a 2020 2020 2020 2020  = "OK":.        
-00033d60: 2020 2020 6b65 7973 5f66 6169 6c65 6420      keys_failed 
-00033d70: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00033d80: 2020 2020 6b65 7973 5f6f 6b3a 2053 6574      keys_ok: Set
-00033d90: 203d 2077 686f 5f68 6173 2e6b 6579 7328   = who_has.keys(
-00033da0: 290a 2020 2020 2020 2020 656c 6966 2072  ).        elif r
-00033db0: 6573 756c 745b 2273 7461 7475 7322 5d20  esult["status"] 
-00033dc0: 3d3d 2022 7061 7274 6961 6c2d 6661 696c  == "partial-fail
-00033dd0: 223a 0a20 2020 2020 2020 2020 2020 206b  ":.            k
-00033de0: 6579 735f 6661 696c 6564 203d 2073 6574  eys_failed = set
-00033df0: 2872 6573 756c 745b 226b 6579 7322 5d29  (result["keys"])
-00033e00: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
-00033e10: 735f 6f6b 203d 2077 686f 5f68 6173 2e6b  s_ok = who_has.k
-00033e20: 6579 7328 2920 2d20 6b65 7973 5f66 6169  eys() - keys_fai
-00033e30: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
-00033e40: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
-00033e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033e60: 6622 576f 726b 6572 207b 776f 726b 6572  f"Worker {worker
-00033e70: 5f61 6464 7265 7373 7d20 6661 696c 6564  _address} failed
-00033e80: 2074 6f20 6163 7175 6972 6520 6b65 7973   to acquire keys
-00033e90: 3a20 7b72 6573 756c 745b 276b 6579 7327  : {result['keys'
-00033ea0: 5d7d 220a 2020 2020 2020 2020 2020 2020  ]}".            
-00033eb0: 290a 2020 2020 2020 2020 656c 7365 3a20  ).        else: 
-00033ec0: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
-00033ed0: 6572 0a20 2020 2020 2020 2020 2020 2072  er.            r
-00033ee0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00033ef0: 6622 556e 6578 7065 6374 6564 206d 6573  f"Unexpected mes
-00033f00: 7361 6765 2066 726f 6d20 7b77 6f72 6b65  sage from {worke
-00033f10: 725f 6164 6472 6573 737d 3a20 7b72 6573  r_address}: {res
-00033f20: 756c 747d 2229 0a0a 2020 2020 2020 2020  ult}")..        
-00033f30: 666f 7220 6b65 7920 696e 206b 6579 735f  for key in keys_
-00033f40: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
-00033f50: 7473 3a20 5461 736b 5374 6174 6520 3d20  ts: TaskState = 
-00033f60: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
-00033f70: 6579 2920 2023 2074 7970 653a 2069 676e  ey)  # type: ign
+00033650: 666f 7220 6164 6472 2069 6e20 7365 6c66  for addr in self
+00033660: 2e77 6f72 6b65 7273 0a20 2020 2020 2020  .workers.       
+00033670: 2020 2020 2020 2020 2069 6620 6164 6472           if addr
+00033680: 206e 6f74 2069 6e20 6e61 6e6e 795f 776f   not in nanny_wo
+00033690: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
+000336a0: 2020 290a 2020 2020 2020 2020 290a 0a20    ).        ).. 
+000336b0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+000336c0: 6275 6728 2253 656e 6420 6b69 6c6c 2073  bug("Send kill s
+000336d0: 6967 6e61 6c20 746f 206e 616e 6e69 6573  ignal to nannies
+000336e0: 3a20 2573 222c 206e 616e 6e79 5f77 6f72  : %s", nanny_wor
+000336f0: 6b65 7273 290a 2020 2020 2020 2020 6173  kers).        as
+00033700: 796e 6320 7769 7468 2063 6f6e 7465 7874  ync with context
+00033710: 6c69 622e 4173 796e 6345 7869 7453 7461  lib.AsyncExitSta
+00033720: 636b 2829 2061 7320 7374 6163 6b3a 0a20  ck() as stack:. 
+00033730: 2020 2020 2020 2020 2020 206e 616e 6e69             nanni
+00033740: 6573 203d 2061 7761 6974 2061 7379 6e63  es = await async
+00033750: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00033760: 2020 2020 2020 2020 2020 202a 280a 2020             *(.  
+00033770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033780: 2020 7374 6163 6b2e 656e 7465 725f 6173    stack.enter_as
+00033790: 796e 635f 636f 6e74 6578 7428 0a20 2020  ync_context(.   
+000337a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000337b0: 2020 2020 2072 7063 286e 616e 6e79 5f61       rpc(nanny_a
+000337c0: 6464 7265 7373 2c20 636f 6e6e 6563 7469  ddress, connecti
+000337d0: 6f6e 5f61 7267 733d 7365 6c66 2e63 6f6e  on_args=self.con
+000337e0: 6e65 6374 696f 6e5f 6172 6773 290a 2020  nection_args).  
+000337f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033800: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00033810: 2020 2020 2020 2020 666f 7220 6e61 6e6e          for nann
+00033820: 795f 6164 6472 6573 7320 696e 206e 616e  y_address in nan
+00033830: 6e79 5f77 6f72 6b65 7273 2e76 616c 7565  ny_workers.value
+00033840: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00033850: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00033860: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00033870: 2073 7461 7274 203d 206d 6f6e 6f74 6f6e   start = monoton
+00033880: 6963 2829 0a20 2020 2020 2020 2020 2020  ic().           
+00033890: 2072 6573 7073 203d 2061 7761 6974 2061   resps = await a
+000338a0: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
+000338b0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+000338c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000338d0: 2020 2020 2020 7761 6974 5f66 6f72 280a        wait_for(.
+000338e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000338f0: 2020 2020 2020 2020 2320 4649 584d 4520          # FIXME 
+00033900: 646f 6573 206e 6f74 2072 6169 7365 2069  does not raise i
+00033910: 6620 7468 6520 7072 6f63 6573 7320 6661  f the process fa
+00033920: 696c 7320 746f 2073 6875 7420 646f 776e  ils to shut down
+00033930: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00033940: 2020 2020 2020 2020 2020 2320 7365 6520            # see 
+00033950: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+00033960: 6f6d 2f64 6173 6b2f 6469 7374 7269 6275  om/dask/distribu
+00033970: 7465 642f 7075 6c6c 2f36 3432 372f 6669  ted/pull/6427/fi
+00033980: 6c65 7323 7238 3934 3931 3734 3234 0a20  les#r894917424. 
+00033990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000339a0: 2020 2020 2020 2023 204e 4f54 453a 204e         # NOTE: N
+000339b0: 616e 6e79 2077 696c 6c20 6175 746f 6d61  anny will automa
+000339c0: 7469 6361 6c6c 7920 7265 7374 6172 7420  tically restart 
+000339d0: 776f 726b 6572 2070 726f 6365 7373 2077  worker process w
+000339e0: 6865 6e20 6974 2773 206b 696c 6c65 640a  hen it's killed.
+000339f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a00: 2020 2020 2020 2020 6e61 6e6e 792e 6b69          nanny.ki
+00033a10: 6c6c 280a 2020 2020 2020 2020 2020 2020  ll(.            
+00033a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a30: 7265 6173 6f6e 3d22 7363 6865 6475 6c65  reason="schedule
+00033a40: 722d 7265 7374 6172 7422 2c0a 2020 2020  r-restart",.    
+00033a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a60: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00033a70: 7469 6d65 6f75 742c 0a20 2020 2020 2020  timeout,.       
+00033a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a90: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00033aa0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00033ab0: 6f75 742c 0a20 2020 2020 2020 2020 2020  out,.           
+00033ac0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00033ad0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00033ae0: 6f72 206e 616e 6e79 2069 6e20 6e61 6e6e  or nanny in nann
+00033af0: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
+00033b00: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00033b10: 2020 2020 2020 2072 6574 7572 6e5f 6578         return_ex
+00033b20: 6365 7074 696f 6e73 3d54 7275 652c 0a20  ceptions=True,. 
+00033b30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00033b40: 2020 2020 2020 2020 2023 204e 4f54 453a           # NOTE:
+00033b50: 2074 6865 2060 576f 726b 6572 5374 6174   the `WorkerStat
+00033b60: 6560 2065 6e74 7269 6573 2066 6f72 2074  e` entries for t
+00033b70: 6865 7365 2077 6f72 6b65 7273 2077 696c  hese workers wil
+00033b80: 6c20 6265 2072 656d 6f76 6564 0a20 2020  l be removed.   
+00033b90: 2020 2020 2020 2020 2023 206e 6174 7572           # natur
+00033ba0: 616c 6c79 2077 6865 6e20 7468 6579 2064  ally when they d
+00033bb0: 6973 636f 6e6e 6563 7420 6672 6f6d 2074  isconnect from t
+00033bc0: 6865 2073 6368 6564 756c 6572 2e0a 0a20  he scheduler... 
+00033bd0: 2020 2020 2020 2020 2020 2023 2052 656d             # Rem
+00033be0: 6f76 6520 616e 7920 776f 726b 6572 7320  ove any workers 
+00033bf0: 7468 6174 2066 6169 6c65 6420 746f 2073  that failed to s
+00033c00: 6875 7420 646f 776e 2c20 736f 2077 6520  hut down, so we 
+00033c10: 6361 6e20 6775 6172 616e 7465 650a 2020  can guarantee.  
+00033c20: 2020 2020 2020 2020 2020 2320 7468 6174            # that
+00033c30: 2061 6674 6572 2060 7265 7374 6172 7460   after `restart`
+00033c40: 2c20 7468 6572 6520 6172 6520 6e6f 206f  , there are no o
+00033c50: 6c64 2077 6f72 6b65 7273 2061 726f 756e  ld workers aroun
+00033c60: 642e 0a20 2020 2020 2020 2020 2020 2062  d..            b
+00033c70: 6164 5f6e 616e 6e69 6573 203d 205b 0a20  ad_nannies = [. 
+00033c80: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00033c90: 6464 7220 666f 7220 6164 6472 2c20 7265  ddr for addr, re
+00033ca0: 7370 2069 6e20 7a69 7028 6e61 6e6e 795f  sp in zip(nanny_
+00033cb0: 776f 726b 6572 732c 2072 6573 7073 2920  workers, resps) 
+00033cc0: 6966 2072 6573 7020 6973 206e 6f74 204e  if resp is not N
+00033cd0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00033ce0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+00033cf0: 2062 6164 5f6e 616e 6e69 6573 3a0a 2020   bad_nannies:.  
+00033d00: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00033d10: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+00033d20: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00033d30: 2020 2020 2020 2020 2a28 0a20 2020 2020          *(.     
+00033d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033d50: 2020 2073 656c 662e 7265 6d6f 7665 5f77     self.remove_w
+00033d60: 6f72 6b65 7228 6164 6472 2c20 7374 696d  orker(addr, stim
+00033d70: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+00033d80: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
+00033d90: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00033da0: 2061 6464 7220 696e 2062 6164 5f6e 616e   addr in bad_nan
+00033db0: 6e69 6573 0a20 2020 2020 2020 2020 2020  nies.           
+00033dc0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00033dd0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00033de0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00033df0: 6973 6520 5469 6d65 6f75 7445 7272 6f72  ise TimeoutError
+00033e00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00033e10: 2020 2020 2020 6622 7b6c 656e 2862 6164        f"{len(bad
+00033e20: 5f6e 616e 6e69 6573 297d 2f7b 6c65 6e28  _nannies)}/{len(
+00033e30: 6e61 6e6e 6965 7329 7d20 6e61 6e6e 7920  nannies)} nanny 
+00033e40: 776f 726b 6572 2873 2920 6469 6420 6e6f  worker(s) did no
+00033e50: 7420 7368 7574 2064 6f77 6e20 7769 7468  t shut down with
+00033e60: 696e 207b 7469 6d65 6f75 747d 7322 0a20  in {timeout}s". 
+00033e70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00033e80: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
+00033e90: 6f67 5f65 7665 6e74 285b 636c 6965 6e74  og_event([client
+00033ea0: 2c20 2261 6c6c 225d 2c20 7b22 6163 7469  , "all"], {"acti
+00033eb0: 6f6e 223a 2022 7265 7374 6172 7422 2c20  on": "restart", 
+00033ec0: 2263 6c69 656e 7422 3a20 636c 6965 6e74  "client": client
+00033ed0: 7d29 0a0a 2020 2020 2020 2020 6966 2077  })..        if w
+00033ee0: 6169 745f 666f 725f 776f 726b 6572 733a  ait_for_workers:
+00033ef0: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
+00033f00: 6c65 206c 656e 2873 656c 662e 776f 726b  le len(self.work
+00033f10: 6572 7329 203c 206e 5f77 6f72 6b65 7273  ers) < n_workers
+00033f20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00033f30: 2020 2320 4e4f 5445 3a20 6966 206e 6577    # NOTE: if new
+00033f40: 2028 756e 7265 6c61 7465 6429 2077 6f72   (unrelated) wor
+00033f50: 6b65 7273 206a 6f69 6e20 7768 696c 6520  kers join while 
+00033f60: 7765 2772 6520 7761 6974 696e 672c 2077  we're waiting, w
+00033f70: 6520 6d61 7920 7265 7475 726e 2062 6566  e may return bef
 00033f80: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
-00033f90: 6966 2074 7320 6973 204e 6f6e 6520 6f72  if ts is None or
-00033fa0: 2074 732e 7374 6174 6520 213d 2022 6d65   ts.state != "me
-00033fb0: 6d6f 7279 223a 0a20 2020 2020 2020 2020  mory":.         
-00033fc0: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00033fd0: 726e 696e 6728 6622 4b65 7920 6c6f 7374  rning(f"Key lost
-00033fe0: 2064 7572 696e 6720 7265 706c 6963 6174   during replicat
-00033ff0: 696f 6e3a 207b 6b65 797d 2229 0a20 2020  ion: {key}").   
-00034000: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00034010: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-00034020: 2020 6966 2077 7320 6e6f 7420 696e 2074    if ws not in t
-00034030: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
-00034040: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00034050: 6164 645f 7265 706c 6963 6128 7473 2c20  add_replica(ts, 
-00034060: 7773 290a 0a20 2020 2020 2020 2072 6574  ws)..        ret
-00034070: 7572 6e20 6b65 7973 5f66 6169 6c65 640a  urn keys_failed.
-00034080: 0a20 2020 2061 7379 6e63 2064 6566 2064  .    async def d
-00034090: 656c 6574 655f 776f 726b 6572 5f64 6174  elete_worker_dat
-000340a0: 6128 0a20 2020 2020 2020 2073 656c 662c  a(.        self,
-000340b0: 2077 6f72 6b65 725f 6164 6472 6573 733a   worker_address:
-000340c0: 2073 7472 2c20 6b65 7973 3a20 2243 6f6c   str, keys: "Col
-000340d0: 6c65 6374 696f 6e5b 7374 725d 222c 2073  lection[str]", s
-000340e0: 7469 6d75 6c75 735f 6964 3a20 7374 720a  timulus_id: str.
-000340f0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-00034100: 2020 2020 2020 2022 2222 4465 6c65 7465         """Delete
-00034110: 2064 6174 6120 6672 6f6d 2061 2077 6f72   data from a wor
-00034120: 6b65 7220 616e 6420 7570 6461 7465 2074  ker and update t
-00034130: 6865 2063 6f72 7265 7370 6f6e 6469 6e67  he corresponding
-00034140: 2077 6f72 6b65 722f 7461 736b 2073 7461   worker/task sta
-00034150: 7465 730a 0a20 2020 2020 2020 2050 6172  tes..        Par
-00034160: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-00034170: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-00034180: 2020 2077 6f72 6b65 725f 6164 6472 6573     worker_addres
-00034190: 733a 2073 7472 0a20 2020 2020 2020 2020  s: str.         
-000341a0: 2020 2057 6f72 6b65 7220 6164 6472 6573     Worker addres
-000341b0: 7320 746f 2064 656c 6574 6520 6b65 7973  s to delete keys
-000341c0: 2066 726f 6d0a 2020 2020 2020 2020 6b65   from.        ke
-000341d0: 7973 3a20 6c69 7374 5b73 7472 5d0a 2020  ys: list[str].  
-000341e0: 2020 2020 2020 2020 2020 4c69 7374 206f            List o
-000341f0: 6620 6b65 7973 2074 6f20 6465 6c65 7465  f keys to delete
-00034200: 206f 6e20 7468 6520 7370 6563 6966 6965   on the specifie
-00034210: 6420 776f 726b 6572 0a20 2020 2020 2020  d worker.       
-00034220: 2022 2222 0a20 2020 2020 2020 2074 7279   """.        try
-00034230: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00034240: 6169 7420 7265 7472 795f 6f70 6572 6174  ait retry_operat
-00034250: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-00034260: 2020 2020 2073 656c 662e 7270 6328 6164       self.rpc(ad
-00034270: 6472 3d77 6f72 6b65 725f 6164 6472 6573  dr=worker_addres
-00034280: 7329 2e66 7265 655f 6b65 7973 2c0a 2020  s).free_keys,.  
-00034290: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-000342a0: 7973 3d6c 6973 7428 6b65 7973 292c 0a20  ys=list(keys),. 
-000342b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000342c0: 7469 6d75 6c75 735f 6964 3d66 2264 656c  timulus_id=f"del
-000342d0: 6574 652d 6461 7461 2d7b 7469 6d65 2829  ete-data-{time()
-000342e0: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-000342f0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00034300: 204f 5345 7272 6f72 2061 7320 653a 0a20   OSError as e:. 
-00034310: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-00034320: 7320 6361 6e20 6861 7070 656e 2065 2e67  s can happen e.g
-00034330: 2e20 6966 2074 6865 2077 6f72 6b65 7220  . if the worker 
-00034340: 6973 2067 6f69 6e67 2074 6872 6f75 6768  is going through
-00034350: 2063 6f6e 7472 6f6c 6c65 6420 7368 7574   controlled shut
-00034360: 646f 776e 3b0a 2020 2020 2020 2020 2020  down;.          
-00034370: 2020 2320 6974 2064 6f65 736e 2774 206e    # it doesn't n
-00034380: 6563 6573 7361 7269 6c79 206d 6561 6e20  ecessarily mean 
-00034390: 7468 6174 2069 7420 7765 6e74 2075 6e65  that it went une
-000343a0: 7870 6563 7465 646c 7920 6d69 7373 696e  xpectedly missin
-000343b0: 670a 2020 2020 2020 2020 2020 2020 6c6f  g.            lo
-000343c0: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
-000343d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000343e0: 436f 6d6d 756e 6963 6174 696f 6e20 7769  Communication wi
-000343f0: 7468 2077 6f72 6b65 7220 7b77 6f72 6b65  th worker {worke
-00034400: 725f 6164 6472 6573 737d 2066 6169 6c65  r_address} faile
-00034410: 6420 6475 7269 6e67 2022 0a20 2020 2020  d during ".     
-00034420: 2020 2020 2020 2020 2020 2066 2272 6570             f"rep
-00034430: 6c69 6361 7469 6f6e 3a20 7b65 2e5f 5f63  lication: {e.__c
-00034440: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
-00034450: 3a20 7b65 7d22 0a20 2020 2020 2020 2020  : {e}".         
-00034460: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00034470: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-00034480: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
-00034490: 7273 2e67 6574 2877 6f72 6b65 725f 6164  rs.get(worker_ad
-000344a0: 6472 6573 7329 0a20 2020 2020 2020 2069  dress).        i
-000344b0: 6620 6e6f 7420 7773 3a0a 2020 2020 2020  f not ws:.      
-000344c0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-000344d0: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-000344e0: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
-000344f0: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
-00034500: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-00034510: 7428 6b65 7929 2020 2320 7479 7065 3a20  t(key)  # type: 
-00034520: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
-00034530: 2020 2069 6620 7473 2069 7320 6e6f 7420     if ts is not 
-00034540: 4e6f 6e65 2061 6e64 2077 7320 696e 2074  None and ws in t
-00034550: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
-00034560: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00034570: 7420 7473 2e73 7461 7465 203d 3d20 226d  t ts.state == "m
-00034580: 656d 6f72 7922 0a20 2020 2020 2020 2020  emory".         
-00034590: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
-000345a0: 7665 5f72 6570 6c69 6361 2874 732c 2077  ve_replica(ts, w
-000345b0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-000345c0: 2020 2069 6620 6e6f 7420 7473 2e77 686f     if not ts.who
-000345d0: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
-000345e0: 2020 2020 2020 2020 2020 2320 4c61 7374            # Last
-000345f0: 2063 6f70 7920 6465 6c65 7465 640a 2020   copy deleted.  
-00034600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034610: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-00034620: 6e73 287b 6b65 793a 2022 7265 6c65 6173  ns({key: "releas
-00034630: 6564 227d 2c20 7374 696d 756c 7573 5f69  ed"}, stimulus_i
-00034640: 6429 0a0a 2020 2020 2020 2020 7365 6c66  d)..        self
-00034650: 2e6c 6f67 5f65 7665 6e74 2877 732e 6164  .log_event(ws.ad
-00034660: 6472 6573 732c 207b 2261 6374 696f 6e22  dress, {"action"
-00034670: 3a20 2272 656d 6f76 652d 776f 726b 6572  : "remove-worker
-00034680: 2d64 6174 6122 2c20 226b 6579 7322 3a20  -data", "keys": 
-00034690: 6b65 7973 7d29 0a0a 2020 2020 406c 6f67  keys})..    @log
-000346a0: 5f65 7272 6f72 730a 2020 2020 6173 796e  _errors.    asyn
-000346b0: 6320 6465 6620 7265 6261 6c61 6e63 6528  c def rebalance(
-000346c0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-000346d0: 2020 2020 2020 2063 6f6d 6d3d 4e6f 6e65         comm=None
-000346e0: 2c0a 2020 2020 2020 2020 6b65 7973 3a20  ,.        keys: 
-000346f0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
-00034700: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00034710: 2020 2020 2077 6f72 6b65 7273 3a20 4974       workers: It
-00034720: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
-00034730: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00034740: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
-00034750: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-00034760: 652c 0a20 2020 2029 202d 3e20 6469 6374  e,.    ) -> dict
-00034770: 3a0a 2020 2020 2020 2020 2222 2252 6562  :.        """Reb
-00034780: 616c 616e 6365 206b 6579 7320 736f 2074  alance keys so t
-00034790: 6861 7420 6561 6368 2077 6f72 6b65 7220  hat each worker 
-000347a0: 656e 6473 2075 7020 7769 7468 2072 6f75  ends up with rou
-000347b0: 6768 6c79 2074 6865 2073 616d 6520 7072  ghly the same pr
-000347c0: 6f63 6573 730a 2020 2020 2020 2020 6d65  ocess.        me
-000347d0: 6d6f 7279 2028 6d61 6e61 6765 642b 756e  mory (managed+un
-000347e0: 6d61 6e61 6765 6429 2e0a 0a20 2020 2020  managed)...     
-000347f0: 2020 202e 2e20 7761 726e 696e 673a 3a0a     .. warning::.
-00034800: 2020 2020 2020 2020 2020 2054 6869 7320             This 
-00034810: 6f70 6572 6174 696f 6e20 6973 2067 656e  operation is gen
-00034820: 6572 616c 6c79 206e 6f74 2077 656c 6c20  erally not well 
-00034830: 7465 7374 6564 2061 6761 696e 7374 206e  tested against n
-00034840: 6f72 6d61 6c20 6f70 6572 6174 696f 6e20  ormal operation 
-00034850: 6f66 2074 6865 0a20 2020 2020 2020 2020  of the.         
-00034860: 2020 7363 6865 6475 6c65 722e 2049 7420    scheduler. It 
-00034870: 6973 206e 6f74 2072 6563 6f6d 6d65 6e64  is not recommend
-00034880: 6564 2074 6f20 7573 6520 6974 2077 6869  ed to use it whi
-00034890: 6c65 2077 6169 7469 6e67 206f 6e20 636f  le waiting on co
-000348a0: 6d70 7574 6174 696f 6e73 2e0a 0a20 2020  mputations...   
-000348b0: 2020 2020 202a 2a41 6c67 6f72 6974 686d       **Algorithm
-000348c0: 2a2a 0a0a 2020 2020 2020 2020 232e 2046  **..        #. F
-000348d0: 696e 6420 7468 6520 6d65 616e 206f 6363  ind the mean occ
-000348e0: 7570 616e 6379 206f 6620 7468 6520 636c  upancy of the cl
-000348f0: 7573 7465 722c 2064 6566 696e 6564 2061  uster, defined a
-00034900: 7320 6461 7461 206d 616e 6167 6564 2062  s data managed b
-00034910: 7920 6461 736b 202b 0a20 2020 2020 2020  y dask +.       
-00034920: 2020 2020 756e 6d61 6e61 6765 6420 7072      unmanaged pr
-00034930: 6f63 6573 7320 6d65 6d6f 7279 2074 6861  ocess memory tha
-00034940: 7420 6861 7320 6265 656e 2074 6865 7265  t has been there
-00034950: 2066 6f72 2061 7420 6c65 6173 7420 3330   for at least 30
-00034960: 2073 6563 6f6e 6473 0a20 2020 2020 2020   seconds.       
-00034970: 2020 2020 2860 6064 6973 7472 6962 7574      (``distribut
-00034980: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-00034990: 2e72 6563 656e 742d 746f 2d6f 6c64 2d74  .recent-to-old-t
-000349a0: 696d 6560 6029 2e0a 2020 2020 2020 2020  ime``)..        
-000349b0: 2020 2054 6869 7320 6c65 7473 2075 7320     This lets us 
-000349c0: 6967 6e6f 7265 2074 656d 706f 7261 7279  ignore temporary
-000349d0: 2073 7069 6b65 7320 6361 7573 6564 2062   spikes caused b
-000349e0: 7920 7461 736b 2068 6561 7020 7573 6167  y task heap usag
-000349f0: 652e 0a0a 2020 2020 2020 2020 2020 2041  e...           A
-00034a00: 6c74 6572 6e61 7469 7665 6c79 2c20 796f  lternatively, yo
-00034a10: 7520 6d61 7920 6368 616e 6765 2068 6f77  u may change how
-00034a20: 206d 656d 6f72 7920 6973 206d 6561 7375   memory is measu
-00034a30: 7265 6420 626f 7468 2066 6f72 2074 6865  red both for the
-00034a40: 2069 6e64 6976 6964 7561 6c0a 2020 2020   individual.    
-00034a50: 2020 2020 2020 2077 6f72 6b65 7273 2061         workers a
-00034a60: 7320 7765 6c6c 2061 7320 746f 2063 616c  s well as to cal
-00034a70: 6375 6c61 7465 2074 6865 206d 6561 6e20  culate the mean 
-00034a80: 7468 726f 7567 680a 2020 2020 2020 2020  through.        
-00034a90: 2020 2060 6064 6973 7472 6962 7574 6564     ``distributed
-00034aa0: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
-00034ab0: 6562 616c 616e 6365 2e6d 6561 7375 7265  ebalance.measure
-00034ac0: 6060 2e20 4e61 6d65 6c79 2c20 7468 6973  ``. Namely, this
-00034ad0: 2063 616e 2062 6520 7573 6566 756c 0a20   can be useful. 
-00034ae0: 2020 2020 2020 2020 2020 746f 2064 6973            to dis
-00034af0: 7265 6761 7264 2069 6e61 6363 7572 6174  regard inaccurat
-00034b00: 6520 4f53 206d 656d 6f72 7920 6d65 6173  e OS memory meas
-00034b10: 7572 656d 656e 7473 2e0a 0a20 2020 2020  urements...     
-00034b20: 2020 2023 2e20 4469 7363 6172 6420 776f     #. Discard wo
-00034b30: 726b 6572 7320 7768 6f73 6520 6f63 6375  rkers whose occu
-00034b40: 7061 6e63 7920 6973 2077 6974 6869 6e20  pancy is within 
-00034b50: 3525 206f 6620 7468 6520 6d65 616e 2063  5% of the mean c
-00034b60: 6c75 7374 6572 206f 6363 7570 616e 6379  luster occupancy
-00034b70: 0a20 2020 2020 2020 2020 2020 2860 6064  .           (``d
-00034b80: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-00034b90: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
-00034ba0: 6365 2e73 656e 6465 722d 7265 6369 7069  ce.sender-recipi
-00034bb0: 656e 742d 6761 7060 6020 2f20 3229 2e0a  ent-gap`` / 2)..
-00034bc0: 2020 2020 2020 2020 2020 2054 6869 7320             This 
-00034bd0: 6865 6c70 7320 6176 6f69 6420 6461 7461  helps avoid data
-00034be0: 2066 726f 6d20 626f 756e 6369 6e67 2061   from bouncing a
-00034bf0: 726f 756e 6420 7468 6520 636c 7573 7465  round the cluste
-00034c00: 7220 7265 7065 6174 6564 6c79 2e0a 2020  r repeatedly..  
-00034c10: 2020 2020 2020 232e 2057 6f72 6b65 7273        #. Workers
-00034c20: 2061 626f 7665 2074 6865 206d 6561 6e20   above the mean 
-00034c30: 6172 6520 7365 6e64 6572 733b 2074 686f  are senders; tho
-00034c40: 7365 2062 656c 6f77 2061 7265 2072 6563  se below are rec
-00034c50: 6970 6965 6e74 732e 0a20 2020 2020 2020  ipients..       
-00034c60: 2023 2e20 4469 7363 6172 6420 7365 6e64   #. Discard send
-00034c70: 6572 7320 7768 6f73 6520 6162 736f 6c75  ers whose absolu
-00034c80: 7465 206f 6363 7570 616e 6379 2069 7320  te occupancy is 
-00034c90: 6265 6c6f 7720 3330 250a 2020 2020 2020  below 30%.      
-00034ca0: 2020 2020 2028 6060 6469 7374 7269 6275       (``distribu
-00034cb0: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
-00034cc0: 792e 7265 6261 6c61 6e63 652e 7365 6e64  y.rebalance.send
-00034cd0: 6572 2d6d 696e 6060 292e 2049 6e20 6f74  er-min``). In ot
-00034ce0: 6865 7220 776f 7264 732c 206e 6f20 6461  her words, no da
-00034cf0: 7461 0a20 2020 2020 2020 2020 2020 6973  ta.           is
-00034d00: 206d 6f76 6564 2072 6567 6172 646c 6573   moved regardles
-00034d10: 7320 6f66 2069 6d62 616c 616e 6369 6e67  s of imbalancing
-00034d20: 2061 7320 6c6f 6e67 2061 7320 616c 6c20   as long as all 
-00034d30: 776f 726b 6572 7320 6172 6520 6265 6c6f  workers are belo
-00034d40: 7720 3330 252e 0a20 2020 2020 2020 2023  w 30%..        #
-00034d50: 2e20 4469 7363 6172 6420 7265 6369 7069  . Discard recipi
-00034d60: 656e 7473 2077 686f 7365 2061 6273 6f6c  ents whose absol
-00034d70: 7574 6520 6f63 6375 7061 6e63 7920 6973  ute occupancy is
-00034d80: 2061 626f 7665 2036 3025 0a20 2020 2020   above 60%.     
-00034d90: 2020 2020 2020 2860 6064 6973 7472 6962        (``distrib
-00034da0: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-00034db0: 7279 2e72 6562 616c 616e 6365 2e72 6563  ry.rebalance.rec
-00034dc0: 6970 6965 6e74 2d6d 6178 6060 292e 0a20  ipient-max``).. 
-00034dd0: 2020 2020 2020 2020 2020 4e6f 7465 2074            Note t
-00034de0: 6861 7420 7468 6973 2074 6872 6573 686f  hat this thresho
-00034df0: 6c64 2062 7920 6465 6661 756c 7420 6973  ld by default is
-00034e00: 2074 6865 2073 616d 6520 6173 0a20 2020   the same as.   
-00034e10: 2020 2020 2020 2020 6060 6469 7374 7269          ``distri
-00034e20: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-00034e30: 6f72 792e 7461 7267 6574 6060 2074 6f20  ory.target`` to 
-00034e40: 7072 6576 656e 7420 776f 726b 6572 7320  prevent workers 
-00034e50: 6672 6f6d 2061 6363 6570 7469 6e67 2064  from accepting d
-00034e60: 6174 610a 2020 2020 2020 2020 2020 2061  ata.           a
-00034e70: 6e64 2069 6d6d 6564 6961 7465 6c79 2073  nd immediately s
-00034e80: 7069 6c6c 696e 6720 6974 206f 7574 2074  pilling it out t
-00034e90: 6f20 6469 736b 2e0a 2020 2020 2020 2020  o disk..        
-00034ea0: 232e 2049 7465 7261 7469 7665 6c79 2070  #. Iteratively p
-00034eb0: 6963 6b20 7468 6520 7365 6e64 6572 2061  ick the sender a
-00034ec0: 6e64 2072 6563 6970 6965 6e74 2074 6861  nd recipient tha
-00034ed0: 7420 6172 6520 6661 7274 6865 7374 2066  t are farthest f
-00034ee0: 726f 6d20 7468 6520 6d65 616e 2061 6e64  rom the mean and
-00034ef0: 0a20 2020 2020 2020 2020 2020 6d6f 7665  .           move
-00034f00: 2074 6865 202a 6c65 6173 7420 7265 6365   the *least rece
-00034f10: 6e74 6c79 2069 6e73 6572 7465 642a 206b  ntly inserted* k
-00034f20: 6579 2062 6574 7765 656e 2074 6865 2074  ey between the t
-00034f30: 776f 2c20 756e 7469 6c20 6569 7468 6572  wo, until either
-00034f40: 2061 6c6c 0a20 2020 2020 2020 2020 2020   all.           
-00034f50: 7365 6e64 6572 7320 6f72 2061 6c6c 2072  senders or all r
-00034f60: 6563 6970 6965 6e74 7320 6661 6c6c 2077  ecipients fall w
-00034f70: 6974 6869 6e20 3525 206f 6620 7468 6520  ithin 5% of the 
-00034f80: 6d65 616e 2e0a 0a20 2020 2020 2020 2020  mean...         
-00034f90: 2020 4120 7265 6369 7069 656e 7420 7769    A recipient wi
-00034fa0: 6c6c 2062 6520 736b 6970 7065 6420 6966  ll be skipped if
-00034fb0: 2069 7420 616c 7265 6164 7920 6861 7320   it already has 
-00034fc0: 6120 636f 7079 206f 6620 7468 6520 6461  a copy of the da
-00034fd0: 7461 2e20 496e 206f 7468 6572 0a20 2020  ta. In other.   
-00034fe0: 2020 2020 2020 2020 776f 7264 732c 2074          words, t
-00034ff0: 6869 7320 6d65 7468 6f64 2064 6f65 7320  his method does 
-00035000: 6e6f 7420 6465 6772 6164 6520 7265 706c  not degrade repl
-00035010: 6963 6174 696f 6e2e 0a20 2020 2020 2020  ication..       
-00035020: 2020 2020 4120 6b65 7920 7769 6c6c 2062      A key will b
-00035030: 6520 736b 6970 7065 6420 6966 2074 6865  e skipped if the
-00035040: 7265 2061 7265 206e 6f20 7265 6369 7069  re are no recipi
-00035050: 656e 7473 2061 7661 696c 6162 6c65 2077  ents available w
-00035060: 6974 6820 656e 6f75 6768 206d 656d 6f72  ith enough memor
-00035070: 790a 2020 2020 2020 2020 2020 2074 6f20  y.           to 
-00035080: 6163 6365 7074 2074 6865 206b 6579 2061  accept the key a
-00035090: 6e64 2074 6861 7420 646f 6e27 7420 616c  nd that don't al
-000350a0: 7265 6164 7920 686f 6c64 2061 2063 6f70  ready hold a cop
-000350b0: 792e 0a0a 2020 2020 2020 2020 5468 6520  y...        The 
-000350c0: 6c65 6173 7420 7265 6365 6e74 6c79 2069  least recently i
-000350d0: 6e73 6572 7464 2028 4c52 4929 2070 6f6c  nsertd (LRI) pol
-000350e0: 6963 7920 6973 2061 2067 7265 6564 7920  icy is a greedy 
-000350f0: 6368 6f69 6365 2077 6974 6820 7468 6520  choice with the 
-00035100: 6164 7661 6e74 6167 6520 6f66 0a20 2020  advantage of.   
-00035110: 2020 2020 2062 6569 6e67 204f 2831 292c       being O(1),
-00035120: 2074 7269 7669 616c 2074 6f20 696d 706c   trivial to impl
-00035130: 656d 656e 7420 2869 7420 7265 6c69 6573  ement (it relies
-00035140: 206f 6e20 7079 7468 6f6e 2064 6963 7420   on python dict 
-00035150: 696e 7365 7274 696f 6e2d 736f 7274 696e  insertion-sortin
-00035160: 6729 0a20 2020 2020 2020 2061 6e64 2068  g).        and h
-00035170: 6f70 6566 756c 6c79 2067 6f6f 6420 656e  opefully good en
-00035180: 6f75 6768 2069 6e20 6d6f 7374 2063 6173  ough in most cas
-00035190: 6573 2e20 4469 7363 6172 6465 6420 616c  es. Discarded al
-000351a0: 7465 726e 6174 6976 6520 706f 6c69 6369  ternative polici
-000351b0: 6573 2077 6572 653a 0a0a 2020 2020 2020  es were:..      
-000351c0: 2020 2d20 4c61 7267 6573 7420 6669 7273    - Largest firs
-000351d0: 742e 204f 286e 2a6c 6f67 286e 2929 2073  t. O(n*log(n)) s
-000351e0: 6176 6520 666f 7220 6e6f 6e2d 7472 6976  ave for non-triv
-000351f0: 6961 6c20 6164 6469 7469 6f6e 616c 2064  ial additional d
-00035200: 6174 6120 7374 7275 6374 7572 6573 2061  ata structures a
-00035210: 6e64 0a20 2020 2020 2020 2020 2072 6973  nd.          ris
-00035220: 6b73 2063 6175 7369 6e67 2074 6865 206c  ks causing the l
-00035230: 6172 6765 7374 2063 6875 6e6b 7320 6f66  argest chunks of
-00035240: 2064 6174 6120 746f 2072 6570 6561 7465   data to repeate
-00035250: 646c 7920 6d6f 7665 2061 726f 756e 6420  dly move around 
-00035260: 7468 650a 2020 2020 2020 2020 2020 636c  the.          cl
-00035270: 7573 7465 7220 6c69 6b65 2070 696e 6261  uster like pinba
-00035280: 6c6c 732e 0a20 2020 2020 2020 202d 204c  lls..        - L
-00035290: 6561 7374 2072 6563 656e 746c 7920 7573  east recently us
-000352a0: 6564 2028 4c52 5529 2e20 5468 6973 2069  ed (LRU). This i
-000352b0: 6e66 6f72 6d61 7469 6f6e 2069 7320 6375  nformation is cu
-000352c0: 7272 656e 746c 7920 6176 6169 6c61 626c  rrently availabl
-000352d0: 6520 6f6e 2074 6865 0a20 2020 2020 2020  e on the.       
-000352e0: 2020 2077 6f72 6b65 7273 206f 6e6c 7920     workers only 
-000352f0: 616e 6420 6e6f 7420 7472 6976 6961 6c20  and not trivial 
-00035300: 746f 2072 6570 6c69 6361 7465 206f 6e20  to replicate on 
-00035310: 7468 6520 7363 6865 6475 6c65 723b 2074  the scheduler; t
-00035320: 7261 6e73 6d69 7474 696e 6720 6974 0a20  ransmitting it. 
-00035330: 2020 2020 2020 2020 206f 7665 7220 7468           over th
-00035340: 6520 6e65 7477 6f72 6b20 776f 756c 6420  e network would 
-00035350: 6265 2076 6572 7920 6578 7065 6e73 6976  be very expensiv
-00035360: 652e 2041 6c73 6f2c 206e 6f74 6520 7468  e. Also, note th
-00035370: 6174 2064 6173 6b20 7769 6c6c 2067 6f20  at dask will go 
-00035380: 6f75 7420 6f66 0a20 2020 2020 2020 2020  out of.         
-00035390: 2069 7473 2077 6179 2074 6f20 6d69 6e69   its way to mini
-000353a0: 6d69 7365 2074 6865 2061 6d6f 756e 7420  mise the amount 
-000353b0: 6f66 2074 696d 6520 696e 7465 726d 6564  of time intermed
-000353c0: 6961 7465 206b 6579 7320 6172 6520 6865  iate keys are he
-000353d0: 6c64 2069 6e20 6d65 6d6f 7279 2c0a 2020  ld in memory,.  
-000353e0: 2020 2020 2020 2020 736f 2069 6e20 7375          so in su
-000353f0: 6368 2061 2063 6173 6520 4c52 4920 6973  ch a case LRI is
-00035400: 2061 2063 6c6f 7365 2061 7070 726f 7869   a close approxi
-00035410: 6d61 7469 6f6e 206f 6620 4c52 552e 0a0a  mation of LRU...
-00035420: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-00035430: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-00035440: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6b65  -----.        ke
-00035450: 7973 3a20 6f70 7469 6f6e 616c 0a20 2020  ys: optional.   
-00035460: 2020 2020 2020 2020 2061 6c6c 6f77 6c69           allowli
-00035470: 7374 206f 6620 6461 736b 206b 6579 7320  st of dask keys 
-00035480: 7468 6174 2073 686f 756c 6420 6265 2063  that should be c
-00035490: 6f6e 7369 6465 7265 6420 666f 7220 6d6f  onsidered for mo
-000354a0: 7669 6e67 2e20 416c 6c20 6f74 6865 7220  ving. All other 
-000354b0: 6b65 7973 0a20 2020 2020 2020 2020 2020  keys.           
-000354c0: 2077 696c 6c20 6265 2069 676e 6f72 6564   will be ignored
-000354d0: 2e20 4e6f 7465 2074 6861 7420 7468 6973  . Note that this
-000354e0: 206f 6666 6572 7320 6e6f 2067 7561 7261   offers no guara
-000354f0: 6e74 6565 2074 6861 7420 6120 6b65 7920  ntee that a key 
-00035500: 7769 6c6c 2061 6374 7561 6c6c 790a 2020  will actually.  
-00035510: 2020 2020 2020 2020 2020 6265 206d 6f76            be mov
-00035520: 6564 2028 652e 672e 2062 6563 6175 7365  ed (e.g. because
-00035530: 2069 7420 6973 2075 6e6e 6563 6573 7361   it is unnecessa
-00035540: 7279 206f 7220 6265 6361 7573 6520 7468  ry or because th
-00035550: 6572 6520 6172 6520 6e6f 2076 6961 626c  ere are no viabl
-00035560: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
-00035570: 6369 7069 656e 7420 776f 726b 6572 7320  cipient workers 
-00035580: 666f 7220 6974 292e 0a20 2020 2020 2020  for it)..       
-00035590: 2077 6f72 6b65 7273 3a20 6f70 7469 6f6e   workers: option
-000355a0: 616c 0a20 2020 2020 2020 2020 2020 2061  al.            a
-000355b0: 6c6c 6f77 6c69 7374 206f 6620 776f 726b  llowlist of work
-000355c0: 6572 7320 6164 6472 6573 7365 7320 746f  ers addresses to
-000355d0: 2062 6520 636f 6e73 6964 6572 6564 2061   be considered a
-000355e0: 7320 7365 6e64 6572 7320 6f72 2072 6563  s senders or rec
-000355f0: 6970 6965 6e74 732e 0a20 2020 2020 2020  ipients..       
-00035600: 2020 2020 2041 6c6c 206f 7468 6572 2077       All other w
-00035610: 6f72 6b65 7273 2077 696c 6c20 6265 2069  orkers will be i
-00035620: 676e 6f72 6564 2e20 5468 6520 6d65 616e  gnored. The mean
-00035630: 2063 6c75 7374 6572 206f 6363 7570 616e   cluster occupan
-00035640: 6379 2077 696c 6c20 6265 0a20 2020 2020  cy will be.     
-00035650: 2020 2020 2020 2063 616c 6375 6c61 7465         calculate
-00035660: 6420 6f6e 6c79 2075 7369 6e67 2074 6865  d only using the
-00035670: 2061 6c6c 6f77 6564 2077 6f72 6b65 7273   allowed workers
-00035680: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00035690: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-000356a0: 6420 3d20 7374 696d 756c 7573 5f69 6420  d = stimulus_id 
-000356b0: 6f72 2066 2272 6562 616c 616e 6365 2d7b  or f"rebalance-{
-000356c0: 7469 6d65 2829 7d22 0a0a 2020 2020 2020  time()}"..      
-000356d0: 2020 7773 733a 2043 6f6c 6c65 6374 696f    wss: Collectio
-000356e0: 6e5b 576f 726b 6572 5374 6174 655d 0a20  n[WorkerState]. 
-000356f0: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
-00035700: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-00035710: 2020 2020 2020 2020 2020 2077 7373 203d             wss =
-00035720: 205b 7365 6c66 2e77 6f72 6b65 7273 5b77   [self.workers[w
-00035730: 5d20 666f 7220 7720 696e 2077 6f72 6b65  ] for w in worke
-00035740: 7273 5d0a 2020 2020 2020 2020 656c 7365  rs].        else
-00035750: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
-00035760: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-00035770: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
-00035780: 2020 6966 206e 6f74 2077 7373 3a0a 2020    if not wss:.  
-00035790: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000357a0: 207b 2273 7461 7475 7322 3a20 224f 4b22   {"status": "OK"
-000357b0: 7d0a 0a20 2020 2020 2020 2069 6620 6b65  }..        if ke
-000357c0: 7973 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ys is not None:.
-000357d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000357e0: 6f74 2069 7369 6e73 7461 6e63 6528 6b65  ot isinstance(ke
-000357f0: 7973 2c20 5365 7429 3a0a 2020 2020 2020  ys, Set):.      
-00035800: 2020 2020 2020 2020 2020 6b65 7973 203d            keys =
-00035810: 2073 6574 286b 6579 7329 2020 2320 756e   set(keys)  # un
-00035820: 6c65 7373 2061 6c72 6561 6479 2061 2073  less already a s
-00035830: 6574 2d6c 696b 650a 2020 2020 2020 2020  et-like.        
-00035840: 2020 2020 6966 206e 6f74 206b 6579 733a      if not keys:
-00035850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035860: 2072 6574 7572 6e20 7b22 7374 6174 7573   return {"status
-00035870: 223a 2022 4f4b 227d 0a20 2020 2020 2020  ": "OK"}.       
-00035880: 2020 2020 206d 6973 7369 6e67 5f64 6174       missing_dat
-00035890: 6120 3d20 5b0a 2020 2020 2020 2020 2020  a = [.          
-000358a0: 2020 2020 2020 6b20 666f 7220 6b20 696e        k for k in
-000358b0: 206b 6579 7320 6966 206b 206e 6f74 2069   keys if k not i
-000358c0: 6e20 7365 6c66 2e74 6173 6b73 206f 7220  n self.tasks or 
-000358d0: 6e6f 7420 7365 6c66 2e74 6173 6b73 5b6b  not self.tasks[k
-000358e0: 5d2e 7768 6f5f 6861 730a 2020 2020 2020  ].who_has.      
-000358f0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00035900: 2020 2020 6966 206d 6973 7369 6e67 5f64      if missing_d
-00035910: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
-00035920: 2020 2020 2072 6574 7572 6e20 7b22 7374       return {"st
-00035930: 6174 7573 223a 2022 7061 7274 6961 6c2d  atus": "partial-
-00035940: 6661 696c 222c 2022 6b65 7973 223a 206d  fail", "keys": m
-00035950: 6973 7369 6e67 5f64 6174 617d 0a0a 2020  issing_data}..  
-00035960: 2020 2020 2020 6d73 6773 203d 2073 656c        msgs = sel
-00035970: 662e 5f72 6562 616c 616e 6365 5f66 696e  f._rebalance_fin
-00035980: 645f 6d73 6773 286b 6579 732c 2077 7373  d_msgs(keys, wss
-00035990: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-000359a0: 206d 7367 733a 0a20 2020 2020 2020 2020   msgs:.         
-000359b0: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
-000359c0: 7573 223a 2022 4f4b 227d 0a0a 2020 2020  us": "OK"}..    
-000359d0: 2020 2020 6173 796e 6320 7769 7468 2073      async with s
-000359e0: 656c 662e 5f6c 6f63 6b3a 0a20 2020 2020  elf._lock:.     
-000359f0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00035a00: 6177 6169 7420 7365 6c66 2e5f 7265 6261  await self._reba
-00035a10: 6c61 6e63 655f 6d6f 7665 5f64 6174 6128  lance_move_data(
-00035a20: 6d73 6773 2c20 7374 696d 756c 7573 5f69  msgs, stimulus_i
-00035a30: 6429 0a20 2020 2020 2020 2020 2020 2069  d).            i
-00035a40: 6620 7265 7375 6c74 5b22 7374 6174 7573  f result["status
-00035a50: 225d 203d 3d20 2270 6172 7469 616c 2d66  "] == "partial-f
-00035a60: 6169 6c22 2061 6e64 206b 6579 7320 6973  ail" and keys is
-00035a70: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00035a80: 2020 2020 2020 2023 204f 6e6c 7920 7265         # Only re
-00035a90: 7475 726e 2066 6169 6c65 6420 6b65 7973  turn failed keys
-00035aa0: 2069 6620 7468 6520 636c 6965 6e74 2065   if the client e
-00035ab0: 7870 6c69 6369 746c 7920 6173 6b65 6420  xplicitly asked 
-00035ac0: 666f 7220 7468 656d 0a20 2020 2020 2020  for them.       
-00035ad0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00035ae0: 3d20 7b22 7374 6174 7573 223a 2022 4f4b  = {"status": "OK
-00035af0: 227d 0a20 2020 2020 2020 2020 2020 2072  "}.            r
-00035b00: 6574 7572 6e20 7265 7375 6c74 0a0a 2020  eturn result..  
-00035b10: 2020 6465 6620 5f72 6562 616c 616e 6365    def _rebalance
-00035b20: 5f66 696e 645f 6d73 6773 280a 2020 2020  _find_msgs(.    
-00035b30: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00035b40: 2020 6b65 7973 3a20 5365 745b 4861 7368    keys: Set[Hash
-00035b50: 6162 6c65 5d20 7c20 4e6f 6e65 2c0a 2020  able] | None,.  
-00035b60: 2020 2020 2020 776f 726b 6572 733a 2049        workers: I
-00035b70: 7465 7261 626c 655b 576f 726b 6572 5374  terable[WorkerSt
-00035b80: 6174 655d 2c0a 2020 2020 2920 2d3e 206c  ate],.    ) -> l
-00035b90: 6973 745b 7475 706c 655b 576f 726b 6572  ist[tuple[Worker
-00035ba0: 5374 6174 652c 2057 6f72 6b65 7253 7461  State, WorkerSta
-00035bb0: 7465 2c20 5461 736b 5374 6174 655d 5d3a  te, TaskState]]:
-00035bc0: 0a20 2020 2020 2020 2022 2222 4964 656e  .        """Iden
-00035bd0: 7469 6679 2077 6f72 6b65 7273 2074 6861  tify workers tha
-00035be0: 7420 6e65 6564 2074 6f20 6c6f 7365 206b  t need to lose k
-00035bf0: 6579 7320 616e 6420 7468 6f73 6520 7468  eys and those th
-00035c00: 6174 2063 616e 2072 6563 6569 7665 2074  at can receive t
-00035c10: 6865 6d2c 0a20 2020 2020 2020 2074 6f67  hem,.        tog
-00035c20: 6574 6865 7220 7769 7468 2068 6f77 206d  ether with how m
-00035c30: 616e 7920 6279 7465 7320 6561 6368 206e  any bytes each n
-00035c40: 6565 6473 2074 6f20 6c6f 7365 2f72 6563  eeds to lose/rec
-00035c50: 6569 7665 2e20 5468 656e 2c20 7061 6972  eive. Then, pair
-00035c60: 2061 2073 656e 6465 720a 2020 2020 2020   a sender.      
-00035c70: 2020 776f 726b 6572 2077 6974 6820 6120    worker with a 
-00035c80: 7265 6369 7069 656e 7420 776f 726b 6572  recipient worker
-00035c90: 2066 6f72 2065 6163 6820 6b65 792c 2075   for each key, u
-00035ca0: 6e74 696c 2074 6865 2063 6c75 7374 6572  ntil the cluster
-00035cb0: 2069 7320 7265 6261 6c61 6e63 6564 2e0a   is rebalanced..
-00035cc0: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
-00035cd0: 7468 6f64 206f 6e6c 7920 6465 6669 6e65  thod only define
-00035ce0: 7320 7468 6520 776f 726b 2074 6f20 6265  s the work to be
-00035cf0: 2070 6572 666f 726d 6564 3b20 6974 2064   performed; it d
-00035d00: 6f65 7320 6e6f 7420 7374 6172 7420 616e  oes not start an
-00035d10: 7920 6e65 7477 6f72 6b0a 2020 2020 2020  y network.      
-00035d20: 2020 7472 616e 7366 6572 7320 6974 7365    transfers itse
-00035d30: 6c66 2e0a 0a20 2020 2020 2020 2054 6865  lf...        The
-00035d40: 2062 6967 2d4f 2063 6f6d 706c 6578 6974   big-O complexit
-00035d50: 7920 6973 204f 2877 7420 2b20 6b65 2a6c  y is O(wt + ke*l
-00035d60: 6f67 2877 6529 292c 2077 6865 7265 0a0a  og(we)), where..
-00035d70: 2020 2020 2020 2020 2d20 7774 2069 7320          - wt is 
-00035d80: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
-00035d90: 206f 6620 776f 726b 6572 7320 6f6e 2074   of workers on t
-00035da0: 6865 2063 6c75 7374 6572 2028 6f72 2074  he cluster (or t
-00035db0: 6865 206e 756d 6265 7220 6f66 2061 6c6c  he number of all
-00035dc0: 6f77 6564 0a20 2020 2020 2020 2020 2077  owed.          w
-00035dd0: 6f72 6b65 7273 2c20 6966 2065 7870 6c69  orkers, if expli
-00035de0: 6369 746c 7920 7374 6174 6564 2062 7920  citly stated by 
-00035df0: 7468 6520 7573 6572 290a 2020 2020 2020  the user).      
-00035e00: 2020 2d20 7765 2069 7320 7468 6520 6e75    - we is the nu
-00035e10: 6d62 6572 206f 6620 776f 726b 6572 7320  mber of workers 
-00035e20: 7468 6174 2061 7265 2065 6c69 6769 626c  that are eligibl
-00035e30: 6520 746f 2062 6520 7365 6e64 6572 7320  e to be senders 
-00035e40: 6f72 2072 6563 6970 6965 6e74 730a 2020  or recipients.  
-00035e50: 2020 2020 2020 2d20 6b74 2069 7320 7468        - kt is th
-00035e60: 6520 746f 7461 6c20 6e75 6d62 6572 206f  e total number o
-00035e70: 6620 6b65 7973 206f 6e20 7468 6520 636c  f keys on the cl
-00035e80: 7573 7465 7220 286f 7220 6f6e 2074 6865  uster (or on the
-00035e90: 2061 6c6c 6f77 6564 2077 6f72 6b65 7273   allowed workers
-00035ea0: 290a 2020 2020 2020 2020 2d20 6b65 2069  ).        - ke i
-00035eb0: 7320 7468 6520 6e75 6d62 6572 206f 6620  s the number of 
-00035ec0: 6b65 7973 2074 6861 7420 6e65 6564 2074  keys that need t
-00035ed0: 6f20 6265 206d 6f76 6564 2069 6e20 6f72  o be moved in or
-00035ee0: 6465 7220 746f 2061 6368 6965 7665 2061  der to achieve a
-00035ef0: 2062 616c 616e 6365 640a 2020 2020 2020   balanced.      
-00035f00: 2020 2020 636c 7573 7465 720a 0a20 2020      cluster..   
-00035f10: 2020 2020 2054 6865 7265 2069 7320 6120       There is a 
-00035f20: 6465 6765 6e65 7261 7465 2065 6467 6520  degenerate edge 
-00035f30: 6361 7365 204f 2877 7420 2b20 6b74 2a6c  case O(wt + kt*l
-00035f40: 6f67 2877 6529 2920 7768 656e 206b 7420  og(we)) when kt 
-00035f50: 6973 206d 7563 6820 6772 6561 7465 7220  is much greater 
-00035f60: 7468 616e 0a20 2020 2020 2020 2074 6865  than.        the
-00035f70: 206e 756d 6265 7220 6f66 2061 6c6c 6f77   number of allow
-00035f80: 6564 206b 6579 732c 206f 7220 7768 656e  ed keys, or when
-00035f90: 206d 6f73 7420 6b65 7973 2061 7265 2072   most keys are r
-00035fa0: 6570 6c69 6361 7465 6420 6f72 2063 616e  eplicated or can
-00035fb0: 6e6f 7420 6265 0a20 2020 2020 2020 206d  not be.        m
-00035fc0: 6f76 6564 2066 6f72 2073 6f6d 6520 6f74  oved for some ot
-00035fd0: 6865 7220 7265 6173 6f6e 2e0a 0a20 2020  her reason...   
-00035fe0: 2020 2020 2052 6574 7572 6e73 206c 6973       Returns lis
-00035ff0: 7420 6f66 2074 7570 6c65 7320 746f 2066  t of tuples to f
-00036000: 6565 6420 696e 746f 205f 7265 6261 6c61  eed into _rebala
-00036010: 6e63 655f 6d6f 7665 5f64 6174 613a 0a0a  nce_move_data:..
-00036020: 2020 2020 2020 2020 2d20 7365 6e64 6572          - sender
-00036030: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
-00036040: 2d20 7265 6369 7069 656e 7420 776f 726b  - recipient work
-00036050: 6572 0a20 2020 2020 2020 202d 2074 6173  er.        - tas
-00036060: 6b20 746f 2062 6520 7472 616e 7366 6572  k to be transfer
-00036070: 7265 640a 2020 2020 2020 2020 2222 220a  red.        """.
-00036080: 2020 2020 2020 2020 2320 4865 6170 7320          # Heaps 
-00036090: 6f66 2077 6f72 6b65 7273 2c20 6d61 6e61  of workers, mana
-000360a0: 6765 6420 6279 2074 6865 2068 6561 7071  ged by the heapq
-000360b0: 206d 6f64 756c 652c 2074 6861 7420 6e65   module, that ne
-000360c0: 6564 2074 6f20 7365 6e64 2f72 6563 6569  ed to send/recei
-000360d0: 7665 2064 6174 612c 0a20 2020 2020 2020  ve data,.       
-000360e0: 2023 2077 6974 6820 686f 7720 6d61 6e79   # with how many
-000360f0: 2062 7974 6573 2065 6163 6820 6e65 6564   bytes each need
-00036100: 7320 746f 2073 656e 642f 7265 6365 6976  s to send/receiv
-00036110: 652e 0a20 2020 2020 2020 2023 0a20 2020  e..        #.   
-00036120: 2020 2020 2023 2045 6163 6820 656c 656d       # Each elem
-00036130: 656e 7420 6f66 2074 6865 2068 6561 7020  ent of the heap 
-00036140: 6973 2061 2074 7570 6c65 2063 6f6e 7374  is a tuple const
-00036150: 7275 6374 6564 2061 7320 666f 6c6c 6f77  ructed as follow
-00036160: 733a 0a20 2020 2020 2020 2023 202d 2073  s:.        # - s
-00036170: 6e64 5f62 7974 6573 5f6d 6178 2f72 6563  nd_bytes_max/rec
-00036180: 5f62 7974 6573 5f6d 6178 3a20 6d61 7869  _bytes_max: maxi
-00036190: 6d75 6d20 6e75 6d62 6572 206f 6620 6279  mum number of by
-000361a0: 7465 7320 746f 2073 656e 6420 6f72 2072  tes to send or r
-000361b0: 6563 6569 7665 2e0a 2020 2020 2020 2020  eceive..        
-000361c0: 2320 2020 5468 6973 206e 756d 6265 7220  #   This number 
-000361d0: 6973 206e 6567 6174 6976 652c 2073 6f20  is negative, so 
-000361e0: 7468 6174 2074 6865 2077 6f72 6b65 7273  that the workers
-000361f0: 2066 6172 7468 6573 7420 6672 6f6d 2074   farthest from t
-00036200: 6865 2063 6c75 7374 6572 206d 6561 6e0a  he cluster mean.
-00036210: 2020 2020 2020 2020 2320 2020 6172 6520          #   are 
-00036220: 6174 2074 6865 2074 6f70 206f 6620 7468  at the top of th
-00036230: 6520 736d 616c 6c65 7374 2d66 6972 7374  e smallest-first
-00036240: 2068 6561 7073 2e0a 2020 2020 2020 2020   heaps..        
-00036250: 2320 2d20 736e 645f 6279 7465 735f 6d69  # - snd_bytes_mi
-00036260: 6e2f 7265 635f 6279 7465 735f 6d69 6e3a  n/rec_bytes_min:
-00036270: 206d 696e 696d 756d 206e 756d 6265 7220   minimum number 
-00036280: 6f66 2062 7974 6573 2061 6674 6572 2073  of bytes after s
-00036290: 656e 6469 6e67 2f72 6563 6569 7669 6e67  ending/receiving
-000362a0: 0a20 2020 2020 2020 2023 2020 2077 6869  .        #   whi
-000362b0: 6368 2074 6865 2077 6f72 6b65 7220 7368  ch the worker sh
-000362c0: 6f75 6c64 206e 6f74 2062 6520 636f 6e73  ould not be cons
-000362d0: 6964 6572 6564 2061 6e79 6d6f 7265 2e20  idered anymore. 
-000362e0: 5468 6973 2069 7320 616c 736f 206e 6567  This is also neg
-000362f0: 6174 6976 652e 0a20 2020 2020 2020 2023  ative..        #
-00036300: 202d 2061 7262 6974 7261 7279 2075 6e69   - arbitrary uni
-00036310: 7175 6520 6e75 6d62 6572 2c20 7468 6572  que number, ther
-00036320: 6520 6a75 7374 2074 6f20 746f 206d 616b  e just to to mak
-00036330: 6520 7375 7265 2074 6861 7420 576f 726b  e sure that Work
-00036340: 6572 5374 6174 6520 6f62 6a65 6374 730a  erState objects.
-00036350: 2020 2020 2020 2020 2320 2020 6172 6520          #   are 
-00036360: 6e65 7665 7220 7573 6564 2066 6f72 2073  never used for s
-00036370: 6f72 7469 6e67 2069 6e20 7468 6520 756e  orting in the un
-00036380: 6c69 6b65 6c79 2065 7665 6e74 2074 6861  likely event tha
-00036390: 7420 7477 6f20 7072 6f63 6573 7365 7320  t two processes 
-000363a0: 6861 7665 0a20 2020 2020 2020 2023 2020  have.        #  
-000363b0: 2065 7861 6374 6c79 2074 6865 2073 616d   exactly the sam
-000363c0: 6520 6e75 6d62 6572 206f 6620 6279 7465  e number of byte
-000363d0: 7320 616c 6c6f 6361 7465 642e 0a20 2020  s allocated..   
-000363e0: 2020 2020 2023 202d 2057 6f72 6b65 7253       # - WorkerS
-000363f0: 7461 7465 0a20 2020 2020 2020 2023 202d  tate.        # -
-00036400: 2069 7465 7261 746f 7220 6f66 2061 6c6c   iterator of all
-00036410: 2074 6173 6b73 2069 6e20 6d65 6d6f 7279   tasks in memory
-00036420: 206f 6e20 7468 6520 776f 726b 6572 2028   on the worker (
-00036430: 7365 6e64 6572 7320 6f6e 6c79 292c 2069  senders only), i
-00036440: 6e73 6572 7469 6f6e 0a20 2020 2020 2020  nsertion.       
-00036450: 2023 2020 2073 6f72 7465 6420 286c 6561   #   sorted (lea
-00036460: 7374 2072 6563 656e 746c 7920 696e 7365  st recently inse
-00036470: 7274 6564 2066 6972 7374 292e 0a20 2020  rted first)..   
-00036480: 2020 2020 2023 2020 204e 6f74 6520 7468       #   Note th
-00036490: 6174 2074 6869 7320 6974 6572 6174 6f72  at this iterator
-000364a0: 2077 696c 6c20 7479 7069 6361 6c6c 7920   will typically 
-000364b0: 2a6e 6f74 2a20 6265 2065 7868 6175 7374  *not* be exhaust
-000364c0: 6564 2e20 4974 2077 696c 6c20 6f6e 6c79  ed. It will only
-000364d0: 2062 650a 2020 2020 2020 2020 2320 2020   be.        #   
-000364e0: 6578 6861 7573 7465 6420 6966 2c20 6166  exhausted if, af
-000364f0: 7465 7220 6d6f 7669 6e67 2061 7761 7920  ter moving away 
-00036500: 6672 6f6d 2074 6865 2077 6f72 6b65 7220  from the worker 
-00036510: 616c 6c20 6b65 7973 2074 6861 7420 6361  all keys that ca
-00036520: 6e20 6265 206d 6f76 6564 2c0a 2020 2020  n be moved,.    
-00036530: 2020 2020 2320 2020 6973 2069 6e73 7566      #   is insuf
-00036540: 6669 6369 656e 7420 746f 2064 726f 7020  ficient to drop 
-00036550: 736e 645f 6279 7465 735f 6d69 6e20 6162  snd_bytes_min ab
-00036560: 6f76 6520 302e 0a20 2020 2020 2020 2073  ove 0..        s
-00036570: 656e 6465 7273 3a20 6c69 7374 5b74 7570  enders: list[tup
-00036580: 6c65 5b69 6e74 2c20 696e 742c 2069 6e74  le[int, int, int
-00036590: 2c20 576f 726b 6572 5374 6174 652c 2049  , WorkerState, I
-000365a0: 7465 7261 746f 725b 5461 736b 5374 6174  terator[TaskStat
-000365b0: 655d 5d5d 203d 205b 5d0a 2020 2020 2020  e]]] = [].      
-000365c0: 2020 7265 6369 7069 656e 7473 3a20 6c69    recipients: li
-000365d0: 7374 5b74 7570 6c65 5b69 6e74 2c20 696e  st[tuple[int, in
-000365e0: 742c 2069 6e74 2c20 576f 726b 6572 5374  t, int, WorkerSt
-000365f0: 6174 655d 5d20 3d20 5b5d 0a0a 2020 2020  ate]] = []..    
-00036600: 2020 2020 2320 4f75 7470 7574 3a20 5b28      # Output: [(
-00036610: 7365 6e64 6572 2c20 7265 6369 7069 656e  sender, recipien
-00036620: 742c 2074 6173 6b29 2c20 2e2e 2e5d 0a20  t, task), ...]. 
-00036630: 2020 2020 2020 206d 7367 733a 206c 6973         msgs: lis
-00036640: 745b 7475 706c 655b 576f 726b 6572 5374  t[tuple[WorkerSt
-00036650: 6174 652c 2057 6f72 6b65 7253 7461 7465  ate, WorkerState
-00036660: 2c20 5461 736b 5374 6174 655d 5d20 3d20  , TaskState]] = 
-00036670: 5b5d 0a0a 2020 2020 2020 2020 2320 4279  []..        # By
-00036680: 2064 6566 6175 6c74 2c20 7468 6973 2069   default, this i
-00036690: 7320 7468 6520 6f70 7469 6d69 7374 6963  s the optimistic
-000366a0: 206d 656d 6f72 792c 206d 6561 6e69 6e67   memory, meaning
-000366b0: 2074 6f74 616c 2070 726f 6365 7373 206d   total process m
-000366c0: 656d 6f72 7920 6d69 6e75 730a 2020 2020  emory minus.    
-000366d0: 2020 2020 2320 756e 6d61 6e61 6765 6420      # unmanaged 
-000366e0: 6d65 6d6f 7279 2074 6861 7420 6170 7065  memory that appe
-000366f0: 6172 6564 206f 7665 7220 7468 6520 6c61  ared over the la
-00036700: 7374 2033 3020 7365 636f 6e64 730a 2020  st 30 seconds.  
-00036710: 2020 2020 2020 2320 2864 6973 7472 6962        # (distrib
-00036720: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-00036730: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
-00036740: 2d74 696d 6529 2e0a 2020 2020 2020 2020  -time)..        
-00036750: 2320 5468 6973 206c 6574 7320 7573 2069  # This lets us i
-00036760: 676e 6f72 6520 7465 6d70 6f72 6172 7920  gnore temporary 
-00036770: 7370 696b 6573 2063 6175 7365 6420 6279  spikes caused by
-00036780: 2074 6173 6b20 6865 6170 2075 7361 6765   task heap usage
-00036790: 2e0a 2020 2020 2020 2020 6d65 6d6f 7279  ..        memory
-000367a0: 5f62 795f 776f 726b 6572 203d 205b 0a20  _by_worker = [. 
-000367b0: 2020 2020 2020 2020 2020 2028 7773 2c20             (ws, 
-000367c0: 6765 7461 7474 7228 7773 2e6d 656d 6f72  getattr(ws.memor
-000367d0: 792c 2073 656c 662e 4d45 4d4f 5259 5f52  y, self.MEMORY_R
-000367e0: 4542 414c 414e 4345 5f4d 4541 5355 5245  EBALANCE_MEASURE
-000367f0: 2929 2066 6f72 2077 7320 696e 2077 6f72  )) for ws in wor
-00036800: 6b65 7273 0a20 2020 2020 2020 205d 0a20  kers.        ]. 
-00036810: 2020 2020 2020 206d 6561 6e5f 6d65 6d6f         mean_memo
-00036820: 7279 203d 2073 756d 286d 2066 6f72 205f  ry = sum(m for _
-00036830: 2c20 6d20 696e 206d 656d 6f72 795f 6279  , m in memory_by
-00036840: 5f77 6f72 6b65 7229 202f 2f20 6c65 6e28  _worker) // len(
-00036850: 6d65 6d6f 7279 5f62 795f 776f 726b 6572  memory_by_worker
-00036860: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
-00036870: 732c 2077 735f 6d65 6d6f 7279 2069 6e20  s, ws_memory in 
-00036880: 6d65 6d6f 7279 5f62 795f 776f 726b 6572  memory_by_worker
-00036890: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000368a0: 2077 732e 6d65 6d6f 7279 5f6c 696d 6974   ws.memory_limit
-000368b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000368c0: 2020 6861 6c66 5f67 6170 203d 2069 6e74    half_gap = int
-000368d0: 2873 656c 662e 4d45 4d4f 5259 5f52 4542  (self.MEMORY_REB
-000368e0: 414c 414e 4345 5f48 414c 465f 4741 5020  ALANCE_HALF_GAP 
-000368f0: 2a20 7773 2e6d 656d 6f72 795f 6c69 6d69  * ws.memory_limi
-00036900: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00036910: 2020 2073 656e 6465 725f 6d69 6e20 3d20     sender_min = 
-00036920: 7365 6c66 2e4d 454d 4f52 595f 5245 4241  self.MEMORY_REBA
-00036930: 4c41 4e43 455f 5345 4e44 4552 5f4d 494e  LANCE_SENDER_MIN
-00036940: 202a 2077 732e 6d65 6d6f 7279 5f6c 696d   * ws.memory_lim
-00036950: 6974 0a20 2020 2020 2020 2020 2020 2020  it.             
-00036960: 2020 2072 6563 6970 6965 6e74 5f6d 6178     recipient_max
-00036970: 203d 2073 656c 662e 4d45 4d4f 5259 5f52   = self.MEMORY_R
-00036980: 4542 414c 414e 4345 5f52 4543 4950 4945  EBALANCE_RECIPIE
-00036990: 4e54 5f4d 4158 202a 2077 732e 6d65 6d6f  NT_MAX * ws.memo
-000369a0: 7279 5f6c 696d 6974 0a20 2020 2020 2020  ry_limit.       
-000369b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000369c0: 2020 2020 2020 2020 2020 2068 616c 665f             half_
-000369d0: 6761 7020 3d20 300a 2020 2020 2020 2020  gap = 0.        
-000369e0: 2020 2020 2020 2020 7365 6e64 6572 5f6d          sender_m
-000369f0: 696e 203d 2030 2e30 0a20 2020 2020 2020  in = 0.0.       
-00036a00: 2020 2020 2020 2020 2072 6563 6970 6965           recipie
-00036a10: 6e74 5f6d 6178 203d 206d 6174 682e 696e  nt_max = math.in
-00036a20: 660a 0a20 2020 2020 2020 2020 2020 2069  f..            i
-00036a30: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00036a40: 2020 2020 7773 2e5f 6861 735f 7768 6174      ws._has_what
-00036a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036a60: 2061 6e64 2077 735f 6d65 6d6f 7279 203e   and ws_memory >
-00036a70: 3d20 6d65 616e 5f6d 656d 6f72 7920 2b20  = mean_memory + 
-00036a80: 6861 6c66 5f67 6170 0a20 2020 2020 2020  half_gap.       
-00036a90: 2020 2020 2020 2020 2061 6e64 2077 735f           and ws_
-00036aa0: 6d65 6d6f 7279 203e 3d20 7365 6e64 6572  memory >= sender
-00036ab0: 5f6d 696e 0a20 2020 2020 2020 2020 2020  _min.           
-00036ac0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00036ad0: 2020 2020 2320 5468 6973 206d 6179 2073      # This may s
-00036ae0: 656e 6420 7468 6520 776f 726b 6572 2062  end the worker b
-00036af0: 656c 6f77 2073 656e 6465 725f 6d69 6e20  elow sender_min 
-00036b00: 2862 7920 6465 7369 676e 290a 2020 2020  (by design).    
-00036b10: 2020 2020 2020 2020 2020 2020 736e 645f              snd_
-00036b20: 6279 7465 735f 6d61 7820 3d20 6d65 616e  bytes_max = mean
-00036b30: 5f6d 656d 6f72 7920 2d20 7773 5f6d 656d  _memory - ws_mem
-00036b40: 6f72 7920 2023 206e 6567 6174 6976 650a  ory  # negative.
-00036b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036b60: 736e 645f 6279 7465 735f 6d69 6e20 3d20  snd_bytes_min = 
-00036b70: 736e 645f 6279 7465 735f 6d61 7820 2b20  snd_bytes_max + 
-00036b80: 6861 6c66 5f67 6170 2020 2320 6e65 6761  half_gap  # nega
-00036b90: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
-00036ba0: 2020 2020 2023 2053 6565 2064 6566 696e       # See defin
-00036bb0: 6974 696f 6e20 6f66 2073 656e 6465 7273  ition of senders
-00036bc0: 2061 626f 7665 0a20 2020 2020 2020 2020   above.         
-00036bd0: 2020 2020 2020 2073 656e 6465 7273 2e61         senders.a
-00036be0: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-00036bf0: 2020 2020 2020 2020 2020 2028 736e 645f             (snd_
-00036c00: 6279 7465 735f 6d61 782c 2073 6e64 5f62  bytes_max, snd_b
-00036c10: 7974 6573 5f6d 696e 2c20 6964 2877 7329  ytes_min, id(ws)
-00036c20: 2c20 7773 2c20 6974 6572 2877 732e 5f68  , ws, iter(ws._h
-00036c30: 6173 5f77 6861 7429 290a 2020 2020 2020  as_what)).      
-00036c40: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00036c50: 2020 2020 2020 2020 656c 6966 2077 735f          elif ws_
-00036c60: 6d65 6d6f 7279 203c 206d 6561 6e5f 6d65  memory < mean_me
-00036c70: 6d6f 7279 202d 2068 616c 665f 6761 7020  mory - half_gap 
-00036c80: 616e 6420 7773 5f6d 656d 6f72 7920 3c20  and ws_memory < 
-00036c90: 7265 6369 7069 656e 745f 6d61 783a 0a20  recipient_max:. 
-00036ca0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00036cb0: 2054 6869 7320 6d61 7920 7365 6e64 2074   This may send t
-00036cc0: 6865 2077 6f72 6b65 7220 6162 6f76 6520  he worker above 
-00036cd0: 7265 6369 7069 656e 745f 6d61 7820 2862  recipient_max (b
-00036ce0: 7920 6465 7369 676e 290a 2020 2020 2020  y design).      
-00036cf0: 2020 2020 2020 2020 2020 7265 635f 6279            rec_by
-00036d00: 7465 735f 6d61 7820 3d20 7773 5f6d 656d  tes_max = ws_mem
-00036d10: 6f72 7920 2d20 6d65 616e 5f6d 656d 6f72  ory - mean_memor
-00036d20: 7920 2023 206e 6567 6174 6976 650a 2020  y  # negative.  
-00036d30: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00036d40: 635f 6279 7465 735f 6d69 6e20 3d20 7265  c_bytes_min = re
-00036d50: 635f 6279 7465 735f 6d61 7820 2b20 6861  c_bytes_max + ha
-00036d60: 6c66 5f67 6170 2020 2320 6e65 6761 7469  lf_gap  # negati
-00036d70: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
-00036d80: 2020 2023 2053 6565 2064 6566 696e 6974     # See definit
-00036d90: 696f 6e20 6f66 2072 6563 6970 6965 6e74  ion of recipient
-00036da0: 7320 6162 6f76 650a 2020 2020 2020 2020  s above.        
-00036db0: 2020 2020 2020 2020 7265 6369 7069 656e          recipien
-00036dc0: 7473 2e61 7070 656e 6428 2872 6563 5f62  ts.append((rec_b
-00036dd0: 7974 6573 5f6d 6178 2c20 7265 635f 6279  ytes_max, rec_by
-00036de0: 7465 735f 6d69 6e2c 2069 6428 7773 292c  tes_min, id(ws),
-00036df0: 2077 7329 290a 0a20 2020 2020 2020 2023   ws))..        #
-00036e00: 2046 6173 7420 6578 6974 2069 6e20 6361   Fast exit in ca
-00036e10: 7365 206e 6f20 7472 616e 7366 6572 7320  se no transfers 
-00036e20: 6172 6520 6e65 6365 7373 6172 7920 6f72  are necessary or
-00036e30: 2070 6f73 7369 626c 650a 2020 2020 2020   possible.      
-00036e40: 2020 6966 206e 6f74 2073 656e 6465 7273    if not senders
-00036e50: 206f 7220 6e6f 7420 7265 6369 7069 656e   or not recipien
-00036e60: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00036e70: 7365 6c66 2e6c 6f67 5f65 7665 6e74 280a  self.log_event(.
-00036e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036e90: 2261 6c6c 222c 0a20 2020 2020 2020 2020  "all",.         
-00036ea0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00036eb0: 2020 2020 2020 2020 2020 2020 2022 6163               "ac
-00036ec0: 7469 6f6e 223a 2022 7265 6261 6c61 6e63  tion": "rebalanc
-00036ed0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00036ee0: 2020 2020 2020 2020 2273 656e 6465 7273          "senders
-00036ef0: 223a 206c 656e 2873 656e 6465 7273 292c  ": len(senders),
-00036f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036f10: 2020 2020 2022 7265 6369 7069 656e 7473       "recipients
-00036f20: 223a 206c 656e 2872 6563 6970 6965 6e74  ": len(recipient
-00036f30: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00036f40: 2020 2020 2020 2020 226d 6f76 6564 5f6b          "moved_k
-00036f50: 6579 7322 3a20 302c 0a20 2020 2020 2020  eys": 0,.       
-00036f60: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00036f70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00036f80: 2020 2020 2020 7265 7475 726e 205b 5d0a        return [].
-00036f90: 0a20 2020 2020 2020 2068 6561 7071 2e68  .        heapq.h
-00036fa0: 6561 7069 6679 2873 656e 6465 7273 290a  eapify(senders).
-00036fb0: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
-00036fc0: 6170 6966 7928 7265 6369 7069 656e 7473  apify(recipients
-00036fd0: 290a 0a20 2020 2020 2020 2077 6869 6c65  )..        while
-00036fe0: 2073 656e 6465 7273 2061 6e64 2072 6563   senders and rec
-00036ff0: 6970 6965 6e74 733a 0a20 2020 2020 2020  ipients:.       
-00037000: 2020 2020 2073 6e64 5f62 7974 6573 5f6d       snd_bytes_m
-00037010: 6178 2c20 736e 645f 6279 7465 735f 6d69  ax, snd_bytes_mi
-00037020: 6e2c 205f 2c20 736e 645f 7773 2c20 7473  n, _, snd_ws, ts
-00037030: 5f69 7465 7220 3d20 7365 6e64 6572 735b  _iter = senders[
-00037040: 305d 0a0a 2020 2020 2020 2020 2020 2020  0]..            
-00037050: 2320 4974 6572 6174 6520 7468 726f 7567  # Iterate throug
-00037060: 6820 7461 736b 7320 696e 206d 656d 6f72  h tasks in memor
-00037070: 792c 206c 6561 7374 2072 6563 656e 746c  y, least recentl
-00037080: 7920 696e 7365 7274 6564 2066 6972 7374  y inserted first
-00037090: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000370a0: 2074 7320 696e 2074 735f 6974 6572 3a0a   ts in ts_iter:.
-000370b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000370c0: 6966 206b 6579 7320 6973 206e 6f74 204e  if keys is not N
-000370d0: 6f6e 6520 616e 6420 7473 2e6b 6579 206e  one and ts.key n
-000370e0: 6f74 2069 6e20 6b65 7973 3a0a 2020 2020  ot in keys:.    
-000370f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037100: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00037110: 2020 2020 2020 2020 206e 6279 7465 7320           nbytes 
-00037120: 3d20 7473 2e6e 6279 7465 730a 2020 2020  = ts.nbytes.    
-00037130: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00037140: 6279 7465 7320 2b20 736e 645f 6279 7465  bytes + snd_byte
-00037150: 735f 6d61 7820 3e20 303a 0a20 2020 2020  s_max > 0:.     
-00037160: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00037170: 204d 6f76 696e 6720 7468 6973 2074 6173   Moving this tas
-00037180: 6b20 776f 756c 6420 6361 7573 6520 7468  k would cause th
-00037190: 6520 7365 6e64 6572 2074 6f20 676f 2062  e sender to go b
-000371a0: 656c 6f77 206d 6561 6e20 616e 640a 2020  elow mean and.  
-000371b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000371c0: 2020 2320 706f 7465 6e74 6961 6c6c 7920    # potentially 
-000371d0: 7269 736b 2062 6563 6f6d 696e 6720 6120  risk becoming a 
-000371e0: 7265 6369 7069 656e 742c 2077 6869 6368  recipient, which
-000371f0: 2077 6f75 6c64 2063 6175 7365 2074 6173   would cause tas
-00037200: 6b73 2074 6f0a 2020 2020 2020 2020 2020  ks to.          
-00037210: 2020 2020 2020 2020 2020 2320 626f 756e            # boun
-00037220: 6365 2061 726f 756e 642e 204d 6f76 6520  ce around. Move 
-00037230: 6f6e 2074 6f20 7468 6520 6e65 7874 2074  on to the next t
-00037240: 6173 6b20 6f66 2074 6865 2073 616d 6520  ask of the same 
-00037250: 7365 6e64 6572 2e0a 2020 2020 2020 2020  sender..        
-00037260: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00037270: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-00037280: 2020 2020 2020 2320 4669 6e64 2074 6865        # Find the
-00037290: 2072 6563 6970 6965 6e74 2c20 6661 7274   recipient, fart
-000372a0: 6865 7374 2066 726f 6d20 7468 6520 6d65  hest from the me
-000372b0: 616e 2c20 7768 6963 680a 2020 2020 2020  an, which.      
-000372c0: 2020 2020 2020 2020 2020 2320 312e 2068            # 1. h
-000372d0: 6173 2065 6e6f 7567 6820 6176 6169 6c61  as enough availa
-000372e0: 626c 6520 5241 4d20 666f 7220 7468 6973  ble RAM for this
-000372f0: 2074 6173 6b2c 2061 6e64 0a20 2020 2020   task, and.     
-00037300: 2020 2020 2020 2020 2020 2023 2032 2e20             # 2. 
-00037310: 646f 6573 6e27 7420 686f 6c64 2061 2063  doesn't hold a c
-00037320: 6f70 7920 6f66 2074 6869 7320 7461 736b  opy of this task
-00037330: 2061 6c72 6561 6479 0a20 2020 2020 2020   already.       
-00037340: 2020 2020 2020 2020 2023 2054 6865 7265           # There
-00037350: 206d 6179 206e 6f74 2062 6520 616e 7920   may not be any 
-00037360: 7468 6174 2073 6174 6973 6669 6573 2074  that satisfies t
-00037370: 6865 7365 2063 6f6e 6469 7469 6f6e 733b  hese conditions;
-00037380: 2069 6e20 7468 6973 2063 6173 650a 2020   in this case.  
-00037390: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000373a0: 7468 6973 2074 6173 6b20 776f 6e27 7420  this task won't 
-000373b0: 6265 206d 6f76 6564 2e0a 2020 2020 2020  be moved..      
-000373c0: 2020 2020 2020 2020 2020 736b 6970 7065            skippe
-000373d0: 645f 7265 6369 7069 656e 7473 203d 205b  d_recipients = [
-000373e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000373f0: 2020 7573 655f 7265 6369 7069 656e 7420    use_recipient 
-00037400: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00037410: 2020 2020 2020 2020 7768 696c 6520 7265          while re
-00037420: 6369 7069 656e 7473 2061 6e64 206e 6f74  cipients and not
-00037430: 2075 7365 5f72 6563 6970 6965 6e74 3a0a   use_recipient:.
-00037440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037450: 2020 2020 7265 635f 6279 7465 735f 6d61      rec_bytes_ma
-00037460: 782c 2072 6563 5f62 7974 6573 5f6d 696e  x, rec_bytes_min
-00037470: 2c20 5f2c 2072 6563 5f77 7320 3d20 7265  , _, rec_ws = re
-00037480: 6369 7069 656e 7473 5b30 5d0a 2020 2020  cipients[0].    
-00037490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000374a0: 6966 206e 6279 7465 7320 2b20 7265 635f  if nbytes + rec_
-000374b0: 6279 7465 735f 6d61 7820 3e20 303a 0a20  bytes_max > 0:. 
-000374c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000374d0: 2020 2020 2020 2023 2072 6563 6970 6965         # recipie
-000374e0: 6e74 7320 6172 6520 736f 7274 6564 2062  nts are sorted b
-000374f0: 7920 7265 635f 6279 7465 735f 6d61 782e  y rec_bytes_max.
-00037500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037510: 2020 2020 2020 2020 2023 2054 6865 206e           # The n
-00037520: 6578 7420 6f6e 6573 2077 696c 6c20 6265  ext ones will be
-00037530: 2077 6f72 7365 3b20 6e6f 2072 6561 736f   worse; no reaso
-00037540: 6e20 746f 2063 6f6e 7469 6e75 6520 6974  n to continue it
-00037550: 6572 6174 696e 670a 2020 2020 2020 2020  erating.        
-00037560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037570: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-00037580: 2020 2020 2020 2020 2020 7573 655f 7265            use_re
-00037590: 6369 7069 656e 7420 3d20 7473 206e 6f74  cipient = ts not
-000375a0: 2069 6e20 7265 635f 7773 2e5f 6861 735f   in rec_ws._has_
-000375b0: 7768 6174 0a20 2020 2020 2020 2020 2020  what.           
-000375c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-000375d0: 7573 655f 7265 6369 7069 656e 743a 0a20  use_recipient:. 
-000375e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000375f0: 2020 2020 2020 2073 6b69 7070 6564 5f72         skipped_r
-00037600: 6563 6970 6965 6e74 732e 6170 7065 6e64  ecipients.append
-00037610: 2868 6561 7071 2e68 6561 7070 6f70 2872  (heapq.heappop(r
-00037620: 6563 6970 6965 6e74 7329 290a 0a20 2020  ecipients))..   
-00037630: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00037640: 2072 6563 6970 6965 6e74 2069 6e20 736b   recipient in sk
-00037650: 6970 7065 645f 7265 6369 7069 656e 7473  ipped_recipients
-00037660: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00037670: 2020 2020 2020 6865 6170 712e 6865 6170        heapq.heap
-00037680: 7075 7368 2872 6563 6970 6965 6e74 732c  push(recipients,
-00037690: 2072 6563 6970 6965 6e74 290a 0a20 2020   recipient)..   
-000376a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000376b0: 6e6f 7420 7573 655f 7265 6369 7069 656e  not use_recipien
-000376c0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-000376d0: 2020 2020 2020 2023 2054 6869 7320 7461         # This ta
-000376e0: 736b 2068 6173 206e 6f20 7265 6369 7069  sk has no recipi
-000376f0: 656e 7473 2061 7661 696c 6162 6c65 2e20  ents available. 
-00037700: 4c65 6176 6520 6974 206f 6e20 7468 6520  Leave it on the 
-00037710: 7365 6e64 6572 2061 6e64 0a20 2020 2020  sender and.     
-00037720: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00037730: 206d 6f76 6520 6f6e 2074 6f20 7468 6520   move on to the 
-00037740: 6e65 7874 2074 6173 6b20 6f66 2074 6865  next task of the
-00037750: 2073 616d 6520 7365 6e64 6572 2e0a 2020   same sender..  
-00037760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037770: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-00037780: 2020 2020 2020 2020 2020 2020 2320 5363              # Sc
-00037790: 6865 6475 6c65 2074 6173 6b20 666f 7220  hedule task for 
-000377a0: 7472 616e 7366 6572 2066 726f 6d20 7365  transfer from se
-000377b0: 6e64 6572 2074 6f20 7265 6369 7069 656e  nder to recipien
-000377c0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-000377d0: 2020 6d73 6773 2e61 7070 656e 6428 2873    msgs.append((s
-000377e0: 6e64 5f77 732c 2072 6563 5f77 732c 2074  nd_ws, rec_ws, t
-000377f0: 7329 290a 0a20 2020 2020 2020 2020 2020  s))..           
-00037800: 2020 2020 2023 202a 5f62 7974 6573 5f6d       # *_bytes_m
-00037810: 6178 2f6d 696e 2061 7265 2061 6c6c 206e  ax/min are all n
-00037820: 6567 6174 6976 6520 666f 7220 6865 6170  egative for heap
-00037830: 2073 6f72 7469 6e67 0a20 2020 2020 2020   sorting.       
-00037840: 2020 2020 2020 2020 2073 6e64 5f62 7974           snd_byt
-00037850: 6573 5f6d 6178 202b 3d20 6e62 7974 6573  es_max += nbytes
-00037860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037870: 2073 6e64 5f62 7974 6573 5f6d 696e 202b   snd_bytes_min +
-00037880: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
-00037890: 2020 2020 2020 2020 2072 6563 5f62 7974           rec_byt
-000378a0: 6573 5f6d 6178 202b 3d20 6e62 7974 6573  es_max += nbytes
-000378b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000378c0: 2072 6563 5f62 7974 6573 5f6d 696e 202b   rec_bytes_min +
-000378d0: 3d20 6e62 7974 6573 0a0a 2020 2020 2020  = nbytes..      
-000378e0: 2020 2020 2020 2020 2020 2320 5374 6f70            # Stop
-000378f0: 2069 7465 7261 7469 6e67 206f 6e20 7468   iterating on th
-00037900: 6520 7461 736b 7320 6f66 2074 6869 7320  e tasks of this 
-00037910: 7365 6e64 6572 2066 6f72 206e 6f77 2061  sender for now a
-00037920: 6e64 2c20 6966 2069 7420 7374 696c 6c0a  nd, if it still.
-00037930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037940: 2320 6861 7320 6279 7465 7320 746f 206c  # has bytes to l
-00037950: 6f73 652c 2070 7573 6820 6974 2062 6163  ose, push it bac
-00037960: 6b20 696e 746f 2074 6865 2073 656e 6465  k into the sende
-00037970: 7273 2068 6561 703b 2069 7420 6d61 7920  rs heap; it may 
-00037980: 6f72 206d 6179 0a20 2020 2020 2020 2020  or may.         
-00037990: 2020 2020 2020 2023 206e 6f74 2063 6f6d         # not com
-000379a0: 6520 6261 636b 206f 6e20 746f 7020 6167  e back on top ag
-000379b0: 6169 6e2e 0a20 2020 2020 2020 2020 2020  ain..           
-000379c0: 2020 2020 2069 6620 736e 645f 6279 7465       if snd_byte
-000379d0: 735f 6d69 6e20 3c20 303a 0a20 2020 2020  s_min < 0:.     
-000379e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000379f0: 2053 6565 2064 6566 696e 6974 696f 6e20   See definition 
-00037a00: 6f66 2073 656e 6465 7273 2061 626f 7665  of senders above
-00037a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037a20: 2020 2020 2068 6561 7071 2e68 6561 7072       heapq.heapr
-00037a30: 6570 6c61 6365 280a 2020 2020 2020 2020  eplace(.        
-00037a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037a50: 7365 6e64 6572 732c 0a20 2020 2020 2020  senders,.       
-00037a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037a70: 2028 736e 645f 6279 7465 735f 6d61 782c   (snd_bytes_max,
-00037a80: 2073 6e64 5f62 7974 6573 5f6d 696e 2c20   snd_bytes_min, 
-00037a90: 6964 2873 6e64 5f77 7329 2c20 736e 645f  id(snd_ws), snd_
-00037aa0: 7773 2c20 7473 5f69 7465 7229 2c0a 2020  ws, ts_iter),.  
-00037ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037ac0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00037ad0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00037ae0: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00037af0: 6170 712e 6865 6170 706f 7028 7365 6e64  apq.heappop(send
-00037b00: 6572 7329 0a0a 2020 2020 2020 2020 2020  ers)..          
-00037b10: 2020 2020 2020 2320 4966 2072 6563 6970        # If recip
-00037b20: 6965 6e74 2073 7469 6c6c 2068 6173 2062  ient still has b
-00037b30: 7974 6573 2074 6f20 6761 696e 2c20 7075  ytes to gain, pu
-00037b40: 7368 2069 7420 6261 636b 2069 6e74 6f20  sh it back into 
-00037b50: 7468 6520 7265 6369 7069 656e 7473 0a20  the recipients. 
-00037b60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00037b70: 2068 6561 703b 2069 7420 6d61 7920 6f72   heap; it may or
-00037b80: 206d 6179 206e 6f74 2063 6f6d 6520 6261   may not come ba
-00037b90: 636b 206f 6e20 746f 7020 6167 6169 6e2e  ck on top again.
-00037ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037bb0: 2069 6620 7265 635f 6279 7465 735f 6d69   if rec_bytes_mi
-00037bc0: 6e20 3c20 303a 0a20 2020 2020 2020 2020  n < 0:.         
-00037bd0: 2020 2020 2020 2020 2020 2023 2053 6565             # See
-00037be0: 2064 6566 696e 6974 696f 6e20 6f66 2072   definition of r
-00037bf0: 6563 6970 6965 6e74 7320 6162 6f76 650a  ecipients above.
-00037c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037c10: 2020 2020 6865 6170 712e 6865 6170 7265      heapq.heapre
-00037c20: 706c 6163 6528 0a20 2020 2020 2020 2020  place(.         
-00037c30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00037c40: 6563 6970 6965 6e74 732c 0a20 2020 2020  ecipients,.     
-00037c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037c60: 2020 2028 7265 635f 6279 7465 735f 6d61     (rec_bytes_ma
-00037c70: 782c 2072 6563 5f62 7974 6573 5f6d 696e  x, rec_bytes_min
-00037c80: 2c20 6964 2872 6563 5f77 7329 2c20 7265  , id(rec_ws), re
-00037c90: 635f 7773 292c 0a20 2020 2020 2020 2020  c_ws),.         
-00037ca0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00037cb0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00037cc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00037cd0: 2020 2020 2020 2068 6561 7071 2e68 6561         heapq.hea
-00037ce0: 7070 6f70 2872 6563 6970 6965 6e74 7329  ppop(recipients)
-00037cf0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00037d00: 2020 2320 4d6f 7665 2074 6f20 6e65 7874    # Move to next
-00037d10: 2073 656e 6465 7220 7769 7468 2074 6865   sender with the
-00037d20: 206d 6f73 7420 6461 7461 2074 6f20 6c6f   most data to lo
-00037d30: 7365 2e0a 2020 2020 2020 2020 2020 2020  se..            
-00037d40: 2020 2020 2320 4974 206d 6179 206f 7220      # It may or 
-00037d50: 6d61 7920 6e6f 7420 6265 2074 6865 2073  may not be the s
-00037d60: 616d 6520 7365 6e64 6572 2061 6761 696e  ame sender again
-00037d70: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00037d80: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-00037d90: 2020 2020 2065 6c73 653a 2020 2320 666f       else:  # fo
-00037da0: 7220 7473 2069 6e20 7473 5f69 7465 720a  r ts in ts_iter.
-00037db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037dc0: 2320 4578 6861 7573 7465 6420 7461 736b  # Exhausted task
-00037dd0: 7320 6f6e 2074 6869 7320 7365 6e64 6572  s on this sender
-00037de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037df0: 2068 6561 7071 2e68 6561 7070 6f70 2873   heapq.heappop(s
-00037e00: 656e 6465 7273 290a 0a20 2020 2020 2020  enders)..       
-00037e10: 2072 6574 7572 6e20 6d73 6773 0a0a 2020   return msgs..  
-00037e20: 2020 6173 796e 6320 6465 6620 5f72 6562    async def _reb
-00037e30: 616c 616e 6365 5f6d 6f76 655f 6461 7461  alance_move_data
-00037e40: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-00037e50: 6d73 6773 3a20 226c 6973 745b 7475 706c  msgs: "list[tupl
-00037e60: 655b 576f 726b 6572 5374 6174 652c 2057  e[WorkerState, W
-00037e70: 6f72 6b65 7253 7461 7465 2c20 5461 736b  orkerState, Task
-00037e80: 5374 6174 655d 5d22 2c20 7374 696d 756c  State]]", stimul
-00037e90: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
-00037ea0: 202d 3e20 6469 6374 3a0a 2020 2020 2020   -> dict:.      
-00037eb0: 2020 2222 2250 6572 666f 726d 2074 6865    """Perform the
-00037ec0: 2061 6374 7561 6c20 7472 616e 7366 6572   actual transfer
-00037ed0: 206f 6620 6461 7461 2061 6372 6f73 7320   of data across 
-00037ee0: 7468 6520 6e65 7477 6f72 6b20 696e 2072  the network in r
-00037ef0: 6562 616c 616e 6365 2829 2e0a 2020 2020  ebalance()..    
-00037f00: 2020 2020 5461 6b65 7320 696e 2069 6e70      Takes in inp
-00037f10: 7574 2074 6865 206f 7574 7075 7420 6f66  ut the output of
-00037f20: 205f 7265 6261 6c61 6e63 655f 6669 6e64   _rebalance_find
-00037f30: 5f6d 7367 7328 292c 2074 6861 7420 6973  _msgs(), that is
-00037f40: 2061 206c 6973 7420 6f66 2074 7570 6c65   a list of tuple
-00037f50: 733a 0a0a 2020 2020 2020 2020 2d20 7365  s:..        - se
-00037f60: 6e64 6572 2077 6f72 6b65 720a 2020 2020  nder worker.    
-00037f70: 2020 2020 2d20 7265 6369 7069 656e 7420      - recipient 
-00037f80: 776f 726b 6572 0a20 2020 2020 2020 202d  worker.        -
-00037f90: 2074 6173 6b20 746f 2062 6520 7472 616e   task to be tran
-00037fa0: 7366 6572 7265 640a 0a20 2020 2020 2020  sferred..       
-00037fb0: 2046 4958 4d45 2074 6869 7320 6d65 7468   FIXME this meth
-00037fc0: 6f64 2069 7320 6e6f 7420 726f 6275 7374  od is not robust
-00037fd0: 2077 6865 6e20 7468 6520 636c 7573 7465   when the cluste
-00037fe0: 7220 6973 206e 6f74 2069 646c 652e 0a20  r is not idle.. 
-00037ff0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00038000: 2020 2074 6f5f 7265 6369 7069 656e 7473     to_recipients
-00038010: 3a20 6465 6661 756c 7464 6963 745b 7374  : defaultdict[st
-00038020: 722c 2064 6566 6175 6c74 6469 6374 5b73  r, defaultdict[s
-00038030: 7472 2c20 6c69 7374 5b73 7472 5d5d 5d20  tr, list[str]]] 
-00038040: 3d20 6465 6661 756c 7464 6963 7428 0a20  = defaultdict(. 
-00038050: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00038060: 613a 2064 6566 6175 6c74 6469 6374 286c  a: defaultdict(l
-00038070: 6973 7429 0a20 2020 2020 2020 2029 0a20  ist).        ). 
-00038080: 2020 2020 2020 2066 6f72 2073 6e64 5f77         for snd_w
-00038090: 732c 2072 6563 5f77 732c 2074 7320 696e  s, rec_ws, ts in
-000380a0: 206d 7367 733a 0a20 2020 2020 2020 2020   msgs:.         
-000380b0: 2020 2074 6f5f 7265 6369 7069 656e 7473     to_recipients
-000380c0: 5b72 6563 5f77 732e 6164 6472 6573 735d  [rec_ws.address]
-000380d0: 5b74 732e 6b65 795d 2e61 7070 656e 6428  [ts.key].append(
-000380e0: 736e 645f 7773 2e61 6464 7265 7373 290a  snd_ws.address).
-000380f0: 2020 2020 2020 2020 6661 696c 6564 5f6b          failed_k
-00038100: 6579 735f 6279 5f72 6563 6970 6965 6e74  eys_by_recipient
-00038110: 203d 2064 6963 7428 0a20 2020 2020 2020   = dict(.       
-00038120: 2020 2020 207a 6970 280a 2020 2020 2020       zip(.      
-00038130: 2020 2020 2020 2020 2020 746f 5f72 6563            to_rec
-00038140: 6970 6965 6e74 732c 0a20 2020 2020 2020  ipients,.       
-00038150: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-00038160: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
-00038170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038180: 2020 202a 280a 2020 2020 2020 2020 2020     *(.          
-00038190: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000381a0: 4e6f 7465 3a20 7468 6973 206e 6576 6572  Note: this never
-000381b0: 2072 6169 7365 7320 6578 6365 7074 696f   raises exceptio
-000381c0: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
-000381d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000381e0: 6761 7468 6572 5f6f 6e5f 776f 726b 6572  gather_on_worker
-000381f0: 2877 2c20 7768 6f5f 6861 7329 0a20 2020  (w, who_has).   
-00038200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038210: 2020 2020 2066 6f72 2077 2c20 7768 6f5f       for w, who_
-00038220: 6861 7320 696e 2074 6f5f 7265 6369 7069  has in to_recipi
-00038230: 656e 7473 2e69 7465 6d73 2829 0a20 2020  ents.items().   
-00038240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038250: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00038260: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00038270: 2020 290a 2020 2020 2020 2020 290a 0a20    ).        ).. 
-00038280: 2020 2020 2020 2074 6f5f 7365 6e64 6572         to_sender
-00038290: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
-000382a0: 6c69 7374 290a 2020 2020 2020 2020 666f  list).        fo
-000382b0: 7220 736e 645f 7773 2c20 7265 635f 7773  r snd_ws, rec_ws
-000382c0: 2c20 7473 2069 6e20 6d73 6773 3a0a 2020  , ts in msgs:.  
-000382d0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
-000382e0: 6b65 7920 6e6f 7420 696e 2066 6169 6c65  key not in faile
-000382f0: 645f 6b65 7973 5f62 795f 7265 6369 7069  d_keys_by_recipi
-00038300: 656e 745b 7265 635f 7773 2e61 6464 7265  ent[rec_ws.addre
-00038310: 7373 5d3a 0a20 2020 2020 2020 2020 2020  ss]:.           
-00038320: 2020 2020 2074 6f5f 7365 6e64 6572 735b       to_senders[
-00038330: 736e 645f 7773 2e61 6464 7265 7373 5d2e  snd_ws.address].
-00038340: 6170 7065 6e64 2874 732e 6b65 7929 0a0a  append(ts.key)..
-00038350: 2020 2020 2020 2020 2320 4e6f 7465 3a20          # Note: 
-00038360: 7468 6973 206e 6576 6572 2072 6169 7365  this never raise
-00038370: 7320 6578 6365 7074 696f 6e73 0a20 2020  s exceptions.   
-00038380: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-00038390: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-000383a0: 2020 2020 2020 202a 2873 656c 662e 6465         *(self.de
-000383b0: 6c65 7465 5f77 6f72 6b65 725f 6461 7461  lete_worker_data
-000383c0: 2872 2c20 762c 2073 7469 6d75 6c75 735f  (r, v, stimulus_
-000383d0: 6964 2920 666f 7220 722c 2076 2069 6e20  id) for r, v in 
-000383e0: 746f 5f73 656e 6465 7273 2e69 7465 6d73  to_senders.items
-000383f0: 2829 290a 2020 2020 2020 2020 290a 0a20  ()).        ).. 
-00038400: 2020 2020 2020 2066 6f72 2072 2c20 7620         for r, v 
-00038410: 696e 2074 6f5f 7265 6369 7069 656e 7473  in to_recipients
-00038420: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00038430: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-00038440: 7665 6e74 2872 2c20 7b22 6163 7469 6f6e  vent(r, {"action
-00038450: 223a 2022 7265 6261 6c61 6e63 6522 2c20  ": "rebalance", 
-00038460: 2277 686f 5f68 6173 223a 2076 7d29 0a20  "who_has": v}). 
-00038470: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-00038480: 6576 656e 7428 0a20 2020 2020 2020 2020  event(.         
-00038490: 2020 2022 616c 6c22 2c0a 2020 2020 2020     "all",.      
-000384a0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000384b0: 2020 2020 2020 2020 2261 6374 696f 6e22          "action"
-000384c0: 3a20 2272 6562 616c 616e 6365 222c 0a20  : "rebalance",. 
-000384d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000384e0: 7365 6e64 6572 7322 3a20 7661 6c6d 6170  senders": valmap
-000384f0: 286c 656e 2c20 746f 5f73 656e 6465 7273  (len, to_senders
-00038500: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00038510: 2020 2022 7265 6369 7069 656e 7473 223a     "recipients":
-00038520: 2076 616c 6d61 7028 6c65 6e2c 2074 6f5f   valmap(len, to_
-00038530: 7265 6369 7069 656e 7473 292c 0a20 2020  recipients),.   
-00038540: 2020 2020 2020 2020 2020 2020 2022 6d6f               "mo
-00038550: 7665 645f 6b65 7973 223a 206c 656e 286d  ved_keys": len(m
-00038560: 7367 7329 2c0a 2020 2020 2020 2020 2020  sgs),.          
-00038570: 2020 7d2c 0a20 2020 2020 2020 2029 0a0a    },.        )..
-00038580: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
-00038590: 6b65 7973 203d 207b 6b20 666f 7220 7220  keys = {k for r 
-000385a0: 696e 2066 6169 6c65 645f 6b65 7973 5f62  in failed_keys_b
-000385b0: 795f 7265 6369 7069 656e 742e 7661 6c75  y_recipient.valu
-000385c0: 6573 2829 2066 6f72 206b 2069 6e20 727d  es() for k in r}
-000385d0: 0a20 2020 2020 2020 2069 6620 6d69 7373  .        if miss
-000385e0: 696e 675f 6b65 7973 3a0a 2020 2020 2020  ing_keys:.      
-000385f0: 2020 2020 2020 7265 7475 726e 207b 2273        return {"s
-00038600: 7461 7475 7322 3a20 2270 6172 7469 616c  tatus": "partial
-00038610: 2d66 6169 6c22 2c20 226b 6579 7322 3a20  -fail", "keys": 
-00038620: 6c69 7374 286d 6973 7369 6e67 5f6b 6579  list(missing_key
-00038630: 7329 7d0a 2020 2020 2020 2020 656c 7365  s)}.        else
-00038640: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00038650: 7475 726e 207b 2273 7461 7475 7322 3a20  turn {"status": 
-00038660: 224f 4b22 7d0a 0a20 2020 2061 7379 6e63  "OK"}..    async
-00038670: 2064 6566 2072 6570 6c69 6361 7465 280a   def replicate(.
-00038680: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00038690: 2020 2020 2020 636f 6d6d 3d4e 6f6e 652c        comm=None,
-000386a0: 0a20 2020 2020 2020 206b 6579 733d 4e6f  .        keys=No
-000386b0: 6e65 2c0a 2020 2020 2020 2020 6e3d 4e6f  ne,.        n=No
-000386c0: 6e65 2c0a 2020 2020 2020 2020 776f 726b  ne,.        work
-000386d0: 6572 733d 4e6f 6e65 2c0a 2020 2020 2020  ers=None,.      
-000386e0: 2020 6272 616e 6368 696e 675f 6661 6374    branching_fact
-000386f0: 6f72 3d32 2c0a 2020 2020 2020 2020 6465  or=2,.        de
-00038700: 6c65 7465 3d54 7275 652c 0a20 2020 2020  lete=True,.     
-00038710: 2020 206c 6f63 6b3d 5472 7565 2c0a 2020     lock=True,.  
-00038720: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-00038730: 643d 4e6f 6e65 2c0a 2020 2020 293a 0a20  d=None,.    ):. 
-00038740: 2020 2020 2020 2022 2222 5265 706c 6963         """Replic
-00038750: 6174 6520 6461 7461 2074 6872 6f75 6768  ate data through
-00038760: 6f75 7420 636c 7573 7465 720a 0a20 2020  out cluster..   
-00038770: 2020 2020 2054 6869 7320 7065 7266 6f72       This perfor
-00038780: 6d73 2061 2074 7265 6520 636f 7079 206f  ms a tree copy o
-00038790: 6620 7468 6520 6461 7461 2074 6872 6f75  f the data throu
-000387a0: 6768 6f75 7420 7468 6520 6e65 7477 6f72  ghout the networ
-000387b0: 6b0a 2020 2020 2020 2020 696e 6469 7669  k.        indivi
-000387c0: 6475 616c 6c79 206f 6e20 6561 6368 2070  dually on each p
-000387d0: 6965 6365 206f 6620 6461 7461 2e0a 0a20  iece of data... 
-000387e0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-000387f0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00038800: 2d2d 2d2d 0a20 2020 2020 2020 206b 6579  ----.        key
-00038810: 733a 2049 7465 7261 626c 650a 2020 2020  s: Iterable.    
-00038820: 2020 2020 2020 2020 6c69 7374 206f 6620          list of 
-00038830: 6b65 7973 2074 6f20 7265 706c 6963 6174  keys to replicat
-00038840: 650a 2020 2020 2020 2020 6e3a 2069 6e74  e.        n: int
-00038850: 0a20 2020 2020 2020 2020 2020 204e 756d  .            Num
-00038860: 6265 7220 6f66 2072 6570 6c69 6361 7469  ber of replicati
-00038870: 6f6e 7320 7765 2065 7870 6563 7420 746f  ons we expect to
-00038880: 2073 6565 2077 6974 6869 6e20 7468 6520   see within the 
-00038890: 636c 7573 7465 720a 2020 2020 2020 2020  cluster.        
-000388a0: 6272 616e 6368 696e 675f 6661 6374 6f72  branching_factor
-000388b0: 3a20 696e 742c 206f 7074 696f 6e61 6c0a  : int, optional.
-000388c0: 2020 2020 2020 2020 2020 2020 5468 6520              The 
-000388d0: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
-000388e0: 7320 7468 6174 2063 616e 2063 6f70 7920  s that can copy 
-000388f0: 6461 7461 2069 6e20 6561 6368 2067 656e  data in each gen
-00038900: 6572 6174 696f 6e2e 0a20 2020 2020 2020  eration..       
-00038910: 2020 2020 2054 6865 206c 6172 6765 7220       The larger 
-00038920: 7468 6520 6272 616e 6368 696e 6720 6661  the branching fa
-00038930: 6374 6f72 2c20 7468 6520 6d6f 7265 2064  ctor, the more d
-00038940: 6174 6120 7765 2063 6f70 7920 696e 0a20  ata we copy in. 
-00038950: 2020 2020 2020 2020 2020 2061 2073 696e             a sin
-00038960: 676c 6520 7374 6570 2c20 6275 7420 7468  gle step, but th
-00038970: 6520 6d6f 7265 2061 2067 6976 656e 2077  e more a given w
-00038980: 6f72 6b65 7220 7269 736b 7320 6265 696e  orker risks bein
-00038990: 670a 2020 2020 2020 2020 2020 2020 7377  g.            sw
-000389a0: 616d 7065 6420 6279 2064 6174 6120 7265  amped by data re
-000389b0: 7175 6573 7473 2e0a 0a20 2020 2020 2020  quests...       
-000389c0: 2053 6565 2061 6c73 6f0a 2020 2020 2020   See also.      
-000389d0: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-000389e0: 2020 2053 6368 6564 756c 6572 2e72 6562     Scheduler.reb
-000389f0: 616c 616e 6365 0a20 2020 2020 2020 2022  alance.        "
-00038a00: 2222 0a20 2020 2020 2020 2073 7469 6d75  "".        stimu
-00038a10: 6c75 735f 6964 203d 2073 7469 6d75 6c75  lus_id = stimulu
-00038a20: 735f 6964 206f 7220 6622 7265 706c 6963  s_id or f"replic
-00038a30: 6174 652d 7b74 696d 6528 297d 220a 2020  ate-{time()}".  
-00038a40: 2020 2020 2020 6173 7365 7274 2062 7261        assert bra
-00038a50: 6e63 6869 6e67 5f66 6163 746f 7220 3e20  nching_factor > 
-00038a60: 300a 2020 2020 2020 2020 6173 796e 6320  0.        async 
-00038a70: 7769 7468 2073 656c 662e 5f6c 6f63 6b20  with self._lock 
-00038a80: 6966 206c 6f63 6b20 656c 7365 2065 6d70  if lock else emp
-00038a90: 7479 5f63 6f6e 7465 7874 3a0a 2020 2020  ty_context:.    
-00038aa0: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
-00038ab0: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
-00038ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ad0: 776f 726b 6572 7320 3d20 7b73 656c 662e  workers = {self.
-00038ae0: 776f 726b 6572 735b 775d 2066 6f72 2077  workers[w] for w
-00038af0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-00038b00: 5f6c 6973 7428 776f 726b 6572 7329 7d0a  _list(workers)}.
-00038b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038b20: 776f 726b 6572 7320 3d20 7b77 7320 666f  workers = {ws fo
-00038b30: 7220 7773 2069 6e20 776f 726b 6572 7320  r ws in workers 
-00038b40: 6966 2077 732e 7374 6174 7573 203d 3d20  if ws.status == 
-00038b50: 5374 6174 7573 2e72 756e 6e69 6e67 7d0a  Status.running}.
-00038b60: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00038b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00038b80: 2020 776f 726b 6572 7320 3d20 7365 6c66    workers = self
-00038b90: 2e72 756e 6e69 6e67 0a0a 2020 2020 2020  .running..      
-00038ba0: 2020 2020 2020 6966 206e 2069 7320 4e6f        if n is No
-00038bb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00038bc0: 2020 2020 6e20 3d20 6c65 6e28 776f 726b      n = len(work
-00038bd0: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-00038be0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00038bf0: 2020 2020 2020 206e 203d 206d 696e 286e         n = min(n
-00038c00: 2c20 6c65 6e28 776f 726b 6572 7329 290a  , len(workers)).
-00038c10: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00038c20: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00038c30: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00038c40: 7565 4572 726f 7228 2243 616e 206e 6f74  ueError("Can not
-00038c50: 2075 7365 2072 6570 6c69 6361 7465 2074   use replicate t
-00038c60: 6f20 6465 6c65 7465 2064 6174 6122 290a  o delete data").
-00038c70: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-00038c80: 6b73 203d 207b 7365 6c66 2e74 6173 6b73  ks = {self.tasks
-00038c90: 5b6b 5d20 666f 7220 6b20 696e 206b 6579  [k] for k in key
-00038ca0: 737d 0a20 2020 2020 2020 2020 2020 206d  s}.            m
-00038cb0: 6973 7369 6e67 5f64 6174 6120 3d20 5b74  issing_data = [t
-00038cc0: 732e 6b65 7920 666f 7220 7473 2069 6e20  s.key for ts in 
-00038cd0: 7461 736b 7320 6966 206e 6f74 2074 732e  tasks if not ts.
-00038ce0: 7768 6f5f 6861 735d 0a20 2020 2020 2020  who_has].       
-00038cf0: 2020 2020 2069 6620 6d69 7373 696e 675f       if missing_
-00038d00: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
-00038d10: 2020 2020 2020 7265 7475 726e 207b 2273        return {"s
-00038d20: 7461 7475 7322 3a20 2270 6172 7469 616c  tatus": "partial
-00038d30: 2d66 6169 6c22 2c20 226b 6579 7322 3a20  -fail", "keys": 
-00038d40: 6d69 7373 696e 675f 6461 7461 7d0a 0a20  missing_data}.. 
-00038d50: 2020 2020 2020 2020 2020 2023 2044 656c             # Del
-00038d60: 6574 6520 6578 7472 616e 656f 7573 2064  ete extraneous d
-00038d70: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
-00038d80: 6966 2064 656c 6574 653a 0a20 2020 2020  if delete:.     
-00038d90: 2020 2020 2020 2020 2020 2064 656c 5f77             del_w
-00038da0: 6f72 6b65 725f 7461 736b 7320 3d20 6465  orker_tasks = de
-00038db0: 6661 756c 7464 6963 7428 7365 7429 0a20  faultdict(set). 
-00038dc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00038dd0: 6f72 2074 7320 696e 2074 6173 6b73 3a0a  or ts in tasks:.
-00038de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038df0: 2020 2020 6465 6c5f 6361 6e64 6964 6174      del_candidat
-00038e00: 6573 203d 2074 7570 6c65 2874 732e 7768  es = tuple(ts.wh
-00038e10: 6f5f 6861 7320 2620 776f 726b 6572 7329  o_has & workers)
-00038e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038e30: 2020 2020 2069 6620 6c65 6e28 6465 6c5f       if len(del_
-00038e40: 6361 6e64 6964 6174 6573 2920 3e20 6e3a  candidates) > n:
-00038e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038e60: 2020 2020 2020 2020 2066 6f72 2077 7320           for ws 
-00038e70: 696e 2072 616e 646f 6d2e 7361 6d70 6c65  in random.sample
-00038e80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00038e90: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00038ea0: 6c5f 6361 6e64 6964 6174 6573 2c20 6c65  l_candidates, le
-00038eb0: 6e28 6465 6c5f 6361 6e64 6964 6174 6573  n(del_candidates
-00038ec0: 2920 2d20 6e0a 2020 2020 2020 2020 2020  ) - n.          
-00038ed0: 2020 2020 2020 2020 2020 2020 2020 293a                ):
-00038ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038ef0: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00038f00: 5f77 6f72 6b65 725f 7461 736b 735b 7773  _worker_tasks[ws
-00038f10: 5d2e 6164 6428 7473 290a 0a20 2020 2020  ].add(ts)..     
-00038f20: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
-00038f30: 653a 2074 6869 7320 6e65 7665 7220 7261  e: this never ra
-00038f40: 6973 6573 2065 7863 6570 7469 6f6e 730a  ises exceptions.
-00038f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038f60: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-00038f70: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-00038f80: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
-00038f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038fa0: 2020 2020 2073 656c 662e 6465 6c65 7465       self.delete
-00038fb0: 5f77 6f72 6b65 725f 6461 7461 280a 2020  _worker_data(.  
-00038fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038fd0: 2020 2020 2020 2020 2020 7773 2e61 6464            ws.add
-00038fe0: 7265 7373 2c20 5b74 2e6b 6579 2066 6f72  ress, [t.key for
-00038ff0: 2074 2069 6e20 7461 736b 735d 2c20 7374   t in tasks], st
-00039000: 696d 756c 7573 5f69 640a 2020 2020 2020  imulus_id.      
-00039010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039020: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00039030: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00039040: 7773 2c20 7461 736b 7320 696e 2064 656c  ws, tasks in del
-00039050: 5f77 6f72 6b65 725f 7461 736b 732e 6974  _worker_tasks.it
-00039060: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-00039070: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-00039080: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00039090: 2020 2020 2020 2020 2020 2023 2043 6f70             # Cop
-000390a0: 7920 6e6f 742d 7965 742d 6669 6c6c 6564  y not-yet-filled
-000390b0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-000390c0: 2020 7768 696c 6520 7461 736b 733a 0a20    while tasks:. 
-000390d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000390e0: 6174 6865 7273 203d 2064 6566 6175 6c74  athers = default
-000390f0: 6469 6374 2864 6963 7429 0a20 2020 2020  dict(dict).     
-00039100: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-00039110: 7320 696e 206c 6973 7428 7461 736b 7329  s in list(tasks)
-00039120: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039130: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
-00039140: 6520 3d3d 2022 666f 7267 6f74 7465 6e22  e == "forgotten"
-00039150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039160: 2020 2020 2020 2020 2020 2320 7461 736b            # task
-00039170: 2069 7320 6e6f 206c 6f6e 6765 7220 6e65   is no longer ne
-00039180: 6564 6564 2062 7920 616e 7920 636c 6965  eded by any clie
-00039190: 6e74 206f 7220 6465 7065 6e64 656e 7420  nt or dependent 
-000391a0: 7461 736b 0a20 2020 2020 2020 2020 2020  task.           
-000391b0: 2020 2020 2020 2020 2020 2020 2074 6173               tas
-000391c0: 6b73 2e72 656d 6f76 6528 7473 290a 2020  ks.remove(ts).  
-000391d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000391e0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-000391f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039200: 2020 206e 5f6d 6973 7369 6e67 203d 206e     n_missing = n
-00039210: 202d 206c 656e 2874 732e 7768 6f5f 6861   - len(ts.who_ha
-00039220: 7320 2620 776f 726b 6572 7329 0a20 2020  s & workers).   
-00039230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039240: 2069 6620 6e5f 6d69 7373 696e 6720 3c3d   if n_missing <=
-00039250: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00039260: 2020 2020 2020 2020 2020 2020 2320 416c              # Al
-00039270: 7265 6164 7920 7265 706c 6963 6174 6564  ready replicated
-00039280: 2065 6e6f 7567 680a 2020 2020 2020 2020   enough.        
-00039290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000392a0: 7461 736b 732e 7265 6d6f 7665 2874 7329  tasks.remove(ts)
-000392b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000392c0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-000392d0: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-000392e0: 2020 2020 2020 2063 6f75 6e74 203d 206d         count = m
-000392f0: 696e 286e 5f6d 6973 7369 6e67 2c20 6272  in(n_missing, br
-00039300: 616e 6368 696e 675f 6661 6374 6f72 202a  anching_factor *
-00039310: 206c 656e 2874 732e 7768 6f5f 6861 7329   len(ts.who_has)
-00039320: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00039330: 2020 2020 2020 6173 7365 7274 2063 6f75        assert cou
-00039340: 6e74 203e 2030 0a0a 2020 2020 2020 2020  nt > 0..        
-00039350: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00039360: 7773 2069 6e20 7261 6e64 6f6d 2e73 616d  ws in random.sam
-00039370: 706c 6528 7475 706c 6528 776f 726b 6572  ple(tuple(worker
-00039380: 7320 2d20 7473 2e77 686f 5f68 6173 292c  s - ts.who_has),
-00039390: 2063 6f75 6e74 293a 0a20 2020 2020 2020   count):.       
-000393a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000393b0: 2067 6174 6865 7273 5b77 732e 6164 6472   gathers[ws.addr
-000393c0: 6573 735d 5b74 732e 6b65 795d 203d 205b  ess][ts.key] = [
-000393d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000393e0: 2020 2020 2020 2020 2020 2020 2077 7773               wws
-000393f0: 2e61 6464 7265 7373 2066 6f72 2077 7773  .address for wws
-00039400: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
-00039410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039420: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
-00039430: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00039440: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
-00039450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039460: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
-00039470: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00039480: 204e 6f74 653a 2074 6869 7320 6e65 7665   Note: this neve
-00039490: 7220 7261 6973 6573 2065 7863 6570 7469  r raises excepti
-000394a0: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
-000394b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000394c0: 2e67 6174 6865 725f 6f6e 5f77 6f72 6b65  .gather_on_worke
-000394d0: 7228 772c 2077 686f 5f68 6173 290a 2020  r(w, who_has).  
-000394e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394f0: 2020 2020 2020 666f 7220 772c 2077 686f        for w, who
-00039500: 5f68 6173 2069 6e20 6761 7468 6572 732e  _has in gathers.
-00039510: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-00039520: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00039530: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00039540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039550: 666f 7220 722c 2076 2069 6e20 6761 7468  for r, v in gath
-00039560: 6572 732e 6974 656d 7328 293a 0a20 2020  ers.items():.   
-00039570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039580: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-00039590: 722c 207b 2261 6374 696f 6e22 3a20 2272  r, {"action": "r
-000395a0: 6570 6c69 6361 7465 2d61 6464 222c 2022  eplicate-add", "
-000395b0: 7768 6f5f 6861 7322 3a20 767d 290a 0a20  who_has": v}).. 
-000395c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000395d0: 6c6f 675f 6576 656e 7428 0a20 2020 2020  log_event(.     
-000395e0: 2020 2020 2020 2020 2020 2022 616c 6c22             "all"
-000395f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00039600: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00039610: 2020 2020 2020 2020 2261 6374 696f 6e22          "action"
-00039620: 3a20 2272 6570 6c69 6361 7465 222c 0a20  : "replicate",. 
-00039630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039640: 2020 2022 776f 726b 6572 7322 3a20 6c69     "workers": li
-00039650: 7374 2877 6f72 6b65 7273 292c 0a20 2020  st(workers),.   
-00039660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039670: 2022 6b65 792d 636f 756e 7422 3a20 6c65   "key-count": le
-00039680: 6e28 6b65 7973 292c 0a20 2020 2020 2020  n(keys),.       
-00039690: 2020 2020 2020 2020 2020 2020 2022 6272               "br
-000396a0: 616e 6368 696e 672d 6661 6374 6f72 223a  anching-factor":
-000396b0: 2062 7261 6e63 6869 6e67 5f66 6163 746f   branching_facto
-000396c0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-000396d0: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-000396e0: 2020 290a 0a20 2020 2064 6566 2077 6f72    )..    def wor
-000396f0: 6b65 7273 5f74 6f5f 636c 6f73 6528 0a20  kers_to_close(. 
-00039700: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00039710: 2020 2020 2063 6f6d 6d3d 4e6f 6e65 2c0a       comm=None,.
-00039720: 2020 2020 2020 2020 6d65 6d6f 7279 5f72          memory_r
-00039730: 6174 696f 3a20 696e 7420 7c20 666c 6f61  atio: int | floa
-00039740: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
-00039750: 0a20 2020 2020 2020 206e 3a20 696e 7420  .        n: int 
-00039760: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00039770: 2020 2020 2020 206b 6579 3a20 4361 6c6c         key: Call
-00039780: 6162 6c65 5b5b 576f 726b 6572 5374 6174  able[[WorkerStat
-00039790: 655d 2c20 4861 7368 6162 6c65 5d20 7c20  e], Hashable] | 
-000397a0: 6279 7465 7320 7c20 4e6f 6e65 203d 204e  bytes | None = N
-000397b0: 6f6e 652c 0a20 2020 2020 2020 206d 696e  one,.        min
-000397c0: 696d 756d 3a20 696e 7420 7c20 4e6f 6e65  imum: int | None
-000397d0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000397e0: 2074 6172 6765 743a 2069 6e74 207c 204e   target: int | N
-000397f0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00039800: 2020 2020 6174 7472 6962 7574 653a 2073      attribute: s
-00039810: 7472 203d 2022 6164 6472 6573 7322 2c0a  tr = "address",.
-00039820: 2020 2020 2920 2d3e 206c 6973 745b 7374      ) -> list[st
-00039830: 725d 3a0a 2020 2020 2020 2020 2222 220a  r]:.        """.
-00039840: 2020 2020 2020 2020 4669 6e64 2077 6f72          Find wor
-00039850: 6b65 7273 2074 6861 7420 7765 2063 616e  kers that we can
-00039860: 2063 6c6f 7365 2077 6974 6820 6c6f 7720   close with low 
-00039870: 636f 7374 0a0a 2020 2020 2020 2020 5468  cost..        Th
-00039880: 6973 2072 6574 7572 6e73 2061 206c 6973  is returns a lis
-00039890: 7420 6f66 2077 6f72 6b65 7273 2074 6861  t of workers tha
-000398a0: 7420 6172 6520 676f 6f64 2063 616e 6469  t are good candi
-000398b0: 6461 7465 7320 746f 2072 6574 6972 652e  dates to retire.
-000398c0: 0a20 2020 2020 2020 2054 6865 7365 2077  .        These w
-000398d0: 6f72 6b65 7273 2061 7265 206e 6f74 2072  orkers are not r
-000398e0: 756e 6e69 6e67 2061 6e79 7468 696e 6720  unning anything 
-000398f0: 616e 6420 6172 6520 7374 6f72 696e 670a  and are storing.
-00039900: 2020 2020 2020 2020 7265 6c61 7469 7665          relative
-00039910: 6c79 206c 6974 746c 6520 6461 7461 2072  ly little data r
-00039920: 656c 6174 6976 6520 746f 2074 6865 6972  elative to their
-00039930: 2070 6565 7273 2e20 2049 6620 616c 6c20   peers.  If all 
-00039940: 776f 726b 6572 7320 6172 650a 2020 2020  workers are.    
-00039950: 2020 2020 6964 6c65 2074 6865 6e20 7765      idle then we
-00039960: 2073 7469 6c6c 206d 6169 6e74 6169 6e20   still maintain 
-00039970: 656e 6f75 6768 2077 6f72 6b65 7273 2074  enough workers t
-00039980: 6f20 6861 7665 2065 6e6f 7567 6820 5241  o have enough RA
-00039990: 4d20 746f 2073 746f 7265 0a20 2020 2020  M to store.     
-000399a0: 2020 206f 7572 2064 6174 612c 2077 6974     our data, wit
-000399b0: 6820 6120 636f 6d66 6f72 7461 626c 6520  h a comfortable 
-000399c0: 6275 6666 6572 2e0a 0a20 2020 2020 2020  buffer...       
-000399d0: 2054 6869 7320 6973 2066 6f72 2075 7365   This is for use
-000399e0: 2077 6974 6820 7379 7374 656d 7320 6c69   with systems li
-000399f0: 6b65 2060 6064 6973 7472 6962 7574 6564  ke ``distributed
-00039a00: 2e64 6570 6c6f 792e 6164 6170 7469 7665  .deploy.adaptive
-00039a10: 6060 2e0a 0a20 2020 2020 2020 2050 6172  ``...        Par
-00039a20: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-00039a30: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-00039a40: 2020 206d 656d 6f72 795f 7261 7469 6f20     memory_ratio 
-00039a50: 3a20 4e75 6d62 6572 0a20 2020 2020 2020  : Number.       
-00039a60: 2020 2020 2041 6d6f 756e 7420 6f66 2065       Amount of e
-00039a70: 7874 7261 2073 7061 6365 2077 6520 7761  xtra space we wa
-00039a80: 6e74 2074 6f20 6861 7665 2066 6f72 206f  nt to have for o
-00039a90: 7572 2073 746f 7265 6420 6461 7461 2e0a  ur stored data..
-00039aa0: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
-00039ab0: 756c 7473 2074 6f20 322c 206f 7220 7468  ults to 2, or th
-00039ac0: 6174 2077 6520 7761 6e74 2074 6f20 6861  at we want to ha
-00039ad0: 7665 2074 7769 6365 2061 7320 6d75 6368  ve twice as much
-00039ae0: 206d 656d 6f72 7920 6173 2077 650a 2020   memory as we.  
-00039af0: 2020 2020 2020 2020 2020 6375 7272 656e            curren
-00039b00: 746c 7920 6861 7665 2064 6174 612e 0a20  tly have data.. 
-00039b10: 2020 2020 2020 206e 203a 2069 6e74 0a20         n : int. 
-00039b20: 2020 2020 2020 2020 2020 204e 756d 6265             Numbe
-00039b30: 7220 6f66 2077 6f72 6b65 7273 2074 6f20  r of workers to 
-00039b40: 636c 6f73 650a 2020 2020 2020 2020 6d69  close.        mi
-00039b50: 6e69 6d75 6d20 3a20 696e 740a 2020 2020  nimum : int.    
-00039b60: 2020 2020 2020 2020 4d69 6e69 6d75 6d20          Minimum 
-00039b70: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
-00039b80: 7320 746f 206b 6565 7020 6172 6f75 6e64  s to keep around
-00039b90: 0a20 2020 2020 2020 206b 6579 203a 2043  .        key : C
-00039ba0: 616c 6c61 626c 6528 576f 726b 6572 5374  allable(WorkerSt
-00039bb0: 6174 6529 0a20 2020 2020 2020 2020 2020  ate).           
-00039bc0: 2041 6e20 6f70 7469 6f6e 616c 2063 616c   An optional cal
-00039bd0: 6c61 626c 6520 6d61 7070 696e 6720 6120  lable mapping a 
-00039be0: 576f 726b 6572 5374 6174 6520 6f62 6a65  WorkerState obje
-00039bf0: 6374 2074 6f20 6120 6772 6f75 700a 2020  ct to a group.  
-00039c00: 2020 2020 2020 2020 2020 6166 6669 6c69            affili
-00039c10: 6174 696f 6e2e 2047 726f 7570 7320 7769  ation. Groups wi
-00039c20: 6c6c 2062 6520 636c 6f73 6564 2074 6f67  ll be closed tog
-00039c30: 6574 6865 722e 2054 6869 7320 6973 2075  ether. This is u
-00039c40: 7365 6675 6c20 7768 656e 0a20 2020 2020  seful when.     
-00039c50: 2020 2020 2020 2063 6c6f 7369 6e67 2077         closing w
-00039c60: 6f72 6b65 7273 206d 7573 7420 6265 2064  orkers must be d
-00039c70: 6f6e 6520 636f 6c6c 6563 7469 7665 6c79  one collectively
-00039c80: 2c20 7375 6368 2061 7320 6279 2068 6f73  , such as by hos
-00039c90: 746e 616d 652e 0a20 2020 2020 2020 2074  tname..        t
-00039ca0: 6172 6765 7420 3a20 696e 740a 2020 2020  arget : int.    
-00039cb0: 2020 2020 2020 2020 5461 7267 6574 206e          Target n
-00039cc0: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
-00039cd0: 2074 6f20 6861 7665 2061 6674 6572 2077   to have after w
-00039ce0: 6520 636c 6f73 650a 2020 2020 2020 2020  e close.        
-00039cf0: 6174 7472 6962 7574 6520 3a20 7374 720a  attribute : str.
-00039d00: 2020 2020 2020 2020 2020 2020 5468 6520              The 
-00039d10: 6174 7472 6962 7574 6520 6f66 2074 6865  attribute of the
-00039d20: 2057 6f72 6b65 7253 7461 7465 206f 626a   WorkerState obj
-00039d30: 6563 7420 746f 2072 6574 7572 6e2c 206c  ect to return, l
-00039d40: 696b 6520 2261 6464 7265 7373 220a 2020  ike "address".  
-00039d50: 2020 2020 2020 2020 2020 6f72 2022 6e61            or "na
-00039d60: 6d65 222e 2020 4465 6661 756c 7473 2074  me".  Defaults t
-00039d70: 6f20 2261 6464 7265 7373 222e 0a0a 2020  o "address"...  
-00039d80: 2020 2020 2020 4578 616d 706c 6573 0a20        Examples. 
-00039d90: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
-00039da0: 2020 2020 2020 2020 3e3e 3e20 7363 6865          >>> sche
-00039db0: 6475 6c65 722e 776f 726b 6572 735f 746f  duler.workers_to
-00039dc0: 5f63 6c6f 7365 2829 0a20 2020 2020 2020  _close().       
-00039dd0: 205b 2774 6370 3a2f 2f31 3932 2e31 3638   ['tcp://192.168
-00039de0: 2e30 2e31 3a31 3233 3427 2c20 2774 6370  .0.1:1234', 'tcp
-00039df0: 3a2f 2f31 3932 2e31 3638 2e30 2e32 3a31  ://192.168.0.2:1
-00039e00: 3233 3427 5d0a 0a20 2020 2020 2020 2047  234']..        G
-00039e10: 726f 7570 2077 6f72 6b65 7273 2062 7920  roup workers by 
-00039e20: 686f 7374 6e61 6d65 2070 7269 6f72 2074  hostname prior t
-00039e30: 6f20 636c 6f73 696e 670a 0a20 2020 2020  o closing..     
-00039e40: 2020 203e 3e3e 2073 6368 6564 756c 6572     >>> scheduler
-00039e50: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
-00039e60: 6528 6b65 793d 6c61 6d62 6461 2077 733a  e(key=lambda ws:
-00039e70: 2077 732e 686f 7374 290a 2020 2020 2020   ws.host).      
-00039e80: 2020 5b27 7463 703a 2f2f 3139 322e 3136    ['tcp://192.16
-00039e90: 382e 302e 313a 3132 3334 272c 2027 7463  8.0.1:1234', 'tc
-00039ea0: 703a 2f2f 3139 322e 3136 382e 302e 313a  p://192.168.0.1:
-00039eb0: 3435 3637 275d 0a0a 2020 2020 2020 2020  4567']..        
-00039ec0: 5265 6d6f 7665 2074 776f 2077 6f72 6b65  Remove two worke
-00039ed0: 7273 0a0a 2020 2020 2020 2020 3e3e 3e20  rs..        >>> 
-00039ee0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-00039ef0: 735f 746f 5f63 6c6f 7365 286e 3d32 290a  s_to_close(n=2).
-00039f00: 0a20 2020 2020 2020 204b 6565 7020 656e  .        Keep en
-00039f10: 6f75 6768 2077 6f72 6b65 7273 2074 6f20  ough workers to 
-00039f20: 6861 7665 2074 7769 6365 2061 7320 6d75  have twice as mu
-00039f30: 6368 206d 656d 6f72 7920 6173 2077 6520  ch memory as we 
-00039f40: 7765 206e 6565 642e 0a0a 2020 2020 2020  we need...      
-00039f50: 2020 3e3e 3e20 7363 6865 6475 6c65 722e    >>> scheduler.
-00039f60: 776f 726b 6572 735f 746f 5f63 6c6f 7365  workers_to_close
-00039f70: 286d 656d 6f72 795f 7261 7469 6f3d 3229  (memory_ratio=2)
-00039f80: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-00039f90: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00039fa0: 2d0a 2020 2020 2020 2020 746f 5f63 6c6f  -.        to_clo
-00039fb0: 7365 3a20 6c69 7374 206f 6620 776f 726b  se: list of work
-00039fc0: 6572 2061 6464 7265 7373 6573 2074 6861  er addresses tha
-00039fd0: 7420 6172 6520 4f4b 2074 6f20 636c 6f73  t are OK to clos
-00039fe0: 650a 0a20 2020 2020 2020 2053 6565 2041  e..        See A
-00039ff0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-0003a000: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-0003a010: 6564 756c 6572 2e72 6574 6972 655f 776f  eduler.retire_wo
-0003a020: 726b 6572 730a 2020 2020 2020 2020 2222  rkers.        ""
-0003a030: 220a 2020 2020 2020 2020 6966 2074 6172  ".        if tar
-0003a040: 6765 7420 6973 206e 6f74 204e 6f6e 6520  get is not None 
-0003a050: 616e 6420 6e20 6973 204e 6f6e 653a 0a20  and n is None:. 
-0003a060: 2020 2020 2020 2020 2020 206e 203d 206c             n = l
-0003a070: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
-0003a080: 202d 2074 6172 6765 740a 2020 2020 2020   - target.      
-0003a090: 2020 6966 206e 2069 7320 6e6f 7420 4e6f    if n is not No
-0003a0a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003a0b0: 6966 206e 203c 2030 3a0a 2020 2020 2020  if n < 0:.      
-0003a0c0: 2020 2020 2020 2020 2020 6e20 3d20 300a            n = 0.
-0003a0d0: 2020 2020 2020 2020 2020 2020 7461 7267              targ
-0003a0e0: 6574 203d 206c 656e 2873 656c 662e 776f  et = len(self.wo
-0003a0f0: 726b 6572 7329 202d 206e 0a0a 2020 2020  rkers) - n..    
-0003a100: 2020 2020 6966 206e 2069 7320 4e6f 6e65      if n is None
-0003a110: 2061 6e64 206d 656d 6f72 795f 7261 7469   and memory_rati
-0003a120: 6f20 6973 204e 6f6e 653a 0a20 2020 2020  o is None:.     
-0003a130: 2020 2020 2020 206d 656d 6f72 795f 7261         memory_ra
-0003a140: 7469 6f20 3d20 320a 0a20 2020 2020 2020  tio = 2..       
-0003a150: 2077 6974 6820 6c6f 675f 6572 726f 7273   with log_errors
-0003a160: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0003a170: 6966 206e 6f74 206e 2061 6e64 2061 6c6c  if not n and all
-0003a180: 285b 7773 2e70 726f 6365 7373 696e 6720  ([ws.processing 
-0003a190: 666f 7220 7773 2069 6e20 7365 6c66 2e77  for ws in self.w
-0003a1a0: 6f72 6b65 7273 2e76 616c 7565 7328 295d  orkers.values()]
-0003a1b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003a1c0: 2020 2072 6574 7572 6e20 5b5d 0a0a 2020     return []..  
-0003a1d0: 2020 2020 2020 2020 2020 6966 206b 6579            if key
-0003a1e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003a1f0: 2020 2020 2020 2020 2020 6b65 7920 3d20            key = 
-0003a200: 6f70 6572 6174 6f72 2e61 7474 7267 6574  operator.attrget
-0003a210: 7465 7228 2261 6464 7265 7373 2229 0a20  ter("address"). 
-0003a220: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0003a230: 696e 7374 616e 6365 286b 6579 2c20 6279  instance(key, by
-0003a240: 7465 7329 2061 6e64 2064 6173 6b2e 636f  tes) and dask.co
-0003a250: 6e66 6967 2e67 6574 280a 2020 2020 2020  nfig.get(.      
-0003a260: 2020 2020 2020 2020 2020 2264 6973 7472            "distr
-0003a270: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0003a280: 2e70 6963 6b6c 6522 0a20 2020 2020 2020  .pickle".       
-0003a290: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-0003a2a0: 2020 2020 2020 2020 6b65 7920 3d20 7069          key = pi
-0003a2b0: 636b 6c65 2e6c 6f61 6473 286b 6579 290a  ckle.loads(key).
-0003a2c0: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
-0003a2d0: 7570 7320 3d20 6772 6f75 7062 7928 6b65  ups = groupby(ke
-0003a2e0: 792c 2073 656c 662e 776f 726b 6572 732e  y, self.workers.
-0003a2f0: 7661 6c75 6573 2829 290a 0a20 2020 2020  values())..     
-0003a300: 2020 2020 2020 206c 696d 6974 5f62 7974         limit_byt
-0003a310: 6573 203d 207b 0a20 2020 2020 2020 2020  es = {.         
-0003a320: 2020 2020 2020 206b 3a20 7375 6d28 7773         k: sum(ws
-0003a330: 2e6d 656d 6f72 795f 6c69 6d69 7420 666f  .memory_limit fo
-0003a340: 7220 7773 2069 6e20 7629 2066 6f72 206b  r ws in v) for k
-0003a350: 2c20 7620 696e 2067 726f 7570 732e 6974  , v in groups.it
-0003a360: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-0003a370: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0003a380: 6772 6f75 705f 6279 7465 7320 3d20 7b6b  group_bytes = {k
-0003a390: 3a20 7375 6d28 7773 2e6e 6279 7465 7320  : sum(ws.nbytes 
-0003a3a0: 666f 7220 7773 2069 6e20 7629 2066 6f72  for ws in v) for
-0003a3b0: 206b 2c20 7620 696e 2067 726f 7570 732e   k, v in groups.
-0003a3c0: 6974 656d 7328 297d 0a0a 2020 2020 2020  items()}..      
-0003a3d0: 2020 2020 2020 6c69 6d69 7420 3d20 7375        limit = su
-0003a3e0: 6d28 6c69 6d69 745f 6279 7465 732e 7661  m(limit_bytes.va
-0003a3f0: 6c75 6573 2829 290a 2020 2020 2020 2020  lues()).        
-0003a400: 2020 2020 746f 7461 6c20 3d20 7375 6d28      total = sum(
-0003a410: 6772 6f75 705f 6279 7465 732e 7661 6c75  group_bytes.valu
-0003a420: 6573 2829 290a 0a20 2020 2020 2020 2020  es())..         
-0003a430: 2020 2064 6566 205f 6b65 7928 6772 6f75     def _key(grou
-0003a440: 7029 3a0a 2020 2020 2020 2020 2020 2020  p):.            
-0003a450: 2020 2020 6973 5f69 646c 6520 3d20 6e6f      is_idle = no
-0003a460: 7420 616e 7928 5b77 7773 2e70 726f 6365  t any([wws.proce
-0003a470: 7373 696e 6720 666f 7220 7777 7320 696e  ssing for wws in
-0003a480: 2067 726f 7570 735b 6772 6f75 705d 5d29   groups[group]])
-0003a490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a4a0: 2062 7974 6573 203d 202d 6772 6f75 705f   bytes = -group_
-0003a4b0: 6279 7465 735b 6772 6f75 705d 0a20 2020  bytes[group].   
-0003a4c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0003a4d0: 7572 6e20 6973 5f69 646c 652c 2062 7974  urn is_idle, byt
-0003a4e0: 6573 0a0a 2020 2020 2020 2020 2020 2020  es..            
-0003a4f0: 6964 6c65 203d 2073 6f72 7465 6428 6772  idle = sorted(gr
-0003a500: 6f75 7073 2c20 6b65 793d 5f6b 6579 290a  oups, key=_key).
-0003a510: 0a20 2020 2020 2020 2020 2020 2074 6f5f  .            to_
-0003a520: 636c 6f73 6520 3d20 5b5d 0a20 2020 2020  close = [].     
-0003a530: 2020 2020 2020 206e 5f72 656d 6169 6e20         n_remain 
-0003a540: 3d20 6c65 6e28 7365 6c66 2e77 6f72 6b65  = len(self.worke
-0003a550: 7273 290a 0a20 2020 2020 2020 2020 2020  rs)..           
-0003a560: 2077 6869 6c65 2069 646c 653a 0a20 2020   while idle:.   
-0003a570: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-0003a580: 7570 203d 2069 646c 652e 706f 7028 290a  up = idle.pop().
-0003a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a5a0: 6966 206e 2069 7320 4e6f 6e65 2061 6e64  if n is None and
-0003a5b0: 2061 6e79 285b 7773 2e70 726f 6365 7373   any([ws.process
-0003a5c0: 696e 6720 666f 7220 7773 2069 6e20 6772  ing for ws in gr
-0003a5d0: 6f75 7073 5b67 726f 7570 5d5d 293a 0a20  oups[group]]):. 
-0003a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a5f0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0003a600: 2020 2020 2020 2020 2020 6966 206d 696e            if min
-0003a610: 696d 756d 2061 6e64 206e 5f72 656d 6169  imum and n_remai
-0003a620: 6e20 2d20 6c65 6e28 6772 6f75 7073 5b67  n - len(groups[g
-0003a630: 726f 7570 5d29 203c 206d 696e 696d 756d  roup]) < minimum
-0003a640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003a650: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
-0003a660: 2020 2020 2020 2020 2020 2020 206c 696d               lim
-0003a670: 6974 202d 3d20 6c69 6d69 745f 6279 7465  it -= limit_byte
-0003a680: 735b 6772 6f75 705d 0a0a 2020 2020 2020  s[group]..      
-0003a690: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
-0003a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a6b0: 2020 206e 2069 7320 6e6f 7420 4e6f 6e65     n is not None
-0003a6c0: 2061 6e64 206e 5f72 656d 6169 6e20 2d20   and n_remain - 
-0003a6d0: 6c65 6e28 6772 6f75 7073 5b67 726f 7570  len(groups[group
-0003a6e0: 5d29 203e 3d20 2874 6172 6765 7420 6f72  ]) >= (target or
-0003a6f0: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
-0003a700: 2020 2020 2920 6f72 2028 6d65 6d6f 7279      ) or (memory
-0003a710: 5f72 6174 696f 2069 7320 6e6f 7420 4e6f  _ratio is not No
-0003a720: 6e65 2061 6e64 206c 696d 6974 203e 3d20  ne and limit >= 
-0003a730: 6d65 6d6f 7279 5f72 6174 696f 202a 2074  memory_ratio * t
-0003a740: 6f74 616c 293a 0a20 2020 2020 2020 2020  otal):.         
-0003a750: 2020 2020 2020 2020 2020 2074 6f5f 636c             to_cl
-0003a760: 6f73 652e 6170 7065 6e64 2867 726f 7570  ose.append(group
-0003a770: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003a780: 2020 2020 2020 6e5f 7265 6d61 696e 202d        n_remain -
-0003a790: 3d20 6c65 6e28 6772 6f75 7073 5b67 726f  = len(groups[gro
-0003a7a0: 7570 5d29 0a0a 2020 2020 2020 2020 2020  up])..          
-0003a7b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00033f90: 2020 2020 2320 6f75 7220 7368 7574 2d64      # our shut-d
+00033fa0: 6f77 6e20 776f 726b 6572 7320 6861 7665  own workers have
+00033fb0: 2063 6f6d 6520 6261 636b 2075 702e 2054   come back up. T
+00033fc0: 6861 7427 7320 6669 6e65 3b20 776f 726b  hat's fine; work
+00033fd0: 6572 7320 6172 6520 696e 7465 7263 6861  ers are intercha
+00033fe0: 6e67 6561 626c 652e 0a20 2020 2020 2020  ngeable..       
+00033ff0: 2020 2020 2020 2020 2069 6620 6d6f 6e6f           if mono
+00034000: 746f 6e69 6328 2920 3c20 7374 6172 7420  tonic() < start 
+00034010: 2b20 7469 6d65 6f75 743a 0a20 2020 2020  + timeout:.     
+00034020: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00034030: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
+00034040: 6570 2830 2e32 290a 2020 2020 2020 2020  ep(0.2).        
+00034050: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00034060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034070: 2020 6d73 6720 3d20 280a 2020 2020 2020    msg = (.      
+00034080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034090: 2020 6622 5761 6974 6564 2066 6f72 207b    f"Waited for {
+000340a0: 6e5f 776f 726b 6572 737d 2077 6f72 6b65  n_workers} worke
+000340b0: 7228 7329 2074 6f20 7265 636f 6e6e 6563  r(s) to reconnec
+000340c0: 7420 6166 7465 7220 7265 7374 6172 7469  t after restarti
+000340d0: 6e67 2c20 220a 2020 2020 2020 2020 2020  ng, ".          
+000340e0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000340f0: 6275 7420 6166 7465 7220 7b74 696d 656f  but after {timeo
+00034100: 7574 7d73 2c20 6f6e 6c79 207b 6c65 6e28  ut}s, only {len(
+00034110: 7365 6c66 2e77 6f72 6b65 7273 297d 2068  self.workers)} h
+00034120: 6176 6520 7265 7475 726e 6564 2e20 220a  ave returned. ".
+00034130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034140: 2020 2020 2020 2020 2243 6f6e 7369 6465          "Conside
+00034150: 7220 6120 6c6f 6e67 6572 2074 696d 656f  r a longer timeo
+00034160: 7574 2c20 6f72 2060 7761 6974 5f66 6f72  ut, or `wait_for
+00034170: 5f77 6f72 6b65 7273 3d46 616c 7365 602e  _workers=False`.
+00034180: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00034190: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000341a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000341b0: 286e 5f6e 616e 6e79 203a 3d20 6c65 6e28  (n_nanny := len(
+000341c0: 6e61 6e6e 795f 776f 726b 6572 7329 2920  nanny_workers)) 
+000341d0: 3c20 6e5f 776f 726b 6572 733a 0a20 2020  < n_workers:.   
+000341e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000341f0: 2020 2020 206d 7367 202b 3d20 280a 2020       msg += (.  
+00034200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034210: 2020 2020 2020 2020 2020 6622 2054 6865            f" The
+00034220: 207b 6e5f 776f 726b 6572 7320 2d20 6e5f   {n_workers - n_
+00034230: 6e61 6e6e 797d 2077 6f72 6b65 7228 7329  nanny} worker(s)
+00034240: 206e 6f74 2075 7369 6e67 204e 616e 6e69   not using Nanni
+00034250: 6573 2077 6572 6520 6a75 7374 2073 6875  es were just shu
+00034260: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
+00034270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034280: 2264 6f77 6e20 696e 7374 6561 6420 6f66  "down instead of
+00034290: 2072 6573 7461 7274 6564 2028 7265 7374   restarted (rest
+000342a0: 6172 7420 6973 206f 6e6c 7920 706f 7373  art is only poss
+000342b0: 6962 6c65 2077 6974 6820 4e61 6e6e 6965  ible with Nannie
+000342c0: 7329 2e20 4966 2022 0a20 2020 2020 2020  s). If ".       
+000342d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000342e0: 2020 2020 2022 796f 7572 2064 6570 6c6f       "your deplo
+000342f0: 796d 656e 7420 7379 7374 656d 2064 6f65  yment system doe
+00034300: 7320 6e6f 7420 6175 746f 6d61 7469 6361  s not automatica
+00034310: 6c6c 7920 7265 2d6c 6175 6e63 6820 7465  lly re-launch te
+00034320: 726d 696e 6174 6564 2022 0a20 2020 2020  rminated ".     
+00034330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034340: 2020 2020 2020 2022 7072 6f63 6573 7365         "processe
+00034350: 732c 2074 6865 6e20 7468 6f73 6520 776f  s, then those wo
+00034360: 726b 6572 7320 7769 6c6c 206e 6576 6572  rkers will never
+00034370: 2063 6f6d 6520 6261 636b 2c20 616e 6420   come back, and 
+00034380: 6043 6c69 656e 742e 7265 7374 6172 7460  `Client.restart`
+00034390: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+000343a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000343b0: 7769 6c6c 2061 6c77 6179 7320 7469 6d65  will always time
+000343c0: 206f 7574 2e20 446f 206e 6f74 2075 7365   out. Do not use
+000343d0: 2060 436c 6965 6e74 2e72 6573 7461 7274   `Client.restart
+000343e0: 6020 696e 2074 6861 7420 6361 7365 2e22  ` in that case."
+000343f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034400: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00034410: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00034420: 6169 7365 2054 696d 656f 7574 4572 726f  aise TimeoutErro
+00034430: 7228 6d73 6729 2066 726f 6d20 4e6f 6e65  r(msg) from None
+00034440: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+00034450: 696e 666f 2822 5265 7374 6172 7469 6e67  info("Restarting
+00034460: 2066 696e 6973 6865 642e 2229 0a0a 2020   finished.")..  
+00034470: 2020 6173 796e 6320 6465 6620 6272 6f61    async def broa
+00034480: 6463 6173 7428 0a20 2020 2020 2020 2073  dcast(.        s
+00034490: 656c 662c 0a20 2020 2020 2020 202a 2c0a  elf,.        *,.
+000344a0: 2020 2020 2020 2020 6d73 673a 2064 6963          msg: dic
+000344b0: 742c 0a20 2020 2020 2020 2077 6f72 6b65  t,.        worke
+000344c0: 7273 3a20 6c69 7374 5b73 7472 5d20 7c20  rs: list[str] | 
+000344d0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+000344e0: 2020 2020 2068 6f73 7473 3a20 6c69 7374       hosts: list
+000344f0: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
+00034500: 6f6e 652c 0a20 2020 2020 2020 206e 616e  one,.        nan
+00034510: 6e79 3a20 626f 6f6c 203d 2046 616c 7365  ny: bool = False
+00034520: 2c0a 2020 2020 2020 2020 7365 7269 616c  ,.        serial
+00034530: 697a 6572 733a 2041 6e79 203d 204e 6f6e  izers: Any = Non
+00034540: 652c 0a20 2020 2020 2020 206f 6e5f 6572  e,.        on_er
+00034550: 726f 723a 2022 4c69 7465 7261 6c5b 2772  ror: "Literal['r
+00034560: 6169 7365 272c 2027 7265 7475 726e 272c  aise', 'return',
+00034570: 2027 7265 7475 726e 5f70 6963 6b6c 6527   'return_pickle'
+00034580: 2c20 2769 676e 6f72 6527 5d22 203d 2022  , 'ignore']" = "
+00034590: 7261 6973 6522 2c0a 2020 2020 2920 2d3e  raise",.    ) ->
+000345a0: 2064 6963 743a 2020 2320 6469 6374 5b73   dict:  # dict[s
+000345b0: 7472 2c20 416e 795d 0a20 2020 2020 2020  tr, Any].       
+000345c0: 2022 2222 4272 6f61 6463 6173 7420 6d65   """Broadcast me
+000345d0: 7373 6167 6520 746f 2077 6f72 6b65 7273  ssage to workers
+000345e0: 2c20 7265 7475 726e 2061 6c6c 2072 6573  , return all res
+000345f0: 756c 7473 2222 220a 2020 2020 2020 2020  ults""".        
+00034600: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
+00034610: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00034620: 6966 2068 6f73 7473 2069 7320 4e6f 6e65  if hosts is None
+00034630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034640: 2020 776f 726b 6572 7320 3d20 6c69 7374    workers = list
+00034650: 2873 656c 662e 776f 726b 6572 7329 0a20  (self.workers). 
+00034660: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00034670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034680: 2077 6f72 6b65 7273 203d 205b 5d0a 2020   workers = [].  
+00034690: 2020 2020 2020 6966 2068 6f73 7473 2069        if hosts i
+000346a0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000346b0: 2020 2020 2020 2020 666f 7220 686f 7374          for host
+000346c0: 2069 6e20 686f 7374 733a 0a20 2020 2020   in hosts:.     
+000346d0: 2020 2020 2020 2020 2020 2064 683a 2064             dh: d
+000346e0: 6963 7420 3d20 7365 6c66 2e68 6f73 745f  ict = self.host_
+000346f0: 696e 666f 2e67 6574 2868 6f73 7429 2020  info.get(host)  
+00034700: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+00034710: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00034720: 6620 6468 2069 7320 6e6f 7420 4e6f 6e65  f dh is not None
+00034730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034740: 2020 2020 2020 776f 726b 6572 732e 6578        workers.ex
+00034750: 7465 6e64 2864 685b 2261 6464 7265 7373  tend(dh["address
+00034760: 6573 225d 290a 2020 2020 2020 2020 2320  es"]).        # 
+00034770: 544f 444f 2072 6570 6c61 6365 2077 6974  TODO replace wit
+00034780: 6820 776f 726b 6572 5f6c 6973 740a 0a20  h worker_list.. 
+00034790: 2020 2020 2020 2069 6620 6e61 6e6e 793a         if nanny:
+000347a0: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
+000347b0: 7265 7373 6573 203d 205b 7365 6c66 2e77  resses = [self.w
+000347c0: 6f72 6b65 7273 5b77 5d2e 6e61 6e6e 7920  orkers[w].nanny 
+000347d0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+000347e0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
+000347f0: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+00034800: 6573 7365 7320 3d20 776f 726b 6572 730a  esses = workers.
+00034810: 0a20 2020 2020 2020 2045 5252 4f52 203d  .        ERROR =
+00034820: 206f 626a 6563 7428 290a 0a20 2020 2020   object()..     
+00034830: 2020 2061 7379 6e63 2064 6566 2073 656e     async def sen
+00034840: 645f 6d65 7373 6167 6528 6164 6472 293a  d_message(addr):
+00034850: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+00034860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034870: 2020 636f 6d6d 203d 2061 7761 6974 2073    comm = await s
+00034880: 656c 662e 7270 632e 636f 6e6e 6563 7428  elf.rpc.connect(
+00034890: 6164 6472 290a 2020 2020 2020 2020 2020  addr).          
+000348a0: 2020 2020 2020 636f 6d6d 2e6e 616d 6520        comm.name 
+000348b0: 3d20 2253 6368 6564 756c 6572 2042 726f  = "Scheduler Bro
+000348c0: 6164 6361 7374 220a 2020 2020 2020 2020  adcast".        
+000348d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000348e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000348f0: 2072 6573 7020 3d20 6177 6169 7420 7365   resp = await se
+00034900: 6e64 5f72 6563 7628 0a20 2020 2020 2020  nd_recv(.       
+00034910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034920: 2063 6f6d 6d2c 2063 6c6f 7365 3d54 7275   comm, close=Tru
+00034930: 652c 2073 6572 6961 6c69 7a65 7273 3d73  e, serializers=s
+00034940: 6572 6961 6c69 7a65 7273 2c20 2a2a 6d73  erializers, **ms
+00034950: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+00034960: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00034970: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
+00034980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034990: 2020 2020 2073 656c 662e 7270 632e 7265       self.rpc.re
+000349a0: 7573 6528 6164 6472 2c20 636f 6d6d 290a  use(addr, comm).
+000349b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000349c0: 7265 7475 726e 2072 6573 700a 2020 2020  return resp.    
+000349d0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+000349e0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+000349f0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00034a00: 6f67 6765 722e 6572 726f 7228 6622 6272  ogger.error(f"br
+00034a10: 6f61 6463 6173 7420 746f 207b 6164 6472  oadcast to {addr
+00034a20: 7d20 6661 696c 6564 3a20 7b65 2e5f 5f63  } failed: {e.__c
+00034a30: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
+00034a40: 3a20 7b65 7d22 290a 2020 2020 2020 2020  : {e}").        
+00034a50: 2020 2020 2020 2020 6966 206f 6e5f 6572          if on_er
+00034a60: 726f 7220 3d3d 2022 7261 6973 6522 3a0a  ror == "raise":.
+00034a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034a80: 2020 2020 7261 6973 650a 2020 2020 2020      raise.      
+00034a90: 2020 2020 2020 2020 2020 656c 6966 206f            elif o
+00034aa0: 6e5f 6572 726f 7220 3d3d 2022 7265 7475  n_error == "retu
+00034ab0: 726e 223a 0a20 2020 2020 2020 2020 2020  rn":.           
+00034ac0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00034ad0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00034ae0: 2020 656c 6966 206f 6e5f 6572 726f 7220    elif on_error 
+00034af0: 3d3d 2022 7265 7475 726e 5f70 6963 6b6c  == "return_pickl
+00034b00: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00034b10: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00034b20: 756d 7073 2865 290a 2020 2020 2020 2020  umps(e).        
+00034b30: 2020 2020 2020 2020 656c 6966 206f 6e5f          elif on_
+00034b40: 6572 726f 7220 3d3d 2022 6967 6e6f 7265  error == "ignore
+00034b50: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00034b60: 2020 2020 2020 2072 6574 7572 6e20 4552         return ER
+00034b70: 524f 520a 2020 2020 2020 2020 2020 2020  ROR.            
+00034b80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00034b90: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00034ba0: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+00034bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034bc0: 2020 2020 2020 2020 226f 6e5f 6572 726f          "on_erro
+00034bd0: 7220 6d75 7374 2062 6520 2772 6169 7365  r must be 'raise
+00034be0: 272c 2027 7265 7475 726e 272c 2027 7265  ', 'return', 're
+00034bf0: 7475 726e 5f70 6963 6b6c 6527 2c20 220a  turn_pickle', ".
+00034c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034c10: 2020 2020 2020 2020 6622 6f72 2027 6967          f"or 'ig
+00034c20: 6e6f 7265 273b 2067 6f74 207b 6f6e 5f65  nore'; got {on_e
+00034c30: 7272 6f72 2172 7d22 0a20 2020 2020 2020  rror!r}".       
+00034c40: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00034c50: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
+00034c60: 3d20 6177 6169 7420 416c 6c28 0a20 2020  = await All(.   
+00034c70: 2020 2020 2020 2020 205b 7365 6e64 5f6d           [send_m
+00034c80: 6573 7361 6765 2861 6464 7265 7373 2920  essage(address) 
+00034c90: 666f 7220 6164 6472 6573 7320 696e 2061  for address in a
+00034ca0: 6464 7265 7373 6573 2069 6620 6164 6472  ddresses if addr
+00034cb0: 6573 7320 6973 206e 6f74 204e 6f6e 655d  ess is not None]
+00034cc0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00034cd0: 2020 2020 7265 7475 726e 207b 6b3a 2076      return {k: v
+00034ce0: 2066 6f72 206b 2c20 7620 696e 207a 6970   for k, v in zip
+00034cf0: 2877 6f72 6b65 7273 2c20 7265 7375 6c74  (workers, result
+00034d00: 7329 2069 6620 7620 6973 206e 6f74 2045  s) if v is not E
+00034d10: 5252 4f52 7d0a 0a20 2020 2061 7379 6e63  RROR}..    async
+00034d20: 2064 6566 2070 726f 7879 280a 2020 2020   def proxy(.    
+00034d30: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00034d40: 2020 6d73 673a 2064 6963 742c 0a20 2020    msg: dict,.   
+00034d50: 2020 2020 2077 6f72 6b65 723a 2073 7472       worker: str
+00034d60: 2c0a 2020 2020 2020 2020 7365 7269 616c  ,.        serial
+00034d70: 697a 6572 733a 2041 6e79 203d 204e 6f6e  izers: Any = Non
+00034d80: 652c 0a20 2020 2029 202d 3e20 416e 793a  e,.    ) -> Any:
+00034d90: 0a20 2020 2020 2020 2022 2222 5072 6f78  .        """Prox
+00034da0: 7920 6120 636f 6d6d 756e 6963 6174 696f  y a communicatio
+00034db0: 6e20 7468 726f 7567 6820 7468 6520 7363  n through the sc
+00034dc0: 6865 6475 6c65 7220 746f 2073 6f6d 6520  heduler to some 
+00034dd0: 6f74 6865 7220 776f 726b 6572 2222 220a  other worker""".
+00034de0: 2020 2020 2020 2020 6420 3d20 6177 6169          d = awai
+00034df0: 7420 7365 6c66 2e62 726f 6164 6361 7374  t self.broadcast
+00034e00: 286d 7367 3d6d 7367 2c20 776f 726b 6572  (msg=msg, worker
+00034e10: 733d 5b77 6f72 6b65 725d 2c20 7365 7269  s=[worker], seri
+00034e20: 616c 697a 6572 733d 7365 7269 616c 697a  alizers=serializ
+00034e30: 6572 7329 0a20 2020 2020 2020 2072 6574  ers).        ret
+00034e40: 7572 6e20 645b 776f 726b 6572 5d0a 0a20  urn d[worker].. 
+00034e50: 2020 2061 7379 6e63 2064 6566 2067 6174     async def gat
+00034e60: 6865 725f 6f6e 5f77 6f72 6b65 7228 0a20  her_on_worker(. 
+00034e70: 2020 2020 2020 2073 656c 662c 2077 6f72         self, wor
+00034e80: 6b65 725f 6164 6472 6573 733a 2073 7472  ker_address: str
+00034e90: 2c20 7768 6f5f 6861 733a 2022 6469 6374  , who_has: "dict
+00034ea0: 5b73 7472 2c20 6c69 7374 5b73 7472 5d5d  [str, list[str]]
+00034eb0: 220a 2020 2020 2920 2d3e 2073 6574 3a0a  ".    ) -> set:.
+00034ec0: 2020 2020 2020 2020 2222 2250 6565 722d          """Peer-
+00034ed0: 746f 2d70 6565 7220 636f 7079 206f 6620  to-peer copy of 
+00034ee0: 6b65 7973 2066 726f 6d20 6d75 6c74 6970  keys from multip
+00034ef0: 6c65 2077 6f72 6b65 7273 2074 6f20 6120  le workers to a 
+00034f00: 7369 6e67 6c65 2077 6f72 6b65 720a 0a20  single worker.. 
+00034f10: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+00034f20: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00034f30: 2d2d 2d2d 0a20 2020 2020 2020 2077 6f72  ----.        wor
+00034f40: 6b65 725f 6164 6472 6573 733a 2073 7472  ker_address: str
+00034f50: 0a20 2020 2020 2020 2020 2020 2052 6563  .            Rec
+00034f60: 6970 6965 6e74 2077 6f72 6b65 7220 6164  ipient worker ad
+00034f70: 6472 6573 7320 746f 2063 6f70 7920 6b65  dress to copy ke
+00034f80: 7973 2074 6f0a 2020 2020 2020 2020 7768  ys to.        wh
+00034f90: 6f5f 6861 733a 2064 6963 745b 4861 7368  o_has: dict[Hash
+00034fa0: 6162 6c65 2c20 6c69 7374 5b73 7472 5d5d  able, list[str]]
+00034fb0: 0a20 2020 2020 2020 2020 2020 207b 6b65  .            {ke
+00034fc0: 793a 205b 7365 6e64 6572 2061 6464 7265  y: [sender addre
+00034fd0: 7373 2c20 7365 6e64 6572 2061 6464 7265  ss, sender addre
+00034fe0: 7373 2c20 2e2e 2e5d 2c20 6b65 793a 202e  ss, ...], key: .
+00034ff0: 2e2e 7d0a 0a20 2020 2020 2020 2052 6574  ..}..        Ret
+00035000: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
+00035010: 2d2d 2d2d 0a20 2020 2020 2020 2072 6574  ----.        ret
+00035020: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00035030: 2020 7365 7420 6f66 206b 6579 7320 7468    set of keys th
+00035040: 6174 2066 6169 6c65 6420 746f 2062 6520  at failed to be 
+00035050: 636f 7069 6564 0a20 2020 2020 2020 2022  copied.        "
+00035060: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
+00035070: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00035080: 6c74 203d 2061 7761 6974 2072 6574 7279  lt = await retry
+00035090: 5f6f 7065 7261 7469 6f6e 280a 2020 2020  _operation(.    
+000350a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000350b0: 2e72 7063 2861 6464 723d 776f 726b 6572  .rpc(addr=worker
+000350c0: 5f61 6464 7265 7373 292e 6761 7468 6572  _address).gather
+000350d0: 2c20 7768 6f5f 6861 733d 7768 6f5f 6861  , who_has=who_ha
+000350e0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
+000350f0: 2020 2020 2020 2020 6578 6365 7074 204f          except O
+00035100: 5345 7272 6f72 2061 7320 653a 0a20 2020  SError as e:.   
+00035110: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+00035120: 6361 6e20 6861 7070 656e 2065 2e67 2e20  can happen e.g. 
+00035130: 6966 2074 6865 2077 6f72 6b65 7220 6973  if the worker is
+00035140: 2067 6f69 6e67 2074 6872 6f75 6768 2063   going through c
+00035150: 6f6e 7472 6f6c 6c65 6420 7368 7574 646f  ontrolled shutdo
+00035160: 776e 3b0a 2020 2020 2020 2020 2020 2020  wn;.            
+00035170: 2320 6974 2064 6f65 736e 2774 206e 6563  # it doesn't nec
+00035180: 6573 7361 7269 6c79 206d 6561 6e20 7468  essarily mean th
+00035190: 6174 2069 7420 7765 6e74 2075 6e65 7870  at it went unexp
+000351a0: 6563 7465 646c 7920 6d69 7373 696e 670a  ectedly missing.
+000351b0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+000351c0: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
+000351d0: 2020 2020 2020 2020 2020 2020 6622 436f              f"Co
+000351e0: 6d6d 756e 6963 6174 696f 6e20 7769 7468  mmunication with
+000351f0: 2077 6f72 6b65 7220 7b77 6f72 6b65 725f   worker {worker_
+00035200: 6164 6472 6573 737d 2066 6169 6c65 6420  address} failed 
+00035210: 6475 7269 6e67 2022 0a20 2020 2020 2020  during ".       
+00035220: 2020 2020 2020 2020 2066 2272 6570 6c69           f"repli
+00035230: 6361 7469 6f6e 3a20 7b65 2e5f 5f63 6c61  cation: {e.__cla
+00035240: 7373 5f5f 2e5f 5f6e 616d 655f 5f7d 3a20  ss__.__name__}: 
+00035250: 7b65 7d22 0a20 2020 2020 2020 2020 2020  {e}".           
+00035260: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
+00035270: 6574 7572 6e20 7365 7428 7768 6f5f 6861  eturn set(who_ha
+00035280: 7329 0a0a 2020 2020 2020 2020 7773 203d  s)..        ws =
+00035290: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
+000352a0: 7428 776f 726b 6572 5f61 6464 7265 7373  t(worker_address
+000352b0: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+000352c0: 7420 7773 3a0a 2020 2020 2020 2020 2020  t ws:.          
+000352d0: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+000352e0: 2866 2257 6f72 6b65 7220 7b77 6f72 6b65  (f"Worker {worke
+000352f0: 725f 6164 6472 6573 737d 206c 6f73 7420  r_address} lost 
+00035300: 6475 7269 6e67 2072 6570 6c69 6361 7469  during replicati
+00035310: 6f6e 2229 0a20 2020 2020 2020 2020 2020  on").           
+00035320: 2072 6574 7572 6e20 7365 7428 7768 6f5f   return set(who_
+00035330: 6861 7329 0a20 2020 2020 2020 2065 6c69  has).        eli
+00035340: 6620 7265 7375 6c74 5b22 7374 6174 7573  f result["status
+00035350: 225d 203d 3d20 224f 4b22 3a0a 2020 2020  "] == "OK":.    
+00035360: 2020 2020 2020 2020 6b65 7973 5f66 6169          keys_fai
+00035370: 6c65 6420 3d20 7365 7428 290a 2020 2020  led = set().    
+00035380: 2020 2020 2020 2020 6b65 7973 5f6f 6b3a          keys_ok:
+00035390: 2053 6574 203d 2077 686f 5f68 6173 2e6b   Set = who_has.k
+000353a0: 6579 7328 290a 2020 2020 2020 2020 656c  eys().        el
+000353b0: 6966 2072 6573 756c 745b 2273 7461 7475  if result["statu
+000353c0: 7322 5d20 3d3d 2022 7061 7274 6961 6c2d  s"] == "partial-
+000353d0: 6661 696c 223a 0a20 2020 2020 2020 2020  fail":.         
+000353e0: 2020 206b 6579 735f 6661 696c 6564 203d     keys_failed =
+000353f0: 2073 6574 2872 6573 756c 745b 226b 6579   set(result["key
+00035400: 7322 5d29 0a20 2020 2020 2020 2020 2020  s"]).           
+00035410: 206b 6579 735f 6f6b 203d 2077 686f 5f68   keys_ok = who_h
+00035420: 6173 2e6b 6579 7328 2920 2d20 6b65 7973  as.keys() - keys
+00035430: 5f66 6169 6c65 640a 2020 2020 2020 2020  _failed.        
+00035440: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
+00035450: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+00035460: 2020 2020 6622 576f 726b 6572 207b 776f      f"Worker {wo
+00035470: 726b 6572 5f61 6464 7265 7373 7d20 6661  rker_address} fa
+00035480: 696c 6564 2074 6f20 6163 7175 6972 6520  iled to acquire 
+00035490: 6b65 7973 3a20 7b72 6573 756c 745b 276b  keys: {result['k
+000354a0: 6579 7327 5d7d 220a 2020 2020 2020 2020  eys']}".        
+000354b0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+000354c0: 7365 3a20 2023 2070 7261 676d 613a 206e  se:  # pragma: n
+000354d0: 6f63 6f76 6572 0a20 2020 2020 2020 2020  ocover.         
+000354e0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000354f0: 726f 7228 6622 556e 6578 7065 6374 6564  ror(f"Unexpected
+00035500: 206d 6573 7361 6765 2066 726f 6d20 7b77   message from {w
+00035510: 6f72 6b65 725f 6164 6472 6573 737d 3a20  orker_address}: 
+00035520: 7b72 6573 756c 747d 2229 0a0a 2020 2020  {result}")..    
+00035530: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
+00035540: 6579 735f 6f6b 3a0a 2020 2020 2020 2020  eys_ok:.        
+00035550: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
+00035560: 6520 3d20 7365 6c66 2e74 6173 6b73 2e67  e = self.tasks.g
+00035570: 6574 286b 6579 2920 2023 2074 7970 653a  et(key)  # type:
+00035580: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+00035590: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
+000355a0: 6520 6f72 2074 732e 7374 6174 6520 213d  e or ts.state !=
+000355b0: 2022 6d65 6d6f 7279 223a 0a20 2020 2020   "memory":.     
+000355c0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000355d0: 722e 7761 726e 696e 6728 6622 4b65 7920  r.warning(f"Key 
+000355e0: 6c6f 7374 2064 7572 696e 6720 7265 706c  lost during repl
+000355f0: 6963 6174 696f 6e3a 207b 6b65 797d 2229  ication: {key}")
+00035600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035610: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+00035620: 2020 2020 2020 6966 2077 7320 6e6f 7420        if ws not 
+00035630: 696e 2074 732e 7768 6f5f 6861 733a 0a20  in ts.who_has:. 
+00035640: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00035650: 656c 662e 6164 645f 7265 706c 6963 6128  elf.add_replica(
+00035660: 7473 2c20 7773 290a 0a20 2020 2020 2020  ts, ws)..       
+00035670: 2072 6574 7572 6e20 6b65 7973 5f66 6169   return keys_fai
+00035680: 6c65 640a 0a20 2020 2061 7379 6e63 2064  led..    async d
+00035690: 6566 2064 656c 6574 655f 776f 726b 6572  ef delete_worker
+000356a0: 5f64 6174 6128 0a20 2020 2020 2020 2073  _data(.        s
+000356b0: 656c 662c 2077 6f72 6b65 725f 6164 6472  elf, worker_addr
+000356c0: 6573 733a 2073 7472 2c20 6b65 7973 3a20  ess: str, keys: 
+000356d0: 2243 6f6c 6c65 6374 696f 6e5b 7374 725d  "Collection[str]
+000356e0: 222c 2073 7469 6d75 6c75 735f 6964 3a20  ", stimulus_id: 
+000356f0: 7374 720a 2020 2020 2920 2d3e 204e 6f6e  str.    ) -> Non
+00035700: 653a 0a20 2020 2020 2020 2022 2222 4465  e:.        """De
+00035710: 6c65 7465 2064 6174 6120 6672 6f6d 2061  lete data from a
+00035720: 2077 6f72 6b65 7220 616e 6420 7570 6461   worker and upda
+00035730: 7465 2074 6865 2063 6f72 7265 7370 6f6e  te the correspon
+00035740: 6469 6e67 2077 6f72 6b65 722f 7461 736b  ding worker/task
+00035750: 2073 7461 7465 730a 0a20 2020 2020 2020   states..       
+00035760: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00035770: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00035780: 2020 2020 2020 2077 6f72 6b65 725f 6164         worker_ad
+00035790: 6472 6573 733a 2073 7472 0a20 2020 2020  dress: str.     
+000357a0: 2020 2020 2020 2057 6f72 6b65 7220 6164         Worker ad
+000357b0: 6472 6573 7320 746f 2064 656c 6574 6520  dress to delete 
+000357c0: 6b65 7973 2066 726f 6d0a 2020 2020 2020  keys from.      
+000357d0: 2020 6b65 7973 3a20 6c69 7374 5b73 7472    keys: list[str
+000357e0: 5d0a 2020 2020 2020 2020 2020 2020 4c69  ].            Li
+000357f0: 7374 206f 6620 6b65 7973 2074 6f20 6465  st of keys to de
+00035800: 6c65 7465 206f 6e20 7468 6520 7370 6563  lete on the spec
+00035810: 6966 6965 6420 776f 726b 6572 0a20 2020  ified worker.   
+00035820: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00035830: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00035840: 2020 6177 6169 7420 7265 7472 795f 6f70    await retry_op
+00035850: 6572 6174 696f 6e28 0a20 2020 2020 2020  eration(.       
+00035860: 2020 2020 2020 2020 2073 656c 662e 7270           self.rp
+00035870: 6328 6164 6472 3d77 6f72 6b65 725f 6164  c(addr=worker_ad
+00035880: 6472 6573 7329 2e66 7265 655f 6b65 7973  dress).free_keys
+00035890: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000358a0: 2020 6b65 7973 3d6c 6973 7428 6b65 7973    keys=list(keys
+000358b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000358c0: 2020 2073 7469 6d75 6c75 735f 6964 3d66     stimulus_id=f
+000358d0: 2264 656c 6574 652d 6461 7461 2d7b 7469  "delete-data-{ti
+000358e0: 6d65 2829 7d22 2c0a 2020 2020 2020 2020  me()}",.        
+000358f0: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
+00035900: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
+00035910: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+00035920: 2054 6869 7320 6361 6e20 6861 7070 656e   This can happen
+00035930: 2065 2e67 2e20 6966 2074 6865 2077 6f72   e.g. if the wor
+00035940: 6b65 7220 6973 2067 6f69 6e67 2074 6872  ker is going thr
+00035950: 6f75 6768 2063 6f6e 7472 6f6c 6c65 6420  ough controlled 
+00035960: 7368 7574 646f 776e 3b0a 2020 2020 2020  shutdown;.      
+00035970: 2020 2020 2020 2320 6974 2064 6f65 736e        # it doesn
+00035980: 2774 206e 6563 6573 7361 7269 6c79 206d  't necessarily m
+00035990: 6561 6e20 7468 6174 2069 7420 7765 6e74  ean that it went
+000359a0: 2075 6e65 7870 6563 7465 646c 7920 6d69   unexpectedly mi
+000359b0: 7373 696e 670a 2020 2020 2020 2020 2020  ssing.          
+000359c0: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+000359d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000359e0: 2020 6622 436f 6d6d 756e 6963 6174 696f    f"Communicatio
+000359f0: 6e20 7769 7468 2077 6f72 6b65 7220 7b77  n with worker {w
+00035a00: 6f72 6b65 725f 6164 6472 6573 737d 2066  orker_address} f
+00035a10: 6169 6c65 6420 6475 7269 6e67 2022 0a20  ailed during ". 
+00035a20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00035a30: 2272 6570 6c69 6361 7469 6f6e 3a20 7b65  "replication: {e
+00035a40: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
+00035a50: 655f 5f7d 3a20 7b65 7d22 0a20 2020 2020  e__}: {e}".     
+00035a60: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00035a70: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00035a80: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
+00035a90: 6f72 6b65 7273 2e67 6574 2877 6f72 6b65  orkers.get(worke
+00035aa0: 725f 6164 6472 6573 7329 0a20 2020 2020  r_address).     
+00035ab0: 2020 2069 6620 6e6f 7420 7773 3a0a 2020     if not ws:.  
+00035ac0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00035ad0: 0a0a 2020 2020 2020 2020 666f 7220 6b65  ..        for ke
+00035ae0: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
+00035af0: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
+00035b00: 7461 7465 203d 2073 656c 662e 7461 736b  tate = self.task
+00035b10: 732e 6765 7428 6b65 7929 2020 2320 7479  s.get(key)  # ty
+00035b20: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+00035b30: 2020 2020 2020 2069 6620 7473 2069 7320         if ts is 
+00035b40: 6e6f 7420 4e6f 6e65 2061 6e64 2077 7320  not None and ws 
+00035b50: 696e 2074 732e 7768 6f5f 6861 733a 0a20  in ts.who_has:. 
+00035b60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00035b70: 7373 6572 7420 7473 2e73 7461 7465 203d  ssert ts.state =
+00035b80: 3d20 226d 656d 6f72 7922 0a20 2020 2020  = "memory".     
+00035b90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00035ba0: 7265 6d6f 7665 5f72 6570 6c69 6361 2874  remove_replica(t
+00035bb0: 732c 2077 7329 0a20 2020 2020 2020 2020  s, ws).         
+00035bc0: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
+00035bd0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+00035be0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00035bf0: 4c61 7374 2063 6f70 7920 6465 6c65 7465  Last copy delete
+00035c00: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00035c10: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+00035c20: 6974 696f 6e73 287b 6b65 793a 2022 7265  itions({key: "re
+00035c30: 6c65 6173 6564 227d 2c20 7374 696d 756c  leased"}, stimul
+00035c40: 7573 5f69 6429 0a0a 2020 2020 2020 2020  us_id)..        
+00035c50: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2877  self.log_event(w
+00035c60: 732e 6164 6472 6573 732c 207b 2261 6374  s.address, {"act
+00035c70: 696f 6e22 3a20 2272 656d 6f76 652d 776f  ion": "remove-wo
+00035c80: 726b 6572 2d64 6174 6122 2c20 226b 6579  rker-data", "key
+00035c90: 7322 3a20 6b65 7973 7d29 0a0a 2020 2020  s": keys})..    
+00035ca0: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+00035cb0: 6173 796e 6320 6465 6620 7265 6261 6c61  async def rebala
+00035cc0: 6e63 6528 0a20 2020 2020 2020 2073 656c  nce(.        sel
+00035cd0: 662c 0a20 2020 2020 2020 206b 6579 733a  f,.        keys:
+00035ce0: 2049 7465 7261 626c 655b 7374 725d 207c   Iterable[str] |
+00035cf0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00035d00: 2020 2020 2020 776f 726b 6572 733a 2049        workers: I
+00035d10: 7465 7261 626c 655b 7374 725d 207c 204e  terable[str] | N
+00035d20: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00035d30: 2020 2020 7374 696d 756c 7573 5f69 643a      stimulus_id:
+00035d40: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00035d50: 6e65 2c0a 2020 2020 2920 2d3e 2064 6963  ne,.    ) -> dic
+00035d60: 743a 0a20 2020 2020 2020 2022 2222 5265  t:.        """Re
+00035d70: 6261 6c61 6e63 6520 6b65 7973 2073 6f20  balance keys so 
+00035d80: 7468 6174 2065 6163 6820 776f 726b 6572  that each worker
+00035d90: 2065 6e64 7320 7570 2077 6974 6820 726f   ends up with ro
+00035da0: 7567 686c 7920 7468 6520 7361 6d65 2070  ughly the same p
+00035db0: 726f 6365 7373 0a20 2020 2020 2020 206d  rocess.        m
+00035dc0: 656d 6f72 7920 286d 616e 6167 6564 2b75  emory (managed+u
+00035dd0: 6e6d 616e 6167 6564 292e 0a0a 2020 2020  nmanaged)...    
+00035de0: 2020 2020 2e2e 2077 6172 6e69 6e67 3a3a      .. warning::
+00035df0: 0a20 2020 2020 2020 2020 2020 5468 6973  .           This
+00035e00: 206f 7065 7261 7469 6f6e 2069 7320 6765   operation is ge
+00035e10: 6e65 7261 6c6c 7920 6e6f 7420 7765 6c6c  nerally not well
+00035e20: 2074 6573 7465 6420 6167 6169 6e73 7420   tested against 
+00035e30: 6e6f 726d 616c 206f 7065 7261 7469 6f6e  normal operation
+00035e40: 206f 6620 7468 650a 2020 2020 2020 2020   of the.        
+00035e50: 2020 2073 6368 6564 756c 6572 2e20 4974     scheduler. It
+00035e60: 2069 7320 6e6f 7420 7265 636f 6d6d 656e   is not recommen
+00035e70: 6465 6420 746f 2075 7365 2069 7420 7768  ded to use it wh
+00035e80: 696c 6520 7761 6974 696e 6720 6f6e 2063  ile waiting on c
+00035e90: 6f6d 7075 7461 7469 6f6e 732e 0a0a 2020  omputations...  
+00035ea0: 2020 2020 2020 2a2a 416c 676f 7269 7468        **Algorith
+00035eb0: 6d2a 2a0a 0a20 2020 2020 2020 2023 2e20  m**..        #. 
+00035ec0: 4669 6e64 2074 6865 206d 6561 6e20 6f63  Find the mean oc
+00035ed0: 6375 7061 6e63 7920 6f66 2074 6865 2063  cupancy of the c
+00035ee0: 6c75 7374 6572 2c20 6465 6669 6e65 6420  luster, defined 
+00035ef0: 6173 2064 6174 6120 6d61 6e61 6765 6420  as data managed 
+00035f00: 6279 2064 6173 6b20 2b0a 2020 2020 2020  by dask +.      
+00035f10: 2020 2020 2075 6e6d 616e 6167 6564 2070       unmanaged p
+00035f20: 726f 6365 7373 206d 656d 6f72 7920 7468  rocess memory th
+00035f30: 6174 2068 6173 2062 6565 6e20 7468 6572  at has been ther
+00035f40: 6520 666f 7220 6174 206c 6561 7374 2033  e for at least 3
+00035f50: 3020 7365 636f 6e64 730a 2020 2020 2020  0 seconds.      
+00035f60: 2020 2020 2028 6060 6469 7374 7269 6275       (``distribu
+00035f70: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+00035f80: 792e 7265 6365 6e74 2d74 6f2d 6f6c 642d  y.recent-to-old-
+00035f90: 7469 6d65 6060 292e 0a20 2020 2020 2020  time``)..       
+00035fa0: 2020 2020 5468 6973 206c 6574 7320 7573      This lets us
+00035fb0: 2069 676e 6f72 6520 7465 6d70 6f72 6172   ignore temporar
+00035fc0: 7920 7370 696b 6573 2063 6175 7365 6420  y spikes caused 
+00035fd0: 6279 2074 6173 6b20 6865 6170 2075 7361  by task heap usa
+00035fe0: 6765 2e0a 0a20 2020 2020 2020 2020 2020  ge...           
+00035ff0: 416c 7465 726e 6174 6976 656c 792c 2079  Alternatively, y
+00036000: 6f75 206d 6179 2063 6861 6e67 6520 686f  ou may change ho
+00036010: 7720 6d65 6d6f 7279 2069 7320 6d65 6173  w memory is meas
+00036020: 7572 6564 2062 6f74 6820 666f 7220 7468  ured both for th
+00036030: 6520 696e 6469 7669 6475 616c 0a20 2020  e individual.   
+00036040: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+00036050: 6173 2077 656c 6c20 6173 2074 6f20 6361  as well as to ca
+00036060: 6c63 756c 6174 6520 7468 6520 6d65 616e  lculate the mean
+00036070: 2074 6872 6f75 6768 0a20 2020 2020 2020   through.       
+00036080: 2020 2020 6060 6469 7374 7269 6275 7465      ``distribute
+00036090: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
+000360a0: 7265 6261 6c61 6e63 652e 6d65 6173 7572  rebalance.measur
+000360b0: 6560 602e 204e 616d 656c 792c 2074 6869  e``. Namely, thi
+000360c0: 7320 6361 6e20 6265 2075 7365 6675 6c0a  s can be useful.
+000360d0: 2020 2020 2020 2020 2020 2074 6f20 6469             to di
+000360e0: 7372 6567 6172 6420 696e 6163 6375 7261  sregard inaccura
+000360f0: 7465 204f 5320 6d65 6d6f 7279 206d 6561  te OS memory mea
+00036100: 7375 7265 6d65 6e74 732e 0a0a 2020 2020  surements...    
+00036110: 2020 2020 232e 2044 6973 6361 7264 2077      #. Discard w
+00036120: 6f72 6b65 7273 2077 686f 7365 206f 6363  orkers whose occ
+00036130: 7570 616e 6379 2069 7320 7769 7468 696e  upancy is within
+00036140: 2035 2520 6f66 2074 6865 206d 6561 6e20   5% of the mean 
+00036150: 636c 7573 7465 7220 6f63 6375 7061 6e63  cluster occupanc
+00036160: 790a 2020 2020 2020 2020 2020 2028 6060  y.           (``
+00036170: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+00036180: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
+00036190: 6e63 652e 7365 6e64 6572 2d72 6563 6970  nce.sender-recip
+000361a0: 6965 6e74 2d67 6170 6060 202f 2032 292e  ient-gap`` / 2).
+000361b0: 0a20 2020 2020 2020 2020 2020 5468 6973  .           This
+000361c0: 2068 656c 7073 2061 766f 6964 2064 6174   helps avoid dat
+000361d0: 6120 6672 6f6d 2062 6f75 6e63 696e 6720  a from bouncing 
+000361e0: 6172 6f75 6e64 2074 6865 2063 6c75 7374  around the clust
+000361f0: 6572 2072 6570 6561 7465 646c 792e 0a20  er repeatedly.. 
+00036200: 2020 2020 2020 2023 2e20 576f 726b 6572         #. Worker
+00036210: 7320 6162 6f76 6520 7468 6520 6d65 616e  s above the mean
+00036220: 2061 7265 2073 656e 6465 7273 3b20 7468   are senders; th
+00036230: 6f73 6520 6265 6c6f 7720 6172 6520 7265  ose below are re
+00036240: 6369 7069 656e 7473 2e0a 2020 2020 2020  cipients..      
+00036250: 2020 232e 2044 6973 6361 7264 2073 656e    #. Discard sen
+00036260: 6465 7273 2077 686f 7365 2061 6273 6f6c  ders whose absol
+00036270: 7574 6520 6f63 6375 7061 6e63 7920 6973  ute occupancy is
+00036280: 2062 656c 6f77 2033 3025 0a20 2020 2020   below 30%.     
+00036290: 2020 2020 2020 2860 6064 6973 7472 6962        (``distrib
+000362a0: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
+000362b0: 7279 2e72 6562 616c 616e 6365 2e73 656e  ry.rebalance.sen
+000362c0: 6465 722d 6d69 6e60 6029 2e20 496e 206f  der-min``). In o
+000362d0: 7468 6572 2077 6f72 6473 2c20 6e6f 2064  ther words, no d
+000362e0: 6174 610a 2020 2020 2020 2020 2020 2069  ata.           i
+000362f0: 7320 6d6f 7665 6420 7265 6761 7264 6c65  s moved regardle
+00036300: 7373 206f 6620 696d 6261 6c61 6e63 696e  ss of imbalancin
+00036310: 6720 6173 206c 6f6e 6720 6173 2061 6c6c  g as long as all
+00036320: 2077 6f72 6b65 7273 2061 7265 2062 656c   workers are bel
+00036330: 6f77 2033 3025 2e0a 2020 2020 2020 2020  ow 30%..        
+00036340: 232e 2044 6973 6361 7264 2072 6563 6970  #. Discard recip
+00036350: 6965 6e74 7320 7768 6f73 6520 6162 736f  ients whose abso
+00036360: 6c75 7465 206f 6363 7570 616e 6379 2069  lute occupancy i
+00036370: 7320 6162 6f76 6520 3630 250a 2020 2020  s above 60%.    
+00036380: 2020 2020 2020 2028 6060 6469 7374 7269         (``distri
+00036390: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+000363a0: 6f72 792e 7265 6261 6c61 6e63 652e 7265  ory.rebalance.re
+000363b0: 6369 7069 656e 742d 6d61 7860 6029 2e0a  cipient-max``)..
+000363c0: 2020 2020 2020 2020 2020 204e 6f74 6520             Note 
+000363d0: 7468 6174 2074 6869 7320 7468 7265 7368  that this thresh
+000363e0: 6f6c 6420 6279 2064 6566 6175 6c74 2069  old by default i
+000363f0: 7320 7468 6520 7361 6d65 2061 730a 2020  s the same as.  
+00036400: 2020 2020 2020 2020 2060 6064 6973 7472           ``distr
+00036410: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+00036420: 6d6f 7279 2e74 6172 6765 7460 6020 746f  mory.target`` to
+00036430: 2070 7265 7665 6e74 2077 6f72 6b65 7273   prevent workers
+00036440: 2066 726f 6d20 6163 6365 7074 696e 6720   from accepting 
+00036450: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+00036460: 616e 6420 696d 6d65 6469 6174 656c 7920  and immediately 
+00036470: 7370 696c 6c69 6e67 2069 7420 6f75 7420  spilling it out 
+00036480: 746f 2064 6973 6b2e 0a20 2020 2020 2020  to disk..       
+00036490: 2023 2e20 4974 6572 6174 6976 656c 7920   #. Iteratively 
+000364a0: 7069 636b 2074 6865 2073 656e 6465 7220  pick the sender 
+000364b0: 616e 6420 7265 6369 7069 656e 7420 7468  and recipient th
+000364c0: 6174 2061 7265 2066 6172 7468 6573 7420  at are farthest 
+000364d0: 6672 6f6d 2074 6865 206d 6561 6e20 616e  from the mean an
+000364e0: 640a 2020 2020 2020 2020 2020 206d 6f76  d.           mov
+000364f0: 6520 7468 6520 2a6c 6561 7374 2072 6563  e the *least rec
+00036500: 656e 746c 7920 696e 7365 7274 6564 2a20  ently inserted* 
+00036510: 6b65 7920 6265 7477 6565 6e20 7468 6520  key between the 
+00036520: 7477 6f2c 2075 6e74 696c 2065 6974 6865  two, until eithe
+00036530: 7220 616c 6c0a 2020 2020 2020 2020 2020  r all.          
+00036540: 2073 656e 6465 7273 206f 7220 616c 6c20   senders or all 
+00036550: 7265 6369 7069 656e 7473 2066 616c 6c20  recipients fall 
+00036560: 7769 7468 696e 2035 2520 6f66 2074 6865  within 5% of the
+00036570: 206d 6561 6e2e 0a0a 2020 2020 2020 2020   mean...        
+00036580: 2020 2041 2072 6563 6970 6965 6e74 2077     A recipient w
+00036590: 696c 6c20 6265 2073 6b69 7070 6564 2069  ill be skipped i
+000365a0: 6620 6974 2061 6c72 6561 6479 2068 6173  f it already has
+000365b0: 2061 2063 6f70 7920 6f66 2074 6865 2064   a copy of the d
+000365c0: 6174 612e 2049 6e20 6f74 6865 720a 2020  ata. In other.  
+000365d0: 2020 2020 2020 2020 2077 6f72 6473 2c20           words, 
+000365e0: 7468 6973 206d 6574 686f 6420 646f 6573  this method does
+000365f0: 206e 6f74 2064 6567 7261 6465 2072 6570   not degrade rep
+00036600: 6c69 6361 7469 6f6e 2e0a 2020 2020 2020  lication..      
+00036610: 2020 2020 2041 206b 6579 2077 696c 6c20       A key will 
+00036620: 6265 2073 6b69 7070 6564 2069 6620 7468  be skipped if th
+00036630: 6572 6520 6172 6520 6e6f 2072 6563 6970  ere are no recip
+00036640: 6965 6e74 7320 6176 6169 6c61 626c 6520  ients available 
+00036650: 7769 7468 2065 6e6f 7567 6820 6d65 6d6f  with enough memo
+00036660: 7279 0a20 2020 2020 2020 2020 2020 746f  ry.           to
+00036670: 2061 6363 6570 7420 7468 6520 6b65 7920   accept the key 
+00036680: 616e 6420 7468 6174 2064 6f6e 2774 2061  and that don't a
+00036690: 6c72 6561 6479 2068 6f6c 6420 6120 636f  lready hold a co
+000366a0: 7079 2e0a 0a20 2020 2020 2020 2054 6865  py...        The
+000366b0: 206c 6561 7374 2072 6563 656e 746c 7920   least recently 
+000366c0: 696e 7365 7274 6420 284c 5249 2920 706f  insertd (LRI) po
+000366d0: 6c69 6379 2069 7320 6120 6772 6565 6479  licy is a greedy
+000366e0: 2063 686f 6963 6520 7769 7468 2074 6865   choice with the
+000366f0: 2061 6476 616e 7461 6765 206f 660a 2020   advantage of.  
+00036700: 2020 2020 2020 6265 696e 6720 4f28 3129        being O(1)
+00036710: 2c20 7472 6976 6961 6c20 746f 2069 6d70  , trivial to imp
+00036720: 6c65 6d65 6e74 2028 6974 2072 656c 6965  lement (it relie
+00036730: 7320 6f6e 2070 7974 686f 6e20 6469 6374  s on python dict
+00036740: 2069 6e73 6572 7469 6f6e 2d73 6f72 7469   insertion-sorti
+00036750: 6e67 290a 2020 2020 2020 2020 616e 6420  ng).        and 
+00036760: 686f 7065 6675 6c6c 7920 676f 6f64 2065  hopefully good e
+00036770: 6e6f 7567 6820 696e 206d 6f73 7420 6361  nough in most ca
+00036780: 7365 732e 2044 6973 6361 7264 6564 2061  ses. Discarded a
+00036790: 6c74 6572 6e61 7469 7665 2070 6f6c 6963  lternative polic
+000367a0: 6965 7320 7765 7265 3a0a 0a20 2020 2020  ies were:..     
+000367b0: 2020 202d 204c 6172 6765 7374 2066 6972     - Largest fir
+000367c0: 7374 2e20 4f28 6e2a 6c6f 6728 6e29 2920  st. O(n*log(n)) 
+000367d0: 7361 7665 2066 6f72 206e 6f6e 2d74 7269  save for non-tri
+000367e0: 7669 616c 2061 6464 6974 696f 6e61 6c20  vial additional 
+000367f0: 6461 7461 2073 7472 7563 7475 7265 7320  data structures 
+00036800: 616e 640a 2020 2020 2020 2020 2020 7269  and.          ri
+00036810: 736b 7320 6361 7573 696e 6720 7468 6520  sks causing the 
+00036820: 6c61 7267 6573 7420 6368 756e 6b73 206f  largest chunks o
+00036830: 6620 6461 7461 2074 6f20 7265 7065 6174  f data to repeat
+00036840: 6564 6c79 206d 6f76 6520 6172 6f75 6e64  edly move around
+00036850: 2074 6865 0a20 2020 2020 2020 2020 2063   the.          c
+00036860: 6c75 7374 6572 206c 696b 6520 7069 6e62  luster like pinb
+00036870: 616c 6c73 2e0a 2020 2020 2020 2020 2d20  alls..        - 
+00036880: 4c65 6173 7420 7265 6365 6e74 6c79 2075  Least recently u
+00036890: 7365 6420 284c 5255 292e 2054 6869 7320  sed (LRU). This 
+000368a0: 696e 666f 726d 6174 696f 6e20 6973 2063  information is c
+000368b0: 7572 7265 6e74 6c79 2061 7661 696c 6162  urrently availab
+000368c0: 6c65 206f 6e20 7468 650a 2020 2020 2020  le on the.      
+000368d0: 2020 2020 776f 726b 6572 7320 6f6e 6c79      workers only
+000368e0: 2061 6e64 206e 6f74 2074 7269 7669 616c   and not trivial
+000368f0: 2074 6f20 7265 706c 6963 6174 6520 6f6e   to replicate on
+00036900: 2074 6865 2073 6368 6564 756c 6572 3b20   the scheduler; 
+00036910: 7472 616e 736d 6974 7469 6e67 2069 740a  transmitting it.
+00036920: 2020 2020 2020 2020 2020 6f76 6572 2074            over t
+00036930: 6865 206e 6574 776f 726b 2077 6f75 6c64  he network would
+00036940: 2062 6520 7665 7279 2065 7870 656e 7369   be very expensi
+00036950: 7665 2e20 416c 736f 2c20 6e6f 7465 2074  ve. Also, note t
+00036960: 6861 7420 6461 736b 2077 696c 6c20 676f  hat dask will go
+00036970: 206f 7574 206f 660a 2020 2020 2020 2020   out of.        
+00036980: 2020 6974 7320 7761 7920 746f 206d 696e    its way to min
+00036990: 696d 6973 6520 7468 6520 616d 6f75 6e74  imise the amount
+000369a0: 206f 6620 7469 6d65 2069 6e74 6572 6d65   of time interme
+000369b0: 6469 6174 6520 6b65 7973 2061 7265 2068  diate keys are h
+000369c0: 656c 6420 696e 206d 656d 6f72 792c 0a20  eld in memory,. 
+000369d0: 2020 2020 2020 2020 2073 6f20 696e 2073           so in s
+000369e0: 7563 6820 6120 6361 7365 204c 5249 2069  uch a case LRI i
+000369f0: 7320 6120 636c 6f73 6520 6170 7072 6f78  s a close approx
+00036a00: 696d 6174 696f 6e20 6f66 204c 5255 2e0a  imation of LRU..
+00036a10: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+00036a20: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+00036a30: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206b  ------.        k
+00036a40: 6579 733a 206f 7074 696f 6e61 6c0a 2020  eys: optional.  
+00036a50: 2020 2020 2020 2020 2020 616c 6c6f 776c            allowl
+00036a60: 6973 7420 6f66 2064 6173 6b20 6b65 7973  ist of dask keys
+00036a70: 2074 6861 7420 7368 6f75 6c64 2062 6520   that should be 
+00036a80: 636f 6e73 6964 6572 6564 2066 6f72 206d  considered for m
+00036a90: 6f76 696e 672e 2041 6c6c 206f 7468 6572  oving. All other
+00036aa0: 206b 6579 730a 2020 2020 2020 2020 2020   keys.          
+00036ab0: 2020 7769 6c6c 2062 6520 6967 6e6f 7265    will be ignore
+00036ac0: 642e 204e 6f74 6520 7468 6174 2074 6869  d. Note that thi
+00036ad0: 7320 6f66 6665 7273 206e 6f20 6775 6172  s offers no guar
+00036ae0: 616e 7465 6520 7468 6174 2061 206b 6579  antee that a key
+00036af0: 2077 696c 6c20 6163 7475 616c 6c79 0a20   will actually. 
+00036b00: 2020 2020 2020 2020 2020 2062 6520 6d6f             be mo
+00036b10: 7665 6420 2865 2e67 2e20 6265 6361 7573  ved (e.g. becaus
+00036b20: 6520 6974 2069 7320 756e 6e65 6365 7373  e it is unnecess
+00036b30: 6172 7920 6f72 2062 6563 6175 7365 2074  ary or because t
+00036b40: 6865 7265 2061 7265 206e 6f20 7669 6162  here are no viab
+00036b50: 6c65 0a20 2020 2020 2020 2020 2020 2072  le.            r
+00036b60: 6563 6970 6965 6e74 2077 6f72 6b65 7273  ecipient workers
+00036b70: 2066 6f72 2069 7429 2e0a 2020 2020 2020   for it)..      
+00036b80: 2020 776f 726b 6572 733a 206f 7074 696f    workers: optio
+00036b90: 6e61 6c0a 2020 2020 2020 2020 2020 2020  nal.            
+00036ba0: 616c 6c6f 776c 6973 7420 6f66 2077 6f72  allowlist of wor
+00036bb0: 6b65 7273 2061 6464 7265 7373 6573 2074  kers addresses t
+00036bc0: 6f20 6265 2063 6f6e 7369 6465 7265 6420  o be considered 
+00036bd0: 6173 2073 656e 6465 7273 206f 7220 7265  as senders or re
+00036be0: 6369 7069 656e 7473 2e0a 2020 2020 2020  cipients..      
+00036bf0: 2020 2020 2020 416c 6c20 6f74 6865 7220        All other 
+00036c00: 776f 726b 6572 7320 7769 6c6c 2062 6520  workers will be 
+00036c10: 6967 6e6f 7265 642e 2054 6865 206d 6561  ignored. The mea
+00036c20: 6e20 636c 7573 7465 7220 6f63 6375 7061  n cluster occupa
+00036c30: 6e63 7920 7769 6c6c 2062 650a 2020 2020  ncy will be.    
+00036c40: 2020 2020 2020 2020 6361 6c63 756c 6174          calculat
+00036c50: 6564 206f 6e6c 7920 7573 696e 6720 7468  ed only using th
+00036c60: 6520 616c 6c6f 7765 6420 776f 726b 6572  e allowed worker
+00036c70: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+00036c80: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+00036c90: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
+00036ca0: 206f 7220 6622 7265 6261 6c61 6e63 652d   or f"rebalance-
+00036cb0: 7b74 696d 6528 297d 220a 0a20 2020 2020  {time()}"..     
+00036cc0: 2020 2077 7373 3a20 436f 6c6c 6563 7469     wss: Collecti
+00036cd0: 6f6e 5b57 6f72 6b65 7253 7461 7465 5d0a  on[WorkerState].
+00036ce0: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
+00036cf0: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
+00036d00: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
+00036d10: 3d20 5b73 656c 662e 776f 726b 6572 735b  = [self.workers[
+00036d20: 775d 2066 6f72 2077 2069 6e20 776f 726b  w] for w in work
+00036d30: 6572 735d 0a20 2020 2020 2020 2065 6c73  ers].        els
+00036d40: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00036d50: 7373 203d 2073 656c 662e 776f 726b 6572  ss = self.worker
+00036d60: 732e 7661 6c75 6573 2829 0a20 2020 2020  s.values().     
+00036d70: 2020 2069 6620 6e6f 7420 7773 733a 0a20     if not wss:. 
+00036d80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00036d90: 6e20 7b22 7374 6174 7573 223a 2022 4f4b  n {"status": "OK
+00036da0: 227d 0a0a 2020 2020 2020 2020 6966 206b  "}..        if k
+00036db0: 6579 7320 6973 206e 6f74 204e 6f6e 653a  eys is not None:
+00036dc0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00036dd0: 6e6f 7420 6973 696e 7374 616e 6365 286b  not isinstance(k
+00036de0: 6579 732c 2053 6574 293a 0a20 2020 2020  eys, Set):.     
+00036df0: 2020 2020 2020 2020 2020 206b 6579 7320             keys 
+00036e00: 3d20 7365 7428 6b65 7973 2920 2023 2075  = set(keys)  # u
+00036e10: 6e6c 6573 7320 616c 7265 6164 7920 6120  nless already a 
+00036e20: 7365 742d 6c69 6b65 0a20 2020 2020 2020  set-like.       
+00036e30: 2020 2020 2069 6620 6e6f 7420 6b65 7973       if not keys
+00036e40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00036e50: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
+00036e60: 7322 3a20 224f 4b22 7d0a 2020 2020 2020  s": "OK"}.      
+00036e70: 2020 2020 2020 6d69 7373 696e 675f 6461        missing_da
+00036e80: 7461 203d 205b 0a20 2020 2020 2020 2020  ta = [.         
+00036e90: 2020 2020 2020 206b 2066 6f72 206b 2069         k for k i
+00036ea0: 6e20 6b65 7973 2069 6620 6b20 6e6f 7420  n keys if k not 
+00036eb0: 696e 2073 656c 662e 7461 736b 7320 6f72  in self.tasks or
+00036ec0: 206e 6f74 2073 656c 662e 7461 736b 735b   not self.tasks[
+00036ed0: 6b5d 2e77 686f 5f68 6173 0a20 2020 2020  k].who_has.     
+00036ee0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00036ef0: 2020 2020 2069 6620 6d69 7373 696e 675f       if missing_
+00036f00: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
+00036f10: 2020 2020 2020 7265 7475 726e 207b 2273        return {"s
+00036f20: 7461 7475 7322 3a20 2270 6172 7469 616c  tatus": "partial
+00036f30: 2d66 6169 6c22 2c20 226b 6579 7322 3a20  -fail", "keys": 
+00036f40: 6d69 7373 696e 675f 6461 7461 7d0a 0a20  missing_data}.. 
+00036f50: 2020 2020 2020 206d 7367 7320 3d20 7365         msgs = se
+00036f60: 6c66 2e5f 7265 6261 6c61 6e63 655f 6669  lf._rebalance_fi
+00036f70: 6e64 5f6d 7367 7328 6b65 7973 2c20 7773  nd_msgs(keys, ws
+00036f80: 7329 0a20 2020 2020 2020 2069 6620 6e6f  s).        if no
+00036f90: 7420 6d73 6773 3a0a 2020 2020 2020 2020  t msgs:.        
+00036fa0: 2020 2020 7265 7475 726e 207b 2273 7461      return {"sta
+00036fb0: 7475 7322 3a20 224f 4b22 7d0a 0a20 2020  tus": "OK"}..   
+00036fc0: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
+00036fd0: 7365 6c66 2e5f 6c6f 636b 3a0a 2020 2020  self._lock:.    
+00036fe0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00036ff0: 2061 7761 6974 2073 656c 662e 5f72 6562   await self._reb
+00037000: 616c 616e 6365 5f6d 6f76 655f 6461 7461  alance_move_data
+00037010: 286d 7367 732c 2073 7469 6d75 6c75 735f  (msgs, stimulus_
+00037020: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
+00037030: 6966 2072 6573 756c 745b 2273 7461 7475  if result["statu
+00037040: 7322 5d20 3d3d 2022 7061 7274 6961 6c2d  s"] == "partial-
+00037050: 6661 696c 2220 616e 6420 6b65 7973 2069  fail" and keys i
+00037060: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00037070: 2020 2020 2020 2020 2320 4f6e 6c79 2072          # Only r
+00037080: 6574 7572 6e20 6661 696c 6564 206b 6579  eturn failed key
+00037090: 7320 6966 2074 6865 2063 6c69 656e 7420  s if the client 
+000370a0: 6578 706c 6963 6974 6c79 2061 736b 6564  explicitly asked
+000370b0: 2066 6f72 2074 6865 6d0a 2020 2020 2020   for them.      
+000370c0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+000370d0: 203d 207b 2273 7461 7475 7322 3a20 224f   = {"status": "O
+000370e0: 4b22 7d0a 2020 2020 2020 2020 2020 2020  K"}.            
+000370f0: 7265 7475 726e 2072 6573 756c 740a 0a20  return result.. 
+00037100: 2020 2064 6566 205f 7265 6261 6c61 6e63     def _rebalanc
+00037110: 655f 6669 6e64 5f6d 7367 7328 0a20 2020  e_find_msgs(.   
+00037120: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00037130: 2020 206b 6579 733a 2053 6574 5b48 6173     keys: Set[Has
+00037140: 6861 626c 655d 207c 204e 6f6e 652c 0a20  hable] | None,. 
+00037150: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
+00037160: 4974 6572 6162 6c65 5b57 6f72 6b65 7253  Iterable[WorkerS
+00037170: 7461 7465 5d2c 0a20 2020 2029 202d 3e20  tate],.    ) -> 
+00037180: 6c69 7374 5b74 7570 6c65 5b57 6f72 6b65  list[tuple[Worke
+00037190: 7253 7461 7465 2c20 576f 726b 6572 5374  rState, WorkerSt
+000371a0: 6174 652c 2054 6173 6b53 7461 7465 5d5d  ate, TaskState]]
+000371b0: 3a0a 2020 2020 2020 2020 2222 2249 6465  :.        """Ide
+000371c0: 6e74 6966 7920 776f 726b 6572 7320 7468  ntify workers th
+000371d0: 6174 206e 6565 6420 746f 206c 6f73 6520  at need to lose 
+000371e0: 6b65 7973 2061 6e64 2074 686f 7365 2074  keys and those t
+000371f0: 6861 7420 6361 6e20 7265 6365 6976 6520  hat can receive 
+00037200: 7468 656d 2c0a 2020 2020 2020 2020 746f  them,.        to
+00037210: 6765 7468 6572 2077 6974 6820 686f 7720  gether with how 
+00037220: 6d61 6e79 2062 7974 6573 2065 6163 6820  many bytes each 
+00037230: 6e65 6564 7320 746f 206c 6f73 652f 7265  needs to lose/re
+00037240: 6365 6976 652e 2054 6865 6e2c 2070 6169  ceive. Then, pai
+00037250: 7220 6120 7365 6e64 6572 0a20 2020 2020  r a sender.     
+00037260: 2020 2077 6f72 6b65 7220 7769 7468 2061     worker with a
+00037270: 2072 6563 6970 6965 6e74 2077 6f72 6b65   recipient worke
+00037280: 7220 666f 7220 6561 6368 206b 6579 2c20  r for each key, 
+00037290: 756e 7469 6c20 7468 6520 636c 7573 7465  until the cluste
+000372a0: 7220 6973 2072 6562 616c 616e 6365 642e  r is rebalanced.
+000372b0: 0a0a 2020 2020 2020 2020 5468 6973 206d  ..        This m
+000372c0: 6574 686f 6420 6f6e 6c79 2064 6566 696e  ethod only defin
+000372d0: 6573 2074 6865 2077 6f72 6b20 746f 2062  es the work to b
+000372e0: 6520 7065 7266 6f72 6d65 643b 2069 7420  e performed; it 
+000372f0: 646f 6573 206e 6f74 2073 7461 7274 2061  does not start a
+00037300: 6e79 206e 6574 776f 726b 0a20 2020 2020  ny network.     
+00037310: 2020 2074 7261 6e73 6665 7273 2069 7473     transfers its
+00037320: 656c 662e 0a0a 2020 2020 2020 2020 5468  elf...        Th
+00037330: 6520 6269 672d 4f20 636f 6d70 6c65 7869  e big-O complexi
+00037340: 7479 2069 7320 4f28 7774 202b 206b 652a  ty is O(wt + ke*
+00037350: 6c6f 6728 7765 2929 2c20 7768 6572 650a  log(we)), where.
+00037360: 0a20 2020 2020 2020 202d 2077 7420 6973  .        - wt is
+00037370: 2074 6865 2074 6f74 616c 206e 756d 6265   the total numbe
+00037380: 7220 6f66 2077 6f72 6b65 7273 206f 6e20  r of workers on 
+00037390: 7468 6520 636c 7573 7465 7220 286f 7220  the cluster (or 
+000373a0: 7468 6520 6e75 6d62 6572 206f 6620 616c  the number of al
+000373b0: 6c6f 7765 640a 2020 2020 2020 2020 2020  lowed.          
+000373c0: 776f 726b 6572 732c 2069 6620 6578 706c  workers, if expl
+000373d0: 6963 6974 6c79 2073 7461 7465 6420 6279  icitly stated by
+000373e0: 2074 6865 2075 7365 7229 0a20 2020 2020   the user).     
+000373f0: 2020 202d 2077 6520 6973 2074 6865 206e     - we is the n
+00037400: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
+00037410: 2074 6861 7420 6172 6520 656c 6967 6962   that are eligib
+00037420: 6c65 2074 6f20 6265 2073 656e 6465 7273  le to be senders
+00037430: 206f 7220 7265 6369 7069 656e 7473 0a20   or recipients. 
+00037440: 2020 2020 2020 202d 206b 7420 6973 2074         - kt is t
+00037450: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
+00037460: 6f66 206b 6579 7320 6f6e 2074 6865 2063  of keys on the c
+00037470: 6c75 7374 6572 2028 6f72 206f 6e20 7468  luster (or on th
+00037480: 6520 616c 6c6f 7765 6420 776f 726b 6572  e allowed worker
+00037490: 7329 0a20 2020 2020 2020 202d 206b 6520  s).        - ke 
+000374a0: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
+000374b0: 206b 6579 7320 7468 6174 206e 6565 6420   keys that need 
+000374c0: 746f 2062 6520 6d6f 7665 6420 696e 206f  to be moved in o
+000374d0: 7264 6572 2074 6f20 6163 6869 6576 6520  rder to achieve 
+000374e0: 6120 6261 6c61 6e63 6564 0a20 2020 2020  a balanced.     
+000374f0: 2020 2020 2063 6c75 7374 6572 0a0a 2020       cluster..  
+00037500: 2020 2020 2020 5468 6572 6520 6973 2061        There is a
+00037510: 2064 6567 656e 6572 6174 6520 6564 6765   degenerate edge
+00037520: 2063 6173 6520 4f28 7774 202b 206b 742a   case O(wt + kt*
+00037530: 6c6f 6728 7765 2929 2077 6865 6e20 6b74  log(we)) when kt
+00037540: 2069 7320 6d75 6368 2067 7265 6174 6572   is much greater
+00037550: 2074 6861 6e0a 2020 2020 2020 2020 7468   than.        th
+00037560: 6520 6e75 6d62 6572 206f 6620 616c 6c6f  e number of allo
+00037570: 7765 6420 6b65 7973 2c20 6f72 2077 6865  wed keys, or whe
+00037580: 6e20 6d6f 7374 206b 6579 7320 6172 6520  n most keys are 
+00037590: 7265 706c 6963 6174 6564 206f 7220 6361  replicated or ca
+000375a0: 6e6e 6f74 2062 650a 2020 2020 2020 2020  nnot be.        
+000375b0: 6d6f 7665 6420 666f 7220 736f 6d65 206f  moved for some o
+000375c0: 7468 6572 2072 6561 736f 6e2e 0a0a 2020  ther reason...  
+000375d0: 2020 2020 2020 5265 7475 726e 7320 6c69        Returns li
+000375e0: 7374 206f 6620 7475 706c 6573 2074 6f20  st of tuples to 
+000375f0: 6665 6564 2069 6e74 6f20 5f72 6562 616c  feed into _rebal
+00037600: 616e 6365 5f6d 6f76 655f 6461 7461 3a0a  ance_move_data:.
+00037610: 0a20 2020 2020 2020 202d 2073 656e 6465  .        - sende
+00037620: 7220 776f 726b 6572 0a20 2020 2020 2020  r worker.       
+00037630: 202d 2072 6563 6970 6965 6e74 2077 6f72   - recipient wor
+00037640: 6b65 720a 2020 2020 2020 2020 2d20 7461  ker.        - ta
+00037650: 736b 2074 6f20 6265 2074 7261 6e73 6665  sk to be transfe
+00037660: 7272 6564 0a20 2020 2020 2020 2022 2222  rred.        """
+00037670: 0a20 2020 2020 2020 2023 2048 6561 7073  .        # Heaps
+00037680: 206f 6620 776f 726b 6572 732c 206d 616e   of workers, man
+00037690: 6167 6564 2062 7920 7468 6520 6865 6170  aged by the heap
+000376a0: 7120 6d6f 6475 6c65 2c20 7468 6174 206e  q module, that n
+000376b0: 6565 6420 746f 2073 656e 642f 7265 6365  eed to send/rece
+000376c0: 6976 6520 6461 7461 2c0a 2020 2020 2020  ive data,.      
+000376d0: 2020 2320 7769 7468 2068 6f77 206d 616e    # with how man
+000376e0: 7920 6279 7465 7320 6561 6368 206e 6565  y bytes each nee
+000376f0: 6473 2074 6f20 7365 6e64 2f72 6563 6569  ds to send/recei
+00037700: 7665 2e0a 2020 2020 2020 2020 230a 2020  ve..        #.  
+00037710: 2020 2020 2020 2320 4561 6368 2065 6c65        # Each ele
+00037720: 6d65 6e74 206f 6620 7468 6520 6865 6170  ment of the heap
+00037730: 2069 7320 6120 7475 706c 6520 636f 6e73   is a tuple cons
+00037740: 7472 7563 7465 6420 6173 2066 6f6c 6c6f  tructed as follo
+00037750: 7773 3a0a 2020 2020 2020 2020 2320 2d20  ws:.        # - 
+00037760: 736e 645f 6279 7465 735f 6d61 782f 7265  snd_bytes_max/re
+00037770: 635f 6279 7465 735f 6d61 783a 206d 6178  c_bytes_max: max
+00037780: 696d 756d 206e 756d 6265 7220 6f66 2062  imum number of b
+00037790: 7974 6573 2074 6f20 7365 6e64 206f 7220  ytes to send or 
+000377a0: 7265 6365 6976 652e 0a20 2020 2020 2020  receive..       
+000377b0: 2023 2020 2054 6869 7320 6e75 6d62 6572   #   This number
+000377c0: 2069 7320 6e65 6761 7469 7665 2c20 736f   is negative, so
+000377d0: 2074 6861 7420 7468 6520 776f 726b 6572   that the worker
+000377e0: 7320 6661 7274 6865 7374 2066 726f 6d20  s farthest from 
+000377f0: 7468 6520 636c 7573 7465 7220 6d65 616e  the cluster mean
+00037800: 0a20 2020 2020 2020 2023 2020 2061 7265  .        #   are
+00037810: 2061 7420 7468 6520 746f 7020 6f66 2074   at the top of t
+00037820: 6865 2073 6d61 6c6c 6573 742d 6669 7273  he smallest-firs
+00037830: 7420 6865 6170 732e 0a20 2020 2020 2020  t heaps..       
+00037840: 2023 202d 2073 6e64 5f62 7974 6573 5f6d   # - snd_bytes_m
+00037850: 696e 2f72 6563 5f62 7974 6573 5f6d 696e  in/rec_bytes_min
+00037860: 3a20 6d69 6e69 6d75 6d20 6e75 6d62 6572  : minimum number
+00037870: 206f 6620 6279 7465 7320 6166 7465 7220   of bytes after 
+00037880: 7365 6e64 696e 672f 7265 6365 6976 696e  sending/receivin
+00037890: 670a 2020 2020 2020 2020 2320 2020 7768  g.        #   wh
+000378a0: 6963 6820 7468 6520 776f 726b 6572 2073  ich the worker s
+000378b0: 686f 756c 6420 6e6f 7420 6265 2063 6f6e  hould not be con
+000378c0: 7369 6465 7265 6420 616e 796d 6f72 652e  sidered anymore.
+000378d0: 2054 6869 7320 6973 2061 6c73 6f20 6e65   This is also ne
+000378e0: 6761 7469 7665 2e0a 2020 2020 2020 2020  gative..        
+000378f0: 2320 2d20 6172 6269 7472 6172 7920 756e  # - arbitrary un
+00037900: 6971 7565 206e 756d 6265 722c 2074 6865  ique number, the
+00037910: 7265 206a 7573 7420 746f 2074 6f20 6d61  re just to to ma
+00037920: 6b65 2073 7572 6520 7468 6174 2057 6f72  ke sure that Wor
+00037930: 6b65 7253 7461 7465 206f 626a 6563 7473  kerState objects
+00037940: 0a20 2020 2020 2020 2023 2020 2061 7265  .        #   are
+00037950: 206e 6576 6572 2075 7365 6420 666f 7220   never used for 
+00037960: 736f 7274 696e 6720 696e 2074 6865 2075  sorting in the u
+00037970: 6e6c 696b 656c 7920 6576 656e 7420 7468  nlikely event th
+00037980: 6174 2074 776f 2070 726f 6365 7373 6573  at two processes
+00037990: 2068 6176 650a 2020 2020 2020 2020 2320   have.        # 
+000379a0: 2020 6578 6163 746c 7920 7468 6520 7361    exactly the sa
+000379b0: 6d65 206e 756d 6265 7220 6f66 2062 7974  me number of byt
+000379c0: 6573 2061 6c6c 6f63 6174 6564 2e0a 2020  es allocated..  
+000379d0: 2020 2020 2020 2320 2d20 576f 726b 6572        # - Worker
+000379e0: 5374 6174 650a 2020 2020 2020 2020 2320  State.        # 
+000379f0: 2d20 6974 6572 6174 6f72 206f 6620 616c  - iterator of al
+00037a00: 6c20 7461 736b 7320 696e 206d 656d 6f72  l tasks in memor
+00037a10: 7920 6f6e 2074 6865 2077 6f72 6b65 7220  y on the worker 
+00037a20: 2873 656e 6465 7273 206f 6e6c 7929 2c20  (senders only), 
+00037a30: 696e 7365 7274 696f 6e0a 2020 2020 2020  insertion.      
+00037a40: 2020 2320 2020 736f 7274 6564 2028 6c65    #   sorted (le
+00037a50: 6173 7420 7265 6365 6e74 6c79 2069 6e73  ast recently ins
+00037a60: 6572 7465 6420 6669 7273 7429 2e0a 2020  erted first)..  
+00037a70: 2020 2020 2020 2320 2020 4e6f 7465 2074        #   Note t
+00037a80: 6861 7420 7468 6973 2069 7465 7261 746f  hat this iterato
+00037a90: 7220 7769 6c6c 2074 7970 6963 616c 6c79  r will typically
+00037aa0: 202a 6e6f 742a 2062 6520 6578 6861 7573   *not* be exhaus
+00037ab0: 7465 642e 2049 7420 7769 6c6c 206f 6e6c  ted. It will onl
+00037ac0: 7920 6265 0a20 2020 2020 2020 2023 2020  y be.        #  
+00037ad0: 2065 7868 6175 7374 6564 2069 662c 2061   exhausted if, a
+00037ae0: 6674 6572 206d 6f76 696e 6720 6177 6179  fter moving away
+00037af0: 2066 726f 6d20 7468 6520 776f 726b 6572   from the worker
+00037b00: 2061 6c6c 206b 6579 7320 7468 6174 2063   all keys that c
+00037b10: 616e 2062 6520 6d6f 7665 642c 0a20 2020  an be moved,.   
+00037b20: 2020 2020 2023 2020 2069 7320 696e 7375       #   is insu
+00037b30: 6666 6963 6965 6e74 2074 6f20 6472 6f70  fficient to drop
+00037b40: 2073 6e64 5f62 7974 6573 5f6d 696e 2061   snd_bytes_min a
+00037b50: 626f 7665 2030 2e0a 2020 2020 2020 2020  bove 0..        
+00037b60: 7365 6e64 6572 733a 206c 6973 745b 7475  senders: list[tu
+00037b70: 706c 655b 696e 742c 2069 6e74 2c20 696e  ple[int, int, in
+00037b80: 742c 2057 6f72 6b65 7253 7461 7465 2c20  t, WorkerState, 
+00037b90: 4974 6572 6174 6f72 5b54 6173 6b53 7461  Iterator[TaskSta
+00037ba0: 7465 5d5d 5d20 3d20 5b5d 0a20 2020 2020  te]]] = [].     
+00037bb0: 2020 2072 6563 6970 6965 6e74 733a 206c     recipients: l
+00037bc0: 6973 745b 7475 706c 655b 696e 742c 2069  ist[tuple[int, i
+00037bd0: 6e74 2c20 696e 742c 2057 6f72 6b65 7253  nt, int, WorkerS
+00037be0: 7461 7465 5d5d 203d 205b 5d0a 0a20 2020  tate]] = []..   
+00037bf0: 2020 2020 2023 204f 7574 7075 743a 205b       # Output: [
+00037c00: 2873 656e 6465 722c 2072 6563 6970 6965  (sender, recipie
+00037c10: 6e74 2c20 7461 736b 292c 202e 2e2e 5d0a  nt, task), ...].
+00037c20: 2020 2020 2020 2020 6d73 6773 3a20 6c69          msgs: li
+00037c30: 7374 5b74 7570 6c65 5b57 6f72 6b65 7253  st[tuple[WorkerS
+00037c40: 7461 7465 2c20 576f 726b 6572 5374 6174  tate, WorkerStat
+00037c50: 652c 2054 6173 6b53 7461 7465 5d5d 203d  e, TaskState]] =
+00037c60: 205b 5d0a 0a20 2020 2020 2020 2023 2042   []..        # B
+00037c70: 7920 6465 6661 756c 742c 2074 6869 7320  y default, this 
+00037c80: 6973 2074 6865 206f 7074 696d 6973 7469  is the optimisti
+00037c90: 6320 6d65 6d6f 7279 2c20 6d65 616e 696e  c memory, meanin
+00037ca0: 6720 746f 7461 6c20 7072 6f63 6573 7320  g total process 
+00037cb0: 6d65 6d6f 7279 206d 696e 7573 0a20 2020  memory minus.   
+00037cc0: 2020 2020 2023 2075 6e6d 616e 6167 6564       # unmanaged
+00037cd0: 206d 656d 6f72 7920 7468 6174 2061 7070   memory that app
+00037ce0: 6561 7265 6420 6f76 6572 2074 6865 206c  eared over the l
+00037cf0: 6173 7420 3330 2073 6563 6f6e 6473 0a20  ast 30 seconds. 
+00037d00: 2020 2020 2020 2023 2028 6469 7374 7269         # (distri
+00037d10: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+00037d20: 6f72 792e 7265 6365 6e74 2d74 6f2d 6f6c  ory.recent-to-ol
+00037d30: 642d 7469 6d65 292e 0a20 2020 2020 2020  d-time)..       
+00037d40: 2023 2054 6869 7320 6c65 7473 2075 7320   # This lets us 
+00037d50: 6967 6e6f 7265 2074 656d 706f 7261 7279  ignore temporary
+00037d60: 2073 7069 6b65 7320 6361 7573 6564 2062   spikes caused b
+00037d70: 7920 7461 736b 2068 6561 7020 7573 6167  y task heap usag
+00037d80: 652e 0a20 2020 2020 2020 206d 656d 6f72  e..        memor
+00037d90: 795f 6279 5f77 6f72 6b65 7220 3d20 5b0a  y_by_worker = [.
+00037da0: 2020 2020 2020 2020 2020 2020 2877 732c              (ws,
+00037db0: 2067 6574 6174 7472 2877 732e 6d65 6d6f   getattr(ws.memo
+00037dc0: 7279 2c20 7365 6c66 2e4d 454d 4f52 595f  ry, self.MEMORY_
+00037dd0: 5245 4241 4c41 4e43 455f 4d45 4153 5552  REBALANCE_MEASUR
+00037de0: 4529 2920 666f 7220 7773 2069 6e20 776f  E)) for ws in wo
+00037df0: 726b 6572 730a 2020 2020 2020 2020 5d0a  rkers.        ].
+00037e00: 2020 2020 2020 2020 6d65 616e 5f6d 656d          mean_mem
+00037e10: 6f72 7920 3d20 7375 6d28 6d20 666f 7220  ory = sum(m for 
+00037e20: 5f2c 206d 2069 6e20 6d65 6d6f 7279 5f62  _, m in memory_b
+00037e30: 795f 776f 726b 6572 2920 2f2f 206c 656e  y_worker) // len
+00037e40: 286d 656d 6f72 795f 6279 5f77 6f72 6b65  (memory_by_worke
+00037e50: 7229 0a0a 2020 2020 2020 2020 666f 7220  r)..        for 
+00037e60: 7773 2c20 7773 5f6d 656d 6f72 7920 696e  ws, ws_memory in
+00037e70: 206d 656d 6f72 795f 6279 5f77 6f72 6b65   memory_by_worke
+00037e80: 723a 0a20 2020 2020 2020 2020 2020 2069  r:.            i
+00037e90: 6620 7773 2e6d 656d 6f72 795f 6c69 6d69  f ws.memory_limi
+00037ea0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00037eb0: 2020 2068 616c 665f 6761 7020 3d20 696e     half_gap = in
+00037ec0: 7428 7365 6c66 2e4d 454d 4f52 595f 5245  t(self.MEMORY_RE
+00037ed0: 4241 4c41 4e43 455f 4841 4c46 5f47 4150  BALANCE_HALF_GAP
+00037ee0: 202a 2077 732e 6d65 6d6f 7279 5f6c 696d   * ws.memory_lim
+00037ef0: 6974 290a 2020 2020 2020 2020 2020 2020  it).            
+00037f00: 2020 2020 7365 6e64 6572 5f6d 696e 203d      sender_min =
+00037f10: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
+00037f20: 414c 414e 4345 5f53 454e 4445 525f 4d49  ALANCE_SENDER_MI
+00037f30: 4e20 2a20 7773 2e6d 656d 6f72 795f 6c69  N * ws.memory_li
+00037f40: 6d69 740a 2020 2020 2020 2020 2020 2020  mit.            
+00037f50: 2020 2020 7265 6369 7069 656e 745f 6d61      recipient_ma
+00037f60: 7820 3d20 7365 6c66 2e4d 454d 4f52 595f  x = self.MEMORY_
+00037f70: 5245 4241 4c41 4e43 455f 5245 4349 5049  REBALANCE_RECIPI
+00037f80: 454e 545f 4d41 5820 2a20 7773 2e6d 656d  ENT_MAX * ws.mem
+00037f90: 6f72 795f 6c69 6d69 740a 2020 2020 2020  ory_limit.      
+00037fa0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00037fb0: 2020 2020 2020 2020 2020 2020 6861 6c66              half
+00037fc0: 5f67 6170 203d 2030 0a20 2020 2020 2020  _gap = 0.       
+00037fd0: 2020 2020 2020 2020 2073 656e 6465 725f           sender_
+00037fe0: 6d69 6e20 3d20 302e 300a 2020 2020 2020  min = 0.0.      
+00037ff0: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
+00038000: 656e 745f 6d61 7820 3d20 6d61 7468 2e69  ent_max = math.i
+00038010: 6e66 0a0a 2020 2020 2020 2020 2020 2020  nf..            
+00038020: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
+00038030: 2020 2020 2077 732e 5f68 6173 5f77 6861       ws._has_wha
+00038040: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00038050: 2020 616e 6420 7773 5f6d 656d 6f72 7920    and ws_memory 
+00038060: 3e3d 206d 6561 6e5f 6d65 6d6f 7279 202b  >= mean_memory +
+00038070: 2068 616c 665f 6761 700a 2020 2020 2020   half_gap.      
+00038080: 2020 2020 2020 2020 2020 616e 6420 7773            and ws
+00038090: 5f6d 656d 6f72 7920 3e3d 2073 656e 6465  _memory >= sende
+000380a0: 725f 6d69 6e0a 2020 2020 2020 2020 2020  r_min.          
+000380b0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+000380c0: 2020 2020 2023 2054 6869 7320 6d61 7920       # This may 
+000380d0: 7365 6e64 2074 6865 2077 6f72 6b65 7220  send the worker 
+000380e0: 6265 6c6f 7720 7365 6e64 6572 5f6d 696e  below sender_min
+000380f0: 2028 6279 2064 6573 6967 6e29 0a20 2020   (by design).   
+00038100: 2020 2020 2020 2020 2020 2020 2073 6e64               snd
+00038110: 5f62 7974 6573 5f6d 6178 203d 206d 6561  _bytes_max = mea
+00038120: 6e5f 6d65 6d6f 7279 202d 2077 735f 6d65  n_memory - ws_me
+00038130: 6d6f 7279 2020 2320 6e65 6761 7469 7665  mory  # negative
+00038140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038150: 2073 6e64 5f62 7974 6573 5f6d 696e 203d   snd_bytes_min =
+00038160: 2073 6e64 5f62 7974 6573 5f6d 6178 202b   snd_bytes_max +
+00038170: 2068 616c 665f 6761 7020 2023 206e 6567   half_gap  # neg
+00038180: 6174 6976 650a 2020 2020 2020 2020 2020  ative.          
+00038190: 2020 2020 2020 2320 5365 6520 6465 6669        # See defi
+000381a0: 6e69 7469 6f6e 206f 6620 7365 6e64 6572  nition of sender
+000381b0: 7320 6162 6f76 650a 2020 2020 2020 2020  s above.        
+000381c0: 2020 2020 2020 2020 7365 6e64 6572 732e          senders.
+000381d0: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+000381e0: 2020 2020 2020 2020 2020 2020 2873 6e64              (snd
+000381f0: 5f62 7974 6573 5f6d 6178 2c20 736e 645f  _bytes_max, snd_
+00038200: 6279 7465 735f 6d69 6e2c 2069 6428 7773  bytes_min, id(ws
+00038210: 292c 2077 732c 2069 7465 7228 7773 2e5f  ), ws, iter(ws._
+00038220: 6861 735f 7768 6174 2929 0a20 2020 2020  has_what)).     
+00038230: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00038240: 2020 2020 2020 2020 2065 6c69 6620 7773           elif ws
+00038250: 5f6d 656d 6f72 7920 3c20 6d65 616e 5f6d  _memory < mean_m
+00038260: 656d 6f72 7920 2d20 6861 6c66 5f67 6170  emory - half_gap
+00038270: 2061 6e64 2077 735f 6d65 6d6f 7279 203c   and ws_memory <
+00038280: 2072 6563 6970 6965 6e74 5f6d 6178 3a0a   recipient_max:.
+00038290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000382a0: 2320 5468 6973 206d 6179 2073 656e 6420  # This may send 
+000382b0: 7468 6520 776f 726b 6572 2061 626f 7665  the worker above
+000382c0: 2072 6563 6970 6965 6e74 5f6d 6178 2028   recipient_max (
+000382d0: 6279 2064 6573 6967 6e29 0a20 2020 2020  by design).     
+000382e0: 2020 2020 2020 2020 2020 2072 6563 5f62             rec_b
+000382f0: 7974 6573 5f6d 6178 203d 2077 735f 6d65  ytes_max = ws_me
+00038300: 6d6f 7279 202d 206d 6561 6e5f 6d65 6d6f  mory - mean_memo
+00038310: 7279 2020 2320 6e65 6761 7469 7665 0a20  ry  # negative. 
+00038320: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00038330: 6563 5f62 7974 6573 5f6d 696e 203d 2072  ec_bytes_min = r
+00038340: 6563 5f62 7974 6573 5f6d 6178 202b 2068  ec_bytes_max + h
+00038350: 616c 665f 6761 7020 2023 206e 6567 6174  alf_gap  # negat
+00038360: 6976 650a 2020 2020 2020 2020 2020 2020  ive.            
+00038370: 2020 2020 2320 5365 6520 6465 6669 6e69      # See defini
+00038380: 7469 6f6e 206f 6620 7265 6369 7069 656e  tion of recipien
+00038390: 7473 2061 626f 7665 0a20 2020 2020 2020  ts above.       
+000383a0: 2020 2020 2020 2020 2072 6563 6970 6965           recipie
+000383b0: 6e74 732e 6170 7065 6e64 2828 7265 635f  nts.append((rec_
+000383c0: 6279 7465 735f 6d61 782c 2072 6563 5f62  bytes_max, rec_b
+000383d0: 7974 6573 5f6d 696e 2c20 6964 2877 7329  ytes_min, id(ws)
+000383e0: 2c20 7773 2929 0a0a 2020 2020 2020 2020  , ws))..        
+000383f0: 2320 4661 7374 2065 7869 7420 696e 2063  # Fast exit in c
+00038400: 6173 6520 6e6f 2074 7261 6e73 6665 7273  ase no transfers
+00038410: 2061 7265 206e 6563 6573 7361 7279 206f   are necessary o
+00038420: 7220 706f 7373 6962 6c65 0a20 2020 2020  r possible.     
+00038430: 2020 2069 6620 6e6f 7420 7365 6e64 6572     if not sender
+00038440: 7320 6f72 206e 6f74 2072 6563 6970 6965  s or not recipie
+00038450: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00038460: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+00038470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038480: 2022 616c 6c22 2c0a 2020 2020 2020 2020   "all",.        
+00038490: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000384a0: 2020 2020 2020 2020 2020 2020 2020 2261                "a
+000384b0: 6374 696f 6e22 3a20 2272 6562 616c 616e  ction": "rebalan
+000384c0: 6365 222c 0a20 2020 2020 2020 2020 2020  ce",.           
+000384d0: 2020 2020 2020 2020 2022 7365 6e64 6572           "sender
+000384e0: 7322 3a20 6c65 6e28 7365 6e64 6572 7329  s": len(senders)
+000384f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00038500: 2020 2020 2020 2272 6563 6970 6965 6e74        "recipient
+00038510: 7322 3a20 6c65 6e28 7265 6369 7069 656e  s": len(recipien
+00038520: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00038530: 2020 2020 2020 2020 2022 6d6f 7665 645f           "moved_
+00038540: 6b65 7973 223a 2030 2c0a 2020 2020 2020  keys": 0,.      
+00038550: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00038560: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00038570: 2020 2020 2020 2072 6574 7572 6e20 5b5d         return []
+00038580: 0a0a 2020 2020 2020 2020 6865 6170 712e  ..        heapq.
+00038590: 6865 6170 6966 7928 7365 6e64 6572 7329  heapify(senders)
+000385a0: 0a20 2020 2020 2020 2068 6561 7071 2e68  .        heapq.h
+000385b0: 6561 7069 6679 2872 6563 6970 6965 6e74  eapify(recipient
+000385c0: 7329 0a0a 2020 2020 2020 2020 7768 696c  s)..        whil
+000385d0: 6520 7365 6e64 6572 7320 616e 6420 7265  e senders and re
+000385e0: 6369 7069 656e 7473 3a0a 2020 2020 2020  cipients:.      
+000385f0: 2020 2020 2020 736e 645f 6279 7465 735f        snd_bytes_
+00038600: 6d61 782c 2073 6e64 5f62 7974 6573 5f6d  max, snd_bytes_m
+00038610: 696e 2c20 5f2c 2073 6e64 5f77 732c 2074  in, _, snd_ws, t
+00038620: 735f 6974 6572 203d 2073 656e 6465 7273  s_iter = senders
+00038630: 5b30 5d0a 0a20 2020 2020 2020 2020 2020  [0]..           
+00038640: 2023 2049 7465 7261 7465 2074 6872 6f75   # Iterate throu
+00038650: 6768 2074 6173 6b73 2069 6e20 6d65 6d6f  gh tasks in memo
+00038660: 7279 2c20 6c65 6173 7420 7265 6365 6e74  ry, least recent
+00038670: 6c79 2069 6e73 6572 7465 6420 6669 7273  ly inserted firs
+00038680: 740a 2020 2020 2020 2020 2020 2020 666f  t.            fo
+00038690: 7220 7473 2069 6e20 7473 5f69 7465 723a  r ts in ts_iter:
+000386a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000386b0: 2069 6620 6b65 7973 2069 7320 6e6f 7420   if keys is not 
+000386c0: 4e6f 6e65 2061 6e64 2074 732e 6b65 7920  None and ts.key 
+000386d0: 6e6f 7420 696e 206b 6579 733a 0a20 2020  not in keys:.   
+000386e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000386f0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+00038700: 2020 2020 2020 2020 2020 6e62 7974 6573            nbytes
+00038710: 203d 2074 732e 6e62 7974 6573 0a20 2020   = ts.nbytes.   
+00038720: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00038730: 6e62 7974 6573 202b 2073 6e64 5f62 7974  nbytes + snd_byt
+00038740: 6573 5f6d 6178 203e 2030 3a0a 2020 2020  es_max > 0:.    
+00038750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038760: 2320 4d6f 7669 6e67 2074 6869 7320 7461  # Moving this ta
+00038770: 736b 2077 6f75 6c64 2063 6175 7365 2074  sk would cause t
+00038780: 6865 2073 656e 6465 7220 746f 2067 6f20  he sender to go 
+00038790: 6265 6c6f 7720 6d65 616e 2061 6e64 0a20  below mean and. 
+000387a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000387b0: 2020 2023 2070 6f74 656e 7469 616c 6c79     # potentially
+000387c0: 2072 6973 6b20 6265 636f 6d69 6e67 2061   risk becoming a
+000387d0: 2072 6563 6970 6965 6e74 2c20 7768 6963   recipient, whic
+000387e0: 6820 776f 756c 6420 6361 7573 6520 7461  h would cause ta
+000387f0: 736b 7320 746f 0a20 2020 2020 2020 2020  sks to.         
+00038800: 2020 2020 2020 2020 2020 2023 2062 6f75             # bou
+00038810: 6e63 6520 6172 6f75 6e64 2e20 4d6f 7665  nce around. Move
+00038820: 206f 6e20 746f 2074 6865 206e 6578 7420   on to the next 
+00038830: 7461 736b 206f 6620 7468 6520 7361 6d65  task of the same
+00038840: 2073 656e 6465 722e 0a20 2020 2020 2020   sender..       
+00038850: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00038860: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
+00038870: 2020 2020 2020 2023 2046 696e 6420 7468         # Find th
+00038880: 6520 7265 6369 7069 656e 742c 2066 6172  e recipient, far
+00038890: 7468 6573 7420 6672 6f6d 2074 6865 206d  thest from the m
+000388a0: 6561 6e2c 2077 6869 6368 0a20 2020 2020  ean, which.     
+000388b0: 2020 2020 2020 2020 2020 2023 2031 2e20             # 1. 
+000388c0: 6861 7320 656e 6f75 6768 2061 7661 696c  has enough avail
+000388d0: 6162 6c65 2052 414d 2066 6f72 2074 6869  able RAM for thi
+000388e0: 7320 7461 736b 2c20 616e 640a 2020 2020  s task, and.    
+000388f0: 2020 2020 2020 2020 2020 2020 2320 322e              # 2.
+00038900: 2064 6f65 736e 2774 2068 6f6c 6420 6120   doesn't hold a 
+00038910: 636f 7079 206f 6620 7468 6973 2074 6173  copy of this tas
+00038920: 6b20 616c 7265 6164 790a 2020 2020 2020  k already.      
+00038930: 2020 2020 2020 2020 2020 2320 5468 6572            # Ther
+00038940: 6520 6d61 7920 6e6f 7420 6265 2061 6e79  e may not be any
+00038950: 2074 6861 7420 7361 7469 7366 6965 7320   that satisfies 
+00038960: 7468 6573 6520 636f 6e64 6974 696f 6e73  these conditions
+00038970: 3b20 696e 2074 6869 7320 6361 7365 0a20  ; in this case. 
+00038980: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00038990: 2074 6869 7320 7461 736b 2077 6f6e 2774   this task won't
+000389a0: 2062 6520 6d6f 7665 642e 0a20 2020 2020   be moved..     
+000389b0: 2020 2020 2020 2020 2020 2073 6b69 7070             skipp
+000389c0: 6564 5f72 6563 6970 6965 6e74 7320 3d20  ed_recipients = 
+000389d0: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
+000389e0: 2020 2075 7365 5f72 6563 6970 6965 6e74     use_recipient
+000389f0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00038a00: 2020 2020 2020 2020 2077 6869 6c65 2072           while r
+00038a10: 6563 6970 6965 6e74 7320 616e 6420 6e6f  ecipients and no
+00038a20: 7420 7573 655f 7265 6369 7069 656e 743a  t use_recipient:
+00038a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038a40: 2020 2020 2072 6563 5f62 7974 6573 5f6d       rec_bytes_m
+00038a50: 6178 2c20 7265 635f 6279 7465 735f 6d69  ax, rec_bytes_mi
+00038a60: 6e2c 205f 2c20 7265 635f 7773 203d 2072  n, _, rec_ws = r
+00038a70: 6563 6970 6965 6e74 735b 305d 0a20 2020  ecipients[0].   
+00038a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038a90: 2069 6620 6e62 7974 6573 202b 2072 6563   if nbytes + rec
+00038aa0: 5f62 7974 6573 5f6d 6178 203e 2030 3a0a  _bytes_max > 0:.
+00038ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038ac0: 2020 2020 2020 2020 2320 7265 6369 7069          # recipi
+00038ad0: 656e 7473 2061 7265 2073 6f72 7465 6420  ents are sorted 
+00038ae0: 6279 2072 6563 5f62 7974 6573 5f6d 6178  by rec_bytes_max
+00038af0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00038b00: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00038b10: 6e65 7874 206f 6e65 7320 7769 6c6c 2062  next ones will b
+00038b20: 6520 776f 7273 653b 206e 6f20 7265 6173  e worse; no reas
+00038b30: 6f6e 2074 6f20 636f 6e74 696e 7565 2069  on to continue i
+00038b40: 7465 7261 7469 6e67 0a20 2020 2020 2020  terating.       
+00038b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038b60: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
+00038b70: 2020 2020 2020 2020 2020 2075 7365 5f72             use_r
+00038b80: 6563 6970 6965 6e74 203d 2074 7320 6e6f  ecipient = ts no
+00038b90: 7420 696e 2072 6563 5f77 732e 5f68 6173  t in rec_ws._has
+00038ba0: 5f77 6861 740a 2020 2020 2020 2020 2020  _what.          
+00038bb0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00038bc0: 2075 7365 5f72 6563 6970 6965 6e74 3a0a   use_recipient:.
+00038bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038be0: 2020 2020 2020 2020 736b 6970 7065 645f          skipped_
+00038bf0: 7265 6369 7069 656e 7473 2e61 7070 656e  recipients.appen
+00038c00: 6428 6865 6170 712e 6865 6170 706f 7028  d(heapq.heappop(
+00038c10: 7265 6369 7069 656e 7473 2929 0a0a 2020  recipients))..  
+00038c20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00038c30: 7220 7265 6369 7069 656e 7420 696e 2073  r recipient in s
+00038c40: 6b69 7070 6564 5f72 6563 6970 6965 6e74  kipped_recipient
+00038c50: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00038c60: 2020 2020 2020 2068 6561 7071 2e68 6561         heapq.hea
+00038c70: 7070 7573 6828 7265 6369 7069 656e 7473  ppush(recipients
+00038c80: 2c20 7265 6369 7069 656e 7429 0a0a 2020  , recipient)..  
+00038c90: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00038ca0: 206e 6f74 2075 7365 5f72 6563 6970 6965   not use_recipie
+00038cb0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+00038cc0: 2020 2020 2020 2020 2320 5468 6973 2074          # This t
+00038cd0: 6173 6b20 6861 7320 6e6f 2072 6563 6970  ask has no recip
+00038ce0: 6965 6e74 7320 6176 6169 6c61 626c 652e  ients available.
+00038cf0: 204c 6561 7665 2069 7420 6f6e 2074 6865   Leave it on the
+00038d00: 2073 656e 6465 7220 616e 640a 2020 2020   sender and.    
+00038d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038d20: 2320 6d6f 7665 206f 6e20 746f 2074 6865  # move on to the
+00038d30: 206e 6578 7420 7461 736b 206f 6620 7468   next task of th
+00038d40: 6520 7361 6d65 2073 656e 6465 722e 0a20  e same sender.. 
+00038d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038d60: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+00038d70: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+00038d80: 6368 6564 756c 6520 7461 736b 2066 6f72  chedule task for
+00038d90: 2074 7261 6e73 6665 7220 6672 6f6d 2073   transfer from s
+00038da0: 656e 6465 7220 746f 2072 6563 6970 6965  ender to recipie
+00038db0: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
+00038dc0: 2020 206d 7367 732e 6170 7065 6e64 2828     msgs.append((
+00038dd0: 736e 645f 7773 2c20 7265 635f 7773 2c20  snd_ws, rec_ws, 
+00038de0: 7473 2929 0a0a 2020 2020 2020 2020 2020  ts))..          
+00038df0: 2020 2020 2020 2320 2a5f 6279 7465 735f        # *_bytes_
+00038e00: 6d61 782f 6d69 6e20 6172 6520 616c 6c20  max/min are all 
+00038e10: 6e65 6761 7469 7665 2066 6f72 2068 6561  negative for hea
+00038e20: 7020 736f 7274 696e 670a 2020 2020 2020  p sorting.      
+00038e30: 2020 2020 2020 2020 2020 736e 645f 6279            snd_by
+00038e40: 7465 735f 6d61 7820 2b3d 206e 6279 7465  tes_max += nbyte
+00038e50: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00038e60: 2020 736e 645f 6279 7465 735f 6d69 6e20    snd_bytes_min 
+00038e70: 2b3d 206e 6279 7465 730a 2020 2020 2020  += nbytes.      
+00038e80: 2020 2020 2020 2020 2020 7265 635f 6279            rec_by
+00038e90: 7465 735f 6d61 7820 2b3d 206e 6279 7465  tes_max += nbyte
+00038ea0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00038eb0: 2020 7265 635f 6279 7465 735f 6d69 6e20    rec_bytes_min 
+00038ec0: 2b3d 206e 6279 7465 730a 0a20 2020 2020  += nbytes..     
+00038ed0: 2020 2020 2020 2020 2020 2023 2053 746f             # Sto
+00038ee0: 7020 6974 6572 6174 696e 6720 6f6e 2074  p iterating on t
+00038ef0: 6865 2074 6173 6b73 206f 6620 7468 6973  he tasks of this
+00038f00: 2073 656e 6465 7220 666f 7220 6e6f 7720   sender for now 
+00038f10: 616e 642c 2069 6620 6974 2073 7469 6c6c  and, if it still
+00038f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038f30: 2023 2068 6173 2062 7974 6573 2074 6f20   # has bytes to 
+00038f40: 6c6f 7365 2c20 7075 7368 2069 7420 6261  lose, push it ba
+00038f50: 636b 2069 6e74 6f20 7468 6520 7365 6e64  ck into the send
+00038f60: 6572 7320 6865 6170 3b20 6974 206d 6179  ers heap; it may
+00038f70: 206f 7220 6d61 790a 2020 2020 2020 2020   or may.        
+00038f80: 2020 2020 2020 2020 2320 6e6f 7420 636f          # not co
+00038f90: 6d65 2062 6163 6b20 6f6e 2074 6f70 2061  me back on top a
+00038fa0: 6761 696e 2e0a 2020 2020 2020 2020 2020  gain..          
+00038fb0: 2020 2020 2020 6966 2073 6e64 5f62 7974        if snd_byt
+00038fc0: 6573 5f6d 696e 203c 2030 3a0a 2020 2020  es_min < 0:.    
+00038fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038fe0: 2320 5365 6520 6465 6669 6e69 7469 6f6e  # See definition
+00038ff0: 206f 6620 7365 6e64 6572 7320 6162 6f76   of senders abov
+00039000: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00039010: 2020 2020 2020 6865 6170 712e 6865 6170        heapq.heap
+00039020: 7265 706c 6163 6528 0a20 2020 2020 2020  replace(.       
+00039030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039040: 2073 656e 6465 7273 2c0a 2020 2020 2020   senders,.      
+00039050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039060: 2020 2873 6e64 5f62 7974 6573 5f6d 6178    (snd_bytes_max
+00039070: 2c20 736e 645f 6279 7465 735f 6d69 6e2c  , snd_bytes_min,
+00039080: 2069 6428 736e 645f 7773 292c 2073 6e64   id(snd_ws), snd
+00039090: 5f77 732c 2074 735f 6974 6572 292c 0a20  _ws, ts_iter),. 
+000390a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000390b0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000390c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000390d0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000390e0: 6561 7071 2e68 6561 7070 6f70 2873 656e  eapq.heappop(sen
+000390f0: 6465 7273 290a 0a20 2020 2020 2020 2020  ders)..         
+00039100: 2020 2020 2020 2023 2049 6620 7265 6369         # If reci
+00039110: 7069 656e 7420 7374 696c 6c20 6861 7320  pient still has 
+00039120: 6279 7465 7320 746f 2067 6169 6e2c 2070  bytes to gain, p
+00039130: 7573 6820 6974 2062 6163 6b20 696e 746f  ush it back into
+00039140: 2074 6865 2072 6563 6970 6965 6e74 730a   the recipients.
+00039150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039160: 2320 6865 6170 3b20 6974 206d 6179 206f  # heap; it may o
+00039170: 7220 6d61 7920 6e6f 7420 636f 6d65 2062  r may not come b
+00039180: 6163 6b20 6f6e 2074 6f70 2061 6761 696e  ack on top again
+00039190: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000391a0: 2020 6966 2072 6563 5f62 7974 6573 5f6d    if rec_bytes_m
+000391b0: 696e 203c 2030 3a0a 2020 2020 2020 2020  in < 0:.        
+000391c0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+000391d0: 6520 6465 6669 6e69 7469 6f6e 206f 6620  e definition of 
+000391e0: 7265 6369 7069 656e 7473 2061 626f 7665  recipients above
+000391f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039200: 2020 2020 2068 6561 7071 2e68 6561 7072       heapq.heapr
+00039210: 6570 6c61 6365 280a 2020 2020 2020 2020  eplace(.        
+00039220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039230: 7265 6369 7069 656e 7473 2c0a 2020 2020  recipients,.    
+00039240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039250: 2020 2020 2872 6563 5f62 7974 6573 5f6d      (rec_bytes_m
+00039260: 6178 2c20 7265 635f 6279 7465 735f 6d69  ax, rec_bytes_mi
+00039270: 6e2c 2069 6428 7265 635f 7773 292c 2072  n, id(rec_ws), r
+00039280: 6563 5f77 7329 2c0a 2020 2020 2020 2020  ec_ws),.        
+00039290: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000392a0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000392b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000392c0: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
+000392d0: 6170 706f 7028 7265 6369 7069 656e 7473  appop(recipients
+000392e0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+000392f0: 2020 2023 204d 6f76 6520 746f 206e 6578     # Move to nex
+00039300: 7420 7365 6e64 6572 2077 6974 6820 7468  t sender with th
+00039310: 6520 6d6f 7374 2064 6174 6120 746f 206c  e most data to l
+00039320: 6f73 652e 0a20 2020 2020 2020 2020 2020  ose..           
+00039330: 2020 2020 2023 2049 7420 6d61 7920 6f72       # It may or
+00039340: 206d 6179 206e 6f74 2062 6520 7468 6520   may not be the 
+00039350: 7361 6d65 2073 656e 6465 7220 6167 6169  same sender agai
+00039360: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
+00039370: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+00039380: 2020 2020 2020 656c 7365 3a20 2023 2066        else:  # f
+00039390: 6f72 2074 7320 696e 2074 735f 6974 6572  or ts in ts_iter
+000393a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000393b0: 2023 2045 7868 6175 7374 6564 2074 6173   # Exhausted tas
+000393c0: 6b73 206f 6e20 7468 6973 2073 656e 6465  ks on this sende
+000393d0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+000393e0: 2020 6865 6170 712e 6865 6170 706f 7028    heapq.heappop(
+000393f0: 7365 6e64 6572 7329 0a0a 2020 2020 2020  senders)..      
+00039400: 2020 7265 7475 726e 206d 7367 730a 0a20    return msgs.. 
+00039410: 2020 2061 7379 6e63 2064 6566 205f 7265     async def _re
+00039420: 6261 6c61 6e63 655f 6d6f 7665 5f64 6174  balance_move_dat
+00039430: 6128 0a20 2020 2020 2020 2073 656c 662c  a(.        self,
+00039440: 206d 7367 733a 2022 6c69 7374 5b74 7570   msgs: "list[tup
+00039450: 6c65 5b57 6f72 6b65 7253 7461 7465 2c20  le[WorkerState, 
+00039460: 576f 726b 6572 5374 6174 652c 2054 6173  WorkerState, Tas
+00039470: 6b53 7461 7465 5d5d 222c 2073 7469 6d75  kState]]", stimu
+00039480: 6c75 735f 6964 3a20 7374 720a 2020 2020  lus_id: str.    
+00039490: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
+000394a0: 2020 2022 2222 5065 7266 6f72 6d20 7468     """Perform th
+000394b0: 6520 6163 7475 616c 2074 7261 6e73 6665  e actual transfe
+000394c0: 7220 6f66 2064 6174 6120 6163 726f 7373  r of data across
+000394d0: 2074 6865 206e 6574 776f 726b 2069 6e20   the network in 
+000394e0: 7265 6261 6c61 6e63 6528 292e 0a20 2020  rebalance()..   
+000394f0: 2020 2020 2054 616b 6573 2069 6e20 696e       Takes in in
+00039500: 7075 7420 7468 6520 6f75 7470 7574 206f  put the output o
+00039510: 6620 5f72 6562 616c 616e 6365 5f66 696e  f _rebalance_fin
+00039520: 645f 6d73 6773 2829 2c20 7468 6174 2069  d_msgs(), that i
+00039530: 7320 6120 6c69 7374 206f 6620 7475 706c  s a list of tupl
+00039540: 6573 3a0a 0a20 2020 2020 2020 202d 2073  es:..        - s
+00039550: 656e 6465 7220 776f 726b 6572 0a20 2020  ender worker.   
+00039560: 2020 2020 202d 2072 6563 6970 6965 6e74       - recipient
+00039570: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
+00039580: 2d20 7461 736b 2074 6f20 6265 2074 7261  - task to be tra
+00039590: 6e73 6665 7272 6564 0a0a 2020 2020 2020  nsferred..      
+000395a0: 2020 4649 584d 4520 7468 6973 206d 6574    FIXME this met
+000395b0: 686f 6420 6973 206e 6f74 2072 6f62 7573  hod is not robus
+000395c0: 7420 7768 656e 2074 6865 2063 6c75 7374  t when the clust
+000395d0: 6572 2069 7320 6e6f 7420 6964 6c65 2e0a  er is not idle..
+000395e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000395f0: 2020 2020 746f 5f72 6563 6970 6965 6e74      to_recipient
+00039600: 733a 2064 6566 6175 6c74 6469 6374 5b73  s: defaultdict[s
+00039610: 7472 2c20 6465 6661 756c 7464 6963 745b  tr, defaultdict[
+00039620: 7374 722c 206c 6973 745b 7374 725d 5d5d  str, list[str]]]
+00039630: 203d 2064 6566 6175 6c74 6469 6374 280a   = defaultdict(.
+00039640: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+00039650: 6461 3a20 6465 6661 756c 7464 6963 7428  da: defaultdict(
+00039660: 6c69 7374 290a 2020 2020 2020 2020 290a  list).        ).
+00039670: 2020 2020 2020 2020 666f 7220 736e 645f          for snd_
+00039680: 7773 2c20 7265 635f 7773 2c20 7473 2069  ws, rec_ws, ts i
+00039690: 6e20 6d73 6773 3a0a 2020 2020 2020 2020  n msgs:.        
+000396a0: 2020 2020 746f 5f72 6563 6970 6965 6e74      to_recipient
+000396b0: 735b 7265 635f 7773 2e61 6464 7265 7373  s[rec_ws.address
+000396c0: 5d5b 7473 2e6b 6579 5d2e 6170 7065 6e64  ][ts.key].append
+000396d0: 2873 6e64 5f77 732e 6164 6472 6573 7329  (snd_ws.address)
+000396e0: 0a20 2020 2020 2020 2066 6169 6c65 645f  .        failed_
+000396f0: 6b65 7973 5f62 795f 7265 6369 7069 656e  keys_by_recipien
+00039700: 7420 3d20 6469 6374 280a 2020 2020 2020  t = dict(.      
+00039710: 2020 2020 2020 7a69 7028 0a20 2020 2020        zip(.     
+00039720: 2020 2020 2020 2020 2020 2074 6f5f 7265             to_re
+00039730: 6369 7069 656e 7473 2c0a 2020 2020 2020  cipients,.      
+00039740: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00039750: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+00039760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039770: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
+00039780: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00039790: 204e 6f74 653a 2074 6869 7320 6e65 7665   Note: this neve
+000397a0: 7220 7261 6973 6573 2065 7863 6570 7469  r raises excepti
+000397b0: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
+000397c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000397d0: 2e67 6174 6865 725f 6f6e 5f77 6f72 6b65  .gather_on_worke
+000397e0: 7228 772c 2077 686f 5f68 6173 290a 2020  r(w, who_has).  
+000397f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039800: 2020 2020 2020 666f 7220 772c 2077 686f        for w, who
+00039810: 5f68 6173 2069 6e20 746f 5f72 6563 6970  _has in to_recip
+00039820: 6965 6e74 732e 6974 656d 7328 290a 2020  ients.items().  
+00039830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039840: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00039850: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00039860: 2020 2029 0a20 2020 2020 2020 2029 0a0a     ).        )..
+00039870: 2020 2020 2020 2020 746f 5f73 656e 6465          to_sende
+00039880: 7273 203d 2064 6566 6175 6c74 6469 6374  rs = defaultdict
+00039890: 286c 6973 7429 0a20 2020 2020 2020 2066  (list).        f
+000398a0: 6f72 2073 6e64 5f77 732c 2072 6563 5f77  or snd_ws, rec_w
+000398b0: 732c 2074 7320 696e 206d 7367 733a 0a20  s, ts in msgs:. 
+000398c0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+000398d0: 2e6b 6579 206e 6f74 2069 6e20 6661 696c  .key not in fail
+000398e0: 6564 5f6b 6579 735f 6279 5f72 6563 6970  ed_keys_by_recip
+000398f0: 6965 6e74 5b72 6563 5f77 732e 6164 6472  ient[rec_ws.addr
+00039900: 6573 735d 3a0a 2020 2020 2020 2020 2020  ess]:.          
+00039910: 2020 2020 2020 746f 5f73 656e 6465 7273        to_senders
+00039920: 5b73 6e64 5f77 732e 6164 6472 6573 735d  [snd_ws.address]
+00039930: 2e61 7070 656e 6428 7473 2e6b 6579 290a  .append(ts.key).
+00039940: 0a20 2020 2020 2020 2023 204e 6f74 653a  .        # Note:
+00039950: 2074 6869 7320 6e65 7665 7220 7261 6973   this never rais
+00039960: 6573 2065 7863 6570 7469 6f6e 730a 2020  es exceptions.  
+00039970: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+00039980: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
+00039990: 2020 2020 2020 2020 2a28 7365 6c66 2e64          *(self.d
+000399a0: 656c 6574 655f 776f 726b 6572 5f64 6174  elete_worker_dat
+000399b0: 6128 722c 2076 2c20 7374 696d 756c 7573  a(r, v, stimulus
+000399c0: 5f69 6429 2066 6f72 2072 2c20 7620 696e  _id) for r, v in
+000399d0: 2074 6f5f 7365 6e64 6572 732e 6974 656d   to_senders.item
+000399e0: 7328 2929 0a20 2020 2020 2020 2029 0a0a  s()).        )..
+000399f0: 2020 2020 2020 2020 666f 7220 722c 2076          for r, v
+00039a00: 2069 6e20 746f 5f72 6563 6970 6965 6e74   in to_recipient
+00039a10: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00039a20: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+00039a30: 6576 656e 7428 722c 207b 2261 6374 696f  event(r, {"actio
+00039a40: 6e22 3a20 2272 6562 616c 616e 6365 222c  n": "rebalance",
+00039a50: 2022 7768 6f5f 6861 7322 3a20 767d 290a   "who_has": v}).
+00039a60: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00039a70: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
+00039a80: 2020 2020 2261 6c6c 222c 0a20 2020 2020      "all",.     
+00039a90: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00039aa0: 2020 2020 2020 2020 2022 6163 7469 6f6e           "action
+00039ab0: 223a 2022 7265 6261 6c61 6e63 6522 2c0a  ": "rebalance",.
+00039ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039ad0: 2273 656e 6465 7273 223a 2076 616c 6d61  "senders": valma
+00039ae0: 7028 6c65 6e2c 2074 6f5f 7365 6e64 6572  p(len, to_sender
+00039af0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00039b00: 2020 2020 2272 6563 6970 6965 6e74 7322      "recipients"
+00039b10: 3a20 7661 6c6d 6170 286c 656e 2c20 746f  : valmap(len, to
+00039b20: 5f72 6563 6970 6965 6e74 7329 2c0a 2020  _recipients),.  
+00039b30: 2020 2020 2020 2020 2020 2020 2020 226d                "m
+00039b40: 6f76 6564 5f6b 6579 7322 3a20 6c65 6e28  oved_keys": len(
+00039b50: 6d73 6773 292c 0a20 2020 2020 2020 2020  msgs),.         
+00039b60: 2020 207d 2c0a 2020 2020 2020 2020 290a     },.        ).
+00039b70: 0a20 2020 2020 2020 206d 6973 7369 6e67  .        missing
+00039b80: 5f6b 6579 7320 3d20 7b6b 2066 6f72 2072  _keys = {k for r
+00039b90: 2069 6e20 6661 696c 6564 5f6b 6579 735f   in failed_keys_
+00039ba0: 6279 5f72 6563 6970 6965 6e74 2e76 616c  by_recipient.val
+00039bb0: 7565 7328 2920 666f 7220 6b20 696e 2072  ues() for k in r
+00039bc0: 7d0a 2020 2020 2020 2020 6966 206d 6973  }.        if mis
+00039bd0: 7369 6e67 5f6b 6579 733a 0a20 2020 2020  sing_keys:.     
+00039be0: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+00039bf0: 7374 6174 7573 223a 2022 7061 7274 6961  status": "partia
+00039c00: 6c2d 6661 696c 222c 2022 6b65 7973 223a  l-fail", "keys":
+00039c10: 206c 6973 7428 6d69 7373 696e 675f 6b65   list(missing_ke
+00039c20: 7973 297d 0a20 2020 2020 2020 2065 6c73  ys)}.        els
+00039c30: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00039c40: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
+00039c50: 2022 4f4b 227d 0a0a 2020 2020 6173 796e   "OK"}..    asyn
+00039c60: 6320 6465 6620 7265 706c 6963 6174 6528  c def replicate(
+00039c70: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00039c80: 2020 2020 2020 2063 6f6d 6d3d 4e6f 6e65         comm=None
+00039c90: 2c0a 2020 2020 2020 2020 6b65 7973 3d4e  ,.        keys=N
+00039ca0: 6f6e 652c 0a20 2020 2020 2020 206e 3d4e  one,.        n=N
+00039cb0: 6f6e 652c 0a20 2020 2020 2020 2077 6f72  one,.        wor
+00039cc0: 6b65 7273 3d4e 6f6e 652c 0a20 2020 2020  kers=None,.     
+00039cd0: 2020 2062 7261 6e63 6869 6e67 5f66 6163     branching_fac
+00039ce0: 746f 723d 322c 0a20 2020 2020 2020 2064  tor=2,.        d
+00039cf0: 656c 6574 653d 5472 7565 2c0a 2020 2020  elete=True,.    
+00039d00: 2020 2020 6c6f 636b 3d54 7275 652c 0a20      lock=True,. 
+00039d10: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+00039d20: 6964 3d4e 6f6e 652c 0a20 2020 2029 3a0a  id=None,.    ):.
+00039d30: 2020 2020 2020 2020 2222 2252 6570 6c69          """Repli
+00039d40: 6361 7465 2064 6174 6120 7468 726f 7567  cate data throug
+00039d50: 686f 7574 2063 6c75 7374 6572 0a0a 2020  hout cluster..  
+00039d60: 2020 2020 2020 5468 6973 2070 6572 666f        This perfo
+00039d70: 726d 7320 6120 7472 6565 2063 6f70 7920  rms a tree copy 
+00039d80: 6f66 2074 6865 2064 6174 6120 7468 726f  of the data thro
+00039d90: 7567 686f 7574 2074 6865 206e 6574 776f  ughout the netwo
+00039da0: 726b 0a20 2020 2020 2020 2069 6e64 6976  rk.        indiv
+00039db0: 6964 7561 6c6c 7920 6f6e 2065 6163 6820  idually on each 
+00039dc0: 7069 6563 6520 6f66 2064 6174 612e 0a0a  piece of data...
+00039dd0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+00039de0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+00039df0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6b65  -----.        ke
+00039e00: 7973 3a20 4974 6572 6162 6c65 0a20 2020  ys: Iterable.   
+00039e10: 2020 2020 2020 2020 206c 6973 7420 6f66           list of
+00039e20: 206b 6579 7320 746f 2072 6570 6c69 6361   keys to replica
+00039e30: 7465 0a20 2020 2020 2020 206e 3a20 696e  te.        n: in
+00039e40: 740a 2020 2020 2020 2020 2020 2020 4e75  t.            Nu
+00039e50: 6d62 6572 206f 6620 7265 706c 6963 6174  mber of replicat
+00039e60: 696f 6e73 2077 6520 6578 7065 6374 2074  ions we expect t
+00039e70: 6f20 7365 6520 7769 7468 696e 2074 6865  o see within the
+00039e80: 2063 6c75 7374 6572 0a20 2020 2020 2020   cluster.       
+00039e90: 2062 7261 6e63 6869 6e67 5f66 6163 746f   branching_facto
+00039ea0: 723a 2069 6e74 2c20 6f70 7469 6f6e 616c  r: int, optional
+00039eb0: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00039ec0: 206e 756d 6265 7220 6f66 2077 6f72 6b65   number of worke
+00039ed0: 7273 2074 6861 7420 6361 6e20 636f 7079  rs that can copy
+00039ee0: 2064 6174 6120 696e 2065 6163 6820 6765   data in each ge
+00039ef0: 6e65 7261 7469 6f6e 2e0a 2020 2020 2020  neration..      
+00039f00: 2020 2020 2020 5468 6520 6c61 7267 6572        The larger
+00039f10: 2074 6865 2062 7261 6e63 6869 6e67 2066   the branching f
+00039f20: 6163 746f 722c 2074 6865 206d 6f72 6520  actor, the more 
+00039f30: 6461 7461 2077 6520 636f 7079 2069 6e0a  data we copy in.
+00039f40: 2020 2020 2020 2020 2020 2020 6120 7369              a si
+00039f50: 6e67 6c65 2073 7465 702c 2062 7574 2074  ngle step, but t
+00039f60: 6865 206d 6f72 6520 6120 6769 7665 6e20  he more a given 
+00039f70: 776f 726b 6572 2072 6973 6b73 2062 6569  worker risks bei
+00039f80: 6e67 0a20 2020 2020 2020 2020 2020 2073  ng.            s
+00039f90: 7761 6d70 6564 2062 7920 6461 7461 2072  wamped by data r
+00039fa0: 6571 7565 7374 732e 0a0a 2020 2020 2020  equests...      
+00039fb0: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+00039fc0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00039fd0: 2020 2020 5363 6865 6475 6c65 722e 7265      Scheduler.re
+00039fe0: 6261 6c61 6e63 650a 2020 2020 2020 2020  balance.        
+00039ff0: 2222 220a 2020 2020 2020 2020 7374 696d  """.        stim
+0003a000: 756c 7573 5f69 6420 3d20 7374 696d 756c  ulus_id = stimul
+0003a010: 7573 5f69 6420 6f72 2066 2272 6570 6c69  us_id or f"repli
+0003a020: 6361 7465 2d7b 7469 6d65 2829 7d22 0a20  cate-{time()}". 
+0003a030: 2020 2020 2020 2061 7373 6572 7420 6272         assert br
+0003a040: 616e 6368 696e 675f 6661 6374 6f72 203e  anching_factor >
+0003a050: 2030 0a20 2020 2020 2020 2061 7379 6e63   0.        async
+0003a060: 2077 6974 6820 7365 6c66 2e5f 6c6f 636b   with self._lock
+0003a070: 2069 6620 6c6f 636b 2065 6c73 6520 656d   if lock else em
+0003a080: 7074 795f 636f 6e74 6578 743a 0a20 2020  pty_context:.   
+0003a090: 2020 2020 2020 2020 2069 6620 776f 726b           if work
+0003a0a0: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
+0003a0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a0c0: 2077 6f72 6b65 7273 203d 207b 7365 6c66   workers = {self
+0003a0d0: 2e77 6f72 6b65 7273 5b77 5d20 666f 7220  .workers[w] for 
+0003a0e0: 7720 696e 2073 656c 662e 776f 726b 6572  w in self.worker
+0003a0f0: 735f 6c69 7374 2877 6f72 6b65 7273 297d  s_list(workers)}
+0003a100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a110: 2077 6f72 6b65 7273 203d 207b 7773 2066   workers = {ws f
+0003a120: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
+0003a130: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
+0003a140: 2053 7461 7475 732e 7275 6e6e 696e 677d   Status.running}
+0003a150: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0003a160: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003a170: 2020 2077 6f72 6b65 7273 203d 2073 656c     workers = sel
+0003a180: 662e 7275 6e6e 696e 670a 0a20 2020 2020  f.running..     
+0003a190: 2020 2020 2020 2069 6620 6e20 6973 204e         if n is N
+0003a1a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0003a1b0: 2020 2020 206e 203d 206c 656e 2877 6f72       n = len(wor
+0003a1c0: 6b65 7273 290a 2020 2020 2020 2020 2020  kers).          
+0003a1d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0003a1e0: 2020 2020 2020 2020 6e20 3d20 6d69 6e28          n = min(
+0003a1f0: 6e2c 206c 656e 2877 6f72 6b65 7273 2929  n, len(workers))
+0003a200: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003a210: 6e20 3d3d 2030 3a0a 2020 2020 2020 2020  n == 0:.        
+0003a220: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0003a230: 6c75 6545 7272 6f72 2822 4361 6e20 6e6f  lueError("Can no
+0003a240: 7420 7573 6520 7265 706c 6963 6174 6520  t use replicate 
+0003a250: 746f 2064 656c 6574 6520 6461 7461 2229  to delete data")
+0003a260: 0a0a 2020 2020 2020 2020 2020 2020 7461  ..            ta
+0003a270: 736b 7320 3d20 7b73 656c 662e 7461 736b  sks = {self.task
+0003a280: 735b 6b5d 2066 6f72 206b 2069 6e20 6b65  s[k] for k in ke
+0003a290: 7973 7d0a 2020 2020 2020 2020 2020 2020  ys}.            
+0003a2a0: 6d69 7373 696e 675f 6461 7461 203d 205b  missing_data = [
+0003a2b0: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+0003a2c0: 2074 6173 6b73 2069 6620 6e6f 7420 7473   tasks if not ts
+0003a2d0: 2e77 686f 5f68 6173 5d0a 2020 2020 2020  .who_has].      
+0003a2e0: 2020 2020 2020 6966 206d 6973 7369 6e67        if missing
+0003a2f0: 5f64 6174 613a 0a20 2020 2020 2020 2020  _data:.         
+0003a300: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+0003a310: 7374 6174 7573 223a 2022 7061 7274 6961  status": "partia
+0003a320: 6c2d 6661 696c 222c 2022 6b65 7973 223a  l-fail", "keys":
+0003a330: 206d 6973 7369 6e67 5f64 6174 617d 0a0a   missing_data}..
+0003a340: 2020 2020 2020 2020 2020 2020 2320 4465              # De
+0003a350: 6c65 7465 2065 7874 7261 6e65 6f75 7320  lete extraneous 
+0003a360: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0003a370: 2069 6620 6465 6c65 7465 3a0a 2020 2020   if delete:.    
+0003a380: 2020 2020 2020 2020 2020 2020 6465 6c5f              del_
+0003a390: 776f 726b 6572 5f74 6173 6b73 203d 2064  worker_tasks = d
+0003a3a0: 6566 6175 6c74 6469 6374 2873 6574 290a  efaultdict(set).
+0003a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a3c0: 666f 7220 7473 2069 6e20 7461 736b 733a  for ts in tasks:
+0003a3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a3e0: 2020 2020 2064 656c 5f63 616e 6469 6461       del_candida
+0003a3f0: 7465 7320 3d20 7475 706c 6528 7473 2e77  tes = tuple(ts.w
+0003a400: 686f 5f68 6173 2026 2077 6f72 6b65 7273  ho_has & workers
+0003a410: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003a420: 2020 2020 2020 6966 206c 656e 2864 656c        if len(del
+0003a430: 5f63 616e 6469 6461 7465 7329 203e 206e  _candidates) > n
+0003a440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003a450: 2020 2020 2020 2020 2020 666f 7220 7773            for ws
+0003a460: 2069 6e20 7261 6e64 6f6d 2e73 616d 706c   in random.sampl
+0003a470: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0003a480: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0003a490: 656c 5f63 616e 6469 6461 7465 732c 206c  el_candidates, l
+0003a4a0: 656e 2864 656c 5f63 616e 6469 6461 7465  en(del_candidate
+0003a4b0: 7329 202d 206e 0a20 2020 2020 2020 2020  s) - n.         
+0003a4c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0003a4d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003a4e0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0003a4f0: 6c5f 776f 726b 6572 5f74 6173 6b73 5b77  l_worker_tasks[w
+0003a500: 735d 2e61 6464 2874 7329 0a0a 2020 2020  s].add(ts)..    
+0003a510: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
+0003a520: 7465 3a20 7468 6973 206e 6576 6572 2072  te: this never r
+0003a530: 6169 7365 7320 6578 6365 7074 696f 6e73  aises exceptions
+0003a540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a550: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+0003a560: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+0003a570: 2020 2020 2020 2020 2020 202a 5b0a 2020             *[.  
+0003a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a590: 2020 2020 2020 7365 6c66 2e64 656c 6574        self.delet
+0003a5a0: 655f 776f 726b 6572 5f64 6174 6128 0a20  e_worker_data(. 
+0003a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a5c0: 2020 2020 2020 2020 2020 2077 732e 6164             ws.ad
+0003a5d0: 6472 6573 732c 205b 742e 6b65 7920 666f  dress, [t.key fo
+0003a5e0: 7220 7420 696e 2074 6173 6b73 5d2c 2073  r t in tasks], s
+0003a5f0: 7469 6d75 6c75 735f 6964 0a20 2020 2020  timulus_id.     
+0003a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a610: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003a620: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0003a630: 2077 732c 2074 6173 6b73 2069 6e20 6465   ws, tasks in de
+0003a640: 6c5f 776f 726b 6572 5f74 6173 6b73 2e69  l_worker_tasks.i
+0003a650: 7465 6d73 2829 0a20 2020 2020 2020 2020  tems().         
+0003a660: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+0003a670: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+0003a680: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
+0003a690: 7079 206e 6f74 2d79 6574 2d66 696c 6c65  py not-yet-fille
+0003a6a0: 6420 6461 7461 0a20 2020 2020 2020 2020  d data.         
+0003a6b0: 2020 2077 6869 6c65 2074 6173 6b73 3a0a     while tasks:.
+0003a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a6d0: 6761 7468 6572 7320 3d20 6465 6661 756c  gathers = defaul
+0003a6e0: 7464 6963 7428 6469 6374 290a 2020 2020  tdict(dict).    
+0003a6f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003a700: 7473 2069 6e20 6c69 7374 2874 6173 6b73  ts in list(tasks
+0003a710: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003a720: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
+0003a730: 7465 203d 3d20 2266 6f72 676f 7474 656e  te == "forgotten
+0003a740: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+0003a750: 2020 2020 2020 2020 2020 2023 2074 6173             # tas
+0003a760: 6b20 6973 206e 6f20 6c6f 6e67 6572 206e  k is no longer n
+0003a770: 6565 6465 6420 6279 2061 6e79 2063 6c69  eeded by any cli
+0003a780: 656e 7420 6f72 2064 6570 656e 6465 6e74  ent or dependent
+0003a790: 2074 6173 6b0a 2020 2020 2020 2020 2020   task.          
+0003a7a0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0003a7b0: 736b 732e 7265 6d6f 7665 2874 7329 0a20  sks.remove(ts). 
 0003a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a7d0: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
-0003a7e0: 2020 2072 6573 756c 7420 3d20 5b67 6574     result = [get
-0003a7f0: 6174 7472 2877 732c 2061 7474 7269 6275  attr(ws, attribu
-0003a800: 7465 2920 666f 7220 6720 696e 2074 6f5f  te) for g in to_
-0003a810: 636c 6f73 6520 666f 7220 7773 2069 6e20  close for ws in 
-0003a820: 6772 6f75 7073 5b67 5d5d 0a20 2020 2020  groups[g]].     
-0003a830: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
-0003a840: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003a850: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0003a860: 5375 6767 6573 7420 636c 6f73 696e 6720  Suggest closing 
-0003a870: 776f 726b 6572 733a 2025 7322 2c20 7265  workers: %s", re
-0003a880: 7375 6c74 290a 0a20 2020 2020 2020 2020  sult)..         
-0003a890: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-0003a8a0: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-0003a8b0: 730a 2020 2020 6173 796e 6320 6465 6620  s.    async def 
-0003a8c0: 7265 7469 7265 5f77 6f72 6b65 7273 280a  retire_workers(.
-0003a8d0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-0003a8e0: 2020 2020 2020 776f 726b 6572 733a 206c        workers: l
-0003a8f0: 6973 745b 7374 725d 207c 204e 6f6e 6520  ist[str] | None 
-0003a900: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0003a910: 2a2c 0a20 2020 2020 2020 206e 616d 6573  *,.        names
-0003a920: 3a20 6c69 7374 207c 204e 6f6e 6520 3d20  : list | None = 
-0003a930: 4e6f 6e65 2c0a 2020 2020 2020 2020 636c  None,.        cl
-0003a940: 6f73 655f 776f 726b 6572 733a 2062 6f6f  ose_workers: boo
-0003a950: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-0003a960: 2020 2072 656d 6f76 653a 2062 6f6f 6c20     remove: bool 
-0003a970: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-0003a980: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-0003a990: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003a9a0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-0003a9b0: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
-0003a9c0: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
-0003a9d0: 2020 2020 2020 2020 2222 2247 7261 6365          """Grace
-0003a9e0: 6675 6c6c 7920 7265 7469 7265 2077 6f72  fully retire wor
-0003a9f0: 6b65 7273 2066 726f 6d20 636c 7573 7465  kers from cluste
-0003aa00: 722e 2041 6e79 206b 6579 2074 6861 7420  r. Any key that 
-0003aa10: 6973 2069 6e20 6d65 6d6f 7279 2065 7863  is in memory exc
-0003aa20: 6c75 7369 7665 6c79 0a20 2020 2020 2020  lusively.       
-0003aa30: 206f 6e20 7468 6520 7265 7469 7265 6420   on the retired 
-0003aa40: 776f 726b 6572 7320 6973 2072 6570 6c69  workers is repli
-0003aa50: 6361 7465 6420 736f 6d65 7768 6572 6520  cated somewhere 
-0003aa60: 656c 7365 2e0a 0a20 2020 2020 2020 2050  else...        P
-0003aa70: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-0003aa80: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-0003aa90: 2020 2020 2077 6f72 6b65 7273 3a20 6c69       workers: li
-0003aaa0: 7374 5b73 7472 5d20 286f 7074 696f 6e61  st[str] (optiona
-0003aab0: 6c29 0a20 2020 2020 2020 2020 2020 204c  l).            L
-0003aac0: 6973 7420 6f66 2077 6f72 6b65 7220 6164  ist of worker ad
-0003aad0: 6472 6573 7365 7320 746f 2072 6574 6972  dresses to retir
-0003aae0: 652e 0a20 2020 2020 2020 206e 616d 6573  e..        names
-0003aaf0: 3a20 6c69 7374 2028 6f70 7469 6f6e 616c  : list (optional
-0003ab00: 290a 2020 2020 2020 2020 2020 2020 4c69  ).            Li
-0003ab10: 7374 206f 6620 776f 726b 6572 206e 616d  st of worker nam
-0003ab20: 6573 2074 6f20 7265 7469 7265 2e0a 2020  es to retire..  
-0003ab30: 2020 2020 2020 2020 2020 4d75 7475 616c            Mutual
-0003ab40: 6c79 2065 7863 6c75 7369 7665 2077 6974  ly exclusive wit
-0003ab50: 6820 6060 776f 726b 6572 7360 602e 0a20  h ``workers``.. 
-0003ab60: 2020 2020 2020 2020 2020 2049 6620 6e65             If ne
-0003ab70: 6974 6865 7220 6060 776f 726b 6572 7360  ither ``workers`
-0003ab80: 6020 6e6f 7220 6060 6e61 6d65 7360 6020  ` nor ``names`` 
-0003ab90: 6172 6520 7072 6f76 6964 6564 2c20 7765  are provided, we
-0003aba0: 2063 616c 6c0a 2020 2020 2020 2020 2020   call.          
-0003abb0: 2020 6060 776f 726b 6572 735f 746f 5f63    ``workers_to_c
-0003abc0: 6c6f 7365 6060 2077 6869 6368 2066 696e  lose`` which fin
-0003abd0: 6473 2061 2067 6f6f 6420 7365 742e 0a20  ds a good set.. 
-0003abe0: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
-0003abf0: 6b65 7273 3a20 626f 6f6c 2028 6465 6661  kers: bool (defa
-0003ac00: 756c 7473 2074 6f20 4661 6c73 6529 0a20  ults to False). 
-0003ac10: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
-0003ac20: 6572 206f 7220 6e6f 7420 746f 2061 6374  er or not to act
-0003ac30: 7561 6c6c 7920 636c 6f73 6520 7468 6520  ually close the 
-0003ac40: 776f 726b 6572 2065 7870 6c69 6369 746c  worker explicitl
-0003ac50: 7920 6672 6f6d 2068 6572 652e 0a20 2020  y from here..   
-0003ac60: 2020 2020 2020 2020 204f 7468 6572 7769           Otherwi
-0003ac70: 7365 2077 6520 6578 7065 6374 2073 6f6d  se we expect som
-0003ac80: 6520 6578 7465 726e 616c 206a 6f62 2073  e external job s
-0003ac90: 6368 6564 756c 6572 2074 6f20 6669 6e69  cheduler to fini
-0003aca0: 7368 206f 6666 2074 6865 0a20 2020 2020  sh off the.     
-0003acb0: 2020 2020 2020 2077 6f72 6b65 722e 0a20         worker.. 
-0003acc0: 2020 2020 2020 2072 656d 6f76 653a 2062         remove: b
-0003acd0: 6f6f 6c20 2864 6566 6175 6c74 7320 746f  ool (defaults to
-0003ace0: 2054 7275 6529 0a20 2020 2020 2020 2020   True).         
-0003acf0: 2020 2057 6865 7468 6572 206f 7220 6e6f     Whether or no
-0003ad00: 7420 746f 2072 656d 6f76 6520 7468 6520  t to remove the 
-0003ad10: 776f 726b 6572 206d 6574 6164 6174 6120  worker metadata 
-0003ad20: 696d 6d65 6469 6174 656c 7920 6f72 2065  immediately or e
-0003ad30: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-0003ad40: 7761 6974 2066 6f72 2074 6865 2077 6f72  wait for the wor
-0003ad50: 6b65 7220 746f 2063 6f6e 7461 6374 2075  ker to contact u
-0003ad60: 732e 0a0a 2020 2020 2020 2020 2020 2020  s...            
-0003ad70: 4966 2063 6c6f 7365 5f77 6f72 6b65 7273  If close_workers
-0003ad80: 3d46 616c 7365 2061 6e64 2072 656d 6f76  =False and remov
-0003ad90: 653d 4661 6c73 652c 2074 6869 7320 6d65  e=False, this me
-0003ada0: 7468 6f64 206a 7573 7420 666c 7573 6865  thod just flushe
-0003adb0: 7320 7468 6520 7461 736b 730a 2020 2020  s the tasks.    
-0003adc0: 2020 2020 2020 2020 696e 206d 656d 6f72          in memor
-0003add0: 7920 6f75 7420 6f66 2074 6865 2077 6f72  y out of the wor
-0003ade0: 6b65 7273 2061 6e64 2074 6865 6e20 7265  kers and then re
-0003adf0: 7475 726e 732e 0a20 2020 2020 2020 2020  turns..         
-0003ae00: 2020 2049 6620 636c 6f73 655f 776f 726b     If close_work
-0003ae10: 6572 733d 5472 7565 2061 6e64 2072 656d  ers=True and rem
-0003ae20: 6f76 653d 4661 6c73 652c 2074 6869 7320  ove=False, this 
-0003ae30: 6d65 7468 6f64 2077 696c 6c20 7265 7475  method will retu
-0003ae40: 726e 2077 6869 6c65 2074 6865 0a20 2020  rn while the.   
-0003ae50: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-0003ae60: 2061 7265 2073 7469 6c6c 2069 6e20 7468   are still in th
-0003ae70: 6520 636c 7573 7465 722c 2061 6c74 686f  e cluster, altho
-0003ae80: 7567 6820 7468 6579 2077 6f6e 2774 2061  ugh they won't a
-0003ae90: 6363 6570 7420 6e65 7720 7461 736b 732e  ccept new tasks.
-0003aea0: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
-0003aeb0: 636c 6f73 655f 776f 726b 6572 733d 4661  close_workers=Fa
-0003aec0: 6c73 6520 6f72 2066 6f72 2077 6861 7465  lse or for whate
-0003aed0: 7665 7220 7265 6173 6f6e 2061 2077 6f72  ver reason a wor
-0003aee0: 6b65 7220 646f 6573 6e27 7420 6163 6365  ker doesn't acce
-0003aef0: 7074 2074 6865 0a20 2020 2020 2020 2020  pt the.         
-0003af00: 2020 2063 6c6f 7365 2063 6f6d 6d61 6e64     close command
-0003af10: 2c20 6974 2077 696c 6c20 6265 206c 6566  , it will be lef
-0003af20: 7420 7065 726d 616e 656e 746c 7920 756e  t permanently un
-0003af30: 6162 6c65 2074 6f20 6163 6365 7074 206e  able to accept n
-0003af40: 6577 2074 6173 6b73 2061 6e64 0a20 2020  ew tasks and.   
-0003af50: 2020 2020 2020 2020 2069 7420 6973 2065           it is e
-0003af60: 7870 6563 7465 6420 746f 2062 6520 636c  xpected to be cl
-0003af70: 6f73 6564 2069 6e20 736f 6d65 206f 7468  osed in some oth
-0003af80: 6572 2077 6179 2e0a 0a20 2020 2020 2020  er way...       
-0003af90: 202a 2a6b 7761 7267 733a 2064 6963 740a   **kwargs: dict.
-0003afa0: 2020 2020 2020 2020 2020 2020 4578 7472              Extr
-0003afb0: 6120 6f70 7469 6f6e 7320 746f 2070 6173  a options to pas
-0003afc0: 7320 746f 2077 6f72 6b65 7273 5f74 6f5f  s to workers_to_
-0003afd0: 636c 6f73 6520 746f 2064 6574 6572 6d69  close to determi
-0003afe0: 6e65 2077 6869 6368 0a20 2020 2020 2020  ne which.       
-0003aff0: 2020 2020 2077 6f72 6b65 7273 2077 6520       workers we 
-0003b000: 7368 6f75 6c64 2064 726f 700a 0a20 2020  should drop..   
-0003b010: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
-0003b020: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
-0003b030: 2020 2020 2044 6963 7469 6f6e 6172 7920       Dictionary 
-0003b040: 6d61 7070 696e 6720 776f 726b 6572 2049  mapping worker I
-0003b050: 442f 6164 6472 6573 7320 746f 2064 6963  D/address to dic
-0003b060: 7469 6f6e 6172 7920 6f66 2069 6e66 6f72  tionary of infor
-0003b070: 6d61 7469 6f6e 2061 626f 7574 0a20 2020  mation about.   
-0003b080: 2020 2020 2074 6861 7420 776f 726b 6572       that worker
-0003b090: 2066 6f72 2065 6163 6820 7265 7469 7265   for each retire
-0003b0a0: 6420 776f 726b 6572 2e0a 0a20 2020 2020  d worker...     
-0003b0b0: 2020 2049 6620 7468 6572 6520 6172 6520     If there are 
-0003b0c0: 6b65 7973 2074 6861 7420 6578 6973 7420  keys that exist 
-0003b0d0: 696e 206d 656d 6f72 7920 6f6e 6c79 206f  in memory only o
-0003b0e0: 6e20 7468 6520 776f 726b 6572 7320 6265  n the workers be
-0003b0f0: 696e 6720 7265 7469 7265 6420 616e 6420  ing retired and 
-0003b100: 6974 0a20 2020 2020 2020 2077 6173 2069  it.        was i
-0003b110: 6d70 6f73 7369 626c 6520 746f 2072 6570  mpossible to rep
-0003b120: 6c69 6361 7465 2074 6865 6d20 736f 6d65  licate them some
-0003b130: 7768 6572 6520 656c 7365 2028 652e 672e  where else (e.g.
-0003b140: 2062 6563 6175 7365 2074 6865 7265 2061   because there a
-0003b150: 7265 6e27 740a 2020 2020 2020 2020 616e  ren't.        an
-0003b160: 7920 6f74 6865 7220 7275 6e6e 696e 6720  y other running 
-0003b170: 776f 726b 6572 7329 2c20 7468 6520 776f  workers), the wo
-0003b180: 726b 6572 7320 686f 6c64 696e 6720 7375  rkers holding su
-0003b190: 6368 206b 6579 7320 776f 6e27 7420 6265  ch keys won't be
-0003b1a0: 2072 6574 6972 6564 2061 6e64 0a20 2020   retired and.   
-0003b1b0: 2020 2020 2077 6f6e 2774 2061 7070 6561       won't appea
-0003b1c0: 7220 696e 2074 6865 2072 6574 7572 6e65  r in the returne
-0003b1d0: 6420 6469 6374 2e0a 0a20 2020 2020 2020  d dict...       
-0003b1e0: 2053 6565 2041 6c73 6f0a 2020 2020 2020   See Also.      
-0003b1f0: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-0003b200: 2020 2053 6368 6564 756c 6572 2e77 6f72     Scheduler.wor
-0003b210: 6b65 7273 5f74 6f5f 636c 6f73 650a 2020  kers_to_close.  
-0003b220: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003b230: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-0003b240: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-0003b250: 2272 6574 6972 652d 776f 726b 6572 732d  "retire-workers-
-0003b260: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
-0003b270: 2020 2320 5468 6973 206c 6f63 6b20 6d61    # This lock ma
-0003b280: 6b65 7320 7265 7469 7265 5f77 6f72 6b65  kes retire_worke
-0003b290: 7273 2c20 7265 6261 6c61 6e63 652c 2061  rs, rebalance, a
-0003b2a0: 6e64 2072 6570 6c69 6361 7465 206d 7574  nd replicate mut
-0003b2b0: 7561 6c6c 790a 2020 2020 2020 2020 2320  ually.        # 
-0003b2c0: 6578 636c 7573 6976 6520 616e 6420 7769  exclusive and wi
-0003b2d0: 6c6c 206e 6f20 6c6f 6e67 6572 2062 6520  ll no longer be 
-0003b2e0: 6e65 6365 7373 6172 7920 6f6e 6365 2072  necessary once r
-0003b2f0: 6562 616c 616e 6365 2061 6e64 2072 6570  ebalance and rep
-0003b300: 6c69 6361 7465 2061 7265 0a20 2020 2020  licate are.     
-0003b310: 2020 2023 206d 6967 7261 7465 6420 746f     # migrated to
-0003b320: 2074 6865 2041 6374 6976 6520 4d65 6d6f   the Active Memo
-0003b330: 7279 204d 616e 6167 6572 2e0a 2020 2020  ry Manager..    
-0003b340: 2020 2020 2320 4e6f 7465 2074 6861 742c      # Note that,
-0003b350: 2069 6e63 6964 656e 7461 6c6c 792c 2069   incidentally, i
-0003b360: 7420 616c 736f 2070 7265 7665 6e74 7320  t also prevents 
-0003b370: 6d75 6c74 6970 6c65 2063 616c 6c73 2074  multiple calls t
-0003b380: 6f20 7265 7469 7265 5f77 6f72 6b65 7273  o retire_workers
-0003b390: 0a20 2020 2020 2020 2023 2066 726f 6d20  .        # from 
-0003b3a0: 7275 6e6e 696e 6720 696e 2070 6172 616c  running in paral
-0003b3b0: 6c65 6c20 2d20 7468 6973 2069 7320 756e  lel - this is un
-0003b3c0: 6e65 6365 7373 6172 792e 0a20 2020 2020  necessary..     
-0003b3d0: 2020 2061 7379 6e63 2077 6974 6820 7365     async with se
-0003b3e0: 6c66 2e5f 6c6f 636b 3a0a 2020 2020 2020  lf._lock:.      
-0003b3f0: 2020 2020 2020 6966 206e 616d 6573 2069        if names i
-0003b400: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0003b410: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-0003b420: 6f72 6b65 7273 2069 7320 6e6f 7420 4e6f  orkers is not No
-0003b430: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003b440: 2020 2020 2020 2020 7261 6973 6520 5479          raise Ty
-0003b450: 7065 4572 726f 7228 226e 616d 6573 2061  peError("names a
-0003b460: 6e64 2077 6f72 6b65 7273 2061 7265 206d  nd workers are m
-0003b470: 7574 7561 6c6c 7920 6578 636c 7573 6976  utually exclusiv
-0003b480: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-0003b490: 2020 2020 6966 206e 616d 6573 3a0a 2020      if names:.  
-0003b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b4b0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
-0003b4c0: 6574 6972 6520 776f 726b 6572 206e 616d  etire worker nam
-0003b4d0: 6573 2025 7322 2c20 6e61 6d65 7329 0a20  es %s", names). 
-0003b4e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003b4f0: 2053 7570 706f 7274 2063 6173 6573 2077   Support cases w
-0003b500: 6865 7265 206e 616d 6573 2061 7265 2070  here names are p
-0003b510: 6173 7365 6420 7468 726f 7567 6820 6120  assed through a 
-0003b520: 434c 4920 616e 6420 6265 636f 6d65 0a20  CLI and become. 
-0003b530: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003b540: 2073 7472 696e 6773 0a20 2020 2020 2020   strings.       
-0003b550: 2020 2020 2020 2020 206e 616d 6573 5f73           names_s
-0003b560: 6574 203d 207b 7374 7228 6e61 6d65 2920  et = {str(name) 
-0003b570: 666f 7220 6e61 6d65 2069 6e20 6e61 6d65  for name in name
-0003b580: 737d 0a20 2020 2020 2020 2020 2020 2020  s}.             
-0003b590: 2020 2077 7373 203d 207b 7773 2066 6f72     wss = {ws for
-0003b5a0: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
-0003b5b0: 6572 732e 7661 6c75 6573 2829 2069 6620  ers.values() if 
-0003b5c0: 7374 7228 7773 2e6e 616d 6529 2069 6e20  str(ws.name) in 
-0003b5d0: 6e61 6d65 735f 7365 747d 0a20 2020 2020  names_set}.     
-0003b5e0: 2020 2020 2020 2065 6c69 6620 776f 726b         elif work
-0003b5f0: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
-0003b600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b610: 2077 7373 203d 207b 0a20 2020 2020 2020   wss = {.       
-0003b620: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0003b630: 662e 776f 726b 6572 735b 6164 6472 6573  f.workers[addres
-0003b640: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
-0003b650: 2020 2020 2020 2066 6f72 2061 6464 7265         for addre
-0003b660: 7373 2069 6e20 776f 726b 6572 730a 2020  ss in workers.  
-0003b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b680: 2020 6966 2061 6464 7265 7373 2069 6e20    if address in 
-0003b690: 7365 6c66 2e77 6f72 6b65 7273 0a20 2020  self.workers.   
-0003b6a0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0003b6b0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0003b6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b6d0: 2077 7373 203d 207b 0a20 2020 2020 2020   wss = {.       
-0003b6e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0003b6f0: 662e 776f 726b 6572 735b 6164 6472 6573  f.workers[addres
-0003b700: 735d 2066 6f72 2061 6464 7265 7373 2069  s] for address i
-0003b710: 6e20 7365 6c66 2e77 6f72 6b65 7273 5f74  n self.workers_t
-0003b720: 6f5f 636c 6f73 6528 2a2a 6b77 6172 6773  o_close(**kwargs
-0003b730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003b740: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0003b750: 6966 206e 6f74 2077 7373 3a0a 2020 2020  if not wss:.    
-0003b760: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003b770: 726e 207b 7d0a 0a20 2020 2020 2020 2020  rn {}..         
-0003b780: 2020 2073 746f 705f 616d 6d20 3d20 4661     stop_amm = Fa
-0003b790: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-0003b7a0: 616d 6d3a 2041 6374 6976 654d 656d 6f72  amm: ActiveMemor
-0003b7b0: 794d 616e 6167 6572 4578 7465 6e73 696f  yManagerExtensio
-0003b7c0: 6e20 3d20 7365 6c66 2e65 7874 656e 7369  n = self.extensi
-0003b7d0: 6f6e 735b 2261 6d6d 225d 0a20 2020 2020  ons["amm"].     
-0003b7e0: 2020 2020 2020 2069 6620 6e6f 7420 616d         if not am
-0003b7f0: 6d2e 7275 6e6e 696e 673a 0a20 2020 2020  m.running:.     
-0003b800: 2020 2020 2020 2020 2020 2061 6d6d 203d             amm =
-0003b810: 2041 6374 6976 654d 656d 6f72 794d 616e   ActiveMemoryMan
-0003b820: 6167 6572 4578 7465 6e73 696f 6e28 0a20  agerExtension(. 
-0003b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b840: 2020 2073 656c 662c 2070 6f6c 6963 6965     self, policie
-0003b850: 733d 7365 7428 292c 2072 6567 6973 7465  s=set(), registe
-0003b860: 723d 4661 6c73 652c 2073 7461 7274 3d54  r=False, start=T
-0003b870: 7275 652c 2069 6e74 6572 7661 6c3d 322e  rue, interval=2.
-0003b880: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-0003b890: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0003b8a0: 2020 2020 7374 6f70 5f61 6d6d 203d 2054      stop_amm = T
-0003b8b0: 7275 650a 0a20 2020 2020 2020 2020 2020  rue..           
-0003b8c0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0003b8d0: 2020 2020 2020 636f 726f 7320 3d20 5b5d        coros = []
-0003b8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b8f0: 2066 6f72 2077 7320 696e 2077 7373 3a0a   for ws in wss:.
-0003b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b910: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0003b920: 2252 6574 6972 696e 6720 776f 726b 6572  "Retiring worker
-0003b930: 2025 7322 2c20 7773 2e61 6464 7265 7373   %s", ws.address
-0003b940: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0003b950: 2020 2020 2020 2070 6f6c 6963 7920 3d20         policy = 
-0003b960: 5265 7469 7265 576f 726b 6572 2877 732e  RetireWorker(ws.
-0003b970: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-0003b980: 2020 2020 2020 2020 2020 2020 2061 6d6d               amm
-0003b990: 2e61 6464 5f70 6f6c 6963 7928 706f 6c69  .add_policy(poli
-0003b9a0: 6379 290a 0a20 2020 2020 2020 2020 2020  cy)..           
-0003b9b0: 2020 2020 2020 2020 2023 2043 6861 6e67           # Chang
-0003b9c0: 6520 576f 726b 6572 2e73 7461 7475 7320  e Worker.status 
-0003b9d0: 746f 2063 6c6f 7369 6e67 5f67 7261 6365  to closing_grace
-0003b9e0: 6675 6c6c 792e 2049 6d6d 6564 6961 7465  fully. Immediate
-0003b9f0: 6c79 2073 6574 0a20 2020 2020 2020 2020  ly set.         
-0003ba00: 2020 2020 2020 2020 2020 2023 2074 6865             # the
-0003ba10: 2073 616d 6520 6f6e 2074 6865 2073 6368   same on the sch
-0003ba20: 6564 756c 6572 2074 6f20 7072 6576 656e  eduler to preven
-0003ba30: 7420 7261 6365 2063 6f6e 6469 7469 6f6e  t race condition
-0003ba40: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
-0003ba50: 2020 2020 2020 2070 7265 765f 7374 6174         prev_stat
-0003ba60: 7573 203d 2077 732e 7374 6174 7573 0a20  us = ws.status. 
-0003ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ba80: 2020 2073 656c 662e 6861 6e64 6c65 5f77     self.handle_w
-0003ba90: 6f72 6b65 725f 7374 6174 7573 5f63 6861  orker_status_cha
-0003baa0: 6e67 6528 0a20 2020 2020 2020 2020 2020  nge(.           
-0003bab0: 2020 2020 2020 2020 2020 2020 2053 7461               Sta
-0003bac0: 7475 732e 636c 6f73 696e 675f 6772 6163  tus.closing_grac
-0003bad0: 6566 756c 6c79 2c20 7773 2c20 7374 696d  efully, ws, stim
-0003bae0: 756c 7573 5f69 640a 2020 2020 2020 2020  ulus_id.        
-0003baf0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bb10: 2020 2320 4649 584d 453a 2057 6520 7368    # FIXME: We sh
-0003bb20: 6f75 6c64 2073 656e 6420 6120 6d65 7373  ould send a mess
-0003bb30: 6167 6520 746f 2074 6865 206e 616e 6e79  age to the nanny
-0003bb40: 2066 6972 7374 3b0a 2020 2020 2020 2020   first;.        
-0003bb50: 2020 2020 2020 2020 2020 2020 2320 6576              # ev
-0003bb60: 656e 7475 616c 6c79 2077 6f72 6b65 7273  entually workers
-0003bb70: 2077 6f6e 2774 2062 6520 6162 6c65 2074   won't be able t
-0003bb80: 6f20 636c 6f73 6520 7468 6569 7220 6f77  o close their ow
-0003bb90: 6e20 6e61 6e6e 6965 732e 0a20 2020 2020  n nannies..     
-0003bba0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0003bbb0: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
-0003bbc0: 5b77 732e 6164 6472 6573 735d 2e73 656e  [ws.address].sen
-0003bbd0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-0003bbe0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0003bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bc00: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
-0003bc10: 776f 726b 6572 2d73 7461 7475 732d 6368  worker-status-ch
-0003bc20: 616e 6765 222c 0a20 2020 2020 2020 2020  ange",.         
-0003bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bc40: 2020 2022 7374 6174 7573 223a 2077 732e     "status": ws.
-0003bc50: 7374 6174 7573 2e6e 616d 652c 0a20 2020  status.name,.   
-0003bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bc70: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
-0003bc80: 7573 5f69 6422 3a20 7374 696d 756c 7573  us_id": stimulus
-0003bc90: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-0003bca0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0003bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bcc0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0003bcd0: 2020 2020 2020 2020 2020 636f 726f 732e            coros.
-0003bce0: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-0003bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bd00: 7365 6c66 2e5f 7472 6163 6b5f 7265 7469  self._track_reti
-0003bd10: 7265 5f77 6f72 6b65 7228 0a20 2020 2020  re_worker(.     
-0003bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bd30: 2020 2020 2020 2077 732c 0a20 2020 2020         ws,.     
-0003bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bd50: 2020 2020 2020 2070 6f6c 6963 792c 0a20         policy,. 
-0003bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bd70: 2020 2020 2020 2020 2020 2070 7265 765f             prev_
-0003bd80: 7374 6174 7573 3d70 7265 765f 7374 6174  status=prev_stat
-0003bd90: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
-0003bda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bdb0: 636c 6f73 653d 636c 6f73 655f 776f 726b  close=close_work
-0003bdc0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
-0003bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bde0: 2072 656d 6f76 653d 7265 6d6f 7665 2c0a   remove=remove,.
-0003bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003be00: 2020 2020 2020 2020 2020 2020 7374 696d              stim
-0003be10: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-0003be20: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-0003be30: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0003be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003be50: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0003be60: 2020 2020 2020 2320 4769 7665 2074 6865        # Give the
-0003be70: 2041 4d4d 2061 206b 6963 6b2c 2069 6e20   AMM a kick, in 
-0003be80: 6164 6469 7469 6f6e 2074 6f20 6974 7320  addition to its 
-0003be90: 7065 7269 6f64 6963 2072 756e 6e69 6e67  periodic running
-0003bea0: 2e20 5468 6973 2069 730a 2020 2020 2020  . This is.      
-0003beb0: 2020 2020 2020 2020 2020 2320 746f 2061            # to a
-0003bec0: 766f 6964 2075 6e6e 6563 6573 7361 7269  void unnecessari
-0003bed0: 6c79 2077 6169 7469 6e67 2066 6f72 2061  ly waiting for a
-0003bee0: 2070 6f74 656e 7469 616c 6c79 2061 7262   potentially arb
-0003bef0: 6974 7261 7269 6c79 206c 6f6e 670a 2020  itrarily long.  
-0003bf00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003bf10: 7469 6d65 2028 6465 7065 6e64 696e 6720  time (depending 
-0003bf20: 6f6e 2069 6e74 6572 7661 6c20 7365 7474  on interval sett
-0003bf30: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
-0003bf40: 2020 2020 2020 616d 6d2e 7275 6e5f 6f6e        amm.run_on
-0003bf50: 6365 2829 0a0a 2020 2020 2020 2020 2020  ce()..          
-0003bf60: 2020 2020 2020 776f 726b 6572 735f 696e        workers_in
-0003bf70: 666f 203d 2064 6963 7428 6177 6169 7420  fo = dict(await 
-0003bf80: 6173 796e 6369 6f2e 6761 7468 6572 282a  asyncio.gather(*
-0003bf90: 636f 726f 7329 290a 2020 2020 2020 2020  coros)).        
-0003bfa0: 2020 2020 2020 2020 776f 726b 6572 735f          workers_
-0003bfb0: 696e 666f 2e70 6f70 284e 6f6e 652c 204e  info.pop(None, N
-0003bfc0: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
-0003bfd0: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-0003bfe0: 2020 2020 2020 2020 2020 6966 2073 746f            if sto
-0003bff0: 705f 616d 6d3a 0a20 2020 2020 2020 2020  p_amm:.         
-0003c000: 2020 2020 2020 2020 2020 2061 6d6d 2e73             amm.s
-0003c010: 746f 7028 290a 0a20 2020 2020 2020 2073  top()..        s
-0003c020: 656c 662e 6c6f 675f 6576 656e 7428 2261  elf.log_event("a
-0003c030: 6c6c 222c 207b 2261 6374 696f 6e22 3a20  ll", {"action": 
-0003c040: 2272 6574 6972 652d 776f 726b 6572 7322  "retire-workers"
-0003c050: 2c20 2277 6f72 6b65 7273 223a 2077 6f72  , "workers": wor
-0003c060: 6b65 7273 5f69 6e66 6f7d 290a 2020 2020  kers_info}).    
-0003c070: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-0003c080: 6e74 286c 6973 7428 776f 726b 6572 735f  nt(list(workers_
-0003c090: 696e 666f 292c 207b 2261 6374 696f 6e22  info), {"action"
-0003c0a0: 3a20 2272 6574 6972 6564 227d 290a 0a20  : "retired"}).. 
-0003c0b0: 2020 2020 2020 2072 6574 7572 6e20 776f         return wo
-0003c0c0: 726b 6572 735f 696e 666f 0a0a 2020 2020  rkers_info..    
-0003c0d0: 6173 796e 6320 6465 6620 5f74 7261 636b  async def _track
-0003c0e0: 5f72 6574 6972 655f 776f 726b 6572 280a  _retire_worker(.
-0003c0f0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-0003c100: 2020 2020 2020 7773 3a20 576f 726b 6572        ws: Worker
-0003c110: 5374 6174 652c 0a20 2020 2020 2020 2070  State,.        p
-0003c120: 6f6c 6963 793a 2052 6574 6972 6557 6f72  olicy: RetireWor
-0003c130: 6b65 722c 0a20 2020 2020 2020 2070 7265  ker,.        pre
-0003c140: 765f 7374 6174 7573 3a20 5374 6174 7573  v_status: Status
-0003c150: 2c0a 2020 2020 2020 2020 636c 6f73 653a  ,.        close:
-0003c160: 2062 6f6f 6c2c 0a20 2020 2020 2020 2072   bool,.        r
-0003c170: 656d 6f76 653a 2062 6f6f 6c2c 0a20 2020  emove: bool,.   
-0003c180: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-0003c190: 3a20 7374 722c 0a20 2020 2029 202d 3e20  : str,.    ) -> 
-0003c1a0: 7475 706c 653a 2020 2320 7475 706c 655b  tuple:  # tuple[
-0003c1b0: 7374 7220 7c20 4e6f 6e65 2c20 6469 6374  str | None, dict
-0003c1c0: 5d0a 2020 2020 2020 2020 7768 696c 6520  ].        while 
-0003c1d0: 6e6f 7420 706f 6c69 6379 2e64 6f6e 6528  not policy.done(
-0003c1e0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-0003c1f0: 2053 6c65 6570 2030 2e30 3173 2077 6865   Sleep 0.01s whe
-0003c200: 6e20 7468 6572 6520 6172 6520 3420 7461  n there are 4 ta
-0003c210: 736b 7320 6f72 206c 6573 730a 2020 2020  sks or less.    
-0003c220: 2020 2020 2020 2020 2320 536c 6565 7020          # Sleep 
-0003c230: 302e 3573 2077 6865 6e20 7468 6572 6520  0.5s when there 
-0003c240: 6172 6520 3230 3020 6f72 206d 6f72 650a  are 200 or more.
-0003c250: 2020 2020 2020 2020 2020 2020 706f 6c6c              poll
-0003c260: 5f69 6e74 6572 7661 6c20 3d20 6d61 7828  _interval = max(
-0003c270: 302e 3031 2c20 6d69 6e28 302e 352c 206c  0.01, min(0.5, l
-0003c280: 656e 2877 732e 6861 735f 7768 6174 2920  en(ws.has_what) 
-0003c290: 2f20 3430 3029 290a 2020 2020 2020 2020  / 400)).        
-0003c2a0: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-0003c2b0: 6f2e 736c 6565 7028 706f 6c6c 5f69 6e74  o.sleep(poll_int
-0003c2c0: 6572 7661 6c29 0a0a 2020 2020 2020 2020  erval)..        
-0003c2d0: 6966 2070 6f6c 6963 792e 6e6f 5f72 6563  if policy.no_rec
-0003c2e0: 6970 6965 6e74 733a 0a20 2020 2020 2020  ipients:.       
-0003c2f0: 2020 2020 2023 2041 626f 7274 2072 6574       # Abort ret
-0003c300: 6972 656d 656e 742e 2054 6869 7320 7469  irement. This ti
-0003c310: 6d65 2077 6520 646f 6e27 7420 6e65 6564  me we don't need
-0003c320: 2074 6f20 776f 7272 7920 6162 6f75 7420   to worry about 
-0003c330: 7261 6365 0a20 2020 2020 2020 2020 2020  race.           
-0003c340: 2023 2063 6f6e 6469 7469 6f6e 7320 616e   # conditions an
-0003c350: 6420 7765 2063 616e 2077 6169 7420 666f  d we can wait fo
-0003c360: 7220 6120 7363 6865 6475 6c65 722d 3e77  r a scheduler->w
-0003c370: 6f72 6b65 722d 3e73 6368 6564 756c 6572  orker->scheduler
-0003c380: 0a20 2020 2020 2020 2020 2020 2023 2072  .            # r
-0003c390: 6f75 6e64 2d74 7269 702e 0a20 2020 2020  ound-trip..     
-0003c3a0: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
-0003c3b0: 616d 5f63 6f6d 6d73 5b77 732e 6164 6472  am_comms[ws.addr
-0003c3c0: 6573 735d 2e73 656e 6428 0a20 2020 2020  ess].send(.     
-0003c3d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0003c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c3f0: 2022 6f70 223a 2022 776f 726b 6572 2d73   "op": "worker-s
-0003c400: 7461 7475 732d 6368 616e 6765 222c 0a20  tatus-change",. 
-0003c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c420: 2020 2022 7374 6174 7573 223a 2070 7265     "status": pre
-0003c430: 765f 7374 6174 7573 2e6e 616d 652c 0a20  v_status.name,. 
-0003c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c450: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
-0003c460: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
-0003c470: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0003c480: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0003c490: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003c4a0: 6e20 4e6f 6e65 2c20 7b7d 0a0a 2020 2020  n None, {}..    
-0003c4b0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-0003c4c0: 280a 2020 2020 2020 2020 2020 2020 2241  (.            "A
-0003c4d0: 6c6c 2075 6e69 7175 6520 6b65 7973 206f  ll unique keys o
-0003c4e0: 6e20 776f 726b 6572 2025 7320 6861 7665  n worker %s have
-0003c4f0: 2062 6565 6e20 7265 706c 6963 6174 6564   been replicated
-0003c500: 2065 6c73 6577 6865 7265 222c 2077 732e   elsewhere", ws.
-0003c510: 6164 6472 6573 730a 2020 2020 2020 2020  address.        
-0003c520: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
-0003c530: 6d6f 7665 3a0a 2020 2020 2020 2020 2020  move:.          
-0003c540: 2020 6177 6169 7420 7365 6c66 2e72 656d    await self.rem
-0003c550: 6f76 655f 776f 726b 6572 280a 2020 2020  ove_worker(.    
-0003c560: 2020 2020 2020 2020 2020 2020 7773 2e61              ws.a
-0003c570: 6464 7265 7373 2c20 7361 6665 3d54 7275  ddress, safe=Tru
-0003c580: 652c 2063 6c6f 7365 3d63 6c6f 7365 2c20  e, close=close, 
-0003c590: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
-0003c5a0: 756c 7573 5f69 640a 2020 2020 2020 2020  ulus_id.        
-0003c5b0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-0003c5c0: 6966 2063 6c6f 7365 3a0a 2020 2020 2020  if close:.      
-0003c5d0: 2020 2020 2020 7365 6c66 2e63 6c6f 7365        self.close
-0003c5e0: 5f77 6f72 6b65 7228 7773 2e61 6464 7265  _worker(ws.addre
-0003c5f0: 7373 290a 0a20 2020 2020 2020 206c 6f67  ss)..        log
-0003c600: 6765 722e 696e 666f 2822 5265 7469 7265  ger.info("Retire
-0003c610: 6420 776f 726b 6572 2025 7322 2c20 7773  d worker %s", ws
-0003c620: 2e61 6464 7265 7373 290a 2020 2020 2020  .address).      
-0003c630: 2020 7265 7475 726e 2077 732e 6164 6472    return ws.addr
-0003c640: 6573 732c 2077 732e 6964 656e 7469 7479  ess, ws.identity
-0003c650: 2829 0a0a 2020 2020 6465 6620 6164 645f  ()..    def add_
-0003c660: 6b65 7973 280a 2020 2020 2020 2020 7365  keys(.        se
-0003c670: 6c66 2c20 776f 726b 6572 3d4e 6f6e 652c  lf, worker=None,
-0003c680: 206b 6579 733d 2829 2c20 7374 696d 756c   keys=(), stimul
-0003c690: 7573 5f69 643d 4e6f 6e65 0a20 2020 2029  us_id=None.    )
-0003c6a0: 202d 3e20 4c69 7465 7261 6c5b 224f 4b22   -> Literal["OK"
-0003c6b0: 2c20 226e 6f74 2066 6f75 6e64 225d 3a0a  , "not found"]:.
-0003c6c0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0003c6d0: 2020 2020 4c65 6172 6e20 7468 6174 2061      Learn that a
-0003c6e0: 2077 6f72 6b65 7220 6861 7320 6365 7274   worker has cert
-0003c6f0: 6169 6e20 6b65 7973 0a0a 2020 2020 2020  ain keys..      
-0003c700: 2020 5468 6973 2073 686f 756c 6420 6e6f    This should no
-0003c710: 7420 6265 2075 7365 6420 696e 2070 7261  t be used in pra
-0003c720: 6374 6963 6520 616e 6420 6973 206d 6f73  ctice and is mos
-0003c730: 746c 7920 6865 7265 2066 6f72 206c 6567  tly here for leg
-0003c740: 6163 790a 2020 2020 2020 2020 7265 6173  acy.        reas
-0003c750: 6f6e 732e 2020 486f 7765 7665 722c 2069  ons.  However, i
-0003c760: 7420 6973 2073 656e 7420 6279 2077 6f72  t is sent by wor
-0003c770: 6b65 7273 2066 726f 6d20 7469 6d65 2074  kers from time t
-0003c780: 6f20 7469 6d65 2e0a 2020 2020 2020 2020  o time..        
-0003c790: 2222 220a 2020 2020 2020 2020 6966 2077  """.        if w
-0003c7a0: 6f72 6b65 7220 6e6f 7420 696e 2073 656c  orker not in sel
-0003c7b0: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
-0003c7c0: 2020 2020 2020 2072 6574 7572 6e20 226e         return "n
-0003c7d0: 6f74 2066 6f75 6e64 220a 2020 2020 2020  ot found".      
-0003c7e0: 2020 7773 3a20 576f 726b 6572 5374 6174    ws: WorkerStat
-0003c7f0: 6520 3d20 7365 6c66 2e77 6f72 6b65 7273  e = self.workers
-0003c800: 5b77 6f72 6b65 725d 0a20 2020 2020 2020  [worker].       
-0003c810: 2072 6564 756e 6461 6e74 5f72 6570 6c69   redundant_repli
-0003c820: 6361 7320 3d20 5b5d 0a20 2020 2020 2020  cas = [].       
-0003c830: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
-0003c840: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
-0003c850: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-0003c860: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
-0003c870: 2020 2069 6620 7473 2069 7320 6e6f 7420     if ts is not 
-0003c880: 4e6f 6e65 2061 6e64 2074 732e 7374 6174  None and ts.stat
-0003c890: 6520 3d3d 2022 6d65 6d6f 7279 223a 0a20  e == "memory":. 
-0003c8a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003c8b0: 6620 7773 206e 6f74 2069 6e20 7473 2e77  f ws not in ts.w
-0003c8c0: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
-0003c8d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003c8e0: 2e61 6464 5f72 6570 6c69 6361 2874 732c  .add_replica(ts,
-0003c8f0: 2077 7329 0a20 2020 2020 2020 2020 2020   ws).           
-0003c900: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0003c910: 2020 2020 2020 2072 6564 756e 6461 6e74         redundant
-0003c920: 5f72 6570 6c69 6361 732e 6170 7065 6e64  _replicas.append
-0003c930: 286b 6579 290a 0a20 2020 2020 2020 2069  (key)..        i
-0003c940: 6620 7265 6475 6e64 616e 745f 7265 706c  f redundant_repl
-0003c950: 6963 6173 3a0a 2020 2020 2020 2020 2020  icas:.          
-0003c960: 2020 6966 206e 6f74 2073 7469 6d75 6c75    if not stimulu
-0003c970: 735f 6964 3a0a 2020 2020 2020 2020 2020  s_id:.          
-0003c980: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-0003c990: 6420 3d20 6622 7265 6475 6e64 616e 742d  d = f"redundant-
-0003c9a0: 7265 706c 6963 6173 2d7b 7469 6d65 2829  replicas-{time()
-0003c9b0: 7d22 0a20 2020 2020 2020 2020 2020 2073  }".            s
-0003c9c0: 656c 662e 776f 726b 6572 5f73 656e 6428  elf.worker_send(
-0003c9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c9e0: 2077 6f72 6b65 722c 0a20 2020 2020 2020   worker,.       
-0003c9f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0003ca00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003ca10: 6f70 223a 2022 7265 6d6f 7665 2d72 6570  op": "remove-rep
-0003ca20: 6c69 6361 7322 2c0a 2020 2020 2020 2020  licas",.        
-0003ca30: 2020 2020 2020 2020 2020 2020 226b 6579              "key
-0003ca40: 7322 3a20 7265 6475 6e64 616e 745f 7265  s": redundant_re
-0003ca50: 706c 6963 6173 2c0a 2020 2020 2020 2020  plicas,.        
-0003ca60: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-0003ca70: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-0003ca80: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-0003ca90: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-0003caa0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0003cab0: 2020 7265 7475 726e 2022 4f4b 220a 0a20    return "OK".. 
-0003cac0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-0003cad0: 2020 2064 6566 2075 7064 6174 655f 6461     def update_da
-0003cae0: 7461 280a 2020 2020 2020 2020 7365 6c66  ta(.        self
-0003caf0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-0003cb00: 2020 2020 2077 686f 5f68 6173 3a20 6469       who_has: di
-0003cb10: 6374 2c0a 2020 2020 2020 2020 6e62 7974  ct,.        nbyt
-0003cb20: 6573 3a20 6469 6374 2c0a 2020 2020 2020  es: dict,.      
-0003cb30: 2020 636c 6965 6e74 3d4e 6f6e 652c 0a20    client=None,. 
-0003cb40: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-0003cb50: 220a 2020 2020 2020 2020 4c65 6172 6e20  ".        Learn 
-0003cb60: 7468 6174 206e 6577 2064 6174 6120 6861  that new data ha
-0003cb70: 7320 656e 7465 7265 6420 7468 6520 6e65  s entered the ne
-0003cb80: 7477 6f72 6b20 6672 6f6d 2061 6e20 6578  twork from an ex
-0003cb90: 7465 726e 616c 2073 6f75 7263 650a 0a20  ternal source.. 
-0003cba0: 2020 2020 2020 2053 6565 2041 6c73 6f0a         See Also.
-0003cbb0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-0003cbc0: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
-0003cbd0: 6572 2e6d 6172 6b5f 6b65 795f 696e 5f6d  er.mark_key_in_m
-0003cbe0: 656d 6f72 790a 2020 2020 2020 2020 2222  emory.        ""
-0003cbf0: 220a 2020 2020 2020 2020 7768 6f5f 6861  ".        who_ha
-0003cc00: 7320 3d20 7b6b 3a20 5b73 656c 662e 636f  s = {k: [self.co
-0003cc10: 6572 6365 5f61 6464 7265 7373 2876 7629  erce_address(vv)
-0003cc20: 2066 6f72 2076 7620 696e 2076 5d20 666f   for vv in v] fo
-0003cc30: 7220 6b2c 2076 2069 6e20 7768 6f5f 6861  r k, v in who_ha
-0003cc40: 732e 6974 656d 7328 297d 0a20 2020 2020  s.items()}.     
-0003cc50: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-0003cc60: 2255 7064 6174 6520 6461 7461 2025 7322  "Update data %s"
-0003cc70: 2c20 7768 6f5f 6861 7329 0a0a 2020 2020  , who_has)..    
-0003cc80: 2020 2020 666f 7220 6b65 792c 2077 6f72      for key, wor
-0003cc90: 6b65 7273 2069 6e20 7768 6f5f 6861 732e  kers in who_has.
-0003cca0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0003ccb0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-0003ccc0: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-0003ccd0: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-0003cce0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0003ccf0: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-0003cd00: 6c66 2e6e 6577 5f74 6173 6b28 6b65 792c  lf.new_task(key,
-0003cd10: 204e 6f6e 652c 2022 6d65 6d6f 7279 2229   None, "memory")
-0003cd20: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
-0003cd30: 7374 6174 6520 3d20 226d 656d 6f72 7922  state = "memory"
-0003cd40: 0a20 2020 2020 2020 2020 2020 2074 735f  .            ts_
-0003cd50: 6e62 7974 6573 203d 206e 6279 7465 732e  nbytes = nbytes.
-0003cd60: 6765 7428 6b65 792c 202d 3129 0a20 2020  get(key, -1).   
-0003cd70: 2020 2020 2020 2020 2069 6620 7473 5f6e           if ts_n
-0003cd80: 6279 7465 7320 3e3d 2030 3a0a 2020 2020  bytes >= 0:.    
-0003cd90: 2020 2020 2020 2020 2020 2020 7473 2e73              ts.s
-0003cda0: 6574 5f6e 6279 7465 7328 7473 5f6e 6279  et_nbytes(ts_nby
-0003cdb0: 7465 7329 0a0a 2020 2020 2020 2020 2020  tes)..          
-0003cdc0: 2020 666f 7220 7720 696e 2077 6f72 6b65    for w in worke
-0003cdd0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-0003cde0: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
-0003cdf0: 726b 6572 735b 775d 0a20 2020 2020 2020  rkers[w].       
-0003ce00: 2020 2020 2020 2020 2069 6620 7773 206e           if ws n
-0003ce10: 6f74 2069 6e20 7473 2e77 686f 5f68 6173  ot in ts.who_has
-0003ce20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003ce30: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
-0003ce40: 6570 6c69 6361 2874 732c 2077 7329 0a20  eplica(ts, ws). 
-0003ce50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0003ce60: 7265 706f 7274 287b 226f 7022 3a20 226b  report({"op": "k
-0003ce70: 6579 2d69 6e2d 6d65 6d6f 7279 222c 2022  ey-in-memory", "
-0003ce80: 6b65 7922 3a20 6b65 792c 2022 776f 726b  key": key, "work
-0003ce90: 6572 7322 3a20 6c69 7374 2877 6f72 6b65  ers": list(worke
-0003cea0: 7273 297d 290a 0a20 2020 2020 2020 2069  rs)})..        i
-0003ceb0: 6620 636c 6965 6e74 3a0a 2020 2020 2020  f client:.      
-0003cec0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0003ced0: 745f 6465 7369 7265 735f 6b65 7973 286b  t_desires_keys(k
-0003cee0: 6579 733d 6c69 7374 2877 686f 5f68 6173  eys=list(who_has
-0003cef0: 292c 2063 6c69 656e 743d 636c 6965 6e74  ), client=client
-0003cf00: 290a 0a20 2020 2040 6f76 6572 6c6f 6164  )..    @overload
-0003cf10: 0a20 2020 2064 6566 2072 6570 6f72 745f  .    def report_
-0003cf20: 6f6e 5f6b 6579 2873 656c 662c 206b 6579  on_key(self, key
-0003cf30: 3a20 7374 722c 202a 2c20 636c 6965 6e74  : str, *, client
-0003cf40: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
-0003cf50: 6f6e 6529 202d 3e20 4e6f 6e65 3a0a 2020  one) -> None:.  
-0003cf60: 2020 2020 2020 2e2e 2e0a 0a20 2020 2040        .....    @
-0003cf70: 6f76 6572 6c6f 6164 0a20 2020 2064 6566  overload.    def
-0003cf80: 2072 6570 6f72 745f 6f6e 5f6b 6579 2873   report_on_key(s
-0003cf90: 656c 662c 202a 2c20 7473 3a20 5461 736b  elf, *, ts: Task
-0003cfa0: 5374 6174 652c 2063 6c69 656e 743a 2073  State, client: s
-0003cfb0: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-0003cfc0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0003cfd0: 2020 202e 2e2e 0a0a 2020 2020 6465 6620     .....    def 
-0003cfe0: 7265 706f 7274 5f6f 6e5f 6b65 7928 7365  report_on_key(se
-0003cff0: 6c66 2c20 6b65 793d 4e6f 6e65 2c20 2a2c  lf, key=None, *,
-0003d000: 2074 733d 4e6f 6e65 2c20 636c 6965 6e74   ts=None, client
-0003d010: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
-0003d020: 6966 2028 7473 2069 7320 4e6f 6e65 2920  if (ts is None) 
-0003d030: 3d3d 2028 6b65 7920 6973 204e 6f6e 6529  == (key is None)
-0003d040: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0003d050: 6973 6520 5661 6c75 6545 7272 6f72 2820  ise ValueError( 
-0003d060: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
-0003d070: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-0003d080: 2020 2066 2274 7320 616e 6420 6b65 7920     f"ts and key 
-0003d090: 6172 6520 6d75 7475 616c 6c79 2065 7863  are mutually exc
-0003d0a0: 6c75 7369 7665 3b20 7265 6365 6976 6564  lusive; received
-0003d0b0: 207b 6b65 793d 2172 7d2c 207b 7473 3d21   {key=!r}, {ts=!
-0003d0c0: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
-0003d0d0: 290a 2020 2020 2020 2020 6966 2074 7320  ).        if ts 
-0003d0e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0003d0f0: 2020 2020 2061 7373 6572 7420 6b65 7920       assert key 
-0003d100: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-0003d110: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0003d120: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-0003d130: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0003d140: 2020 2020 2020 2020 2020 206b 6579 203d             key =
-0003d150: 2074 732e 6b65 790a 0a20 2020 2020 2020   ts.key..       
-0003d160: 2069 6620 7473 2069 7320 6e6f 7420 4e6f   if ts is not No
-0003d170: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003d180: 7265 706f 7274 5f6d 7367 203d 205f 7461  report_msg = _ta
-0003d190: 736b 5f74 6f5f 7265 706f 7274 5f6d 7367  sk_to_report_msg
-0003d1a0: 2874 7329 0a20 2020 2020 2020 2065 6c73  (ts).        els
-0003d1b0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0003d1c0: 6570 6f72 745f 6d73 6720 3d20 7b22 6f70  eport_msg = {"op
-0003d1d0: 223a 2022 6361 6e63 656c 6c65 642d 6b65  ": "cancelled-ke
-0003d1e0: 7973 222c 2022 6b65 7973 223a 205b 6b65  ys", "keys": [ke
-0003d1f0: 795d 7d0a 2020 2020 2020 2020 6966 2072  y]}.        if r
-0003d200: 6570 6f72 745f 6d73 6720 6973 206e 6f74  eport_msg is not
-0003d210: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0003d220: 2020 2073 656c 662e 7265 706f 7274 2872     self.report(r
-0003d230: 6570 6f72 745f 6d73 672c 2074 733d 7473  eport_msg, ts=ts
-0003d240: 2c20 636c 6965 6e74 3d63 6c69 656e 7429  , client=client)
-0003d250: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-0003d260: 730a 2020 2020 6173 796e 6320 6465 6620  s.    async def 
-0003d270: 6665 6564 280a 2020 2020 2020 2020 7365  feed(.        se
-0003d280: 6c66 2c20 636f 6d6d 2c20 6675 6e63 7469  lf, comm, functi
-0003d290: 6f6e 3d4e 6f6e 652c 2073 6574 7570 3d4e  on=None, setup=N
-0003d2a0: 6f6e 652c 2074 6561 7264 6f77 6e3d 4e6f  one, teardown=No
-0003d2b0: 6e65 2c20 696e 7465 7276 616c 3d22 3173  ne, interval="1s
-0003d2c0: 222c 202a 2a6b 7761 7267 730a 2020 2020  ", **kwargs.    
-0003d2d0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-0003d2e0: 2020 2020 2020 2050 726f 7669 6465 7320         Provides 
-0003d2f0: 6120 6461 7461 2043 6f6d 6d20 746f 2065  a data Comm to e
-0003d300: 7874 6572 6e61 6c20 7265 7175 6573 7465  xternal requeste
-0003d310: 720a 0a20 2020 2020 2020 2043 6175 7469  r..        Cauti
-0003d320: 6f6e 3a20 7468 6973 2072 756e 7320 6172  on: this runs ar
-0003d330: 6269 7472 6172 7920 5079 7468 6f6e 2063  bitrary Python c
-0003d340: 6f64 6520 6f6e 2074 6865 2073 6368 6564  ode on the sched
-0003d350: 756c 6572 2e20 2054 6869 7320 7368 6f75  uler.  This shou
-0003d360: 6c64 0a20 2020 2020 2020 2065 7665 6e74  ld.        event
-0003d370: 7561 6c6c 7920 6265 2070 6861 7365 6420  ually be phased 
-0003d380: 6f75 742e 2020 4974 2069 7320 6d6f 7374  out.  It is most
-0003d390: 6c79 2075 7365 6420 6279 2064 6961 676e  ly used by diagn
-0003d3a0: 6f73 7469 6373 2e0a 2020 2020 2020 2020  ostics..        
-0003d3b0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
-0003d3c0: 6f74 2064 6173 6b2e 636f 6e66 6967 2e67  ot dask.config.g
-0003d3d0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0003d3e0: 7363 6865 6475 6c65 722e 7069 636b 6c65  scheduler.pickle
-0003d3f0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-0003d400: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
-0003d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d420: 2254 7269 6564 2074 6f20 6361 6c6c 2027  "Tried to call '
-0003d430: 6665 6564 2720 726f 7574 6520 7769 7468  feed' route with
-0003d440: 2063 7573 746f 6d20 6675 6e63 7469 6f6e   custom function
-0003d450: 732c 2062 7574 2022 0a20 2020 2020 2020  s, but ".       
-0003d460: 2020 2020 2020 2020 2022 7069 636b 6c65           "pickle
-0003d470: 2069 7320 6469 7361 6c6c 6f77 6564 2e20   is disallowed. 
-0003d480: 2053 6574 2074 6865 2027 6469 7374 7269   Set the 'distri
-0003d490: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0003d4a0: 7069 636b 6c65 2722 0a20 2020 2020 2020  pickle'".       
-0003d4b0: 2020 2020 2020 2020 2022 636f 6e66 6967           "config
-0003d4c0: 2076 616c 7565 2074 6f20 5472 7565 2074   value to True t
-0003d4d0: 6f20 7573 6520 7468 6520 2766 6565 6427  o use the 'feed'
-0003d4e0: 2072 6f75 7465 2028 7468 6973 2069 7320   route (this is 
-0003d4f0: 6d6f 7374 6c79 2022 0a20 2020 2020 2020  mostly ".       
-0003d500: 2020 2020 2020 2020 2022 636f 6d6d 6f6e           "common
-0003d510: 6c79 2075 7365 6420 7769 7468 2070 726f  ly used with pro
-0003d520: 6772 6573 7320 6261 7273 2922 0a20 2020  gress bars)".   
-0003d530: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0003d540: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-0003d550: 2020 2020 2020 2069 6e74 6572 7661 6c20         interval 
-0003d560: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
-0003d570: 6128 696e 7465 7276 616c 290a 2020 2020  a(interval).    
-0003d580: 2020 2020 6966 2066 756e 6374 696f 6e3a      if function:
-0003d590: 0a20 2020 2020 2020 2020 2020 2066 756e  .            fun
-0003d5a0: 6374 696f 6e20 3d20 7069 636b 6c65 2e6c  ction = pickle.l
-0003d5b0: 6f61 6473 2866 756e 6374 696f 6e29 0a20  oads(function). 
-0003d5c0: 2020 2020 2020 2069 6620 7365 7475 703a         if setup:
-0003d5d0: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
-0003d5e0: 7570 203d 2070 6963 6b6c 652e 6c6f 6164  up = pickle.load
-0003d5f0: 7328 7365 7475 7029 0a20 2020 2020 2020  s(setup).       
-0003d600: 2069 6620 7465 6172 646f 776e 3a0a 2020   if teardown:.  
-0003d610: 2020 2020 2020 2020 2020 7465 6172 646f            teardo
-0003d620: 776e 203d 2070 6963 6b6c 652e 6c6f 6164  wn = pickle.load
-0003d630: 7328 7465 6172 646f 776e 290a 2020 2020  s(teardown).    
-0003d640: 2020 2020 7374 6174 6520 3d20 7365 7475      state = setu
-0003d650: 7028 7365 6c66 2920 6966 2073 6574 7570  p(self) if setup
-0003d660: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
-0003d670: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
-0003d680: 6177 6169 7461 626c 6528 7374 6174 6529  awaitable(state)
-0003d690: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0003d6a0: 6174 6520 3d20 6177 6169 7420 7374 6174  ate = await stat
-0003d6b0: 650a 2020 2020 2020 2020 7472 793a 0a20  e.        try:. 
-0003d6c0: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-0003d6d0: 2073 656c 662e 7374 6174 7573 203d 3d20   self.status == 
-0003d6e0: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
-0003d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d700: 6966 2073 7461 7465 2069 7320 4e6f 6e65  if state is None
-0003d710: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003d720: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-0003d730: 2066 756e 6374 696f 6e28 7365 6c66 290a   function(self).
-0003d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d750: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0003d760: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-0003d770: 7365 203d 2066 756e 6374 696f 6e28 7365  se = function(se
-0003d780: 6c66 2c20 7374 6174 6529 0a20 2020 2020  lf, state).     
-0003d790: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0003d7a0: 2063 6f6d 6d2e 7772 6974 6528 7265 7370   comm.write(resp
-0003d7b0: 6f6e 7365 290a 2020 2020 2020 2020 2020  onse).          
-0003d7c0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-0003d7d0: 6369 6f2e 736c 6565 7028 696e 7465 7276  cio.sleep(interv
-0003d7e0: 616c 290a 2020 2020 2020 2020 6578 6365  al).        exce
-0003d7f0: 7074 204f 5345 7272 6f72 3a0a 2020 2020  pt OSError:.    
-0003d800: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0003d810: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
-0003d820: 2020 2020 2020 2020 2020 6966 2074 6561            if tea
-0003d830: 7264 6f77 6e3a 0a20 2020 2020 2020 2020  rdown:.         
-0003d840: 2020 2020 2020 2074 6561 7264 6f77 6e28         teardown(
-0003d850: 7365 6c66 2c20 7374 6174 6529 0a0a 2020  self, state)..  
-0003d860: 2020 6465 6620 6c6f 675f 776f 726b 6572    def log_worker
-0003d870: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
-0003d880: 7365 6c66 2c20 776f 726b 6572 3a20 7374  self, worker: st
-0003d890: 722c 2074 6f70 6963 3a20 7374 7220 7c20  r, topic: str | 
-0003d8a0: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d2c  Collection[str],
-0003d8b0: 206d 7367 3a20 416e 790a 2020 2020 2920   msg: Any.    ) 
-0003d8c0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0003d8d0: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
-0003d8e0: 7367 2c20 6469 6374 293a 0a20 2020 2020  sg, dict):.     
-0003d8f0: 2020 2020 2020 206d 7367 5b22 776f 726b         msg["work
-0003d900: 6572 225d 203d 2077 6f72 6b65 720a 2020  er"] = worker.  
-0003d910: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-0003d920: 7665 6e74 2874 6f70 6963 2c20 6d73 6729  vent(topic, msg)
-0003d930: 0a0a 2020 2020 6465 6620 7375 6273 6372  ..    def subscr
-0003d940: 6962 655f 776f 726b 6572 5f73 7461 7475  ibe_worker_statu
-0003d950: 7328 7365 6c66 2c20 636f 6d6d 3d4e 6f6e  s(self, comm=Non
-0003d960: 6529 3a0a 2020 2020 2020 2020 576f 726b  e):.        Work
-0003d970: 6572 5374 6174 7573 506c 7567 696e 2873  erStatusPlugin(s
-0003d980: 656c 662c 2063 6f6d 6d29 0a20 2020 2020  elf, comm).     
-0003d990: 2020 2069 6465 6e74 203d 2073 656c 662e     ident = self.
-0003d9a0: 6964 656e 7469 7479 2829 0a20 2020 2020  identity().     
-0003d9b0: 2020 2066 6f72 2076 2069 6e20 6964 656e     for v in iden
-0003d9c0: 745b 2277 6f72 6b65 7273 225d 2e76 616c  t["workers"].val
-0003d9d0: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
-0003d9e0: 2020 2064 656c 2076 5b22 6d65 7472 6963     del v["metric
-0003d9f0: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
-0003da00: 6465 6c20 765b 226c 6173 745f 7365 656e  del v["last_seen
-0003da10: 225d 0a20 2020 2020 2020 2072 6574 7572  "].        retur
-0003da20: 6e20 6964 656e 740a 0a20 2020 2064 6566  n ident..    def
-0003da30: 2067 6574 5f70 726f 6365 7373 696e 6728   get_processing(
-0003da40: 7365 6c66 2c20 776f 726b 6572 733d 4e6f  self, workers=No
-0003da50: 6e65 293a 0a20 2020 2020 2020 2069 6620  ne):.        if 
-0003da60: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-0003da70: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003da80: 2077 6f72 6b65 7273 203d 2073 6574 286d   workers = set(m
-0003da90: 6170 2873 656c 662e 636f 6572 6365 5f61  ap(self.coerce_a
-0003daa0: 6464 7265 7373 2c20 776f 726b 6572 7329  ddress, workers)
-0003dab0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0003dac0: 7475 726e 207b 773a 205b 7473 2e6b 6579  turn {w: [ts.key
-0003dad0: 2066 6f72 2074 7320 696e 2073 656c 662e   for ts in self.
-0003dae0: 776f 726b 6572 735b 775d 2e70 726f 6365  workers[w].proce
-0003daf0: 7373 696e 675d 2066 6f72 2077 2069 6e20  ssing] for w in 
-0003db00: 776f 726b 6572 737d 0a20 2020 2020 2020  workers}.       
-0003db10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0003db20: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-0003db30: 2020 2020 2020 2020 2020 2020 773a 205b              w: [
-0003db40: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
-0003db50: 2077 732e 7072 6f63 6573 7369 6e67 5d20   ws.processing] 
-0003db60: 666f 7220 772c 2077 7320 696e 2073 656c  for w, ws in sel
-0003db70: 662e 776f 726b 6572 732e 6974 656d 7328  f.workers.items(
-0003db80: 290a 2020 2020 2020 2020 2020 2020 7d0a  ).            }.
-0003db90: 0a20 2020 2064 6566 2067 6574 5f77 686f  .    def get_who
-0003dba0: 5f68 6173 2873 656c 662c 206b 6579 733a  _has(self, keys:
-0003dbb0: 2049 7465 7261 626c 655b 7374 725d 207c   Iterable[str] |
-0003dbc0: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
-0003dbd0: 2064 6963 745b 7374 722c 206c 6973 745b   dict[str, list[
-0003dbe0: 7374 725d 5d3a 0a20 2020 2020 2020 2069  str]]:.        i
-0003dbf0: 6620 6b65 7973 2069 7320 6e6f 7420 4e6f  f keys is not No
-0003dc00: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003dc10: 7265 7475 726e 207b 0a20 2020 2020 2020  return {.       
-0003dc20: 2020 2020 2020 2020 206b 6579 3a20 5b77           key: [w
-0003dc30: 732e 6164 6472 6573 7320 666f 7220 7773  s.address for ws
-0003dc40: 2069 6e20 7365 6c66 2e74 6173 6b73 5b6b   in self.tasks[k
-0003dc50: 6579 5d2e 7768 6f5f 6861 735d 0a20 2020  ey].who_has].   
-0003dc60: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003dc70: 6b65 7920 696e 2073 656c 662e 7461 736b  key in self.task
-0003dc80: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003dc90: 2020 656c 7365 205b 5d0a 2020 2020 2020    else [].      
-0003dca0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-0003dcb0: 7920 696e 206b 6579 730a 2020 2020 2020  y in keys.      
-0003dcc0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0003dcd0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0003dce0: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
-0003dcf0: 2020 2020 2020 2020 2020 206b 6579 3a20             key: 
-0003dd00: 5b77 732e 6164 6472 6573 7320 666f 7220  [ws.address for 
-0003dd10: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-0003dd20: 5d20 666f 7220 6b65 792c 2074 7320 696e  ] for key, ts in
-0003dd30: 2073 656c 662e 7461 736b 732e 6974 656d   self.tasks.item
-0003dd40: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0003dd50: 7d0a 0a20 2020 2064 6566 2067 6574 5f68  }..    def get_h
-0003dd60: 6173 5f77 6861 7428 7365 6c66 2c20 776f  as_what(self, wo
-0003dd70: 726b 6572 733d 4e6f 6e65 293a 0a20 2020  rkers=None):.   
-0003dd80: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
-0003dd90: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0003dda0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-0003ddb0: 203d 206d 6170 2873 656c 662e 636f 6572   = map(self.coer
-0003ddc0: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
-0003ddd0: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-0003dde0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
-0003ddf0: 2020 2020 2020 2020 2020 773a 205b 7473            w: [ts
-0003de00: 2e6b 6579 2066 6f72 2074 7320 696e 2073  .key for ts in s
-0003de10: 656c 662e 776f 726b 6572 735b 775d 2e68  elf.workers[w].h
-0003de20: 6173 5f77 6861 745d 0a20 2020 2020 2020  as_what].       
-0003de30: 2020 2020 2020 2020 2069 6620 7720 696e           if w in
-0003de40: 2073 656c 662e 776f 726b 6572 730a 2020   self.workers.  
-0003de50: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0003de60: 7365 205b 5d0a 2020 2020 2020 2020 2020  se [].          
-0003de70: 2020 2020 2020 666f 7220 7720 696e 2077        for w in w
-0003de80: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
-0003de90: 2020 207d 0a20 2020 2020 2020 2065 6c73     }.        els
-0003dea0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0003deb0: 6574 7572 6e20 7b77 3a20 5b74 732e 6b65  eturn {w: [ts.ke
-0003dec0: 7920 666f 7220 7473 2069 6e20 7773 2e68  y for ts in ws.h
-0003ded0: 6173 5f77 6861 745d 2066 6f72 2077 2c20  as_what] for w, 
-0003dee0: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
-0003def0: 7273 2e69 7465 6d73 2829 7d0a 0a20 2020  rs.items()}..   
-0003df00: 2064 6566 2067 6574 5f6e 636f 7265 7328   def get_ncores(
-0003df10: 7365 6c66 2c20 776f 726b 6572 733d 4e6f  self, workers=No
-0003df20: 6e65 293a 0a20 2020 2020 2020 2069 6620  ne):.        if 
-0003df30: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-0003df40: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003df50: 2077 6f72 6b65 7273 203d 206d 6170 2873   workers = map(s
-0003df60: 656c 662e 636f 6572 6365 5f61 6464 7265  elf.coerce_addre
-0003df70: 7373 2c20 776f 726b 6572 7329 0a20 2020  ss, workers).   
-0003df80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0003df90: 7b77 3a20 7365 6c66 2e77 6f72 6b65 7273  {w: self.workers
-0003dfa0: 5b77 5d2e 6e74 6872 6561 6473 2066 6f72  [w].nthreads for
-0003dfb0: 2077 2069 6e20 776f 726b 6572 7320 6966   w in workers if
-0003dfc0: 2077 2069 6e20 7365 6c66 2e77 6f72 6b65   w in self.worke
-0003dfd0: 7273 7d0a 2020 2020 2020 2020 656c 7365  rs}.        else
-0003dfe0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0003dff0: 7475 726e 207b 773a 2077 732e 6e74 6872  turn {w: ws.nthr
-0003e000: 6561 6473 2066 6f72 2077 2c20 7773 2069  eads for w, ws i
-0003e010: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e69  n self.workers.i
-0003e020: 7465 6d73 2829 7d0a 0a20 2020 2064 6566  tems()}..    def
-0003e030: 2067 6574 5f6e 636f 7265 735f 7275 6e6e   get_ncores_runn
-0003e040: 696e 6728 7365 6c66 2c20 776f 726b 6572  ing(self, worker
-0003e050: 733d 4e6f 6e65 293a 0a20 2020 2020 2020  s=None):.       
-0003e060: 206e 636f 7265 7320 3d20 7365 6c66 2e67   ncores = self.g
-0003e070: 6574 5f6e 636f 7265 7328 776f 726b 6572  et_ncores(worker
-0003e080: 733d 776f 726b 6572 7329 0a20 2020 2020  s=workers).     
-0003e090: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-0003e0a0: 2020 2020 2020 2020 773a 206e 2066 6f72          w: n for
-0003e0b0: 2077 2c20 6e20 696e 206e 636f 7265 732e   w, n in ncores.
-0003e0c0: 6974 656d 7328 2920 6966 2073 656c 662e  items() if self.
-0003e0d0: 776f 726b 6572 735b 775d 2e73 7461 7475  workers[w].statu
-0003e0e0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-0003e0f0: 696e 670a 2020 2020 2020 2020 7d0a 0a20  ing.        }.. 
-0003e100: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-0003e110: 5f63 616c 6c5f 7374 6163 6b28 7365 6c66  _call_stack(self
-0003e120: 2c20 6b65 7973 3d4e 6f6e 6529 3a0a 2020  , keys=None):.  
-0003e130: 2020 2020 2020 6966 206b 6579 7320 6973        if keys is
-0003e140: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0003e150: 2020 2020 2020 2073 7461 636b 203d 206c         stack = l
-0003e160: 6973 7428 6b65 7973 290a 2020 2020 2020  ist(keys).      
-0003e170: 2020 2020 2020 7072 6f63 6573 7369 6e67        processing
-0003e180: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-0003e190: 2020 2020 2077 6869 6c65 2073 7461 636b       while stack
-0003e1a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003e1b0: 2020 6b65 7920 3d20 7374 6163 6b2e 706f    key = stack.po
-0003e1c0: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-0003e1d0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-0003e1e0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-0003e1f0: 2020 2020 2020 2020 2069 6620 7473 2e73           if ts.s
-0003e200: 7461 7465 203d 3d20 2277 6169 7469 6e67  tate == "waiting
-0003e210: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-0003e220: 2020 2020 2020 2073 7461 636b 2e65 7874         stack.ext
-0003e230: 656e 6428 5b64 7473 2e6b 6579 2066 6f72  end([dts.key for
-0003e240: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0003e250: 6465 6e63 6965 735d 290a 2020 2020 2020  dencies]).      
-0003e260: 2020 2020 2020 2020 2020 656c 6966 2074            elif t
-0003e270: 732e 7374 6174 6520 3d3d 2022 7072 6f63  s.state == "proc
-0003e280: 6573 7369 6e67 223a 0a20 2020 2020 2020  essing":.       
-0003e290: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-0003e2a0: 6365 7373 696e 672e 6164 6428 7473 290a  cessing.add(ts).
-0003e2b0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-0003e2c0: 6b65 7273 203d 2064 6566 6175 6c74 6469  kers = defaultdi
-0003e2d0: 6374 286c 6973 7429 0a20 2020 2020 2020  ct(list).       
-0003e2e0: 2020 2020 2066 6f72 2074 7320 696e 2070       for ts in p
-0003e2f0: 726f 6365 7373 696e 673a 0a20 2020 2020  rocessing:.     
-0003e300: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0003e310: 2e70 726f 6365 7373 696e 675f 6f6e 3a0a  .processing_on:.
-0003e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e330: 2020 2020 776f 726b 6572 735b 7473 2e70      workers[ts.p
-0003e340: 726f 6365 7373 696e 675f 6f6e 2e61 6464  rocessing_on.add
-0003e350: 7265 7373 5d2e 6170 7065 6e64 2874 732e  ress].append(ts.
-0003e360: 6b65 7929 0a20 2020 2020 2020 2065 6c73  key).        els
-0003e370: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-0003e380: 6f72 6b65 7273 203d 207b 773a 204e 6f6e  orkers = {w: Non
-0003e390: 6520 666f 7220 7720 696e 2073 656c 662e  e for w in self.
-0003e3a0: 776f 726b 6572 737d 0a0a 2020 2020 2020  workers}..      
-0003e3b0: 2020 6966 206e 6f74 2077 6f72 6b65 7273    if not workers
-0003e3c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0003e3d0: 7475 726e 207b 7d0a 0a20 2020 2020 2020  turn {}..       
-0003e3e0: 2072 6573 756c 7473 203d 2061 7761 6974   results = await
-0003e3f0: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-0003e400: 0a20 2020 2020 2020 2020 2020 202a 2873  .            *(s
-0003e410: 656c 662e 7270 6328 7729 2e63 616c 6c5f  elf.rpc(w).call_
-0003e420: 7374 6163 6b28 6b65 7973 3d76 2920 666f  stack(keys=v) fo
-0003e430: 7220 772c 2076 2069 6e20 776f 726b 6572  r w, v in worker
-0003e440: 732e 6974 656d 7328 2929 0a20 2020 2020  s.items()).     
-0003e450: 2020 2029 0a20 2020 2020 2020 2072 6573     ).        res
-0003e460: 706f 6e73 6520 3d20 7b77 3a20 7220 666f  ponse = {w: r fo
-0003e470: 7220 772c 2072 2069 6e20 7a69 7028 776f  r w, r in zip(wo
-0003e480: 726b 6572 732c 2072 6573 756c 7473 2920  rkers, results) 
-0003e490: 6966 2072 7d0a 2020 2020 2020 2020 7265  if r}.        re
-0003e4a0: 7475 726e 2072 6573 706f 6e73 650a 0a20  turn response.. 
-0003e4b0: 2020 2061 7379 6e63 2064 6566 2062 656e     async def ben
-0003e4c0: 6368 6d61 726b 5f68 6172 6477 6172 6528  chmark_hardware(
-0003e4d0: 7365 6c66 2920 2d3e 2022 6469 6374 5b73  self) -> "dict[s
-0003e4e0: 7472 2c20 6469 6374 5b73 7472 2c20 666c  tr, dict[str, fl
-0003e4f0: 6f61 745d 5d22 3a0a 2020 2020 2020 2020  oat]]":.        
-0003e500: 2222 220a 2020 2020 2020 2020 5275 6e20  """.        Run 
-0003e510: 6120 6265 6e63 686d 6172 6b20 6f6e 2074  a benchmark on t
-0003e520: 6865 2077 6f72 6b65 7273 2066 6f72 206d  he workers for m
-0003e530: 656d 6f72 792c 2064 6973 6b2c 2061 6e64  emory, disk, and
-0003e540: 206e 6574 776f 726b 2062 616e 6477 6964   network bandwid
-0003e550: 7468 730a 0a20 2020 2020 2020 2052 6574  ths..        Ret
-0003e560: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
-0003e570: 2d2d 2d2d 0a20 2020 2020 2020 2072 6573  ----.        res
-0003e580: 756c 743a 2064 6963 740a 2020 2020 2020  ult: dict.      
-0003e590: 2020 2020 2020 4120 6469 6374 696f 6e61        A dictiona
-0003e5a0: 7279 206d 6170 7069 6e67 2074 6865 206e  ry mapping the n
-0003e5b0: 616d 6573 2022 6469 736b 222c 2022 6d65  ames "disk", "me
-0003e5c0: 6d6f 7279 222c 2061 6e64 2022 6e65 7477  mory", and "netw
-0003e5d0: 6f72 6b22 2074 6f0a 2020 2020 2020 2020  ork" to.        
-0003e5e0: 2020 2020 6469 6374 696f 6e61 7269 6573      dictionaries
-0003e5f0: 206d 6170 7069 6e67 2073 697a 6573 2074   mapping sizes t
-0003e600: 6f20 6261 6e64 7769 6474 6873 2e20 2054  o bandwidths.  T
-0003e610: 6865 7365 2062 616e 6477 6964 7468 7320  hese bandwidths 
-0003e620: 6172 650a 2020 2020 2020 2020 2020 2020  are.            
-0003e630: 6176 6572 6167 6564 206f 7665 7220 6d61  averaged over ma
-0003e640: 6e79 2077 6f72 6b65 7273 2072 756e 6e69  ny workers runni
-0003e650: 6e67 2063 6f6d 7075 7461 7469 6f6e 7320  ng computations 
-0003e660: 6163 726f 7373 2074 6865 2063 6c75 7374  across the clust
-0003e670: 6572 2e0a 2020 2020 2020 2020 2222 220a  er..        """.
-0003e680: 2020 2020 2020 2020 6f75 743a 2064 6963          out: dic
-0003e690: 745b 7374 722c 2064 6566 6175 6c74 6469  t[str, defaultdi
-0003e6a0: 6374 5b73 7472 2c20 6c69 7374 5b66 6c6f  ct[str, list[flo
-0003e6b0: 6174 5d5d 5d20 3d20 7b0a 2020 2020 2020  at]]] = {.      
-0003e6c0: 2020 2020 2020 6e61 6d65 3a20 6465 6661        name: defa
-0003e6d0: 756c 7464 6963 7428 6c69 7374 2920 666f  ultdict(list) fo
-0003e6e0: 7220 6e61 6d65 2069 6e20 5b22 6469 736b  r name in ["disk
-0003e6f0: 222c 2022 6d65 6d6f 7279 222c 2022 6e65  ", "memory", "ne
-0003e700: 7477 6f72 6b22 5d0a 2020 2020 2020 2020  twork"].        
-0003e710: 7d0a 0a20 2020 2020 2020 2023 2064 6973  }..        # dis
-0003e720: 6b0a 2020 2020 2020 2020 7265 7375 6c74  k.        result
-0003e730: 203d 2061 7761 6974 2073 656c 662e 6272   = await self.br
-0003e740: 6f61 6463 6173 7428 6d73 673d 7b22 6f70  oadcast(msg={"op
-0003e750: 223a 2022 6265 6e63 686d 6172 6b5f 6469  ": "benchmark_di
-0003e760: 736b 227d 290a 2020 2020 2020 2020 666f  sk"}).        fo
-0003e770: 7220 6420 696e 2072 6573 756c 742e 7661  r d in result.va
-0003e780: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-0003e790: 2020 2020 666f 7220 7369 7a65 2c20 6475      for size, du
-0003e7a0: 7261 7469 6f6e 2069 6e20 642e 6974 656d  ration in d.item
-0003e7b0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0003e7c0: 2020 2020 206f 7574 5b22 6469 736b 225d       out["disk"]
-0003e7d0: 5b73 697a 655d 2e61 7070 656e 6428 6475  [size].append(du
-0003e7e0: 7261 7469 6f6e 290a 0a20 2020 2020 2020  ration)..       
-0003e7f0: 2023 206d 656d 6f72 790a 2020 2020 2020   # memory.      
-0003e800: 2020 7265 7375 6c74 203d 2061 7761 6974    result = await
-0003e810: 2073 656c 662e 6272 6f61 6463 6173 7428   self.broadcast(
-0003e820: 6d73 673d 7b22 6f70 223a 2022 6265 6e63  msg={"op": "benc
-0003e830: 686d 6172 6b5f 6d65 6d6f 7279 227d 290a  hmark_memory"}).
-0003e840: 2020 2020 2020 2020 666f 7220 6420 696e          for d in
-0003e850: 2072 6573 756c 742e 7661 6c75 6573 2829   result.values()
-0003e860: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-0003e870: 7220 7369 7a65 2c20 6475 7261 7469 6f6e  r size, duration
-0003e880: 2069 6e20 642e 6974 656d 7328 293a 0a20   in d.items():. 
-0003e890: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0003e8a0: 7574 5b22 6d65 6d6f 7279 225d 5b73 697a  ut["memory"][siz
-0003e8b0: 655d 2e61 7070 656e 6428 6475 7261 7469  e].append(durati
-0003e8c0: 6f6e 290a 0a20 2020 2020 2020 2023 206e  on)..        # n
-0003e8d0: 6574 776f 726b 0a20 2020 2020 2020 2077  etwork.        w
-0003e8e0: 6f72 6b65 7273 203d 206c 6973 7428 7365  orkers = list(se
-0003e8f0: 6c66 2e77 6f72 6b65 7273 290a 2020 2020  lf.workers).    
-0003e900: 2020 2020 2320 4f6e 2061 6e20 6164 6170      # On an adap
-0003e910: 7469 7665 2063 6c75 7374 6572 2c20 6966  tive cluster, if
-0003e920: 206d 756c 7469 706c 6520 776f 726b 6572   multiple worker
-0003e930: 7320 6172 6520 7374 6172 7465 6420 6f6e  s are started on
-0003e940: 2074 6865 2073 616d 6520 7068 7973 6963   the same physic
-0003e950: 616c 2068 6f73 742c 0a20 2020 2020 2020  al host,.       
-0003e960: 2023 2074 6865 7920 6172 6520 6d6f 7265   # they are more
-0003e970: 206c 696b 656c 7920 746f 2063 6f6e 6e65   likely to conne
-0003e980: 6374 2074 6f20 7468 6520 5363 6865 6475  ct to the Schedu
-0003e990: 6c65 7220 696e 2073 6571 7565 6e63 652c  ler in sequence,
-0003e9a0: 2065 6e64 696e 6720 7570 206e 6578 7420   ending up next 
-0003e9b0: 746f 0a20 2020 2020 2020 2023 2065 6163  to.        # eac
-0003e9c0: 6820 6f74 6865 7220 696e 2074 6869 7320  h other in this 
-0003e9d0: 6c69 7374 2e0a 2020 2020 2020 2020 2320  list..        # 
-0003e9e0: 5468 6520 7472 616e 7366 6572 2073 7065  The transfer spe
-0003e9f0: 6564 2077 6974 6869 6e20 7375 6368 2063  ed within such c
-0003ea00: 6c75 7374 6572 7320 6f66 2077 6f72 6b65  lusters of worke
-0003ea10: 7273 2077 696c 6c20 6265 2065 6666 6563  rs will be effec
-0003ea20: 7469 7665 6c79 2074 6861 7420 6f66 0a20  tively that of. 
-0003ea30: 2020 2020 2020 2023 206c 6f63 616c 686f         # localho
-0003ea40: 7374 2e20 5468 6973 2063 6f75 6c64 2068  st. This could h
-0003ea50: 6170 7065 6e20 6163 726f 7373 2064 6966  appen across dif
-0003ea60: 6665 7265 6e74 2056 4d73 2061 6e64 2f6f  ferent VMs and/o
-0003ea70: 7220 646f 636b 6572 2069 6d61 6765 732c  r docker images,
-0003ea80: 2073 6f0a 2020 2020 2020 2020 2320 696d   so.        # im
-0003ea90: 706c 656d 656e 7469 6e67 206c 6f67 6963  plementing logic
-0003eaa0: 2062 6173 6564 206f 6e20 4950 2061 6464   based on IP add
-0003eab0: 7265 7373 6573 2077 6f75 6c64 206e 6f74  resses would not
-0003eac0: 206e 6563 6573 7361 7269 6c79 2068 656c   necessarily hel
-0003ead0: 702e 0a20 2020 2020 2020 2023 2052 616e  p..        # Ran
-0003eae0: 646f 6d69 7a65 2074 6865 2063 6f6e 6e65  domize the conne
-0003eaf0: 6374 696f 6e73 2074 6f20 6576 656e 206f  ctions to even o
-0003eb00: 7574 2074 6865 206d 6561 6e20 6d65 6173  ut the mean meas
-0003eb10: 7572 6573 2e0a 2020 2020 2020 2020 7261  ures..        ra
-0003eb20: 6e64 6f6d 2e73 6875 6666 6c65 2877 6f72  ndom.shuffle(wor
-0003eb30: 6b65 7273 290a 2020 2020 2020 2020 6675  kers).        fu
-0003eb40: 7475 7265 7320 3d20 5b0a 2020 2020 2020  tures = [.      
-0003eb50: 2020 2020 2020 7365 6c66 2e72 7063 2861        self.rpc(a
-0003eb60: 292e 6265 6e63 686d 6172 6b5f 6e65 7477  ).benchmark_netw
-0003eb70: 6f72 6b28 6164 6472 6573 733d 6229 2066  ork(address=b) f
-0003eb80: 6f72 2061 2c20 6220 696e 2070 6172 7469  or a, b in parti
-0003eb90: 7469 6f6e 2832 2c20 776f 726b 6572 7329  tion(2, workers)
-0003eba0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-0003ebb0: 2020 2072 6573 706f 6e73 6573 203d 2061     responses = a
-0003ebc0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-0003ebd0: 6865 7228 2a66 7574 7572 6573 290a 0a20  her(*futures).. 
-0003ebe0: 2020 2020 2020 2066 6f72 2064 2069 6e20         for d in 
-0003ebf0: 7265 7370 6f6e 7365 733a 0a20 2020 2020  responses:.     
-0003ec00: 2020 2020 2020 2066 6f72 2073 697a 652c         for size,
-0003ec10: 2064 7572 6174 696f 6e20 696e 2064 2e69   duration in d.i
-0003ec20: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-0003ec30: 2020 2020 2020 2020 6f75 745b 226e 6574          out["net
-0003ec40: 776f 726b 225d 5b73 697a 655d 2e61 7070  work"][size].app
-0003ec50: 656e 6428 6475 7261 7469 6f6e 290a 0a20  end(duration).. 
-0003ec60: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0003ec70: 7b7d 0a20 2020 2020 2020 2066 6f72 206d  {}.        for m
-0003ec80: 6f64 6520 696e 206f 7574 3a0a 2020 2020  ode in out:.    
-0003ec90: 2020 2020 2020 2020 7265 7375 6c74 5b6d          result[m
-0003eca0: 6f64 655d 203d 207b 0a20 2020 2020 2020  ode] = {.       
-0003ecb0: 2020 2020 2020 2020 2073 697a 653a 2073           size: s
-0003ecc0: 756d 2864 7572 6174 696f 6e73 2920 2f20  um(durations) / 
-0003ecd0: 6c65 6e28 6475 7261 7469 6f6e 7329 0a20  len(durations). 
-0003ece0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0003ecf0: 6f72 2073 697a 652c 2064 7572 6174 696f  or size, duratio
-0003ed00: 6e73 2069 6e20 6f75 745b 6d6f 6465 5d2e  ns in out[mode].
-0003ed10: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-0003ed20: 2020 2020 7d0a 0a20 2020 2020 2020 2072      }..        r
-0003ed30: 6574 7572 6e20 7265 7375 6c74 0a0a 2020  eturn result..  
-0003ed40: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-0003ed50: 2020 6465 6620 6765 745f 6e62 7974 6573    def get_nbytes
-0003ed60: 2873 656c 662c 206b 6579 733d 4e6f 6e65  (self, keys=None
-0003ed70: 2c20 7375 6d6d 6172 793d 5472 7565 293a  , summary=True):
-0003ed80: 0a20 2020 2020 2020 2069 6620 6b65 7973  .        if keys
-0003ed90: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0003eda0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-0003edb0: 203d 207b 6b3a 2073 656c 662e 7461 736b   = {k: self.task
-0003edc0: 735b 6b5d 2e6e 6279 7465 7320 666f 7220  s[k].nbytes for 
-0003edd0: 6b20 696e 206b 6579 737d 0a20 2020 2020  k in keys}.     
-0003ede0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003edf0: 2020 2020 2072 6573 756c 7420 3d20 7b6b       result = {k
-0003ee00: 3a20 7473 2e6e 6279 7465 7320 666f 7220  : ts.nbytes for 
-0003ee10: 6b2c 2074 7320 696e 2073 656c 662e 7461  k, ts in self.ta
-0003ee20: 736b 732e 6974 656d 7328 2920 6966 2074  sks.items() if t
-0003ee30: 732e 6e62 7974 6573 203e 3d20 307d 0a0a  s.nbytes >= 0}..
-0003ee40: 2020 2020 2020 2020 6966 2073 756d 6d61          if summa
-0003ee50: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0003ee60: 6f75 7420 3d20 6465 6661 756c 7464 6963  out = defaultdic
-0003ee70: 7428 6c61 6d62 6461 3a20 3029 0a20 2020  t(lambda: 0).   
-0003ee80: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
-0003ee90: 7620 696e 2072 6573 756c 742e 6974 656d  v in result.item
-0003eea0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0003eeb0: 2020 2020 206f 7574 5b6b 6579 5f73 706c       out[key_spl
-0003eec0: 6974 286b 295d 202b 3d20 760a 2020 2020  it(k)] += v.    
-0003eed0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0003eee0: 2064 6963 7428 6f75 7429 0a0a 2020 2020   dict(out)..    
-0003eef0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0003ef00: 740a 0a20 2020 2064 6566 2072 756e 5f66  t..    def run_f
-0003ef10: 756e 6374 696f 6e28 7365 6c66 2c20 636f  unction(self, co
-0003ef20: 6d6d 2c20 6675 6e63 7469 6f6e 2c20 6172  mm, function, ar
-0003ef30: 6773 3d28 292c 206b 7761 7267 733d 4e6f  gs=(), kwargs=No
-0003ef40: 6e65 2c20 7761 6974 3d54 7275 6529 3a0a  ne, wait=True):.
-0003ef50: 2020 2020 2020 2020 2222 2252 756e 2061          """Run a
-0003ef60: 2066 756e 6374 696f 6e20 7769 7468 696e   function within
-0003ef70: 2074 6869 7320 7072 6f63 6573 730a 0a20   this process.. 
-0003ef80: 2020 2020 2020 2053 6565 2041 6c73 6f0a         See Also.
-0003ef90: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-0003efa0: 0a20 2020 2020 2020 2043 6c69 656e 742e  .        Client.
-0003efb0: 7275 6e5f 6f6e 5f73 6368 6564 756c 6572  run_on_scheduler
-0003efc0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0003efd0: 2020 2020 2066 726f 6d20 6469 7374 7269       from distri
-0003efe0: 6275 7465 642e 776f 726b 6572 2069 6d70  buted.worker imp
-0003eff0: 6f72 7420 7275 6e0a 0a20 2020 2020 2020  ort run..       
-0003f000: 2069 6620 6e6f 7420 6461 736b 2e63 6f6e   if not dask.con
-0003f010: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-0003f020: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
-0003f030: 6963 6b6c 6522 293a 0a20 2020 2020 2020  ickle"):.       
-0003f040: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0003f050: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0003f060: 2020 2020 2020 2022 4361 6e6e 6f74 2072         "Cannot r
-0003f070: 756e 2066 756e 6374 696f 6e20 6173 2074  un function as t
-0003f080: 6865 2073 6368 6564 756c 6572 2068 6173  he scheduler has
-0003f090: 2062 6565 6e20 6578 706c 6963 6974 6c79   been explicitly
-0003f0a0: 2064 6973 616c 6c6f 7765 6420 6672 6f6d   disallowed from
-0003f0b0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0003f0c0: 2020 2022 6465 7365 7269 616c 697a 696e     "deserializin
-0003f0d0: 6720 6172 6269 7472 6172 7920 6279 7465  g arbitrary byte
-0003f0e0: 7374 7269 6e67 7320 7573 696e 6720 7069  strings using pi
-0003f0f0: 636b 6c65 2076 6961 2074 6865 2022 0a20  ckle via the ". 
-0003f100: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003f110: 2764 6973 7472 6962 7574 6564 2e73 6368  'distributed.sch
-0003f120: 6564 756c 6572 2e70 6963 6b6c 6527 2063  eduler.pickle' c
-0003f130: 6f6e 6669 6775 7261 7469 6f6e 2073 6574  onfiguration set
-0003f140: 7469 6e67 2e22 0a20 2020 2020 2020 2020  ting.".         
-0003f150: 2020 2029 0a20 2020 2020 2020 206b 7761     ).        kwa
-0003f160: 7267 7320 3d20 6b77 6172 6773 206f 7220  rgs = kwargs or 
-0003f170: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-0003f180: 6c6f 675f 6576 656e 7428 2261 6c6c 222c  log_event("all",
-0003f190: 207b 2261 6374 696f 6e22 3a20 2272 756e   {"action": "run
-0003f1a0: 2d66 756e 6374 696f 6e22 2c20 2266 756e  -function", "fun
-0003f1b0: 6374 696f 6e22 3a20 6675 6e63 7469 6f6e  ction": function
-0003f1c0: 7d29 0a20 2020 2020 2020 2072 6574 7572  }).        retur
-0003f1d0: 6e20 7275 6e28 7365 6c66 2c20 636f 6d6d  n run(self, comm
-0003f1e0: 2c20 6675 6e63 7469 6f6e 3d66 756e 6374  , function=funct
-0003f1f0: 696f 6e2c 2061 7267 733d 6172 6773 2c20  ion, args=args, 
-0003f200: 6b77 6172 6773 3d6b 7761 7267 732c 2077  kwargs=kwargs, w
-0003f210: 6169 743d 7761 6974 290a 0a20 2020 2064  ait=wait)..    d
-0003f220: 6566 2073 6574 5f6d 6574 6164 6174 6128  ef set_metadata(
-0003f230: 7365 6c66 2c20 6b65 7973 3a20 6c69 7374  self, keys: list
-0003f240: 5b73 7472 5d2c 2076 616c 7565 3a20 6f62  [str], value: ob
-0003f250: 6a65 6374 203d 204e 6f6e 6529 202d 3e20  ject = None) -> 
-0003f260: 4e6f 6e65 3a0a 2020 2020 2020 2020 6d65  None:.        me
-0003f270: 7461 6461 7461 203d 2073 656c 662e 7461  tadata = self.ta
-0003f280: 736b 5f6d 6574 6164 6174 610a 2020 2020  sk_metadata.    
-0003f290: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-0003f2a0: 6579 735b 3a2d 315d 3a0a 2020 2020 2020  eys[:-1]:.      
-0003f2b0: 2020 2020 2020 6966 206b 6579 206e 6f74        if key not
-0003f2c0: 2069 6e20 6d65 7461 6461 7461 206f 7220   in metadata or 
-0003f2d0: 6e6f 7420 6973 696e 7374 616e 6365 286d  not isinstance(m
-0003f2e0: 6574 6164 6174 615b 6b65 795d 2c20 2864  etadata[key], (d
-0003f2f0: 6963 742c 206c 6973 7429 293a 0a20 2020  ict, list)):.   
-0003f300: 2020 2020 2020 2020 2020 2020 206d 6574               met
-0003f310: 6164 6174 615b 6b65 795d 203d 207b 7d0a  adata[key] = {}.
-0003f320: 2020 2020 2020 2020 2020 2020 6d65 7461              meta
-0003f330: 6461 7461 203d 206d 6574 6164 6174 615b  data = metadata[
-0003f340: 6b65 795d 0a20 2020 2020 2020 206d 6574  key].        met
-0003f350: 6164 6174 615b 6b65 7973 5b2d 315d 5d20  adata[keys[-1]] 
-0003f360: 3d20 7661 6c75 650a 0a20 2020 2064 6566  = value..    def
-0003f370: 2067 6574 5f6d 6574 6164 6174 6128 7365   get_metadata(se
-0003f380: 6c66 2c20 6b65 7973 3a20 6c69 7374 5b73  lf, keys: list[s
-0003f390: 7472 5d2c 2064 6566 6175 6c74 3d6e 6f5f  tr], default=no_
-0003f3a0: 6465 6661 756c 7429 3a0a 2020 2020 2020  default):.      
-0003f3b0: 2020 6d65 7461 6461 7461 203d 2073 656c    metadata = sel
-0003f3c0: 662e 7461 736b 5f6d 6574 6164 6174 610a  f.task_metadata.
-0003f3d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0003f3e0: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
-0003f3f0: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
-0003f400: 2020 2020 2020 2020 2020 6d65 7461 6461            metada
-0003f410: 7461 203d 206d 6574 6164 6174 615b 6b65  ta = metadata[ke
-0003f420: 795d 0a20 2020 2020 2020 2020 2020 2072  y].            r
-0003f430: 6574 7572 6e20 6d65 7461 6461 7461 0a20  eturn metadata. 
-0003f440: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-0003f450: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-0003f460: 2020 2020 6966 2064 6566 6175 6c74 2021      if default !
-0003f470: 3d20 6e6f 5f64 6566 6175 6c74 3a0a 2020  = no_default:.  
-0003f480: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0003f490: 7475 726e 2064 6566 6175 6c74 0a20 2020  turn default.   
-0003f4a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0003f4b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0003f4c0: 6169 7365 0a0a 2020 2020 6465 6620 7365  aise..    def se
-0003f4d0: 745f 7265 7374 7269 6374 696f 6e73 2873  t_restrictions(s
-0003f4e0: 656c 662c 2077 6f72 6b65 723a 2064 6963  elf, worker: dic
-0003f4f0: 745b 7374 722c 2043 6f6c 6c65 6374 696f  t[str, Collectio
-0003f500: 6e5b 7374 725d 207c 2073 7472 5d29 3a0a  n[str] | str]):.
-0003f510: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
-0003f520: 2072 6573 7472 6963 7469 6f6e 7320 696e   restrictions in
-0003f530: 2077 6f72 6b65 722e 6974 656d 7328 293a   worker.items():
-0003f540: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
-0003f550: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-0003f560: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-0003f570: 2069 7369 6e73 7461 6e63 6528 7265 7374   isinstance(rest
-0003f580: 7269 6374 696f 6e73 2c20 7374 7229 3a0a  rictions, str):.
-0003f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f5a0: 7265 7374 7269 6374 696f 6e73 203d 207b  restrictions = {
-0003f5b0: 7265 7374 7269 6374 696f 6e73 7d0a 2020  restrictions}.  
-0003f5c0: 2020 2020 2020 2020 2020 7473 2e77 6f72            ts.wor
-0003f5d0: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-0003f5e0: 203d 2073 6574 2872 6573 7472 6963 7469   = set(restricti
-0003f5f0: 6f6e 7329 0a0a 2020 2020 406c 6f67 5f65  ons)..    @log_e
-0003f600: 7272 6f72 730a 2020 2020 6465 6620 6765  rrors.    def ge
-0003f610: 745f 7461 736b 5f70 7265 6669 785f 7374  t_task_prefix_st
-0003f620: 6174 6573 2873 656c 6629 3a0a 2020 2020  ates(self):.    
-0003f630: 2020 2020 7374 6174 6520 3d20 7b7d 0a0a      state = {}..
-0003f640: 2020 2020 2020 2020 666f 7220 7470 2069          for tp i
-0003f650: 6e20 7365 6c66 2e74 6173 6b5f 7072 6566  n self.task_pref
-0003f660: 6978 6573 2e76 616c 7565 7328 293a 0a20  ixes.values():. 
-0003f670: 2020 2020 2020 2020 2020 2061 6374 6976             activ
-0003f680: 655f 7374 6174 6573 203d 2074 702e 6163  e_states = tp.ac
-0003f690: 7469 7665 5f73 7461 7465 730a 2020 2020  tive_states.    
-0003f6a0: 2020 2020 2020 2020 6966 2061 6e79 280a          if any(.
-0003f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f6c0: 6163 7469 7665 5f73 7461 7465 732e 6765  active_states.ge
-0003f6d0: 7428 7329 0a20 2020 2020 2020 2020 2020  t(s).           
-0003f6e0: 2020 2020 2066 6f72 2073 2069 6e20 7b22       for s in {"
-0003f6f0: 6d65 6d6f 7279 222c 2022 6572 7265 6422  memory", "erred"
-0003f700: 2c20 2272 656c 6561 7365 6422 2c20 2270  , "released", "p
-0003f710: 726f 6365 7373 696e 6722 2c20 2277 6169  rocessing", "wai
-0003f720: 7469 6e67 227d 0a20 2020 2020 2020 2020  ting"}.         
-0003f730: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-0003f740: 2020 2020 2020 7374 6174 655b 7470 2e6e        state[tp.n
-0003f750: 616d 655d 203d 207b 0a20 2020 2020 2020  ame] = {.       
-0003f760: 2020 2020 2020 2020 2020 2020 2022 6d65               "me
-0003f770: 6d6f 7279 223a 2061 6374 6976 655f 7374  mory": active_st
-0003f780: 6174 6573 5b22 6d65 6d6f 7279 225d 2c0a  ates["memory"],.
-0003f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f7a0: 2020 2020 2265 7272 6564 223a 2061 6374      "erred": act
-0003f7b0: 6976 655f 7374 6174 6573 5b22 6572 7265  ive_states["erre
-0003f7c0: 6422 5d2c 0a20 2020 2020 2020 2020 2020  d"],.           
-0003f7d0: 2020 2020 2020 2020 2022 7265 6c65 6173           "releas
-0003f7e0: 6564 223a 2061 6374 6976 655f 7374 6174  ed": active_stat
-0003f7f0: 6573 5b22 7265 6c65 6173 6564 225d 2c0a  es["released"],.
-0003f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f810: 2020 2020 2270 726f 6365 7373 696e 6722      "processing"
-0003f820: 3a20 6163 7469 7665 5f73 7461 7465 735b  : active_states[
-0003f830: 2270 726f 6365 7373 696e 6722 5d2c 0a20  "processing"],. 
-0003f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f850: 2020 2022 7761 6974 696e 6722 3a20 6163     "waiting": ac
-0003f860: 7469 7665 5f73 7461 7465 735b 2277 6169  tive_states["wai
-0003f870: 7469 6e67 225d 2c0a 2020 2020 2020 2020  ting"],.        
-0003f880: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0003f890: 2020 2072 6574 7572 6e20 7374 6174 650a     return state.
-0003f8a0: 0a20 2020 2064 6566 2067 6574 5f74 6173  .    def get_tas
-0003f8b0: 6b5f 7374 6174 7573 2873 656c 662c 206b  k_status(self, k
-0003f8c0: 6579 733d 4e6f 6e65 293a 0a20 2020 2020  eys=None):.     
-0003f8d0: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-0003f8e0: 2020 2020 2020 2020 6b65 793a 2028 7365          key: (se
-0003f8f0: 6c66 2e74 6173 6b73 5b6b 6579 5d2e 7374  lf.tasks[key].st
-0003f900: 6174 6520 6966 206b 6579 2069 6e20 7365  ate if key in se
-0003f910: 6c66 2e74 6173 6b73 2065 6c73 6520 4e6f  lf.tasks else No
-0003f920: 6e65 2920 666f 7220 6b65 7920 696e 206b  ne) for key in k
-0003f930: 6579 730a 2020 2020 2020 2020 7d0a 0a20  eys.        }.. 
-0003f940: 2020 2064 6566 2067 6574 5f74 6173 6b5f     def get_task_
-0003f950: 7374 7265 616d 2873 656c 662c 2073 7461  stream(self, sta
-0003f960: 7274 3d4e 6f6e 652c 2073 746f 703d 4e6f  rt=None, stop=No
-0003f970: 6e65 2c20 636f 756e 743d 4e6f 6e65 293a  ne, count=None):
-0003f980: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
-0003f990: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
-0003f9a0: 7374 6963 732e 7461 736b 5f73 7472 6561  stics.task_strea
-0003f9b0: 6d20 696d 706f 7274 2054 6173 6b53 7472  m import TaskStr
-0003f9c0: 6561 6d50 6c75 6769 6e0a 0a20 2020 2020  eamPlugin..     
-0003f9d0: 2020 2069 6620 5461 736b 5374 7265 616d     if TaskStream
-0003f9e0: 506c 7567 696e 2e6e 616d 6520 6e6f 7420  Plugin.name not 
-0003f9f0: 696e 2073 656c 662e 706c 7567 696e 733a  in self.plugins:
-0003fa00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0003fa10: 662e 6164 645f 706c 7567 696e 2854 6173  f.add_plugin(Tas
-0003fa20: 6b53 7472 6561 6d50 6c75 6769 6e28 7365  kStreamPlugin(se
-0003fa30: 6c66 2929 0a0a 2020 2020 2020 2020 706c  lf))..        pl
-0003fa40: 7567 696e 203d 2073 656c 662e 706c 7567  ugin = self.plug
-0003fa50: 696e 735b 5461 736b 5374 7265 616d 506c  ins[TaskStreamPl
-0003fa60: 7567 696e 2e6e 616d 655d 0a0a 2020 2020  ugin.name]..    
-0003fa70: 2020 2020 7265 7475 726e 2070 6c75 6769      return plugi
-0003fa80: 6e2e 636f 6c6c 6563 7428 7374 6172 743d  n.collect(start=
-0003fa90: 7374 6172 742c 2073 746f 703d 7374 6f70  start, stop=stop
-0003faa0: 2c20 636f 756e 743d 636f 756e 7429 0a0a  , count=count)..
-0003fab0: 2020 2020 6465 6620 7374 6172 745f 7461      def start_ta
-0003fac0: 736b 5f6d 6574 6164 6174 6128 7365 6c66  sk_metadata(self
-0003fad0: 2c20 6e61 6d65 3d4e 6f6e 6529 3a0a 2020  , name=None):.  
-0003fae0: 2020 2020 2020 706c 7567 696e 203d 2043        plugin = C
-0003faf0: 6f6c 6c65 6374 5461 736b 4d65 7461 4461  ollectTaskMetaDa
-0003fb00: 7461 506c 7567 696e 2873 6368 6564 756c  taPlugin(schedul
-0003fb10: 6572 3d73 656c 662c 206e 616d 653d 6e61  er=self, name=na
-0003fb20: 6d65 290a 2020 2020 2020 2020 7365 6c66  me).        self
-0003fb30: 2e61 6464 5f70 6c75 6769 6e28 706c 7567  .add_plugin(plug
-0003fb40: 696e 290a 0a20 2020 2064 6566 2073 746f  in)..    def sto
-0003fb50: 705f 7461 736b 5f6d 6574 6164 6174 6128  p_task_metadata(
-0003fb60: 7365 6c66 2c20 6e61 6d65 3d4e 6f6e 6529  self, name=None)
-0003fb70: 3a0a 2020 2020 2020 2020 706c 7567 696e  :.        plugin
-0003fb80: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-0003fb90: 2020 700a 2020 2020 2020 2020 2020 2020    p.            
-0003fba0: 666f 7220 7020 696e 206c 6973 7428 7365  for p in list(se
-0003fbb0: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
-0003fbc0: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
-0003fbd0: 2069 6620 6973 696e 7374 616e 6365 2870   if isinstance(p
-0003fbe0: 2c20 436f 6c6c 6563 7454 6173 6b4d 6574  , CollectTaskMet
-0003fbf0: 6144 6174 6150 6c75 6769 6e29 2061 6e64  aDataPlugin) and
-0003fc00: 2070 2e6e 616d 6520 3d3d 206e 616d 650a   p.name == name.
-0003fc10: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-0003fc20: 2020 6966 206c 656e 2870 6c75 6769 6e73    if len(plugins
-0003fc30: 2920 213d 2031 3a0a 2020 2020 2020 2020  ) != 1:.        
-0003fc40: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-0003fc50: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0003fc60: 2020 2020 2020 2245 7870 6563 7465 6420        "Expected 
-0003fc70: 746f 2066 696e 6420 6578 6163 746c 7920  to find exactly 
-0003fc80: 6f6e 6520 436f 6c6c 6563 7454 6173 6b4d  one CollectTaskM
-0003fc90: 6574 6144 6174 6150 6c75 6769 6e20 220a  etaDataPlugin ".
-0003fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fcb0: 6622 7769 7468 206e 616d 6520 7b6e 616d  f"with name {nam
-0003fcc0: 657d 2062 7574 2066 6f75 6e64 207b 6c65  e} but found {le
-0003fcd0: 6e28 706c 7567 696e 7329 7d2e 220a 2020  n(plugins)}.".  
-0003fce0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0003fcf0: 2020 2020 2070 6c75 6769 6e20 3d20 706c       plugin = pl
-0003fd00: 7567 696e 735b 305d 0a20 2020 2020 2020  ugins[0].       
-0003fd10: 2073 656c 662e 7265 6d6f 7665 5f70 6c75   self.remove_plu
-0003fd20: 6769 6e28 6e61 6d65 3d70 6c75 6769 6e2e  gin(name=plugin.
-0003fd30: 6e61 6d65 290a 2020 2020 2020 2020 7265  name).        re
-0003fd40: 7475 726e 207b 226d 6574 6164 6174 6122  turn {"metadata"
-0003fd50: 3a20 706c 7567 696e 2e6d 6574 6164 6174  : plugin.metadat
-0003fd60: 612c 2022 7374 6174 6522 3a20 706c 7567  a, "state": plug
-0003fd70: 696e 2e73 7461 7465 7d0a 0a20 2020 2061  in.state}..    a
-0003fd80: 7379 6e63 2064 6566 2072 6567 6973 7465  sync def registe
-0003fd90: 725f 776f 726b 6572 5f70 6c75 6769 6e28  r_worker_plugin(
-0003fda0: 7365 6c66 2c20 636f 6d6d 2c20 706c 7567  self, comm, plug
-0003fdb0: 696e 2c20 6e61 6d65 3d4e 6f6e 6529 3a0a  in, name=None):.
-0003fdc0: 2020 2020 2020 2020 2222 2252 6567 6973          """Regis
-0003fdd0: 7465 7273 2061 2077 6f72 6b65 7220 706c  ters a worker pl
-0003fde0: 7567 696e 206f 6e20 616c 6c20 7275 6e6e  ugin on all runn
-0003fdf0: 696e 6720 616e 6420 6675 7475 7265 2077  ing and future w
-0003fe00: 6f72 6b65 7273 2222 220a 2020 2020 2020  orkers""".      
-0003fe10: 2020 7365 6c66 2e77 6f72 6b65 725f 706c    self.worker_pl
-0003fe20: 7567 696e 735b 6e61 6d65 5d20 3d20 706c  ugins[name] = pl
-0003fe30: 7567 696e 0a0a 2020 2020 2020 2020 7265  ugin..        re
-0003fe40: 7370 6f6e 7365 7320 3d20 6177 6169 7420  sponses = await 
-0003fe50: 7365 6c66 2e62 726f 6164 6361 7374 280a  self.broadcast(.
-0003fe60: 2020 2020 2020 2020 2020 2020 6d73 673d              msg=
-0003fe70: 6469 6374 286f 703d 2270 6c75 6769 6e2d  dict(op="plugin-
-0003fe80: 6164 6422 2c20 706c 7567 696e 3d70 6c75  add", plugin=plu
-0003fe90: 6769 6e2c 206e 616d 653d 6e61 6d65 290a  gin, name=name).
-0003fea0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0003feb0: 2020 7265 7475 726e 2072 6573 706f 6e73    return respons
-0003fec0: 6573 0a0a 2020 2020 6173 796e 6320 6465  es..    async de
-0003fed0: 6620 756e 7265 6769 7374 6572 5f77 6f72  f unregister_wor
-0003fee0: 6b65 725f 706c 7567 696e 2873 656c 662c  ker_plugin(self,
-0003fef0: 2063 6f6d 6d2c 206e 616d 6529 3a0a 2020   comm, name):.  
-0003ff00: 2020 2020 2020 2222 2255 6e72 6567 6973        """Unregis
-0003ff10: 7465 7273 2061 2077 6f72 6b65 7220 706c  ters a worker pl
-0003ff20: 7567 696e 2222 220a 2020 2020 2020 2020  ugin""".        
-0003ff30: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0003ff40: 2073 656c 662e 776f 726b 6572 5f70 6c75   self.worker_plu
-0003ff50: 6769 6e73 2e70 6f70 286e 616d 6529 0a20  gins.pop(name). 
-0003ff60: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-0003ff70: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-0003ff80: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-0003ff90: 7272 6f72 2866 2254 6865 2077 6f72 6b65  rror(f"The worke
-0003ffa0: 7220 706c 7567 696e 207b 6e61 6d65 7d20  r plugin {name} 
-0003ffb0: 646f 6573 206e 6f74 2065 7869 7374 2229  does not exist")
-0003ffc0: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
-0003ffd0: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
-0003ffe0: 2e62 726f 6164 6361 7374 286d 7367 3d64  .broadcast(msg=d
-0003fff0: 6963 7428 6f70 3d22 706c 7567 696e 2d72  ict(op="plugin-r
-00040000: 656d 6f76 6522 2c20 6e61 6d65 3d6e 616d  emove", name=nam
-00040010: 6529 290a 2020 2020 2020 2020 7265 7475  e)).        retu
-00040020: 726e 2072 6573 706f 6e73 6573 0a0a 2020  rn responses..  
-00040030: 2020 6173 796e 6320 6465 6620 7265 6769    async def regi
-00040040: 7374 6572 5f6e 616e 6e79 5f70 6c75 6769  ster_nanny_plugi
-00040050: 6e28 7365 6c66 2c20 636f 6d6d 2c20 706c  n(self, comm, pl
-00040060: 7567 696e 2c20 6e61 6d65 3d4e 6f6e 6529  ugin, name=None)
-00040070: 3a0a 2020 2020 2020 2020 2222 2252 6567  :.        """Reg
-00040080: 6973 7465 7273 2061 2073 6574 7570 2066  isters a setup f
-00040090: 756e 6374 696f 6e2c 2061 6e64 2063 616c  unction, and cal
-000400a0: 6c20 6974 206f 6e20 6576 6572 7920 776f  l it on every wo
-000400b0: 726b 6572 2222 220a 2020 2020 2020 2020  rker""".        
-000400c0: 7365 6c66 2e6e 616e 6e79 5f70 6c75 6769  self.nanny_plugi
-000400d0: 6e73 5b6e 616d 655d 203d 2070 6c75 6769  ns[name] = plugi
-000400e0: 6e0a 0a20 2020 2020 2020 2072 6573 706f  n..        respo
-000400f0: 6e73 6573 203d 2061 7761 6974 2073 656c  nses = await sel
-00040100: 662e 6272 6f61 6463 6173 7428 0a20 2020  f.broadcast(.   
-00040110: 2020 2020 2020 2020 206d 7367 3d64 6963           msg=dic
-00040120: 7428 6f70 3d22 706c 7567 696e 5f61 6464  t(op="plugin_add
-00040130: 222c 2070 6c75 6769 6e3d 706c 7567 696e  ", plugin=plugin
-00040140: 2c20 6e61 6d65 3d6e 616d 6529 2c0a 2020  , name=name),.  
-00040150: 2020 2020 2020 2020 2020 6e61 6e6e 793d            nanny=
-00040160: 5472 7565 2c0a 2020 2020 2020 2020 290a  True,.        ).
-00040170: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00040180: 6573 706f 6e73 6573 0a0a 2020 2020 6173  esponses..    as
-00040190: 796e 6320 6465 6620 756e 7265 6769 7374  ync def unregist
-000401a0: 6572 5f6e 616e 6e79 5f70 6c75 6769 6e28  er_nanny_plugin(
-000401b0: 7365 6c66 2c20 636f 6d6d 2c20 6e61 6d65  self, comm, name
-000401c0: 293a 0a20 2020 2020 2020 2022 2222 556e  ):.        """Un
-000401d0: 7265 6769 7374 6572 7320 6120 776f 726b  registers a work
-000401e0: 6572 2070 6c75 6769 6e22 2222 0a20 2020  er plugin""".   
-000401f0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00040200: 2020 2020 2020 7365 6c66 2e6e 616e 6e79        self.nanny
-00040210: 5f70 6c75 6769 6e73 2e70 6f70 286e 616d  _plugins.pop(nam
-00040220: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
-00040230: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
-00040240: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00040250: 6c75 6545 7272 6f72 2866 2254 6865 206e  lueError(f"The n
-00040260: 616e 6e79 2070 6c75 6769 6e20 7b6e 616d  anny plugin {nam
-00040270: 657d 2064 6f65 7320 6e6f 7420 6578 6973  e} does not exis
-00040280: 7422 290a 0a20 2020 2020 2020 2072 6573  t")..        res
-00040290: 706f 6e73 6573 203d 2061 7761 6974 2073  ponses = await s
-000402a0: 656c 662e 6272 6f61 6463 6173 7428 0a20  elf.broadcast(. 
-000402b0: 2020 2020 2020 2020 2020 206d 7367 3d64             msg=d
-000402c0: 6963 7428 6f70 3d22 706c 7567 696e 5f72  ict(op="plugin_r
-000402d0: 656d 6f76 6522 2c20 6e61 6d65 3d6e 616d  emove", name=nam
-000402e0: 6529 2c20 6e61 6e6e 793d 5472 7565 0a20  e), nanny=True. 
-000402f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00040300: 2072 6574 7572 6e20 7265 7370 6f6e 7365   return response
-00040310: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
-00040320: 6974 696f 6e28 0a20 2020 2020 2020 2073  ition(.        s
-00040330: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
-00040340: 3a20 7374 722c 0a20 2020 2020 2020 2066  : str,.        f
-00040350: 696e 6973 683a 2054 6173 6b53 7461 7465  inish: TaskState
-00040360: 5374 6174 652c 0a20 2020 2020 2020 2073  State,.        s
-00040370: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
-00040380: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-00040390: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
-000403a0: 2052 6563 733a 0a20 2020 2020 2020 2022   Recs:.        "
-000403b0: 2222 5472 616e 7369 7469 6f6e 2061 206b  ""Transition a k
-000403c0: 6579 2066 726f 6d20 6974 7320 6375 7272  ey from its curr
-000403d0: 656e 7420 7374 6174 6520 746f 2074 6865  ent state to the
-000403e0: 2066 696e 6973 6820 7374 6174 650a 0a20   finish state.. 
-000403f0: 2020 2020 2020 2045 7861 6d70 6c65 730a         Examples.
-00040400: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00040410: 0a20 2020 2020 2020 203e 3e3e 2073 656c  .        >>> sel
-00040420: 662e 7472 616e 7369 7469 6f6e 2827 7827  f.transition('x'
-00040430: 2c20 2777 6169 7469 6e67 2729 0a20 2020  , 'waiting').   
-00040440: 2020 2020 207b 2778 273a 2027 7072 6f63       {'x': 'proc
-00040450: 6573 7369 6e67 277d 0a0a 2020 2020 2020  essing'}..      
-00040460: 2020 5265 7475 726e 730a 2020 2020 2020    Returns.      
-00040470: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 2020    -------.      
-00040480: 2020 4469 6374 696f 6e61 7279 206f 6620    Dictionary of 
-00040490: 7265 636f 6d6d 656e 6461 7469 6f6e 7320  recommendations 
-000404a0: 666f 7220 6675 7475 7265 2074 7261 6e73  for future trans
-000404b0: 6974 696f 6e73 0a0a 2020 2020 2020 2020  itions..        
-000404c0: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
-000404d0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
-000404e0: 2020 5363 6865 6475 6c65 722e 7472 616e    Scheduler.tran
-000404f0: 7369 7469 6f6e 733a 2074 7261 6e73 6974  sitions: transit
-00040500: 6976 6520 7665 7273 696f 6e20 6f66 2074  ive version of t
-00040510: 6869 7320 6675 6e63 7469 6f6e 0a20 2020  his function.   
-00040520: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00040530: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00040540: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
-00040550: 6f72 6b65 725f 6d73 6773 203d 2073 656c  orker_msgs = sel
-00040560: 662e 5f74 7261 6e73 6974 696f 6e28 0a20  f._transition(. 
-00040570: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
-00040580: 6669 6e69 7368 2c20 7374 696d 756c 7573  finish, stimulus
-00040590: 5f69 642c 202a 2a6b 7761 7267 730a 2020  _id, **kwargs.  
-000405a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000405b0: 7365 6c66 2e73 656e 645f 616c 6c28 636c  self.send_all(cl
-000405c0: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-000405d0: 725f 6d73 6773 290a 2020 2020 2020 2020  r_msgs).        
-000405e0: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
-000405f0: 6174 696f 6e73 0a0a 2020 2020 6465 6620  ations..    def 
-00040600: 7472 616e 7369 7469 6f6e 7328 7365 6c66  transitions(self
-00040610: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
-00040620: 733a 2052 6563 732c 2073 7469 6d75 6c75  s: Recs, stimulu
-00040630: 735f 6964 3a20 7374 7229 202d 3e20 4e6f  s_id: str) -> No
-00040640: 6e65 3a0a 2020 2020 2020 2020 2222 2250  ne:.        """P
-00040650: 726f 6365 7373 2074 7261 6e73 6974 696f  rocess transitio
-00040660: 6e73 2075 6e74 696c 206e 6f6e 6520 6172  ns until none ar
-00040670: 6520 6c65 6674 0a0a 2020 2020 2020 2020  e left..        
-00040680: 5468 6973 2069 6e63 6c75 6465 7320 6665  This includes fe
-00040690: 6564 6261 636b 2066 726f 6d20 7072 6576  edback from prev
-000406a0: 696f 7573 2074 7261 6e73 6974 696f 6e73  ious transitions
-000406b0: 2061 6e64 2063 6f6e 7469 6e75 6573 2075   and continues u
-000406c0: 6e74 696c 2077 650a 2020 2020 2020 2020  ntil we.        
-000406d0: 7265 6163 6820 6120 7374 6561 6479 2073  reach a steady s
-000406e0: 7461 7465 0a20 2020 2020 2020 2022 2222  tate.        """
-000406f0: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
-00040700: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
-00040710: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-00040720: 7367 733a 204d 7367 7320 3d20 7b7d 0a20  sgs: Msgs = {}. 
-00040730: 2020 2020 2020 2073 656c 662e 5f74 7261         self._tra
-00040740: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
-00040750: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-00040760: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-00040770: 6773 2c20 7374 696d 756c 7573 5f69 6429  gs, stimulus_id)
-00040780: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
-00040790: 6e64 5f61 6c6c 2863 6c69 656e 745f 6d73  nd_all(client_ms
-000407a0: 6773 2c20 776f 726b 6572 5f6d 7367 7329  gs, worker_msgs)
-000407b0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-000407c0: 6765 745f 7374 6f72 7928 7365 6c66 2c20  get_story(self, 
-000407d0: 6b65 7973 5f6f 725f 7374 696d 756c 693a  keys_or_stimuli:
-000407e0: 2049 7465 7261 626c 655b 7374 725d 2920   Iterable[str]) 
-000407f0: 2d3e 206c 6973 745b 5472 616e 7369 7469  -> list[Transiti
-00040800: 6f6e 5d3a 0a20 2020 2020 2020 2022 2222  on]:.        """
-00040810: 5250 4320 686f 6f6b 2066 6f72 203a 6d65  RPC hook for :me
-00040820: 7468 3a60 5363 6865 6475 6c65 7253 7461  th:`SchedulerSta
-00040830: 7465 2e73 746f 7279 602e 0a0a 2020 2020  te.story`...    
-00040840: 2020 2020 4e6f 7465 2074 6861 7420 7468      Note that th
-00040850: 6520 6d73 6770 6163 6b20 7365 7269 616c  e msgpack serial
-00040860: 697a 6174 696f 6e2f 6465 7365 7269 616c  ization/deserial
-00040870: 697a 6174 696f 6e20 726f 756e 642d 7472  ization round-tr
-00040880: 6970 2077 696c 6c20 7472 616e 7366 6f72  ip will transfor
-00040890: 6d0a 2020 2020 2020 2020 7468 6520 3a63  m.        the :c
-000408a0: 6c61 7373 3a60 5472 616e 7369 7469 6f6e  lass:`Transition
-000408b0: 6020 6e61 6d65 6474 7570 6c65 7320 696e  ` namedtuples in
-000408c0: 746f 2072 6567 756c 6172 2074 7570 6c65  to regular tuple
-000408d0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-000408e0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000408f0: 6c66 2e73 746f 7279 282a 6b65 7973 5f6f  lf.story(*keys_o
-00040900: 725f 7374 696d 756c 6929 0a0a 2020 2020  r_stimuli)..    
-00040910: 6465 6620 5f72 6573 6368 6564 756c 6528  def _reschedule(
-00040920: 0a20 2020 2020 2020 2073 656c 662c 206b  .        self, k
-00040930: 6579 3a20 7374 722c 2077 6f72 6b65 723a  ey: str, worker:
-00040940: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
-00040950: 6e65 2c20 2a2c 2073 7469 6d75 6c75 735f  ne, *, stimulus_
-00040960: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-00040970: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00040980: 2222 5265 7363 6865 6475 6c65 2061 2074  ""Reschedule a t
-00040990: 6173 6b2e 0a0a 2020 2020 2020 2020 5468  ask...        Th
-000409a0: 6973 2066 756e 6374 696f 6e20 7368 6f75  is function shou
-000409b0: 6c64 206f 6e6c 7920 6265 2075 7365 6420  ld only be used 
-000409c0: 7768 656e 2074 6865 2074 6173 6b20 6861  when the task ha
-000409d0: 7320 616c 7265 6164 7920 6265 656e 2072  s already been r
-000409e0: 656c 6561 7365 6420 696e 0a20 2020 2020  eleased in.     
-000409f0: 2020 2073 6f6d 6520 7761 7920 6f6e 2074     some way on t
-00040a00: 6865 2077 6f72 6b65 7220 6974 2773 2061  he worker it's a
-00040a10: 7373 6967 6e65 6420 746f 20e2 8094 2065  ssigned to ... e
-00040a20: 6974 6865 7220 7669 6120 6361 6e63 656c  ither via cancel
-00040a30: 6c61 7469 6f6e 206f 7220 610a 2020 2020  lation or a.    
-00040a40: 2020 2020 5265 7363 6865 6475 6c65 2065      Reschedule e
-00040a50: 7863 6570 7469 6f6e 20e2 8094 2061 6e64  xception ... and
-00040a60: 2079 6f75 2061 7265 2063 6572 7461 696e   you are certain
-00040a70: 2074 6865 2077 6f72 6b65 7220 7769 6c6c   the worker will
-00040a80: 206e 6f74 2073 656e 6420 616e 7920 6675   not send any fu
-00040a90: 7274 6865 720a 2020 2020 2020 2020 7570  rther.        up
-00040aa0: 6461 7465 7320 6162 6f75 7420 7468 6520  dates about the 
-00040ab0: 7461 736b 2074 6f20 7468 6520 7363 6865  task to the sche
-00040ac0: 6475 6c65 722e 0a20 2020 2020 2020 2022  duler..        "
-00040ad0: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
-00040ae0: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-00040af0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00040b00: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00040b10: 4b65 7945 7272 6f72 3a0a 2020 2020 2020  KeyError:.      
-00040b20: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
-00040b30: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
-00040b40: 2020 2020 2020 6622 4174 7465 6d70 7469        f"Attempti
-00040b50: 6e67 2074 6f20 7265 7363 6865 6475 6c65  ng to reschedule
-00040b60: 2074 6173 6b20 7b6b 6579 7d2c 2077 6869   task {key}, whi
-00040b70: 6368 2077 6173 206e 6f74 2022 0a20 2020  ch was not ".   
-00040b80: 2020 2020 2020 2020 2020 2020 2022 666f               "fo
-00040b90: 756e 6420 6f6e 2074 6865 2073 6368 6564  und on the sched
-00040ba0: 756c 6572 2e20 4162 6f72 7469 6e67 2072  uler. Aborting r
-00040bb0: 6573 6368 6564 756c 652e 220a 2020 2020  eschedule.".    
-00040bc0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00040bd0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00040be0: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-00040bf0: 2021 3d20 2270 726f 6365 7373 696e 6722   != "processing"
-00040c00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00040c10: 7475 726e 0a20 2020 2020 2020 2069 6620  turn.        if 
-00040c20: 776f 726b 6572 2061 6e64 2074 732e 7072  worker and ts.pr
-00040c30: 6f63 6573 7369 6e67 5f6f 6e20 616e 6420  ocessing_on and 
-00040c40: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00040c50: 2e61 6464 7265 7373 2021 3d20 776f 726b  .address != work
-00040c60: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-00040c70: 7265 7475 726e 0a20 2020 2020 2020 2023  return.        #
-00040c80: 2074 7261 6e73 6974 696f 6e5f 7072 6f63   transition_proc
-00040c90: 6573 7369 6e67 5f72 656c 6561 7365 6420  essing_released 
-00040ca0: 7769 6c6c 2069 6d6d 6564 6961 7465 6c79  will immediately
-00040cb0: 2073 7567 6765 7374 2061 6e20 6164 6469   suggest an addi
-00040cc0: 7469 6f6e 616c 0a20 2020 2020 2020 2023  tional.        #
-00040cd0: 2074 7261 6e73 6974 696f 6e20 746f 2077   transition to w
-00040ce0: 6169 7469 6e67 2069 6620 7468 6520 7461  aiting if the ta
-00040cf0: 736b 2068 6173 2061 6e79 2077 6169 7465  sk has any waite
-00040d00: 7273 206f 7220 636c 6965 6e74 7320 686f  rs or clients ho
-00040d10: 6c64 696e 6720 6120 6675 7475 7265 2e0a  lding a future..
-00040d20: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
-00040d30: 6e73 6974 696f 6e73 287b 6b65 793a 2022  nsitions({key: "
-00040d40: 7265 6c65 6173 6564 227d 2c20 7374 696d  released"}, stim
-00040d50: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-00040d60: 5f69 6429 0a0a 2020 2020 2323 2323 2323  _id)..    ######
-00040d70: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00040d80: 2020 2020 2320 5574 696c 6974 7920 6675      # Utility fu
-00040d90: 6e63 7469 6f6e 7320 230a 2020 2020 2323  nctions #.    ##
-00040da0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00040db0: 2323 230a 0a20 2020 2064 6566 2061 6464  ###..    def add
-00040dc0: 5f72 6573 6f75 7263 6573 2873 656c 662c  _resources(self,
-00040dd0: 2077 6f72 6b65 723a 2073 7472 2c20 7265   worker: str, re
-00040de0: 736f 7572 6365 733d 4e6f 6e65 293a 0a20  sources=None):. 
-00040df0: 2020 2020 2020 2077 733a 2057 6f72 6b65         ws: Worke
-00040e00: 7253 7461 7465 203d 2073 656c 662e 776f  rState = self.wo
-00040e10: 726b 6572 735b 776f 726b 6572 5d0a 2020  rkers[worker].  
-00040e20: 2020 2020 2020 6966 2072 6573 6f75 7263        if resourc
-00040e30: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00040e40: 7773 2e72 6573 6f75 7263 6573 2e75 7064  ws.resources.upd
-00040e50: 6174 6528 7265 736f 7572 6365 7329 0a20  ate(resources). 
-00040e60: 2020 2020 2020 2077 732e 7573 6564 5f72         ws.used_r
-00040e70: 6573 6f75 7263 6573 203d 207b 7d0a 2020  esources = {}.  
-00040e80: 2020 2020 2020 666f 7220 7265 736f 7572        for resour
-00040e90: 6365 2c20 7175 616e 7469 7479 2069 6e20  ce, quantity in 
-00040ea0: 7773 2e72 6573 6f75 7263 6573 2e69 7465  ws.resources.ite
-00040eb0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00040ec0: 2020 7773 2e75 7365 645f 7265 736f 7572    ws.used_resour
-00040ed0: 6365 735b 7265 736f 7572 6365 5d20 3d20  ces[resource] = 
-00040ee0: 300a 2020 2020 2020 2020 2020 2020 6472  0.            dr
-00040ef0: 203d 2073 656c 662e 7265 736f 7572 6365   = self.resource
-00040f00: 732e 6765 7428 7265 736f 7572 6365 2c20  s.get(resource, 
-00040f10: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
-00040f20: 2020 6966 2064 7220 6973 204e 6f6e 653a    if dr is None:
-00040f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040f40: 2073 656c 662e 7265 736f 7572 6365 735b   self.resources[
-00040f50: 7265 736f 7572 6365 5d20 3d20 6472 203d  resource] = dr =
-00040f60: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-00040f70: 6472 5b77 6f72 6b65 725d 203d 2071 7561  dr[worker] = qua
-00040f80: 6e74 6974 790a 2020 2020 2020 2020 7265  ntity.        re
-00040f90: 7475 726e 2022 4f4b 220a 0a20 2020 2064  turn "OK"..    d
-00040fa0: 6566 2072 656d 6f76 655f 7265 736f 7572  ef remove_resour
-00040fb0: 6365 7328 7365 6c66 2c20 776f 726b 6572  ces(self, worker
-00040fc0: 293a 0a20 2020 2020 2020 2077 733a 2057  ):.        ws: W
-00040fd0: 6f72 6b65 7253 7461 7465 203d 2073 656c  orkerState = sel
-00040fe0: 662e 776f 726b 6572 735b 776f 726b 6572  f.workers[worker
-00040ff0: 5d0a 2020 2020 2020 2020 666f 7220 7265  ].        for re
-00041000: 736f 7572 6365 2069 6e20 7773 2e72 6573  source in ws.res
-00041010: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
-00041020: 2020 2020 6472 3a20 6469 6374 203d 2073      dr: dict = s
-00041030: 656c 662e 7265 736f 7572 6365 732e 6765  elf.resources.ge
-00041040: 7428 7265 736f 7572 6365 2c20 4e6f 6e65  t(resource, None
-00041050: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00041060: 2064 7220 6973 204e 6f6e 653a 0a20 2020   dr is None:.   
-00041070: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00041080: 662e 7265 736f 7572 6365 735b 7265 736f  f.resources[reso
-00041090: 7572 6365 5d20 3d20 6472 203d 207b 7d0a  urce] = dr = {}.
-000410a0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-000410b0: 6472 5b77 6f72 6b65 725d 0a0a 2020 2020  dr[worker]..    
-000410c0: 6465 6620 636f 6572 6365 5f61 6464 7265  def coerce_addre
-000410d0: 7373 2873 656c 662c 2061 6464 722c 2072  ss(self, addr, r
-000410e0: 6573 6f6c 7665 3d54 7275 6529 3a0a 2020  esolve=True):.  
-000410f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00041100: 2020 436f 6572 6365 2070 6f73 7369 626c    Coerce possibl
-00041110: 6520 696e 7075 7420 6164 6472 6573 7365  e input addresse
-00041120: 7320 746f 2063 616e 6f6e 6963 616c 2066  s to canonical f
-00041130: 6f72 6d2e 0a20 2020 2020 2020 202a 7265  orm..        *re
-00041140: 736f 6c76 652a 2063 616e 2062 6520 6469  solve* can be di
-00041150: 7361 626c 6564 2066 6f72 2074 6573 7469  sabled for testi
-00041160: 6e67 2077 6974 6820 6661 6b65 2068 6f73  ng with fake hos
-00041170: 746e 616d 6573 2e0a 0a20 2020 2020 2020  tnames...       
-00041180: 2048 616e 646c 6573 2073 7472 696e 6773   Handles strings
-00041190: 2c20 7475 706c 6573 2c20 6f72 2061 6c69  , tuples, or ali
-000411a0: 6173 6573 2e0a 2020 2020 2020 2020 2222  ases..        ""
-000411b0: 220a 2020 2020 2020 2020 2320 5858 5820  ".        # XXX 
-000411c0: 686f 7720 6d61 6e79 2061 6464 7265 7373  how many address
-000411d0: 2d70 6172 7369 6e67 2072 6f75 7469 6e65  -parsing routine
-000411e0: 7320 646f 2077 6520 6861 7665 3f0a 2020  s do we have?.  
-000411f0: 2020 2020 2020 6966 2061 6464 7220 696e        if addr in
-00041200: 2073 656c 662e 616c 6961 7365 733a 0a20   self.aliases:. 
-00041210: 2020 2020 2020 2020 2020 2061 6464 7220             addr 
-00041220: 3d20 7365 6c66 2e61 6c69 6173 6573 5b61  = self.aliases[a
-00041230: 6464 725d 0a20 2020 2020 2020 2069 6620  ddr].        if 
-00041240: 6973 696e 7374 616e 6365 2861 6464 722c  isinstance(addr,
-00041250: 2074 7570 6c65 293a 0a20 2020 2020 2020   tuple):.       
-00041260: 2020 2020 2061 6464 7220 3d20 756e 7061       addr = unpa
-00041270: 7273 655f 686f 7374 5f70 6f72 7428 2a61  rse_host_port(*a
-00041280: 6464 7229 0a20 2020 2020 2020 2069 6620  ddr).        if 
-00041290: 6e6f 7420 6973 696e 7374 616e 6365 2861  not isinstance(a
-000412a0: 6464 722c 2073 7472 293a 0a20 2020 2020  ddr, str):.     
-000412b0: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
-000412c0: 6545 7272 6f72 2866 2261 6464 7265 7373  eError(f"address
-000412d0: 6573 2073 686f 756c 6420 6265 2073 7472  es should be str
-000412e0: 696e 6773 206f 7220 7475 706c 6573 2c20  ings or tuples, 
-000412f0: 676f 7420 7b61 6464 7221 727d 2229 0a0a  got {addr!r}")..
-00041300: 2020 2020 2020 2020 6966 2072 6573 6f6c          if resol
-00041310: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
-00041320: 6164 6472 203d 2072 6573 6f6c 7665 5f61  addr = resolve_a
-00041330: 6464 7265 7373 2861 6464 7229 0a20 2020  ddress(addr).   
-00041340: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00041350: 2020 2020 2020 2061 6464 7220 3d20 6e6f         addr = no
-00041360: 726d 616c 697a 655f 6164 6472 6573 7328  rmalize_address(
-00041370: 6164 6472 290a 0a20 2020 2020 2020 2072  addr)..        r
-00041380: 6574 7572 6e20 6164 6472 0a0a 2020 2020  eturn addr..    
-00041390: 6465 6620 776f 726b 6572 735f 6c69 7374  def workers_list
-000413a0: 2873 656c 662c 2077 6f72 6b65 7273 293a  (self, workers):
-000413b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000413c0: 2020 2020 204c 6973 7420 6f66 2071 7561       List of qua
-000413d0: 6c69 6679 696e 6720 776f 726b 6572 730a  lifying workers.
-000413e0: 0a20 2020 2020 2020 2054 616b 6573 2061  .        Takes a
-000413f0: 206c 6973 7420 6f66 2077 6f72 6b65 7220   list of worker 
-00041400: 6164 6472 6573 7365 7320 6f72 2068 6f73  addresses or hos
-00041410: 746e 616d 6573 2e0a 2020 2020 2020 2020  tnames..        
-00041420: 5265 7475 726e 7320 6120 6c69 7374 206f  Returns a list o
-00041430: 6620 616c 6c20 776f 726b 6572 2061 6464  f all worker add
-00041440: 7265 7373 6573 2074 6861 7420 6d61 7463  resses that matc
-00041450: 680a 2020 2020 2020 2020 2222 220a 2020  h.        """.  
-00041460: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
-00041470: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00041480: 2020 2020 2020 7265 7475 726e 206c 6973        return lis
-00041490: 7428 7365 6c66 2e77 6f72 6b65 7273 290a  t(self.workers).
-000414a0: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-000414b0: 6574 2829 0a20 2020 2020 2020 2066 6f72  et().        for
-000414c0: 2077 2069 6e20 776f 726b 6572 733a 0a20   w in workers:. 
-000414d0: 2020 2020 2020 2020 2020 2069 6620 223a             if ":
-000414e0: 2220 696e 2077 3a0a 2020 2020 2020 2020  " in w:.        
-000414f0: 2020 2020 2020 2020 6f75 742e 6164 6428          out.add(
-00041500: 7729 0a20 2020 2020 2020 2020 2020 2065  w).            e
-00041510: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00041520: 2020 2020 206f 7574 2e75 7064 6174 6528       out.update(
-00041530: 7b77 7720 666f 7220 7777 2069 6e20 7365  {ww for ww in se
-00041540: 6c66 2e77 6f72 6b65 7273 2069 6620 7720  lf.workers if w 
-00041550: 696e 2077 777d 2920 2023 2054 4f44 4f3a  in ww})  # TODO:
-00041560: 2071 7561 6472 6174 6963 0a20 2020 2020   quadratic.     
-00041570: 2020 2072 6574 7572 6e20 6c69 7374 286f     return list(o
-00041580: 7574 290a 0a20 2020 2061 7379 6e63 2064  ut)..    async d
-00041590: 6566 2067 6574 5f70 726f 6669 6c65 280a  ef get_profile(.
-000415a0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-000415b0: 2020 2020 2020 636f 6d6d 3d4e 6f6e 652c        comm=None,
-000415c0: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-000415d0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-000415e0: 6368 6564 756c 6572 3d46 616c 7365 2c0a  cheduler=False,.
-000415f0: 2020 2020 2020 2020 7365 7276 6572 3d46          server=F
-00041600: 616c 7365 2c0a 2020 2020 2020 2020 6d65  alse,.        me
-00041610: 7267 655f 776f 726b 6572 733d 5472 7565  rge_workers=True
-00041620: 2c0a 2020 2020 2020 2020 7374 6172 743d  ,.        start=
-00041630: 4e6f 6e65 2c0a 2020 2020 2020 2020 7374  None,.        st
-00041640: 6f70 3d4e 6f6e 652c 0a20 2020 2020 2020  op=None,.       
-00041650: 206b 6579 3d4e 6f6e 652c 0a20 2020 2029   key=None,.    )
-00041660: 3a0a 2020 2020 2020 2020 6966 2077 6f72  :.        if wor
-00041670: 6b65 7273 2069 7320 4e6f 6e65 3a0a 2020  kers is None:.  
-00041680: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00041690: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-000416a0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000416b0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-000416c0: 7273 203d 2073 6574 2873 656c 662e 776f  rs = set(self.wo
-000416d0: 726b 6572 7329 2026 2073 6574 2877 6f72  rkers) & set(wor
-000416e0: 6b65 7273 290a 0a20 2020 2020 2020 2069  kers)..        i
-000416f0: 6620 7363 6865 6475 6c65 723a 0a20 2020  f scheduler:.   
-00041700: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00041710: 7072 6f66 696c 652e 6765 745f 7072 6f66  profile.get_prof
-00041720: 696c 6528 7365 6c66 2e69 6f5f 6c6f 6f70  ile(self.io_loop
-00041730: 2e70 726f 6669 6c65 2c20 7374 6172 743d  .profile, start=
-00041740: 7374 6172 742c 2073 746f 703d 7374 6f70  start, stop=stop
-00041750: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-00041760: 7473 203d 2061 7761 6974 2061 7379 6e63  ts = await async
-00041770: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00041780: 2020 2020 2020 202a 280a 2020 2020 2020         *(.      
-00041790: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000417a0: 7063 2877 292e 7072 6f66 696c 6528 7374  pc(w).profile(st
-000417b0: 6172 743d 7374 6172 742c 2073 746f 703d  art=start, stop=
-000417c0: 7374 6f70 2c20 6b65 793d 6b65 792c 2073  stop, key=key, s
-000417d0: 6572 7665 723d 7365 7276 6572 290a 2020  erver=server).  
-000417e0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000417f0: 7220 7720 696e 2077 6f72 6b65 7273 0a20  r w in workers. 
-00041800: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00041810: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00041820: 5f65 7863 6570 7469 6f6e 733d 5472 7565  _exceptions=True
-00041830: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00041840: 2020 2020 2072 6573 756c 7473 203d 205b       results = [
-00041850: 7220 666f 7220 7220 696e 2072 6573 756c  r for r in resul
-00041860: 7473 2069 6620 6e6f 7420 6973 696e 7374  ts if not isinst
-00041870: 616e 6365 2872 2c20 4578 6365 7074 696f  ance(r, Exceptio
-00041880: 6e29 5d0a 0a20 2020 2020 2020 2069 6620  n)]..        if 
-00041890: 6d65 7267 655f 776f 726b 6572 733a 0a20  merge_workers:. 
-000418a0: 2020 2020 2020 2020 2020 2072 6573 706f             respo
-000418b0: 6e73 6520 3d20 7072 6f66 696c 652e 6d65  nse = profile.me
-000418c0: 7267 6528 2a72 6573 756c 7473 290a 2020  rge(*results).  
-000418d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000418e0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-000418f0: 203d 2064 6963 7428 7a69 7028 776f 726b   = dict(zip(work
-00041900: 6572 732c 2072 6573 756c 7473 2929 0a20  ers, results)). 
-00041910: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00041920: 7370 6f6e 7365 0a0a 2020 2020 6173 796e  sponse..    asyn
-00041930: 6320 6465 6620 6765 745f 7072 6f66 696c  c def get_profil
-00041940: 655f 6d65 7461 6461 7461 280a 2020 2020  e_metadata(.    
-00041950: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00041960: 2020 776f 726b 6572 733a 2022 4974 6572    workers: "Iter
-00041970: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
-00041980: 2220 3d20 4e6f 6e65 2c0a 2020 2020 2020  " = None,.      
-00041990: 2020 7374 6172 743a 2066 6c6f 6174 203d    start: float =
-000419a0: 2030 2c0a 2020 2020 2020 2020 7374 6f70   0,.        stop
-000419b0: 3a20 2266 6c6f 6174 207c 204e 6f6e 6522  : "float | None"
-000419c0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000419d0: 2070 726f 6669 6c65 5f63 7963 6c65 5f69   profile_cycle_i
-000419e0: 6e74 6572 7661 6c3a 2022 7374 7220 7c20  nterval: "str | 
-000419f0: 666c 6f61 7420 7c20 4e6f 6e65 2220 3d20  float | None" = 
-00041a00: 4e6f 6e65 2c0a 2020 2020 293a 0a20 2020  None,.    ):.   
-00041a10: 2020 2020 2064 7420 3d20 7072 6f66 696c       dt = profil
-00041a20: 655f 6379 636c 655f 696e 7465 7276 616c  e_cycle_interval
-00041a30: 206f 7220 6461 736b 2e63 6f6e 6669 672e   or dask.config.
-00041a40: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-00041a50: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
-00041a60: 726b 6572 2e70 726f 6669 6c65 2e63 7963  rker.profile.cyc
-00041a70: 6c65 220a 2020 2020 2020 2020 290a 2020  le".        ).  
-00041a80: 2020 2020 2020 6474 203d 2070 6172 7365        dt = parse
-00041a90: 5f74 696d 6564 656c 7461 2864 742c 2064  _timedelta(dt, d
-00041aa0: 6566 6175 6c74 3d22 6d73 2229 0a0a 2020  efault="ms")..  
-00041ab0: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
-00041ac0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00041ad0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
-00041ae0: 7365 6c66 2e77 6f72 6b65 7273 0a20 2020  self.workers.   
-00041af0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00041b00: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-00041b10: 2073 6574 2873 656c 662e 776f 726b 6572   set(self.worker
-00041b20: 7329 2026 2073 6574 2877 6f72 6b65 7273  s) & set(workers
-00041b30: 290a 2020 2020 2020 2020 7265 7375 6c74  ).        result
-00041b40: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
-00041b50: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-00041b60: 2020 2020 2020 2a28 7365 6c66 2e72 7063        *(self.rpc
-00041b70: 2877 292e 7072 6f66 696c 655f 6d65 7461  (w).profile_meta
-00041b80: 6461 7461 2873 7461 7274 3d73 7461 7274  data(start=start
-00041b90: 2c20 7374 6f70 3d73 746f 7029 2066 6f72  , stop=stop) for
-00041ba0: 2077 2069 6e20 776f 726b 6572 7329 2c0a   w in workers),.
-00041bb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00041bc0: 726e 5f65 7863 6570 7469 6f6e 733d 5472  rn_exceptions=Tr
-00041bd0: 7565 2c0a 2020 2020 2020 2020 290a 0a20  ue,.        ).. 
-00041be0: 2020 2020 2020 2072 6573 756c 7473 203d         results =
-00041bf0: 205b 7220 666f 7220 7220 696e 2072 6573   [r for r in res
-00041c00: 756c 7473 2069 6620 6e6f 7420 6973 696e  ults if not isin
-00041c10: 7374 616e 6365 2872 2c20 4578 6365 7074  stance(r, Except
-00041c20: 696f 6e29 5d0a 2020 2020 2020 2020 636f  ion)].        co
-00041c30: 756e 7473 203d 205b 0a20 2020 2020 2020  unts = [.       
-00041c40: 2020 2020 2028 7469 6d65 2c20 7375 6d28       (time, sum(
-00041c50: 706c 7563 6b28 312c 2067 726f 7570 2929  pluck(1, group))
-00041c60: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-00041c70: 7220 7469 6d65 2c20 6772 6f75 7020 696e  r time, group in
-00041c80: 2069 7465 7274 6f6f 6c73 2e67 726f 7570   itertools.group
-00041c90: 6279 280a 2020 2020 2020 2020 2020 2020  by(.            
-00041ca0: 2020 2020 6d65 7267 655f 736f 7274 6564      merge_sorted
-00041cb0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00041cc0: 2020 2020 2020 2a28 765b 2263 6f75 6e74        *(v["count
-00041cd0: 7322 5d20 666f 7220 7620 696e 2072 6573  s"] for v in res
-00041ce0: 756c 7473 292c 0a20 2020 2020 2020 2020  ults),.         
-00041cf0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00041d00: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-00041d10: 2074 3a20 745b 305d 202f 2f20 6474 202a   t: t[0] // dt *
-00041d20: 2064 742c 0a20 2020 2020 2020 2020 2020   dt,.           
-00041d30: 2029 0a20 2020 2020 2020 205d 0a0a 2020   ).        ]..  
-00041d40: 2020 2020 2020 6b65 7973 3a20 6469 6374        keys: dict
-00041d50: 5b73 7472 2c20 6c69 7374 5b6c 6973 745d  [str, list[list]
-00041d60: 5d20 3d20 7b0a 2020 2020 2020 2020 2020  ] = {.          
-00041d70: 2020 6b3a 205b 5d20 666f 7220 7620 696e    k: [] for v in
-00041d80: 2072 6573 756c 7473 2066 6f72 2074 2c20   results for t, 
-00041d90: 6420 696e 2076 5b22 6b65 7973 225d 2066  d in v["keys"] f
-00041da0: 6f72 206b 2069 6e20 640a 2020 2020 2020  or k in d.      
-00041db0: 2020 7d0a 0a20 2020 2020 2020 2067 726f    }..        gro
-00041dc0: 7570 7331 203d 205b 765b 226b 6579 7322  ups1 = [v["keys"
-00041dd0: 5d20 666f 7220 7620 696e 2072 6573 756c  ] for v in resul
-00041de0: 7473 5d0a 2020 2020 2020 2020 6772 6f75  ts].        grou
-00041df0: 7073 3220 3d20 6c69 7374 286d 6572 6765  ps2 = list(merge
-00041e00: 5f73 6f72 7465 6428 2a67 726f 7570 7331  _sorted(*groups1
-00041e10: 2c20 6b65 793d 6669 7273 7429 290a 0a20  , key=first)).. 
-00041e20: 2020 2020 2020 206c 6173 7420 3d20 300a         last = 0.
-00041e30: 2020 2020 2020 2020 666f 7220 742c 2064          for t, d
-00041e40: 2069 6e20 6772 6f75 7073 323a 0a20 2020   in groups2:.   
-00041e50: 2020 2020 2020 2020 2074 7420 3d20 7420           tt = t 
-00041e60: 2f2f 2064 7420 2a20 6474 0a20 2020 2020  // dt * dt.     
-00041e70: 2020 2020 2020 2069 6620 7474 203e 206c         if tt > l
-00041e80: 6173 743a 0a20 2020 2020 2020 2020 2020  ast:.           
-00041e90: 2020 2020 206c 6173 7420 3d20 7474 0a20       last = tt. 
-00041ea0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00041eb0: 6f72 2076 2069 6e20 6b65 7973 2e76 616c  or v in keys.val
-00041ec0: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
-00041ed0: 2020 2020 2020 2020 2020 2076 2e61 7070             v.app
-00041ee0: 656e 6428 5b74 742c 2030 5d29 0a20 2020  end([tt, 0]).   
-00041ef0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
-00041f00: 7620 696e 2064 2e69 7465 6d73 2829 3a0a  v in d.items():.
-00041f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041f20: 6b65 7973 5b6b 5d5b 2d31 5d5b 315d 202b  keys[k][-1][1] +
-00041f30: 3d20 760a 0a20 2020 2020 2020 2072 6574  = v..        ret
-00041f40: 7572 6e20 7b22 636f 756e 7473 223a 2063  urn {"counts": c
-00041f50: 6f75 6e74 732c 2022 6b65 7973 223a 206b  ounts, "keys": k
-00041f60: 6579 737d 0a0a 2020 2020 6173 796e 6320  eys}..    async 
-00041f70: 6465 6620 7065 7266 6f72 6d61 6e63 655f  def performance_
-00041f80: 7265 706f 7274 280a 2020 2020 2020 2020  report(.        
-00041f90: 7365 6c66 2c20 7374 6172 743a 2066 6c6f  self, start: flo
-00041fa0: 6174 2c20 6c61 7374 5f63 6f75 6e74 3a20  at, last_count: 
-00041fb0: 696e 742c 2063 6f64 653d 2222 2c20 6d6f  int, code="", mo
-00041fc0: 6465 3d4e 6f6e 650a 2020 2020 293a 0a20  de=None.    ):. 
-00041fd0: 2020 2020 2020 2073 746f 7020 3d20 7469         stop = ti
-00041fe0: 6d65 2829 0a20 2020 2020 2020 2023 2050  me().        # P
-00041ff0: 726f 6669 6c65 730a 2020 2020 2020 2020  rofiles.        
-00042000: 636f 6d70 7574 652c 2073 6368 6564 756c  compute, schedul
-00042010: 6572 2c20 776f 726b 6572 7320 3d20 6177  er, workers = aw
-00042020: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
-00042030: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-00042040: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
-00042050: 2020 2073 656c 662e 6765 745f 7072 6f66     self.get_prof
-00042060: 696c 6528 7374 6172 743d 7374 6172 7429  ile(start=start)
-00042070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00042080: 2020 7365 6c66 2e67 6574 5f70 726f 6669    self.get_profi
-00042090: 6c65 2873 6368 6564 756c 6572 3d54 7275  le(scheduler=Tru
-000420a0: 652c 2073 7461 7274 3d73 7461 7274 292c  e, start=start),
-000420b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000420c0: 2073 656c 662e 6765 745f 7072 6f66 696c   self.get_profil
-000420d0: 6528 7365 7276 6572 3d54 7275 652c 2073  e(server=True, s
-000420e0: 7461 7274 3d73 7461 7274 292c 0a20 2020  tart=start),.   
-000420f0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-00042100: 2020 2029 0a20 2020 2020 2020 2066 726f     ).        fro
-00042110: 6d20 6469 7374 7269 6275 7465 6420 696d  m distributed im
-00042120: 706f 7274 2070 726f 6669 6c65 0a0a 2020  port profile..  
-00042130: 2020 2020 2020 6465 6620 7072 6f66 696c        def profil
-00042140: 655f 746f 5f66 6967 7572 6528 7374 6174  e_to_figure(stat
-00042150: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00042160: 6461 7461 203d 2070 726f 6669 6c65 2e70  data = profile.p
-00042170: 6c6f 745f 6461 7461 2873 7461 7465 290a  lot_data(state).
-00042180: 2020 2020 2020 2020 2020 2020 6669 6775              figu
-00042190: 7265 2c20 736f 7572 6365 203d 2070 726f  re, source = pro
-000421a0: 6669 6c65 2e70 6c6f 745f 6669 6775 7265  file.plot_figure
-000421b0: 2864 6174 612c 2073 697a 696e 675f 6d6f  (data, sizing_mo
-000421c0: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
-000421d0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-000421e0: 6574 7572 6e20 6669 6775 7265 0a0a 2020  eturn figure..  
-000421f0: 2020 2020 2020 636f 6d70 7574 652c 2073        compute, s
-00042200: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
-00042210: 7320 3d20 6d61 7028 0a20 2020 2020 2020  s = map(.       
-00042220: 2020 2020 2070 726f 6669 6c65 5f74 6f5f       profile_to_
-00042230: 6669 6775 7265 2c20 2863 6f6d 7075 7465  figure, (compute
-00042240: 2c20 7363 6865 6475 6c65 722c 2077 6f72  , scheduler, wor
-00042250: 6b65 7273 290a 2020 2020 2020 2020 290a  kers).        ).
-00042260: 0a20 2020 2020 2020 2023 2054 6173 6b20  .        # Task 
-00042270: 7374 7265 616d 0a20 2020 2020 2020 2074  stream.        t
-00042280: 6173 6b5f 7374 7265 616d 203d 2073 656c  ask_stream = sel
-00042290: 662e 6765 745f 7461 736b 5f73 7472 6561  f.get_task_strea
-000422a0: 6d28 7374 6172 743d 7374 6172 7429 0a20  m(start=start). 
-000422b0: 2020 2020 2020 2074 6f74 616c 5f74 6173         total_tas
-000422c0: 6b73 203d 206c 656e 2874 6173 6b5f 7374  ks = len(task_st
-000422d0: 7265 616d 290a 2020 2020 2020 2020 7469  ream).        ti
-000422e0: 6d65 7370 656e 743a 2064 6566 6175 6c74  mespent: default
-000422f0: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
-00042300: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
-00042310: 6c6f 6174 290a 2020 2020 2020 2020 666f  loat).        fo
-00042320: 7220 6420 696e 2074 6173 6b5f 7374 7265  r d in task_stre
-00042330: 616d 3a0a 2020 2020 2020 2020 2020 2020  am:.            
-00042340: 666f 7220 7820 696e 2064 5b22 7374 6172  for x in d["star
-00042350: 7473 746f 7073 225d 3a0a 2020 2020 2020  tstops"]:.      
-00042360: 2020 2020 2020 2020 2020 7469 6d65 7370            timesp
-00042370: 656e 745b 785b 2261 6374 696f 6e22 5d5d  ent[x["action"]]
-00042380: 202b 3d20 785b 2273 746f 7022 5d20 2d20   += x["stop"] - 
-00042390: 785b 2273 7461 7274 225d 0a20 2020 2020  x["start"].     
-000423a0: 2020 2074 6173 6b73 5f74 696d 696e 6773     tasks_timings
-000423b0: 203d 2022 220a 2020 2020 2020 2020 666f   = "".        fo
-000423c0: 7220 6b20 696e 2073 6f72 7465 6428 7469  r k in sorted(ti
-000423d0: 6d65 7370 656e 742e 6b65 7973 2829 293a  mespent.keys()):
-000423e0: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-000423f0: 6b73 5f74 696d 696e 6773 202b 3d20 6622  ks_timings += f"
-00042400: 5c6e 3c6c 693e 207b 6b7d 2074 696d 653a  \n<li> {k} time:
-00042410: 207b 666f 726d 6174 5f74 696d 6528 7469   {format_time(ti
-00042420: 6d65 7370 656e 745b 6b5d 297d 203c 2f6c  mespent[k])} </l
-00042430: 693e 220a 0a20 2020 2020 2020 2066 726f  i>"..        fro
-00042440: 6d20 6469 7374 7269 6275 7465 642e 6461  m distributed.da
-00042450: 7368 626f 6172 642e 636f 6d70 6f6e 656e  shboard.componen
-00042460: 7473 2e73 6368 6564 756c 6572 2069 6d70  ts.scheduler imp
-00042470: 6f72 7420 7461 736b 5f73 7472 6561 6d5f  ort task_stream_
-00042480: 6669 6775 7265 0a20 2020 2020 2020 2066  figure.        f
-00042490: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000424a0: 6469 6167 6e6f 7374 6963 732e 7461 736b  diagnostics.task
-000424b0: 5f73 7472 6561 6d20 696d 706f 7274 2072  _stream import r
-000424c0: 6563 7461 6e67 6c65 730a 0a20 2020 2020  ectangles..     
-000424d0: 2020 2072 6563 7473 203d 2072 6563 7461     rects = recta
-000424e0: 6e67 6c65 7328 7461 736b 5f73 7472 6561  ngles(task_strea
-000424f0: 6d29 0a20 2020 2020 2020 2073 6f75 7263  m).        sourc
-00042500: 652c 2074 6173 6b5f 7374 7265 616d 203d  e, task_stream =
-00042510: 2074 6173 6b5f 7374 7265 616d 5f66 6967   task_stream_fig
-00042520: 7572 6528 7369 7a69 6e67 5f6d 6f64 653d  ure(sizing_mode=
-00042530: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-00042540: 2020 2020 2020 2020 736f 7572 6365 2e64          source.d
-00042550: 6174 612e 7570 6461 7465 2872 6563 7473  ata.update(rects
-00042560: 290a 0a20 2020 2020 2020 2023 2042 616e  )..        # Ban
-00042570: 6477 6964 7468 0a20 2020 2020 2020 2066  dwidth.        f
-00042580: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00042590: 6461 7368 626f 6172 642e 636f 6d70 6f6e  dashboard.compon
-000425a0: 656e 7473 2e73 6368 6564 756c 6572 2069  ents.scheduler i
-000425b0: 6d70 6f72 7420 280a 2020 2020 2020 2020  mport (.        
-000425c0: 2020 2020 4261 6e64 7769 6474 6854 7970      BandwidthTyp
-000425d0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-000425e0: 4261 6e64 7769 6474 6857 6f72 6b65 7273  BandwidthWorkers
-000425f0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00042600: 2020 2020 2062 616e 6477 6964 7468 5f77       bandwidth_w
-00042610: 6f72 6b65 7273 203d 2042 616e 6477 6964  orkers = Bandwid
-00042620: 7468 576f 726b 6572 7328 7365 6c66 2c20  thWorkers(self, 
-00042630: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-00042640: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
-00042650: 2020 2020 6261 6e64 7769 6474 685f 776f      bandwidth_wo
-00042660: 726b 6572 732e 7570 6461 7465 2829 0a20  rkers.update(). 
-00042670: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
-00042680: 5f74 7970 6573 203d 2042 616e 6477 6964  _types = Bandwid
-00042690: 7468 5479 7065 7328 7365 6c66 2c20 7369  thTypes(self, si
-000426a0: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
-000426b0: 6368 5f62 6f74 6822 290a 2020 2020 2020  ch_both").      
-000426c0: 2020 6261 6e64 7769 6474 685f 7479 7065    bandwidth_type
-000426d0: 732e 7570 6461 7465 2829 0a0a 2020 2020  s.update()..    
-000426e0: 2020 2020 2320 5379 7374 656d 206d 6f6e      # System mon
-000426f0: 6974 6f72 0a20 2020 2020 2020 2066 726f  itor.        fro
-00042700: 6d20 6469 7374 7269 6275 7465 642e 6461  m distributed.da
-00042710: 7368 626f 6172 642e 636f 6d70 6f6e 656e  shboard.componen
-00042720: 7473 2e73 6861 7265 6420 696d 706f 7274  ts.shared import
-00042730: 2053 7973 7465 6d4d 6f6e 6974 6f72 0a0a   SystemMonitor..
-00042740: 2020 2020 2020 2020 7379 736d 6f6e 203d          sysmon =
-00042750: 2053 7973 7465 6d4d 6f6e 6974 6f72 2873   SystemMonitor(s
-00042760: 656c 662c 206c 6173 745f 636f 756e 743d  elf, last_count=
-00042770: 6c61 7374 5f63 6f75 6e74 2c20 7369 7a69  last_count, sizi
-00042780: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-00042790: 5f62 6f74 6822 290a 2020 2020 2020 2020  _both").        
-000427a0: 7379 736d 6f6e 2e75 7064 6174 6528 290a  sysmon.update().
-000427b0: 0a20 2020 2020 2020 2023 2053 6368 6564  .        # Sched
-000427c0: 756c 6572 206c 6f67 730a 2020 2020 2020  uler logs.      
-000427d0: 2020 6672 6f6d 2064 6973 7472 6962 7574    from distribut
-000427e0: 6564 2e64 6173 6862 6f61 7264 2e63 6f6d  ed.dashboard.com
-000427f0: 706f 6e65 6e74 732e 7363 6865 6475 6c65  ponents.schedule
-00042800: 7220 696d 706f 7274 2028 0a20 2020 2020  r import (.     
-00042810: 2020 2020 2020 205f 424f 4b45 485f 5354         _BOKEH_ST
-00042820: 594c 4553 5f4b 5741 5247 532c 0a20 2020  YLES_KWARGS,.   
-00042830: 2020 2020 2020 2020 2053 6368 6564 756c           Schedul
-00042840: 6572 4c6f 6773 2c0a 2020 2020 2020 2020  erLogs,.        
-00042850: 290a 0a20 2020 2020 2020 206c 6f67 7320  )..        logs 
-00042860: 3d20 5363 6865 6475 6c65 724c 6f67 7328  = SchedulerLogs(
-00042870: 7365 6c66 2c20 7374 6172 743d 7374 6172  self, start=star
-00042880: 7429 0a0a 2020 2020 2020 2020 6672 6f6d  t)..        from
-00042890: 2062 6f6b 6568 2e6d 6f64 656c 7320 696d   bokeh.models im
-000428a0: 706f 7274 2044 6976 2c20 5461 6273 0a0a  port Div, Tabs..
-000428b0: 2020 2020 2020 2020 696d 706f 7274 2064          import d
-000428c0: 6973 7472 6962 7574 6564 0a20 2020 2020  istributed.     
-000428d0: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
-000428e0: 7465 642e 6461 7368 626f 6172 642e 636f  ted.dashboard.co
-000428f0: 7265 2069 6d70 6f72 7420 5461 6250 616e  re import TabPan
-00042900: 656c 0a0a 2020 2020 2020 2020 2320 4854  el..        # HT
-00042910: 4d4c 0a20 2020 2020 2020 2068 746d 6c20  ML.        html 
-00042920: 3d20 2222 220a 2020 2020 2020 2020 3c68  = """.        <h
-00042930: 313e 2044 6173 6b20 5065 7266 6f72 6d61  1> Dask Performa
-00042940: 6e63 6520 5265 706f 7274 203c 2f68 313e  nce Report </h1>
-00042950: 0a0a 2020 2020 2020 2020 3c69 3e20 5365  ..        <i> Se
-00042960: 6c65 6374 2064 6966 6665 7265 6e74 2074  lect different t
-00042970: 6162 7320 6f6e 2074 6865 2074 6f70 2066  abs on the top f
-00042980: 6f72 2061 6464 6974 696f 6e61 6c20 696e  or additional in
-00042990: 666f 726d 6174 696f 6e20 3c2f 693e 0a0a  formation </i>..
-000429a0: 2020 2020 2020 2020 3c68 323e 2044 7572          <h2> Dur
-000429b0: 6174 696f 6e3a 207b 7469 6d65 7d20 3c2f  ation: {time} </
-000429c0: 6832 3e0a 2020 2020 2020 2020 3c68 323e  h2>.        <h2>
-000429d0: 2054 6173 6b73 2049 6e66 6f72 6d61 7469   Tasks Informati
-000429e0: 6f6e 203c 2f68 323e 0a20 2020 2020 2020  on </h2>.       
-000429f0: 203c 756c 3e0a 2020 2020 2020 2020 203c   <ul>.         <
-00042a00: 6c69 3e20 6e75 6d62 6572 206f 6620 7461  li> number of ta
-00042a10: 736b 733a 207b 6e74 6173 6b73 7d20 3c2f  sks: {ntasks} </
-00042a20: 6c69 3e0a 2020 2020 2020 2020 207b 7461  li>.         {ta
-00042a30: 736b 735f 7469 6d69 6e67 737d 0a20 2020  sks_timings}.   
-00042a40: 2020 2020 203c 2f75 6c3e 0a0a 2020 2020       </ul>..    
-00042a50: 2020 2020 3c68 323e 2053 6368 6564 756c      <h2> Schedul
-00042a60: 6572 2049 6e66 6f72 6d61 7469 6f6e 203c  er Information <
-00042a70: 2f68 323e 0a20 2020 2020 2020 203c 756c  /h2>.        <ul
-00042a80: 3e0a 2020 2020 2020 2020 2020 3c6c 693e  >.          <li>
-00042a90: 2041 6464 7265 7373 3a20 7b61 6464 7265   Address: {addre
-00042aa0: 7373 7d20 3c2f 6c69 3e0a 2020 2020 2020  ss} </li>.      
-00042ab0: 2020 2020 3c6c 693e 2057 6f72 6b65 7273      <li> Workers
-00042ac0: 3a20 7b6e 776f 726b 6572 737d 203c 2f6c  : {nworkers} </l
-00042ad0: 693e 0a20 2020 2020 2020 2020 203c 6c69  i>.          <li
-00042ae0: 3e20 5468 7265 6164 733a 207b 7468 7265  > Threads: {thre
-00042af0: 6164 737d 203c 2f6c 693e 0a20 2020 2020  ads} </li>.     
-00042b00: 2020 2020 203c 6c69 3e20 4d65 6d6f 7279       <li> Memory
-00042b10: 3a20 7b6d 656d 6f72 797d 203c 2f6c 693e  : {memory} </li>
-00042b20: 0a20 2020 2020 2020 2020 203c 6c69 3e20  .          <li> 
-00042b30: 4461 736b 2056 6572 7369 6f6e 3a20 7b64  Dask Version: {d
-00042b40: 6173 6b5f 7665 7273 696f 6e7d 203c 2f6c  ask_version} </l
-00042b50: 693e 0a20 2020 2020 2020 2020 203c 6c69  i>.          <li
-00042b60: 3e20 4461 736b 2e44 6973 7472 6962 7574  > Dask.Distribut
-00042b70: 6564 2056 6572 7369 6f6e 3a20 7b64 6973  ed Version: {dis
-00042b80: 7472 6962 7574 6564 5f76 6572 7369 6f6e  tributed_version
-00042b90: 7d20 3c2f 6c69 3e0a 2020 2020 2020 2020  } </li>.        
-00042ba0: 3c2f 756c 3e0a 0a20 2020 2020 2020 203c  </ul>..        <
-00042bb0: 6832 3e20 4361 6c6c 696e 6720 436f 6465  h2> Calling Code
-00042bc0: 203c 2f68 323e 0a20 2020 2020 2020 203c   </h2>.        <
-00042bd0: 7072 653e 0a7b 636f 6465 7d0a 2020 2020  pre>.{code}.    
-00042be0: 2020 2020 3c2f 7072 653e 0a20 2020 2020      </pre>.     
-00042bf0: 2020 2022 2222 2e66 6f72 6d61 7428 0a20     """.format(. 
-00042c00: 2020 2020 2020 2020 2020 2074 696d 653d             time=
-00042c10: 666f 726d 6174 5f74 696d 6528 7374 6f70  format_time(stop
-00042c20: 202d 2073 7461 7274 292c 0a20 2020 2020   - start),.     
-00042c30: 2020 2020 2020 206e 7461 736b 733d 746f         ntasks=to
-00042c40: 7461 6c5f 7461 736b 732c 0a20 2020 2020  tal_tasks,.     
-00042c50: 2020 2020 2020 2074 6173 6b73 5f74 696d         tasks_tim
-00042c60: 696e 6773 3d74 6173 6b73 5f74 696d 696e  ings=tasks_timin
-00042c70: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
-00042c80: 6164 6472 6573 733d 7365 6c66 2e61 6464  address=self.add
-00042c90: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
-00042ca0: 2020 6e77 6f72 6b65 7273 3d6c 656e 2873    nworkers=len(s
-00042cb0: 656c 662e 776f 726b 6572 7329 2c0a 2020  elf.workers),.  
-00042cc0: 2020 2020 2020 2020 2020 7468 7265 6164            thread
-00042cd0: 733d 7375 6d28 7773 2e6e 7468 7265 6164  s=sum(ws.nthread
-00042ce0: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
-00042cf0: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-00042d00: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00042d10: 6d65 6d6f 7279 3d66 6f72 6d61 745f 6279  memory=format_by
-00042d20: 7465 7328 7375 6d28 7773 2e6d 656d 6f72  tes(sum(ws.memor
-00042d30: 795f 6c69 6d69 7420 666f 7220 7773 2069  y_limit for ws i
-00042d40: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
-00042d50: 616c 7565 7328 2929 292c 0a20 2020 2020  alues())),.     
-00042d60: 2020 2020 2020 2063 6f64 653d 636f 6465         code=code
-00042d70: 2c0a 2020 2020 2020 2020 2020 2020 6461  ,.            da
-00042d80: 736b 5f76 6572 7369 6f6e 3d64 6173 6b2e  sk_version=dask.
-00042d90: 5f5f 7665 7273 696f 6e5f 5f2c 0a20 2020  __version__,.   
-00042da0: 2020 2020 2020 2020 2064 6973 7472 6962           distrib
-00042db0: 7574 6564 5f76 6572 7369 6f6e 3d64 6973  uted_version=dis
-00042dc0: 7472 6962 7574 6564 2e5f 5f76 6572 7369  tributed.__versi
-00042dd0: 6f6e 5f5f 2c0a 2020 2020 2020 2020 290a  on__,.        ).
-00042de0: 2020 2020 2020 2020 6874 6d6c 203d 2044          html = D
-00042df0: 6976 2874 6578 743d 6874 6d6c 2c20 2a2a  iv(text=html, **
-00042e00: 5f42 4f4b 4548 5f53 5459 4c45 535f 4b57  _BOKEH_STYLES_KW
-00042e10: 4152 4753 290a 0a20 2020 2020 2020 2068  ARGS)..        h
-00042e20: 746d 6c20 3d20 5461 6250 616e 656c 2863  tml = TabPanel(c
-00042e30: 6869 6c64 3d68 746d 6c2c 2074 6974 6c65  hild=html, title
-00042e40: 3d22 5375 6d6d 6172 7922 290a 2020 2020  ="Summary").    
-00042e50: 2020 2020 636f 6d70 7574 6520 3d20 5461      compute = Ta
-00042e60: 6250 616e 656c 2863 6869 6c64 3d63 6f6d  bPanel(child=com
-00042e70: 7075 7465 2c20 7469 746c 653d 2257 6f72  pute, title="Wor
-00042e80: 6b65 7220 5072 6f66 696c 6520 2863 6f6d  ker Profile (com
-00042e90: 7075 7465 2922 290a 2020 2020 2020 2020  pute)").        
-00042ea0: 776f 726b 6572 7320 3d20 5461 6250 616e  workers = TabPan
-00042eb0: 656c 2863 6869 6c64 3d77 6f72 6b65 7273  el(child=workers
-00042ec0: 2c20 7469 746c 653d 2257 6f72 6b65 7220  , title="Worker 
-00042ed0: 5072 6f66 696c 6520 2861 646d 696e 6973  Profile (adminis
-00042ee0: 7472 6174 6976 6529 2229 0a20 2020 2020  trative)").     
-00042ef0: 2020 2073 6368 6564 756c 6572 203d 2054     scheduler = T
-00042f00: 6162 5061 6e65 6c28 0a20 2020 2020 2020  abPanel(.       
-00042f10: 2020 2020 2063 6869 6c64 3d73 6368 6564       child=sched
-00042f20: 756c 6572 2c20 7469 746c 653d 2253 6368  uler, title="Sch
-00042f30: 6564 756c 6572 2050 726f 6669 6c65 2028  eduler Profile (
-00042f40: 6164 6d69 6e69 7374 7261 7469 7665 2922  administrative)"
-00042f50: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00042f60: 2020 2074 6173 6b5f 7374 7265 616d 203d     task_stream =
-00042f70: 2054 6162 5061 6e65 6c28 6368 696c 643d   TabPanel(child=
-00042f80: 7461 736b 5f73 7472 6561 6d2c 2074 6974  task_stream, tit
-00042f90: 6c65 3d22 5461 736b 2053 7472 6561 6d22  le="Task Stream"
-00042fa0: 290a 2020 2020 2020 2020 6261 6e64 7769  ).        bandwi
-00042fb0: 6474 685f 776f 726b 6572 7320 3d20 5461  dth_workers = Ta
-00042fc0: 6250 616e 656c 280a 2020 2020 2020 2020  bPanel(.        
-00042fd0: 2020 2020 6368 696c 643d 6261 6e64 7769      child=bandwi
-00042fe0: 6474 685f 776f 726b 6572 732e 726f 6f74  dth_workers.root
-00042ff0: 2c20 7469 746c 653d 2242 616e 6477 6964  , title="Bandwid
-00043000: 7468 2028 576f 726b 6572 7329 220a 2020  th (Workers)".  
-00043010: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00043020: 6261 6e64 7769 6474 685f 7479 7065 7320  bandwidth_types 
-00043030: 3d20 5461 6250 616e 656c 280a 2020 2020  = TabPanel(.    
-00043040: 2020 2020 2020 2020 6368 696c 643d 6261          child=ba
-00043050: 6e64 7769 6474 685f 7479 7065 732e 726f  ndwidth_types.ro
-00043060: 6f74 2c20 7469 746c 653d 2242 616e 6477  ot, title="Bandw
-00043070: 6964 7468 2028 5479 7065 7329 220a 2020  idth (Types)".  
-00043080: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00043090: 7379 7374 656d 203d 2054 6162 5061 6e65  system = TabPane
-000430a0: 6c28 6368 696c 643d 7379 736d 6f6e 2e72  l(child=sysmon.r
-000430b0: 6f6f 742c 2074 6974 6c65 3d22 5379 7374  oot, title="Syst
-000430c0: 656d 2229 0a20 2020 2020 2020 206c 6f67  em").        log
-000430d0: 7320 3d20 5461 6250 616e 656c 2863 6869  s = TabPanel(chi
-000430e0: 6c64 3d6c 6f67 732e 726f 6f74 2c20 7469  ld=logs.root, ti
-000430f0: 746c 653d 2253 6368 6564 756c 6572 204c  tle="Scheduler L
-00043100: 6f67 7322 290a 0a20 2020 2020 2020 2074  ogs")..        t
-00043110: 6162 7320 3d20 5461 6273 280a 2020 2020  abs = Tabs(.    
-00043120: 2020 2020 2020 2020 7461 6273 3d5b 0a20          tabs=[. 
-00043130: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00043140: 746d 6c2c 0a20 2020 2020 2020 2020 2020  tml,.           
-00043150: 2020 2020 2074 6173 6b5f 7374 7265 616d       task_stream
-00043160: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00043170: 2020 7379 7374 656d 2c0a 2020 2020 2020    system,.      
-00043180: 2020 2020 2020 2020 2020 6c6f 6773 2c0a            logs,.
-00043190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000431a0: 636f 6d70 7574 652c 0a20 2020 2020 2020  compute,.       
-000431b0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-000431c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000431d0: 2020 7363 6865 6475 6c65 722c 0a20 2020    scheduler,.   
-000431e0: 2020 2020 2020 2020 2020 2020 2062 616e               ban
-000431f0: 6477 6964 7468 5f77 6f72 6b65 7273 2c0a  dwidth_workers,.
-00043200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043210: 6261 6e64 7769 6474 685f 7479 7065 732c  bandwidth_types,
-00043220: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-00043230: 2020 2020 2020 2020 2020 2020 7369 7a69              sizi
-00043240: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-00043250: 5f62 6f74 6822 2c0a 2020 2020 2020 2020  _both",.        
-00043260: 290a 0a20 2020 2020 2020 2066 726f 6d20  )..        from 
-00043270: 626f 6b65 682e 636f 7265 2e74 656d 706c  bokeh.core.templ
-00043280: 6174 6573 2069 6d70 6f72 7420 6765 745f  ates import get_
-00043290: 656e 760a 2020 2020 2020 2020 6672 6f6d  env.        from
-000432a0: 2062 6f6b 6568 2e70 6c6f 7474 696e 6720   bokeh.plotting 
-000432b0: 696d 706f 7274 206f 7574 7075 745f 6669  import output_fi
-000432c0: 6c65 2c20 7361 7665 0a0a 2020 2020 2020  le, save..      
-000432d0: 2020 7769 7468 2074 6d70 6669 6c65 2865    with tmpfile(e
-000432e0: 7874 656e 7369 6f6e 3d22 2e68 746d 6c22  xtension=".html"
-000432f0: 2920 6173 2066 6e3a 0a20 2020 2020 2020  ) as fn:.       
-00043300: 2020 2020 206f 7574 7075 745f 6669 6c65       output_file
-00043310: 2866 696c 656e 616d 653d 666e 2c20 7469  (filename=fn, ti
-00043320: 746c 653d 2244 6173 6b20 5065 7266 6f72  tle="Dask Perfor
-00043330: 6d61 6e63 6520 5265 706f 7274 222c 206d  mance Report", m
-00043340: 6f64 653d 6d6f 6465 290a 2020 2020 2020  ode=mode).      
-00043350: 2020 2020 2020 7465 6d70 6c61 7465 5f64        template_d
-00043360: 6972 6563 746f 7279 203d 206f 732e 7061  irectory = os.pa
-00043370: 7468 2e6a 6f69 6e28 0a20 2020 2020 2020  th.join(.       
-00043380: 2020 2020 2020 2020 206f 732e 7061 7468           os.path
-00043390: 2e64 6972 6e61 6d65 286f 732e 7061 7468  .dirname(os.path
-000433a0: 2e61 6273 7061 7468 285f 5f66 696c 655f  .abspath(__file_
-000433b0: 5f29 292c 2022 6461 7368 626f 6172 6422  _)), "dashboard"
-000433c0: 2c20 2274 656d 706c 6174 6573 220a 2020  , "templates".  
-000433d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000433e0: 2020 2020 2020 2020 7465 6d70 6c61 7465          template
-000433f0: 5f65 6e76 6972 6f6e 6d65 6e74 203d 2067  _environment = g
-00043400: 6574 5f65 6e76 2829 0a20 2020 2020 2020  et_env().       
-00043410: 2020 2020 2074 656d 706c 6174 655f 656e       template_en
-00043420: 7669 726f 6e6d 656e 742e 6c6f 6164 6572  vironment.loader
-00043430: 2e73 6561 7263 6870 6174 682e 6170 7065  .searchpath.appe
-00043440: 6e64 2874 656d 706c 6174 655f 6469 7265  nd(template_dire
-00043450: 6374 6f72 7929 0a20 2020 2020 2020 2020  ctory).         
-00043460: 2020 2074 656d 706c 6174 6520 3d20 7465     template = te
-00043470: 6d70 6c61 7465 5f65 6e76 6972 6f6e 6d65  mplate_environme
-00043480: 6e74 2e67 6574 5f74 656d 706c 6174 6528  nt.get_template(
-00043490: 2270 6572 666f 726d 616e 6365 5f72 6570  "performance_rep
-000434a0: 6f72 742e 6874 6d6c 2229 0a20 2020 2020  ort.html").     
-000434b0: 2020 2020 2020 2073 6176 6528 7461 6273         save(tabs
-000434c0: 2c20 6669 6c65 6e61 6d65 3d66 6e2c 2074  , filename=fn, t
-000434d0: 656d 706c 6174 653d 7465 6d70 6c61 7465  emplate=template
-000434e0: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
-000434f0: 6974 6820 6f70 656e 2866 6e29 2061 7320  ith open(fn) as 
-00043500: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
-00043510: 2020 2064 6174 6120 3d20 662e 7265 6164     data = f.read
-00043520: 2829 0a0a 2020 2020 2020 2020 7265 7475  ()..        retu
-00043530: 726e 2064 6174 610a 0a20 2020 2061 7379  rn data..    asy
-00043540: 6e63 2064 6566 2067 6574 5f77 6f72 6b65  nc def get_worke
-00043550: 725f 6c6f 6773 2873 656c 662c 206e 3d4e  r_logs(self, n=N
-00043560: 6f6e 652c 2077 6f72 6b65 7273 3d4e 6f6e  one, workers=Non
-00043570: 652c 206e 616e 6e79 3d46 616c 7365 293a  e, nanny=False):
-00043580: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-00043590: 203d 2061 7761 6974 2073 656c 662e 6272   = await self.br
-000435a0: 6f61 6463 6173 7428 0a20 2020 2020 2020  oadcast(.       
-000435b0: 2020 2020 206d 7367 3d7b 226f 7022 3a20       msg={"op": 
-000435c0: 2267 6574 5f6c 6f67 7322 2c20 226e 223a  "get_logs", "n":
-000435d0: 206e 7d2c 2077 6f72 6b65 7273 3d77 6f72   n}, workers=wor
-000435e0: 6b65 7273 2c20 6e61 6e6e 793d 6e61 6e6e  kers, nanny=nann
-000435f0: 790a 2020 2020 2020 2020 290a 2020 2020  y.        ).    
-00043600: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00043610: 7473 0a0a 2020 2020 6465 6620 6c6f 675f  ts..    def log_
-00043620: 6576 656e 7428 7365 6c66 2c20 746f 7069  event(self, topi
-00043630: 633a 2073 7472 207c 2043 6f6c 6c65 6374  c: str | Collect
-00043640: 696f 6e5b 7374 725d 2c20 6d73 673a 2041  ion[str], msg: A
-00043650: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
-00043660: 2020 2020 2065 7665 6e74 203d 2028 7469       event = (ti
-00043670: 6d65 2829 2c20 6d73 6729 0a20 2020 2020  me(), msg).     
-00043680: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-00043690: 616e 6365 2874 6f70 6963 2c20 7374 7229  ance(topic, str)
-000436a0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-000436b0: 7220 7420 696e 2074 6f70 6963 3a0a 2020  r t in topic:.  
-000436c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000436d0: 6c66 2e65 7665 6e74 735b 745d 2e61 7070  lf.events[t].app
-000436e0: 656e 6428 6576 656e 7429 0a20 2020 2020  end(event).     
-000436f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00043700: 6576 656e 745f 636f 756e 7473 5b74 5d20  event_counts[t] 
-00043710: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-00043720: 2020 2020 2073 656c 662e 5f72 6570 6f72       self._repor
-00043730: 745f 6576 656e 7428 742c 2065 7665 6e74  t_event(t, event
-00043740: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00043750: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00043760: 2e65 7665 6e74 735b 746f 7069 635d 2e61  .events[topic].a
-00043770: 7070 656e 6428 6576 656e 7429 0a20 2020  ppend(event).   
-00043780: 2020 2020 2020 2020 2073 656c 662e 6576           self.ev
-00043790: 656e 745f 636f 756e 7473 5b74 6f70 6963  ent_counts[topic
-000437a0: 5d20 2b3d 2031 0a20 2020 2020 2020 2020  ] += 1.         
-000437b0: 2020 2073 656c 662e 5f72 6570 6f72 745f     self._report_
-000437c0: 6576 656e 7428 746f 7069 632c 2065 7665  event(topic, eve
-000437d0: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
-000437e0: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
-000437f0: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
-00043800: 2e76 616c 7565 7328 2929 3a0a 2020 2020  .values()):.    
-00043810: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00043820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043830: 2020 2020 2070 6c75 6769 6e2e 6c6f 675f       plugin.log_
-00043840: 6576 656e 7428 746f 7069 632c 206d 7367  event(topic, msg
-00043850: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00043860: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00043870: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00043880: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00043890: 6e66 6f28 2250 6c75 6769 6e20 6661 696c  nfo("Plugin fail
-000438a0: 6564 2077 6974 6820 6578 6365 7074 696f  ed with exceptio
-000438b0: 6e22 2c20 6578 635f 696e 666f 3d54 7275  n", exc_info=Tru
-000438c0: 6529 0a0a 2020 2020 6465 6620 5f72 6570  e)..    def _rep
-000438d0: 6f72 745f 6576 656e 7428 7365 6c66 2c20  ort_event(self, 
-000438e0: 6e61 6d65 2c20 6576 656e 7429 3a0a 2020  name, event):.  
-000438f0: 2020 2020 2020 6d73 6720 3d20 7b0a 2020        msg = {.  
-00043900: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-00043910: 2265 7665 6e74 222c 0a20 2020 2020 2020  "event",.       
-00043920: 2020 2020 2022 746f 7069 6322 3a20 6e61       "topic": na
-00043930: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00043940: 2265 7665 6e74 223a 2065 7665 6e74 2c0a  "event": event,.
-00043950: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00043960: 2020 636c 6965 6e74 5f6d 7367 7320 3d20    client_msgs = 
-00043970: 7b63 6c69 656e 743a 205b 6d73 675d 2066  {client: [msg] f
-00043980: 6f72 2063 6c69 656e 7420 696e 2073 656c  or client in sel
-00043990: 662e 6576 656e 745f 7375 6273 6372 6962  f.event_subscrib
-000439a0: 6572 5b6e 616d 655d 7d0a 2020 2020 2020  er[name]}.      
-000439b0: 2020 7365 6c66 2e73 656e 645f 616c 6c28    self.send_all(
-000439c0: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-000439d0: 6b65 725f 6d73 6773 3d7b 7d29 0a0a 2020  ker_msgs={})..  
-000439e0: 2020 6465 6620 7375 6273 6372 6962 655f    def subscribe_
-000439f0: 746f 7069 6328 7365 6c66 2c20 746f 7069  topic(self, topi
-00043a00: 632c 2063 6c69 656e 7429 3a0a 2020 2020  c, client):.    
-00043a10: 2020 2020 7365 6c66 2e65 7665 6e74 5f73      self.event_s
-00043a20: 7562 7363 7269 6265 725b 746f 7069 635d  ubscriber[topic]
-00043a30: 2e61 6464 2863 6c69 656e 7429 0a0a 2020  .add(client)..  
-00043a40: 2020 6465 6620 756e 7375 6273 6372 6962    def unsubscrib
-00043a50: 655f 746f 7069 6328 7365 6c66 2c20 746f  e_topic(self, to
-00043a60: 7069 632c 2063 6c69 656e 7429 3a0a 2020  pic, client):.  
-00043a70: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
-00043a80: 5f73 7562 7363 7269 6265 725b 746f 7069  _subscriber[topi
-00043a90: 635d 2e64 6973 6361 7264 2863 6c69 656e  c].discard(clien
-00043aa0: 7429 0a0a 2020 2020 6465 6620 6765 745f  t)..    def get_
-00043ab0: 6576 656e 7473 2873 656c 662c 2074 6f70  events(self, top
-00043ac0: 6963 3d4e 6f6e 6529 3a0a 2020 2020 2020  ic=None):.      
-00043ad0: 2020 6966 2074 6f70 6963 2069 7320 6e6f    if topic is no
-00043ae0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00043af0: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
-00043b00: 2873 656c 662e 6576 656e 7473 5b74 6f70  (self.events[top
-00043b10: 6963 5d29 0a20 2020 2020 2020 2065 6c73  ic]).        els
-00043b20: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00043b30: 6574 7572 6e20 7661 6c6d 6170 2874 7570  eturn valmap(tup
-00043b40: 6c65 2c20 7365 6c66 2e65 7665 6e74 7329  le, self.events)
-00043b50: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00043b60: 6765 745f 776f 726b 6572 5f6d 6f6e 6974  get_worker_monit
-00043b70: 6f72 5f69 6e66 6f28 7365 6c66 2c20 7265  or_info(self, re
-00043b80: 6365 6e74 3d46 616c 7365 2c20 7374 6172  cent=False, star
-00043b90: 7473 3d4e 6f6e 6529 3a0a 2020 2020 2020  ts=None):.      
-00043ba0: 2020 6966 2073 7461 7274 7320 6973 204e    if starts is N
-00043bb0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00043bc0: 2073 7461 7274 7320 3d20 7b7d 0a20 2020   starts = {}.   
-00043bd0: 2020 2020 2072 6573 756c 7473 203d 2061       results = a
-00043be0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-00043bf0: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-00043c00: 202a 280a 2020 2020 2020 2020 2020 2020   *(.            
-00043c10: 2020 2020 7365 6c66 2e72 7063 2877 292e      self.rpc(w).
-00043c20: 6765 745f 6d6f 6e69 746f 725f 696e 666f  get_monitor_info
-00043c30: 2872 6563 656e 743d 7265 6365 6e74 2c20  (recent=recent, 
-00043c40: 7374 6172 743d 7374 6172 7473 2e67 6574  start=starts.get
-00043c50: 2877 2c20 3029 290a 2020 2020 2020 2020  (w, 0)).        
-00043c60: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
-00043c70: 2073 656c 662e 776f 726b 6572 730a 2020   self.workers.  
-00043c80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00043c90: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00043ca0: 7475 726e 2064 6963 7428 7a69 7028 7365  turn dict(zip(se
-00043cb0: 6c66 2e77 6f72 6b65 7273 2c20 7265 7375  lf.workers, resu
-00043cc0: 6c74 7329 290a 0a20 2020 2023 2323 2323  lts))..    #####
-00043cd0: 2323 2323 2323 0a20 2020 2023 2043 6c65  ######.    # Cle
-00043ce0: 616e 7570 2023 0a20 2020 2023 2323 2323  anup #.    #####
-00043cf0: 2323 2323 2323 0a0a 2020 2020 6173 796e  ######..    asyn
-00043d00: 6320 6465 6620 6368 6563 6b5f 776f 726b  c def check_work
-00043d10: 6572 5f74 746c 2873 656c 6629 3a0a 2020  er_ttl(self):.  
-00043d20: 2020 2020 2020 6e6f 7720 3d20 7469 6d65        now = time
-00043d30: 2829 0a20 2020 2020 2020 2073 7469 6d75  ().        stimu
-00043d40: 6c75 735f 6964 203d 2066 2263 6865 636b  lus_id = f"check
-00043d50: 2d77 6f72 6b65 722d 7474 6c2d 7b6e 6f77  -worker-ttl-{now
-00043d60: 7d22 0a20 2020 2020 2020 2066 6f72 2077  }".        for w
-00043d70: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
-00043d80: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
-00043d90: 2020 2020 2020 2020 6966 2028 7773 2e6c          if (ws.l
-00043da0: 6173 745f 7365 656e 203c 206e 6f77 202d  ast_seen < now -
-00043db0: 2073 656c 662e 776f 726b 6572 5f74 746c   self.worker_ttl
-00043dc0: 2920 616e 6420 280a 2020 2020 2020 2020  ) and (.        
-00043dd0: 2020 2020 2020 2020 7773 2e6c 6173 745f          ws.last_
-00043de0: 7365 656e 203c 206e 6f77 202d 2031 3020  seen < now - 10 
-00043df0: 2a20 6865 6172 7462 6561 745f 696e 7465  * heartbeat_inte
-00043e00: 7276 616c 286c 656e 2873 656c 662e 776f  rval(len(self.wo
-00043e10: 726b 6572 7329 290a 2020 2020 2020 2020  rkers)).        
-00043e20: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00043e30: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00043e40: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
-00043e50: 2020 2020 2020 2020 2020 2022 576f 726b             "Work
-00043e60: 6572 2066 6169 6c65 6420 746f 2068 6561  er failed to hea
-00043e70: 7274 6265 6174 2077 6974 6869 6e20 2573  rtbeat within %s
-00043e80: 2073 6563 6f6e 6473 2e20 436c 6f73 696e   seconds. Closin
-00043e90: 673a 2025 7322 2c0a 2020 2020 2020 2020  g: %s",.        
-00043ea0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00043eb0: 2e77 6f72 6b65 725f 7474 6c2c 0a20 2020  .worker_ttl,.   
-00043ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043ed0: 2077 732c 0a20 2020 2020 2020 2020 2020   ws,.           
-00043ee0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00043ef0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-00043f00: 662e 7265 6d6f 7665 5f77 6f72 6b65 7228  f.remove_worker(
-00043f10: 6164 6472 6573 733d 7773 2e61 6464 7265  address=ws.addre
-00043f20: 7373 2c20 7374 696d 756c 7573 5f69 643d  ss, stimulus_id=
-00043f30: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-00043f40: 2020 6465 6620 6368 6563 6b5f 6964 6c65    def check_idle
-00043f50: 2873 656c 6629 202d 3e20 696e 7420 7c20  (self) -> int | 
-00043f60: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-00043f70: 2073 656c 662e 7374 6174 7573 2069 6e20   self.status in 
-00043f80: 2853 7461 7475 732e 636c 6f73 696e 672c  (Status.closing,
-00043f90: 2053 7461 7475 732e 636c 6f73 6564 293a   Status.closed):
-00043fa0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00043fb0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
-00043fc0: 2020 6966 2073 656c 662e 7472 616e 7369    if self.transi
-00043fd0: 7469 6f6e 5f63 6f75 6e74 6572 2021 3d20  tion_counter != 
-00043fe0: 7365 6c66 2e5f 6964 6c65 5f74 7261 6e73  self._idle_trans
-00043ff0: 6974 696f 6e5f 636f 756e 7465 723a 0a20  ition_counter:. 
-00044000: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00044010: 5f69 646c 655f 7472 616e 7369 7469 6f6e  _idle_transition
-00044020: 5f63 6f75 6e74 6572 203d 2073 656c 662e  _counter = self.
-00044030: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-00044040: 6572 0a20 2020 2020 2020 2020 2020 2073  er.            s
-00044050: 656c 662e 6964 6c65 5f73 696e 6365 203d  elf.idle_since =
-00044060: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00044070: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
-00044080: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
-00044090: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
-000440a0: 7565 640a 2020 2020 2020 2020 2020 2020  ued.            
-000440b0: 6f72 2073 656c 662e 756e 7275 6e6e 6162  or self.unrunnab
-000440c0: 6c65 0a20 2020 2020 2020 2020 2020 206f  le.            o
-000440d0: 7220 616e 7928 5b77 732e 7072 6f63 6573  r any([ws.proces
-000440e0: 7369 6e67 2066 6f72 2077 7320 696e 2073  sing for ws in s
-000440f0: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
-00044100: 6573 2829 5d29 0a20 2020 2020 2020 2029  es()]).        )
-00044110: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00044120: 6c66 2e69 646c 655f 7369 6e63 6520 3d20  lf.idle_since = 
-00044130: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00044140: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-00044150: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00044160: 662e 6964 6c65 5f73 696e 6365 3a0a 2020  f.idle_since:.  
-00044170: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
-00044180: 646c 655f 7369 6e63 6520 3d20 7469 6d65  dle_since = time
-00044190: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-000441a0: 6574 7572 6e20 7365 6c66 2e69 646c 655f  eturn self.idle_
-000441b0: 7369 6e63 650a 0a20 2020 2020 2020 2069  since..        i
-000441c0: 6620 7365 6c66 2e69 646c 655f 7469 6d65  f self.idle_time
-000441d0: 6f75 743a 0a20 2020 2020 2020 2020 2020  out:.           
-000441e0: 2069 6620 7469 6d65 2829 203e 2073 656c   if time() > sel
-000441f0: 662e 6964 6c65 5f73 696e 6365 202b 2073  f.idle_since + s
-00044200: 656c 662e 6964 6c65 5f74 696d 656f 7574  elf.idle_timeout
-00044210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00044220: 2020 6173 7365 7274 2073 656c 662e 6964    assert self.id
-00044230: 6c65 5f73 696e 6365 0a20 2020 2020 2020  le_since.       
-00044240: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00044250: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-00044260: 2020 2020 2020 2020 2020 2253 6368 6564            "Sched
-00044270: 756c 6572 2063 6c6f 7369 6e67 2061 6674  uler closing aft
-00044280: 6572 2062 6569 6e67 2069 646c 6520 666f  er being idle fo
-00044290: 7220 2573 222c 0a20 2020 2020 2020 2020  r %s",.         
-000442a0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-000442b0: 745f 7469 6d65 2873 656c 662e 6964 6c65  t_time(self.idle
-000442c0: 5f74 696d 656f 7574 292c 0a20 2020 2020  _timeout),.     
-000442d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000442e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000442f0: 662e 5f6f 6e67 6f69 6e67 5f62 6163 6b67  f._ongoing_backg
-00044300: 726f 756e 645f 7461 736b 732e 6361 6c6c  round_tasks.call
-00044310: 5f73 6f6f 6e28 7365 6c66 2e63 6c6f 7365  _soon(self.close
-00044320: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00044330: 204e 6f6e 650a 0a20 2020 2064 6566 2061   None..    def a
-00044340: 6461 7074 6976 655f 7461 7267 6574 2873  daptive_target(s
-00044350: 656c 662c 2074 6172 6765 745f 6475 7261  elf, target_dura
-00044360: 7469 6f6e 3d4e 6f6e 6529 3a0a 2020 2020  tion=None):.    
-00044370: 2020 2020 2222 2244 6573 6972 6564 206e      """Desired n
-00044380: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
-00044390: 2062 6173 6564 206f 6e20 7468 6520 6375   based on the cu
-000443a0: 7272 656e 7420 776f 726b 6c6f 6164 0a0a  rrent workload..
-000443b0: 2020 2020 2020 2020 5468 6973 206c 6f6f          This loo
-000443c0: 6b73 2061 7420 7468 6520 6375 7272 656e  ks at the curren
-000443d0: 7420 7275 6e6e 696e 6720 7461 736b 7320  t running tasks 
-000443e0: 616e 6420 6d65 6d6f 7279 2075 7365 2c20  and memory use, 
-000443f0: 616e 6420 7265 7475 726e 7320 610a 2020  and returns a.  
-00044400: 2020 2020 2020 6e75 6d62 6572 206f 6620        number of 
-00044410: 6465 7369 7265 6420 776f 726b 6572 732e  desired workers.
-00044420: 2020 5468 6973 2069 7320 6f66 7465 6e20    This is often 
-00044430: 7573 6564 2062 7920 6164 6170 7469 7665  used by adaptive
-00044440: 2073 6368 6564 756c 696e 672e 0a0a 2020   scheduling...  
-00044450: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
-00044460: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00044470: 2d2d 2d0a 2020 2020 2020 2020 7461 7267  ---.        targ
-00044480: 6574 5f64 7572 6174 696f 6e20 3a20 7374  et_duration : st
-00044490: 720a 2020 2020 2020 2020 2020 2020 4120  r.            A 
-000444a0: 6465 7369 7265 6420 6475 7261 7469 6f6e  desired duration
-000444b0: 206f 6620 7469 6d65 2066 6f72 2063 6f6d   of time for com
-000444c0: 7075 7461 7469 6f6e 7320 746f 2074 616b  putations to tak
-000444d0: 652e 2020 5468 6973 2061 6666 6563 7473  e.  This affects
-000444e0: 0a20 2020 2020 2020 2020 2020 2068 6f77  .            how
-000444f0: 2072 6170 6964 6c79 2074 6865 2073 6368   rapidly the sch
-00044500: 6564 756c 6572 2077 696c 6c20 6173 6b20  eduler will ask 
-00044510: 746f 2073 6361 6c65 2e0a 0a20 2020 2020  to scale...     
-00044520: 2020 2053 6565 2041 6c73 6f0a 2020 2020     See Also.    
-00044530: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-00044540: 2020 2020 2064 6973 7472 6962 7574 6564       distributed
-00044550: 2e64 6570 6c6f 792e 4164 6170 7469 7665  .deploy.Adaptive
-00044560: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00044570: 2020 2020 2069 6620 7461 7267 6574 5f64       if target_d
-00044580: 7572 6174 696f 6e20 6973 204e 6f6e 653a  uration is None:
-00044590: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
-000445a0: 6765 745f 6475 7261 7469 6f6e 203d 2064  get_duration = d
-000445b0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-000445c0: 6469 7374 7269 6275 7465 642e 6164 6170  distributed.adap
-000445d0: 7469 7665 2e74 6172 6765 742d 6475 7261  tive.target-dura
-000445e0: 7469 6f6e 2229 0a20 2020 2020 2020 2074  tion").        t
-000445f0: 6172 6765 745f 6475 7261 7469 6f6e 203d  arget_duration =
-00044600: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
-00044610: 2874 6172 6765 745f 6475 7261 7469 6f6e  (target_duration
-00044620: 290a 0a20 2020 2020 2020 2023 2043 5055  )..        # CPU
-00044630: 0a0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
-00044640: 2063 6f6e 7369 6465 7220 616e 7920 7573   consider any us
-00044650: 6572 2d73 7065 6369 6669 6564 2064 6566  er-specified def
-00044660: 6175 6c74 2074 6173 6b20 6475 7261 7469  ault task durati
-00044670: 6f6e 7320 666f 7220 7175 6575 6564 2074  ons for queued t
-00044680: 6173 6b73 0a20 2020 2020 2020 2071 7565  asks.        que
-00044690: 7565 645f 6f63 6375 7061 6e63 7920 3d20  ued_occupancy = 
-000446a0: 6c65 6e28 7365 6c66 2e71 7565 7565 6429  len(self.queued)
-000446b0: 202a 2073 656c 662e 554e 4b4e 4f57 4e5f   * self.UNKNOWN_
-000446c0: 5441 534b 5f44 5552 4154 494f 4e0a 2020  TASK_DURATION.  
-000446d0: 2020 2020 2020 6370 7520 3d20 6d61 7468        cpu = math
-000446e0: 2e63 6569 6c28 0a20 2020 2020 2020 2020  .ceil(.         
-000446f0: 2020 2028 7365 6c66 2e74 6f74 616c 5f6f     (self.total_o
-00044700: 6363 7570 616e 6379 202b 2071 7565 7565  ccupancy + queue
-00044710: 645f 6f63 6375 7061 6e63 7929 202f 2074  d_occupancy) / t
-00044720: 6172 6765 745f 6475 7261 7469 6f6e 0a20  arget_duration. 
-00044730: 2020 2020 2020 2029 2020 2320 544f 444f         )  # TODO
-00044740: 3a20 7468 7265 6164 7320 7065 7220 776f  : threads per wo
-00044750: 726b 6572 0a0a 2020 2020 2020 2020 2320  rker..        # 
-00044760: 4176 6f69 6420 6120 6665 7720 6c6f 6e67  Avoid a few long
-00044770: 2074 6173 6b73 2066 726f 6d20 6173 6b69   tasks from aski
-00044780: 6e67 2066 6f72 206d 616e 7920 636f 7265  ng for many core
-00044790: 730a 2020 2020 2020 2020 7461 736b 735f  s.        tasks_
-000447a0: 7265 6164 7920 3d20 6c65 6e28 7365 6c66  ready = len(self
-000447b0: 2e71 7565 7565 6429 0a20 2020 2020 2020  .queued).       
-000447c0: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-000447d0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-000447e0: 3a0a 2020 2020 2020 2020 2020 2020 7461  :.            ta
-000447f0: 736b 735f 7265 6164 7920 2b3d 206c 656e  sks_ready += len
-00044800: 2877 732e 7072 6f63 6573 7369 6e67 290a  (ws.processing).
-00044810: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00044820: 7461 736b 735f 7265 6164 7920 3e20 6370  tasks_ready > cp
-00044830: 753a 0a20 2020 2020 2020 2020 2020 2020  u:.             
-00044840: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
-00044850: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00044860: 2020 2063 7075 203d 206d 696e 2874 6173     cpu = min(tas
-00044870: 6b73 5f72 6561 6479 2c20 6370 7529 0a0a  ks_ready, cpu)..
-00044880: 2020 2020 2020 2020 6966 2028 7365 6c66          if (self
-00044890: 2e75 6e72 756e 6e61 626c 6520 6f72 2073  .unrunnable or s
-000448a0: 656c 662e 7175 6575 6564 2920 616e 6420  elf.queued) and 
-000448b0: 6e6f 7420 7365 6c66 2e77 6f72 6b65 7273  not self.workers
-000448c0: 3a0a 2020 2020 2020 2020 2020 2020 6370  :.            cp
-000448d0: 7520 3d20 6d61 7828 312c 2063 7075 290a  u = max(1, cpu).
-000448e0: 0a20 2020 2020 2020 2023 2061 6464 206d  .        # add m
-000448f0: 6f72 6520 776f 726b 6572 7320 6966 206d  ore workers if m
-00044900: 6f72 6520 7468 616e 2036 3025 206f 6620  ore than 60% of 
-00044910: 6d65 6d6f 7279 2069 7320 7573 6564 0a20  memory is used. 
-00044920: 2020 2020 2020 206c 696d 6974 203d 2073         limit = s
-00044930: 756d 2877 732e 6d65 6d6f 7279 5f6c 696d  um(ws.memory_lim
-00044940: 6974 2066 6f72 2077 7320 696e 2073 656c  it for ws in sel
-00044950: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
-00044960: 2829 290a 2020 2020 2020 2020 7573 6564  ()).        used
-00044970: 203d 2073 756d 2877 732e 6e62 7974 6573   = sum(ws.nbytes
-00044980: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-00044990: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-000449a0: 290a 2020 2020 2020 2020 6d65 6d6f 7279  ).        memory
-000449b0: 203d 2030 0a20 2020 2020 2020 2069 6620   = 0.        if 
-000449c0: 7573 6564 203e 2030 2e36 202a 206c 696d  used > 0.6 * lim
-000449d0: 6974 2061 6e64 206c 696d 6974 203e 2030  it and limit > 0
-000449e0: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
-000449f0: 6d6f 7279 203d 2032 202a 206c 656e 2873  mory = 2 * len(s
-00044a00: 656c 662e 776f 726b 6572 7329 0a0a 2020  elf.workers)..  
-00044a10: 2020 2020 2020 7461 7267 6574 203d 206d        target = m
-00044a20: 6178 286d 656d 6f72 792c 2063 7075 290a  ax(memory, cpu).
-00044a30: 2020 2020 2020 2020 6966 2074 6172 6765          if targe
-00044a40: 7420 3e3d 206c 656e 2873 656c 662e 776f  t >= len(self.wo
-00044a50: 726b 6572 7329 3a0a 2020 2020 2020 2020  rkers):.        
-00044a60: 2020 2020 7265 7475 726e 2074 6172 6765      return targe
-00044a70: 740a 2020 2020 2020 2020 656c 7365 3a20  t.        else: 
-00044a80: 2023 2053 6361 6c65 2064 6f77 6e3f 0a20   # Scale down?. 
-00044a90: 2020 2020 2020 2020 2020 2074 6f5f 636c             to_cl
-00044aa0: 6f73 6520 3d20 7365 6c66 2e77 6f72 6b65  ose = self.worke
-00044ab0: 7273 5f74 6f5f 636c 6f73 6528 290a 2020  rs_to_close().  
-00044ac0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00044ad0: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
-00044ae0: 7329 202d 206c 656e 2874 6f5f 636c 6f73  s) - len(to_clos
-00044af0: 6529 0a0a 2020 2020 6465 6620 7265 7175  e)..    def requ
-00044b00: 6573 745f 6163 7175 6972 655f 7265 706c  est_acquire_repl
-00044b10: 6963 6173 280a 2020 2020 2020 2020 7365  icas(.        se
-00044b20: 6c66 2c20 6164 6472 3a20 7374 722c 206b  lf, addr: str, k
-00044b30: 6579 733a 2049 7465 7261 626c 655b 7374  eys: Iterable[st
-00044b40: 725d 2c20 2a2c 2073 7469 6d75 6c75 735f  r], *, stimulus_
-00044b50: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-00044b60: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00044b70: 2222 4173 796e 6368 726f 6e6f 7573 6c79  ""Asynchronously
-00044b80: 2061 736b 2061 2077 6f72 6b65 7220 746f   ask a worker to
-00044b90: 2061 6371 7569 7265 2061 2072 6570 6c69   acquire a repli
-00044ba0: 6361 206f 6620 7468 6520 6c69 7374 6564  ca of the listed
-00044bb0: 206b 6579 7320 6672 6f6d 0a20 2020 2020   keys from.     
-00044bc0: 2020 206f 7468 6572 2077 6f72 6b65 7273     other workers
-00044bd0: 2e20 5468 6973 2069 7320 6120 6669 7265  . This is a fire
-00044be0: 2d61 6e64 2d66 6f72 6765 7420 6f70 6572  -and-forget oper
-00044bf0: 6174 696f 6e20 7768 6963 6820 6f66 6665  ation which offe
-00044c00: 7273 206e 6f20 6665 6564 6261 636b 2066  rs no feedback f
-00044c10: 6f72 0a20 2020 2020 2020 2073 7563 6365  or.        succe
-00044c20: 7373 206f 7220 6661 696c 7572 652c 2061  ss or failure, a
-00044c30: 6e64 2069 7320 696e 7465 6e64 6564 2066  nd is intended f
-00044c40: 6f72 2068 6f75 7365 6b65 6570 696e 6720  or housekeeping 
-00044c50: 616e 6420 6e6f 7420 666f 7220 636f 6d70  and not for comp
-00044c60: 7574 6174 696f 6e2e 0a20 2020 2020 2020  utation..       
-00044c70: 2022 2222 0a20 2020 2020 2020 2077 686f   """.        who
-00044c80: 5f68 6173 203d 207b 7d0a 2020 2020 2020  _has = {}.      
-00044c90: 2020 6e62 7974 6573 203d 207b 7d0a 2020    nbytes = {}.  
-00044ca0: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-00044cb0: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
-00044cc0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00044cd0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-00044ce0: 2020 2020 6173 7365 7274 2074 732e 7768      assert ts.wh
-00044cf0: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
-00044d00: 2020 7768 6f5f 6861 735b 6b65 795d 203d    who_has[key] =
-00044d10: 205b 7773 2e61 6464 7265 7373 2066 6f72   [ws.address for
-00044d20: 2077 7320 696e 2074 732e 7768 6f5f 6861   ws in ts.who_ha
-00044d30: 735d 0a20 2020 2020 2020 2020 2020 206e  s].            n
-00044d40: 6279 7465 735b 6b65 795d 203d 2074 732e  bytes[key] = ts.
-00044d50: 6e62 7974 6573 0a0a 2020 2020 2020 2020  nbytes..        
-00044d60: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00044d70: 735b 6164 6472 5d2e 7365 6e64 280a 2020  s[addr].send(.  
-00044d80: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00044d90: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
-00044da0: 3a20 2261 6371 7569 7265 2d72 6570 6c69  : "acquire-repli
-00044db0: 6361 7322 2c0a 2020 2020 2020 2020 2020  cas",.          
-00044dc0: 2020 2020 2020 2277 686f 5f68 6173 223a        "who_has":
-00044dd0: 2077 686f 5f68 6173 2c0a 2020 2020 2020   who_has,.      
-00044de0: 2020 2020 2020 2020 2020 226e 6279 7465            "nbyte
-00044df0: 7322 3a20 6e62 7974 6573 2c0a 2020 2020  s": nbytes,.    
-00044e00: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-00044e10: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-00044e20: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-00044e30: 2020 2020 7d2c 0a20 2020 2020 2020 2029      },.        )
-00044e40: 0a0a 2020 2020 6465 6620 7265 7175 6573  ..    def reques
-00044e50: 745f 7265 6d6f 7665 5f72 6570 6c69 6361  t_remove_replica
-00044e60: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-00044e70: 2061 6464 723a 2073 7472 2c20 6b65 7973   addr: str, keys
-00044e80: 3a20 6c69 7374 5b73 7472 5d2c 202a 2c20  : list[str], *, 
-00044e90: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00044ea0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00044eb0: 2020 2020 2020 2020 2222 2241 7379 6e63          """Async
-00044ec0: 6872 6f6e 6f75 736c 7920 6173 6b20 6120  hronously ask a 
-00044ed0: 776f 726b 6572 2074 6f20 6469 7363 6172  worker to discar
-00044ee0: 6420 6974 7320 7265 706c 6963 6120 6f66  d its replica of
-00044ef0: 2074 6865 206c 6973 7465 6420 6b65 7973   the listed keys
-00044f00: 2e0a 2020 2020 2020 2020 5468 6973 206d  ..        This m
-00044f10: 7573 7420 6e65 7665 7220 6265 2075 7365  ust never be use
-00044f20: 6420 746f 2064 6573 7472 6f79 2074 6865  d to destroy the
-00044f30: 206c 6173 7420 7265 706c 6963 6120 6f66   last replica of
-00044f40: 2061 206b 6579 2e20 5468 6973 2069 7320   a key. This is 
-00044f50: 610a 2020 2020 2020 2020 6669 7265 2d61  a.        fire-a
-00044f60: 6e64 2d66 6f72 6765 7420 6f70 6572 6174  nd-forget operat
-00044f70: 696f 6e2c 2069 6e74 656e 6465 6420 666f  ion, intended fo
-00044f80: 7220 686f 7573 656b 6565 7069 6e67 2061  r housekeeping a
-00044f90: 6e64 206e 6f74 2066 6f72 2063 6f6d 7075  nd not for compu
-00044fa0: 7461 7469 6f6e 2e0a 0a20 2020 2020 2020  tation...       
-00044fb0: 2054 6865 2072 6570 6c69 6361 2064 6973   The replica dis
-00044fc0: 6170 7065 6172 7320 696d 6d65 6469 6174  appears immediat
-00044fd0: 656c 7920 6672 6f6d 2054 6173 6b53 7461  ely from TaskSta
-00044fe0: 7465 2e77 686f 5f68 6173 206f 6e20 7468  te.who_has on th
-00044ff0: 6520 5363 6865 6475 6c65 7220 7369 6465  e Scheduler side
-00045000: 3b0a 2020 2020 2020 2020 6966 2074 6865  ;.        if the
-00045010: 2077 6f72 6b65 7220 7265 6675 7365 7320   worker refuses 
-00045020: 746f 2064 656c 6574 652c 2065 2e67 2e20  to delete, e.g. 
-00045030: 6265 6361 7573 6520 7468 6520 7461 736b  because the task
-00045040: 2069 7320 6120 6465 7065 6e64 656e 6379   is a dependency
-00045050: 206f 660a 2020 2020 2020 2020 616e 6f74   of.        anot
-00045060: 6865 7220 7461 736b 2072 756e 6e69 6e67  her task running
-00045070: 206f 6e20 6974 2c20 6974 2077 696c 6c20   on it, it will 
-00045080: 2861 6c73 6f20 6173 796e 6368 726f 6e6f  (also asynchrono
-00045090: 7573 6c79 2920 696e 666f 726d 2074 6865  usly) inform the
-000450a0: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
-000450b0: 2020 2074 6f20 7265 2d61 6464 2069 7473     to re-add its
-000450c0: 656c 6620 746f 2077 686f 5f68 6173 2e20  elf to who_has. 
-000450d0: 4966 2074 6865 2077 6f72 6b65 7220 6167  If the worker ag
-000450e0: 7265 6573 2074 6f20 6469 7363 6172 6420  rees to discard 
-000450f0: 7468 6520 7461 736b 2c20 7468 6572 6520  the task, there 
-00045100: 6973 0a20 2020 2020 2020 206e 6f20 6665  is.        no fe
-00045110: 6564 6261 636b 2e0a 2020 2020 2020 2020  edback..        
-00045120: 2222 220a 2020 2020 2020 2020 7773 203d  """.        ws =
-00045130: 2073 656c 662e 776f 726b 6572 735b 6164   self.workers[ad
-00045140: 6472 5d0a 0a20 2020 2020 2020 2023 2054  dr]..        # T
-00045150: 6865 2073 6368 6564 756c 6572 2069 6d6d  he scheduler imm
-00045160: 6564 6961 7465 6c79 2066 6f72 6765 7473  ediately forgets
-00045170: 2061 626f 7574 2074 6865 2072 6570 6c69   about the repli
-00045180: 6361 2061 6e64 2073 7567 6765 7374 7320  ca and suggests 
-00045190: 7468 6520 776f 726b 6572 2074 6f0a 2020  the worker to.  
-000451a0: 2020 2020 2020 2320 6472 6f70 2069 742e        # drop it.
-000451b0: 2054 6865 2077 6f72 6b65 7220 6d61 7920   The worker may 
-000451c0: 7265 6675 7365 2c20 6174 2077 6869 6368  refuse, at which
-000451d0: 2070 6f69 6e74 2069 7420 7769 6c6c 2073   point it will s
-000451e0: 656e 6420 6261 636b 2061 6e20 6164 642d  end back an add-
-000451f0: 6b65 7973 0a20 2020 2020 2020 2023 206d  keys.        # m
-00045200: 6573 7361 6765 2074 6f20 7265 696e 7374  essage to reinst
-00045210: 6174 6520 6974 2e0a 2020 2020 2020 2020  ate it..        
-00045220: 666f 7220 6b65 7920 696e 206b 6579 733a  for key in keys:
-00045230: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
-00045240: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00045250: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00045260: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-00045270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045280: 2320 446f 206e 6f74 2064 6573 7472 6f79  # Do not destroy
-00045290: 2074 6865 206c 6173 7420 636f 7079 0a20   the last copy. 
-000452a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000452b0: 7373 6572 7420 6c65 6e28 7473 2e77 686f  ssert len(ts.who
-000452c0: 5f68 6173 2920 3e20 310a 2020 2020 2020  _has) > 1.      
-000452d0: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-000452e0: 655f 7265 706c 6963 6128 7473 2c20 7773  e_replica(ts, ws
-000452f0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00045300: 7374 7265 616d 5f63 6f6d 6d73 5b61 6464  stream_comms[add
-00045310: 725d 2e73 656e 6428 0a20 2020 2020 2020  r].send(.       
-00045320: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00045330: 2020 2020 2020 2022 6f70 223a 2022 7265         "op": "re
-00045340: 6d6f 7665 2d72 6570 6c69 6361 7322 2c0a  move-replicas",.
-00045350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045360: 226b 6579 7322 3a20 6b65 7973 2c0a 2020  "keys": keys,.  
-00045370: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-00045380: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
-00045390: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
-000453a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000453b0: 290a 0a0a 6465 6620 5f74 6173 6b5f 746f  )...def _task_to
-000453c0: 5f72 6570 6f72 745f 6d73 6728 7473 3a20  _report_msg(ts: 
-000453d0: 5461 736b 5374 6174 6529 202d 3e20 6469  TaskState) -> di
-000453e0: 6374 5b73 7472 2c20 416e 795d 207c 204e  ct[str, Any] | N
-000453f0: 6f6e 653a 0a20 2020 2069 6620 7473 2e73  one:.    if ts.s
-00045400: 7461 7465 203d 3d20 2266 6f72 676f 7474  tate == "forgott
-00045410: 656e 223a 0a20 2020 2020 2020 2072 6574  en":.        ret
-00045420: 7572 6e20 7b22 6f70 223a 2022 6361 6e63  urn {"op": "canc
-00045430: 656c 6c65 642d 6b65 7973 222c 2022 6b65  elled-keys", "ke
-00045440: 7973 223a 205b 7473 2e6b 6579 5d7d 0a20  ys": [ts.key]}. 
-00045450: 2020 2065 6c69 6620 7473 2e73 7461 7465     elif ts.state
-00045460: 203d 3d20 226d 656d 6f72 7922 3a0a 2020   == "memory":.  
-00045470: 2020 2020 2020 7265 7475 726e 207b 226f        return {"o
-00045480: 7022 3a20 226b 6579 2d69 6e2d 6d65 6d6f  p": "key-in-memo
-00045490: 7279 222c 2022 6b65 7922 3a20 7473 2e6b  ry", "key": ts.k
-000454a0: 6579 7d0a 2020 2020 656c 6966 2074 732e  ey}.    elif ts.
-000454b0: 7374 6174 6520 3d3d 2022 6572 7265 6422  state == "erred"
-000454c0: 3a0a 2020 2020 2020 2020 6661 696c 696e  :.        failin
-000454d0: 675f 7473 203d 2074 732e 6578 6365 7074  g_ts = ts.except
-000454e0: 696f 6e5f 626c 616d 650a 2020 2020 2020  ion_blame.      
-000454f0: 2020 6173 7365 7274 2066 6169 6c69 6e67    assert failing
-00045500: 5f74 730a 2020 2020 2020 2020 7265 7475  _ts.        retu
-00045510: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
-00045520: 2022 6f70 223a 2022 7461 736b 2d65 7272   "op": "task-err
-00045530: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
-00045540: 2022 6b65 7922 3a20 7473 2e6b 6579 2c0a   "key": ts.key,.
-00045550: 2020 2020 2020 2020 2020 2020 2265 7863              "exc
-00045560: 6570 7469 6f6e 223a 2066 6169 6c69 6e67  eption": failing
-00045570: 5f74 732e 6578 6365 7074 696f 6e2c 0a20  _ts.exception,. 
-00045580: 2020 2020 2020 2020 2020 2022 7472 6163             "trac
-00045590: 6562 6163 6b22 3a20 6661 696c 696e 675f  eback": failing_
-000455a0: 7473 2e74 7261 6365 6261 636b 2c0a 2020  ts.traceback,.  
-000455b0: 2020 2020 2020 7d0a 2020 2020 656c 7365        }.    else
-000455c0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000455d0: 204e 6f6e 650a 0a0a 6465 6620 5f74 6173   None...def _tas
-000455e0: 6b5f 746f 5f63 6c69 656e 745f 6d73 6773  k_to_client_msgs
-000455f0: 2874 733a 2054 6173 6b53 7461 7465 2920  (ts: TaskState) 
-00045600: 2d3e 2064 6963 745b 7374 722c 206c 6973  -> dict[str, lis
-00045610: 745b 6469 6374 5b73 7472 2c20 416e 795d  t[dict[str, Any]
-00045620: 5d5d 3a0a 2020 2020 6966 2074 732e 7768  ]]:.    if ts.wh
-00045630: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
-00045640: 2072 6570 6f72 745f 6d73 6720 3d20 5f74   report_msg = _t
-00045650: 6173 6b5f 746f 5f72 6570 6f72 745f 6d73  ask_to_report_ms
-00045660: 6728 7473 290a 2020 2020 2020 2020 6966  g(ts).        if
-00045670: 2072 6570 6f72 745f 6d73 6720 6973 206e   report_msg is n
-00045680: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00045690: 2020 2020 2072 6574 7572 6e20 7b63 732e       return {cs.
-000456a0: 636c 6965 6e74 5f6b 6579 3a20 5b72 6570  client_key: [rep
-000456b0: 6f72 745f 6d73 675d 2066 6f72 2063 7320  ort_msg] for cs 
-000456c0: 696e 2074 732e 7768 6f5f 7761 6e74 737d  in ts.who_wants}
-000456d0: 0a20 2020 2072 6574 7572 6e20 7b7d 0a0a  .    return {}..
-000456e0: 0a64 6566 2064 6563 6964 655f 776f 726b  .def decide_work
-000456f0: 6572 280a 2020 2020 7473 3a20 5461 736b  er(.    ts: Task
-00045700: 5374 6174 652c 0a20 2020 2061 6c6c 5f77  State,.    all_w
-00045710: 6f72 6b65 7273 3a20 4974 6572 6162 6c65  orkers: Iterable
-00045720: 5b57 6f72 6b65 7253 7461 7465 5d2c 0a20  [WorkerState],. 
-00045730: 2020 2076 616c 6964 5f77 6f72 6b65 7273     valid_workers
-00045740: 3a20 7365 745b 576f 726b 6572 5374 6174  : set[WorkerStat
-00045750: 655d 207c 204e 6f6e 652c 0a20 2020 206f  e] | None,.    o
-00045760: 626a 6563 7469 7665 3a20 4361 6c6c 6162  bjective: Callab
-00045770: 6c65 5b5b 576f 726b 6572 5374 6174 655d  le[[WorkerState]
-00045780: 2c20 416e 795d 2c0a 2920 2d3e 2057 6f72  , Any],.) -> Wor
-00045790: 6b65 7253 7461 7465 207c 204e 6f6e 653a  kerState | None:
-000457a0: 0a20 2020 2022 2222 0a20 2020 2044 6563  .    """.    Dec
-000457b0: 6964 6520 7768 6963 6820 776f 726b 6572  ide which worker
-000457c0: 2073 686f 756c 6420 7461 6b65 2074 6173   should take tas
-000457d0: 6b20 2a74 732a 2e0a 0a20 2020 2057 6520  k *ts*...    We 
-000457e0: 6368 6f6f 7365 2074 6865 2077 6f72 6b65  choose the worke
-000457f0: 7220 7468 6174 2068 6173 2074 6865 2064  r that has the d
-00045800: 6174 6120 6f6e 2077 6869 6368 202a 7473  ata on which *ts
-00045810: 2a20 6465 7065 6e64 732e 0a0a 2020 2020  * depends...    
-00045820: 4966 2073 6576 6572 616c 2077 6f72 6b65  If several worke
-00045830: 7273 2068 6176 6520 6465 7065 6e64 656e  rs have dependen
-00045840: 6369 6573 2074 6865 6e20 7765 2063 686f  cies then we cho
-00045850: 6f73 6520 7468 6520 6c65 7373 2d62 7573  ose the less-bus
-00045860: 7920 776f 726b 6572 2e0a 0a20 2020 204f  y worker...    O
-00045870: 7074 696f 6e61 6c6c 7920 7072 6f76 6964  ptionally provid
-00045880: 6520 2a76 616c 6964 5f77 6f72 6b65 7273  e *valid_workers
-00045890: 2a20 6f66 2077 6865 7265 206a 6f62 7320  * of where jobs 
-000458a0: 6172 6520 616c 6c6f 7765 6420 746f 206f  are allowed to o
-000458b0: 6363 7572 0a20 2020 2028 6966 2061 6c6c  ccur.    (if all
-000458c0: 2077 6f72 6b65 7273 2061 7265 2061 6c6c   workers are all
-000458d0: 6f77 6564 2074 6f20 7461 6b65 2074 6865  owed to take the
-000458e0: 2074 6173 6b2c 2070 6173 7320 4e6f 6e65   task, pass None
-000458f0: 2069 6e73 7465 6164 292e 0a0a 2020 2020   instead)...    
-00045900: 4966 2074 6865 2074 6173 6b20 7265 7175  If the task requ
-00045910: 6972 6573 2064 6174 6120 636f 6d6d 756e  ires data commun
-00045920: 6963 6174 696f 6e20 6265 6361 7573 6520  ication because 
-00045930: 6e6f 2065 6c69 6769 626c 6520 776f 726b  no eligible work
-00045940: 6572 2068 6173 0a20 2020 2061 6c6c 2074  er has.    all t
-00045950: 6865 2064 6570 656e 6465 6e63 6965 7320  he dependencies 
-00045960: 616c 7265 6164 792c 2074 6865 6e20 7765  already, then we
-00045970: 2063 686f 6f73 6520 746f 206d 696e 696d   choose to minim
-00045980: 697a 6520 7468 6520 6e75 6d62 6572 0a20  ize the number. 
-00045990: 2020 206f 6620 6279 7465 7320 7365 6e74     of bytes sent
-000459a0: 2062 6574 7765 656e 2077 6f72 6b65 7273   between workers
-000459b0: 2e20 2054 6869 7320 6973 2064 6574 6572  .  This is deter
-000459c0: 6d69 6e65 6420 6279 2063 616c 6c69 6e67  mined by calling
-000459d0: 2074 6865 0a20 2020 202a 6f62 6a65 6374   the.    *object
-000459e0: 6976 652a 2066 756e 6374 696f 6e2e 0a20  ive* function.. 
-000459f0: 2020 2022 2222 0a20 2020 2061 7373 6572     """.    asser
-00045a00: 7420 616c 6c28 6474 732e 7768 6f5f 6861  t all(dts.who_ha
-00045a10: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
-00045a20: 6465 7065 6e64 656e 6369 6573 290a 2020  dependencies).  
-00045a30: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
-00045a40: 2020 2020 2020 2063 616e 6469 6461 7465         candidate
-00045a50: 7320 3d20 7365 7428 616c 6c5f 776f 726b  s = set(all_work
-00045a60: 6572 7329 0a20 2020 2065 6c73 653a 0a20  ers).    else:. 
-00045a70: 2020 2020 2020 2063 616e 6469 6461 7465         candidate
-00045a80: 7320 3d20 7b77 7773 2066 6f72 2064 7473  s = {wws for dts
-00045a90: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
-00045aa0: 6965 7320 666f 7220 7777 7320 696e 2064  ies for wws in d
-00045ab0: 7473 2e77 686f 5f68 6173 7d0a 2020 2020  ts.who_has}.    
-00045ac0: 6966 2076 616c 6964 5f77 6f72 6b65 7273  if valid_workers
-00045ad0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00045ae0: 2020 6966 206e 6f74 2063 616e 6469 6461    if not candida
-00045af0: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
-00045b00: 2063 616e 6469 6461 7465 7320 3d20 7365   candidates = se
-00045b10: 7428 616c 6c5f 776f 726b 6572 7329 0a20  t(all_workers). 
-00045b20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00045b30: 2063 616e 6469 6461 7465 7320 263d 2076   candidates &= v
-00045b40: 616c 6964 5f77 6f72 6b65 7273 0a20 2020  alid_workers.   
-00045b50: 2020 2020 2069 6620 6e6f 7420 6361 6e64       if not cand
-00045b60: 6964 6174 6573 3a0a 2020 2020 2020 2020  idates:.        
-00045b70: 2020 2020 6361 6e64 6964 6174 6573 203d      candidates =
-00045b80: 2076 616c 6964 5f77 6f72 6b65 7273 0a20   valid_workers. 
-00045b90: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00045ba0: 7420 6361 6e64 6964 6174 6573 3a0a 2020  t candidates:.  
-00045bb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00045bc0: 2074 732e 6c6f 6f73 655f 7265 7374 7269   ts.loose_restri
-00045bd0: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
-00045be0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00045bf0: 726e 2064 6563 6964 655f 776f 726b 6572  rn decide_worker
-00045c00: 2874 732c 2061 6c6c 5f77 6f72 6b65 7273  (ts, all_workers
-00045c10: 2c20 4e6f 6e65 2c20 6f62 6a65 6374 6976  , None, objectiv
-00045c20: 6529 0a0a 2020 2020 6966 206e 6f74 2063  e)..    if not c
-00045c30: 616e 6469 6461 7465 733a 0a20 2020 2020  andidates:.     
-00045c40: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
-00045c50: 2020 2065 6c69 6620 6c65 6e28 6361 6e64     elif len(cand
-00045c60: 6964 6174 6573 2920 3d3d 2031 3a0a 2020  idates) == 1:.  
-00045c70: 2020 2020 2020 7265 7475 726e 206e 6578        return nex
-00045c80: 7428 6974 6572 2863 616e 6469 6461 7465  t(iter(candidate
-00045c90: 7329 290a 2020 2020 656c 7365 3a0a 2020  s)).    else:.  
-00045ca0: 2020 2020 2020 7265 7475 726e 206d 696e        return min
-00045cb0: 2863 616e 6469 6461 7465 732c 206b 6579  (candidates, key
-00045cc0: 3d6f 626a 6563 7469 7665 290a 0a0a 6465  =objective)...de
-00045cd0: 6620 7661 6c69 6461 7465 5f74 6173 6b5f  f validate_task_
-00045ce0: 7374 6174 6528 7473 3a20 5461 736b 5374  state(ts: TaskSt
-00045cf0: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-00045d00: 2020 2222 2256 616c 6964 6174 6520 7468    """Validate th
-00045d10: 6520 6769 7665 6e20 5461 736b 5374 6174  e given TaskStat
-00045d20: 6522 2222 0a20 2020 2061 7373 6572 7420  e""".    assert 
-00045d30: 7473 2e73 7461 7465 2069 6e20 414c 4c5f  ts.state in ALL_
-00045d40: 5441 534b 5f53 5441 5445 532c 2074 730a  TASK_STATES, ts.
-00045d50: 0a20 2020 2069 6620 7473 2e77 6169 7469  .    if ts.waiti
-00045d60: 6e67 5f6f 6e3a 0a20 2020 2020 2020 2061  ng_on:.        a
-00045d70: 7373 6572 7420 7473 2e77 6169 7469 6e67  ssert ts.waiting
-00045d80: 5f6f 6e2e 6973 7375 6273 6574 2874 732e  _on.issubset(ts.
-00045d90: 6465 7065 6e64 656e 6369 6573 292c 2028  dependencies), (
-00045da0: 0a20 2020 2020 2020 2020 2020 2022 7761  .            "wa
-00045db0: 6974 696e 6720 6e6f 7420 7375 6273 6574  iting not subset
-00045dc0: 206f 6620 6465 7065 6e64 656e 6369 6573   of dependencies
-00045dd0: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-00045de0: 7472 2874 732e 7761 6974 696e 675f 6f6e  tr(ts.waiting_on
-00045df0: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-00045e00: 7472 2874 732e 6465 7065 6e64 656e 6369  tr(ts.dependenci
-00045e10: 6573 292c 0a20 2020 2020 2020 2029 0a20  es),.        ). 
-00045e20: 2020 2069 6620 7473 2e77 6169 7465 7273     if ts.waiters
-00045e30: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00045e40: 2074 732e 7761 6974 6572 732e 6973 7375   ts.waiters.issu
-00045e50: 6273 6574 2874 732e 6465 7065 6e64 656e  bset(ts.dependen
-00045e60: 7473 292c 2028 0a20 2020 2020 2020 2020  ts), (.         
-00045e70: 2020 2022 7761 6974 6572 7320 6e6f 7420     "waiters not 
-00045e80: 7375 6273 6574 206f 6620 6465 7065 6e64  subset of depend
-00045e90: 656e 7473 222c 0a20 2020 2020 2020 2020  ents",.         
-00045ea0: 2020 2073 7472 2874 732e 7761 6974 6572     str(ts.waiter
-00045eb0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00045ec0: 7374 7228 7473 2e64 6570 656e 6465 6e74  str(ts.dependent
-00045ed0: 7329 2c0a 2020 2020 2020 2020 290a 0a20  s),.        ).. 
-00045ee0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-00045ef0: 2e77 6169 7469 6e67 5f6f 6e3a 0a20 2020  .waiting_on:.   
-00045f00: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00045f10: 6474 732e 7768 6f5f 6861 732c 2028 2277  dts.who_has, ("w
-00045f20: 6169 7469 6e67 206f 6e20 696e 2d6d 656d  aiting on in-mem
-00045f30: 6f72 7920 6465 7022 2c20 7374 7228 7473  ory dep", str(ts
-00045f40: 292c 2073 7472 2864 7473 2929 0a20 2020  ), str(dts)).   
-00045f50: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
-00045f60: 7374 6174 6520 213d 2022 7265 6c65 6173  state != "releas
-00045f70: 6564 222c 2028 2277 6169 7469 6e67 206f  ed", ("waiting o
-00045f80: 6e20 7265 6c65 6173 6564 2064 6570 222c  n released dep",
-00045f90: 2073 7472 2874 7329 2c20 7374 7228 6474   str(ts), str(dt
-00045fa0: 7329 290a 2020 2020 666f 7220 6474 7320  s)).    for dts 
-00045fb0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-00045fc0: 6573 3a0a 2020 2020 2020 2020 6173 7365  es:.        asse
-00045fd0: 7274 2074 7320 696e 2064 7473 2e64 6570  rt ts in dts.dep
-00045fe0: 656e 6465 6e74 732c 2028 0a20 2020 2020  endents, (.     
-00045ff0: 2020 2020 2020 2022 6e6f 7420 696e 2064         "not in d
-00046000: 6570 656e 6465 6e63 7927 7320 6465 7065  ependency's depe
-00046010: 6e64 656e 7473 222c 0a20 2020 2020 2020  ndents",.       
-00046020: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
-00046030: 2020 2020 2020 2020 2020 7374 7228 6474            str(dt
-00046040: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00046050: 7374 7228 6474 732e 6465 7065 6e64 656e  str(dts.dependen
-00046060: 7473 292c 0a20 2020 2020 2020 2029 0a20  ts),.        ). 
-00046070: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-00046080: 7465 2069 6e20 2822 7761 6974 696e 6722  te in ("waiting"
-00046090: 2c20 2271 7565 7565 6422 2c20 2270 726f  , "queued", "pro
-000460a0: 6365 7373 696e 6722 2c20 226e 6f2d 776f  cessing", "no-wo
-000460b0: 726b 6572 2229 3a0a 2020 2020 2020 2020  rker"):.        
-000460c0: 2020 2020 6173 7365 7274 2064 7473 2069      assert dts i
-000460d0: 6e20 7473 2e77 6169 7469 6e67 5f6f 6e20  n ts.waiting_on 
-000460e0: 6f72 2064 7473 2e77 686f 5f68 6173 2c20  or dts.who_has, 
-000460f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00046100: 2020 2264 6570 206d 6973 7369 6e67 222c    "dep missing",
-00046110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046120: 2073 7472 2874 7329 2c0a 2020 2020 2020   str(ts),.      
-00046130: 2020 2020 2020 2020 2020 7374 7228 6474            str(dt
-00046140: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00046150: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00046160: 2064 7473 2e73 7461 7465 2021 3d20 2266   dts.state != "f
-00046170: 6f72 676f 7474 656e 220a 0a20 2020 2066  orgotten"..    f
-00046180: 6f72 2064 7473 2069 6e20 7473 2e77 6169  or dts in ts.wai
-00046190: 7465 7273 3a0a 2020 2020 2020 2020 6173  ters:.        as
-000461a0: 7365 7274 2064 7473 2e73 7461 7465 2069  sert dts.state i
-000461b0: 6e20 2822 7761 6974 696e 6722 2c20 2271  n ("waiting", "q
-000461c0: 7565 7565 6422 2c20 2270 726f 6365 7373  ueued", "process
-000461d0: 696e 6722 2c20 226e 6f2d 776f 726b 6572  ing", "no-worker
-000461e0: 2229 2c20 280a 2020 2020 2020 2020 2020  "), (.          
-000461f0: 2020 2277 6169 7465 7220 6e6f 7420 696e    "waiter not in
-00046200: 2070 6c61 7922 2c0a 2020 2020 2020 2020   play",.        
-00046210: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
-00046220: 2020 2020 2020 2020 2073 7472 2864 7473           str(dts
-00046230: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
-00046240: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-00046250: 6570 656e 6465 6e74 733a 0a20 2020 2020  ependents:.     
-00046260: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-00046270: 6474 732e 6465 7065 6e64 656e 6369 6573  dts.dependencies
-00046280: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00046290: 226e 6f74 2069 6e20 6465 7065 6e64 656e  "not in dependen
-000462a0: 7427 7320 6465 7065 6e64 656e 6369 6573  t's dependencies
-000462b0: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-000462c0: 7472 2874 7329 2c0a 2020 2020 2020 2020  tr(ts),.        
-000462d0: 2020 2020 7374 7228 6474 7329 2c0a 2020      str(dts),.  
-000462e0: 2020 2020 2020 2020 2020 7374 7228 6474            str(dt
-000462f0: 732e 6465 7065 6e64 656e 6369 6573 292c  s.dependencies),
-00046300: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00046310: 2020 2061 7373 6572 7420 6474 732e 7374     assert dts.st
-00046320: 6174 6520 213d 2022 666f 7267 6f74 7465  ate != "forgotte
-00046330: 6e22 0a0a 2020 2020 6173 7365 7274 2028  n"..    assert (
-00046340: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00046350: 2069 7320 6e6f 7420 4e6f 6e65 2920 3d3d   is not None) ==
-00046360: 2028 7473 2e73 7461 7465 203d 3d20 2270   (ts.state == "p
-00046370: 726f 6365 7373 696e 6722 290a 2020 2020  rocessing").    
-00046380: 6173 7365 7274 2062 6f6f 6c28 7473 2e77  assert bool(ts.w
-00046390: 686f 5f68 6173 2920 3d3d 2028 7473 2e73  ho_has) == (ts.s
-000463a0: 7461 7465 203d 3d20 226d 656d 6f72 7922  tate == "memory"
-000463b0: 292c 2028 7473 2c20 7473 2e77 686f 5f68  ), (ts, ts.who_h
-000463c0: 6173 2c20 7473 2e73 7461 7465 290a 0a20  as, ts.state).. 
-000463d0: 2020 2069 6620 7473 2e73 7461 7465 203d     if ts.state =
-000463e0: 3d20 2271 7565 7565 6422 3a0a 2020 2020  = "queued":.    
-000463f0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00046400: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
-00046410: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00046420: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
-00046430: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-00046440: 2864 7473 2e77 686f 5f68 6173 2066 6f72  (dts.who_has for
-00046450: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-00046460: 6465 6e63 6965 7329 2c20 280a 2020 2020  dencies), (.    
-00046470: 2020 2020 2020 2020 2274 6173 6b20 7175          "task qu
-00046480: 6575 6564 2077 6974 686f 7574 2061 6c6c  eued without all
-00046490: 2064 6570 7322 2c0a 2020 2020 2020 2020   deps",.        
-000464a0: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
-000464b0: 2020 2020 2020 2020 2073 7472 2874 732e           str(ts.
-000464c0: 6465 7065 6e64 656e 6369 6573 292c 0a20  dependencies),. 
-000464d0: 2020 2020 2020 2029 0a0a 2020 2020 6966         )..    if
-000464e0: 2074 732e 7374 6174 6520 3d3d 2022 7072   ts.state == "pr
-000464f0: 6f63 6573 7369 6e67 223a 0a20 2020 2020  ocessing":.     
-00046500: 2020 2061 7373 6572 7420 616c 6c28 6474     assert all(dt
-00046510: 732e 7768 6f5f 6861 7320 666f 7220 6474  s.who_has for dt
-00046520: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-00046530: 6369 6573 292c 2028 0a20 2020 2020 2020  cies), (.       
-00046540: 2020 2020 2022 7461 736b 2070 726f 6365       "task proce
-00046550: 7373 696e 6720 7769 7468 6f75 7420 616c  ssing without al
-00046560: 6c20 6465 7073 222c 0a20 2020 2020 2020  l deps",.       
-00046570: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
-00046580: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
-00046590: 2e64 6570 656e 6465 6e63 6965 7329 2c0a  .dependencies),.
-000465a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000465b0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-000465c0: 7761 6974 696e 675f 6f6e 0a0a 2020 2020  waiting_on..    
-000465d0: 6966 2074 732e 7768 6f5f 6861 733a 0a20  if ts.who_has:. 
-000465e0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000465f0: 2e77 6169 7465 7273 206f 7220 7473 2e77  .waiters or ts.w
-00046600: 686f 5f77 616e 7473 2c20 280a 2020 2020  ho_wants, (.    
-00046610: 2020 2020 2020 2020 2275 6e6e 6565 6465          "unneede
-00046620: 6420 7461 736b 2069 6e20 6d65 6d6f 7279  d task in memory
-00046630: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-00046640: 7472 2874 7329 2c0a 2020 2020 2020 2020  tr(ts),.        
-00046650: 2020 2020 7374 7228 7473 2e77 686f 5f68      str(ts.who_h
-00046660: 6173 292c 0a20 2020 2020 2020 2029 0a20  as),.        ). 
-00046670: 2020 2020 2020 2069 6620 7473 2e72 756e         if ts.run
-00046680: 5f73 7065 633a 2020 2320 7761 7320 636f  _spec:  # was co
-00046690: 6d70 7574 6564 0a20 2020 2020 2020 2020  mputed.         
-000466a0: 2020 2061 7373 6572 7420 7473 2e74 7970     assert ts.typ
-000466b0: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
-000466c0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-000466d0: 7473 2e74 7970 652c 2073 7472 290a 2020  ts.type, str).  
-000466e0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-000466f0: 2061 6e79 285b 7473 2069 6e20 6474 732e   any([ts in dts.
-00046700: 7761 6974 696e 675f 6f6e 2066 6f72 2064  waiting_on for d
-00046710: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-00046720: 6e74 735d 290a 2020 2020 2020 2020 666f  nts]).        fo
-00046730: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
-00046740: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-00046750: 6173 7365 7274 2074 7320 696e 2077 732e  assert ts in ws.
-00046760: 6861 735f 7768 6174 2c20 280a 2020 2020  has_what, (.    
-00046770: 2020 2020 2020 2020 2020 2020 226e 6f74              "not
-00046780: 2069 6e20 7768 6f5f 6861 7327 2068 6173   in who_has' has
-00046790: 5f77 6861 7422 2c0a 2020 2020 2020 2020  _what",.        
-000467a0: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
-000467b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000467c0: 2073 7472 2877 7329 2c0a 2020 2020 2020   str(ws),.      
-000467d0: 2020 2020 2020 2020 2020 7374 7228 7773            str(ws
-000467e0: 2e68 6173 5f77 6861 7429 2c0a 2020 2020  .has_what),.    
-000467f0: 2020 2020 2020 2020 290a 0a20 2020 2066          )..    f
-00046800: 6f72 2063 7320 696e 2074 732e 7768 6f5f  or cs in ts.who_
-00046810: 7761 6e74 733a 0a20 2020 2020 2020 2061  wants:.        a
-00046820: 7373 6572 7420 7473 2069 6e20 6373 2e77  ssert ts in cs.w
-00046830: 616e 7473 5f77 6861 742c 2028 0a20 2020  ants_what, (.   
-00046840: 2020 2020 2020 2020 2022 6e6f 7420 696e           "not in
-00046850: 2077 686f 5f77 616e 7473 2720 7761 6e74   who_wants' want
-00046860: 735f 7768 6174 222c 0a20 2020 2020 2020  s_what",.       
-00046870: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
-00046880: 2020 2020 2020 2020 2020 7374 7228 6373            str(cs
-00046890: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-000468a0: 7472 2863 732e 7761 6e74 735f 7768 6174  tr(cs.wants_what
-000468b0: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-000468c0: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
-000468d0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-000468e0: 7465 203d 3d20 226d 656d 6f72 7922 3a0a  te == "memory":.
-000468f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00046900: 7274 2073 756d 2874 7320 696e 2077 732e  rt sum(ts in ws.
-00046910: 6163 746f 7273 2066 6f72 2077 7320 696e  actors for ws in
-00046920: 2074 732e 7768 6f5f 6861 7329 203d 3d20   ts.who_has) == 
-00046930: 310a 2020 2020 2020 2020 6966 2074 732e  1.        if ts.
-00046940: 7374 6174 6520 3d3d 2022 7072 6f63 6573  state == "proces
-00046950: 7369 6e67 223a 0a20 2020 2020 2020 2020  sing":.         
-00046960: 2020 2061 7373 6572 7420 7473 2e70 726f     assert ts.pro
-00046970: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-00046980: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00046990: 2069 6e20 7473 2e70 726f 6365 7373 696e   in ts.processin
-000469a0: 675f 6f6e 2e61 6374 6f72 730a 2020 2020  g_on.actors.    
-000469b0: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
-000469c0: 6174 6520 213d 2022 7175 6575 6564 220a  ate != "queued".
-000469d0: 0a0a 6465 6620 7661 6c69 6461 7465 5f77  ..def validate_w
-000469e0: 6f72 6b65 725f 7374 6174 6528 7773 3a20  orker_state(ws: 
-000469f0: 576f 726b 6572 5374 6174 6529 202d 3e20  WorkerState) -> 
-00046a00: 4e6f 6e65 3a0a 2020 2020 666f 7220 7473  None:.    for ts
-00046a10: 2069 6e20 7773 2e68 6173 5f77 6861 743a   in ws.has_what:
-00046a20: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00046a30: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-00046a40: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00046a50: 226e 6f74 2069 6e20 6861 735f 7768 6174  "not in has_what
-00046a60: 2720 7768 6f5f 6861 7322 2c0a 2020 2020  ' who_has",.    
-00046a70: 2020 2020 2020 2020 7374 7228 7773 292c          str(ws),
-00046a80: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00046a90: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
-00046aa0: 2020 7374 7228 7473 2e77 686f 5f68 6173    str(ts.who_has
-00046ab0: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-00046ac0: 2020 666f 7220 7473 2069 6e20 7773 2e61    for ts in ws.a
-00046ad0: 6374 6f72 733a 0a20 2020 2020 2020 2061  ctors:.        a
-00046ae0: 7373 6572 7420 7473 2e73 7461 7465 2069  ssert ts.state i
-00046af0: 6e20 2822 6d65 6d6f 7279 222c 2022 7072  n ("memory", "pr
-00046b00: 6f63 6573 7369 6e67 2229 0a0a 0a64 6566  ocessing")...def
-00046b10: 2076 616c 6964 6174 655f 7374 6174 6528   validate_state(
-00046b20: 0a20 2020 2074 6173 6b73 3a20 6469 6374  .    tasks: dict
-00046b30: 5b73 7472 2c20 5461 736b 5374 6174 655d  [str, TaskState]
-00046b40: 2c0a 2020 2020 776f 726b 6572 733a 2064  ,.    workers: d
-00046b50: 6963 745b 7374 722c 2057 6f72 6b65 7253  ict[str, WorkerS
-00046b60: 7461 7465 5d2c 0a20 2020 2063 6c69 656e  tate],.    clien
-00046b70: 7473 3a20 6469 6374 5b73 7472 2c20 436c  ts: dict[str, Cl
-00046b80: 6965 6e74 5374 6174 655d 2c0a 2920 2d3e  ientState],.) ->
-00046b90: 204e 6f6e 653a 0a20 2020 2022 2222 5661   None:.    """Va
-00046ba0: 6c69 6461 7465 2061 2063 7572 7265 6e74  lidate a current
-00046bb0: 2072 756e 7469 6d65 2073 7461 7465 2e0a   runtime state..
-00046bc0: 0a20 2020 2054 6869 7320 7065 7266 6f72  .    This perfor
-00046bd0: 6d73 2061 2073 6571 7565 6e63 6520 6f66  ms a sequence of
-00046be0: 2063 6865 636b 7320 6f6e 2074 6865 2065   checks on the e
-00046bf0: 6e74 6972 6520 6772 6170 682c 2072 756e  ntire graph, run
-00046c00: 6e69 6e67 2069 6e20 6162 6f75 7420 6c69  ning in about li
-00046c10: 6e65 6172 0a20 2020 2074 696d 652e 2054  near.    time. T
-00046c20: 6869 7320 7261 6973 6573 2061 7373 6572  his raises asser
-00046c30: 7420 6572 726f 7273 2069 6620 616e 7974  t errors if anyt
-00046c40: 6869 6e67 2064 6f65 736e 2774 2063 6865  hing doesn't che
-00046c50: 636b 206f 7574 2e0a 2020 2020 2222 220a  ck out..    """.
-00046c60: 2020 2020 666f 7220 7473 2069 6e20 7461      for ts in ta
-00046c70: 736b 732e 7661 6c75 6573 2829 3a0a 2020  sks.values():.  
-00046c80: 2020 2020 2020 7661 6c69 6461 7465 5f74        validate_t
-00046c90: 6173 6b5f 7374 6174 6528 7473 290a 0a20  ask_state(ts).. 
-00046ca0: 2020 2066 6f72 2077 7320 696e 2077 6f72     for ws in wor
-00046cb0: 6b65 7273 2e76 616c 7565 7328 293a 0a20  kers.values():. 
-00046cc0: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
-00046cd0: 776f 726b 6572 5f73 7461 7465 2877 7329  worker_state(ws)
-00046ce0: 0a0a 2020 2020 666f 7220 6373 2069 6e20  ..    for cs in 
-00046cf0: 636c 6965 6e74 732e 7661 6c75 6573 2829  clients.values()
-00046d00: 3a0a 2020 2020 2020 2020 666f 7220 7473  :.        for ts
-00046d10: 2069 6e20 6373 2e77 616e 7473 5f77 6861   in cs.wants_wha
-00046d20: 743a 0a20 2020 2020 2020 2020 2020 2061  t:.            a
-00046d30: 7373 6572 7420 6373 2069 6e20 7473 2e77  ssert cs in ts.w
-00046d40: 686f 5f77 616e 7473 2c20 280a 2020 2020  ho_wants, (.    
-00046d50: 2020 2020 2020 2020 2020 2020 226e 6f74              "not
-00046d60: 2069 6e20 7761 6e74 735f 7768 6174 2720   in wants_what' 
-00046d70: 7768 6f5f 7761 6e74 7322 2c0a 2020 2020  who_wants",.    
-00046d80: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00046d90: 6373 292c 0a20 2020 2020 2020 2020 2020  cs),.           
-00046da0: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
-00046db0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00046dc0: 7228 7473 2e77 686f 5f77 616e 7473 292c  r(ts.who_wants),
-00046dd0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00046de0: 0a64 6566 2068 6561 7274 6265 6174 5f69  .def heartbeat_i
-00046df0: 6e74 6572 7661 6c28 6e3a 2069 6e74 2920  nterval(n: int) 
-00046e00: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2222  -> float:.    ""
-00046e10: 2249 6e74 6572 7661 6c20 696e 2073 6563  "Interval in sec
-00046e20: 6f6e 6473 2074 6861 7420 7765 2064 6573  onds that we des
-00046e30: 6972 6520 6865 6172 7462 6561 7473 2062  ire heartbeats b
-00046e40: 6173 6564 206f 6e20 6e75 6d62 6572 206f  ased on number o
-00046e50: 6620 776f 726b 6572 7322 2222 0a20 2020  f workers""".   
-00046e60: 2069 6620 6e20 3c3d 2031 303a 0a20 2020   if n <= 10:.   
-00046e70: 2020 2020 2072 6574 7572 6e20 302e 350a       return 0.5.
-00046e80: 2020 2020 656c 6966 206e 203c 2035 303a      elif n < 50:
-00046e90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00046ea0: 310a 2020 2020 656c 6966 206e 203c 2032  1.    elif n < 2
-00046eb0: 3030 3a0a 2020 2020 2020 2020 7265 7475  00:.        retu
-00046ec0: 726e 2032 0a20 2020 2065 6c73 653a 0a20  rn 2.    else:. 
-00046ed0: 2020 2020 2020 2023 204e 6f20 6d6f 7265         # No more
-00046ee0: 2074 6861 6e20 3230 3020 6865 6172 7462   than 200 heartb
-00046ef0: 6561 7473 2061 2073 6563 6f6e 6420 7363  eats a second sc
-00046f00: 616c 6564 2062 7920 776f 726b 6572 730a  aled by workers.
-00046f10: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-00046f20: 202f 2032 3030 202b 2031 0a0a 0a64 6566   / 200 + 1...def
-00046f30: 205f 7461 736b 5f73 6c6f 7473 5f61 7661   _task_slots_ava
-00046f40: 696c 6162 6c65 2877 733a 2057 6f72 6b65  ilable(ws: Worke
-00046f50: 7253 7461 7465 2c20 7361 7475 7261 7469  rState, saturati
-00046f60: 6f6e 5f66 6163 746f 723a 2066 6c6f 6174  on_factor: float
-00046f70: 2920 2d3e 2069 6e74 3a0a 2020 2020 2222  ) -> int:.    ""
-00046f80: 224e 756d 6265 7220 6f66 2074 6173 6b73  "Number of tasks
-00046f90: 2074 6861 7420 6361 6e20 6265 2073 656e   that can be sen
-00046fa0: 7420 746f 2074 6869 7320 776f 726b 6572  t to this worker
-00046fb0: 2077 6974 686f 7574 206f 7665 7273 6174   without oversat
-00046fc0: 7572 6174 696e 6720 6974 2222 220a 2020  urating it""".  
-00046fd0: 2020 6173 7365 7274 206e 6f74 206d 6174    assert not mat
-00046fe0: 682e 6973 696e 6628 7361 7475 7261 7469  h.isinf(saturati
-00046ff0: 6f6e 5f66 6163 746f 7229 0a20 2020 2072  on_factor).    r
-00047000: 6574 7572 6e20 6d61 7828 6d61 7468 2e63  eturn max(math.c
-00047010: 6569 6c28 7361 7475 7261 7469 6f6e 5f66  eil(saturation_f
-00047020: 6163 746f 7220 2a20 7773 2e6e 7468 7265  actor * ws.nthre
-00047030: 6164 7329 2c20 3129 202d 2028 0a20 2020  ads), 1) - (.   
-00047040: 2020 2020 206c 656e 2877 732e 7072 6f63       len(ws.proc
-00047050: 6573 7369 6e67 2920 2d20 6c65 6e28 7773  essing) - len(ws
-00047060: 2e6c 6f6e 675f 7275 6e6e 696e 6729 0a20  .long_running). 
-00047070: 2020 2029 0a0a 0a64 6566 205f 776f 726b     )...def _work
-00047080: 6572 5f66 756c 6c28 7773 3a20 576f 726b  er_full(ws: Work
-00047090: 6572 5374 6174 652c 2073 6174 7572 6174  erState, saturat
-000470a0: 696f 6e5f 6661 6374 6f72 3a20 666c 6f61  ion_factor: floa
-000470b0: 7429 202d 3e20 626f 6f6c 3a0a 2020 2020  t) -> bool:.    
-000470c0: 6966 206d 6174 682e 6973 696e 6628 7361  if math.isinf(sa
-000470d0: 7475 7261 7469 6f6e 5f66 6163 746f 7229  turation_factor)
-000470e0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000470f0: 2046 616c 7365 0a20 2020 2072 6574 7572   False.    retur
-00047100: 6e20 5f74 6173 6b5f 736c 6f74 735f 6176  n _task_slots_av
-00047110: 6169 6c61 626c 6528 7773 2c20 7361 7475  ailable(ws, satu
-00047120: 7261 7469 6f6e 5f66 6163 746f 7229 203c  ration_factor) <
-00047130: 3d20 300a 0a0a 636c 6173 7320 4b69 6c6c  = 0...class Kill
-00047140: 6564 576f 726b 6572 2845 7863 6570 7469  edWorker(Excepti
-00047150: 6f6e 293a 0a20 2020 2064 6566 205f 5f69  on):.    def __i
-00047160: 6e69 745f 5f28 7365 6c66 2c20 7461 736b  nit__(self, task
-00047170: 3a20 7374 722c 206c 6173 745f 776f 726b  : str, last_work
-00047180: 6572 3a20 576f 726b 6572 5374 6174 652c  er: WorkerState,
-00047190: 2061 6c6c 6f77 6564 5f66 6169 6c75 7265   allowed_failure
-000471a0: 733a 2069 6e74 293a 0a20 2020 2020 2020  s: int):.       
-000471b0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
-000471c0: 5f28 7461 736b 2c20 6c61 7374 5f77 6f72  _(task, last_wor
-000471d0: 6b65 722c 2061 6c6c 6f77 6564 5f66 6169  ker, allowed_fai
-000471e0: 6c75 7265 7329 0a0a 2020 2020 4070 726f  lures)..    @pro
-000471f0: 7065 7274 790a 2020 2020 6465 6620 7461  perty.    def ta
-00047200: 736b 2873 656c 6629 202d 3e20 7374 723a  sk(self) -> str:
-00047210: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00047220: 7365 6c66 2e61 7267 735b 305d 0a0a 2020  self.args[0]..  
-00047230: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00047240: 6465 6620 6c61 7374 5f77 6f72 6b65 7228  def last_worker(
-00047250: 7365 6c66 2920 2d3e 2057 6f72 6b65 7253  self) -> WorkerS
-00047260: 7461 7465 3a0a 2020 2020 2020 2020 7265  tate:.        re
-00047270: 7475 726e 2073 656c 662e 6172 6773 5b31  turn self.args[1
-00047280: 5d0a 0a20 2020 2040 7072 6f70 6572 7479  ]..    @property
-00047290: 0a20 2020 2064 6566 2061 6c6c 6f77 6564  .    def allowed
-000472a0: 5f66 6169 6c75 7265 7328 7365 6c66 2920  _failures(self) 
-000472b0: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
-000472c0: 7265 7475 726e 2073 656c 662e 6172 6773  return self.args
-000472d0: 5b32 5d0a 0a20 2020 2064 6566 205f 5f73  [2]..    def __s
-000472e0: 7472 5f5f 2873 656c 6629 202d 3e20 7374  tr__(self) -> st
-000472f0: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
-00047300: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
-00047310: 6622 4174 7465 6d70 7465 6420 746f 2072  f"Attempted to r
-00047320: 756e 2074 6173 6b20 7b73 656c 662e 7461  un task {self.ta
-00047330: 736b 7d20 6f6e 207b 7365 6c66 2e61 6c6c  sk} on {self.all
-00047340: 6f77 6564 5f66 6169 6c75 7265 737d 2064  owed_failures} d
-00047350: 6966 6665 7265 6e74 2022 0a20 2020 2020  ifferent ".     
-00047360: 2020 2020 2020 2022 776f 726b 6572 732c         "workers,
-00047370: 2062 7574 2061 6c6c 2074 686f 7365 2077   but all those w
-00047380: 6f72 6b65 7273 2064 6965 6420 7768 696c  orkers died whil
-00047390: 6520 7275 6e6e 696e 6720 6974 2e20 220a  e running it. ".
-000473a0: 2020 2020 2020 2020 2020 2020 6622 5468              f"Th
-000473b0: 6520 6c61 7374 2077 6f72 6b65 7220 7468  e last worker th
-000473c0: 6174 2061 7474 656d 7074 2074 6f20 7275  at attempt to ru
-000473d0: 6e20 7468 6520 7461 736b 2077 6173 207b  n the task was {
-000473e0: 7365 6c66 2e6c 6173 745f 776f 726b 6572  self.last_worker
-000473f0: 2e61 6464 7265 7373 7d2e 2022 0a20 2020  .address}. ".   
-00047400: 2020 2020 2020 2020 2022 496e 7370 6563           "Inspec
-00047410: 7469 6e67 2077 6f72 6b65 7220 6c6f 6773  ting worker logs
-00047420: 2069 7320 6f66 7465 6e20 6120 676f 6f64   is often a good
-00047430: 206e 6578 7420 7374 6570 2074 6f20 6469   next step to di
-00047440: 6167 6e6f 7365 2077 6861 7420 7765 6e74  agnose what went
-00047450: 2077 726f 6e67 2e20 220a 2020 2020 2020   wrong. ".      
-00047460: 2020 2020 2020 2246 6f72 206d 6f72 6520        "For more 
-00047470: 696e 666f 726d 6174 696f 6e20 7365 6520  information see 
-00047480: 6874 7470 733a 2f2f 6469 7374 7269 6275  https://distribu
-00047490: 7465 642e 6461 736b 2e6f 7267 2f65 6e2f  ted.dask.org/en/
-000474a0: 7374 6162 6c65 2f6b 696c 6c65 642e 6874  stable/killed.ht
-000474b0: 6d6c 2e22 0a20 2020 2020 2020 2029 0a0a  ml.".        )..
-000474c0: 0a63 6c61 7373 2057 6f72 6b65 7253 7461  .class WorkerSta
-000474d0: 7475 7350 6c75 6769 6e28 5363 6865 6475  tusPlugin(Schedu
-000474e0: 6c65 7250 6c75 6769 6e29 3a0a 2020 2020  lerPlugin):.    
-000474f0: 2222 2241 2070 6c75 6769 6e20 746f 2073  """A plugin to s
-00047500: 6861 7265 2077 6f72 6b65 7220 7374 6174  hare worker stat
-00047510: 7573 2077 6974 6820 6120 7265 6d6f 7465  us with a remote
-00047520: 206f 6273 6572 7665 720a 0a20 2020 2054   observer..    T
-00047530: 6869 7320 6973 2075 7365 6420 696e 2063  his is used in c
-00047540: 6c75 7374 6572 206d 616e 6167 6572 7320  luster managers 
-00047550: 746f 206b 6565 7020 7570 6461 7465 6420  to keep updated 
-00047560: 6162 6f75 7420 7468 6520 7374 6174 7573  about the status
-00047570: 206f 6620 7468 6520 7363 6865 6475 6c65   of the schedule
-00047580: 722e 0a20 2020 2022 2222 0a0a 2020 2020  r..    """..    
-00047590: 6e61 6d65 3a20 436c 6173 7356 6172 5b73  name: ClassVar[s
-000475a0: 7472 5d20 3d20 2277 6f72 6b65 722d 7374  tr] = "worker-st
-000475b0: 6174 7573 220a 2020 2020 6263 6f6d 6d3a  atus".    bcomm:
-000475c0: 2042 6174 6368 6564 5365 6e64 0a0a 2020   BatchedSend..  
-000475d0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-000475e0: 656c 662c 2073 6368 6564 756c 6572 3a20  elf, scheduler: 
-000475f0: 5363 6865 6475 6c65 722c 2063 6f6d 6d3a  Scheduler, comm:
-00047600: 2043 6f6d 6d29 3a0a 2020 2020 2020 2020   Comm):.        
-00047610: 7365 6c66 2e62 636f 6d6d 203d 2042 6174  self.bcomm = Bat
-00047620: 6368 6564 5365 6e64 2869 6e74 6572 7661  chedSend(interva
-00047630: 6c3d 2235 6d73 2229 0a20 2020 2020 2020  l="5ms").       
-00047640: 2073 656c 662e 6263 6f6d 6d2e 7374 6172   self.bcomm.star
-00047650: 7428 636f 6d6d 290a 2020 2020 2020 2020  t(comm).        
-00047660: 7363 6865 6475 6c65 722e 6164 645f 706c  scheduler.add_pl
-00047670: 7567 696e 2873 656c 6629 0a0a 2020 2020  ugin(self)..    
-00047680: 6465 6620 6164 645f 776f 726b 6572 2873  def add_worker(s
-00047690: 656c 662c 2073 6368 6564 756c 6572 3a20  elf, scheduler: 
-000476a0: 5363 6865 6475 6c65 722c 2077 6f72 6b65  Scheduler, worke
-000476b0: 723a 2073 7472 2920 2d3e 204e 6f6e 653a  r: str) -> None:
-000476c0: 0a20 2020 2020 2020 2069 6465 6e74 203d  .        ident =
-000476d0: 2073 6368 6564 756c 6572 2e77 6f72 6b65   scheduler.worke
-000476e0: 7273 5b77 6f72 6b65 725d 2e69 6465 6e74  rs[worker].ident
-000476f0: 6974 7928 290a 2020 2020 2020 2020 6465  ity().        de
-00047700: 6c20 6964 656e 745b 226d 6574 7269 6373  l ident["metrics
-00047710: 225d 0a20 2020 2020 2020 2064 656c 2069  "].        del i
-00047720: 6465 6e74 5b22 6c61 7374 5f73 6565 6e22  dent["last_seen"
-00047730: 5d0a 2020 2020 2020 2020 7472 793a 0a20  ].        try:. 
-00047740: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00047750: 6263 6f6d 6d2e 7365 6e64 285b 2261 6464  bcomm.send(["add
-00047760: 222c 207b 2277 6f72 6b65 7273 223a 207b  ", {"workers": {
-00047770: 776f 726b 6572 3a20 6964 656e 747d 7d5d  worker: ident}}]
-00047780: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00047790: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
-000477a0: 3a0a 2020 2020 2020 2020 2020 2020 7363  :.            sc
-000477b0: 6865 6475 6c65 722e 7265 6d6f 7665 5f70  heduler.remove_p
-000477c0: 6c75 6769 6e28 6e61 6d65 3d73 656c 662e  lugin(name=self.
-000477d0: 6e61 6d65 290a 0a20 2020 2064 6566 2072  name)..    def r
-000477e0: 656d 6f76 655f 776f 726b 6572 2873 656c  emove_worker(sel
-000477f0: 662c 2073 6368 6564 756c 6572 3a20 5363  f, scheduler: Sc
-00047800: 6865 6475 6c65 722c 2077 6f72 6b65 723a  heduler, worker:
-00047810: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00047820: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00047830: 2020 2020 2020 2020 7365 6c66 2e62 636f          self.bco
-00047840: 6d6d 2e73 656e 6428 5b22 7265 6d6f 7665  mm.send(["remove
-00047850: 222c 2077 6f72 6b65 725d 290a 2020 2020  ", worker]).    
-00047860: 2020 2020 6578 6365 7074 2043 6f6d 6d43      except CommC
-00047870: 6c6f 7365 6445 7272 6f72 3a0a 2020 2020  losedError:.    
-00047880: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-00047890: 722e 7265 6d6f 7665 5f70 6c75 6769 6e28  r.remove_plugin(
-000478a0: 6e61 6d65 3d73 656c 662e 6e61 6d65 290a  name=self.name).
-000478b0: 0a20 2020 2064 6566 2074 6561 7264 6f77  .    def teardow
-000478c0: 6e28 7365 6c66 2920 2d3e 204e 6f6e 653a  n(self) -> None:
-000478d0: 0a20 2020 2020 2020 2073 656c 662e 6263  .        self.bc
-000478e0: 6f6d 6d2e 636c 6f73 6528 290a 0a0a 636c  omm.close()...cl
-000478f0: 6173 7320 436f 6c6c 6563 7454 6173 6b4d  ass CollectTaskM
-00047900: 6574 6144 6174 6150 6c75 6769 6e28 5363  etaDataPlugin(Sc
-00047910: 6865 6475 6c65 7250 6c75 6769 6e29 3a0a  hedulerPlugin):.
-00047920: 2020 2020 7363 6865 6475 6c65 723a 2053      scheduler: S
-00047930: 6368 6564 756c 6572 0a20 2020 206e 616d  cheduler.    nam
-00047940: 653a 2073 7472 0a20 2020 206b 6579 733a  e: str.    keys:
-00047950: 2073 6574 5b73 7472 5d0a 2020 2020 6d65   set[str].    me
-00047960: 7461 6461 7461 3a20 6469 6374 5b73 7472  tadata: dict[str
-00047970: 2c20 416e 795d 0a20 2020 2073 7461 7465  , Any].    state
-00047980: 3a20 6469 6374 5b73 7472 2c20 7374 725d  : dict[str, str]
-00047990: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-000479a0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-000479b0: 6572 3a20 5363 6865 6475 6c65 722c 206e  er: Scheduler, n
-000479c0: 616d 653a 2073 7472 293a 0a20 2020 2020  ame: str):.     
-000479d0: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
-000479e0: 7220 3d20 7363 6865 6475 6c65 720a 2020  r = scheduler.  
-000479f0: 2020 2020 2020 7365 6c66 2e6e 616d 6520        self.name 
-00047a00: 3d20 6e61 6d65 0a20 2020 2020 2020 2073  = name.        s
-00047a10: 656c 662e 6b65 7973 203d 2073 6574 2829  elf.keys = set()
-00047a20: 0a20 2020 2020 2020 2073 656c 662e 6d65  .        self.me
-00047a30: 7461 6461 7461 203d 207b 7d0a 2020 2020  tadata = {}.    
-00047a40: 2020 2020 7365 6c66 2e73 7461 7465 203d      self.state =
-00047a50: 207b 7d0a 0a20 2020 2064 6566 2075 7064   {}..    def upd
-00047a60: 6174 655f 6772 6170 6828 0a20 2020 2020  ate_graph(.     
-00047a70: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00047a80: 2073 6368 6564 756c 6572 3a20 5363 6865   scheduler: Sche
-00047a90: 6475 6c65 722c 0a20 2020 2020 2020 206b  duler,.        k
-00047aa0: 6579 733a 2073 6574 5b73 7472 5d2c 0a20  eys: set[str],. 
-00047ab0: 2020 2020 2020 2072 6573 7472 6963 7469         restricti
-00047ac0: 6f6e 733a 2064 6963 745b 7374 722c 2066  ons: dict[str, f
-00047ad0: 6c6f 6174 5d2c 0a20 2020 2020 2020 202a  loat],.        *
-00047ae0: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
-00047af0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-00047b00: 2020 2020 2073 656c 662e 6b65 7973 2e75       self.keys.u
-00047b10: 7064 6174 6528 6b65 7973 290a 0a20 2020  pdate(keys)..   
-00047b20: 2064 6566 2074 7261 6e73 6974 696f 6e28   def transition(
-00047b30: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00047b40: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
-00047b50: 0a20 2020 2020 2020 2073 7461 7274 3a20  .        start: 
-00047b60: 5461 736b 5374 6174 6553 7461 7465 2c0a  TaskStateState,.
-00047b70: 2020 2020 2020 2020 6669 6e69 7368 3a20          finish: 
-00047b80: 5461 736b 5374 6174 6553 7461 7465 2c0a  TaskStateState,.
-00047b90: 2020 2020 2020 2020 2a61 7267 733a 2041          *args: A
-00047ba0: 6e79 2c0a 2020 2020 2020 2020 2a2a 6b77  ny,.        **kw
-00047bb0: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
-00047bc0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00047bd0: 2020 6966 2066 696e 6973 6820 696e 2028    if finish in (
-00047be0: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
-00047bf0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00047c00: 7473 203d 2073 656c 662e 7363 6865 6475  ts = self.schedu
-00047c10: 6c65 722e 7461 736b 732e 6765 7428 6b65  ler.tasks.get(ke
-00047c20: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-00047c30: 6620 7473 2069 7320 6e6f 7420 4e6f 6e65  f ts is not None
-00047c40: 2061 6e64 2074 732e 6b65 7920 696e 2073   and ts.key in s
-00047c50: 656c 662e 6b65 7973 3a0a 2020 2020 2020  elf.keys:.      
-00047c60: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-00047c70: 6574 6164 6174 615b 6b65 795d 203d 2074  etadata[key] = t
-00047c80: 732e 6d65 7461 6461 7461 0a20 2020 2020  s.metadata.     
-00047c90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00047ca0: 7374 6174 655b 6b65 795d 203d 2066 696e  state[key] = fin
-00047cb0: 6973 680a 2020 2020 2020 2020 2020 2020  ish.            
-00047cc0: 2020 2020 7365 6c66 2e6b 6579 732e 6469      self.keys.di
-00047cd0: 7363 6172 6428 6b65 7929 0a              scard(key).
+0003a7d0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0003a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a7f0: 2020 2020 6e5f 6d69 7373 696e 6720 3d20      n_missing = 
+0003a800: 6e20 2d20 6c65 6e28 7473 2e77 686f 5f68  n - len(ts.who_h
+0003a810: 6173 2026 2077 6f72 6b65 7273 290a 2020  as & workers).  
+0003a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a830: 2020 6966 206e 5f6d 6973 7369 6e67 203c    if n_missing <
+0003a840: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+0003a850: 2020 2020 2020 2020 2020 2020 2023 2041               # A
+0003a860: 6c72 6561 6479 2072 6570 6c69 6361 7465  lready replicate
+0003a870: 6420 656e 6f75 6768 0a20 2020 2020 2020  d enough.       
+0003a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a890: 2074 6173 6b73 2e72 656d 6f76 6528 7473   tasks.remove(ts
+0003a8a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003a8b0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0003a8c0: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+0003a8d0: 2020 2020 2020 2020 636f 756e 7420 3d20          count = 
+0003a8e0: 6d69 6e28 6e5f 6d69 7373 696e 672c 2062  min(n_missing, b
+0003a8f0: 7261 6e63 6869 6e67 5f66 6163 746f 7220  ranching_factor 
+0003a900: 2a20 6c65 6e28 7473 2e77 686f 5f68 6173  * len(ts.who_has
+0003a910: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0003a920: 2020 2020 2020 2061 7373 6572 7420 636f         assert co
+0003a930: 756e 7420 3e20 300a 0a20 2020 2020 2020  unt > 0..       
+0003a940: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0003a950: 2077 7320 696e 2072 616e 646f 6d2e 7361   ws in random.sa
+0003a960: 6d70 6c65 2874 7570 6c65 2877 6f72 6b65  mple(tuple(worke
+0003a970: 7273 202d 2074 732e 7768 6f5f 6861 7329  rs - ts.who_has)
+0003a980: 2c20 636f 756e 7429 3a0a 2020 2020 2020  , count):.      
+0003a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a9a0: 2020 6761 7468 6572 735b 7773 2e61 6464    gathers[ws.add
+0003a9b0: 7265 7373 5d5b 7473 2e6b 6579 5d20 3d20  ress][ts.key] = 
+0003a9c0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0003a9d0: 2020 2020 2020 2020 2020 2020 2020 7777                ww
+0003a9e0: 732e 6164 6472 6573 7320 666f 7220 7777  s.address for ww
+0003a9f0: 7320 696e 2074 732e 7768 6f5f 6861 730a  s in ts.who_has.
+0003aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aa10: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
+0003aa20: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0003aa30: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+0003aa40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003aa50: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
+0003aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aa70: 2320 4e6f 7465 3a20 7468 6973 206e 6576  # Note: this nev
+0003aa80: 6572 2072 6169 7365 7320 6578 6365 7074  er raises except
+0003aa90: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
+0003aaa0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0003aab0: 662e 6761 7468 6572 5f6f 6e5f 776f 726b  f.gather_on_work
+0003aac0: 6572 2877 2c20 7768 6f5f 6861 7329 0a20  er(w, who_has). 
+0003aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aae0: 2020 2020 2020 2066 6f72 2077 2c20 7768         for w, wh
+0003aaf0: 6f5f 6861 7320 696e 2067 6174 6865 7273  o_has in gathers
+0003ab00: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
+0003ab10: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0003ab20: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0003ab30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ab40: 2066 6f72 2072 2c20 7620 696e 2067 6174   for r, v in gat
+0003ab50: 6865 7273 2e69 7465 6d73 2829 3a0a 2020  hers.items():.  
+0003ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ab70: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+0003ab80: 2872 2c20 7b22 6163 7469 6f6e 223a 2022  (r, {"action": "
+0003ab90: 7265 706c 6963 6174 652d 6164 6422 2c20  replicate-add", 
+0003aba0: 2277 686f 5f68 6173 223a 2076 7d29 0a0a  "who_has": v})..
+0003abb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003abc0: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
+0003abd0: 2020 2020 2020 2020 2020 2020 2261 6c6c              "all
+0003abe0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0003abf0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0003ac00: 2020 2020 2020 2020 2022 6163 7469 6f6e           "action
+0003ac10: 223a 2022 7265 706c 6963 6174 6522 2c0a  ": "replicate",.
+0003ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ac30: 2020 2020 2277 6f72 6b65 7273 223a 206c      "workers": l
+0003ac40: 6973 7428 776f 726b 6572 7329 2c0a 2020  ist(workers),.  
+0003ac50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ac60: 2020 226b 6579 2d63 6f75 6e74 223a 206c    "key-count": l
+0003ac70: 656e 286b 6579 7329 2c0a 2020 2020 2020  en(keys),.      
+0003ac80: 2020 2020 2020 2020 2020 2020 2020 2262                "b
+0003ac90: 7261 6e63 6869 6e67 2d66 6163 746f 7222  ranching-factor"
+0003aca0: 3a20 6272 616e 6368 696e 675f 6661 6374  : branching_fact
+0003acb0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+0003acc0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+0003acd0: 2020 2029 0a0a 2020 2020 6465 6620 776f     )..    def wo
+0003ace0: 726b 6572 735f 746f 5f63 6c6f 7365 280a  rkers_to_close(.
+0003acf0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0003ad00: 2020 2020 2020 6d65 6d6f 7279 5f72 6174        memory_rat
+0003ad10: 696f 3a20 696e 7420 7c20 666c 6f61 7420  io: int | float 
+0003ad20: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003ad30: 2020 2020 2020 206e 3a20 696e 7420 7c20         n: int | 
+0003ad40: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+0003ad50: 2020 2020 206b 6579 3a20 4361 6c6c 6162       key: Callab
+0003ad60: 6c65 5b5b 576f 726b 6572 5374 6174 655d  le[[WorkerState]
+0003ad70: 2c20 4861 7368 6162 6c65 5d20 7c20 6279  , Hashable] | by
+0003ad80: 7465 7320 7c20 4e6f 6e65 203d 204e 6f6e  tes | None = Non
+0003ad90: 652c 0a20 2020 2020 2020 206d 696e 696d  e,.        minim
+0003ada0: 756d 3a20 696e 7420 7c20 4e6f 6e65 203d  um: int | None =
+0003adb0: 204e 6f6e 652c 0a20 2020 2020 2020 2074   None,.        t
+0003adc0: 6172 6765 743a 2069 6e74 207c 204e 6f6e  arget: int | Non
+0003add0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+0003ade0: 2020 6174 7472 6962 7574 653a 2073 7472    attribute: str
+0003adf0: 203d 2022 6164 6472 6573 7322 2c0a 2020   = "address",.  
+0003ae00: 2020 2920 2d3e 206c 6973 745b 7374 725d    ) -> list[str]
+0003ae10: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0003ae20: 2020 2020 2020 4669 6e64 2077 6f72 6b65        Find worke
+0003ae30: 7273 2074 6861 7420 7765 2063 616e 2063  rs that we can c
+0003ae40: 6c6f 7365 2077 6974 6820 6c6f 7720 636f  lose with low co
+0003ae50: 7374 0a0a 2020 2020 2020 2020 5468 6973  st..        This
+0003ae60: 2072 6574 7572 6e73 2061 206c 6973 7420   returns a list 
+0003ae70: 6f66 2077 6f72 6b65 7273 2074 6861 7420  of workers that 
+0003ae80: 6172 6520 676f 6f64 2063 616e 6469 6461  are good candida
+0003ae90: 7465 7320 746f 2072 6574 6972 652e 0a20  tes to retire.. 
+0003aea0: 2020 2020 2020 2054 6865 7365 2077 6f72         These wor
+0003aeb0: 6b65 7273 2061 7265 206e 6f74 2072 756e  kers are not run
+0003aec0: 6e69 6e67 2061 6e79 7468 696e 6720 616e  ning anything an
+0003aed0: 6420 6172 6520 7374 6f72 696e 670a 2020  d are storing.  
+0003aee0: 2020 2020 2020 7265 6c61 7469 7665 6c79        relatively
+0003aef0: 206c 6974 746c 6520 6461 7461 2072 656c   little data rel
+0003af00: 6174 6976 6520 746f 2074 6865 6972 2070  ative to their p
+0003af10: 6565 7273 2e20 2049 6620 616c 6c20 776f  eers.  If all wo
+0003af20: 726b 6572 7320 6172 650a 2020 2020 2020  rkers are.      
+0003af30: 2020 6964 6c65 2074 6865 6e20 7765 2073    idle then we s
+0003af40: 7469 6c6c 206d 6169 6e74 6169 6e20 656e  till maintain en
+0003af50: 6f75 6768 2077 6f72 6b65 7273 2074 6f20  ough workers to 
+0003af60: 6861 7665 2065 6e6f 7567 6820 5241 4d20  have enough RAM 
+0003af70: 746f 2073 746f 7265 0a20 2020 2020 2020  to store.       
+0003af80: 206f 7572 2064 6174 612c 2077 6974 6820   our data, with 
+0003af90: 6120 636f 6d66 6f72 7461 626c 6520 6275  a comfortable bu
+0003afa0: 6666 6572 2e0a 0a20 2020 2020 2020 2054  ffer...        T
+0003afb0: 6869 7320 6973 2066 6f72 2075 7365 2077  his is for use w
+0003afc0: 6974 6820 7379 7374 656d 7320 6c69 6b65  ith systems like
+0003afd0: 2060 6064 6973 7472 6962 7574 6564 2e64   ``distributed.d
+0003afe0: 6570 6c6f 792e 6164 6170 7469 7665 6060  eploy.adaptive``
+0003aff0: 2e0a 0a20 2020 2020 2020 2050 6172 616d  ...        Param
+0003b000: 6574 6572 730a 2020 2020 2020 2020 2d2d  eters.        --
+0003b010: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0003b020: 206d 656d 6f72 795f 7261 7469 6f20 3a20   memory_ratio : 
+0003b030: 4e75 6d62 6572 0a20 2020 2020 2020 2020  Number.         
+0003b040: 2020 2041 6d6f 756e 7420 6f66 2065 7874     Amount of ext
+0003b050: 7261 2073 7061 6365 2077 6520 7761 6e74  ra space we want
+0003b060: 2074 6f20 6861 7665 2066 6f72 206f 7572   to have for our
+0003b070: 2073 746f 7265 6420 6461 7461 2e0a 2020   stored data..  
+0003b080: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
+0003b090: 7473 2074 6f20 322c 206f 7220 7468 6174  ts to 2, or that
+0003b0a0: 2077 6520 7761 6e74 2074 6f20 6861 7665   we want to have
+0003b0b0: 2074 7769 6365 2061 7320 6d75 6368 206d   twice as much m
+0003b0c0: 656d 6f72 7920 6173 2077 650a 2020 2020  emory as we.    
+0003b0d0: 2020 2020 2020 2020 6375 7272 656e 746c          currentl
+0003b0e0: 7920 6861 7665 2064 6174 612e 0a20 2020  y have data..   
+0003b0f0: 2020 2020 206e 203a 2069 6e74 0a20 2020       n : int.   
+0003b100: 2020 2020 2020 2020 204e 756d 6265 7220           Number 
+0003b110: 6f66 2077 6f72 6b65 7273 2074 6f20 636c  of workers to cl
+0003b120: 6f73 650a 2020 2020 2020 2020 6d69 6e69  ose.        mini
+0003b130: 6d75 6d20 3a20 696e 740a 2020 2020 2020  mum : int.      
+0003b140: 2020 2020 2020 4d69 6e69 6d75 6d20 6e75        Minimum nu
+0003b150: 6d62 6572 206f 6620 776f 726b 6572 7320  mber of workers 
+0003b160: 746f 206b 6565 7020 6172 6f75 6e64 0a20  to keep around. 
+0003b170: 2020 2020 2020 206b 6579 203a 2043 616c         key : Cal
+0003b180: 6c61 626c 6528 576f 726b 6572 5374 6174  lable(WorkerStat
+0003b190: 6529 0a20 2020 2020 2020 2020 2020 2041  e).            A
+0003b1a0: 6e20 6f70 7469 6f6e 616c 2063 616c 6c61  n optional calla
+0003b1b0: 626c 6520 6d61 7070 696e 6720 6120 576f  ble mapping a Wo
+0003b1c0: 726b 6572 5374 6174 6520 6f62 6a65 6374  rkerState object
+0003b1d0: 2074 6f20 6120 6772 6f75 700a 2020 2020   to a group.    
+0003b1e0: 2020 2020 2020 2020 6166 6669 6c69 6174          affiliat
+0003b1f0: 696f 6e2e 2047 726f 7570 7320 7769 6c6c  ion. Groups will
+0003b200: 2062 6520 636c 6f73 6564 2074 6f67 6574   be closed toget
+0003b210: 6865 722e 2054 6869 7320 6973 2075 7365  her. This is use
+0003b220: 6675 6c20 7768 656e 0a20 2020 2020 2020  ful when.       
+0003b230: 2020 2020 2063 6c6f 7369 6e67 2077 6f72       closing wor
+0003b240: 6b65 7273 206d 7573 7420 6265 2064 6f6e  kers must be don
+0003b250: 6520 636f 6c6c 6563 7469 7665 6c79 2c20  e collectively, 
+0003b260: 7375 6368 2061 7320 6279 2068 6f73 746e  such as by hostn
+0003b270: 616d 652e 0a20 2020 2020 2020 2074 6172  ame..        tar
+0003b280: 6765 7420 3a20 696e 740a 2020 2020 2020  get : int.      
+0003b290: 2020 2020 2020 5461 7267 6574 206e 756d        Target num
+0003b2a0: 6265 7220 6f66 2077 6f72 6b65 7273 2074  ber of workers t
+0003b2b0: 6f20 6861 7665 2061 6674 6572 2077 6520  o have after we 
+0003b2c0: 636c 6f73 650a 2020 2020 2020 2020 6174  close.        at
+0003b2d0: 7472 6962 7574 6520 3a20 7374 720a 2020  tribute : str.  
+0003b2e0: 2020 2020 2020 2020 2020 5468 6520 6174            The at
+0003b2f0: 7472 6962 7574 6520 6f66 2074 6865 2057  tribute of the W
+0003b300: 6f72 6b65 7253 7461 7465 206f 626a 6563  orkerState objec
+0003b310: 7420 746f 2072 6574 7572 6e2c 206c 696b  t to return, lik
+0003b320: 6520 2261 6464 7265 7373 220a 2020 2020  e "address".    
+0003b330: 2020 2020 2020 2020 6f72 2022 6e61 6d65          or "name
+0003b340: 222e 2020 4465 6661 756c 7473 2074 6f20  ".  Defaults to 
+0003b350: 2261 6464 7265 7373 222e 0a0a 2020 2020  "address"...    
+0003b360: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
+0003b370: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+0003b380: 2020 2020 2020 3e3e 3e20 7363 6865 6475        >>> schedu
+0003b390: 6c65 722e 776f 726b 6572 735f 746f 5f63  ler.workers_to_c
+0003b3a0: 6c6f 7365 2829 0a20 2020 2020 2020 205b  lose().        [
+0003b3b0: 2774 6370 3a2f 2f31 3932 2e31 3638 2e30  'tcp://192.168.0
+0003b3c0: 2e31 3a31 3233 3427 2c20 2774 6370 3a2f  .1:1234', 'tcp:/
+0003b3d0: 2f31 3932 2e31 3638 2e30 2e32 3a31 3233  /192.168.0.2:123
+0003b3e0: 3427 5d0a 0a20 2020 2020 2020 2047 726f  4']..        Gro
+0003b3f0: 7570 2077 6f72 6b65 7273 2062 7920 686f  up workers by ho
+0003b400: 7374 6e61 6d65 2070 7269 6f72 2074 6f20  stname prior to 
+0003b410: 636c 6f73 696e 670a 0a20 2020 2020 2020  closing..       
+0003b420: 203e 3e3e 2073 6368 6564 756c 6572 2e77   >>> scheduler.w
+0003b430: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
+0003b440: 6b65 793d 6c61 6d62 6461 2077 733a 2077  key=lambda ws: w
+0003b450: 732e 686f 7374 290a 2020 2020 2020 2020  s.host).        
+0003b460: 5b27 7463 703a 2f2f 3139 322e 3136 382e  ['tcp://192.168.
+0003b470: 302e 313a 3132 3334 272c 2027 7463 703a  0.1:1234', 'tcp:
+0003b480: 2f2f 3139 322e 3136 382e 302e 313a 3435  //192.168.0.1:45
+0003b490: 3637 275d 0a0a 2020 2020 2020 2020 5265  67']..        Re
+0003b4a0: 6d6f 7665 2074 776f 2077 6f72 6b65 7273  move two workers
+0003b4b0: 0a0a 2020 2020 2020 2020 3e3e 3e20 7363  ..        >>> sc
+0003b4c0: 6865 6475 6c65 722e 776f 726b 6572 735f  heduler.workers_
+0003b4d0: 746f 5f63 6c6f 7365 286e 3d32 290a 0a20  to_close(n=2).. 
+0003b4e0: 2020 2020 2020 204b 6565 7020 656e 6f75         Keep enou
+0003b4f0: 6768 2077 6f72 6b65 7273 2074 6f20 6861  gh workers to ha
+0003b500: 7665 2074 7769 6365 2061 7320 6d75 6368  ve twice as much
+0003b510: 206d 656d 6f72 7920 6173 2077 6520 7765   memory as we we
+0003b520: 206e 6565 642e 0a0a 2020 2020 2020 2020   need...        
+0003b530: 3e3e 3e20 7363 6865 6475 6c65 722e 776f  >>> scheduler.wo
+0003b540: 726b 6572 735f 746f 5f63 6c6f 7365 286d  rkers_to_close(m
+0003b550: 656d 6f72 795f 7261 7469 6f3d 3229 0a0a  emory_ratio=2)..
+0003b560: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
+0003b570: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
+0003b580: 2020 2020 2020 2020 746f 5f63 6c6f 7365          to_close
+0003b590: 3a20 6c69 7374 206f 6620 776f 726b 6572  : list of worker
+0003b5a0: 2061 6464 7265 7373 6573 2074 6861 7420   addresses that 
+0003b5b0: 6172 6520 4f4b 2074 6f20 636c 6f73 650a  are OK to close.
+0003b5c0: 0a20 2020 2020 2020 2053 6565 2041 6c73  .        See Als
+0003b5d0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+0003b5e0: 2d2d 0a20 2020 2020 2020 2053 6368 6564  --.        Sched
+0003b5f0: 756c 6572 2e72 6574 6972 655f 776f 726b  uler.retire_work
+0003b600: 6572 730a 2020 2020 2020 2020 2222 220a  ers.        """.
+0003b610: 2020 2020 2020 2020 6966 2074 6172 6765          if targe
+0003b620: 7420 6973 206e 6f74 204e 6f6e 6520 616e  t is not None an
+0003b630: 6420 6e20 6973 204e 6f6e 653a 0a20 2020  d n is None:.   
+0003b640: 2020 2020 2020 2020 206e 203d 206c 656e           n = len
+0003b650: 2873 656c 662e 776f 726b 6572 7329 202d  (self.workers) -
+0003b660: 2074 6172 6765 740a 2020 2020 2020 2020   target.        
+0003b670: 6966 206e 2069 7320 6e6f 7420 4e6f 6e65  if n is not None
+0003b680: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0003b690: 206e 203c 2030 3a0a 2020 2020 2020 2020   n < 0:.        
+0003b6a0: 2020 2020 2020 2020 6e20 3d20 300a 2020          n = 0.  
+0003b6b0: 2020 2020 2020 2020 2020 7461 7267 6574            target
+0003b6c0: 203d 206c 656e 2873 656c 662e 776f 726b   = len(self.work
+0003b6d0: 6572 7329 202d 206e 0a0a 2020 2020 2020  ers) - n..      
+0003b6e0: 2020 6966 206e 2069 7320 4e6f 6e65 2061    if n is None a
+0003b6f0: 6e64 206d 656d 6f72 795f 7261 7469 6f20  nd memory_ratio 
+0003b700: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0003b710: 2020 2020 206d 656d 6f72 795f 7261 7469       memory_rati
+0003b720: 6f20 3d20 320a 0a20 2020 2020 2020 2077  o = 2..        w
+0003b730: 6974 6820 6c6f 675f 6572 726f 7273 2829  ith log_errors()
+0003b740: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0003b750: 206e 6f74 206e 2061 6e64 2061 6c6c 285b   not n and all([
+0003b760: 7773 2e70 726f 6365 7373 696e 6720 666f  ws.processing fo
+0003b770: 7220 7773 2069 6e20 7365 6c66 2e77 6f72  r ws in self.wor
+0003b780: 6b65 7273 2e76 616c 7565 7328 295d 293a  kers.values()]):
+0003b790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b7a0: 2072 6574 7572 6e20 5b5d 0a0a 2020 2020   return []..    
+0003b7b0: 2020 2020 2020 2020 6966 206b 6579 2069          if key i
+0003b7c0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0003b7d0: 2020 2020 2020 2020 6b65 7920 3d20 6f70          key = op
+0003b7e0: 6572 6174 6f72 2e61 7474 7267 6574 7465  erator.attrgette
+0003b7f0: 7228 2261 6464 7265 7373 2229 0a20 2020  r("address").   
+0003b800: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0003b810: 7374 616e 6365 286b 6579 2c20 6279 7465  stance(key, byte
+0003b820: 7329 2061 6e64 2064 6173 6b2e 636f 6e66  s) and dask.conf
+0003b830: 6967 2e67 6574 280a 2020 2020 2020 2020  ig.get(.        
+0003b840: 2020 2020 2020 2020 2264 6973 7472 6962          "distrib
+0003b850: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
+0003b860: 6963 6b6c 6522 0a20 2020 2020 2020 2020  ickle".         
+0003b870: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+0003b880: 2020 2020 2020 6b65 7920 3d20 7069 636b        key = pick
+0003b890: 6c65 2e6c 6f61 6473 286b 6579 290a 0a20  le.loads(key).. 
+0003b8a0: 2020 2020 2020 2020 2020 2067 726f 7570             group
+0003b8b0: 7320 3d20 6772 6f75 7062 7928 6b65 792c  s = groupby(key,
+0003b8c0: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
+0003b8d0: 6c75 6573 2829 290a 0a20 2020 2020 2020  lues())..       
+0003b8e0: 2020 2020 206c 696d 6974 5f62 7974 6573       limit_bytes
+0003b8f0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0003b900: 2020 2020 206b 3a20 7375 6d28 7773 2e6d       k: sum(ws.m
+0003b910: 656d 6f72 795f 6c69 6d69 7420 666f 7220  emory_limit for 
+0003b920: 7773 2069 6e20 7629 2066 6f72 206b 2c20  ws in v) for k, 
+0003b930: 7620 696e 2067 726f 7570 732e 6974 656d  v in groups.item
+0003b940: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+0003b950: 7d0a 2020 2020 2020 2020 2020 2020 6772  }.            gr
+0003b960: 6f75 705f 6279 7465 7320 3d20 7b6b 3a20  oup_bytes = {k: 
+0003b970: 7375 6d28 7773 2e6e 6279 7465 7320 666f  sum(ws.nbytes fo
+0003b980: 7220 7773 2069 6e20 7629 2066 6f72 206b  r ws in v) for k
+0003b990: 2c20 7620 696e 2067 726f 7570 732e 6974  , v in groups.it
+0003b9a0: 656d 7328 297d 0a0a 2020 2020 2020 2020  ems()}..        
+0003b9b0: 2020 2020 6c69 6d69 7420 3d20 7375 6d28      limit = sum(
+0003b9c0: 6c69 6d69 745f 6279 7465 732e 7661 6c75  limit_bytes.valu
+0003b9d0: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
+0003b9e0: 2020 746f 7461 6c20 3d20 7375 6d28 6772    total = sum(gr
+0003b9f0: 6f75 705f 6279 7465 732e 7661 6c75 6573  oup_bytes.values
+0003ba00: 2829 290a 0a20 2020 2020 2020 2020 2020  ())..           
+0003ba10: 2064 6566 205f 6b65 7928 6772 6f75 7029   def _key(group)
+0003ba20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003ba30: 2020 6973 5f69 646c 6520 3d20 6e6f 7420    is_idle = not 
+0003ba40: 616e 7928 5b77 7773 2e70 726f 6365 7373  any([wws.process
+0003ba50: 696e 6720 666f 7220 7777 7320 696e 2067  ing for wws in g
+0003ba60: 726f 7570 735b 6772 6f75 705d 5d29 0a20  roups[group]]). 
+0003ba70: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0003ba80: 7974 6573 203d 202d 6772 6f75 705f 6279  ytes = -group_by
+0003ba90: 7465 735b 6772 6f75 705d 0a20 2020 2020  tes[group].     
+0003baa0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003bab0: 6e20 6973 5f69 646c 652c 2062 7974 6573  n is_idle, bytes
+0003bac0: 0a0a 2020 2020 2020 2020 2020 2020 6964  ..            id
+0003bad0: 6c65 203d 2073 6f72 7465 6428 6772 6f75  le = sorted(grou
+0003bae0: 7073 2c20 6b65 793d 5f6b 6579 290a 0a20  ps, key=_key).. 
+0003baf0: 2020 2020 2020 2020 2020 2074 6f5f 636c             to_cl
+0003bb00: 6f73 6520 3d20 5b5d 0a20 2020 2020 2020  ose = [].       
+0003bb10: 2020 2020 206e 5f72 656d 6169 6e20 3d20       n_remain = 
+0003bb20: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
+0003bb30: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
+0003bb40: 6869 6c65 2069 646c 653a 0a20 2020 2020  hile idle:.     
+0003bb50: 2020 2020 2020 2020 2020 2067 726f 7570             group
+0003bb60: 203d 2069 646c 652e 706f 7028 290a 2020   = idle.pop().  
+0003bb70: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003bb80: 206e 2069 7320 4e6f 6e65 2061 6e64 2061   n is None and a
+0003bb90: 6e79 285b 7773 2e70 726f 6365 7373 696e  ny([ws.processin
+0003bba0: 6720 666f 7220 7773 2069 6e20 6772 6f75  g for ws in grou
+0003bbb0: 7073 5b67 726f 7570 5d5d 293a 0a20 2020  ps[group]]):.   
+0003bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bbd0: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
+0003bbe0: 2020 2020 2020 2020 6966 206d 696e 696d          if minim
+0003bbf0: 756d 2061 6e64 206e 5f72 656d 6169 6e20  um and n_remain 
+0003bc00: 2d20 6c65 6e28 6772 6f75 7073 5b67 726f  - len(groups[gro
+0003bc10: 7570 5d29 203c 206d 696e 696d 756d 3a0a  up]) < minimum:.
+0003bc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bc30: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+0003bc40: 2020 2020 2020 2020 2020 206c 696d 6974             limit
+0003bc50: 202d 3d20 6c69 6d69 745f 6279 7465 735b   -= limit_bytes[
+0003bc60: 6772 6f75 705d 0a0a 2020 2020 2020 2020  group]..        
+0003bc70: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
+0003bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bc90: 206e 2069 7320 6e6f 7420 4e6f 6e65 2061   n is not None a
+0003bca0: 6e64 206e 5f72 656d 6169 6e20 2d20 6c65  nd n_remain - le
+0003bcb0: 6e28 6772 6f75 7073 5b67 726f 7570 5d29  n(groups[group])
+0003bcc0: 203e 3d20 2874 6172 6765 7420 6f72 2030   >= (target or 0
+0003bcd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003bce0: 2020 2920 6f72 2028 6d65 6d6f 7279 5f72    ) or (memory_r
+0003bcf0: 6174 696f 2069 7320 6e6f 7420 4e6f 6e65  atio is not None
+0003bd00: 2061 6e64 206c 696d 6974 203e 3d20 6d65   and limit >= me
+0003bd10: 6d6f 7279 5f72 6174 696f 202a 2074 6f74  mory_ratio * tot
+0003bd20: 616c 293a 0a20 2020 2020 2020 2020 2020  al):.           
+0003bd30: 2020 2020 2020 2020 2074 6f5f 636c 6f73           to_clos
+0003bd40: 652e 6170 7065 6e64 2867 726f 7570 290a  e.append(group).
+0003bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bd60: 2020 2020 6e5f 7265 6d61 696e 202d 3d20      n_remain -= 
+0003bd70: 6c65 6e28 6772 6f75 7073 5b67 726f 7570  len(groups[group
+0003bd80: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+0003bd90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003bda0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+0003bdb0: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
+0003bdc0: 2072 6573 756c 7420 3d20 5b67 6574 6174   result = [getat
+0003bdd0: 7472 2877 732c 2061 7474 7269 6275 7465  tr(ws, attribute
+0003bde0: 2920 666f 7220 6720 696e 2074 6f5f 636c  ) for g in to_cl
+0003bdf0: 6f73 6520 666f 7220 7773 2069 6e20 6772  ose for ws in gr
+0003be00: 6f75 7073 5b67 5d5d 0a20 2020 2020 2020  oups[g]].       
+0003be10: 2020 2020 2069 6620 7265 7375 6c74 3a0a       if result:.
+0003be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003be30: 6c6f 6767 6572 2e64 6562 7567 2822 5375  logger.debug("Su
+0003be40: 6767 6573 7420 636c 6f73 696e 6720 776f  ggest closing wo
+0003be50: 726b 6572 733a 2025 7322 2c20 7265 7375  rkers: %s", resu
+0003be60: 6c74 290a 0a20 2020 2020 2020 2020 2020  lt)..           
+0003be70: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+0003be80: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+0003be90: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
+0003bea0: 7469 7265 5f77 6f72 6b65 7273 280a 2020  tire_workers(.  
+0003beb0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0003bec0: 2020 2020 776f 726b 6572 733a 206c 6973      workers: lis
+0003bed0: 745b 7374 725d 207c 204e 6f6e 6520 3d20  t[str] | None = 
+0003bee0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2c  None,.        *,
+0003bef0: 0a20 2020 2020 2020 206e 616d 6573 3a20  .        names: 
+0003bf00: 6c69 7374 207c 204e 6f6e 6520 3d20 4e6f  list | None = No
+0003bf10: 6e65 2c0a 2020 2020 2020 2020 636c 6f73  ne,.        clos
+0003bf20: 655f 776f 726b 6572 733a 2062 6f6f 6c20  e_workers: bool 
+0003bf30: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+0003bf40: 2072 656d 6f76 653a 2062 6f6f 6c20 3d20   remove: bool = 
+0003bf50: 5472 7565 2c0a 2020 2020 2020 2020 7374  True,.        st
+0003bf60: 696d 756c 7573 5f69 643a 2073 7472 207c  imulus_id: str |
+0003bf70: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+0003bf80: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+0003bf90: 416e 792c 0a20 2020 2029 202d 3e20 6469  Any,.    ) -> di
+0003bfa0: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
+0003bfb0: 2020 2020 2020 2222 2247 7261 6365 6675        """Gracefu
+0003bfc0: 6c6c 7920 7265 7469 7265 2077 6f72 6b65  lly retire worke
+0003bfd0: 7273 2066 726f 6d20 636c 7573 7465 722e  rs from cluster.
+0003bfe0: 2041 6e79 206b 6579 2074 6861 7420 6973   Any key that is
+0003bff0: 2069 6e20 6d65 6d6f 7279 2065 7863 6c75   in memory exclu
+0003c000: 7369 7665 6c79 0a20 2020 2020 2020 206f  sively.        o
+0003c010: 6e20 7468 6520 7265 7469 7265 6420 776f  n the retired wo
+0003c020: 726b 6572 7320 6973 2072 6570 6c69 6361  rkers is replica
+0003c030: 7465 6420 736f 6d65 7768 6572 6520 656c  ted somewhere el
+0003c040: 7365 2e0a 0a20 2020 2020 2020 2050 6172  se...        Par
+0003c050: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+0003c060: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+0003c070: 2020 2077 6f72 6b65 7273 3a20 6c69 7374     workers: list
+0003c080: 5b73 7472 5d20 286f 7074 696f 6e61 6c29  [str] (optional)
+0003c090: 0a20 2020 2020 2020 2020 2020 204c 6973  .            Lis
+0003c0a0: 7420 6f66 2077 6f72 6b65 7220 6164 6472  t of worker addr
+0003c0b0: 6573 7365 7320 746f 2072 6574 6972 652e  esses to retire.
+0003c0c0: 0a20 2020 2020 2020 206e 616d 6573 3a20  .        names: 
+0003c0d0: 6c69 7374 2028 6f70 7469 6f6e 616c 290a  list (optional).
+0003c0e0: 2020 2020 2020 2020 2020 2020 4c69 7374              List
+0003c0f0: 206f 6620 776f 726b 6572 206e 616d 6573   of worker names
+0003c100: 2074 6f20 7265 7469 7265 2e0a 2020 2020   to retire..    
+0003c110: 2020 2020 2020 2020 4d75 7475 616c 6c79          Mutually
+0003c120: 2065 7863 6c75 7369 7665 2077 6974 6820   exclusive with 
+0003c130: 6060 776f 726b 6572 7360 602e 0a20 2020  ``workers``..   
+0003c140: 2020 2020 2020 2020 2049 6620 6e65 6974           If neit
+0003c150: 6865 7220 6060 776f 726b 6572 7360 6020  her ``workers`` 
+0003c160: 6e6f 7220 6060 6e61 6d65 7360 6020 6172  nor ``names`` ar
+0003c170: 6520 7072 6f76 6964 6564 2c20 7765 2063  e provided, we c
+0003c180: 616c 6c0a 2020 2020 2020 2020 2020 2020  all.            
+0003c190: 6060 776f 726b 6572 735f 746f 5f63 6c6f  ``workers_to_clo
+0003c1a0: 7365 6060 2077 6869 6368 2066 696e 6473  se`` which finds
+0003c1b0: 2061 2067 6f6f 6420 7365 742e 0a20 2020   a good set..   
+0003c1c0: 2020 2020 2063 6c6f 7365 5f77 6f72 6b65       close_worke
+0003c1d0: 7273 3a20 626f 6f6c 2028 6465 6661 756c  rs: bool (defaul
+0003c1e0: 7473 2074 6f20 4661 6c73 6529 0a20 2020  ts to False).   
+0003c1f0: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+0003c200: 206f 7220 6e6f 7420 746f 2061 6374 7561   or not to actua
+0003c210: 6c6c 7920 636c 6f73 6520 7468 6520 776f  lly close the wo
+0003c220: 726b 6572 2065 7870 6c69 6369 746c 7920  rker explicitly 
+0003c230: 6672 6f6d 2068 6572 652e 0a20 2020 2020  from here..     
+0003c240: 2020 2020 2020 204f 7468 6572 7769 7365         Otherwise
+0003c250: 2077 6520 6578 7065 6374 2073 6f6d 6520   we expect some 
+0003c260: 6578 7465 726e 616c 206a 6f62 2073 6368  external job sch
+0003c270: 6564 756c 6572 2074 6f20 6669 6e69 7368  eduler to finish
+0003c280: 206f 6666 2074 6865 0a20 2020 2020 2020   off the.       
+0003c290: 2020 2020 2077 6f72 6b65 722e 0a20 2020       worker..   
+0003c2a0: 2020 2020 2072 656d 6f76 653a 2062 6f6f       remove: boo
+0003c2b0: 6c20 2864 6566 6175 6c74 7320 746f 2054  l (defaults to T
+0003c2c0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0003c2d0: 2057 6865 7468 6572 206f 7220 6e6f 7420   Whether or not 
+0003c2e0: 746f 2072 656d 6f76 6520 7468 6520 776f  to remove the wo
+0003c2f0: 726b 6572 206d 6574 6164 6174 6120 696d  rker metadata im
+0003c300: 6d65 6469 6174 656c 7920 6f72 2065 6c73  mediately or els
+0003c310: 650a 2020 2020 2020 2020 2020 2020 7761  e.            wa
+0003c320: 6974 2066 6f72 2074 6865 2077 6f72 6b65  it for the worke
+0003c330: 7220 746f 2063 6f6e 7461 6374 2075 732e  r to contact us.
+0003c340: 0a0a 2020 2020 2020 2020 2020 2020 4966  ..            If
+0003c350: 2063 6c6f 7365 5f77 6f72 6b65 7273 3d46   close_workers=F
+0003c360: 616c 7365 2061 6e64 2072 656d 6f76 653d  alse and remove=
+0003c370: 4661 6c73 652c 2074 6869 7320 6d65 7468  False, this meth
+0003c380: 6f64 206a 7573 7420 666c 7573 6865 7320  od just flushes 
+0003c390: 7468 6520 7461 736b 730a 2020 2020 2020  the tasks.      
+0003c3a0: 2020 2020 2020 696e 206d 656d 6f72 7920        in memory 
+0003c3b0: 6f75 7420 6f66 2074 6865 2077 6f72 6b65  out of the worke
+0003c3c0: 7273 2061 6e64 2074 6865 6e20 7265 7475  rs and then retu
+0003c3d0: 726e 732e 0a20 2020 2020 2020 2020 2020  rns..           
+0003c3e0: 2049 6620 636c 6f73 655f 776f 726b 6572   If close_worker
+0003c3f0: 733d 5472 7565 2061 6e64 2072 656d 6f76  s=True and remov
+0003c400: 653d 4661 6c73 652c 2074 6869 7320 6d65  e=False, this me
+0003c410: 7468 6f64 2077 696c 6c20 7265 7475 726e  thod will return
+0003c420: 2077 6869 6c65 2074 6865 0a20 2020 2020   while the.     
+0003c430: 2020 2020 2020 2077 6f72 6b65 7273 2061         workers a
+0003c440: 7265 2073 7469 6c6c 2069 6e20 7468 6520  re still in the 
+0003c450: 636c 7573 7465 722c 2061 6c74 686f 7567  cluster, althoug
+0003c460: 6820 7468 6579 2077 6f6e 2774 2061 6363  h they won't acc
+0003c470: 6570 7420 6e65 7720 7461 736b 732e 0a20  ept new tasks.. 
+0003c480: 2020 2020 2020 2020 2020 2049 6620 636c             If cl
+0003c490: 6f73 655f 776f 726b 6572 733d 4661 6c73  ose_workers=Fals
+0003c4a0: 6520 6f72 2066 6f72 2077 6861 7465 7665  e or for whateve
+0003c4b0: 7220 7265 6173 6f6e 2061 2077 6f72 6b65  r reason a worke
+0003c4c0: 7220 646f 6573 6e27 7420 6163 6365 7074  r doesn't accept
+0003c4d0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0003c4e0: 2063 6c6f 7365 2063 6f6d 6d61 6e64 2c20   close command, 
+0003c4f0: 6974 2077 696c 6c20 6265 206c 6566 7420  it will be left 
+0003c500: 7065 726d 616e 656e 746c 7920 756e 6162  permanently unab
+0003c510: 6c65 2074 6f20 6163 6365 7074 206e 6577  le to accept new
+0003c520: 2074 6173 6b73 2061 6e64 0a20 2020 2020   tasks and.     
+0003c530: 2020 2020 2020 2069 7420 6973 2065 7870         it is exp
+0003c540: 6563 7465 6420 746f 2062 6520 636c 6f73  ected to be clos
+0003c550: 6564 2069 6e20 736f 6d65 206f 7468 6572  ed in some other
+0003c560: 2077 6179 2e0a 0a20 2020 2020 2020 202a   way...        *
+0003c570: 2a6b 7761 7267 733a 2064 6963 740a 2020  *kwargs: dict.  
+0003c580: 2020 2020 2020 2020 2020 4578 7472 6120            Extra 
+0003c590: 6f70 7469 6f6e 7320 746f 2070 6173 7320  options to pass 
+0003c5a0: 746f 2077 6f72 6b65 7273 5f74 6f5f 636c  to workers_to_cl
+0003c5b0: 6f73 6520 746f 2064 6574 6572 6d69 6e65  ose to determine
+0003c5c0: 2077 6869 6368 0a20 2020 2020 2020 2020   which.         
+0003c5d0: 2020 2077 6f72 6b65 7273 2077 6520 7368     workers we sh
+0003c5e0: 6f75 6c64 2064 726f 700a 0a20 2020 2020  ould drop..     
+0003c5f0: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+0003c600: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+0003c610: 2020 2044 6963 7469 6f6e 6172 7920 6d61     Dictionary ma
+0003c620: 7070 696e 6720 776f 726b 6572 2049 442f  pping worker ID/
+0003c630: 6164 6472 6573 7320 746f 2064 6963 7469  address to dicti
+0003c640: 6f6e 6172 7920 6f66 2069 6e66 6f72 6d61  onary of informa
+0003c650: 7469 6f6e 2061 626f 7574 0a20 2020 2020  tion about.     
+0003c660: 2020 2074 6861 7420 776f 726b 6572 2066     that worker f
+0003c670: 6f72 2065 6163 6820 7265 7469 7265 6420  or each retired 
+0003c680: 776f 726b 6572 2e0a 0a20 2020 2020 2020  worker...       
+0003c690: 2049 6620 7468 6572 6520 6172 6520 6b65   If there are ke
+0003c6a0: 7973 2074 6861 7420 6578 6973 7420 696e  ys that exist in
+0003c6b0: 206d 656d 6f72 7920 6f6e 6c79 206f 6e20   memory only on 
+0003c6c0: 7468 6520 776f 726b 6572 7320 6265 696e  the workers bein
+0003c6d0: 6720 7265 7469 7265 6420 616e 6420 6974  g retired and it
+0003c6e0: 0a20 2020 2020 2020 2077 6173 2069 6d70  .        was imp
+0003c6f0: 6f73 7369 626c 6520 746f 2072 6570 6c69  ossible to repli
+0003c700: 6361 7465 2074 6865 6d20 736f 6d65 7768  cate them somewh
+0003c710: 6572 6520 656c 7365 2028 652e 672e 2062  ere else (e.g. b
+0003c720: 6563 6175 7365 2074 6865 7265 2061 7265  ecause there are
+0003c730: 6e27 740a 2020 2020 2020 2020 616e 7920  n't.        any 
+0003c740: 6f74 6865 7220 7275 6e6e 696e 6720 776f  other running wo
+0003c750: 726b 6572 7329 2c20 7468 6520 776f 726b  rkers), the work
+0003c760: 6572 7320 686f 6c64 696e 6720 7375 6368  ers holding such
+0003c770: 206b 6579 7320 776f 6e27 7420 6265 2072   keys won't be r
+0003c780: 6574 6972 6564 2061 6e64 0a20 2020 2020  etired and.     
+0003c790: 2020 2077 6f6e 2774 2061 7070 6561 7220     won't appear 
+0003c7a0: 696e 2074 6865 2072 6574 7572 6e65 6420  in the returned 
+0003c7b0: 6469 6374 2e0a 0a20 2020 2020 2020 2053  dict...        S
+0003c7c0: 6565 2041 6c73 6f0a 2020 2020 2020 2020  ee Also.        
+0003c7d0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0003c7e0: 2053 6368 6564 756c 6572 2e77 6f72 6b65   Scheduler.worke
+0003c7f0: 7273 5f74 6f5f 636c 6f73 650a 2020 2020  rs_to_close.    
+0003c800: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0003c810: 7374 696d 756c 7573 5f69 6420 3d20 7374  stimulus_id = st
+0003c820: 696d 756c 7573 5f69 6420 6f72 2066 2272  imulus_id or f"r
+0003c830: 6574 6972 652d 776f 726b 6572 732d 7b74  etire-workers-{t
+0003c840: 696d 6528 297d 220a 2020 2020 2020 2020  ime()}".        
+0003c850: 2320 5468 6973 206c 6f63 6b20 6d61 6b65  # This lock make
+0003c860: 7320 7265 7469 7265 5f77 6f72 6b65 7273  s retire_workers
+0003c870: 2c20 7265 6261 6c61 6e63 652c 2061 6e64  , rebalance, and
+0003c880: 2072 6570 6c69 6361 7465 206d 7574 7561   replicate mutua
+0003c890: 6c6c 790a 2020 2020 2020 2020 2320 6578  lly.        # ex
+0003c8a0: 636c 7573 6976 6520 616e 6420 7769 6c6c  clusive and will
+0003c8b0: 206e 6f20 6c6f 6e67 6572 2062 6520 6e65   no longer be ne
+0003c8c0: 6365 7373 6172 7920 6f6e 6365 2072 6562  cessary once reb
+0003c8d0: 616c 616e 6365 2061 6e64 2072 6570 6c69  alance and repli
+0003c8e0: 6361 7465 2061 7265 0a20 2020 2020 2020  cate are.       
+0003c8f0: 2023 206d 6967 7261 7465 6420 746f 2074   # migrated to t
+0003c900: 6865 2041 6374 6976 6520 4d65 6d6f 7279  he Active Memory
+0003c910: 204d 616e 6167 6572 2e0a 2020 2020 2020   Manager..      
+0003c920: 2020 2320 4e6f 7465 2074 6861 742c 2069    # Note that, i
+0003c930: 6e63 6964 656e 7461 6c6c 792c 2069 7420  ncidentally, it 
+0003c940: 616c 736f 2070 7265 7665 6e74 7320 6d75  also prevents mu
+0003c950: 6c74 6970 6c65 2063 616c 6c73 2074 6f20  ltiple calls to 
+0003c960: 7265 7469 7265 5f77 6f72 6b65 7273 0a20  retire_workers. 
+0003c970: 2020 2020 2020 2023 2066 726f 6d20 7275         # from ru
+0003c980: 6e6e 696e 6720 696e 2070 6172 616c 6c65  nning in paralle
+0003c990: 6c20 2d20 7468 6973 2069 7320 756e 6e65  l - this is unne
+0003c9a0: 6365 7373 6172 792e 0a20 2020 2020 2020  cessary..       
+0003c9b0: 2061 7379 6e63 2077 6974 6820 7365 6c66   async with self
+0003c9c0: 2e5f 6c6f 636b 3a0a 2020 2020 2020 2020  ._lock:.        
+0003c9d0: 2020 2020 6966 206e 616d 6573 2069 7320      if names is 
+0003c9e0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0003c9f0: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
+0003ca00: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
+0003ca10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003ca20: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+0003ca30: 4572 726f 7228 226e 616d 6573 2061 6e64  Error("names and
+0003ca40: 2077 6f72 6b65 7273 2061 7265 206d 7574   workers are mut
+0003ca50: 7561 6c6c 7920 6578 636c 7573 6976 6522  ually exclusive"
+0003ca60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003ca70: 2020 6966 206e 616d 6573 3a0a 2020 2020    if names:.    
+0003ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ca90: 6c6f 6767 6572 2e69 6e66 6f28 2252 6574  logger.info("Ret
+0003caa0: 6972 6520 776f 726b 6572 206e 616d 6573  ire worker names
+0003cab0: 2025 7322 2c20 6e61 6d65 7329 0a20 2020   %s", names).   
+0003cac0: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+0003cad0: 7570 706f 7274 2063 6173 6573 2077 6865  upport cases whe
+0003cae0: 7265 206e 616d 6573 2061 7265 2070 6173  re names are pas
+0003caf0: 7365 6420 7468 726f 7567 6820 6120 434c  sed through a CL
+0003cb00: 4920 616e 6420 6265 636f 6d65 0a20 2020  I and become.   
+0003cb10: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+0003cb20: 7472 696e 6773 0a20 2020 2020 2020 2020  trings.         
+0003cb30: 2020 2020 2020 206e 616d 6573 5f73 6574         names_set
+0003cb40: 203d 207b 7374 7228 6e61 6d65 2920 666f   = {str(name) fo
+0003cb50: 7220 6e61 6d65 2069 6e20 6e61 6d65 737d  r name in names}
+0003cb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003cb70: 2077 7373 203d 207b 7773 2066 6f72 2077   wss = {ws for w
+0003cb80: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
+0003cb90: 732e 7661 6c75 6573 2829 2069 6620 7374  s.values() if st
+0003cba0: 7228 7773 2e6e 616d 6529 2069 6e20 6e61  r(ws.name) in na
+0003cbb0: 6d65 735f 7365 747d 0a20 2020 2020 2020  mes_set}.       
+0003cbc0: 2020 2020 2065 6c69 6620 776f 726b 6572       elif worker
+0003cbd0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+0003cbe0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0003cbf0: 7373 203d 207b 0a20 2020 2020 2020 2020  ss = {.         
+0003cc00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003cc10: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
+0003cc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003cc30: 2020 2020 2066 6f72 2061 6464 7265 7373       for address
+0003cc40: 2069 6e20 776f 726b 6572 730a 2020 2020   in workers.    
+0003cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cc60: 6966 2061 6464 7265 7373 2069 6e20 7365  if address in se
+0003cc70: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
+0003cc80: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0003cc90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0003cca0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0003ccb0: 7373 203d 207b 0a20 2020 2020 2020 2020  ss = {.         
+0003ccc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003ccd0: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
+0003cce0: 2066 6f72 2061 6464 7265 7373 2069 6e20   for address in 
+0003ccf0: 7365 6c66 2e77 6f72 6b65 7273 5f74 6f5f  self.workers_to_
+0003cd00: 636c 6f73 6528 2a2a 6b77 6172 6773 290a  close(**kwargs).
+0003cd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cd20: 7d0a 2020 2020 2020 2020 2020 2020 6966  }.            if
+0003cd30: 206e 6f74 2077 7373 3a0a 2020 2020 2020   not wss:.      
+0003cd40: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003cd50: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
+0003cd60: 2073 746f 705f 616d 6d20 3d20 4661 6c73   stop_amm = Fals
+0003cd70: 650a 2020 2020 2020 2020 2020 2020 616d  e.            am
+0003cd80: 6d3a 2041 6374 6976 654d 656d 6f72 794d  m: ActiveMemoryM
+0003cd90: 616e 6167 6572 4578 7465 6e73 696f 6e20  anagerExtension 
+0003cda0: 3d20 7365 6c66 2e65 7874 656e 7369 6f6e  = self.extension
+0003cdb0: 735b 2261 6d6d 225d 0a20 2020 2020 2020  s["amm"].       
+0003cdc0: 2020 2020 2069 6620 6e6f 7420 616d 6d2e       if not amm.
+0003cdd0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+0003cde0: 2020 2020 2020 2020 2061 6d6d 203d 2041           amm = A
+0003cdf0: 6374 6976 654d 656d 6f72 794d 616e 6167  ctiveMemoryManag
+0003ce00: 6572 4578 7465 6e73 696f 6e28 0a20 2020  erExtension(.   
+0003ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ce20: 2073 656c 662c 2070 6f6c 6963 6965 733d   self, policies=
+0003ce30: 7365 7428 292c 2072 6567 6973 7465 723d  set(), register=
+0003ce40: 4661 6c73 652c 2073 7461 7274 3d54 7275  False, start=Tru
+0003ce50: 652c 2069 6e74 6572 7661 6c3d 322e 300a  e, interval=2.0.
+0003ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ce70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003ce80: 2020 7374 6f70 5f61 6d6d 203d 2054 7275    stop_amm = Tru
+0003ce90: 650a 0a20 2020 2020 2020 2020 2020 2074  e..            t
+0003cea0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0003ceb0: 2020 2020 636f 726f 7320 3d20 5b5d 0a20      coros = []. 
+0003cec0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003ced0: 6f72 2077 7320 696e 2077 7373 3a0a 2020  or ws in wss:.  
+0003cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cef0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
+0003cf00: 6574 6972 696e 6720 776f 726b 6572 2025  etiring worker %
+0003cf10: 7322 2c20 7773 2e61 6464 7265 7373 290a  s", ws.address).
+0003cf20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003cf30: 2020 2020 2070 6f6c 6963 7920 3d20 5265       policy = Re
+0003cf40: 7469 7265 576f 726b 6572 2877 732e 6164  tireWorker(ws.ad
+0003cf50: 6472 6573 7329 0a20 2020 2020 2020 2020  dress).         
+0003cf60: 2020 2020 2020 2020 2020 2061 6d6d 2e61             amm.a
+0003cf70: 6464 5f70 6f6c 6963 7928 706f 6c69 6379  dd_policy(policy
+0003cf80: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0003cf90: 2020 2020 2020 2023 2043 6861 6e67 6520         # Change 
+0003cfa0: 576f 726b 6572 2e73 7461 7475 7320 746f  Worker.status to
+0003cfb0: 2063 6c6f 7369 6e67 5f67 7261 6365 6675   closing_gracefu
+0003cfc0: 6c6c 792e 2049 6d6d 6564 6961 7465 6c79  lly. Immediately
+0003cfd0: 2073 6574 0a20 2020 2020 2020 2020 2020   set.           
+0003cfe0: 2020 2020 2020 2020 2023 2074 6865 2073           # the s
+0003cff0: 616d 6520 6f6e 2074 6865 2073 6368 6564  ame on the sched
+0003d000: 756c 6572 2074 6f20 7072 6576 656e 7420  uler to prevent 
+0003d010: 7261 6365 2063 6f6e 6469 7469 6f6e 732e  race conditions.
+0003d020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d030: 2020 2020 2070 7265 765f 7374 6174 7573       prev_status
+0003d040: 203d 2077 732e 7374 6174 7573 0a20 2020   = ws.status.   
+0003d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d060: 2073 656c 662e 6861 6e64 6c65 5f77 6f72   self.handle_wor
+0003d070: 6b65 725f 7374 6174 7573 5f63 6861 6e67  ker_status_chang
+0003d080: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0003d090: 2020 2020 2020 2020 2020 2053 7461 7475             Statu
+0003d0a0: 732e 636c 6f73 696e 675f 6772 6163 6566  s.closing_gracef
+0003d0b0: 756c 6c79 2c20 7773 2c20 7374 696d 756c  ully, ws, stimul
+0003d0c0: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
+0003d0d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0003d0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d0f0: 2320 4649 584d 453a 2057 6520 7368 6f75  # FIXME: We shou
+0003d100: 6c64 2073 656e 6420 6120 6d65 7373 6167  ld send a messag
+0003d110: 6520 746f 2074 6865 206e 616e 6e79 2066  e to the nanny f
+0003d120: 6972 7374 3b0a 2020 2020 2020 2020 2020  irst;.          
+0003d130: 2020 2020 2020 2020 2020 2320 6576 656e            # even
+0003d140: 7475 616c 6c79 2077 6f72 6b65 7273 2077  tually workers w
+0003d150: 6f6e 2774 2062 6520 6162 6c65 2074 6f20  on't be able to 
+0003d160: 636c 6f73 6520 7468 6569 7220 6f77 6e20  close their own 
+0003d170: 6e61 6e6e 6965 732e 0a20 2020 2020 2020  nannies..       
+0003d180: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0003d190: 662e 7374 7265 616d 5f63 6f6d 6d73 5b77  f.stream_comms[w
+0003d1a0: 732e 6164 6472 6573 735d 2e73 656e 6428  s.address].send(
+0003d1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d1c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0003d1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d1e0: 2020 2020 2020 2022 6f70 223a 2022 776f         "op": "wo
+0003d1f0: 726b 6572 2d73 7461 7475 732d 6368 616e  rker-status-chan
+0003d200: 6765 222c 0a20 2020 2020 2020 2020 2020  ge",.           
+0003d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d220: 2022 7374 6174 7573 223a 2077 732e 7374   "status": ws.st
+0003d230: 6174 7573 2e6e 616d 652c 0a20 2020 2020  atus.name,.     
+0003d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d250: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+0003d260: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+0003d270: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0003d280: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0003d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d2a0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0003d2b0: 2020 2020 2020 2020 636f 726f 732e 6170          coros.ap
+0003d2c0: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+0003d2d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0003d2e0: 6c66 2e5f 7472 6163 6b5f 7265 7469 7265  lf._track_retire
+0003d2f0: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
+0003d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d310: 2020 2020 2077 732c 0a20 2020 2020 2020       ws,.       
+0003d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d330: 2020 2020 2070 6f6c 6963 792c 0a20 2020       policy,.   
+0003d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d350: 2020 2020 2020 2020 2070 7265 765f 7374           prev_st
+0003d360: 6174 7573 3d70 7265 765f 7374 6174 7573  atus=prev_status
+0003d370: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003d380: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+0003d390: 6f73 653d 636c 6f73 655f 776f 726b 6572  ose=close_worker
+0003d3a0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0003d3b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003d3c0: 656d 6f76 653d 7265 6d6f 7665 2c0a 2020  emove=remove,.  
+0003d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d3e0: 2020 2020 2020 2020 2020 7374 696d 756c            stimul
+0003d3f0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
+0003d400: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0003d410: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d430: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0003d440: 2020 2020 2320 4769 7665 2074 6865 2041      # Give the A
+0003d450: 4d4d 2061 206b 6963 6b2c 2069 6e20 6164  MM a kick, in ad
+0003d460: 6469 7469 6f6e 2074 6f20 6974 7320 7065  dition to its pe
+0003d470: 7269 6f64 6963 2072 756e 6e69 6e67 2e20  riodic running. 
+0003d480: 5468 6973 2069 730a 2020 2020 2020 2020  This is.        
+0003d490: 2020 2020 2020 2020 2320 746f 2061 766f          # to avo
+0003d4a0: 6964 2075 6e6e 6563 6573 7361 7269 6c79  id unnecessarily
+0003d4b0: 2077 6169 7469 6e67 2066 6f72 2061 2070   waiting for a p
+0003d4c0: 6f74 656e 7469 616c 6c79 2061 7262 6974  otentially arbit
+0003d4d0: 7261 7269 6c79 206c 6f6e 670a 2020 2020  rarily long.    
+0003d4e0: 2020 2020 2020 2020 2020 2020 2320 7469              # ti
+0003d4f0: 6d65 2028 6465 7065 6e64 696e 6720 6f6e  me (depending on
+0003d500: 2069 6e74 6572 7661 6c20 7365 7474 696e   interval settin
+0003d510: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+0003d520: 2020 2020 616d 6d2e 7275 6e5f 6f6e 6365      amm.run_once
+0003d530: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
+0003d540: 2020 2020 776f 726b 6572 735f 696e 666f      workers_info
+0003d550: 203d 2064 6963 7428 6177 6169 7420 6173   = dict(await as
+0003d560: 796e 6369 6f2e 6761 7468 6572 282a 636f  yncio.gather(*co
+0003d570: 726f 7329 290a 2020 2020 2020 2020 2020  ros)).          
+0003d580: 2020 2020 2020 776f 726b 6572 735f 696e        workers_in
+0003d590: 666f 2e70 6f70 284e 6f6e 652c 204e 6f6e  fo.pop(None, Non
+0003d5a0: 6529 0a20 2020 2020 2020 2020 2020 2066  e).            f
+0003d5b0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+0003d5c0: 2020 2020 2020 2020 6966 2073 746f 705f          if stop_
+0003d5d0: 616d 6d3a 0a20 2020 2020 2020 2020 2020  amm:.           
+0003d5e0: 2020 2020 2020 2020 2061 6d6d 2e73 746f           amm.sto
+0003d5f0: 7028 290a 0a20 2020 2020 2020 2073 656c  p()..        sel
+0003d600: 662e 6c6f 675f 6576 656e 7428 2261 6c6c  f.log_event("all
+0003d610: 222c 207b 2261 6374 696f 6e22 3a20 2272  ", {"action": "r
+0003d620: 6574 6972 652d 776f 726b 6572 7322 2c20  etire-workers", 
+0003d630: 2277 6f72 6b65 7273 223a 2077 6f72 6b65  "workers": worke
+0003d640: 7273 5f69 6e66 6f7d 290a 2020 2020 2020  rs_info}).      
+0003d650: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+0003d660: 286c 6973 7428 776f 726b 6572 735f 696e  (list(workers_in
+0003d670: 666f 292c 207b 2261 6374 696f 6e22 3a20  fo), {"action": 
+0003d680: 2272 6574 6972 6564 227d 290a 0a20 2020  "retired"})..   
+0003d690: 2020 2020 2072 6574 7572 6e20 776f 726b       return work
+0003d6a0: 6572 735f 696e 666f 0a0a 2020 2020 6173  ers_info..    as
+0003d6b0: 796e 6320 6465 6620 5f74 7261 636b 5f72  ync def _track_r
+0003d6c0: 6574 6972 655f 776f 726b 6572 280a 2020  etire_worker(.  
+0003d6d0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0003d6e0: 2020 2020 7773 3a20 576f 726b 6572 5374      ws: WorkerSt
+0003d6f0: 6174 652c 0a20 2020 2020 2020 2070 6f6c  ate,.        pol
+0003d700: 6963 793a 2052 6574 6972 6557 6f72 6b65  icy: RetireWorke
+0003d710: 722c 0a20 2020 2020 2020 2070 7265 765f  r,.        prev_
+0003d720: 7374 6174 7573 3a20 5374 6174 7573 2c0a  status: Status,.
+0003d730: 2020 2020 2020 2020 636c 6f73 653a 2062          close: b
+0003d740: 6f6f 6c2c 0a20 2020 2020 2020 2072 656d  ool,.        rem
+0003d750: 6f76 653a 2062 6f6f 6c2c 0a20 2020 2020  ove: bool,.     
+0003d760: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
+0003d770: 7374 722c 0a20 2020 2029 202d 3e20 7475  str,.    ) -> tu
+0003d780: 706c 653a 2020 2320 7475 706c 655b 7374  ple:  # tuple[st
+0003d790: 7220 7c20 4e6f 6e65 2c20 6469 6374 5d0a  r | None, dict].
+0003d7a0: 2020 2020 2020 2020 7768 696c 6520 6e6f          while no
+0003d7b0: 7420 706f 6c69 6379 2e64 6f6e 6528 293a  t policy.done():
+0003d7c0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+0003d7d0: 6c65 6570 2030 2e30 3173 2077 6865 6e20  leep 0.01s when 
+0003d7e0: 7468 6572 6520 6172 6520 3420 7461 736b  there are 4 task
+0003d7f0: 7320 6f72 206c 6573 730a 2020 2020 2020  s or less.      
+0003d800: 2020 2020 2020 2320 536c 6565 7020 302e        # Sleep 0.
+0003d810: 3573 2077 6865 6e20 7468 6572 6520 6172  5s when there ar
+0003d820: 6520 3230 3020 6f72 206d 6f72 650a 2020  e 200 or more.  
+0003d830: 2020 2020 2020 2020 2020 706f 6c6c 5f69            poll_i
+0003d840: 6e74 6572 7661 6c20 3d20 6d61 7828 302e  nterval = max(0.
+0003d850: 3031 2c20 6d69 6e28 302e 352c 206c 656e  01, min(0.5, len
+0003d860: 2877 732e 6861 735f 7768 6174 2920 2f20  (ws.has_what) / 
+0003d870: 3430 3029 290a 2020 2020 2020 2020 2020  400)).          
+0003d880: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+0003d890: 736c 6565 7028 706f 6c6c 5f69 6e74 6572  sleep(poll_inter
+0003d8a0: 7661 6c29 0a0a 2020 2020 2020 2020 6966  val)..        if
+0003d8b0: 2070 6f6c 6963 792e 6e6f 5f72 6563 6970   policy.no_recip
+0003d8c0: 6965 6e74 733a 0a20 2020 2020 2020 2020  ients:.         
+0003d8d0: 2020 2023 2041 626f 7274 2072 6574 6972     # Abort retir
+0003d8e0: 656d 656e 742e 2054 6869 7320 7469 6d65  ement. This time
+0003d8f0: 2077 6520 646f 6e27 7420 6e65 6564 2074   we don't need t
+0003d900: 6f20 776f 7272 7920 6162 6f75 7420 7261  o worry about ra
+0003d910: 6365 0a20 2020 2020 2020 2020 2020 2023  ce.            #
+0003d920: 2063 6f6e 6469 7469 6f6e 7320 616e 6420   conditions and 
+0003d930: 7765 2063 616e 2077 6169 7420 666f 7220  we can wait for 
+0003d940: 6120 7363 6865 6475 6c65 722d 3e77 6f72  a scheduler->wor
+0003d950: 6b65 722d 3e73 6368 6564 756c 6572 0a20  ker->scheduler. 
+0003d960: 2020 2020 2020 2020 2020 2023 2072 6f75             # rou
+0003d970: 6e64 2d74 7269 702e 0a20 2020 2020 2020  nd-trip..       
+0003d980: 2020 2020 2073 656c 662e 7374 7265 616d       self.stream
+0003d990: 5f63 6f6d 6d73 5b77 732e 6164 6472 6573  _comms[ws.addres
+0003d9a0: 735d 2e73 656e 6428 0a20 2020 2020 2020  s].send(.       
+0003d9b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0003d9c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003d9d0: 6f70 223a 2022 776f 726b 6572 2d73 7461  op": "worker-sta
+0003d9e0: 7475 732d 6368 616e 6765 222c 0a20 2020  tus-change",.   
+0003d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003da00: 2022 7374 6174 7573 223a 2070 7265 765f   "status": prev_
+0003da10: 7374 6174 7573 2e6e 616d 652c 0a20 2020  status.name,.   
+0003da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003da30: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+0003da40: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+0003da50: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0003da60: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003da70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003da80: 4e6f 6e65 2c20 7b7d 0a0a 2020 2020 2020  None, {}..      
+0003da90: 2020 6c6f 6767 6572 2e64 6562 7567 280a    logger.debug(.
+0003daa0: 2020 2020 2020 2020 2020 2020 2241 6c6c              "All
+0003dab0: 2075 6e69 7175 6520 6b65 7973 206f 6e20   unique keys on 
+0003dac0: 776f 726b 6572 2025 7320 6861 7665 2062  worker %s have b
+0003dad0: 6565 6e20 7265 706c 6963 6174 6564 2065  een replicated e
+0003dae0: 6c73 6577 6865 7265 222c 2077 732e 6164  lsewhere", ws.ad
+0003daf0: 6472 6573 730a 2020 2020 2020 2020 290a  dress.        ).
+0003db00: 0a20 2020 2020 2020 2069 6620 7265 6d6f  .        if remo
+0003db10: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
+0003db20: 6177 6169 7420 7365 6c66 2e72 656d 6f76  await self.remov
+0003db30: 655f 776f 726b 6572 280a 2020 2020 2020  e_worker(.      
+0003db40: 2020 2020 2020 2020 2020 7773 2e61 6464            ws.add
+0003db50: 7265 7373 2c20 7361 6665 3d54 7275 652c  ress, safe=True,
+0003db60: 2063 6c6f 7365 3d63 6c6f 7365 2c20 7374   close=close, st
+0003db70: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+0003db80: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
+0003db90: 2020 290a 2020 2020 2020 2020 656c 6966    ).        elif
+0003dba0: 2063 6c6f 7365 3a0a 2020 2020 2020 2020   close:.        
+0003dbb0: 2020 2020 7365 6c66 2e63 6c6f 7365 5f77      self.close_w
+0003dbc0: 6f72 6b65 7228 7773 2e61 6464 7265 7373  orker(ws.address
+0003dbd0: 290a 0a20 2020 2020 2020 206c 6f67 6765  )..        logge
+0003dbe0: 722e 696e 666f 2822 5265 7469 7265 6420  r.info("Retired 
+0003dbf0: 776f 726b 6572 2025 7322 2c20 7773 2e61  worker %s", ws.a
+0003dc00: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+0003dc10: 7265 7475 726e 2077 732e 6164 6472 6573  return ws.addres
+0003dc20: 732c 2077 732e 6964 656e 7469 7479 2829  s, ws.identity()
+0003dc30: 0a0a 2020 2020 6465 6620 6164 645f 6b65  ..    def add_ke
+0003dc40: 7973 280a 2020 2020 2020 2020 7365 6c66  ys(.        self
+0003dc50: 2c20 776f 726b 6572 3a20 7374 722c 206b  , worker: str, k
+0003dc60: 6579 733a 2043 6f6c 6c65 6374 696f 6e5b  eys: Collection[
+0003dc70: 7374 725d 203d 2028 292c 2073 7469 6d75  str] = (), stimu
+0003dc80: 6c75 735f 6964 3a20 7374 7220 7c20 4e6f  lus_id: str | No
+0003dc90: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
+0003dca0: 2d3e 204c 6974 6572 616c 5b22 4f4b 222c  -> Literal["OK",
+0003dcb0: 2022 6e6f 7420 666f 756e 6422 5d3a 0a20   "not found"]:. 
+0003dcc0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003dcd0: 2020 204c 6561 726e 2074 6861 7420 6120     Learn that a 
+0003dce0: 776f 726b 6572 2068 6173 2063 6572 7461  worker has certa
+0003dcf0: 696e 206b 6579 730a 0a20 2020 2020 2020  in keys..       
+0003dd00: 2054 6869 7320 7368 6f75 6c64 206e 6f74   This should not
+0003dd10: 2062 6520 7573 6564 2069 6e20 7072 6163   be used in prac
+0003dd20: 7469 6365 2061 6e64 2069 7320 6d6f 7374  tice and is most
+0003dd30: 6c79 2068 6572 6520 666f 7220 6c65 6761  ly here for lega
+0003dd40: 6379 0a20 2020 2020 2020 2072 6561 736f  cy.        reaso
+0003dd50: 6e73 2e20 2048 6f77 6576 6572 2c20 6974  ns.  However, it
+0003dd60: 2069 7320 7365 6e74 2062 7920 776f 726b   is sent by work
+0003dd70: 6572 7320 6672 6f6d 2074 696d 6520 746f  ers from time to
+0003dd80: 2074 696d 652e 0a20 2020 2020 2020 2022   time..        "
+0003dd90: 2222 0a20 2020 2020 2020 2069 6620 776f  "".        if wo
+0003dda0: 726b 6572 206e 6f74 2069 6e20 7365 6c66  rker not in self
+0003ddb0: 2e77 6f72 6b65 7273 3a0a 2020 2020 2020  .workers:.      
+0003ddc0: 2020 2020 2020 7265 7475 726e 2022 6e6f        return "no
+0003ddd0: 7420 666f 756e 6422 0a20 2020 2020 2020  t found".       
+0003dde0: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
+0003ddf0: 203d 2073 656c 662e 776f 726b 6572 735b   = self.workers[
+0003de00: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
+0003de10: 7265 6475 6e64 616e 745f 7265 706c 6963  redundant_replic
+0003de20: 6173 203d 205b 5d0a 2020 2020 2020 2020  as = [].        
+0003de30: 666f 7220 6b65 7920 696e 206b 6579 733a  for key in keys:
+0003de40: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
+0003de50: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
+0003de60: 286b 6579 290a 2020 2020 2020 2020 2020  (key).          
+0003de70: 2020 6966 2074 7320 6973 206e 6f74 204e    if ts is not N
+0003de80: 6f6e 6520 616e 6420 7473 2e73 7461 7465  one and ts.state
+0003de90: 203d 3d20 226d 656d 6f72 7922 3a0a 2020   == "memory":.  
+0003dea0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003deb0: 2077 7320 6e6f 7420 696e 2074 732e 7768   ws not in ts.wh
+0003dec0: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+0003ded0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003dee0: 6164 645f 7265 706c 6963 6128 7473 2c20  add_replica(ts, 
+0003def0: 7773 290a 2020 2020 2020 2020 2020 2020  ws).            
+0003df00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003df10: 2020 2020 2020 7265 6475 6e64 616e 745f        redundant_
+0003df20: 7265 706c 6963 6173 2e61 7070 656e 6428  replicas.append(
+0003df30: 6b65 7929 0a0a 2020 2020 2020 2020 6966  key)..        if
+0003df40: 2072 6564 756e 6461 6e74 5f72 6570 6c69   redundant_repli
+0003df50: 6361 733a 0a20 2020 2020 2020 2020 2020  cas:.           
+0003df60: 2069 6620 6e6f 7420 7374 696d 756c 7573   if not stimulus
+0003df70: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
+0003df80: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+0003df90: 203d 2066 2272 6564 756e 6461 6e74 2d72   = f"redundant-r
+0003dfa0: 6570 6c69 6361 732d 7b74 696d 6528 297d  eplicas-{time()}
+0003dfb0: 220a 2020 2020 2020 2020 2020 2020 7365  ".            se
+0003dfc0: 6c66 2e77 6f72 6b65 725f 7365 6e64 280a  lf.worker_send(.
+0003dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dfe0: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
+0003dff0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003e000: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+0003e010: 7022 3a20 2272 656d 6f76 652d 7265 706c  p": "remove-repl
+0003e020: 6963 6173 222c 0a20 2020 2020 2020 2020  icas",.         
+0003e030: 2020 2020 2020 2020 2020 2022 6b65 7973             "keys
+0003e040: 223a 2072 6564 756e 6461 6e74 5f72 6570  ": redundant_rep
+0003e050: 6c69 6361 732c 0a20 2020 2020 2020 2020  licas,.         
+0003e060: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
+0003e070: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
+0003e080: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
+0003e090: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0003e0a0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0003e0b0: 2072 6574 7572 6e20 224f 4b22 0a0a 2020   return "OK"..  
+0003e0c0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+0003e0d0: 2020 6465 6620 7570 6461 7465 5f64 6174    def update_dat
+0003e0e0: 6128 0a20 2020 2020 2020 2073 656c 662c  a(.        self,
+0003e0f0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+0003e100: 2020 2020 7768 6f5f 6861 733a 2064 6963      who_has: dic
+0003e110: 745b 7374 722c 206c 6973 745b 7374 725d  t[str, list[str]
+0003e120: 5d2c 0a20 2020 2020 2020 206e 6279 7465  ],.        nbyte
+0003e130: 733a 2064 6963 745b 7374 722c 2069 6e74  s: dict[str, int
+0003e140: 5d2c 0a20 2020 2020 2020 2063 6c69 656e  ],.        clien
+0003e150: 743a 2073 7472 207c 204e 6f6e 6520 3d20  t: str | None = 
+0003e160: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 204e  None,.    ) -> N
+0003e170: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0003e180: 4c65 6172 6e20 7468 6174 206e 6577 2064  Learn that new d
+0003e190: 6174 6120 6861 7320 656e 7465 7265 6420  ata has entered 
+0003e1a0: 7468 6520 6e65 7477 6f72 6b20 6672 6f6d  the network from
+0003e1b0: 2061 6e20 6578 7465 726e 616c 2073 6f75   an external sou
+0003e1c0: 7263 6522 2222 0a20 2020 2020 2020 2077  rce""".        w
+0003e1d0: 686f 5f68 6173 203d 207b 6b3a 205b 7365  ho_has = {k: [se
+0003e1e0: 6c66 2e63 6f65 7263 655f 6164 6472 6573  lf.coerce_addres
+0003e1f0: 7328 7676 2920 666f 7220 7676 2069 6e20  s(vv) for vv in 
+0003e200: 765d 2066 6f72 206b 2c20 7620 696e 2077  v] for k, v in w
+0003e210: 686f 5f68 6173 2e69 7465 6d73 2829 7d0a  ho_has.items()}.
+0003e220: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0003e230: 6562 7567 2822 5570 6461 7465 2064 6174  ebug("Update dat
+0003e240: 6120 2573 222c 2077 686f 5f68 6173 290a  a %s", who_has).
+0003e250: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+0003e260: 2c20 776f 726b 6572 7320 696e 2077 686f  , workers in who
+0003e270: 5f68 6173 2e69 7465 6d73 2829 3a0a 2020  _has.items():.  
+0003e280: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+0003e290: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+0003e2a0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
+0003e2b0: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
+0003e2c0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0003e2d0: 203d 2073 656c 662e 6e65 775f 7461 736b   = self.new_task
+0003e2e0: 286b 6579 2c20 4e6f 6e65 2c20 226d 656d  (key, None, "mem
+0003e2f0: 6f72 7922 290a 2020 2020 2020 2020 2020  ory").          
+0003e300: 2020 7473 2e73 7461 7465 203d 2022 6d65    ts.state = "me
+0003e310: 6d6f 7279 220a 2020 2020 2020 2020 2020  mory".          
+0003e320: 2020 7473 5f6e 6279 7465 7320 3d20 6e62    ts_nbytes = nb
+0003e330: 7974 6573 2e67 6574 286b 6579 2c20 2d31  ytes.get(key, -1
+0003e340: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0003e350: 2074 735f 6e62 7974 6573 203e 3d20 303a   ts_nbytes >= 0:
+0003e360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e370: 2074 732e 7365 745f 6e62 7974 6573 2874   ts.set_nbytes(t
+0003e380: 735f 6e62 7974 6573 290a 0a20 2020 2020  s_nbytes)..     
+0003e390: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+0003e3a0: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+0003e3b0: 2020 2020 2020 2020 2077 7320 3d20 7365           ws = se
+0003e3c0: 6c66 2e77 6f72 6b65 7273 5b77 5d0a 2020  lf.workers[w].  
+0003e3d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003e3e0: 2077 7320 6e6f 7420 696e 2074 732e 7768   ws not in ts.wh
+0003e3f0: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+0003e400: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003e410: 6164 645f 7265 706c 6963 6128 7473 2c20  add_replica(ts, 
+0003e420: 7773 290a 2020 2020 2020 2020 2020 2020  ws).            
+0003e430: 7365 6c66 2e72 6570 6f72 7428 7b22 6f70  self.report({"op
+0003e440: 223a 2022 6b65 792d 696e 2d6d 656d 6f72  ": "key-in-memor
+0003e450: 7922 2c20 226b 6579 223a 206b 6579 2c20  y", "key": key, 
+0003e460: 2277 6f72 6b65 7273 223a 206c 6973 7428  "workers": list(
+0003e470: 776f 726b 6572 7329 7d29 0a0a 2020 2020  workers)})..    
+0003e480: 2020 2020 6966 2063 6c69 656e 743a 0a20      if client:. 
+0003e490: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003e4a0: 636c 6965 6e74 5f64 6573 6972 6573 5f6b  client_desires_k
+0003e4b0: 6579 7328 6b65 7973 3d6c 6973 7428 7768  eys(keys=list(wh
+0003e4c0: 6f5f 6861 7329 2c20 636c 6965 6e74 3d63  o_has), client=c
+0003e4d0: 6c69 656e 7429 0a0a 2020 2020 406f 7665  lient)..    @ove
+0003e4e0: 726c 6f61 640a 2020 2020 6465 6620 7265  rload.    def re
+0003e4f0: 706f 7274 5f6f 6e5f 6b65 7928 7365 6c66  port_on_key(self
+0003e500: 2c20 6b65 793a 2073 7472 2c20 2a2c 2063  , key: str, *, c
+0003e510: 6c69 656e 743a 2073 7472 207c 204e 6f6e  lient: str | Non
+0003e520: 6520 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  e = None) -> Non
+0003e530: 653a 0a20 2020 2020 2020 202e 2e2e 0a0a  e:.        .....
+0003e540: 2020 2020 406f 7665 726c 6f61 640a 2020      @overload.  
+0003e550: 2020 6465 6620 7265 706f 7274 5f6f 6e5f    def report_on_
+0003e560: 6b65 7928 7365 6c66 2c20 2a2c 2074 733a  key(self, *, ts:
+0003e570: 2054 6173 6b53 7461 7465 2c20 636c 6965   TaskState, clie
+0003e580: 6e74 3a20 7374 7220 7c20 4e6f 6e65 203d  nt: str | None =
+0003e590: 204e 6f6e 6529 202d 3e20 4e6f 6e65 3a0a   None) -> None:.
+0003e5a0: 2020 2020 2020 2020 2e2e 2e0a 0a20 2020          .....   
+0003e5b0: 2064 6566 2072 6570 6f72 745f 6f6e 5f6b   def report_on_k
+0003e5c0: 6579 2873 656c 662c 206b 6579 3d4e 6f6e  ey(self, key=Non
+0003e5d0: 652c 202a 2c20 7473 3d4e 6f6e 652c 2063  e, *, ts=None, c
+0003e5e0: 6c69 656e 743d 4e6f 6e65 293a 0a20 2020  lient=None):.   
+0003e5f0: 2020 2020 2069 6620 2874 7320 6973 204e       if (ts is N
+0003e600: 6f6e 6529 203d 3d20 286b 6579 2069 7320  one) == (key is 
+0003e610: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
+0003e620: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0003e630: 726f 7228 2020 2320 7072 6167 6d61 3a20  ror(  # pragma: 
+0003e640: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
+0003e650: 2020 2020 2020 2020 6622 7473 2061 6e64          f"ts and
+0003e660: 206b 6579 2061 7265 206d 7574 7561 6c6c   key are mutuall
+0003e670: 7920 6578 636c 7573 6976 653b 2072 6563  y exclusive; rec
+0003e680: 6569 7665 6420 7b6b 6579 3d21 727d 2c20  eived {key=!r}, 
+0003e690: 7b74 733d 2172 7d22 0a20 2020 2020 2020  {ts=!r}".       
+0003e6a0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+0003e6b0: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
+0003e6c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0003e6d0: 206b 6579 2069 7320 6e6f 7420 4e6f 6e65   key is not None
+0003e6e0: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
+0003e6f0: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
+0003e700: 286b 6579 290a 2020 2020 2020 2020 656c  (key).        el
+0003e710: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003e720: 6b65 7920 3d20 7473 2e6b 6579 0a0a 2020  key = ts.key..  
+0003e730: 2020 2020 2020 6966 2074 7320 6973 206e        if ts is n
+0003e740: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0003e750: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
+0003e760: 3d20 5f74 6173 6b5f 746f 5f72 6570 6f72  = _task_to_repor
+0003e770: 745f 6d73 6728 7473 290a 2020 2020 2020  t_msg(ts).      
+0003e780: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0003e790: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
+0003e7a0: 207b 226f 7022 3a20 2263 616e 6365 6c6c   {"op": "cancell
+0003e7b0: 6564 2d6b 6579 7322 2c20 226b 6579 7322  ed-keys", "keys"
+0003e7c0: 3a20 5b6b 6579 5d7d 0a20 2020 2020 2020  : [key]}.       
+0003e7d0: 2069 6620 7265 706f 7274 5f6d 7367 2069   if report_msg i
+0003e7e0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0003e7f0: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+0003e800: 6f72 7428 7265 706f 7274 5f6d 7367 2c20  ort(report_msg, 
+0003e810: 7473 3d74 732c 2063 6c69 656e 743d 636c  ts=ts, client=cl
+0003e820: 6965 6e74 290a 0a20 2020 2040 6c6f 675f  ient)..    @log_
+0003e830: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
+0003e840: 2064 6566 2066 6565 6428 0a20 2020 2020   def feed(.     
+0003e850: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0003e860: 2063 6f6d 6d3a 2043 6f6d 6d2c 0a20 2020   comm: Comm,.   
+0003e870: 2020 2020 2066 756e 6374 696f 6e3a 2062       function: b
+0003e880: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
+0003e890: 6e65 2c0a 2020 2020 2020 2020 7365 7475  ne,.        setu
+0003e8a0: 703a 2062 7974 6573 207c 204e 6f6e 6520  p: bytes | None 
+0003e8b0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0003e8c0: 7465 6172 646f 776e 3a20 6279 7465 7320  teardown: bytes 
+0003e8d0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003e8e0: 2020 2020 2020 2069 6e74 6572 7661 6c3a         interval:
+0003e8f0: 2073 7472 207c 2066 6c6f 6174 203d 2022   str | float = "
+0003e900: 3173 222c 0a20 2020 2020 2020 202a 2a6b  1s",.        **k
+0003e910: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
+0003e920: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0003e930: 2020 2022 2222 0a20 2020 2020 2020 2050     """.        P
+0003e940: 726f 7669 6465 7320 6120 6461 7461 2043  rovides a data C
+0003e950: 6f6d 6d20 746f 2065 7874 6572 6e61 6c20  omm to external 
+0003e960: 7265 7175 6573 7465 720a 0a20 2020 2020  requester..     
+0003e970: 2020 2043 6175 7469 6f6e 3a20 7468 6973     Caution: this
+0003e980: 2072 756e 7320 6172 6269 7472 6172 7920   runs arbitrary 
+0003e990: 5079 7468 6f6e 2063 6f64 6520 6f6e 2074  Python code on t
+0003e9a0: 6865 2073 6368 6564 756c 6572 2e20 2054  he scheduler.  T
+0003e9b0: 6869 7320 7368 6f75 6c64 0a20 2020 2020  his should.     
+0003e9c0: 2020 2065 7665 6e74 7561 6c6c 7920 6265     eventually be
+0003e9d0: 2070 6861 7365 6420 6f75 742e 2020 4974   phased out.  It
+0003e9e0: 2069 7320 6d6f 7374 6c79 2075 7365 6420   is mostly used 
+0003e9f0: 6279 2064 6961 676e 6f73 7469 6373 2e0a  by diagnostics..
+0003ea00: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0003ea10: 2020 2020 6966 206e 6f74 2064 6173 6b2e      if not dask.
+0003ea20: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0003ea30: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0003ea40: 722e 7069 636b 6c65 2229 3a0a 2020 2020  r.pickle"):.    
+0003ea50: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
+0003ea60: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
+0003ea70: 2020 2020 2020 2020 2254 7269 6564 2074          "Tried t
+0003ea80: 6f20 6361 6c6c 2027 6665 6564 2720 726f  o call 'feed' ro
+0003ea90: 7574 6520 7769 7468 2063 7573 746f 6d20  ute with custom 
+0003eaa0: 6675 6e63 7469 6f6e 732c 2062 7574 2022  functions, but "
+0003eab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003eac0: 2022 7069 636b 6c65 2069 7320 6469 7361   "pickle is disa
+0003ead0: 6c6c 6f77 6564 2e20 2053 6574 2074 6865  llowed.  Set the
+0003eae0: 2027 6469 7374 7269 6275 7465 642e 7363   'distributed.sc
+0003eaf0: 6865 6475 6c65 722e 7069 636b 6c65 2722  heduler.pickle'"
+0003eb00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003eb10: 2022 636f 6e66 6967 2076 616c 7565 2074   "config value t
+0003eb20: 6f20 5472 7565 2074 6f20 7573 6520 7468  o True to use th
+0003eb30: 6520 2766 6565 6427 2072 6f75 7465 2028  e 'feed' route (
+0003eb40: 7468 6973 2069 7320 6d6f 7374 6c79 2022  this is mostly "
+0003eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003eb60: 2022 636f 6d6d 6f6e 6c79 2075 7365 6420   "commonly used 
+0003eb70: 7769 7468 2070 726f 6772 6573 7320 6261  with progress ba
+0003eb80: 7273 2922 0a20 2020 2020 2020 2020 2020  rs)".           
+0003eb90: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
+0003eba0: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
+0003ebb0: 6e74 6572 7661 6c20 3d20 7061 7273 655f  nterval = parse_
+0003ebc0: 7469 6d65 6465 6c74 6128 696e 7465 7276  timedelta(interv
+0003ebd0: 616c 290a 2020 2020 2020 2020 6966 2066  al).        if f
+0003ebe0: 756e 6374 696f 6e3a 0a20 2020 2020 2020  unction:.       
+0003ebf0: 2020 2020 2066 756e 6374 696f 6e20 3d20       function = 
+0003ec00: 7069 636b 6c65 2e6c 6f61 6473 2866 756e  pickle.loads(fun
+0003ec10: 6374 696f 6e29 0a20 2020 2020 2020 2069  ction).        i
+0003ec20: 6620 7365 7475 703a 0a20 2020 2020 2020  f setup:.       
+0003ec30: 2020 2020 2073 6574 7570 203d 2070 6963       setup = pic
+0003ec40: 6b6c 652e 6c6f 6164 7328 7365 7475 7029  kle.loads(setup)
+0003ec50: 0a0a 2020 2020 2020 2020 6966 2074 6561  ..        if tea
+0003ec60: 7264 6f77 6e3a 0a20 2020 2020 2020 2020  rdown:.         
+0003ec70: 2020 2074 6561 7264 6f77 6e20 3d20 7069     teardown = pi
+0003ec80: 636b 6c65 2e6c 6f61 6473 2874 6561 7264  ckle.loads(teard
+0003ec90: 6f77 6e29 0a20 2020 2020 2020 2073 7461  own).        sta
+0003eca0: 7465 203d 2073 6574 7570 2873 656c 6629  te = setup(self)
+0003ecb0: 2069 6620 7365 7475 7020 656c 7365 204e   if setup else N
+0003ecc0: 6f6e 6520 2023 2074 7970 653a 2069 676e  one  # type: ign
+0003ecd0: 6f72 650a 2020 2020 2020 2020 6966 2069  ore.        if i
+0003ece0: 6e73 7065 6374 2e69 7361 7761 6974 6162  nspect.isawaitab
+0003ecf0: 6c65 2873 7461 7465 293a 0a20 2020 2020  le(state):.     
+0003ed00: 2020 2020 2020 2073 7461 7465 203d 2061         state = a
+0003ed10: 7761 6974 2073 7461 7465 0a20 2020 2020  wait state.     
+0003ed20: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0003ed30: 2020 2020 7768 696c 6520 7365 6c66 2e73      while self.s
+0003ed40: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+0003ed50: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+0003ed60: 2020 2020 2020 2020 2069 6620 7374 6174           if stat
+0003ed70: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+0003ed80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003ed90: 6573 706f 6e73 6520 3d20 6675 6e63 7469  esponse = functi
+0003eda0: 6f6e 2873 656c 6629 2020 2320 7479 7065  on(self)  # type
+0003edb0: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+0003edc0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0003edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ede0: 2020 2072 6573 706f 6e73 6520 3d20 6675     response = fu
+0003edf0: 6e63 7469 6f6e 2873 656c 662c 2073 7461  nction(self, sta
+0003ee00: 7465 2920 2023 2074 7970 653a 2069 676e  te)  # type: ign
+0003ee10: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
+0003ee20: 2020 2020 6177 6169 7420 636f 6d6d 2e77      await comm.w
+0003ee30: 7269 7465 2872 6573 706f 6e73 6529 0a20  rite(response). 
+0003ee40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0003ee50: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
+0003ee60: 6570 2869 6e74 6572 7661 6c29 0a20 2020  ep(interval).   
+0003ee70: 2020 2020 2065 7863 6570 7420 4f53 4572       except OSEr
+0003ee80: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0003ee90: 2070 6173 730a 2020 2020 2020 2020 6669   pass.        fi
+0003eea0: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
+0003eeb0: 2020 2069 6620 7465 6172 646f 776e 3a0a     if teardown:.
+0003eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003eed0: 7465 6172 646f 776e 2873 656c 662c 2073  teardown(self, s
+0003eee0: 7461 7465 2920 2023 2074 7970 653a 2069  tate)  # type: i
+0003eef0: 676e 6f72 650a 0a20 2020 2064 6566 206c  gnore..    def l
+0003ef00: 6f67 5f77 6f72 6b65 725f 6576 656e 7428  og_worker_event(
+0003ef10: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
+0003ef20: 6f72 6b65 723a 2073 7472 2c20 746f 7069  orker: str, topi
+0003ef30: 633a 2073 7472 207c 2043 6f6c 6c65 6374  c: str | Collect
+0003ef40: 696f 6e5b 7374 725d 2c20 6d73 673a 2041  ion[str], msg: A
+0003ef50: 6e79 0a20 2020 2029 202d 3e20 4e6f 6e65  ny.    ) -> None
+0003ef60: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+0003ef70: 6e73 7461 6e63 6528 6d73 672c 2064 6963  nstance(msg, dic
+0003ef80: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+0003ef90: 6d73 675b 2277 6f72 6b65 7222 5d20 3d20  msg["worker"] = 
+0003efa0: 776f 726b 6572 0a20 2020 2020 2020 2073  worker.        s
+0003efb0: 656c 662e 6c6f 675f 6576 656e 7428 746f  elf.log_event(to
+0003efc0: 7069 632c 206d 7367 290a 0a20 2020 2064  pic, msg)..    d
+0003efd0: 6566 2073 7562 7363 7269 6265 5f77 6f72  ef subscribe_wor
+0003efe0: 6b65 725f 7374 6174 7573 2873 656c 662c  ker_status(self,
+0003eff0: 2063 6f6d 6d3a 2043 6f6d 6d29 202d 3e20   comm: Comm) -> 
+0003f000: 7374 723a 0a20 2020 2020 2020 2057 6f72  str:.        Wor
+0003f010: 6b65 7253 7461 7475 7350 6c75 6769 6e28  kerStatusPlugin(
+0003f020: 7365 6c66 2c20 636f 6d6d 290a 2020 2020  self, comm).    
+0003f030: 2020 2020 6964 656e 7420 3d20 7365 6c66      ident = self
+0003f040: 2e69 6465 6e74 6974 7928 290a 2020 2020  .identity().    
+0003f050: 2020 2020 666f 7220 7620 696e 2069 6465      for v in ide
+0003f060: 6e74 5b22 776f 726b 6572 7322 5d2e 7661  nt["workers"].va
+0003f070: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+0003f080: 2020 2020 6465 6c20 765b 226d 6574 7269      del v["metri
+0003f090: 6373 225d 0a20 2020 2020 2020 2020 2020  cs"].           
+0003f0a0: 2064 656c 2076 5b22 6c61 7374 5f73 6565   del v["last_see
+0003f0b0: 6e22 5d0a 2020 2020 2020 2020 7265 7475  n"].        retu
+0003f0c0: 726e 2069 6465 6e74 0a0a 2020 2020 6465  rn ident..    de
+0003f0d0: 6620 6765 745f 7072 6f63 6573 7369 6e67  f get_processing
+0003f0e0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0003f0f0: 776f 726b 6572 733a 2049 7465 7261 626c  workers: Iterabl
+0003f100: 655b 7374 725d 207c 204e 6f6e 6520 3d20  e[str] | None = 
+0003f110: 4e6f 6e65 0a20 2020 2029 202d 3e20 6469  None.    ) -> di
+0003f120: 6374 5b73 7472 2c20 6c69 7374 5b73 7472  ct[str, list[str
+0003f130: 5d5d 3a0a 2020 2020 2020 2020 6966 2077  ]]:.        if w
+0003f140: 6f72 6b65 7273 2069 7320 6e6f 7420 4e6f  orkers is not No
+0003f150: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003f160: 776f 726b 6572 7320 3d20 7365 7428 6d61  workers = set(ma
+0003f170: 7028 7365 6c66 2e63 6f65 7263 655f 6164  p(self.coerce_ad
+0003f180: 6472 6573 732c 2077 6f72 6b65 7273 2929  dress, workers))
+0003f190: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003f1a0: 7572 6e20 7b77 3a20 5b74 732e 6b65 7920  urn {w: [ts.key 
+0003f1b0: 666f 7220 7473 2069 6e20 7365 6c66 2e77  for ts in self.w
+0003f1c0: 6f72 6b65 7273 5b77 5d2e 7072 6f63 6573  orkers[w].proces
+0003f1d0: 7369 6e67 5d20 666f 7220 7720 696e 2077  sing] for w in w
+0003f1e0: 6f72 6b65 7273 7d0a 2020 2020 2020 2020  orkers}.        
+0003f1f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003f200: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
+0003f210: 2020 2020 2020 2020 2020 2077 3a20 5b74             w: [t
+0003f220: 732e 6b65 7920 666f 7220 7473 2069 6e20  s.key for ts in 
+0003f230: 7773 2e70 726f 6365 7373 696e 675d 2066  ws.processing] f
+0003f240: 6f72 2077 2c20 7773 2069 6e20 7365 6c66  or w, ws in self
+0003f250: 2e77 6f72 6b65 7273 2e69 7465 6d73 2829  .workers.items()
+0003f260: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+0003f270: 2020 2020 6465 6620 6765 745f 7768 6f5f      def get_who_
+0003f280: 6861 7328 7365 6c66 2c20 6b65 7973 3a20  has(self, keys: 
+0003f290: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
+0003f2a0: 4e6f 6e65 203d 204e 6f6e 6529 202d 3e20  None = None) -> 
+0003f2b0: 6469 6374 5b73 7472 2c20 6c69 7374 5b73  dict[str, list[s
+0003f2c0: 7472 5d5d 3a0a 2020 2020 2020 2020 6966  tr]]:.        if
+0003f2d0: 206b 6579 7320 6973 206e 6f74 204e 6f6e   keys is not Non
+0003f2e0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0003f2f0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+0003f300: 2020 2020 2020 2020 6b65 793a 205b 7773          key: [ws
+0003f310: 2e61 6464 7265 7373 2066 6f72 2077 7320  .address for ws 
+0003f320: 696e 2073 656c 662e 7461 736b 735b 6b65  in self.tasks[ke
+0003f330: 795d 2e77 686f 5f68 6173 5d0a 2020 2020  y].who_has].    
+0003f340: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+0003f350: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
+0003f360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f370: 2065 6c73 6520 5b5d 0a20 2020 2020 2020   else [].       
+0003f380: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+0003f390: 2069 6e20 6b65 7973 0a20 2020 2020 2020   in keys.       
+0003f3a0: 2020 2020 207d 0a20 2020 2020 2020 2065       }.        e
+0003f3b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003f3c0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
+0003f3d0: 2020 2020 2020 2020 2020 6b65 793a 205b            key: [
+0003f3e0: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
+0003f3f0: 7320 696e 2074 732e 7768 6f5f 6861 735d  s in ts.who_has]
+0003f400: 2066 6f72 206b 6579 2c20 7473 2069 6e20   for key, ts in 
+0003f410: 7365 6c66 2e74 6173 6b73 2e69 7465 6d73  self.tasks.items
+0003f420: 2829 0a20 2020 2020 2020 2020 2020 207d  ().            }
+0003f430: 0a0a 2020 2020 6465 6620 6765 745f 6861  ..    def get_ha
+0003f440: 735f 7768 6174 280a 2020 2020 2020 2020  s_what(.        
+0003f450: 7365 6c66 2c20 776f 726b 6572 733a 2049  self, workers: I
+0003f460: 7465 7261 626c 655b 7374 725d 207c 204e  terable[str] | N
+0003f470: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
+0003f480: 202d 3e20 6469 6374 5b73 7472 2c20 6c69   -> dict[str, li
+0003f490: 7374 5b73 7472 5d5d 3a0a 2020 2020 2020  st[str]]:.      
+0003f4a0: 2020 6966 2077 6f72 6b65 7273 2069 7320    if workers is 
+0003f4b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0003f4c0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+0003f4d0: 6d61 7028 7365 6c66 2e63 6f65 7263 655f  map(self.coerce_
+0003f4e0: 6164 6472 6573 732c 2077 6f72 6b65 7273  address, workers
+0003f4f0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0003f500: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
+0003f510: 2020 2020 2020 2077 3a20 5b74 732e 6b65         w: [ts.ke
+0003f520: 7920 666f 7220 7473 2069 6e20 7365 6c66  y for ts in self
+0003f530: 2e77 6f72 6b65 7273 5b77 5d2e 6861 735f  .workers[w].has_
+0003f540: 7768 6174 5d0a 2020 2020 2020 2020 2020  what].          
+0003f550: 2020 2020 2020 6966 2077 2069 6e20 7365        if w in se
+0003f560: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
+0003f570: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
+0003f580: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
+0003f590: 2020 2066 6f72 2077 2069 6e20 776f 726b     for w in work
+0003f5a0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+0003f5b0: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
+0003f5c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003f5d0: 726e 207b 773a 205b 7473 2e6b 6579 2066  rn {w: [ts.key f
+0003f5e0: 6f72 2074 7320 696e 2077 732e 6861 735f  or ts in ws.has_
+0003f5f0: 7768 6174 5d20 666f 7220 772c 2077 7320  what] for w, ws 
+0003f600: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+0003f610: 6974 656d 7328 297d 0a0a 2020 2020 6465  items()}..    de
+0003f620: 6620 6765 745f 6e63 6f72 6573 2873 656c  f get_ncores(sel
+0003f630: 662c 2077 6f72 6b65 7273 3a20 4974 6572  f, workers: Iter
+0003f640: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
+0003f650: 203d 204e 6f6e 6529 202d 3e20 6469 6374   = None) -> dict
+0003f660: 5b73 7472 2c20 696e 745d 3a0a 2020 2020  [str, int]:.    
+0003f670: 2020 2020 6966 2077 6f72 6b65 7273 2069      if workers i
+0003f680: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0003f690: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+0003f6a0: 3d20 6d61 7028 7365 6c66 2e63 6f65 7263  = map(self.coerc
+0003f6b0: 655f 6164 6472 6573 732c 2077 6f72 6b65  e_address, worke
+0003f6c0: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
+0003f6d0: 7265 7475 726e 207b 773a 2073 656c 662e  return {w: self.
+0003f6e0: 776f 726b 6572 735b 775d 2e6e 7468 7265  workers[w].nthre
+0003f6f0: 6164 7320 666f 7220 7720 696e 2077 6f72  ads for w in wor
+0003f700: 6b65 7273 2069 6620 7720 696e 2073 656c  kers if w in sel
+0003f710: 662e 776f 726b 6572 737d 0a20 2020 2020  f.workers}.     
+0003f720: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003f730: 2020 2020 2072 6574 7572 6e20 7b77 3a20       return {w: 
+0003f740: 7773 2e6e 7468 7265 6164 7320 666f 7220  ws.nthreads for 
+0003f750: 772c 2077 7320 696e 2073 656c 662e 776f  w, ws in self.wo
+0003f760: 726b 6572 732e 6974 656d 7328 297d 0a0a  rkers.items()}..
+0003f770: 2020 2020 6465 6620 6765 745f 6e63 6f72      def get_ncor
+0003f780: 6573 5f72 756e 6e69 6e67 280a 2020 2020  es_running(.    
+0003f790: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
+0003f7a0: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
+0003f7b0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 0a20   | None = None. 
+0003f7c0: 2020 2029 202d 3e20 6469 6374 5b73 7472     ) -> dict[str
+0003f7d0: 2c20 696e 745d 3a0a 2020 2020 2020 2020  , int]:.        
+0003f7e0: 6e63 6f72 6573 203d 2073 656c 662e 6765  ncores = self.ge
+0003f7f0: 745f 6e63 6f72 6573 2877 6f72 6b65 7273  t_ncores(workers
+0003f800: 3d77 6f72 6b65 7273 290a 2020 2020 2020  =workers).      
+0003f810: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
+0003f820: 2020 2020 2020 2077 3a20 6e20 666f 7220         w: n for 
+0003f830: 772c 206e 2069 6e20 6e63 6f72 6573 2e69  w, n in ncores.i
+0003f840: 7465 6d73 2829 2069 6620 7365 6c66 2e77  tems() if self.w
+0003f850: 6f72 6b65 7273 5b77 5d2e 7374 6174 7573  orkers[w].status
+0003f860: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+0003f870: 6e67 0a20 2020 2020 2020 207d 0a0a 2020  ng.        }..  
+0003f880: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
+0003f890: 6361 6c6c 5f73 7461 636b 2873 656c 662c  call_stack(self,
+0003f8a0: 206b 6579 733a 2049 7465 7261 626c 655b   keys: Iterable[
+0003f8b0: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
+0003f8c0: 6e65 2920 2d3e 2064 6963 743a 0a20 2020  ne) -> dict:.   
+0003f8d0: 2020 2020 2077 6f72 6b65 7273 3a20 6469       workers: di
+0003f8e0: 6374 5b73 7472 2c20 6c69 7374 5b73 7472  ct[str, list[str
+0003f8f0: 5d20 7c20 4e6f 6e65 5d0a 2020 2020 2020  ] | None].      
+0003f900: 2020 6966 206b 6579 7320 6973 206e 6f74    if keys is not
+0003f910: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0003f920: 2020 2073 7461 636b 203d 206c 6973 7428     stack = list(
+0003f930: 6b65 7973 290a 2020 2020 2020 2020 2020  keys).          
+0003f940: 2020 7072 6f63 6573 7369 6e67 203d 2073    processing = s
+0003f950: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
+0003f960: 2077 6869 6c65 2073 7461 636b 3a0a 2020   while stack:.  
+0003f970: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+0003f980: 7920 3d20 7374 6163 6b2e 706f 7028 290a  y = stack.pop().
+0003f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f9a0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+0003f9b0: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
+0003f9c0: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
+0003f9d0: 203d 3d20 2277 6169 7469 6e67 223a 0a20   == "waiting":. 
+0003f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f9f0: 2020 2073 7461 636b 2e65 7874 656e 6428     stack.extend(
+0003fa00: 5b64 7473 2e6b 6579 2066 6f72 2064 7473  [dts.key for dts
+0003fa10: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+0003fa20: 6965 735d 290a 2020 2020 2020 2020 2020  ies]).          
+0003fa30: 2020 2020 2020 656c 6966 2074 732e 7374        elif ts.st
+0003fa40: 6174 6520 3d3d 2022 7072 6f63 6573 7369  ate == "processi
+0003fa50: 6e67 223a 0a20 2020 2020 2020 2020 2020  ng":.           
+0003fa60: 2020 2020 2020 2020 2070 726f 6365 7373           process
+0003fa70: 696e 672e 6164 6428 7473 290a 0a20 2020  ing.add(ts)..   
+0003fa80: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+0003fa90: 203d 2064 6566 6175 6c74 6469 6374 286c   = defaultdict(l
+0003faa0: 6973 7429 0a20 2020 2020 2020 2020 2020  ist).           
+0003fab0: 2066 6f72 2074 7320 696e 2070 726f 6365   for ts in proce
+0003fac0: 7373 696e 673a 0a20 2020 2020 2020 2020  ssing:.         
+0003fad0: 2020 2020 2020 2069 6620 7473 2e70 726f         if ts.pro
+0003fae0: 6365 7373 696e 675f 6f6e 3a0a 2020 2020  cessing_on:.    
+0003faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fb00: 776b 6579 7320 3d20 776f 726b 6572 735b  wkeys = workers[
+0003fb10: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+0003fb20: 2e61 6464 7265 7373 5d0a 2020 2020 2020  .address].      
+0003fb30: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0003fb40: 7365 7274 2077 6b65 7973 2069 7320 6e6f  sert wkeys is no
+0003fb50: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
+0003fb60: 2020 2020 2020 2020 2020 2077 6b65 7973             wkeys
+0003fb70: 2e61 7070 656e 6428 7473 2e6b 6579 290a  .append(ts.key).
+0003fb80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003fb90: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0003fba0: 7320 3d20 7b77 3a20 4e6f 6e65 2066 6f72  s = {w: None for
+0003fbb0: 2077 2069 6e20 7365 6c66 2e77 6f72 6b65   w in self.worke
+0003fbc0: 7273 7d0a 0a20 2020 2020 2020 2069 6620  rs}..        if 
+0003fbd0: 6e6f 7420 776f 726b 6572 733a 0a20 2020  not workers:.   
+0003fbe0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003fbf0: 7b7d 0a0a 2020 2020 2020 2020 7265 7375  {}..        resu
+0003fc00: 6c74 7320 3d20 6177 6169 7420 6173 796e  lts = await asyn
+0003fc10: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
+0003fc20: 2020 2020 2020 2020 2a28 7365 6c66 2e72          *(self.r
+0003fc30: 7063 2877 292e 6361 6c6c 5f73 7461 636b  pc(w).call_stack
+0003fc40: 286b 6579 733d 7629 2066 6f72 2077 2c20  (keys=v) for w, 
+0003fc50: 7620 696e 2077 6f72 6b65 7273 2e69 7465  v in workers.ite
+0003fc60: 6d73 2829 290a 2020 2020 2020 2020 290a  ms()).        ).
+0003fc70: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0003fc80: 203d 207b 773a 2072 2066 6f72 2077 2c20   = {w: r for w, 
+0003fc90: 7220 696e 207a 6970 2877 6f72 6b65 7273  r in zip(workers
+0003fca0: 2c20 7265 7375 6c74 7329 2069 6620 727d  , results) if r}
+0003fcb0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003fcc0: 7265 7370 6f6e 7365 0a0a 2020 2020 6173  response..    as
+0003fcd0: 796e 6320 6465 6620 6265 6e63 686d 6172  ync def benchmar
+0003fce0: 6b5f 6861 7264 7761 7265 2873 656c 6629  k_hardware(self)
+0003fcf0: 202d 3e20 2264 6963 745b 7374 722c 2064   -> "dict[str, d
+0003fd00: 6963 745b 7374 722c 2066 6c6f 6174 5d5d  ict[str, float]]
+0003fd10: 223a 0a20 2020 2020 2020 2022 2222 0a20  ":.        """. 
+0003fd20: 2020 2020 2020 2052 756e 2061 2062 656e         Run a ben
+0003fd30: 6368 6d61 726b 206f 6e20 7468 6520 776f  chmark on the wo
+0003fd40: 726b 6572 7320 666f 7220 6d65 6d6f 7279  rkers for memory
+0003fd50: 2c20 6469 736b 2c20 616e 6420 6e65 7477  , disk, and netw
+0003fd60: 6f72 6b20 6261 6e64 7769 6474 6873 0a0a  ork bandwidths..
+0003fd70: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
+0003fd80: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
+0003fd90: 2020 2020 2020 2020 7265 7375 6c74 3a20          result: 
+0003fda0: 6469 6374 0a20 2020 2020 2020 2020 2020  dict.           
+0003fdb0: 2041 2064 6963 7469 6f6e 6172 7920 6d61   A dictionary ma
+0003fdc0: 7070 696e 6720 7468 6520 6e61 6d65 7320  pping the names 
+0003fdd0: 2264 6973 6b22 2c20 226d 656d 6f72 7922  "disk", "memory"
+0003fde0: 2c20 616e 6420 226e 6574 776f 726b 2220  , and "network" 
+0003fdf0: 746f 0a20 2020 2020 2020 2020 2020 2064  to.            d
+0003fe00: 6963 7469 6f6e 6172 6965 7320 6d61 7070  ictionaries mapp
+0003fe10: 696e 6720 7369 7a65 7320 746f 2062 616e  ing sizes to ban
+0003fe20: 6477 6964 7468 732e 2020 5468 6573 6520  dwidths.  These 
+0003fe30: 6261 6e64 7769 6474 6873 2061 7265 0a20  bandwidths are. 
+0003fe40: 2020 2020 2020 2020 2020 2061 7665 7261             avera
+0003fe50: 6765 6420 6f76 6572 206d 616e 7920 776f  ged over many wo
+0003fe60: 726b 6572 7320 7275 6e6e 696e 6720 636f  rkers running co
+0003fe70: 6d70 7574 6174 696f 6e73 2061 6372 6f73  mputations acros
+0003fe80: 7320 7468 6520 636c 7573 7465 722e 0a20  s the cluster.. 
+0003fe90: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003fea0: 2020 206f 7574 3a20 6469 6374 5b73 7472     out: dict[str
+0003feb0: 2c20 6465 6661 756c 7464 6963 745b 7374  , defaultdict[st
+0003fec0: 722c 206c 6973 745b 666c 6f61 745d 5d5d  r, list[float]]]
+0003fed0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0003fee0: 206e 616d 653a 2064 6566 6175 6c74 6469   name: defaultdi
+0003fef0: 6374 286c 6973 7429 2066 6f72 206e 616d  ct(list) for nam
+0003ff00: 6520 696e 205b 2264 6973 6b22 2c20 226d  e in ["disk", "m
+0003ff10: 656d 6f72 7922 2c20 226e 6574 776f 726b  emory", "network
+0003ff20: 225d 0a20 2020 2020 2020 207d 0a0a 2020  "].        }..  
+0003ff30: 2020 2020 2020 2320 6469 736b 0a20 2020        # disk.   
+0003ff40: 2020 2020 2072 6573 756c 7420 3d20 6177       result = aw
+0003ff50: 6169 7420 7365 6c66 2e62 726f 6164 6361  ait self.broadca
+0003ff60: 7374 286d 7367 3d7b 226f 7022 3a20 2262  st(msg={"op": "b
+0003ff70: 656e 6368 6d61 726b 5f64 6973 6b22 7d29  enchmark_disk"})
+0003ff80: 0a20 2020 2020 2020 2066 6f72 2064 2069  .        for d i
+0003ff90: 6e20 7265 7375 6c74 2e76 616c 7565 7328  n result.values(
+0003ffa0: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
+0003ffb0: 6f72 2073 697a 652c 2064 7572 6174 696f  or size, duratio
+0003ffc0: 6e20 696e 2064 2e69 7465 6d73 2829 3a0a  n in d.items():.
+0003ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ffe0: 6f75 745b 2264 6973 6b22 5d5b 7369 7a65  out["disk"][size
+0003fff0: 5d2e 6170 7065 6e64 2864 7572 6174 696f  ].append(duratio
+00040000: 6e29 0a0a 2020 2020 2020 2020 2320 6d65  n)..        # me
+00040010: 6d6f 7279 0a20 2020 2020 2020 2072 6573  mory.        res
+00040020: 756c 7420 3d20 6177 6169 7420 7365 6c66  ult = await self
+00040030: 2e62 726f 6164 6361 7374 286d 7367 3d7b  .broadcast(msg={
+00040040: 226f 7022 3a20 2262 656e 6368 6d61 726b  "op": "benchmark
+00040050: 5f6d 656d 6f72 7922 7d29 0a20 2020 2020  _memory"}).     
+00040060: 2020 2066 6f72 2064 2069 6e20 7265 7375     for d in resu
+00040070: 6c74 2e76 616c 7565 7328 293a 0a20 2020  lt.values():.   
+00040080: 2020 2020 2020 2020 2066 6f72 2073 697a           for siz
+00040090: 652c 2064 7572 6174 696f 6e20 696e 2064  e, duration in d
+000400a0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+000400b0: 2020 2020 2020 2020 2020 6f75 745b 226d            out["m
+000400c0: 656d 6f72 7922 5d5b 7369 7a65 5d2e 6170  emory"][size].ap
+000400d0: 7065 6e64 2864 7572 6174 696f 6e29 0a0a  pend(duration)..
+000400e0: 2020 2020 2020 2020 2320 6e65 7477 6f72          # networ
+000400f0: 6b0a 2020 2020 2020 2020 776f 726b 6572  k.        worker
+00040100: 7320 3d20 6c69 7374 2873 656c 662e 776f  s = list(self.wo
+00040110: 726b 6572 7329 0a20 2020 2020 2020 2023  rkers).        #
+00040120: 204f 6e20 616e 2061 6461 7074 6976 6520   On an adaptive 
+00040130: 636c 7573 7465 722c 2069 6620 6d75 6c74  cluster, if mult
+00040140: 6970 6c65 2077 6f72 6b65 7273 2061 7265  iple workers are
+00040150: 2073 7461 7274 6564 206f 6e20 7468 6520   started on the 
+00040160: 7361 6d65 2070 6879 7369 6361 6c20 686f  same physical ho
+00040170: 7374 2c0a 2020 2020 2020 2020 2320 7468  st,.        # th
+00040180: 6579 2061 7265 206d 6f72 6520 6c69 6b65  ey are more like
+00040190: 6c79 2074 6f20 636f 6e6e 6563 7420 746f  ly to connect to
+000401a0: 2074 6865 2053 6368 6564 756c 6572 2069   the Scheduler i
+000401b0: 6e20 7365 7175 656e 6365 2c20 656e 6469  n sequence, endi
+000401c0: 6e67 2075 7020 6e65 7874 2074 6f0a 2020  ng up next to.  
+000401d0: 2020 2020 2020 2320 6561 6368 206f 7468        # each oth
+000401e0: 6572 2069 6e20 7468 6973 206c 6973 742e  er in this list.
+000401f0: 0a20 2020 2020 2020 2023 2054 6865 2074  .        # The t
+00040200: 7261 6e73 6665 7220 7370 6565 6420 7769  ransfer speed wi
+00040210: 7468 696e 2073 7563 6820 636c 7573 7465  thin such cluste
+00040220: 7273 206f 6620 776f 726b 6572 7320 7769  rs of workers wi
+00040230: 6c6c 2062 6520 6566 6665 6374 6976 656c  ll be effectivel
+00040240: 7920 7468 6174 206f 660a 2020 2020 2020  y that of.      
+00040250: 2020 2320 6c6f 6361 6c68 6f73 742e 2054    # localhost. T
+00040260: 6869 7320 636f 756c 6420 6861 7070 656e  his could happen
+00040270: 2061 6372 6f73 7320 6469 6666 6572 656e   across differen
+00040280: 7420 564d 7320 616e 642f 6f72 2064 6f63  t VMs and/or doc
+00040290: 6b65 7220 696d 6167 6573 2c20 736f 0a20  ker images, so. 
+000402a0: 2020 2020 2020 2023 2069 6d70 6c65 6d65         # impleme
+000402b0: 6e74 696e 6720 6c6f 6769 6320 6261 7365  nting logic base
+000402c0: 6420 6f6e 2049 5020 6164 6472 6573 7365  d on IP addresse
+000402d0: 7320 776f 756c 6420 6e6f 7420 6e65 6365  s would not nece
+000402e0: 7373 6172 696c 7920 6865 6c70 2e0a 2020  ssarily help..  
+000402f0: 2020 2020 2020 2320 5261 6e64 6f6d 697a        # Randomiz
+00040300: 6520 7468 6520 636f 6e6e 6563 7469 6f6e  e the connection
+00040310: 7320 746f 2065 7665 6e20 6f75 7420 7468  s to even out th
+00040320: 6520 6d65 616e 206d 6561 7375 7265 732e  e mean measures.
+00040330: 0a20 2020 2020 2020 2072 616e 646f 6d2e  .        random.
+00040340: 7368 7566 666c 6528 776f 726b 6572 7329  shuffle(workers)
+00040350: 0a20 2020 2020 2020 2066 7574 7572 6573  .        futures
+00040360: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00040370: 2073 656c 662e 7270 6328 6129 2e62 656e   self.rpc(a).ben
+00040380: 6368 6d61 726b 5f6e 6574 776f 726b 2861  chmark_network(a
+00040390: 6464 7265 7373 3d62 2920 666f 7220 612c  ddress=b) for a,
+000403a0: 2062 2069 6e20 7061 7274 6974 696f 6e28   b in partition(
+000403b0: 322c 2077 6f72 6b65 7273 290a 2020 2020  2, workers).    
+000403c0: 2020 2020 5d0a 2020 2020 2020 2020 7265      ].        re
+000403d0: 7370 6f6e 7365 7320 3d20 6177 6169 7420  sponses = await 
+000403e0: 6173 796e 6369 6f2e 6761 7468 6572 282a  asyncio.gather(*
+000403f0: 6675 7475 7265 7329 0a0a 2020 2020 2020  futures)..      
+00040400: 2020 666f 7220 6420 696e 2072 6573 706f    for d in respo
+00040410: 6e73 6573 3a0a 2020 2020 2020 2020 2020  nses:.          
+00040420: 2020 666f 7220 7369 7a65 2c20 6475 7261    for size, dura
+00040430: 7469 6f6e 2069 6e20 642e 6974 656d 7328  tion in d.items(
+00040440: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00040450: 2020 206f 7574 5b22 6e65 7477 6f72 6b22     out["network"
+00040460: 5d5b 7369 7a65 5d2e 6170 7065 6e64 2864  ][size].append(d
+00040470: 7572 6174 696f 6e29 0a0a 2020 2020 2020  uration)..      
+00040480: 2020 7265 7375 6c74 203d 207b 7d0a 2020    result = {}.  
+00040490: 2020 2020 2020 666f 7220 6d6f 6465 2069        for mode i
+000404a0: 6e20 6f75 743a 0a20 2020 2020 2020 2020  n out:.         
+000404b0: 2020 2072 6573 756c 745b 6d6f 6465 5d20     result[mode] 
+000404c0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+000404d0: 2020 2020 7369 7a65 3a20 7375 6d28 6475      size: sum(du
+000404e0: 7261 7469 6f6e 7329 202f 206c 656e 2864  rations) / len(d
+000404f0: 7572 6174 696f 6e73 290a 2020 2020 2020  urations).      
+00040500: 2020 2020 2020 2020 2020 666f 7220 7369            for si
+00040510: 7a65 2c20 6475 7261 7469 6f6e 7320 696e  ze, durations in
+00040520: 206f 7574 5b6d 6f64 655d 2e69 7465 6d73   out[mode].items
+00040530: 2829 0a20 2020 2020 2020 2020 2020 207d  ().            }
+00040540: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00040550: 2072 6573 756c 740a 0a20 2020 2040 6c6f   result..    @lo
+00040560: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+00040570: 2067 6574 5f6e 6279 7465 7328 0a20 2020   get_nbytes(.   
+00040580: 2020 2020 2073 656c 662c 206b 6579 733a       self, keys:
+00040590: 2049 7465 7261 626c 655b 7374 725d 207c   Iterable[str] |
+000405a0: 204e 6f6e 6520 3d20 4e6f 6e65 2c20 7375   None = None, su
+000405b0: 6d6d 6172 793a 2062 6f6f 6c20 3d20 5472  mmary: bool = Tr
+000405c0: 7565 0a20 2020 2029 202d 3e20 6469 6374  ue.    ) -> dict
+000405d0: 5b73 7472 2c20 696e 745d 3a0a 2020 2020  [str, int]:.    
+000405e0: 2020 2020 6966 206b 6579 7320 6973 206e      if keys is n
+000405f0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00040600: 2020 2020 2072 6573 756c 7420 3d20 7b6b       result = {k
+00040610: 3a20 7365 6c66 2e74 6173 6b73 5b6b 5d2e  : self.tasks[k].
+00040620: 6e62 7974 6573 2066 6f72 206b 2069 6e20  nbytes for k in 
+00040630: 6b65 7973 7d0a 2020 2020 2020 2020 656c  keys}.        el
+00040640: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00040650: 7265 7375 6c74 203d 207b 6b3a 2074 732e  result = {k: ts.
+00040660: 6e62 7974 6573 2066 6f72 206b 2c20 7473  nbytes for k, ts
+00040670: 2069 6e20 7365 6c66 2e74 6173 6b73 2e69   in self.tasks.i
+00040680: 7465 6d73 2829 2069 6620 7473 2e6e 6279  tems() if ts.nby
+00040690: 7465 7320 3e3d 2030 7d0a 0a20 2020 2020  tes >= 0}..     
+000406a0: 2020 2069 6620 7375 6d6d 6172 793a 0a20     if summary:. 
+000406b0: 2020 2020 2020 2020 2020 206f 7574 3a20             out: 
+000406c0: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
+000406d0: 2069 6e74 5d20 3d20 6465 6661 756c 7464   int] = defaultd
+000406e0: 6963 7428 6c61 6d62 6461 3a20 3029 0a20  ict(lambda: 0). 
+000406f0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00040700: 2c20 7620 696e 2072 6573 756c 742e 6974  , v in result.it
+00040710: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+00040720: 2020 2020 2020 206f 7574 5b6b 6579 5f73         out[key_s
+00040730: 706c 6974 286b 295d 202b 3d20 760a 2020  plit(k)] += v.  
+00040740: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00040750: 203d 2064 6963 7428 6f75 7429 0a0a 2020   = dict(out)..  
+00040760: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00040770: 756c 740a 0a20 2020 2064 6566 2072 756e  ult..    def run
+00040780: 5f66 756e 6374 696f 6e28 0a20 2020 2020  _function(.     
+00040790: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+000407a0: 2063 6f6d 6d3a 2043 6f6d 6d2c 0a20 2020   comm: Comm,.   
+000407b0: 2020 2020 2066 756e 6374 696f 6e3a 2043       function: C
+000407c0: 616c 6c61 626c 652c 0a20 2020 2020 2020  allable,.       
+000407d0: 2061 7267 733a 2074 7570 6c65 203d 2028   args: tuple = (
+000407e0: 292c 0a20 2020 2020 2020 206b 7761 7267  ),.        kwarg
+000407f0: 733a 2064 6963 7420 7c20 4e6f 6e65 203d  s: dict | None =
+00040800: 204e 6f6e 652c 0a20 2020 2020 2020 2077   None,.        w
+00040810: 6169 743a 2062 6f6f 6c20 3d20 5472 7565  ait: bool = True
+00040820: 2c0a 2020 2020 2920 2d3e 2041 6e79 3a0a  ,.    ) -> Any:.
+00040830: 2020 2020 2020 2020 2222 2252 756e 2061          """Run a
+00040840: 2066 756e 6374 696f 6e20 7769 7468 696e   function within
+00040850: 2074 6869 7320 7072 6f63 6573 730a 0a20   this process.. 
+00040860: 2020 2020 2020 2053 6565 2041 6c73 6f0a         See Also.
+00040870: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00040880: 0a20 2020 2020 2020 2043 6c69 656e 742e  .        Client.
+00040890: 7275 6e5f 6f6e 5f73 6368 6564 756c 6572  run_on_scheduler
+000408a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000408b0: 2020 2020 2066 726f 6d20 6469 7374 7269       from distri
+000408c0: 6275 7465 642e 776f 726b 6572 2069 6d70  buted.worker imp
+000408d0: 6f72 7420 7275 6e0a 0a20 2020 2020 2020  ort run..       
+000408e0: 2069 6620 6e6f 7420 6461 736b 2e63 6f6e   if not dask.con
+000408f0: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+00040900: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
+00040910: 6963 6b6c 6522 293a 0a20 2020 2020 2020  ickle"):.       
+00040920: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00040930: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00040940: 2020 2020 2020 2022 4361 6e6e 6f74 2072         "Cannot r
+00040950: 756e 2066 756e 6374 696f 6e20 6173 2074  un function as t
+00040960: 6865 2073 6368 6564 756c 6572 2068 6173  he scheduler has
+00040970: 2062 6565 6e20 6578 706c 6963 6974 6c79   been explicitly
+00040980: 2064 6973 616c 6c6f 7765 6420 6672 6f6d   disallowed from
+00040990: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+000409a0: 2020 2022 6465 7365 7269 616c 697a 696e     "deserializin
+000409b0: 6720 6172 6269 7472 6172 7920 6279 7465  g arbitrary byte
+000409c0: 7374 7269 6e67 7320 7573 696e 6720 7069  strings using pi
+000409d0: 636b 6c65 2076 6961 2074 6865 2022 0a20  ckle via the ". 
+000409e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000409f0: 2764 6973 7472 6962 7574 6564 2e73 6368  'distributed.sch
+00040a00: 6564 756c 6572 2e70 6963 6b6c 6527 2063  eduler.pickle' c
+00040a10: 6f6e 6669 6775 7261 7469 6f6e 2073 6574  onfiguration set
+00040a20: 7469 6e67 2e22 0a20 2020 2020 2020 2020  ting.".         
+00040a30: 2020 2029 0a20 2020 2020 2020 206b 7761     ).        kwa
+00040a40: 7267 7320 3d20 6b77 6172 6773 206f 7220  rgs = kwargs or 
+00040a50: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00040a60: 6c6f 675f 6576 656e 7428 2261 6c6c 222c  log_event("all",
+00040a70: 207b 2261 6374 696f 6e22 3a20 2272 756e   {"action": "run
+00040a80: 2d66 756e 6374 696f 6e22 2c20 2266 756e  -function", "fun
+00040a90: 6374 696f 6e22 3a20 6675 6e63 7469 6f6e  ction": function
+00040aa0: 7d29 0a20 2020 2020 2020 2072 6574 7572  }).        retur
+00040ab0: 6e20 7275 6e28 7365 6c66 2c20 636f 6d6d  n run(self, comm
+00040ac0: 2c20 6675 6e63 7469 6f6e 3d66 756e 6374  , function=funct
+00040ad0: 696f 6e2c 2061 7267 733d 6172 6773 2c20  ion, args=args, 
+00040ae0: 6b77 6172 6773 3d6b 7761 7267 732c 2077  kwargs=kwargs, w
+00040af0: 6169 743d 7761 6974 290a 0a20 2020 2064  ait=wait)..    d
+00040b00: 6566 2073 6574 5f6d 6574 6164 6174 6128  ef set_metadata(
+00040b10: 7365 6c66 2c20 6b65 7973 3a20 6c69 7374  self, keys: list
+00040b20: 5b73 7472 5d2c 2076 616c 7565 3a20 6f62  [str], value: ob
+00040b30: 6a65 6374 203d 204e 6f6e 6529 202d 3e20  ject = None) -> 
+00040b40: 4e6f 6e65 3a0a 2020 2020 2020 2020 6d65  None:.        me
+00040b50: 7461 6461 7461 203d 2073 656c 662e 7461  tadata = self.ta
+00040b60: 736b 5f6d 6574 6164 6174 610a 2020 2020  sk_metadata.    
+00040b70: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
+00040b80: 6579 735b 3a2d 315d 3a0a 2020 2020 2020  eys[:-1]:.      
+00040b90: 2020 2020 2020 6966 206b 6579 206e 6f74        if key not
+00040ba0: 2069 6e20 6d65 7461 6461 7461 206f 7220   in metadata or 
+00040bb0: 6e6f 7420 6973 696e 7374 616e 6365 286d  not isinstance(m
+00040bc0: 6574 6164 6174 615b 6b65 795d 2c20 2864  etadata[key], (d
+00040bd0: 6963 742c 206c 6973 7429 293a 0a20 2020  ict, list)):.   
+00040be0: 2020 2020 2020 2020 2020 2020 206d 6574               met
+00040bf0: 6164 6174 615b 6b65 795d 203d 207b 7d0a  adata[key] = {}.
+00040c00: 2020 2020 2020 2020 2020 2020 6d65 7461              meta
+00040c10: 6461 7461 203d 206d 6574 6164 6174 615b  data = metadata[
+00040c20: 6b65 795d 0a20 2020 2020 2020 206d 6574  key].        met
+00040c30: 6164 6174 615b 6b65 7973 5b2d 315d 5d20  adata[keys[-1]] 
+00040c40: 3d20 7661 6c75 650a 0a20 2020 2064 6566  = value..    def
+00040c50: 2067 6574 5f6d 6574 6164 6174 6128 7365   get_metadata(se
+00040c60: 6c66 2c20 6b65 7973 3a20 6c69 7374 5b73  lf, keys: list[s
+00040c70: 7472 5d2c 2064 6566 6175 6c74 3a20 416e  tr], default: An
+00040c80: 7920 3d20 6e6f 5f64 6566 6175 6c74 2920  y = no_default) 
+00040c90: 2d3e 2041 6e79 3a0a 2020 2020 2020 2020  -> Any:.        
+00040ca0: 6d65 7461 6461 7461 203d 2073 656c 662e  metadata = self.
+00040cb0: 7461 736b 5f6d 6574 6164 6174 610a 2020  task_metadata.  
+00040cc0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00040cd0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00040ce0: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+00040cf0: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
+00040d00: 203d 206d 6574 6164 6174 615b 6b65 795d   = metadata[key]
+00040d10: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00040d20: 7572 6e20 6d65 7461 6461 7461 0a20 2020  urn metadata.   
+00040d30: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+00040d40: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00040d50: 2020 6966 2064 6566 6175 6c74 2021 3d20    if default != 
+00040d60: 6e6f 5f64 6566 6175 6c74 3a0a 2020 2020  no_default:.    
+00040d70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00040d80: 726e 2064 6566 6175 6c74 0a20 2020 2020  rn default.     
+00040d90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00040da0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00040db0: 7365 0a0a 2020 2020 6465 6620 7365 745f  se..    def set_
+00040dc0: 7265 7374 7269 6374 696f 6e73 2873 656c  restrictions(sel
+00040dd0: 662c 2077 6f72 6b65 723a 2064 6963 745b  f, worker: dict[
+00040de0: 7374 722c 2043 6f6c 6c65 6374 696f 6e5b  str, Collection[
+00040df0: 7374 725d 207c 2073 7472 5d29 202d 3e20  str] | str]) -> 
+00040e00: 4e6f 6e65 3a0a 2020 2020 2020 2020 666f  None:.        fo
+00040e10: 7220 6b65 792c 2072 6573 7472 6963 7469  r key, restricti
+00040e20: 6f6e 7320 696e 2077 6f72 6b65 722e 6974  ons in worker.it
+00040e30: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+00040e40: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00040e50: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+00040e60: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00040e70: 6528 7265 7374 7269 6374 696f 6e73 2c20  e(restrictions, 
+00040e80: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
+00040e90: 2020 2020 2020 7265 7374 7269 6374 696f        restrictio
+00040ea0: 6e73 203d 207b 7265 7374 7269 6374 696f  ns = {restrictio
+00040eb0: 6e73 7d0a 2020 2020 2020 2020 2020 2020  ns}.            
+00040ec0: 7473 2e77 6f72 6b65 725f 7265 7374 7269  ts.worker_restri
+00040ed0: 6374 696f 6e73 203d 2073 6574 2872 6573  ctions = set(res
+00040ee0: 7472 6963 7469 6f6e 7329 0a0a 2020 2020  trictions)..    
+00040ef0: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+00040f00: 6465 6620 6765 745f 7461 736b 5f70 7265  def get_task_pre
+00040f10: 6669 785f 7374 6174 6573 2873 656c 6629  fix_states(self)
+00040f20: 202d 3e20 6469 6374 5b73 7472 2c20 6469   -> dict[str, di
+00040f30: 6374 5b73 7472 2c20 696e 745d 5d3a 0a20  ct[str, int]]:. 
+00040f40: 2020 2020 2020 2073 7461 7465 203d 207b         state = {
+00040f50: 7d0a 0a20 2020 2020 2020 2066 6f72 2074  }..        for t
+00040f60: 7020 696e 2073 656c 662e 7461 736b 5f70  p in self.task_p
+00040f70: 7265 6669 7865 732e 7661 6c75 6573 2829  refixes.values()
+00040f80: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
+00040f90: 7469 7665 5f73 7461 7465 7320 3d20 7470  tive_states = tp
+00040fa0: 2e61 6374 6976 655f 7374 6174 6573 0a20  .active_states. 
+00040fb0: 2020 2020 2020 2020 2020 2069 6620 616e             if an
+00040fc0: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
+00040fd0: 2020 2061 6374 6976 655f 7374 6174 6573     active_states
+00040fe0: 2e67 6574 2873 290a 2020 2020 2020 2020  .get(s).        
+00040ff0: 2020 2020 2020 2020 666f 7220 7320 696e          for s in
+00041000: 207b 226d 656d 6f72 7922 2c20 2265 7272   {"memory", "err
+00041010: 6564 222c 2022 7265 6c65 6173 6564 222c  ed", "released",
+00041020: 2022 7072 6f63 6573 7369 6e67 222c 2022   "processing", "
+00041030: 7761 6974 696e 6722 7d0a 2020 2020 2020  waiting"}.      
+00041040: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+00041050: 2020 2020 2020 2020 2073 7461 7465 5b74           state[t
+00041060: 702e 6e61 6d65 5d20 3d20 7b0a 2020 2020  p.name] = {.    
+00041070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041080: 226d 656d 6f72 7922 3a20 6163 7469 7665  "memory": active
+00041090: 5f73 7461 7465 735b 226d 656d 6f72 7922  _states["memory"
+000410a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000410b0: 2020 2020 2020 2022 6572 7265 6422 3a20         "erred": 
+000410c0: 6163 7469 7665 5f73 7461 7465 735b 2265  active_states["e
+000410d0: 7272 6564 225d 2c0a 2020 2020 2020 2020  rred"],.        
+000410e0: 2020 2020 2020 2020 2020 2020 2272 656c              "rel
+000410f0: 6561 7365 6422 3a20 6163 7469 7665 5f73  eased": active_s
+00041100: 7461 7465 735b 2272 656c 6561 7365 6422  tates["released"
+00041110: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00041120: 2020 2020 2020 2022 7072 6f63 6573 7369         "processi
+00041130: 6e67 223a 2061 6374 6976 655f 7374 6174  ng": active_stat
+00041140: 6573 5b22 7072 6f63 6573 7369 6e67 225d  es["processing"]
+00041150: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00041160: 2020 2020 2020 2277 6169 7469 6e67 223a        "waiting":
+00041170: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
+00041180: 7761 6974 696e 6722 5d2c 0a20 2020 2020  waiting"],.     
+00041190: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+000411a0: 2020 2020 2020 7265 7475 726e 2073 7461        return sta
+000411b0: 7465 0a0a 2020 2020 6465 6620 6765 745f  te..    def get_
+000411c0: 7461 736b 5f73 7461 7475 7328 7365 6c66  task_status(self
+000411d0: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
+000411e0: 5b73 7472 5d29 202d 3e20 6469 6374 5b73  [str]) -> dict[s
+000411f0: 7472 2c20 5461 736b 5374 6174 6553 7461  tr, TaskStateSta
+00041200: 7465 207c 204e 6f6e 655d 3a0a 2020 2020  te | None]:.    
+00041210: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
+00041220: 2020 2020 2020 2020 206b 6579 3a20 2873           key: (s
+00041230: 656c 662e 7461 736b 735b 6b65 795d 2e73  elf.tasks[key].s
+00041240: 7461 7465 2069 6620 6b65 7920 696e 2073  tate if key in s
+00041250: 656c 662e 7461 736b 7320 656c 7365 204e  elf.tasks else N
+00041260: 6f6e 6529 2066 6f72 206b 6579 2069 6e20  one) for key in 
+00041270: 6b65 7973 0a20 2020 2020 2020 207d 0a0a  keys.        }..
+00041280: 2020 2020 6465 6620 6765 745f 7461 736b      def get_task
+00041290: 5f73 7472 6561 6d28 0a20 2020 2020 2020  _stream(.       
+000412a0: 2073 656c 662c 0a20 2020 2020 2020 2073   self,.        s
+000412b0: 7461 7274 3a20 7374 7220 7c20 666c 6f61  tart: str | floa
+000412c0: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
+000412d0: 0a20 2020 2020 2020 2073 746f 703a 2073  .        stop: s
+000412e0: 7472 207c 2066 6c6f 6174 207c 204e 6f6e  tr | float | Non
+000412f0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00041300: 2020 636f 756e 743a 2069 6e74 207c 204e    count: int | N
+00041310: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00041320: 2920 2d3e 206c 6973 743a 0a20 2020 2020  ) -> list:.     
+00041330: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
+00041340: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
+00041350: 7461 736b 5f73 7472 6561 6d20 696d 706f  task_stream impo
+00041360: 7274 2054 6173 6b53 7472 6561 6d50 6c75  rt TaskStreamPlu
+00041370: 6769 6e0a 0a20 2020 2020 2020 2069 6620  gin..        if 
+00041380: 5461 736b 5374 7265 616d 506c 7567 696e  TaskStreamPlugin
+00041390: 2e6e 616d 6520 6e6f 7420 696e 2073 656c  .name not in sel
+000413a0: 662e 706c 7567 696e 733a 0a20 2020 2020  f.plugins:.     
+000413b0: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
+000413c0: 706c 7567 696e 2854 6173 6b53 7472 6561  plugin(TaskStrea
+000413d0: 6d50 6c75 6769 6e28 7365 6c66 2929 0a0a  mPlugin(self))..
+000413e0: 2020 2020 2020 2020 706c 7567 696e 203d          plugin =
+000413f0: 2063 6173 7428 5461 736b 5374 7265 616d   cast(TaskStream
+00041400: 506c 7567 696e 2c20 7365 6c66 2e70 6c75  Plugin, self.plu
+00041410: 6769 6e73 5b54 6173 6b53 7472 6561 6d50  gins[TaskStreamP
+00041420: 6c75 6769 6e2e 6e61 6d65 5d29 0a0a 2020  lugin.name])..  
+00041430: 2020 2020 2020 7265 7475 726e 2070 6c75        return plu
+00041440: 6769 6e2e 636f 6c6c 6563 7428 7374 6172  gin.collect(star
+00041450: 743d 7374 6172 742c 2073 746f 703d 7374  t=start, stop=st
+00041460: 6f70 2c20 636f 756e 743d 636f 756e 7429  op, count=count)
+00041470: 0a0a 2020 2020 6465 6620 7374 6172 745f  ..    def start_
+00041480: 7461 736b 5f6d 6574 6164 6174 6128 7365  task_metadata(se
+00041490: 6c66 2c20 6e61 6d65 3a20 7374 7229 202d  lf, name: str) -
+000414a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000414b0: 706c 7567 696e 203d 2043 6f6c 6c65 6374  plugin = Collect
+000414c0: 5461 736b 4d65 7461 4461 7461 506c 7567  TaskMetaDataPlug
+000414d0: 696e 2873 6368 6564 756c 6572 3d73 656c  in(scheduler=sel
+000414e0: 662c 206e 616d 653d 6e61 6d65 290a 2020  f, name=name).  
+000414f0: 2020 2020 2020 7365 6c66 2e61 6464 5f70        self.add_p
+00041500: 6c75 6769 6e28 706c 7567 696e 290a 0a20  lugin(plugin).. 
+00041510: 2020 2064 6566 2073 746f 705f 7461 736b     def stop_task
+00041520: 5f6d 6574 6164 6174 6128 7365 6c66 2c20  _metadata(self, 
+00041530: 6e61 6d65 3a20 7374 7220 7c20 4e6f 6e65  name: str | None
+00041540: 203d 204e 6f6e 6529 202d 3e20 6469 6374   = None) -> dict
+00041550: 3a0a 2020 2020 2020 2020 706c 7567 696e  :.        plugin
+00041560: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+00041570: 2020 700a 2020 2020 2020 2020 2020 2020    p.            
+00041580: 666f 7220 7020 696e 206c 6973 7428 7365  for p in list(se
+00041590: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
+000415a0: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
+000415b0: 2069 6620 6973 696e 7374 616e 6365 2870   if isinstance(p
+000415c0: 2c20 436f 6c6c 6563 7454 6173 6b4d 6574  , CollectTaskMet
+000415d0: 6144 6174 6150 6c75 6769 6e29 2061 6e64  aDataPlugin) and
+000415e0: 2070 2e6e 616d 6520 3d3d 206e 616d 650a   p.name == name.
+000415f0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00041600: 2020 6966 206c 656e 2870 6c75 6769 6e73    if len(plugins
+00041610: 2920 213d 2031 3a0a 2020 2020 2020 2020  ) != 1:.        
+00041620: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00041630: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00041640: 2020 2020 2020 2245 7870 6563 7465 6420        "Expected 
+00041650: 746f 2066 696e 6420 6578 6163 746c 7920  to find exactly 
+00041660: 6f6e 6520 436f 6c6c 6563 7454 6173 6b4d  one CollectTaskM
+00041670: 6574 6144 6174 6150 6c75 6769 6e20 220a  etaDataPlugin ".
+00041680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041690: 6622 7769 7468 206e 616d 6520 7b6e 616d  f"with name {nam
+000416a0: 657d 2062 7574 2066 6f75 6e64 207b 6c65  e} but found {le
+000416b0: 6e28 706c 7567 696e 7329 7d2e 220a 2020  n(plugins)}.".  
+000416c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000416d0: 2020 2020 2070 6c75 6769 6e20 3d20 706c       plugin = pl
+000416e0: 7567 696e 735b 305d 0a20 2020 2020 2020  ugins[0].       
+000416f0: 2073 656c 662e 7265 6d6f 7665 5f70 6c75   self.remove_plu
+00041700: 6769 6e28 6e61 6d65 3d70 6c75 6769 6e2e  gin(name=plugin.
+00041710: 6e61 6d65 290a 2020 2020 2020 2020 7265  name).        re
+00041720: 7475 726e 207b 226d 6574 6164 6174 6122  turn {"metadata"
+00041730: 3a20 706c 7567 696e 2e6d 6574 6164 6174  : plugin.metadat
+00041740: 612c 2022 7374 6174 6522 3a20 706c 7567  a, "state": plug
+00041750: 696e 2e73 7461 7465 7d0a 0a20 2020 2061  in.state}..    a
+00041760: 7379 6e63 2064 6566 2072 6567 6973 7465  sync def registe
+00041770: 725f 776f 726b 6572 5f70 6c75 6769 6e28  r_worker_plugin(
+00041780: 7365 6c66 2c20 636f 6d6d 2c20 706c 7567  self, comm, plug
+00041790: 696e 2c20 6e61 6d65 3d4e 6f6e 6529 3a0a  in, name=None):.
+000417a0: 2020 2020 2020 2020 2222 2252 6567 6973          """Regis
+000417b0: 7465 7273 2061 2077 6f72 6b65 7220 706c  ters a worker pl
+000417c0: 7567 696e 206f 6e20 616c 6c20 7275 6e6e  ugin on all runn
+000417d0: 696e 6720 616e 6420 6675 7475 7265 2077  ing and future w
+000417e0: 6f72 6b65 7273 2222 220a 2020 2020 2020  orkers""".      
+000417f0: 2020 7365 6c66 2e77 6f72 6b65 725f 706c    self.worker_pl
+00041800: 7567 696e 735b 6e61 6d65 5d20 3d20 706c  ugins[name] = pl
+00041810: 7567 696e 0a0a 2020 2020 2020 2020 7265  ugin..        re
+00041820: 7370 6f6e 7365 7320 3d20 6177 6169 7420  sponses = await 
+00041830: 7365 6c66 2e62 726f 6164 6361 7374 280a  self.broadcast(.
+00041840: 2020 2020 2020 2020 2020 2020 6d73 673d              msg=
+00041850: 6469 6374 286f 703d 2270 6c75 6769 6e2d  dict(op="plugin-
+00041860: 6164 6422 2c20 706c 7567 696e 3d70 6c75  add", plugin=plu
+00041870: 6769 6e2c 206e 616d 653d 6e61 6d65 290a  gin, name=name).
+00041880: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00041890: 2020 7265 7475 726e 2072 6573 706f 6e73    return respons
+000418a0: 6573 0a0a 2020 2020 6173 796e 6320 6465  es..    async de
+000418b0: 6620 756e 7265 6769 7374 6572 5f77 6f72  f unregister_wor
+000418c0: 6b65 725f 706c 7567 696e 2873 656c 662c  ker_plugin(self,
+000418d0: 2063 6f6d 6d2c 206e 616d 6529 3a0a 2020   comm, name):.  
+000418e0: 2020 2020 2020 2222 2255 6e72 6567 6973        """Unregis
+000418f0: 7465 7273 2061 2077 6f72 6b65 7220 706c  ters a worker pl
+00041900: 7567 696e 2222 220a 2020 2020 2020 2020  ugin""".        
+00041910: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00041920: 2073 656c 662e 776f 726b 6572 5f70 6c75   self.worker_plu
+00041930: 6769 6e73 2e70 6f70 286e 616d 6529 0a20  gins.pop(name). 
+00041940: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+00041950: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+00041960: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00041970: 7272 6f72 2866 2254 6865 2077 6f72 6b65  rror(f"The worke
+00041980: 7220 706c 7567 696e 207b 6e61 6d65 7d20  r plugin {name} 
+00041990: 646f 6573 206e 6f74 2065 7869 7374 2229  does not exist")
+000419a0: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
+000419b0: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
+000419c0: 2e62 726f 6164 6361 7374 286d 7367 3d64  .broadcast(msg=d
+000419d0: 6963 7428 6f70 3d22 706c 7567 696e 2d72  ict(op="plugin-r
+000419e0: 656d 6f76 6522 2c20 6e61 6d65 3d6e 616d  emove", name=nam
+000419f0: 6529 290a 2020 2020 2020 2020 7265 7475  e)).        retu
+00041a00: 726e 2072 6573 706f 6e73 6573 0a0a 2020  rn responses..  
+00041a10: 2020 6173 796e 6320 6465 6620 7265 6769    async def regi
+00041a20: 7374 6572 5f6e 616e 6e79 5f70 6c75 6769  ster_nanny_plugi
+00041a30: 6e28 7365 6c66 2c20 636f 6d6d 2c20 706c  n(self, comm, pl
+00041a40: 7567 696e 2c20 6e61 6d65 3d4e 6f6e 6529  ugin, name=None)
+00041a50: 3a0a 2020 2020 2020 2020 2222 2252 6567  :.        """Reg
+00041a60: 6973 7465 7273 2061 2073 6574 7570 2066  isters a setup f
+00041a70: 756e 6374 696f 6e2c 2061 6e64 2063 616c  unction, and cal
+00041a80: 6c20 6974 206f 6e20 6576 6572 7920 776f  l it on every wo
+00041a90: 726b 6572 2222 220a 2020 2020 2020 2020  rker""".        
+00041aa0: 7365 6c66 2e6e 616e 6e79 5f70 6c75 6769  self.nanny_plugi
+00041ab0: 6e73 5b6e 616d 655d 203d 2070 6c75 6769  ns[name] = plugi
+00041ac0: 6e0a 0a20 2020 2020 2020 2072 6573 706f  n..        respo
+00041ad0: 6e73 6573 203d 2061 7761 6974 2073 656c  nses = await sel
+00041ae0: 662e 6272 6f61 6463 6173 7428 0a20 2020  f.broadcast(.   
+00041af0: 2020 2020 2020 2020 206d 7367 3d64 6963           msg=dic
+00041b00: 7428 6f70 3d22 706c 7567 696e 5f61 6464  t(op="plugin_add
+00041b10: 222c 2070 6c75 6769 6e3d 706c 7567 696e  ", plugin=plugin
+00041b20: 2c20 6e61 6d65 3d6e 616d 6529 2c0a 2020  , name=name),.  
+00041b30: 2020 2020 2020 2020 2020 6e61 6e6e 793d            nanny=
+00041b40: 5472 7565 2c0a 2020 2020 2020 2020 290a  True,.        ).
+00041b50: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00041b60: 6573 706f 6e73 6573 0a0a 2020 2020 6173  esponses..    as
+00041b70: 796e 6320 6465 6620 756e 7265 6769 7374  ync def unregist
+00041b80: 6572 5f6e 616e 6e79 5f70 6c75 6769 6e28  er_nanny_plugin(
+00041b90: 7365 6c66 2c20 636f 6d6d 2c20 6e61 6d65  self, comm, name
+00041ba0: 293a 0a20 2020 2020 2020 2022 2222 556e  ):.        """Un
+00041bb0: 7265 6769 7374 6572 7320 6120 776f 726b  registers a work
+00041bc0: 6572 2070 6c75 6769 6e22 2222 0a20 2020  er plugin""".   
+00041bd0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00041be0: 2020 2020 2020 7365 6c66 2e6e 616e 6e79        self.nanny
+00041bf0: 5f70 6c75 6769 6e73 2e70 6f70 286e 616d  _plugins.pop(nam
+00041c00: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
+00041c10: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+00041c20: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00041c30: 6c75 6545 7272 6f72 2866 2254 6865 206e  lueError(f"The n
+00041c40: 616e 6e79 2070 6c75 6769 6e20 7b6e 616d  anny plugin {nam
+00041c50: 657d 2064 6f65 7320 6e6f 7420 6578 6973  e} does not exis
+00041c60: 7422 290a 0a20 2020 2020 2020 2072 6573  t")..        res
+00041c70: 706f 6e73 6573 203d 2061 7761 6974 2073  ponses = await s
+00041c80: 656c 662e 6272 6f61 6463 6173 7428 0a20  elf.broadcast(. 
+00041c90: 2020 2020 2020 2020 2020 206d 7367 3d64             msg=d
+00041ca0: 6963 7428 6f70 3d22 706c 7567 696e 5f72  ict(op="plugin_r
+00041cb0: 656d 6f76 6522 2c20 6e61 6d65 3d6e 616d  emove", name=nam
+00041cc0: 6529 2c20 6e61 6e6e 793d 5472 7565 0a20  e), nanny=True. 
+00041cd0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00041ce0: 2072 6574 7572 6e20 7265 7370 6f6e 7365   return response
+00041cf0: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
+00041d00: 6974 696f 6e28 0a20 2020 2020 2020 2073  ition(.        s
+00041d10: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
+00041d20: 3a20 7374 722c 0a20 2020 2020 2020 2066  : str,.        f
+00041d30: 696e 6973 683a 2054 6173 6b53 7461 7465  inish: TaskState
+00041d40: 5374 6174 652c 0a20 2020 2020 2020 2073  State,.        s
+00041d50: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
+00041d60: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00041d70: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+00041d80: 2052 6563 733a 0a20 2020 2020 2020 2022   Recs:.        "
+00041d90: 2222 5472 616e 7369 7469 6f6e 2061 206b  ""Transition a k
+00041da0: 6579 2066 726f 6d20 6974 7320 6375 7272  ey from its curr
+00041db0: 656e 7420 7374 6174 6520 746f 2074 6865  ent state to the
+00041dc0: 2066 696e 6973 6820 7374 6174 650a 0a20   finish state.. 
+00041dd0: 2020 2020 2020 2045 7861 6d70 6c65 730a         Examples.
+00041de0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00041df0: 0a20 2020 2020 2020 203e 3e3e 2073 656c  .        >>> sel
+00041e00: 662e 7472 616e 7369 7469 6f6e 2827 7827  f.transition('x'
+00041e10: 2c20 2777 6169 7469 6e67 2729 0a20 2020  , 'waiting').   
+00041e20: 2020 2020 207b 2778 273a 2027 7072 6f63       {'x': 'proc
+00041e30: 6573 7369 6e67 277d 0a0a 2020 2020 2020  essing'}..      
+00041e40: 2020 5265 7475 726e 730a 2020 2020 2020    Returns.      
+00041e50: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 2020    -------.      
+00041e60: 2020 4469 6374 696f 6e61 7279 206f 6620    Dictionary of 
+00041e70: 7265 636f 6d6d 656e 6461 7469 6f6e 7320  recommendations 
+00041e80: 666f 7220 6675 7475 7265 2074 7261 6e73  for future trans
+00041e90: 6974 696f 6e73 0a0a 2020 2020 2020 2020  itions..        
+00041ea0: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
+00041eb0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+00041ec0: 2020 5363 6865 6475 6c65 722e 7472 616e    Scheduler.tran
+00041ed0: 7369 7469 6f6e 733a 2074 7261 6e73 6974  sitions: transit
+00041ee0: 6976 6520 7665 7273 696f 6e20 6f66 2074  ive version of t
+00041ef0: 6869 7320 6675 6e63 7469 6f6e 0a20 2020  his function.   
+00041f00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00041f10: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00041f20: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
+00041f30: 6f72 6b65 725f 6d73 6773 203d 2073 656c  orker_msgs = sel
+00041f40: 662e 5f74 7261 6e73 6974 696f 6e28 0a20  f._transition(. 
+00041f50: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
+00041f60: 6669 6e69 7368 2c20 7374 696d 756c 7573  finish, stimulus
+00041f70: 5f69 642c 202a 2a6b 7761 7267 730a 2020  _id, **kwargs.  
+00041f80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00041f90: 7365 6c66 2e73 656e 645f 616c 6c28 636c  self.send_all(cl
+00041fa0: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+00041fb0: 725f 6d73 6773 290a 2020 2020 2020 2020  r_msgs).        
+00041fc0: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00041fd0: 6174 696f 6e73 0a0a 2020 2020 6465 6620  ations..    def 
+00041fe0: 7472 616e 7369 7469 6f6e 7328 7365 6c66  transitions(self
+00041ff0: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
+00042000: 733a 2052 6563 732c 2073 7469 6d75 6c75  s: Recs, stimulu
+00042010: 735f 6964 3a20 7374 7229 202d 3e20 4e6f  s_id: str) -> No
+00042020: 6e65 3a0a 2020 2020 2020 2020 2222 2250  ne:.        """P
+00042030: 726f 6365 7373 2074 7261 6e73 6974 696f  rocess transitio
+00042040: 6e73 2075 6e74 696c 206e 6f6e 6520 6172  ns until none ar
+00042050: 6520 6c65 6674 0a0a 2020 2020 2020 2020  e left..        
+00042060: 5468 6973 2069 6e63 6c75 6465 7320 6665  This includes fe
+00042070: 6564 6261 636b 2066 726f 6d20 7072 6576  edback from prev
+00042080: 696f 7573 2074 7261 6e73 6974 696f 6e73  ious transitions
+00042090: 2061 6e64 2063 6f6e 7469 6e75 6573 2075   and continues u
+000420a0: 6e74 696c 2077 650a 2020 2020 2020 2020  ntil we.        
+000420b0: 7265 6163 6820 6120 7374 6561 6479 2073  reach a steady s
+000420c0: 7461 7465 0a20 2020 2020 2020 2022 2222  tate.        """
+000420d0: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
+000420e0: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
+000420f0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+00042100: 7367 733a 204d 7367 7320 3d20 7b7d 0a20  sgs: Msgs = {}. 
+00042110: 2020 2020 2020 2073 656c 662e 5f74 7261         self._tra
+00042120: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
+00042130: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+00042140: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
+00042150: 6773 2c20 7374 696d 756c 7573 5f69 6429  gs, stimulus_id)
+00042160: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00042170: 6e64 5f61 6c6c 2863 6c69 656e 745f 6d73  nd_all(client_ms
+00042180: 6773 2c20 776f 726b 6572 5f6d 7367 7329  gs, worker_msgs)
+00042190: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+000421a0: 6765 745f 7374 6f72 7928 7365 6c66 2c20  get_story(self, 
+000421b0: 6b65 7973 5f6f 725f 7374 696d 756c 693a  keys_or_stimuli:
+000421c0: 2049 7465 7261 626c 655b 7374 725d 2920   Iterable[str]) 
+000421d0: 2d3e 206c 6973 745b 5472 616e 7369 7469  -> list[Transiti
+000421e0: 6f6e 5d3a 0a20 2020 2020 2020 2022 2222  on]:.        """
+000421f0: 5250 4320 686f 6f6b 2066 6f72 203a 6d65  RPC hook for :me
+00042200: 7468 3a60 5363 6865 6475 6c65 7253 7461  th:`SchedulerSta
+00042210: 7465 2e73 746f 7279 602e 0a0a 2020 2020  te.story`...    
+00042220: 2020 2020 4e6f 7465 2074 6861 7420 7468      Note that th
+00042230: 6520 6d73 6770 6163 6b20 7365 7269 616c  e msgpack serial
+00042240: 697a 6174 696f 6e2f 6465 7365 7269 616c  ization/deserial
+00042250: 697a 6174 696f 6e20 726f 756e 642d 7472  ization round-tr
+00042260: 6970 2077 696c 6c20 7472 616e 7366 6f72  ip will transfor
+00042270: 6d0a 2020 2020 2020 2020 7468 6520 3a63  m.        the :c
+00042280: 6c61 7373 3a60 5472 616e 7369 7469 6f6e  lass:`Transition
+00042290: 6020 6e61 6d65 6474 7570 6c65 7320 696e  ` namedtuples in
+000422a0: 746f 2072 6567 756c 6172 2074 7570 6c65  to regular tuple
+000422b0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+000422c0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000422d0: 6c66 2e73 746f 7279 282a 6b65 7973 5f6f  lf.story(*keys_o
+000422e0: 725f 7374 696d 756c 6929 0a0a 2020 2020  r_stimuli)..    
+000422f0: 6465 6620 5f72 6573 6368 6564 756c 6528  def _reschedule(
+00042300: 0a20 2020 2020 2020 2073 656c 662c 206b  .        self, k
+00042310: 6579 3a20 7374 722c 2077 6f72 6b65 723a  ey: str, worker:
+00042320: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00042330: 6e65 2c20 2a2c 2073 7469 6d75 6c75 735f  ne, *, stimulus_
+00042340: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
+00042350: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00042360: 2222 5265 7363 6865 6475 6c65 2061 2074  ""Reschedule a t
+00042370: 6173 6b2e 0a0a 2020 2020 2020 2020 5468  ask...        Th
+00042380: 6973 2066 756e 6374 696f 6e20 7368 6f75  is function shou
+00042390: 6c64 206f 6e6c 7920 6265 2075 7365 6420  ld only be used 
+000423a0: 7768 656e 2074 6865 2074 6173 6b20 6861  when the task ha
+000423b0: 7320 616c 7265 6164 7920 6265 656e 2072  s already been r
+000423c0: 656c 6561 7365 6420 696e 0a20 2020 2020  eleased in.     
+000423d0: 2020 2073 6f6d 6520 7761 7920 6f6e 2074     some way on t
+000423e0: 6865 2077 6f72 6b65 7220 6974 2773 2061  he worker it's a
+000423f0: 7373 6967 6e65 6420 746f 20e2 8094 2065  ssigned to ... e
+00042400: 6974 6865 7220 7669 6120 6361 6e63 656c  ither via cancel
+00042410: 6c61 7469 6f6e 206f 7220 610a 2020 2020  lation or a.    
+00042420: 2020 2020 5265 7363 6865 6475 6c65 2065      Reschedule e
+00042430: 7863 6570 7469 6f6e 20e2 8094 2061 6e64  xception ... and
+00042440: 2079 6f75 2061 7265 2063 6572 7461 696e   you are certain
+00042450: 2074 6865 2077 6f72 6b65 7220 7769 6c6c   the worker will
+00042460: 206e 6f74 2073 656e 6420 616e 7920 6675   not send any fu
+00042470: 7274 6865 720a 2020 2020 2020 2020 7570  rther.        up
+00042480: 6461 7465 7320 6162 6f75 7420 7468 6520  dates about the 
+00042490: 7461 736b 2074 6f20 7468 6520 7363 6865  task to the sche
+000424a0: 6475 6c65 722e 0a20 2020 2020 2020 2022  duler..        "
+000424b0: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
+000424c0: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+000424d0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+000424e0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+000424f0: 4b65 7945 7272 6f72 3a0a 2020 2020 2020  KeyError:.      
+00042500: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+00042510: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+00042520: 2020 2020 2020 6622 4174 7465 6d70 7469        f"Attempti
+00042530: 6e67 2074 6f20 7265 7363 6865 6475 6c65  ng to reschedule
+00042540: 2074 6173 6b20 7b6b 6579 7d2c 2077 6869   task {key}, whi
+00042550: 6368 2077 6173 206e 6f74 2022 0a20 2020  ch was not ".   
+00042560: 2020 2020 2020 2020 2020 2020 2022 666f               "fo
+00042570: 756e 6420 6f6e 2074 6865 2073 6368 6564  und on the sched
+00042580: 756c 6572 2e20 4162 6f72 7469 6e67 2072  uler. Aborting r
+00042590: 6573 6368 6564 756c 652e 220a 2020 2020  eschedule.".    
+000425a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000425b0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+000425c0: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
+000425d0: 2021 3d20 2270 726f 6365 7373 696e 6722   != "processing"
+000425e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000425f0: 7475 726e 0a20 2020 2020 2020 2069 6620  turn.        if 
+00042600: 776f 726b 6572 2061 6e64 2074 732e 7072  worker and ts.pr
+00042610: 6f63 6573 7369 6e67 5f6f 6e20 616e 6420  ocessing_on and 
+00042620: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00042630: 2e61 6464 7265 7373 2021 3d20 776f 726b  .address != work
+00042640: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00042650: 7265 7475 726e 0a20 2020 2020 2020 2023  return.        #
+00042660: 2074 7261 6e73 6974 696f 6e5f 7072 6f63   transition_proc
+00042670: 6573 7369 6e67 5f72 656c 6561 7365 6420  essing_released 
+00042680: 7769 6c6c 2069 6d6d 6564 6961 7465 6c79  will immediately
+00042690: 2073 7567 6765 7374 2061 6e20 6164 6469   suggest an addi
+000426a0: 7469 6f6e 616c 0a20 2020 2020 2020 2023  tional.        #
+000426b0: 2074 7261 6e73 6974 696f 6e20 746f 2077   transition to w
+000426c0: 6169 7469 6e67 2069 6620 7468 6520 7461  aiting if the ta
+000426d0: 736b 2068 6173 2061 6e79 2077 6169 7465  sk has any waite
+000426e0: 7273 206f 7220 636c 6965 6e74 7320 686f  rs or clients ho
+000426f0: 6c64 696e 6720 6120 6675 7475 7265 2e0a  lding a future..
+00042700: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
+00042710: 6e73 6974 696f 6e73 287b 6b65 793a 2022  nsitions({key: "
+00042720: 7265 6c65 6173 6564 227d 2c20 7374 696d  released"}, stim
+00042730: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+00042740: 5f69 6429 0a0a 2020 2020 2323 2323 2323  _id)..    ######
+00042750: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00042760: 2020 2020 2320 5574 696c 6974 7920 6675      # Utility fu
+00042770: 6e63 7469 6f6e 7320 230a 2020 2020 2323  nctions #.    ##
+00042780: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00042790: 2323 230a 0a20 2020 2064 6566 2061 6464  ###..    def add
+000427a0: 5f72 6573 6f75 7263 6573 280a 2020 2020  _resources(.    
+000427b0: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
+000427c0: 3a20 7374 722c 2072 6573 6f75 7263 6573  : str, resources
+000427d0: 3a20 6469 6374 207c 204e 6f6e 6520 3d20  : dict | None = 
+000427e0: 4e6f 6e65 0a20 2020 2029 202d 3e20 4c69  None.    ) -> Li
+000427f0: 7465 7261 6c5b 224f 4b22 5d3a 0a20 2020  teral["OK"]:.   
+00042800: 2020 2020 2077 733a 2057 6f72 6b65 7253       ws: WorkerS
+00042810: 7461 7465 203d 2073 656c 662e 776f 726b  tate = self.work
+00042820: 6572 735b 776f 726b 6572 5d0a 2020 2020  ers[worker].    
+00042830: 2020 2020 6966 2072 6573 6f75 7263 6573      if resources
+00042840: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
+00042850: 2e72 6573 6f75 7263 6573 2e75 7064 6174  .resources.updat
+00042860: 6528 7265 736f 7572 6365 7329 0a20 2020  e(resources).   
+00042870: 2020 2020 2077 732e 7573 6564 5f72 6573       ws.used_res
+00042880: 6f75 7263 6573 203d 207b 7d0a 2020 2020  ources = {}.    
+00042890: 2020 2020 666f 7220 7265 736f 7572 6365      for resource
+000428a0: 2c20 7175 616e 7469 7479 2069 6e20 7773  , quantity in ws
+000428b0: 2e72 6573 6f75 7263 6573 2e69 7465 6d73  .resources.items
+000428c0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000428d0: 7773 2e75 7365 645f 7265 736f 7572 6365  ws.used_resource
+000428e0: 735b 7265 736f 7572 6365 5d20 3d20 300a  s[resource] = 0.
+000428f0: 2020 2020 2020 2020 2020 2020 6472 203d              dr =
+00042900: 2073 656c 662e 7265 736f 7572 6365 732e   self.resources.
+00042910: 6765 7428 7265 736f 7572 6365 2c20 4e6f  get(resource, No
+00042920: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+00042930: 6966 2064 7220 6973 204e 6f6e 653a 0a20  if dr is None:. 
+00042940: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00042950: 656c 662e 7265 736f 7572 6365 735b 7265  elf.resources[re
+00042960: 736f 7572 6365 5d20 3d20 6472 203d 207b  source] = dr = {
+00042970: 7d0a 2020 2020 2020 2020 2020 2020 6472  }.            dr
+00042980: 5b77 6f72 6b65 725d 203d 2071 7561 6e74  [worker] = quant
+00042990: 6974 790a 2020 2020 2020 2020 7265 7475  ity.        retu
+000429a0: 726e 2022 4f4b 220a 0a20 2020 2064 6566  rn "OK"..    def
+000429b0: 2072 656d 6f76 655f 7265 736f 7572 6365   remove_resource
+000429c0: 7328 7365 6c66 2c20 776f 726b 6572 3a20  s(self, worker: 
+000429d0: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
+000429e0: 2020 2020 2020 7773 3a20 576f 726b 6572        ws: Worker
+000429f0: 5374 6174 6520 3d20 7365 6c66 2e77 6f72  State = self.wor
+00042a00: 6b65 7273 5b77 6f72 6b65 725d 0a20 2020  kers[worker].   
+00042a10: 2020 2020 2066 6f72 2072 6573 6f75 7263       for resourc
+00042a20: 6520 696e 2077 732e 7265 736f 7572 6365  e in ws.resource
+00042a30: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
+00042a40: 7220 3d20 7365 6c66 2e72 6573 6f75 7263  r = self.resourc
+00042a50: 6573 2e73 6574 6465 6661 756c 7428 7265  es.setdefault(re
+00042a60: 736f 7572 6365 2c20 7b7d 290a 2020 2020  source, {}).    
+00042a70: 2020 2020 2020 2020 6465 6c20 6472 5b77          del dr[w
+00042a80: 6f72 6b65 725d 0a0a 2020 2020 6465 6620  orker]..    def 
+00042a90: 636f 6572 6365 5f61 6464 7265 7373 2873  coerce_address(s
+00042aa0: 656c 662c 2061 6464 723a 2073 7472 207c  elf, addr: str |
+00042ab0: 2074 7570 6c65 2c20 7265 736f 6c76 653a   tuple, resolve:
+00042ac0: 2062 6f6f 6c20 3d20 5472 7565 2920 2d3e   bool = True) ->
+00042ad0: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
+00042ae0: 220a 2020 2020 2020 2020 436f 6572 6365  ".        Coerce
+00042af0: 2070 6f73 7369 626c 6520 696e 7075 7420   possible input 
+00042b00: 6164 6472 6573 7365 7320 746f 2063 616e  addresses to can
+00042b10: 6f6e 6963 616c 2066 6f72 6d2e 0a20 2020  onical form..   
+00042b20: 2020 2020 202a 7265 736f 6c76 652a 2063       *resolve* c
+00042b30: 616e 2062 6520 6469 7361 626c 6564 2066  an be disabled f
+00042b40: 6f72 2074 6573 7469 6e67 2077 6974 6820  or testing with 
+00042b50: 6661 6b65 2068 6f73 746e 616d 6573 2e0a  fake hostnames..
+00042b60: 0a20 2020 2020 2020 2048 616e 646c 6573  .        Handles
+00042b70: 2073 7472 696e 6773 2c20 7475 706c 6573   strings, tuples
+00042b80: 2c20 6f72 2061 6c69 6173 6573 2e0a 2020  , or aliases..  
+00042b90: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00042ba0: 2020 2320 5858 5820 686f 7720 6d61 6e79    # XXX how many
+00042bb0: 2061 6464 7265 7373 2d70 6172 7369 6e67   address-parsing
+00042bc0: 2072 6f75 7469 6e65 7320 646f 2077 6520   routines do we 
+00042bd0: 6861 7665 3f0a 2020 2020 2020 2020 6966  have?.        if
+00042be0: 2061 6464 7220 696e 2073 656c 662e 616c   addr in self.al
+00042bf0: 6961 7365 733a 0a20 2020 2020 2020 2020  iases:.         
+00042c00: 2020 2061 6464 7220 3d20 7365 6c66 2e61     addr = self.a
+00042c10: 6c69 6173 6573 5b61 6464 725d 0a20 2020  liases[addr].   
+00042c20: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00042c30: 6365 2861 6464 722c 2074 7570 6c65 293a  ce(addr, tuple):
+00042c40: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
+00042c50: 7220 3d20 756e 7061 7273 655f 686f 7374  r = unparse_host
+00042c60: 5f70 6f72 7428 2a61 6464 7229 0a20 2020  _port(*addr).   
+00042c70: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00042c80: 7374 616e 6365 2861 6464 722c 2073 7472  stance(addr, str
+00042c90: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00042ca0: 6169 7365 2054 7970 6545 7272 6f72 2866  aise TypeError(f
+00042cb0: 2261 6464 7265 7373 6573 2073 686f 756c  "addresses shoul
+00042cc0: 6420 6265 2073 7472 696e 6773 206f 7220  d be strings or 
+00042cd0: 7475 706c 6573 2c20 676f 7420 7b61 6464  tuples, got {add
+00042ce0: 7221 727d 2229 0a0a 2020 2020 2020 2020  r!r}")..        
+00042cf0: 6966 2072 6573 6f6c 7665 3a0a 2020 2020  if resolve:.    
+00042d00: 2020 2020 2020 2020 6164 6472 203d 2072          addr = r
+00042d10: 6573 6f6c 7665 5f61 6464 7265 7373 2861  esolve_address(a
+00042d20: 6464 7229 0a20 2020 2020 2020 2065 6c73  ddr).        els
+00042d30: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00042d40: 6464 7220 3d20 6e6f 726d 616c 697a 655f  ddr = normalize_
+00042d50: 6164 6472 6573 7328 6164 6472 290a 0a20  address(addr).. 
+00042d60: 2020 2020 2020 2072 6574 7572 6e20 6164         return ad
+00042d70: 6472 0a0a 2020 2020 6465 6620 776f 726b  dr..    def work
+00042d80: 6572 735f 6c69 7374 2873 656c 662c 2077  ers_list(self, w
+00042d90: 6f72 6b65 7273 3a20 4974 6572 6162 6c65  orkers: Iterable
+00042da0: 5b73 7472 5d20 7c20 4e6f 6e65 2920 2d3e  [str] | None) ->
+00042db0: 206c 6973 745b 7374 725d 3a0a 2020 2020   list[str]:.    
+00042dc0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00042dd0: 4c69 7374 206f 6620 7175 616c 6966 7969  List of qualifyi
+00042de0: 6e67 2077 6f72 6b65 7273 0a0a 2020 2020  ng workers..    
+00042df0: 2020 2020 5461 6b65 7320 6120 6c69 7374      Takes a list
+00042e00: 206f 6620 776f 726b 6572 2061 6464 7265   of worker addre
+00042e10: 7373 6573 206f 7220 686f 7374 6e61 6d65  sses or hostname
+00042e20: 732e 0a20 2020 2020 2020 2052 6574 7572  s..        Retur
+00042e30: 6e73 2061 206c 6973 7420 6f66 2061 6c6c  ns a list of all
+00042e40: 2077 6f72 6b65 7220 6164 6472 6573 7365   worker addresse
+00042e50: 7320 7468 6174 206d 6174 6368 0a20 2020  s that match.   
+00042e60: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00042e70: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
+00042e80: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00042e90: 2072 6574 7572 6e20 6c69 7374 2873 656c   return list(sel
+00042ea0: 662e 776f 726b 6572 7329 0a0a 2020 2020  f.workers)..    
+00042eb0: 2020 2020 6f75 7420 3d20 7365 7428 290a      out = set().
+00042ec0: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
+00042ed0: 2077 6f72 6b65 7273 3a0a 2020 2020 2020   workers:.      
+00042ee0: 2020 2020 2020 6966 2022 3a22 2069 6e20        if ":" in 
+00042ef0: 773a 0a20 2020 2020 2020 2020 2020 2020  w:.             
+00042f00: 2020 206f 7574 2e61 6464 2877 290a 2020     out.add(w).  
+00042f10: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00042f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042f30: 6f75 742e 7570 6461 7465 287b 7777 2066  out.update({ww f
+00042f40: 6f72 2077 7720 696e 2073 656c 662e 776f  or ww in self.wo
+00042f50: 726b 6572 7320 6966 2077 2069 6e20 7777  rkers if w in ww
+00042f60: 7d29 2020 2320 544f 444f 3a20 7175 6164  })  # TODO: quad
+00042f70: 7261 7469 630a 2020 2020 2020 2020 7265  ratic.        re
+00042f80: 7475 726e 206c 6973 7428 6f75 7429 0a0a  turn list(out)..
+00042f90: 2020 2020 6173 796e 6320 6465 6620 6765      async def ge
+00042fa0: 745f 7072 6f66 696c 6528 0a20 2020 2020  t_profile(.     
+00042fb0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00042fc0: 2063 6f6d 6d3d 4e6f 6e65 2c0a 2020 2020   comm=None,.    
+00042fd0: 2020 2020 776f 726b 6572 733d 4e6f 6e65      workers=None
+00042fe0: 2c0a 2020 2020 2020 2020 7363 6865 6475  ,.        schedu
+00042ff0: 6c65 723d 4661 6c73 652c 0a20 2020 2020  ler=False,.     
+00043000: 2020 2073 6572 7665 723d 4661 6c73 652c     server=False,
+00043010: 0a20 2020 2020 2020 206d 6572 6765 5f77  .        merge_w
+00043020: 6f72 6b65 7273 3d54 7275 652c 0a20 2020  orkers=True,.   
+00043030: 2020 2020 2073 7461 7274 3d4e 6f6e 652c       start=None,
+00043040: 0a20 2020 2020 2020 2073 746f 703d 4e6f  .        stop=No
+00043050: 6e65 2c0a 2020 2020 2020 2020 6b65 793d  ne,.        key=
+00043060: 4e6f 6e65 2c0a 2020 2020 293a 0a20 2020  None,.    ):.   
+00043070: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
+00043080: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00043090: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
+000430a0: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
+000430b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000430c0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+000430d0: 7365 7428 7365 6c66 2e77 6f72 6b65 7273  set(self.workers
+000430e0: 2920 2620 7365 7428 776f 726b 6572 7329  ) & set(workers)
+000430f0: 0a0a 2020 2020 2020 2020 6966 2073 6368  ..        if sch
+00043100: 6564 756c 6572 3a0a 2020 2020 2020 2020  eduler:.        
+00043110: 2020 2020 7265 7475 726e 2070 726f 6669      return profi
+00043120: 6c65 2e67 6574 5f70 726f 6669 6c65 2873  le.get_profile(s
+00043130: 656c 662e 696f 5f6c 6f6f 702e 7072 6f66  elf.io_loop.prof
+00043140: 696c 652c 2073 7461 7274 3d73 7461 7274  ile, start=start
+00043150: 2c20 7374 6f70 3d73 746f 7029 0a0a 2020  , stop=stop)..  
+00043160: 2020 2020 2020 7265 7375 6c74 7320 3d20        results = 
+00043170: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00043180: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+00043190: 2020 2a28 0a20 2020 2020 2020 2020 2020    *(.           
+000431a0: 2020 2020 2073 656c 662e 7270 6328 7729       self.rpc(w)
+000431b0: 2e70 726f 6669 6c65 2873 7461 7274 3d73  .profile(start=s
+000431c0: 7461 7274 2c20 7374 6f70 3d73 746f 702c  tart, stop=stop,
+000431d0: 206b 6579 3d6b 6579 2c20 7365 7276 6572   key=key, server
+000431e0: 3d73 6572 7665 7229 0a20 2020 2020 2020  =server).       
+000431f0: 2020 2020 2020 2020 2066 6f72 2077 2069           for w i
+00043200: 6e20 776f 726b 6572 730a 2020 2020 2020  n workers.      
+00043210: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+00043220: 2020 2020 2072 6574 7572 6e5f 6578 6365       return_exce
+00043230: 7074 696f 6e73 3d54 7275 652c 0a20 2020  ptions=True,.   
+00043240: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00043250: 7265 7375 6c74 7320 3d20 5b72 2066 6f72  results = [r for
+00043260: 2072 2069 6e20 7265 7375 6c74 7320 6966   r in results if
+00043270: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00043280: 722c 2045 7863 6570 7469 6f6e 295d 0a0a  r, Exception)]..
+00043290: 2020 2020 2020 2020 6966 206d 6572 6765          if merge
+000432a0: 5f77 6f72 6b65 7273 3a0a 2020 2020 2020  _workers:.      
+000432b0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+000432c0: 2070 726f 6669 6c65 2e6d 6572 6765 282a   profile.merge(*
+000432d0: 7265 7375 6c74 7329 0a20 2020 2020 2020  results).       
+000432e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000432f0: 2020 2072 6573 706f 6e73 6520 3d20 6469     response = di
+00043300: 6374 287a 6970 2877 6f72 6b65 7273 2c20  ct(zip(workers, 
+00043310: 7265 7375 6c74 7329 290a 2020 2020 2020  results)).      
+00043320: 2020 7265 7475 726e 2072 6573 706f 6e73    return respons
+00043330: 650a 0a20 2020 2061 7379 6e63 2064 6566  e..    async def
+00043340: 2067 6574 5f70 726f 6669 6c65 5f6d 6574   get_profile_met
+00043350: 6164 6174 6128 0a20 2020 2020 2020 2073  adata(.        s
+00043360: 656c 662c 0a20 2020 2020 2020 2077 6f72  elf,.        wor
+00043370: 6b65 7273 3a20 2249 7465 7261 626c 655b  kers: "Iterable[
+00043380: 7374 725d 207c 204e 6f6e 6522 203d 204e  str] | None" = N
+00043390: 6f6e 652c 0a20 2020 2020 2020 2073 7461  one,.        sta
+000433a0: 7274 3a20 666c 6f61 7420 3d20 302c 0a20  rt: float = 0,. 
+000433b0: 2020 2020 2020 2073 746f 703a 2022 666c         stop: "fl
+000433c0: 6f61 7420 7c20 4e6f 6e65 2220 3d20 4e6f  oat | None" = No
+000433d0: 6e65 2c0a 2020 2020 2020 2020 7072 6f66  ne,.        prof
+000433e0: 696c 655f 6379 636c 655f 696e 7465 7276  ile_cycle_interv
+000433f0: 616c 3a20 2273 7472 207c 2066 6c6f 6174  al: "str | float
+00043400: 207c 204e 6f6e 6522 203d 204e 6f6e 652c   | None" = None,
+00043410: 0a20 2020 2029 202d 3e20 6469 6374 3a0a  .    ) -> dict:.
+00043420: 2020 2020 2020 2020 6474 203d 2070 726f          dt = pro
+00043430: 6669 6c65 5f63 7963 6c65 5f69 6e74 6572  file_cycle_inter
+00043440: 7661 6c20 6f72 2064 6173 6b2e 636f 6e66  val or dask.conf
+00043450: 6967 2e67 6574 280a 2020 2020 2020 2020  ig.get(.        
+00043460: 2020 2020 2264 6973 7472 6962 7574 6564      "distributed
+00043470: 2e77 6f72 6b65 722e 7072 6f66 696c 652e  .worker.profile.
+00043480: 6379 636c 6522 0a20 2020 2020 2020 2029  cycle".        )
+00043490: 0a20 2020 2020 2020 2064 7420 3d20 7061  .        dt = pa
+000434a0: 7273 655f 7469 6d65 6465 6c74 6128 6474  rse_timedelta(dt
+000434b0: 2c20 6465 6661 756c 743d 226d 7322 290a  , default="ms").
+000434c0: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
+000434d0: 6572 7320 6973 204e 6f6e 653a 0a20 2020  ers is None:.   
+000434e0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+000434f0: 203d 2073 656c 662e 776f 726b 6572 730a   = self.workers.
+00043500: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00043510: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00043520: 7320 3d20 7365 7428 7365 6c66 2e77 6f72  s = set(self.wor
+00043530: 6b65 7273 2920 2620 7365 7428 776f 726b  kers) & set(work
+00043540: 6572 7329 0a20 2020 2020 2020 2072 6573  ers).        res
+00043550: 756c 7473 203d 2061 7761 6974 2061 7379  ults = await asy
+00043560: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+00043570: 2020 2020 2020 2020 202a 2873 656c 662e           *(self.
+00043580: 7270 6328 7729 2e70 726f 6669 6c65 5f6d  rpc(w).profile_m
+00043590: 6574 6164 6174 6128 7374 6172 743d 7374  etadata(start=st
+000435a0: 6172 742c 2073 746f 703d 7374 6f70 2920  art, stop=stop) 
+000435b0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+000435c0: 292c 0a20 2020 2020 2020 2020 2020 2072  ),.            r
+000435d0: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+000435e0: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
+000435f0: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+00043600: 7320 3d20 5b72 2066 6f72 2072 2069 6e20  s = [r for r in 
+00043610: 7265 7375 6c74 7320 6966 206e 6f74 2069  results if not i
+00043620: 7369 6e73 7461 6e63 6528 722c 2045 7863  sinstance(r, Exc
+00043630: 6570 7469 6f6e 295d 0a20 2020 2020 2020  eption)].       
+00043640: 2063 6f75 6e74 7320 3d20 5b0a 2020 2020   counts = [.    
+00043650: 2020 2020 2020 2020 2874 696d 652c 2073          (time, s
+00043660: 756d 2870 6c75 636b 2831 2c20 6772 6f75  um(pluck(1, grou
+00043670: 7029 2929 0a20 2020 2020 2020 2020 2020  p))).           
+00043680: 2066 6f72 2074 696d 652c 2067 726f 7570   for time, group
+00043690: 2069 6e20 6974 6572 746f 6f6c 732e 6772   in itertools.gr
+000436a0: 6f75 7062 7928 0a20 2020 2020 2020 2020  oupby(.         
+000436b0: 2020 2020 2020 206d 6572 6765 5f73 6f72         merge_sor
+000436c0: 7465 6428 0a20 2020 2020 2020 2020 2020  ted(.           
+000436d0: 2020 2020 2020 2020 202a 2876 5b22 636f           *(v["co
+000436e0: 756e 7473 225d 2066 6f72 2076 2069 6e20  unts"] for v in 
+000436f0: 7265 7375 6c74 7329 2c0a 2020 2020 2020  results),.      
+00043700: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00043710: 2020 2020 2020 2020 2020 2020 206c 616d               lam
+00043720: 6264 6120 743a 2074 5b30 5d20 2f2f 2064  bda t: t[0] // d
+00043730: 7420 2a20 6474 2c0a 2020 2020 2020 2020  t * dt,.        
+00043740: 2020 2020 290a 2020 2020 2020 2020 5d0a      ).        ].
+00043750: 0a20 2020 2020 2020 206b 6579 733a 2064  .        keys: d
+00043760: 6963 745b 7374 722c 206c 6973 745b 6c69  ict[str, list[li
+00043770: 7374 5d5d 203d 207b 0a20 2020 2020 2020  st]] = {.       
+00043780: 2020 2020 206b 3a20 5b5d 2066 6f72 2076       k: [] for v
+00043790: 2069 6e20 7265 7375 6c74 7320 666f 7220   in results for 
+000437a0: 742c 2064 2069 6e20 765b 226b 6579 7322  t, d in v["keys"
+000437b0: 5d20 666f 7220 6b20 696e 2064 0a20 2020  ] for k in d.   
+000437c0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000437d0: 6772 6f75 7073 3120 3d20 5b76 5b22 6b65  groups1 = [v["ke
+000437e0: 7973 225d 2066 6f72 2076 2069 6e20 7265  ys"] for v in re
+000437f0: 7375 6c74 735d 0a20 2020 2020 2020 2067  sults].        g
+00043800: 726f 7570 7332 203d 206c 6973 7428 6d65  roups2 = list(me
+00043810: 7267 655f 736f 7274 6564 282a 6772 6f75  rge_sorted(*grou
+00043820: 7073 312c 206b 6579 3d66 6972 7374 2929  ps1, key=first))
+00043830: 0a0a 2020 2020 2020 2020 6c61 7374 203d  ..        last =
+00043840: 2030 0a20 2020 2020 2020 2066 6f72 2074   0.        for t
+00043850: 2c20 6420 696e 2067 726f 7570 7332 3a0a  , d in groups2:.
+00043860: 2020 2020 2020 2020 2020 2020 7474 203d              tt =
+00043870: 2074 202f 2f20 6474 202a 2064 740a 2020   t // dt * dt.  
+00043880: 2020 2020 2020 2020 2020 6966 2074 7420            if tt 
+00043890: 3e20 6c61 7374 3a0a 2020 2020 2020 2020  > last:.        
+000438a0: 2020 2020 2020 2020 6c61 7374 203d 2074          last = t
+000438b0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+000438c0: 2020 666f 7220 7620 696e 206b 6579 732e    for v in keys.
+000438d0: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+000438e0: 2020 2020 2020 2020 2020 2020 2020 762e                v.
+000438f0: 6170 7065 6e64 285b 7474 2c20 305d 290a  append([tt, 0]).
+00043900: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00043910: 6b2c 2076 2069 6e20 642e 6974 656d 7328  k, v in d.items(
+00043920: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00043930: 2020 206b 6579 735b 6b5d 5b2d 315d 5b31     keys[k][-1][1
+00043940: 5d20 2b3d 2076 0a0a 2020 2020 2020 2020  ] += v..        
+00043950: 7265 7475 726e 207b 2263 6f75 6e74 7322  return {"counts"
+00043960: 3a20 636f 756e 7473 2c20 226b 6579 7322  : counts, "keys"
+00043970: 3a20 6b65 7973 7d0a 0a20 2020 2061 7379  : keys}..    asy
+00043980: 6e63 2064 6566 2070 6572 666f 726d 616e  nc def performan
+00043990: 6365 5f72 6570 6f72 7428 0a20 2020 2020  ce_report(.     
+000439a0: 2020 2073 656c 662c 2073 7461 7274 3a20     self, start: 
+000439b0: 666c 6f61 742c 206c 6173 745f 636f 756e  float, last_coun
+000439c0: 743a 2069 6e74 2c20 636f 6465 3a20 7374  t: int, code: st
+000439d0: 7220 3d20 2222 2c20 6d6f 6465 3a20 7374  r = "", mode: st
+000439e0: 7220 7c20 4e6f 6e65 203d 204e 6f6e 650a  r | None = None.
+000439f0: 2020 2020 2920 2d3e 2073 7472 3a0a 2020      ) -> str:.  
+00043a00: 2020 2020 2020 7374 6f70 203d 2074 696d        stop = tim
+00043a10: 6528 290a 2020 2020 2020 2020 2320 5072  e().        # Pr
+00043a20: 6f66 696c 6573 0a20 2020 2020 2020 2063  ofiles.        c
+00043a30: 6f6d 7075 7465 2c20 7363 6865 6475 6c65  ompute, schedule
+00043a40: 722c 2077 6f72 6b65 7273 203d 2061 7761  r, workers = awa
+00043a50: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+00043a60: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
+00043a70: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00043a80: 2020 7365 6c66 2e67 6574 5f70 726f 6669    self.get_profi
+00043a90: 6c65 2873 7461 7274 3d73 7461 7274 292c  le(start=start),
+00043aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043ab0: 2073 656c 662e 6765 745f 7072 6f66 696c   self.get_profil
+00043ac0: 6528 7363 6865 6475 6c65 723d 5472 7565  e(scheduler=True
+00043ad0: 2c20 7374 6172 743d 7374 6172 7429 2c0a  , start=start),.
+00043ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043af0: 7365 6c66 2e67 6574 5f70 726f 6669 6c65  self.get_profile
+00043b00: 2873 6572 7665 723d 5472 7565 2c20 7374  (server=True, st
+00043b10: 6172 743d 7374 6172 7429 2c0a 2020 2020  art=start),.    
+00043b20: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00043b30: 2020 290a 2020 2020 2020 2020 6672 6f6d    ).        from
+00043b40: 2064 6973 7472 6962 7574 6564 2069 6d70   distributed imp
+00043b50: 6f72 7420 7072 6f66 696c 650a 0a20 2020  ort profile..   
+00043b60: 2020 2020 2064 6566 2070 726f 6669 6c65       def profile
+00043b70: 5f74 6f5f 6669 6775 7265 2873 7461 7465  _to_figure(state
+00043b80: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
+00043b90: 6174 6120 3d20 7072 6f66 696c 652e 706c  ata = profile.pl
+00043ba0: 6f74 5f64 6174 6128 7374 6174 6529 0a20  ot_data(state). 
+00043bb0: 2020 2020 2020 2020 2020 2066 6967 7572             figur
+00043bc0: 652c 2073 6f75 7263 6520 3d20 7072 6f66  e, source = prof
+00043bd0: 696c 652e 706c 6f74 5f66 6967 7572 6528  ile.plot_figure(
+00043be0: 6461 7461 2c20 7369 7a69 6e67 5f6d 6f64  data, sizing_mod
+00043bf0: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00043c00: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00043c10: 7475 726e 2066 6967 7572 650a 0a20 2020  turn figure..   
+00043c20: 2020 2020 2063 6f6d 7075 7465 2c20 7363       compute, sc
+00043c30: 6865 6475 6c65 722c 2077 6f72 6b65 7273  heduler, workers
+00043c40: 203d 206d 6170 280a 2020 2020 2020 2020   = map(.        
+00043c50: 2020 2020 7072 6f66 696c 655f 746f 5f66      profile_to_f
+00043c60: 6967 7572 652c 2028 636f 6d70 7574 652c  igure, (compute,
+00043c70: 2073 6368 6564 756c 6572 2c20 776f 726b   scheduler, work
+00043c80: 6572 7329 0a20 2020 2020 2020 2029 0a0a  ers).        )..
+00043c90: 2020 2020 2020 2020 2320 5461 736b 2073          # Task s
+00043ca0: 7472 6561 6d0a 2020 2020 2020 2020 7461  tream.        ta
+00043cb0: 736b 5f73 7472 6561 6d20 3d20 7365 6c66  sk_stream = self
+00043cc0: 2e67 6574 5f74 6173 6b5f 7374 7265 616d  .get_task_stream
+00043cd0: 2873 7461 7274 3d73 7461 7274 290a 2020  (start=start).  
+00043ce0: 2020 2020 2020 746f 7461 6c5f 7461 736b        total_task
+00043cf0: 7320 3d20 6c65 6e28 7461 736b 5f73 7472  s = len(task_str
+00043d00: 6561 6d29 0a20 2020 2020 2020 2074 696d  eam).        tim
+00043d10: 6573 7065 6e74 3a20 6465 6661 756c 7464  espent: defaultd
+00043d20: 6963 745b 7374 722c 2066 6c6f 6174 5d20  ict[str, float] 
+00043d30: 3d20 6465 6661 756c 7464 6963 7428 666c  = defaultdict(fl
+00043d40: 6f61 7429 0a20 2020 2020 2020 2066 6f72  oat).        for
+00043d50: 2064 2069 6e20 7461 736b 5f73 7472 6561   d in task_strea
+00043d60: 6d3a 0a20 2020 2020 2020 2020 2020 2066  m:.            f
+00043d70: 6f72 2078 2069 6e20 645b 2273 7461 7274  or x in d["start
+00043d80: 7374 6f70 7322 5d3a 0a20 2020 2020 2020  stops"]:.       
+00043d90: 2020 2020 2020 2020 2074 696d 6573 7065           timespe
+00043da0: 6e74 5b78 5b22 6163 7469 6f6e 225d 5d20  nt[x["action"]] 
+00043db0: 2b3d 2078 5b22 7374 6f70 225d 202d 2078  += x["stop"] - x
+00043dc0: 5b22 7374 6172 7422 5d0a 2020 2020 2020  ["start"].      
+00043dd0: 2020 7461 736b 735f 7469 6d69 6e67 7320    tasks_timings 
+00043de0: 3d20 2222 0a20 2020 2020 2020 2066 6f72  = "".        for
+00043df0: 206b 2069 6e20 736f 7274 6564 2874 696d   k in sorted(tim
+00043e00: 6573 7065 6e74 2e6b 6579 7328 2929 3a0a  espent.keys()):.
+00043e10: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00043e20: 735f 7469 6d69 6e67 7320 2b3d 2066 225c  s_timings += f"\
+00043e30: 6e3c 6c69 3e20 7b6b 7d20 7469 6d65 3a20  n<li> {k} time: 
+00043e40: 7b66 6f72 6d61 745f 7469 6d65 2874 696d  {format_time(tim
+00043e50: 6573 7065 6e74 5b6b 5d29 7d20 3c2f 6c69  espent[k])} </li
+00043e60: 3e22 0a0a 2020 2020 2020 2020 6672 6f6d  >"..        from
+00043e70: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00043e80: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
+00043e90: 732e 7363 6865 6475 6c65 7220 696d 706f  s.scheduler impo
+00043ea0: 7274 2074 6173 6b5f 7374 7265 616d 5f66  rt task_stream_f
+00043eb0: 6967 7572 650a 2020 2020 2020 2020 6672  igure.        fr
+00043ec0: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+00043ed0: 6961 676e 6f73 7469 6373 2e74 6173 6b5f  iagnostics.task_
+00043ee0: 7374 7265 616d 2069 6d70 6f72 7420 7265  stream import re
+00043ef0: 6374 616e 676c 6573 0a0a 2020 2020 2020  ctangles..      
+00043f00: 2020 7265 6374 7320 3d20 7265 6374 616e    rects = rectan
+00043f10: 676c 6573 2874 6173 6b5f 7374 7265 616d  gles(task_stream
+00043f20: 290a 2020 2020 2020 2020 736f 7572 6365  ).        source
+00043f30: 2c20 7461 736b 5f73 7472 6561 6d20 3d20  , task_stream = 
+00043f40: 7461 736b 5f73 7472 6561 6d5f 6669 6775  task_stream_figu
+00043f50: 7265 2873 697a 696e 675f 6d6f 6465 3d22  re(sizing_mode="
+00043f60: 7374 7265 7463 685f 626f 7468 2229 0a20  stretch_both"). 
+00043f70: 2020 2020 2020 2073 6f75 7263 652e 6461         source.da
+00043f80: 7461 2e75 7064 6174 6528 7265 6374 7329  ta.update(rects)
+00043f90: 0a0a 2020 2020 2020 2020 2320 4261 6e64  ..        # Band
+00043fa0: 7769 6474 680a 2020 2020 2020 2020 6672  width.        fr
+00043fb0: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+00043fc0: 6173 6862 6f61 7264 2e63 6f6d 706f 6e65  ashboard.compone
+00043fd0: 6e74 732e 7363 6865 6475 6c65 7220 696d  nts.scheduler im
+00043fe0: 706f 7274 2028 0a20 2020 2020 2020 2020  port (.         
+00043ff0: 2020 2042 616e 6477 6964 7468 5479 7065     BandwidthType
+00044000: 732c 0a20 2020 2020 2020 2020 2020 2042  s,.            B
+00044010: 616e 6477 6964 7468 576f 726b 6572 732c  andwidthWorkers,
+00044020: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00044030: 2020 2020 6261 6e64 7769 6474 685f 776f      bandwidth_wo
+00044040: 726b 6572 7320 3d20 4261 6e64 7769 6474  rkers = Bandwidt
+00044050: 6857 6f72 6b65 7273 2873 656c 662c 2073  hWorkers(self, s
+00044060: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
+00044070: 7463 685f 626f 7468 2229 0a20 2020 2020  tch_both").     
+00044080: 2020 2062 616e 6477 6964 7468 5f77 6f72     bandwidth_wor
+00044090: 6b65 7273 2e75 7064 6174 6528 290a 2020  kers.update().  
+000440a0: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
+000440b0: 7479 7065 7320 3d20 4261 6e64 7769 6474  types = Bandwidt
+000440c0: 6854 7970 6573 2873 656c 662c 2073 697a  hTypes(self, siz
+000440d0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+000440e0: 685f 626f 7468 2229 0a20 2020 2020 2020  h_both").       
+000440f0: 2062 616e 6477 6964 7468 5f74 7970 6573   bandwidth_types
+00044100: 2e75 7064 6174 6528 290a 0a20 2020 2020  .update()..     
+00044110: 2020 2023 2053 7973 7465 6d20 6d6f 6e69     # System moni
+00044120: 746f 720a 2020 2020 2020 2020 6672 6f6d  tor.        from
+00044130: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00044140: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
+00044150: 732e 7368 6172 6564 2069 6d70 6f72 7420  s.shared import 
+00044160: 5379 7374 656d 4d6f 6e69 746f 720a 0a20  SystemMonitor.. 
+00044170: 2020 2020 2020 2073 7973 6d6f 6e20 3d20         sysmon = 
+00044180: 5379 7374 656d 4d6f 6e69 746f 7228 7365  SystemMonitor(se
+00044190: 6c66 2c20 6c61 7374 5f63 6f75 6e74 3d6c  lf, last_count=l
+000441a0: 6173 745f 636f 756e 742c 2073 697a 696e  ast_count, sizin
+000441b0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+000441c0: 626f 7468 2229 0a20 2020 2020 2020 2073  both").        s
+000441d0: 7973 6d6f 6e2e 7570 6461 7465 2829 0a0a  ysmon.update()..
+000441e0: 2020 2020 2020 2020 2320 5363 6865 6475          # Schedu
+000441f0: 6c65 7220 6c6f 6773 0a20 2020 2020 2020  ler logs.       
+00044200: 2066 726f 6d20 6469 7374 7269 6275 7465   from distribute
+00044210: 642e 6461 7368 626f 6172 642e 636f 6d70  d.dashboard.comp
+00044220: 6f6e 656e 7473 2e73 6368 6564 756c 6572  onents.scheduler
+00044230: 2069 6d70 6f72 7420 280a 2020 2020 2020   import (.      
+00044240: 2020 2020 2020 5f42 4f4b 4548 5f53 5459        _BOKEH_STY
+00044250: 4c45 535f 4b57 4152 4753 2c0a 2020 2020  LES_KWARGS,.    
+00044260: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
+00044270: 724c 6f67 732c 0a20 2020 2020 2020 2029  rLogs,.        )
+00044280: 0a0a 2020 2020 2020 2020 6c6f 6773 203d  ..        logs =
+00044290: 2053 6368 6564 756c 6572 4c6f 6773 2873   SchedulerLogs(s
+000442a0: 656c 662c 2073 7461 7274 3d73 7461 7274  elf, start=start
+000442b0: 290a 0a20 2020 2020 2020 2066 726f 6d20  )..        from 
+000442c0: 626f 6b65 682e 6d6f 6465 6c73 2069 6d70  bokeh.models imp
+000442d0: 6f72 7420 4469 762c 2054 6162 730a 0a20  ort Div, Tabs.. 
+000442e0: 2020 2020 2020 2069 6d70 6f72 7420 6469         import di
+000442f0: 7374 7269 6275 7465 640a 2020 2020 2020  stributed.      
+00044300: 2020 6672 6f6d 2064 6973 7472 6962 7574    from distribut
+00044310: 6564 2e64 6173 6862 6f61 7264 2e63 6f72  ed.dashboard.cor
+00044320: 6520 696d 706f 7274 2054 6162 5061 6e65  e import TabPane
+00044330: 6c0a 0a20 2020 2020 2020 2023 2048 544d  l..        # HTM
+00044340: 4c0a 2020 2020 2020 2020 6874 6d6c 203d  L.        html =
+00044350: 2022 2222 0a20 2020 2020 2020 203c 6831   """.        <h1
+00044360: 3e20 4461 736b 2050 6572 666f 726d 616e  > Dask Performan
+00044370: 6365 2052 6570 6f72 7420 3c2f 6831 3e0a  ce Report </h1>.
+00044380: 0a20 2020 2020 2020 203c 693e 2053 656c  .        <i> Sel
+00044390: 6563 7420 6469 6666 6572 656e 7420 7461  ect different ta
+000443a0: 6273 206f 6e20 7468 6520 746f 7020 666f  bs on the top fo
+000443b0: 7220 6164 6469 7469 6f6e 616c 2069 6e66  r additional inf
+000443c0: 6f72 6d61 7469 6f6e 203c 2f69 3e0a 0a20  ormation </i>.. 
+000443d0: 2020 2020 2020 203c 6832 3e20 4475 7261         <h2> Dura
+000443e0: 7469 6f6e 3a20 7b74 696d 657d 203c 2f68  tion: {time} </h
+000443f0: 323e 0a20 2020 2020 2020 203c 6832 3e20  2>.        <h2> 
+00044400: 5461 736b 7320 496e 666f 726d 6174 696f  Tasks Informatio
+00044410: 6e20 3c2f 6832 3e0a 2020 2020 2020 2020  n </h2>.        
+00044420: 3c75 6c3e 0a20 2020 2020 2020 2020 3c6c  <ul>.         <l
+00044430: 693e 206e 756d 6265 7220 6f66 2074 6173  i> number of tas
+00044440: 6b73 3a20 7b6e 7461 736b 737d 203c 2f6c  ks: {ntasks} </l
+00044450: 693e 0a20 2020 2020 2020 2020 7b74 6173  i>.         {tas
+00044460: 6b73 5f74 696d 696e 6773 7d0a 2020 2020  ks_timings}.    
+00044470: 2020 2020 3c2f 756c 3e0a 0a20 2020 2020      </ul>..     
+00044480: 2020 203c 6832 3e20 5363 6865 6475 6c65     <h2> Schedule
+00044490: 7220 496e 666f 726d 6174 696f 6e20 3c2f  r Information </
+000444a0: 6832 3e0a 2020 2020 2020 2020 3c75 6c3e  h2>.        <ul>
+000444b0: 0a20 2020 2020 2020 2020 203c 6c69 3e20  .          <li> 
+000444c0: 4164 6472 6573 733a 207b 6164 6472 6573  Address: {addres
+000444d0: 737d 203c 2f6c 693e 0a20 2020 2020 2020  s} </li>.       
+000444e0: 2020 203c 6c69 3e20 576f 726b 6572 733a     <li> Workers:
+000444f0: 207b 6e77 6f72 6b65 7273 7d20 3c2f 6c69   {nworkers} </li
+00044500: 3e0a 2020 2020 2020 2020 2020 3c6c 693e  >.          <li>
+00044510: 2054 6872 6561 6473 3a20 7b74 6872 6561   Threads: {threa
+00044520: 6473 7d20 3c2f 6c69 3e0a 2020 2020 2020  ds} </li>.      
+00044530: 2020 2020 3c6c 693e 204d 656d 6f72 793a      <li> Memory:
+00044540: 207b 6d65 6d6f 7279 7d20 3c2f 6c69 3e0a   {memory} </li>.
+00044550: 2020 2020 2020 2020 2020 3c6c 693e 2044            <li> D
+00044560: 6173 6b20 5665 7273 696f 6e3a 207b 6461  ask Version: {da
+00044570: 736b 5f76 6572 7369 6f6e 7d20 3c2f 6c69  sk_version} </li
+00044580: 3e0a 2020 2020 2020 2020 2020 3c6c 693e  >.          <li>
+00044590: 2044 6173 6b2e 4469 7374 7269 6275 7465   Dask.Distribute
+000445a0: 6420 5665 7273 696f 6e3a 207b 6469 7374  d Version: {dist
+000445b0: 7269 6275 7465 645f 7665 7273 696f 6e7d  ributed_version}
+000445c0: 203c 2f6c 693e 0a20 2020 2020 2020 203c   </li>.        <
+000445d0: 2f75 6c3e 0a0a 2020 2020 2020 2020 3c68  /ul>..        <h
+000445e0: 323e 2043 616c 6c69 6e67 2043 6f64 6520  2> Calling Code 
+000445f0: 3c2f 6832 3e0a 2020 2020 2020 2020 3c70  </h2>.        <p
+00044600: 7265 3e0a 7b63 6f64 657d 0a20 2020 2020  re>.{code}.     
+00044610: 2020 203c 2f70 7265 3e0a 2020 2020 2020     </pre>.      
+00044620: 2020 2222 222e 666f 726d 6174 280a 2020    """.format(.  
+00044630: 2020 2020 2020 2020 2020 7469 6d65 3d66            time=f
+00044640: 6f72 6d61 745f 7469 6d65 2873 746f 7020  ormat_time(stop 
+00044650: 2d20 7374 6172 7429 2c0a 2020 2020 2020  - start),.      
+00044660: 2020 2020 2020 6e74 6173 6b73 3d74 6f74        ntasks=tot
+00044670: 616c 5f74 6173 6b73 2c0a 2020 2020 2020  al_tasks,.      
+00044680: 2020 2020 2020 7461 736b 735f 7469 6d69        tasks_timi
+00044690: 6e67 733d 7461 736b 735f 7469 6d69 6e67  ngs=tasks_timing
+000446a0: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
+000446b0: 6464 7265 7373 3d73 656c 662e 6164 6472  ddress=self.addr
+000446c0: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
+000446d0: 206e 776f 726b 6572 733d 6c65 6e28 7365   nworkers=len(se
+000446e0: 6c66 2e77 6f72 6b65 7273 292c 0a20 2020  lf.workers),.   
+000446f0: 2020 2020 2020 2020 2074 6872 6561 6473           threads
+00044700: 3d73 756d 2877 732e 6e74 6872 6561 6473  =sum(ws.nthreads
+00044710: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+00044720: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+00044730: 292c 0a20 2020 2020 2020 2020 2020 206d  ),.            m
+00044740: 656d 6f72 793d 666f 726d 6174 5f62 7974  emory=format_byt
+00044750: 6573 2873 756d 2877 732e 6d65 6d6f 7279  es(sum(ws.memory
+00044760: 5f6c 696d 6974 2066 6f72 2077 7320 696e  _limit for ws in
+00044770: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
+00044780: 6c75 6573 2829 2929 2c0a 2020 2020 2020  lues())),.      
+00044790: 2020 2020 2020 636f 6465 3d63 6f64 652c        code=code,
+000447a0: 0a20 2020 2020 2020 2020 2020 2064 6173  .            das
+000447b0: 6b5f 7665 7273 696f 6e3d 6461 736b 2e5f  k_version=dask._
+000447c0: 5f76 6572 7369 6f6e 5f5f 2c0a 2020 2020  _version__,.    
+000447d0: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
+000447e0: 7465 645f 7665 7273 696f 6e3d 6469 7374  ted_version=dist
+000447f0: 7269 6275 7465 642e 5f5f 7665 7273 696f  ributed.__versio
+00044800: 6e5f 5f2c 0a20 2020 2020 2020 2029 0a20  n__,.        ). 
+00044810: 2020 2020 2020 2068 746d 6c20 3d20 4469         html = Di
+00044820: 7628 7465 7874 3d68 746d 6c2c 202a 2a5f  v(text=html, **_
+00044830: 424f 4b45 485f 5354 594c 4553 5f4b 5741  BOKEH_STYLES_KWA
+00044840: 5247 5329 0a0a 2020 2020 2020 2020 6874  RGS)..        ht
+00044850: 6d6c 203d 2054 6162 5061 6e65 6c28 6368  ml = TabPanel(ch
+00044860: 696c 643d 6874 6d6c 2c20 7469 746c 653d  ild=html, title=
+00044870: 2253 756d 6d61 7279 2229 0a20 2020 2020  "Summary").     
+00044880: 2020 2063 6f6d 7075 7465 203d 2054 6162     compute = Tab
+00044890: 5061 6e65 6c28 6368 696c 643d 636f 6d70  Panel(child=comp
+000448a0: 7574 652c 2074 6974 6c65 3d22 576f 726b  ute, title="Work
+000448b0: 6572 2050 726f 6669 6c65 2028 636f 6d70  er Profile (comp
+000448c0: 7574 6529 2229 0a20 2020 2020 2020 2077  ute)").        w
+000448d0: 6f72 6b65 7273 203d 2054 6162 5061 6e65  orkers = TabPane
+000448e0: 6c28 6368 696c 643d 776f 726b 6572 732c  l(child=workers,
+000448f0: 2074 6974 6c65 3d22 576f 726b 6572 2050   title="Worker P
+00044900: 726f 6669 6c65 2028 6164 6d69 6e69 7374  rofile (administ
+00044910: 7261 7469 7665 2922 290a 2020 2020 2020  rative)").      
+00044920: 2020 7363 6865 6475 6c65 7220 3d20 5461    scheduler = Ta
+00044930: 6250 616e 656c 280a 2020 2020 2020 2020  bPanel(.        
+00044940: 2020 2020 6368 696c 643d 7363 6865 6475      child=schedu
+00044950: 6c65 722c 2074 6974 6c65 3d22 5363 6865  ler, title="Sche
+00044960: 6475 6c65 7220 5072 6f66 696c 6520 2861  duler Profile (a
+00044970: 646d 696e 6973 7472 6174 6976 6529 220a  dministrative)".
+00044980: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00044990: 2020 7461 736b 5f73 7472 6561 6d20 3d20    task_stream = 
+000449a0: 5461 6250 616e 656c 2863 6869 6c64 3d74  TabPanel(child=t
+000449b0: 6173 6b5f 7374 7265 616d 2c20 7469 746c  ask_stream, titl
+000449c0: 653d 2254 6173 6b20 5374 7265 616d 2229  e="Task Stream")
+000449d0: 0a20 2020 2020 2020 2062 616e 6477 6964  .        bandwid
+000449e0: 7468 5f77 6f72 6b65 7273 203d 2054 6162  th_workers = Tab
+000449f0: 5061 6e65 6c28 0a20 2020 2020 2020 2020  Panel(.         
+00044a00: 2020 2063 6869 6c64 3d62 616e 6477 6964     child=bandwid
+00044a10: 7468 5f77 6f72 6b65 7273 2e72 6f6f 742c  th_workers.root,
+00044a20: 2074 6974 6c65 3d22 4261 6e64 7769 6474   title="Bandwidt
+00044a30: 6820 2857 6f72 6b65 7273 2922 0a20 2020  h (Workers)".   
+00044a40: 2020 2020 2029 0a20 2020 2020 2020 2062       ).        b
+00044a50: 616e 6477 6964 7468 5f74 7970 6573 203d  andwidth_types =
+00044a60: 2054 6162 5061 6e65 6c28 0a20 2020 2020   TabPanel(.     
+00044a70: 2020 2020 2020 2063 6869 6c64 3d62 616e         child=ban
+00044a80: 6477 6964 7468 5f74 7970 6573 2e72 6f6f  dwidth_types.roo
+00044a90: 742c 2074 6974 6c65 3d22 4261 6e64 7769  t, title="Bandwi
+00044aa0: 6474 6820 2854 7970 6573 2922 0a20 2020  dth (Types)".   
+00044ab0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00044ac0: 7973 7465 6d20 3d20 5461 6250 616e 656c  ystem = TabPanel
+00044ad0: 2863 6869 6c64 3d73 7973 6d6f 6e2e 726f  (child=sysmon.ro
+00044ae0: 6f74 2c20 7469 746c 653d 2253 7973 7465  ot, title="Syste
+00044af0: 6d22 290a 2020 2020 2020 2020 6c6f 6773  m").        logs
+00044b00: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
+00044b10: 643d 6c6f 6773 2e72 6f6f 742c 2074 6974  d=logs.root, tit
+00044b20: 6c65 3d22 5363 6865 6475 6c65 7220 4c6f  le="Scheduler Lo
+00044b30: 6773 2229 0a0a 2020 2020 2020 2020 7461  gs")..        ta
+00044b40: 6273 203d 2054 6162 7328 0a20 2020 2020  bs = Tabs(.     
+00044b50: 2020 2020 2020 2074 6162 733d 5b0a 2020         tabs=[.  
+00044b60: 2020 2020 2020 2020 2020 2020 2020 6874                ht
+00044b70: 6d6c 2c0a 2020 2020 2020 2020 2020 2020  ml,.            
+00044b80: 2020 2020 7461 736b 5f73 7472 6561 6d2c      task_stream,
+00044b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044ba0: 2073 7973 7465 6d2c 0a20 2020 2020 2020   system,.       
+00044bb0: 2020 2020 2020 2020 206c 6f67 732c 0a20           logs,. 
+00044bc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00044bd0: 6f6d 7075 7465 2c0a 2020 2020 2020 2020  ompute,.        
+00044be0: 2020 2020 2020 2020 776f 726b 6572 732c          workers,
+00044bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044c00: 2073 6368 6564 756c 6572 2c0a 2020 2020   scheduler,.    
+00044c10: 2020 2020 2020 2020 2020 2020 6261 6e64              band
+00044c20: 7769 6474 685f 776f 726b 6572 732c 0a20  width_workers,. 
+00044c30: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00044c40: 616e 6477 6964 7468 5f74 7970 6573 2c0a  andwidth_types,.
+00044c50: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+00044c60: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
+00044c70: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+00044c80: 626f 7468 222c 0a20 2020 2020 2020 2029  both",.        )
+00044c90: 0a0a 2020 2020 2020 2020 6672 6f6d 2062  ..        from b
+00044ca0: 6f6b 6568 2e63 6f72 652e 7465 6d70 6c61  okeh.core.templa
+00044cb0: 7465 7320 696d 706f 7274 2067 6574 5f65  tes import get_e
+00044cc0: 6e76 0a20 2020 2020 2020 2066 726f 6d20  nv.        from 
+00044cd0: 626f 6b65 682e 706c 6f74 7469 6e67 2069  bokeh.plotting i
+00044ce0: 6d70 6f72 7420 6f75 7470 7574 5f66 696c  mport output_fil
+00044cf0: 652c 2073 6176 650a 0a20 2020 2020 2020  e, save..       
+00044d00: 2077 6974 6820 746d 7066 696c 6528 6578   with tmpfile(ex
+00044d10: 7465 6e73 696f 6e3d 222e 6874 6d6c 2229  tension=".html")
+00044d20: 2061 7320 666e 3a0a 2020 2020 2020 2020   as fn:.        
+00044d30: 2020 2020 6f75 7470 7574 5f66 696c 6528      output_file(
+00044d40: 6669 6c65 6e61 6d65 3d66 6e2c 2074 6974  filename=fn, tit
+00044d50: 6c65 3d22 4461 736b 2050 6572 666f 726d  le="Dask Perform
+00044d60: 616e 6365 2052 6570 6f72 7422 2c20 6d6f  ance Report", mo
+00044d70: 6465 3d6d 6f64 6529 0a20 2020 2020 2020  de=mode).       
+00044d80: 2020 2020 2074 656d 706c 6174 655f 6469       template_di
+00044d90: 7265 6374 6f72 7920 3d20 6f73 2e70 6174  rectory = os.pat
+00044da0: 682e 6a6f 696e 280a 2020 2020 2020 2020  h.join(.        
+00044db0: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
+00044dc0: 6469 726e 616d 6528 6f73 2e70 6174 682e  dirname(os.path.
+00044dd0: 6162 7370 6174 6828 5f5f 6669 6c65 5f5f  abspath(__file__
+00044de0: 2929 2c20 2264 6173 6862 6f61 7264 222c  )), "dashboard",
+00044df0: 2022 7465 6d70 6c61 7465 7322 0a20 2020   "templates".   
+00044e00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00044e10: 2020 2020 2020 2074 656d 706c 6174 655f         template_
+00044e20: 656e 7669 726f 6e6d 656e 7420 3d20 6765  environment = ge
+00044e30: 745f 656e 7628 290a 2020 2020 2020 2020  t_env().        
+00044e40: 2020 2020 7465 6d70 6c61 7465 5f65 6e76      template_env
+00044e50: 6972 6f6e 6d65 6e74 2e6c 6f61 6465 722e  ironment.loader.
+00044e60: 7365 6172 6368 7061 7468 2e61 7070 656e  searchpath.appen
+00044e70: 6428 7465 6d70 6c61 7465 5f64 6972 6563  d(template_direc
+00044e80: 746f 7279 290a 2020 2020 2020 2020 2020  tory).          
+00044e90: 2020 7465 6d70 6c61 7465 203d 2074 656d    template = tem
+00044ea0: 706c 6174 655f 656e 7669 726f 6e6d 656e  plate_environmen
+00044eb0: 742e 6765 745f 7465 6d70 6c61 7465 2822  t.get_template("
+00044ec0: 7065 7266 6f72 6d61 6e63 655f 7265 706f  performance_repo
+00044ed0: 7274 2e68 746d 6c22 290a 2020 2020 2020  rt.html").      
+00044ee0: 2020 2020 2020 7361 7665 2874 6162 732c        save(tabs,
+00044ef0: 2066 696c 656e 616d 653d 666e 2c20 7465   filename=fn, te
+00044f00: 6d70 6c61 7465 3d74 656d 706c 6174 6529  mplate=template)
+00044f10: 0a0a 2020 2020 2020 2020 2020 2020 7769  ..            wi
+00044f20: 7468 206f 7065 6e28 666e 2920 6173 2066  th open(fn) as f
+00044f30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00044f40: 2020 6461 7461 203d 2066 2e72 6561 6428    data = f.read(
+00044f50: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00044f60: 6e20 6461 7461 0a0a 2020 2020 6173 796e  n data..    asyn
+00044f70: 6320 6465 6620 6765 745f 776f 726b 6572  c def get_worker
+00044f80: 5f6c 6f67 7328 7365 6c66 2c20 6e3d 4e6f  _logs(self, n=No
+00044f90: 6e65 2c20 776f 726b 6572 733d 4e6f 6e65  ne, workers=None
+00044fa0: 2c20 6e61 6e6e 793d 4661 6c73 6529 3a0a  , nanny=False):.
+00044fb0: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
+00044fc0: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
+00044fd0: 6164 6361 7374 280a 2020 2020 2020 2020  adcast(.        
+00044fe0: 2020 2020 6d73 673d 7b22 6f70 223a 2022      msg={"op": "
+00044ff0: 6765 745f 6c6f 6773 222c 2022 6e22 3a20  get_logs", "n": 
+00045000: 6e7d 2c20 776f 726b 6572 733d 776f 726b  n}, workers=work
+00045010: 6572 732c 206e 616e 6e79 3d6e 616e 6e79  ers, nanny=nanny
+00045020: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00045030: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00045040: 730a 0a20 2020 2064 6566 206c 6f67 5f65  s..    def log_e
+00045050: 7665 6e74 2873 656c 662c 2074 6f70 6963  vent(self, topic
+00045060: 3a20 7374 7220 7c20 436f 6c6c 6563 7469  : str | Collecti
+00045070: 6f6e 5b73 7472 5d2c 206d 7367 3a20 416e  on[str], msg: An
+00045080: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
+00045090: 2020 2020 6576 656e 7420 3d20 2874 696d      event = (tim
+000450a0: 6528 292c 206d 7367 290a 2020 2020 2020  e(), msg).      
+000450b0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+000450c0: 6e63 6528 746f 7069 632c 2073 7472 293a  nce(topic, str):
+000450d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000450e0: 2074 2069 6e20 746f 7069 633a 0a20 2020   t in topic:.   
+000450f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00045100: 662e 6576 656e 7473 5b74 5d2e 6170 7065  f.events[t].appe
+00045110: 6e64 2865 7665 6e74 290a 2020 2020 2020  nd(event).      
+00045120: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00045130: 7665 6e74 5f63 6f75 6e74 735b 745d 202b  vent_counts[t] +
+00045140: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00045150: 2020 2020 7365 6c66 2e5f 7265 706f 7274      self._report
+00045160: 5f65 7665 6e74 2874 2c20 6576 656e 7429  _event(t, event)
+00045170: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00045180: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00045190: 6576 656e 7473 5b74 6f70 6963 5d2e 6170  events[topic].ap
+000451a0: 7065 6e64 2865 7665 6e74 290a 2020 2020  pend(event).    
+000451b0: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
+000451c0: 6e74 5f63 6f75 6e74 735b 746f 7069 635d  nt_counts[topic]
+000451d0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+000451e0: 2020 7365 6c66 2e5f 7265 706f 7274 5f65    self._report_e
+000451f0: 7665 6e74 2874 6f70 6963 2c20 6576 656e  vent(topic, even
+00045200: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+00045210: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
+00045220: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
+00045230: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
+00045240: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00045250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045260: 2020 2020 706c 7567 696e 2e6c 6f67 5f65      plugin.log_e
+00045270: 7665 6e74 2874 6f70 6963 2c20 6d73 6729  vent(topic, msg)
+00045280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045290: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000452a0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+000452b0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+000452c0: 666f 2822 506c 7567 696e 2066 6169 6c65  fo("Plugin faile
+000452d0: 6420 7769 7468 2065 7863 6570 7469 6f6e  d with exception
+000452e0: 222c 2065 7863 5f69 6e66 6f3d 5472 7565  ", exc_info=True
+000452f0: 290a 0a20 2020 2064 6566 205f 7265 706f  )..    def _repo
+00045300: 7274 5f65 7665 6e74 2873 656c 662c 206e  rt_event(self, n
+00045310: 616d 652c 2065 7665 6e74 293a 0a20 2020  ame, event):.   
+00045320: 2020 2020 206d 7367 203d 207b 0a20 2020       msg = {.   
+00045330: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
+00045340: 6576 656e 7422 2c0a 2020 2020 2020 2020  event",.        
+00045350: 2020 2020 2274 6f70 6963 223a 206e 616d      "topic": nam
+00045360: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+00045370: 6576 656e 7422 3a20 6576 656e 742c 0a20  event": event,. 
+00045380: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00045390: 2063 6c69 656e 745f 6d73 6773 203d 207b   client_msgs = {
+000453a0: 636c 6965 6e74 3a20 5b6d 7367 5d20 666f  client: [msg] fo
+000453b0: 7220 636c 6965 6e74 2069 6e20 7365 6c66  r client in self
+000453c0: 2e65 7665 6e74 5f73 7562 7363 7269 6265  .event_subscribe
+000453d0: 725b 6e61 6d65 5d7d 0a20 2020 2020 2020  r[name]}.       
+000453e0: 2073 656c 662e 7365 6e64 5f61 6c6c 2863   self.send_all(c
+000453f0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+00045400: 6572 5f6d 7367 733d 7b7d 290a 0a20 2020  er_msgs={})..   
+00045410: 2064 6566 2073 7562 7363 7269 6265 5f74   def subscribe_t
+00045420: 6f70 6963 2873 656c 662c 2074 6f70 6963  opic(self, topic
+00045430: 2c20 636c 6965 6e74 293a 0a20 2020 2020  , client):.     
+00045440: 2020 2073 656c 662e 6576 656e 745f 7375     self.event_su
+00045450: 6273 6372 6962 6572 5b74 6f70 6963 5d2e  bscriber[topic].
+00045460: 6164 6428 636c 6965 6e74 290a 0a20 2020  add(client)..   
+00045470: 2064 6566 2075 6e73 7562 7363 7269 6265   def unsubscribe
+00045480: 5f74 6f70 6963 2873 656c 662c 2074 6f70  _topic(self, top
+00045490: 6963 2c20 636c 6965 6e74 293a 0a20 2020  ic, client):.   
+000454a0: 2020 2020 2073 656c 662e 6576 656e 745f       self.event_
+000454b0: 7375 6273 6372 6962 6572 5b74 6f70 6963  subscriber[topic
+000454c0: 5d2e 6469 7363 6172 6428 636c 6965 6e74  ].discard(client
+000454d0: 290a 0a20 2020 2064 6566 2067 6574 5f65  )..    def get_e
+000454e0: 7665 6e74 7328 7365 6c66 2c20 746f 7069  vents(self, topi
+000454f0: 633d 4e6f 6e65 293a 0a20 2020 2020 2020  c=None):.       
+00045500: 2069 6620 746f 7069 6320 6973 206e 6f74   if topic is not
+00045510: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00045520: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+00045530: 7365 6c66 2e65 7665 6e74 735b 746f 7069  self.events[topi
+00045540: 635d 290a 2020 2020 2020 2020 656c 7365  c]).        else
+00045550: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00045560: 7475 726e 2076 616c 6d61 7028 7475 706c  turn valmap(tupl
+00045570: 652c 2073 656c 662e 6576 656e 7473 290a  e, self.events).
+00045580: 0a20 2020 2061 7379 6e63 2064 6566 2067  .    async def g
+00045590: 6574 5f77 6f72 6b65 725f 6d6f 6e69 746f  et_worker_monito
+000455a0: 725f 696e 666f 2873 656c 662c 2072 6563  r_info(self, rec
+000455b0: 656e 743d 4661 6c73 652c 2073 7461 7274  ent=False, start
+000455c0: 733d 4e6f 6e65 293a 0a20 2020 2020 2020  s=None):.       
+000455d0: 2069 6620 7374 6172 7473 2069 7320 4e6f   if starts is No
+000455e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000455f0: 7374 6172 7473 203d 207b 7d0a 2020 2020  starts = {}.    
+00045600: 2020 2020 7265 7375 6c74 7320 3d20 6177      results = aw
+00045610: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+00045620: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00045630: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+00045640: 2020 2073 656c 662e 7270 6328 7729 2e67     self.rpc(w).g
+00045650: 6574 5f6d 6f6e 6974 6f72 5f69 6e66 6f28  et_monitor_info(
+00045660: 7265 6365 6e74 3d72 6563 656e 742c 2073  recent=recent, s
+00045670: 7461 7274 3d73 7461 7274 732e 6765 7428  tart=starts.get(
+00045680: 772c 2030 2929 0a20 2020 2020 2020 2020  w, 0)).         
+00045690: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+000456a0: 7365 6c66 2e77 6f72 6b65 7273 0a20 2020  self.workers.   
+000456b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000456c0: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+000456d0: 7572 6e20 6469 6374 287a 6970 2873 656c  urn dict(zip(sel
+000456e0: 662e 776f 726b 6572 732c 2072 6573 756c  f.workers, resul
+000456f0: 7473 2929 0a0a 2020 2020 2323 2323 2323  ts))..    ######
+00045700: 2323 2323 230a 2020 2020 2320 436c 6561  #####.    # Clea
+00045710: 6e75 7020 230a 2020 2020 2323 2323 2323  nup #.    ######
+00045720: 2323 2323 230a 0a20 2020 2061 7379 6e63  #####..    async
+00045730: 2064 6566 2063 6865 636b 5f77 6f72 6b65   def check_worke
+00045740: 725f 7474 6c28 7365 6c66 293a 0a20 2020  r_ttl(self):.   
+00045750: 2020 2020 206e 6f77 203d 2074 696d 6528       now = time(
+00045760: 290a 2020 2020 2020 2020 7374 696d 756c  ).        stimul
+00045770: 7573 5f69 6420 3d20 6622 6368 6563 6b2d  us_id = f"check-
+00045780: 776f 726b 6572 2d74 746c 2d7b 6e6f 777d  worker-ttl-{now}
+00045790: 220a 2020 2020 2020 2020 666f 7220 7773  ".        for ws
+000457a0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+000457b0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+000457c0: 2020 2020 2020 2069 6620 2877 732e 6c61         if (ws.la
+000457d0: 7374 5f73 6565 6e20 3c20 6e6f 7720 2d20  st_seen < now - 
+000457e0: 7365 6c66 2e77 6f72 6b65 725f 7474 6c29  self.worker_ttl)
+000457f0: 2061 6e64 2028 0a20 2020 2020 2020 2020   and (.         
+00045800: 2020 2020 2020 2077 732e 6c61 7374 5f73         ws.last_s
+00045810: 6565 6e20 3c20 6e6f 7720 2d20 3130 202a  een < now - 10 *
+00045820: 2068 6561 7274 6265 6174 5f69 6e74 6572   heartbeat_inter
+00045830: 7661 6c28 6c65 6e28 7365 6c66 2e77 6f72  val(len(self.wor
+00045840: 6b65 7273 2929 0a20 2020 2020 2020 2020  kers)).         
+00045850: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00045860: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+00045870: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+00045880: 2020 2020 2020 2020 2020 2257 6f72 6b65            "Worke
+00045890: 7220 6661 696c 6564 2074 6f20 6865 6172  r failed to hear
+000458a0: 7462 6561 7420 7769 7468 696e 2025 7320  tbeat within %s 
+000458b0: 7365 636f 6e64 732e 2043 6c6f 7369 6e67  seconds. Closing
+000458c0: 3a20 2573 222c 0a20 2020 2020 2020 2020  : %s",.         
+000458d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000458e0: 776f 726b 6572 5f74 746c 2c0a 2020 2020  worker_ttl,.    
+000458f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045900: 7773 2c0a 2020 2020 2020 2020 2020 2020  ws,.            
+00045910: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00045920: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+00045930: 2e72 656d 6f76 655f 776f 726b 6572 2861  .remove_worker(a
+00045940: 6464 7265 7373 3d77 732e 6164 6472 6573  ddress=ws.addres
+00045950: 732c 2073 7469 6d75 6c75 735f 6964 3d73  s, stimulus_id=s
+00045960: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+00045970: 2064 6566 2063 6865 636b 5f69 646c 6528   def check_idle(
+00045980: 7365 6c66 2920 2d3e 2066 6c6f 6174 207c  self) -> float |
+00045990: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+000459a0: 6620 7365 6c66 2e73 7461 7475 7320 696e  f self.status in
+000459b0: 2028 5374 6174 7573 2e63 6c6f 7369 6e67   (Status.closing
+000459c0: 2c20 5374 6174 7573 2e63 6c6f 7365 6429  , Status.closed)
+000459d0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000459e0: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
+000459f0: 2020 2069 6620 7365 6c66 2e74 7261 6e73     if self.trans
+00045a00: 6974 696f 6e5f 636f 756e 7465 7220 213d  ition_counter !=
+00045a10: 2073 656c 662e 5f69 646c 655f 7472 616e   self._idle_tran
+00045a20: 7369 7469 6f6e 5f63 6f75 6e74 6572 3a0a  sition_counter:.
+00045a30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00045a40: 2e5f 6964 6c65 5f74 7261 6e73 6974 696f  ._idle_transitio
+00045a50: 6e5f 636f 756e 7465 7220 3d20 7365 6c66  n_counter = self
+00045a60: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+00045a70: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
+00045a80: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
+00045a90: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00045aa0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+00045ab0: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
+00045ac0: 2020 2020 2020 2020 2073 656c 662e 7175           self.qu
+00045ad0: 6575 6564 0a20 2020 2020 2020 2020 2020  eued.           
+00045ae0: 206f 7220 7365 6c66 2e75 6e72 756e 6e61   or self.unrunna
+00045af0: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
+00045b00: 6f72 2061 6e79 2877 732e 7072 6f63 6573  or any(ws.proces
+00045b10: 7369 6e67 2066 6f72 2077 7320 696e 2073  sing for ws in s
+00045b20: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
+00045b30: 6573 2829 290a 2020 2020 2020 2020 293a  es()).        ):
+00045b40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00045b50: 662e 6964 6c65 5f73 696e 6365 203d 204e  f.idle_since = N
+00045b60: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00045b70: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
+00045b80: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00045b90: 2e69 646c 655f 7369 6e63 653a 0a20 2020  .idle_since:.   
+00045ba0: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
+00045bb0: 6c65 5f73 696e 6365 203d 2074 696d 6528  le_since = time(
+00045bc0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00045bd0: 7475 726e 2073 656c 662e 6964 6c65 5f73  turn self.idle_s
+00045be0: 696e 6365 0a0a 2020 2020 2020 2020 6966  ince..        if
+00045bf0: 2073 656c 662e 6a75 7079 7465 723a 0a20   self.jupyter:. 
+00045c00: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+00045c10: 6163 7469 7669 7479 203d 2028 0a20 2020  activity = (.   
+00045c20: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00045c30: 662e 5f6a 7570 7974 6572 5f73 6572 7665  f._jupyter_serve
+00045c40: 725f 6170 706c 6963 6174 696f 6e2e 7765  r_application.we
+00045c50: 625f 6170 702e 6c61 7374 5f61 6374 6976  b_app.last_activ
+00045c60: 6974 7928 292e 7469 6d65 7374 616d 7028  ity().timestamp(
+00045c70: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
+00045c80: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00045c90: 6173 745f 6163 7469 7669 7479 203e 2073  ast_activity > s
+00045ca0: 656c 662e 6964 6c65 5f73 696e 6365 3a0a  elf.idle_since:.
+00045cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045cc0: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
+00045cd0: 3d20 6c61 7374 5f61 6374 6976 6974 790a  = last_activity.
+00045ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045cf0: 7265 7475 726e 2073 656c 662e 6964 6c65  return self.idle
+00045d00: 5f73 696e 6365 0a0a 2020 2020 2020 2020  _since..        
+00045d10: 6966 2073 656c 662e 6964 6c65 5f74 696d  if self.idle_tim
+00045d20: 656f 7574 3a0a 2020 2020 2020 2020 2020  eout:.          
+00045d30: 2020 6966 2074 696d 6528 2920 3e20 7365    if time() > se
+00045d40: 6c66 2e69 646c 655f 7369 6e63 6520 2b20  lf.idle_since + 
+00045d50: 7365 6c66 2e69 646c 655f 7469 6d65 6f75  self.idle_timeou
+00045d60: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00045d70: 2020 2061 7373 6572 7420 7365 6c66 2e69     assert self.i
+00045d80: 646c 655f 7369 6e63 650a 2020 2020 2020  dle_since.      
+00045d90: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00045da0: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
+00045db0: 2020 2020 2020 2020 2020 2022 5363 6865             "Sche
+00045dc0: 6475 6c65 7220 636c 6f73 696e 6720 6166  duler closing af
+00045dd0: 7465 7220 6265 696e 6720 6964 6c65 2066  ter being idle f
+00045de0: 6f72 2025 7322 2c0a 2020 2020 2020 2020  or %s",.        
+00045df0: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00045e00: 6174 5f74 696d 6528 7365 6c66 2e69 646c  at_time(self.idl
+00045e10: 655f 7469 6d65 6f75 7429 2c0a 2020 2020  e_timeout),.    
+00045e20: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00045e30: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00045e40: 6c66 2e5f 6f6e 676f 696e 675f 6261 636b  lf._ongoing_back
+00045e50: 6772 6f75 6e64 5f74 6173 6b73 2e63 616c  ground_tasks.cal
+00045e60: 6c5f 736f 6f6e 2873 656c 662e 636c 6f73  l_soon(self.clos
+00045e70: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+00045e80: 6e20 4e6f 6e65 0a0a 2020 2020 6465 6620  n None..    def 
+00045e90: 6164 6170 7469 7665 5f74 6172 6765 7428  adaptive_target(
+00045ea0: 7365 6c66 2c20 7461 7267 6574 5f64 7572  self, target_dur
+00045eb0: 6174 696f 6e3d 4e6f 6e65 293a 0a20 2020  ation=None):.   
+00045ec0: 2020 2020 2022 2222 4465 7369 7265 6420       """Desired 
+00045ed0: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
+00045ee0: 7320 6261 7365 6420 6f6e 2074 6865 2063  s based on the c
+00045ef0: 7572 7265 6e74 2077 6f72 6b6c 6f61 640a  urrent workload.
+00045f00: 0a20 2020 2020 2020 2054 6869 7320 6c6f  .        This lo
+00045f10: 6f6b 7320 6174 2074 6865 2063 7572 7265  oks at the curre
+00045f20: 6e74 2072 756e 6e69 6e67 2074 6173 6b73  nt running tasks
+00045f30: 2061 6e64 206d 656d 6f72 7920 7573 652c   and memory use,
+00045f40: 2061 6e64 2072 6574 7572 6e73 2061 0a20   and returns a. 
+00045f50: 2020 2020 2020 206e 756d 6265 7220 6f66         number of
+00045f60: 2064 6573 6972 6564 2077 6f72 6b65 7273   desired workers
+00045f70: 2e20 2054 6869 7320 6973 206f 6674 656e  .  This is often
+00045f80: 2075 7365 6420 6279 2061 6461 7074 6976   used by adaptiv
+00045f90: 6520 7363 6865 6475 6c69 6e67 2e0a 0a20  e scheduling... 
+00045fa0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+00045fb0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00045fc0: 2d2d 2d2d 0a20 2020 2020 2020 2074 6172  ----.        tar
+00045fd0: 6765 745f 6475 7261 7469 6f6e 203a 2073  get_duration : s
+00045fe0: 7472 0a20 2020 2020 2020 2020 2020 2041  tr.            A
+00045ff0: 2064 6573 6972 6564 2064 7572 6174 696f   desired duratio
+00046000: 6e20 6f66 2074 696d 6520 666f 7220 636f  n of time for co
+00046010: 6d70 7574 6174 696f 6e73 2074 6f20 7461  mputations to ta
+00046020: 6b65 2e20 2054 6869 7320 6166 6665 6374  ke.  This affect
+00046030: 730a 2020 2020 2020 2020 2020 2020 686f  s.            ho
+00046040: 7720 7261 7069 646c 7920 7468 6520 7363  w rapidly the sc
+00046050: 6865 6475 6c65 7220 7769 6c6c 2061 736b  heduler will ask
+00046060: 2074 6f20 7363 616c 652e 0a0a 2020 2020   to scale...    
+00046070: 2020 2020 5365 6520 416c 736f 0a20 2020      See Also.   
+00046080: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00046090: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
+000460a0: 642e 6465 706c 6f79 2e41 6461 7074 6976  d.deploy.Adaptiv
+000460b0: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
+000460c0: 2020 2020 2020 6966 2074 6172 6765 745f        if target_
+000460d0: 6475 7261 7469 6f6e 2069 7320 4e6f 6e65  duration is None
+000460e0: 3a0a 2020 2020 2020 2020 2020 2020 7461  :.            ta
+000460f0: 7267 6574 5f64 7572 6174 696f 6e20 3d20  rget_duration = 
+00046100: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+00046110: 2264 6973 7472 6962 7574 6564 2e61 6461  "distributed.ada
+00046120: 7074 6976 652e 7461 7267 6574 2d64 7572  ptive.target-dur
+00046130: 6174 696f 6e22 290a 2020 2020 2020 2020  ation").        
+00046140: 7461 7267 6574 5f64 7572 6174 696f 6e20  target_duration 
+00046150: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
+00046160: 6128 7461 7267 6574 5f64 7572 6174 696f  a(target_duratio
+00046170: 6e29 0a0a 2020 2020 2020 2020 2320 4350  n)..        # CP
+00046180: 550a 0a20 2020 2020 2020 2023 2054 4f44  U..        # TOD
+00046190: 4f20 636f 6e73 6964 6572 2061 6e79 2075  O consider any u
+000461a0: 7365 722d 7370 6563 6966 6965 6420 6465  ser-specified de
+000461b0: 6661 756c 7420 7461 736b 2064 7572 6174  fault task durat
+000461c0: 696f 6e73 2066 6f72 2071 7565 7565 6420  ions for queued 
+000461d0: 7461 736b 730a 2020 2020 2020 2020 7175  tasks.        qu
+000461e0: 6575 6564 5f6f 6363 7570 616e 6379 203d  eued_occupancy =
+000461f0: 206c 656e 2873 656c 662e 7175 6575 6564   len(self.queued
+00046200: 2920 2a20 7365 6c66 2e55 4e4b 4e4f 574e  ) * self.UNKNOWN
+00046210: 5f54 4153 4b5f 4455 5241 5449 4f4e 0a20  _TASK_DURATION. 
+00046220: 2020 2020 2020 2063 7075 203d 206d 6174         cpu = mat
+00046230: 682e 6365 696c 280a 2020 2020 2020 2020  h.ceil(.        
+00046240: 2020 2020 2873 656c 662e 746f 7461 6c5f      (self.total_
+00046250: 6f63 6375 7061 6e63 7920 2b20 7175 6575  occupancy + queu
+00046260: 6564 5f6f 6363 7570 616e 6379 2920 2f20  ed_occupancy) / 
+00046270: 7461 7267 6574 5f64 7572 6174 696f 6e0a  target_duration.
+00046280: 2020 2020 2020 2020 2920 2023 2054 4f44          )  # TOD
+00046290: 4f3a 2074 6872 6561 6473 2070 6572 2077  O: threads per w
+000462a0: 6f72 6b65 720a 0a20 2020 2020 2020 2023  orker..        #
+000462b0: 2041 766f 6964 2061 2066 6577 206c 6f6e   Avoid a few lon
+000462c0: 6720 7461 736b 7320 6672 6f6d 2061 736b  g tasks from ask
+000462d0: 696e 6720 666f 7220 6d61 6e79 2063 6f72  ing for many cor
+000462e0: 6573 0a20 2020 2020 2020 2074 6173 6b73  es.        tasks
+000462f0: 5f72 6561 6479 203d 206c 656e 2873 656c  _ready = len(sel
+00046300: 662e 7175 6575 6564 290a 2020 2020 2020  f.queued).      
+00046310: 2020 666f 7220 7773 2069 6e20 7365 6c66    for ws in self
+00046320: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00046330: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00046340: 6173 6b73 5f72 6561 6479 202b 3d20 6c65  asks_ready += le
+00046350: 6e28 7773 2e70 726f 6365 7373 696e 6729  n(ws.processing)
+00046360: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00046370: 2074 6173 6b73 5f72 6561 6479 203e 2063   tasks_ready > c
+00046380: 7075 3a0a 2020 2020 2020 2020 2020 2020  pu:.            
+00046390: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+000463a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000463b0: 2020 2020 6370 7520 3d20 6d69 6e28 7461      cpu = min(ta
+000463c0: 736b 735f 7265 6164 792c 2063 7075 290a  sks_ready, cpu).
+000463d0: 0a20 2020 2020 2020 2069 6620 2873 656c  .        if (sel
+000463e0: 662e 756e 7275 6e6e 6162 6c65 206f 7220  f.unrunnable or 
+000463f0: 7365 6c66 2e71 7565 7565 6429 2061 6e64  self.queued) and
+00046400: 206e 6f74 2073 656c 662e 776f 726b 6572   not self.worker
+00046410: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
+00046420: 7075 203d 206d 6178 2831 2c20 6370 7529  pu = max(1, cpu)
+00046430: 0a0a 2020 2020 2020 2020 2320 6164 6420  ..        # add 
+00046440: 6d6f 7265 2077 6f72 6b65 7273 2069 6620  more workers if 
+00046450: 6d6f 7265 2074 6861 6e20 3630 2520 6f66  more than 60% of
+00046460: 206d 656d 6f72 7920 6973 2075 7365 640a   memory is used.
+00046470: 2020 2020 2020 2020 6c69 6d69 7420 3d20          limit = 
+00046480: 7375 6d28 7773 2e6d 656d 6f72 795f 6c69  sum(ws.memory_li
+00046490: 6d69 7420 666f 7220 7773 2069 6e20 7365  mit for ws in se
+000464a0: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+000464b0: 7328 2929 0a20 2020 2020 2020 2075 7365  s()).        use
+000464c0: 6420 3d20 7375 6d28 7773 2e6e 6279 7465  d = sum(ws.nbyte
+000464d0: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
+000464e0: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+000464f0: 2929 0a20 2020 2020 2020 206d 656d 6f72  )).        memor
+00046500: 7920 3d20 300a 2020 2020 2020 2020 6966  y = 0.        if
+00046510: 2075 7365 6420 3e20 302e 3620 2a20 6c69   used > 0.6 * li
+00046520: 6d69 7420 616e 6420 6c69 6d69 7420 3e20  mit and limit > 
+00046530: 303a 0a20 2020 2020 2020 2020 2020 206d  0:.            m
+00046540: 656d 6f72 7920 3d20 3220 2a20 6c65 6e28  emory = 2 * len(
+00046550: 7365 6c66 2e77 6f72 6b65 7273 290a 0a20  self.workers).. 
+00046560: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
+00046570: 6d61 7828 6d65 6d6f 7279 2c20 6370 7529  max(memory, cpu)
+00046580: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
+00046590: 6574 203e 3d20 6c65 6e28 7365 6c66 2e77  et >= len(self.w
+000465a0: 6f72 6b65 7273 293a 0a20 2020 2020 2020  orkers):.       
+000465b0: 2020 2020 2072 6574 7572 6e20 7461 7267       return targ
+000465c0: 6574 0a20 2020 2020 2020 2065 6c73 653a  et.        else:
+000465d0: 2020 2320 5363 616c 6520 646f 776e 3f0a    # Scale down?.
+000465e0: 2020 2020 2020 2020 2020 2020 746f 5f63              to_c
+000465f0: 6c6f 7365 203d 2073 656c 662e 776f 726b  lose = self.work
+00046600: 6572 735f 746f 5f63 6c6f 7365 2829 0a20  ers_to_close(). 
+00046610: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00046620: 6e20 6c65 6e28 7365 6c66 2e77 6f72 6b65  n len(self.worke
+00046630: 7273 2920 2d20 6c65 6e28 746f 5f63 6c6f  rs) - len(to_clo
+00046640: 7365 290a 0a20 2020 2064 6566 2072 6571  se)..    def req
+00046650: 7565 7374 5f61 6371 7569 7265 5f72 6570  uest_acquire_rep
+00046660: 6c69 6361 7328 0a20 2020 2020 2020 2073  licas(.        s
+00046670: 656c 662c 2061 6464 723a 2073 7472 2c20  elf, addr: str, 
+00046680: 6b65 7973 3a20 4974 6572 6162 6c65 5b73  keys: Iterable[s
+00046690: 7472 5d2c 202a 2c20 7374 696d 756c 7573  tr], *, stimulus
+000466a0: 5f69 643a 2073 7472 0a20 2020 2029 202d  _id: str.    ) -
+000466b0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000466c0: 2222 2241 7379 6e63 6872 6f6e 6f75 736c  """Asynchronousl
+000466d0: 7920 6173 6b20 6120 776f 726b 6572 2074  y ask a worker t
+000466e0: 6f20 6163 7175 6972 6520 6120 7265 706c  o acquire a repl
+000466f0: 6963 6120 6f66 2074 6865 206c 6973 7465  ica of the liste
+00046700: 6420 6b65 7973 2066 726f 6d0a 2020 2020  d keys from.    
+00046710: 2020 2020 6f74 6865 7220 776f 726b 6572      other worker
+00046720: 732e 2054 6869 7320 6973 2061 2066 6972  s. This is a fir
+00046730: 652d 616e 642d 666f 7267 6574 206f 7065  e-and-forget ope
+00046740: 7261 7469 6f6e 2077 6869 6368 206f 6666  ration which off
+00046750: 6572 7320 6e6f 2066 6565 6462 6163 6b20  ers no feedback 
+00046760: 666f 720a 2020 2020 2020 2020 7375 6363  for.        succ
+00046770: 6573 7320 6f72 2066 6169 6c75 7265 2c20  ess or failure, 
+00046780: 616e 6420 6973 2069 6e74 656e 6465 6420  and is intended 
+00046790: 666f 7220 686f 7573 656b 6565 7069 6e67  for housekeeping
+000467a0: 2061 6e64 206e 6f74 2066 6f72 2063 6f6d   and not for com
+000467b0: 7075 7461 7469 6f6e 2e0a 2020 2020 2020  putation..      
+000467c0: 2020 2222 220a 2020 2020 2020 2020 7768    """.        wh
+000467d0: 6f5f 6861 7320 3d20 7b7d 0a20 2020 2020  o_has = {}.     
+000467e0: 2020 206e 6279 7465 7320 3d20 7b7d 0a20     nbytes = {}. 
+000467f0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00046800: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+00046810: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00046820: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+00046830: 2020 2020 2061 7373 6572 7420 7473 2e77       assert ts.w
+00046840: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+00046850: 2020 2077 686f 5f68 6173 5b6b 6579 5d20     who_has[key] 
+00046860: 3d20 5b77 732e 6164 6472 6573 7320 666f  = [ws.address fo
+00046870: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
+00046880: 6173 5d0a 2020 2020 2020 2020 2020 2020  as].            
+00046890: 6e62 7974 6573 5b6b 6579 5d20 3d20 7473  nbytes[key] = ts
+000468a0: 2e6e 6279 7465 730a 0a20 2020 2020 2020  .nbytes..       
+000468b0: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
+000468c0: 6d73 5b61 6464 725d 2e73 656e 6428 0a20  ms[addr].send(. 
+000468d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000468e0: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
+000468f0: 223a 2022 6163 7175 6972 652d 7265 706c  ": "acquire-repl
+00046900: 6963 6173 222c 0a20 2020 2020 2020 2020  icas",.         
+00046910: 2020 2020 2020 2022 7768 6f5f 6861 7322         "who_has"
+00046920: 3a20 7768 6f5f 6861 732c 0a20 2020 2020  : who_has,.     
+00046930: 2020 2020 2020 2020 2020 2022 6e62 7974             "nbyt
+00046940: 6573 223a 206e 6279 7465 732c 0a20 2020  es": nbytes,.   
+00046950: 2020 2020 2020 2020 2020 2020 2022 7374               "st
+00046960: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
+00046970: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
+00046980: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00046990: 290a 0a20 2020 2064 6566 2072 6571 7565  )..    def reque
+000469a0: 7374 5f72 656d 6f76 655f 7265 706c 6963  st_remove_replic
+000469b0: 6173 280a 2020 2020 2020 2020 7365 6c66  as(.        self
+000469c0: 2c20 6164 6472 3a20 7374 722c 206b 6579  , addr: str, key
+000469d0: 733a 206c 6973 745b 7374 725d 2c20 2a2c  s: list[str], *,
+000469e0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+000469f0: 720a 2020 2020 2920 2d3e 204e 6f6e 653a  r.    ) -> None:
+00046a00: 0a20 2020 2020 2020 2022 2222 4173 796e  .        """Asyn
+00046a10: 6368 726f 6e6f 7573 6c79 2061 736b 2061  chronously ask a
+00046a20: 2077 6f72 6b65 7220 746f 2064 6973 6361   worker to disca
+00046a30: 7264 2069 7473 2072 6570 6c69 6361 206f  rd its replica o
+00046a40: 6620 7468 6520 6c69 7374 6564 206b 6579  f the listed key
+00046a50: 732e 0a20 2020 2020 2020 2054 6869 7320  s..        This 
+00046a60: 6d75 7374 206e 6576 6572 2062 6520 7573  must never be us
+00046a70: 6564 2074 6f20 6465 7374 726f 7920 7468  ed to destroy th
+00046a80: 6520 6c61 7374 2072 6570 6c69 6361 206f  e last replica o
+00046a90: 6620 6120 6b65 792e 2054 6869 7320 6973  f a key. This is
+00046aa0: 2061 0a20 2020 2020 2020 2066 6972 652d   a.        fire-
+00046ab0: 616e 642d 666f 7267 6574 206f 7065 7261  and-forget opera
+00046ac0: 7469 6f6e 2c20 696e 7465 6e64 6564 2066  tion, intended f
+00046ad0: 6f72 2068 6f75 7365 6b65 6570 696e 6720  or housekeeping 
+00046ae0: 616e 6420 6e6f 7420 666f 7220 636f 6d70  and not for comp
+00046af0: 7574 6174 696f 6e2e 0a0a 2020 2020 2020  utation...      
+00046b00: 2020 5468 6520 7265 706c 6963 6120 6469    The replica di
+00046b10: 7361 7070 6561 7273 2069 6d6d 6564 6961  sappears immedia
+00046b20: 7465 6c79 2066 726f 6d20 5461 736b 5374  tely from TaskSt
+00046b30: 6174 652e 7768 6f5f 6861 7320 6f6e 2074  ate.who_has on t
+00046b40: 6865 2053 6368 6564 756c 6572 2073 6964  he Scheduler sid
+00046b50: 653b 0a20 2020 2020 2020 2069 6620 7468  e;.        if th
+00046b60: 6520 776f 726b 6572 2072 6566 7573 6573  e worker refuses
+00046b70: 2074 6f20 6465 6c65 7465 2c20 652e 672e   to delete, e.g.
+00046b80: 2062 6563 6175 7365 2074 6865 2074 6173   because the tas
+00046b90: 6b20 6973 2061 2064 6570 656e 6465 6e63  k is a dependenc
+00046ba0: 7920 6f66 0a20 2020 2020 2020 2061 6e6f  y of.        ano
+00046bb0: 7468 6572 2074 6173 6b20 7275 6e6e 696e  ther task runnin
+00046bc0: 6720 6f6e 2069 742c 2069 7420 7769 6c6c  g on it, it will
+00046bd0: 2028 616c 736f 2061 7379 6e63 6872 6f6e   (also asynchron
+00046be0: 6f75 736c 7929 2069 6e66 6f72 6d20 7468  ously) inform th
+00046bf0: 6520 7363 6865 6475 6c65 720a 2020 2020  e scheduler.    
+00046c00: 2020 2020 746f 2072 652d 6164 6420 6974      to re-add it
+00046c10: 7365 6c66 2074 6f20 7768 6f5f 6861 732e  self to who_has.
+00046c20: 2049 6620 7468 6520 776f 726b 6572 2061   If the worker a
+00046c30: 6772 6565 7320 746f 2064 6973 6361 7264  grees to discard
+00046c40: 2074 6865 2074 6173 6b2c 2074 6865 7265   the task, there
+00046c50: 2069 730a 2020 2020 2020 2020 6e6f 2066   is.        no f
+00046c60: 6565 6462 6163 6b2e 0a20 2020 2020 2020  eedback..       
+00046c70: 2022 2222 0a20 2020 2020 2020 2077 7320   """.        ws 
+00046c80: 3d20 7365 6c66 2e77 6f72 6b65 7273 5b61  = self.workers[a
+00046c90: 6464 725d 0a0a 2020 2020 2020 2020 2320  ddr]..        # 
+00046ca0: 5468 6520 7363 6865 6475 6c65 7220 696d  The scheduler im
+00046cb0: 6d65 6469 6174 656c 7920 666f 7267 6574  mediately forget
+00046cc0: 7320 6162 6f75 7420 7468 6520 7265 706c  s about the repl
+00046cd0: 6963 6120 616e 6420 7375 6767 6573 7473  ica and suggests
+00046ce0: 2074 6865 2077 6f72 6b65 7220 746f 0a20   the worker to. 
+00046cf0: 2020 2020 2020 2023 2064 726f 7020 6974         # drop it
+00046d00: 2e20 5468 6520 776f 726b 6572 206d 6179  . The worker may
+00046d10: 2072 6566 7573 652c 2061 7420 7768 6963   refuse, at whic
+00046d20: 6820 706f 696e 7420 6974 2077 696c 6c20  h point it will 
+00046d30: 7365 6e64 2062 6163 6b20 616e 2061 6464  send back an add
+00046d40: 2d6b 6579 730a 2020 2020 2020 2020 2320  -keys.        # 
+00046d50: 6d65 7373 6167 6520 746f 2072 6569 6e73  message to reins
+00046d60: 7461 7465 2069 742e 0a20 2020 2020 2020  tate it..       
+00046d70: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
+00046d80: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+00046d90: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+00046da0: 795d 0a20 2020 2020 2020 2020 2020 2069  y].            i
+00046db0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00046dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046dd0: 2023 2044 6f20 6e6f 7420 6465 7374 726f   # Do not destro
+00046de0: 7920 7468 6520 6c61 7374 2063 6f70 790a  y the last copy.
+00046df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046e00: 6173 7365 7274 206c 656e 2874 732e 7768  assert len(ts.wh
+00046e10: 6f5f 6861 7329 203e 2031 0a20 2020 2020  o_has) > 1.     
+00046e20: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+00046e30: 7665 5f72 6570 6c69 6361 2874 732c 2077  ve_replica(ts, w
+00046e40: 7329 0a0a 2020 2020 2020 2020 7365 6c66  s)..        self
+00046e50: 2e73 7472 6561 6d5f 636f 6d6d 735b 6164  .stream_comms[ad
+00046e60: 6472 5d2e 7365 6e64 280a 2020 2020 2020  dr].send(.      
+00046e70: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00046e80: 2020 2020 2020 2020 226f 7022 3a20 2272          "op": "r
+00046e90: 656d 6f76 652d 7265 706c 6963 6173 222c  emove-replicas",
+00046ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046eb0: 2022 6b65 7973 223a 206b 6579 732c 0a20   "keys": keys,. 
+00046ec0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00046ed0: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
+00046ee0: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+00046ef0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00046f00: 2029 0a0a 0a64 6566 205f 7461 736b 5f74   )...def _task_t
+00046f10: 6f5f 7265 706f 7274 5f6d 7367 2874 733a  o_report_msg(ts:
+00046f20: 2054 6173 6b53 7461 7465 2920 2d3e 2064   TaskState) -> d
+00046f30: 6963 745b 7374 722c 2041 6e79 5d20 7c20  ict[str, Any] | 
+00046f40: 4e6f 6e65 3a0a 2020 2020 6966 2074 732e  None:.    if ts.
+00046f50: 7374 6174 6520 3d3d 2022 666f 7267 6f74  state == "forgot
+00046f60: 7465 6e22 3a0a 2020 2020 2020 2020 7265  ten":.        re
+00046f70: 7475 726e 207b 226f 7022 3a20 2263 616e  turn {"op": "can
+00046f80: 6365 6c6c 6564 2d6b 6579 7322 2c20 226b  celled-keys", "k
+00046f90: 6579 7322 3a20 5b74 732e 6b65 795d 7d0a  eys": [ts.key]}.
+00046fa0: 2020 2020 656c 6966 2074 732e 7374 6174      elif ts.stat
+00046fb0: 6520 3d3d 2022 6d65 6d6f 7279 223a 0a20  e == "memory":. 
+00046fc0: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+00046fd0: 6f70 223a 2022 6b65 792d 696e 2d6d 656d  op": "key-in-mem
+00046fe0: 6f72 7922 2c20 226b 6579 223a 2074 732e  ory", "key": ts.
+00046ff0: 6b65 797d 0a20 2020 2065 6c69 6620 7473  key}.    elif ts
+00047000: 2e73 7461 7465 203d 3d20 2265 7272 6564  .state == "erred
+00047010: 223a 0a20 2020 2020 2020 2066 6169 6c69  ":.        faili
+00047020: 6e67 5f74 7320 3d20 7473 2e65 7863 6570  ng_ts = ts.excep
+00047030: 7469 6f6e 5f62 6c61 6d65 0a20 2020 2020  tion_blame.     
+00047040: 2020 2061 7373 6572 7420 6661 696c 696e     assert failin
+00047050: 675f 7473 0a20 2020 2020 2020 2072 6574  g_ts.        ret
+00047060: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
+00047070: 2020 226f 7022 3a20 2274 6173 6b2d 6572    "op": "task-er
+00047080: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
+00047090: 2020 226b 6579 223a 2074 732e 6b65 792c    "key": ts.key,
+000470a0: 0a20 2020 2020 2020 2020 2020 2022 6578  .            "ex
+000470b0: 6365 7074 696f 6e22 3a20 6661 696c 696e  ception": failin
+000470c0: 675f 7473 2e65 7863 6570 7469 6f6e 2c0a  g_ts.exception,.
+000470d0: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
+000470e0: 6365 6261 636b 223a 2066 6169 6c69 6e67  ceback": failing
+000470f0: 5f74 732e 7472 6163 6562 6163 6b2c 0a20  _ts.traceback,. 
+00047100: 2020 2020 2020 207d 0a20 2020 2065 6c73         }.    els
+00047110: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+00047120: 6e20 4e6f 6e65 0a0a 0a64 6566 205f 7461  n None...def _ta
+00047130: 736b 5f74 6f5f 636c 6965 6e74 5f6d 7367  sk_to_client_msg
+00047140: 7328 7473 3a20 5461 736b 5374 6174 6529  s(ts: TaskState)
+00047150: 202d 3e20 6469 6374 5b73 7472 2c20 6c69   -> dict[str, li
+00047160: 7374 5b64 6963 745b 7374 722c 2041 6e79  st[dict[str, Any
+00047170: 5d5d 5d3a 0a20 2020 2069 6620 7473 2e77  ]]]:.    if ts.w
+00047180: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
+00047190: 2020 7265 706f 7274 5f6d 7367 203d 205f    report_msg = _
+000471a0: 7461 736b 5f74 6f5f 7265 706f 7274 5f6d  task_to_report_m
+000471b0: 7367 2874 7329 0a20 2020 2020 2020 2069  sg(ts).        i
+000471c0: 6620 7265 706f 7274 5f6d 7367 2069 7320  f report_msg is 
+000471d0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000471e0: 2020 2020 2020 7265 7475 726e 207b 6373        return {cs
+000471f0: 2e63 6c69 656e 745f 6b65 793a 205b 7265  .client_key: [re
+00047200: 706f 7274 5f6d 7367 5d20 666f 7220 6373  port_msg] for cs
+00047210: 2069 6e20 7473 2e77 686f 5f77 616e 7473   in ts.who_wants
+00047220: 7d0a 2020 2020 7265 7475 726e 207b 7d0a  }.    return {}.
+00047230: 0a0a 6465 6620 6465 6369 6465 5f77 6f72  ..def decide_wor
+00047240: 6b65 7228 0a20 2020 2074 733a 2054 6173  ker(.    ts: Tas
+00047250: 6b53 7461 7465 2c0a 2020 2020 616c 6c5f  kState,.    all_
+00047260: 776f 726b 6572 733a 2049 7465 7261 626c  workers: Iterabl
+00047270: 655b 576f 726b 6572 5374 6174 655d 2c0a  e[WorkerState],.
+00047280: 2020 2020 7661 6c69 645f 776f 726b 6572      valid_worker
+00047290: 733a 2073 6574 5b57 6f72 6b65 7253 7461  s: set[WorkerSta
+000472a0: 7465 5d20 7c20 4e6f 6e65 2c0a 2020 2020  te] | None,.    
+000472b0: 6f62 6a65 6374 6976 653a 2043 616c 6c61  objective: Calla
+000472c0: 626c 655b 5b57 6f72 6b65 7253 7461 7465  ble[[WorkerState
+000472d0: 5d2c 2041 6e79 5d2c 0a29 202d 3e20 576f  ], Any],.) -> Wo
+000472e0: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
+000472f0: 3a0a 2020 2020 2222 220a 2020 2020 4465  :.    """.    De
+00047300: 6369 6465 2077 6869 6368 2077 6f72 6b65  cide which worke
+00047310: 7220 7368 6f75 6c64 2074 616b 6520 7461  r should take ta
+00047320: 736b 202a 7473 2a2e 0a0a 2020 2020 5765  sk *ts*...    We
+00047330: 2063 686f 6f73 6520 7468 6520 776f 726b   choose the work
+00047340: 6572 2074 6861 7420 6861 7320 7468 6520  er that has the 
+00047350: 6461 7461 206f 6e20 7768 6963 6820 2a74  data on which *t
+00047360: 732a 2064 6570 656e 6473 2e0a 0a20 2020  s* depends...   
+00047370: 2049 6620 7365 7665 7261 6c20 776f 726b   If several work
+00047380: 6572 7320 6861 7665 2064 6570 656e 6465  ers have depende
+00047390: 6e63 6965 7320 7468 656e 2077 6520 6368  ncies then we ch
+000473a0: 6f6f 7365 2074 6865 206c 6573 732d 6275  oose the less-bu
+000473b0: 7379 2077 6f72 6b65 722e 0a0a 2020 2020  sy worker...    
+000473c0: 4f70 7469 6f6e 616c 6c79 2070 726f 7669  Optionally provi
+000473d0: 6465 202a 7661 6c69 645f 776f 726b 6572  de *valid_worker
+000473e0: 732a 206f 6620 7768 6572 6520 6a6f 6273  s* of where jobs
+000473f0: 2061 7265 2061 6c6c 6f77 6564 2074 6f20   are allowed to 
+00047400: 6f63 6375 720a 2020 2020 2869 6620 616c  occur.    (if al
+00047410: 6c20 776f 726b 6572 7320 6172 6520 616c  l workers are al
+00047420: 6c6f 7765 6420 746f 2074 616b 6520 7468  lowed to take th
+00047430: 6520 7461 736b 2c20 7061 7373 204e 6f6e  e task, pass Non
+00047440: 6520 696e 7374 6561 6429 2e0a 0a20 2020  e instead)...   
+00047450: 2049 6620 7468 6520 7461 736b 2072 6571   If the task req
+00047460: 7569 7265 7320 6461 7461 2063 6f6d 6d75  uires data commu
+00047470: 6e69 6361 7469 6f6e 2062 6563 6175 7365  nication because
+00047480: 206e 6f20 656c 6967 6962 6c65 2077 6f72   no eligible wor
+00047490: 6b65 7220 6861 730a 2020 2020 616c 6c20  ker has.    all 
+000474a0: 7468 6520 6465 7065 6e64 656e 6369 6573  the dependencies
+000474b0: 2061 6c72 6561 6479 2c20 7468 656e 2077   already, then w
+000474c0: 6520 6368 6f6f 7365 2074 6f20 6d69 6e69  e choose to mini
+000474d0: 6d69 7a65 2074 6865 206e 756d 6265 720a  mize the number.
+000474e0: 2020 2020 6f66 2062 7974 6573 2073 656e      of bytes sen
+000474f0: 7420 6265 7477 6565 6e20 776f 726b 6572  t between worker
+00047500: 732e 2020 5468 6973 2069 7320 6465 7465  s.  This is dete
+00047510: 726d 696e 6564 2062 7920 6361 6c6c 696e  rmined by callin
+00047520: 6720 7468 650a 2020 2020 2a6f 626a 6563  g the.    *objec
+00047530: 7469 7665 2a20 6675 6e63 7469 6f6e 2e0a  tive* function..
+00047540: 2020 2020 2222 220a 2020 2020 6173 7365      """.    asse
+00047550: 7274 2061 6c6c 2864 7473 2e77 686f 5f68  rt all(dts.who_h
+00047560: 6173 2066 6f72 2064 7473 2069 6e20 7473  as for dts in ts
+00047570: 2e64 6570 656e 6465 6e63 6965 7329 0a20  .dependencies). 
+00047580: 2020 2069 6620 7473 2e61 6374 6f72 3a0a     if ts.actor:.
+00047590: 2020 2020 2020 2020 6361 6e64 6964 6174          candidat
+000475a0: 6573 203d 2073 6574 2861 6c6c 5f77 6f72  es = set(all_wor
+000475b0: 6b65 7273 290a 2020 2020 656c 7365 3a0a  kers).    else:.
+000475c0: 2020 2020 2020 2020 6361 6e64 6964 6174          candidat
+000475d0: 6573 203d 207b 7777 7320 666f 7220 6474  es = {wws for dt
+000475e0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+000475f0: 6369 6573 2066 6f72 2077 7773 2069 6e20  cies for wws in 
+00047600: 6474 732e 7768 6f5f 6861 737d 0a20 2020  dts.who_has}.   
+00047610: 2069 6620 7661 6c69 645f 776f 726b 6572   if valid_worker
+00047620: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00047630: 2020 2069 6620 6e6f 7420 6361 6e64 6964     if not candid
+00047640: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
+00047650: 2020 6361 6e64 6964 6174 6573 203d 2073    candidates = s
+00047660: 6574 2861 6c6c 5f77 6f72 6b65 7273 290a  et(all_workers).
+00047670: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00047680: 2020 6361 6e64 6964 6174 6573 2026 3d20    candidates &= 
+00047690: 7661 6c69 645f 776f 726b 6572 730a 2020  valid_workers.  
+000476a0: 2020 2020 2020 6966 206e 6f74 2063 616e        if not can
+000476b0: 6469 6461 7465 733a 0a20 2020 2020 2020  didates:.       
+000476c0: 2020 2020 2063 616e 6469 6461 7465 7320       candidates 
+000476d0: 3d20 7661 6c69 645f 776f 726b 6572 730a  = valid_workers.
+000476e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000476f0: 6f74 2063 616e 6469 6461 7465 733a 0a20  ot candidates:. 
+00047700: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00047710: 6620 7473 2e6c 6f6f 7365 5f72 6573 7472  f ts.loose_restr
+00047720: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
+00047730: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00047740: 7572 6e20 6465 6369 6465 5f77 6f72 6b65  urn decide_worke
+00047750: 7228 7473 2c20 616c 6c5f 776f 726b 6572  r(ts, all_worker
+00047760: 732c 204e 6f6e 652c 206f 626a 6563 7469  s, None, objecti
+00047770: 7665 290a 0a20 2020 2069 6620 6e6f 7420  ve)..    if not 
+00047780: 6361 6e64 6964 6174 6573 3a0a 2020 2020  candidates:.    
+00047790: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+000477a0: 2020 2020 656c 6966 206c 656e 2863 616e      elif len(can
+000477b0: 6469 6461 7465 7329 203d 3d20 313a 0a20  didates) == 1:. 
+000477c0: 2020 2020 2020 2072 6574 7572 6e20 6e65         return ne
+000477d0: 7874 2869 7465 7228 6361 6e64 6964 6174  xt(iter(candidat
+000477e0: 6573 2929 0a20 2020 2065 6c73 653a 0a20  es)).    else:. 
+000477f0: 2020 2020 2020 2072 6574 7572 6e20 6d69         return mi
+00047800: 6e28 6361 6e64 6964 6174 6573 2c20 6b65  n(candidates, ke
+00047810: 793d 6f62 6a65 6374 6976 6529 0a0a 0a64  y=objective)...d
+00047820: 6566 2076 616c 6964 6174 655f 7461 736b  ef validate_task
+00047830: 5f73 7461 7465 2874 733a 2054 6173 6b53  _state(ts: TaskS
+00047840: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+00047850: 2020 2022 2222 5661 6c69 6461 7465 2074     """Validate t
+00047860: 6865 2067 6976 656e 2054 6173 6b53 7461  he given TaskSta
+00047870: 7465 2222 220a 2020 2020 6173 7365 7274  te""".    assert
+00047880: 2074 732e 7374 6174 6520 696e 2041 4c4c   ts.state in ALL
+00047890: 5f54 4153 4b5f 5354 4154 4553 2c20 7473  _TASK_STATES, ts
+000478a0: 0a0a 2020 2020 6966 2074 732e 7761 6974  ..    if ts.wait
+000478b0: 696e 675f 6f6e 3a0a 2020 2020 2020 2020  ing_on:.        
+000478c0: 6173 7365 7274 2074 732e 7761 6974 696e  assert ts.waitin
+000478d0: 675f 6f6e 2e69 7373 7562 7365 7428 7473  g_on.issubset(ts
+000478e0: 2e64 6570 656e 6465 6e63 6965 7329 2c20  .dependencies), 
+000478f0: 280a 2020 2020 2020 2020 2020 2020 2277  (.            "w
+00047900: 6169 7469 6e67 206e 6f74 2073 7562 7365  aiting not subse
+00047910: 7420 6f66 2064 6570 656e 6465 6e63 6965  t of dependencie
+00047920: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00047930: 7374 7228 7473 2e77 6169 7469 6e67 5f6f  str(ts.waiting_o
+00047940: 6e29 2c0a 2020 2020 2020 2020 2020 2020  n),.            
+00047950: 7374 7228 7473 2e64 6570 656e 6465 6e63  str(ts.dependenc
+00047960: 6965 7329 2c0a 2020 2020 2020 2020 290a  ies),.        ).
+00047970: 2020 2020 6966 2074 732e 7761 6974 6572      if ts.waiter
+00047980: 733a 0a20 2020 2020 2020 2061 7373 6572  s:.        asser
+00047990: 7420 7473 2e77 6169 7465 7273 2e69 7373  t ts.waiters.iss
+000479a0: 7562 7365 7428 7473 2e64 6570 656e 6465  ubset(ts.depende
+000479b0: 6e74 7329 2c20 280a 2020 2020 2020 2020  nts), (.        
+000479c0: 2020 2020 2277 6169 7465 7273 206e 6f74      "waiters not
+000479d0: 2073 7562 7365 7420 6f66 2064 6570 656e   subset of depen
+000479e0: 6465 6e74 7322 2c0a 2020 2020 2020 2020  dents",.        
+000479f0: 2020 2020 7374 7228 7473 2e77 6169 7465      str(ts.waite
+00047a00: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
+00047a10: 2073 7472 2874 732e 6465 7065 6e64 656e   str(ts.dependen
+00047a20: 7473 292c 0a20 2020 2020 2020 2029 0a0a  ts),.        )..
+00047a30: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+00047a40: 732e 7761 6974 696e 675f 6f6e 3a0a 2020  s.waiting_on:.  
+00047a50: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00047a60: 2064 7473 2e77 686f 5f68 6173 2c20 2822   dts.who_has, ("
+00047a70: 7761 6974 696e 6720 6f6e 2069 6e2d 6d65  waiting on in-me
+00047a80: 6d6f 7279 2064 6570 222c 2073 7472 2874  mory dep", str(t
+00047a90: 7329 2c20 7374 7228 6474 7329 290a 2020  s), str(dts)).  
+00047aa0: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
+00047ab0: 2e73 7461 7465 2021 3d20 2272 656c 6561  .state != "relea
+00047ac0: 7365 6422 2c20 2822 7761 6974 696e 6720  sed", ("waiting 
+00047ad0: 6f6e 2072 656c 6561 7365 6420 6465 7022  on released dep"
+00047ae0: 2c20 7374 7228 7473 292c 2073 7472 2864  , str(ts), str(d
+00047af0: 7473 2929 0a20 2020 2066 6f72 2064 7473  ts)).    for dts
+00047b00: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+00047b10: 6965 733a 0a20 2020 2020 2020 2061 7373  ies:.        ass
+00047b20: 6572 7420 7473 2069 6e20 6474 732e 6465  ert ts in dts.de
+00047b30: 7065 6e64 656e 7473 2c20 280a 2020 2020  pendents, (.    
+00047b40: 2020 2020 2020 2020 226e 6f74 2069 6e20          "not in 
+00047b50: 6465 7065 6e64 656e 6379 2773 2064 6570  dependency's dep
+00047b60: 656e 6465 6e74 7322 2c0a 2020 2020 2020  endents",.      
+00047b70: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
+00047b80: 2020 2020 2020 2020 2020 2073 7472 2864             str(d
+00047b90: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00047ba0: 2073 7472 2864 7473 2e64 6570 656e 6465   str(dts.depende
+00047bb0: 6e74 7329 2c0a 2020 2020 2020 2020 290a  nts),.        ).
+00047bc0: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+00047bd0: 6174 6520 696e 2028 2277 6169 7469 6e67  ate in ("waiting
+00047be0: 222c 2022 7175 6575 6564 222c 2022 7072  ", "queued", "pr
+00047bf0: 6f63 6573 7369 6e67 222c 2022 6e6f 2d77  ocessing", "no-w
+00047c00: 6f72 6b65 7222 293a 0a20 2020 2020 2020  orker"):.       
+00047c10: 2020 2020 2061 7373 6572 7420 6474 7320       assert dts 
+00047c20: 696e 2074 732e 7761 6974 696e 675f 6f6e  in ts.waiting_on
+00047c30: 206f 7220 6474 732e 7768 6f5f 6861 732c   or dts.who_has,
+00047c40: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00047c50: 2020 2022 6465 7020 6d69 7373 696e 6722     "dep missing"
+00047c60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00047c70: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
+00047c80: 2020 2020 2020 2020 2020 2073 7472 2864             str(d
+00047c90: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00047ca0: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+00047cb0: 7420 6474 732e 7374 6174 6520 213d 2022  t dts.state != "
+00047cc0: 666f 7267 6f74 7465 6e22 0a0a 2020 2020  forgotten"..    
+00047cd0: 666f 7220 6474 7320 696e 2074 732e 7761  for dts in ts.wa
+00047ce0: 6974 6572 733a 0a20 2020 2020 2020 2061  iters:.        a
+00047cf0: 7373 6572 7420 6474 732e 7374 6174 6520  ssert dts.state 
+00047d00: 696e 2028 2277 6169 7469 6e67 222c 2022  in ("waiting", "
+00047d10: 7175 6575 6564 222c 2022 7072 6f63 6573  queued", "proces
+00047d20: 7369 6e67 222c 2022 6e6f 2d77 6f72 6b65  sing", "no-worke
+00047d30: 7222 292c 2028 0a20 2020 2020 2020 2020  r"), (.         
+00047d40: 2020 2022 7761 6974 6572 206e 6f74 2069     "waiter not i
+00047d50: 6e20 706c 6179 222c 0a20 2020 2020 2020  n play",.       
+00047d60: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
+00047d70: 2020 2020 2020 2020 2020 7374 7228 6474            str(dt
+00047d80: 7329 2c0a 2020 2020 2020 2020 290a 2020  s),.        ).  
+00047d90: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00047da0: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+00047db0: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+00047dc0: 2064 7473 2e64 6570 656e 6465 6e63 6965   dts.dependencie
+00047dd0: 732c 2028 0a20 2020 2020 2020 2020 2020  s, (.           
+00047de0: 2022 6e6f 7420 696e 2064 6570 656e 6465   "not in depende
+00047df0: 6e74 2773 2064 6570 656e 6465 6e63 6965  nt's dependencie
+00047e00: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00047e10: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
+00047e20: 2020 2020 2073 7472 2864 7473 292c 0a20       str(dts),. 
+00047e30: 2020 2020 2020 2020 2020 2073 7472 2864             str(d
+00047e40: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+00047e50: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00047e60: 2020 2020 6173 7365 7274 2064 7473 2e73      assert dts.s
+00047e70: 7461 7465 2021 3d20 2266 6f72 676f 7474  tate != "forgott
+00047e80: 656e 220a 0a20 2020 2061 7373 6572 7420  en"..    assert 
+00047e90: 2874 732e 7072 6f63 6573 7369 6e67 5f6f  (ts.processing_o
+00047ea0: 6e20 6973 206e 6f74 204e 6f6e 6529 203d  n is not None) =
+00047eb0: 3d20 2874 732e 7374 6174 6520 3d3d 2022  = (ts.state == "
+00047ec0: 7072 6f63 6573 7369 6e67 2229 0a20 2020  processing").   
+00047ed0: 2061 7373 6572 7420 626f 6f6c 2874 732e   assert bool(ts.
+00047ee0: 7768 6f5f 6861 7329 203d 3d20 2874 732e  who_has) == (ts.
+00047ef0: 7374 6174 6520 3d3d 2022 6d65 6d6f 7279  state == "memory
+00047f00: 2229 2c20 2874 732c 2074 732e 7768 6f5f  "), (ts, ts.who_
+00047f10: 6861 732c 2074 732e 7374 6174 6529 0a0a  has, ts.state)..
+00047f20: 2020 2020 6966 2074 732e 7374 6174 6520      if ts.state 
+00047f30: 3d3d 2022 7175 6575 6564 223a 0a20 2020  == "queued":.   
+00047f40: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00047f50: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00047f60: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00047f70: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
+00047f80: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
+00047f90: 6c28 6474 732e 7768 6f5f 6861 7320 666f  l(dts.who_has fo
+00047fa0: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+00047fb0: 6e64 656e 6369 6573 292c 2028 0a20 2020  ndencies), (.   
+00047fc0: 2020 2020 2020 2020 2022 7461 736b 2071           "task q
+00047fd0: 7565 7565 6420 7769 7468 6f75 7420 616c  ueued without al
+00047fe0: 6c20 6465 7073 222c 0a20 2020 2020 2020  l deps",.       
+00047ff0: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
+00048000: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
+00048010: 2e64 6570 656e 6465 6e63 6965 7329 2c0a  .dependencies),.
+00048020: 2020 2020 2020 2020 290a 0a20 2020 2069          )..    i
+00048030: 6620 7473 2e73 7461 7465 203d 3d20 2270  f ts.state == "p
+00048040: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
+00048050: 2020 2020 6173 7365 7274 2061 6c6c 2864      assert all(d
+00048060: 7473 2e77 686f 5f68 6173 2066 6f72 2064  ts.who_has for d
+00048070: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+00048080: 6e63 6965 7329 2c20 280a 2020 2020 2020  ncies), (.      
+00048090: 2020 2020 2020 2274 6173 6b20 7072 6f63        "task proc
+000480a0: 6573 7369 6e67 2077 6974 686f 7574 2061  essing without a
+000480b0: 6c6c 2064 6570 7322 2c0a 2020 2020 2020  ll deps",.      
+000480c0: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
+000480d0: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+000480e0: 732e 6465 7065 6e64 656e 6369 6573 292c  s.dependencies),
+000480f0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00048100: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00048110: 2e77 6169 7469 6e67 5f6f 6e0a 0a20 2020  .waiting_on..   
+00048120: 2069 6620 7473 2e77 686f 5f68 6173 3a0a   if ts.who_has:.
+00048130: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00048140: 732e 7761 6974 6572 7320 6f72 2074 732e  s.waiters or ts.
+00048150: 7768 6f5f 7761 6e74 732c 2028 0a20 2020  who_wants, (.   
+00048160: 2020 2020 2020 2020 2022 756e 6e65 6564           "unneed
+00048170: 6564 2074 6173 6b20 696e 206d 656d 6f72  ed task in memor
+00048180: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+00048190: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
+000481a0: 2020 2020 2073 7472 2874 732e 7768 6f5f       str(ts.who_
+000481b0: 6861 7329 2c0a 2020 2020 2020 2020 290a  has),.        ).
+000481c0: 2020 2020 2020 2020 6966 2074 732e 7275          if ts.ru
+000481d0: 6e5f 7370 6563 3a20 2023 2077 6173 2063  n_spec:  # was c
+000481e0: 6f6d 7075 7465 640a 2020 2020 2020 2020  omputed.        
+000481f0: 2020 2020 6173 7365 7274 2074 732e 7479      assert ts.ty
+00048200: 7065 0a20 2020 2020 2020 2020 2020 2061  pe.            a
+00048210: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00048220: 2874 732e 7479 7065 2c20 7374 7229 0a20  (ts.type, str). 
+00048230: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00048240: 7420 616e 7928 5b74 7320 696e 2064 7473  t any([ts in dts
+00048250: 2e77 6169 7469 6e67 5f6f 6e20 666f 7220  .waiting_on for 
+00048260: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+00048270: 656e 7473 5d29 0a20 2020 2020 2020 2066  ents]).        f
+00048280: 6f72 2077 7320 696e 2074 732e 7768 6f5f  or ws in ts.who_
+00048290: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
+000482a0: 2061 7373 6572 7420 7473 2069 6e20 7773   assert ts in ws
+000482b0: 2e68 6173 5f77 6861 742c 2028 0a20 2020  .has_what, (.   
+000482c0: 2020 2020 2020 2020 2020 2020 2022 6e6f               "no
+000482d0: 7420 696e 2077 686f 5f68 6173 2720 6861  t in who_has' ha
+000482e0: 735f 7768 6174 222c 0a20 2020 2020 2020  s_what",.       
+000482f0: 2020 2020 2020 2020 2073 7472 2874 7329           str(ts)
+00048300: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00048310: 2020 7374 7228 7773 292c 0a20 2020 2020    str(ws),.     
+00048320: 2020 2020 2020 2020 2020 2073 7472 2877             str(w
+00048330: 732e 6861 735f 7768 6174 292c 0a20 2020  s.has_what),.   
+00048340: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00048350: 666f 7220 6373 2069 6e20 7473 2e77 686f  for cs in ts.who
+00048360: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
+00048370: 6173 7365 7274 2074 7320 696e 2063 732e  assert ts in cs.
+00048380: 7761 6e74 735f 7768 6174 2c20 280a 2020  wants_what, (.  
+00048390: 2020 2020 2020 2020 2020 226e 6f74 2069            "not i
+000483a0: 6e20 7768 6f5f 7761 6e74 7327 2077 616e  n who_wants' wan
+000483b0: 7473 5f77 6861 7422 2c0a 2020 2020 2020  ts_what",.      
+000483c0: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
+000483d0: 2020 2020 2020 2020 2020 2073 7472 2863             str(c
+000483e0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+000483f0: 7374 7228 6373 2e77 616e 7473 5f77 6861  str(cs.wants_wha
+00048400: 7429 2c0a 2020 2020 2020 2020 290a 0a20  t),.        ).. 
+00048410: 2020 2069 6620 7473 2e61 6374 6f72 3a0a     if ts.actor:.
+00048420: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+00048430: 6174 6520 3d3d 2022 6d65 6d6f 7279 223a  ate == "memory":
+00048440: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00048450: 6572 7420 7375 6d28 7473 2069 6e20 7773  ert sum(ts in ws
+00048460: 2e61 6374 6f72 7320 666f 7220 7773 2069  .actors for ws i
+00048470: 6e20 7473 2e77 686f 5f68 6173 2920 3d3d  n ts.who_has) ==
+00048480: 2031 0a20 2020 2020 2020 2069 6620 7473   1.        if ts
+00048490: 2e73 7461 7465 203d 3d20 2270 726f 6365  .state == "proce
+000484a0: 7373 696e 6722 3a0a 2020 2020 2020 2020  ssing":.        
+000484b0: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
+000484c0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+000484d0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000484e0: 7320 696e 2074 732e 7072 6f63 6573 7369  s in ts.processi
+000484f0: 6e67 5f6f 6e2e 6163 746f 7273 0a20 2020  ng_on.actors.   
+00048500: 2020 2020 2061 7373 6572 7420 7473 2e73       assert ts.s
+00048510: 7461 7465 2021 3d20 2271 7565 7565 6422  tate != "queued"
+00048520: 0a0a 0a64 6566 2076 616c 6964 6174 655f  ...def validate_
+00048530: 776f 726b 6572 5f73 7461 7465 2877 733a  worker_state(ws:
+00048540: 2057 6f72 6b65 7253 7461 7465 2920 2d3e   WorkerState) ->
+00048550: 204e 6f6e 653a 0a20 2020 2066 6f72 2074   None:.    for t
+00048560: 7320 696e 2077 732e 6861 735f 7768 6174  s in ws.has_what
+00048570: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00048580: 2077 7320 696e 2074 732e 7768 6f5f 6861   ws in ts.who_ha
+00048590: 732c 2028 0a20 2020 2020 2020 2020 2020  s, (.           
+000485a0: 2022 6e6f 7420 696e 2068 6173 5f77 6861   "not in has_wha
+000485b0: 7427 2077 686f 5f68 6173 222c 0a20 2020  t' who_has",.   
+000485c0: 2020 2020 2020 2020 2073 7472 2877 7329           str(ws)
+000485d0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+000485e0: 7228 7473 292c 0a20 2020 2020 2020 2020  r(ts),.         
+000485f0: 2020 2073 7472 2874 732e 7768 6f5f 6861     str(ts.who_ha
+00048600: 7329 2c0a 2020 2020 2020 2020 290a 0a20  s),.        ).. 
+00048610: 2020 2066 6f72 2074 7320 696e 2077 732e     for ts in ws.
+00048620: 6163 746f 7273 3a0a 2020 2020 2020 2020  actors:.        
+00048630: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
+00048640: 696e 2028 226d 656d 6f72 7922 2c20 2270  in ("memory", "p
+00048650: 726f 6365 7373 696e 6722 290a 0a0a 6465  rocessing")...de
+00048660: 6620 7661 6c69 6461 7465 5f73 7461 7465  f validate_state
+00048670: 280a 2020 2020 7461 736b 733a 2064 6963  (.    tasks: dic
+00048680: 745b 7374 722c 2054 6173 6b53 7461 7465  t[str, TaskState
+00048690: 5d2c 0a20 2020 2077 6f72 6b65 7273 3a20  ],.    workers: 
+000486a0: 6469 6374 5b73 7472 2c20 576f 726b 6572  dict[str, Worker
+000486b0: 5374 6174 655d 2c0a 2020 2020 636c 6965  State],.    clie
+000486c0: 6e74 733a 2064 6963 745b 7374 722c 2043  nts: dict[str, C
+000486d0: 6c69 656e 7453 7461 7465 5d2c 0a29 202d  lientState],.) -
+000486e0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2256  > None:.    """V
+000486f0: 616c 6964 6174 6520 6120 6375 7272 656e  alidate a curren
+00048700: 7420 7275 6e74 696d 6520 7374 6174 652e  t runtime state.
+00048710: 0a0a 2020 2020 5468 6973 2070 6572 666f  ..    This perfo
+00048720: 726d 7320 6120 7365 7175 656e 6365 206f  rms a sequence o
+00048730: 6620 6368 6563 6b73 206f 6e20 7468 6520  f checks on the 
+00048740: 656e 7469 7265 2067 7261 7068 2c20 7275  entire graph, ru
+00048750: 6e6e 696e 6720 696e 2061 626f 7574 206c  nning in about l
+00048760: 696e 6561 720a 2020 2020 7469 6d65 2e20  inear.    time. 
+00048770: 5468 6973 2072 6169 7365 7320 6173 7365  This raises asse
+00048780: 7274 2065 7272 6f72 7320 6966 2061 6e79  rt errors if any
+00048790: 7468 696e 6720 646f 6573 6e27 7420 6368  thing doesn't ch
+000487a0: 6563 6b20 6f75 742e 0a20 2020 2022 2222  eck out..    """
+000487b0: 0a20 2020 2066 6f72 2074 7320 696e 2074  .    for ts in t
+000487c0: 6173 6b73 2e76 616c 7565 7328 293a 0a20  asks.values():. 
+000487d0: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
+000487e0: 7461 736b 5f73 7461 7465 2874 7329 0a0a  task_state(ts)..
+000487f0: 2020 2020 666f 7220 7773 2069 6e20 776f      for ws in wo
+00048800: 726b 6572 732e 7661 6c75 6573 2829 3a0a  rkers.values():.
+00048810: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+00048820: 5f77 6f72 6b65 725f 7374 6174 6528 7773  _worker_state(ws
+00048830: 290a 0a20 2020 2066 6f72 2063 7320 696e  )..    for cs in
+00048840: 2063 6c69 656e 7473 2e76 616c 7565 7328   clients.values(
+00048850: 293a 0a20 2020 2020 2020 2066 6f72 2074  ):.        for t
+00048860: 7320 696e 2063 732e 7761 6e74 735f 7768  s in cs.wants_wh
+00048870: 6174 3a0a 2020 2020 2020 2020 2020 2020  at:.            
+00048880: 6173 7365 7274 2063 7320 696e 2074 732e  assert cs in ts.
+00048890: 7768 6f5f 7761 6e74 732c 2028 0a20 2020  who_wants, (.   
+000488a0: 2020 2020 2020 2020 2020 2020 2022 6e6f               "no
+000488b0: 7420 696e 2077 616e 7473 5f77 6861 7427  t in wants_what'
+000488c0: 2077 686f 5f77 616e 7473 222c 0a20 2020   who_wants",.   
+000488d0: 2020 2020 2020 2020 2020 2020 2073 7472               str
+000488e0: 2863 7329 2c0a 2020 2020 2020 2020 2020  (cs),.          
+000488f0: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
+00048900: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00048910: 7472 2874 732e 7768 6f5f 7761 6e74 7329  tr(ts.who_wants)
+00048920: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00048930: 0a0a 6465 6620 6865 6172 7462 6561 745f  ..def heartbeat_
+00048940: 696e 7465 7276 616c 286e 3a20 696e 7429  interval(n: int)
+00048950: 202d 3e20 666c 6f61 743a 0a20 2020 2022   -> float:.    "
+00048960: 2222 496e 7465 7276 616c 2069 6e20 7365  ""Interval in se
+00048970: 636f 6e64 7320 7468 6174 2077 6520 6465  conds that we de
+00048980: 7369 7265 2068 6561 7274 6265 6174 7320  sire heartbeats 
+00048990: 6261 7365 6420 6f6e 206e 756d 6265 7220  based on number 
+000489a0: 6f66 2077 6f72 6b65 7273 2222 220a 2020  of workers""".  
+000489b0: 2020 6966 206e 203c 3d20 3130 3a0a 2020    if n <= 10:.  
+000489c0: 2020 2020 2020 7265 7475 726e 2030 2e35        return 0.5
+000489d0: 0a20 2020 2065 6c69 6620 6e20 3c20 3530  .    elif n < 50
+000489e0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000489f0: 2031 0a20 2020 2065 6c69 6620 6e20 3c20   1.    elif n < 
+00048a00: 3230 303a 0a20 2020 2020 2020 2072 6574  200:.        ret
+00048a10: 7572 6e20 320a 2020 2020 656c 7365 3a0a  urn 2.    else:.
+00048a20: 2020 2020 2020 2020 2320 4e6f 206d 6f72          # No mor
+00048a30: 6520 7468 616e 2032 3030 2068 6561 7274  e than 200 heart
+00048a40: 6265 6174 7320 6120 7365 636f 6e64 2073  beats a second s
+00048a50: 6361 6c65 6420 6279 2077 6f72 6b65 7273  caled by workers
+00048a60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00048a70: 6e20 2f20 3230 3020 2b20 310a 0a0a 6465  n / 200 + 1...de
+00048a80: 6620 5f74 6173 6b5f 736c 6f74 735f 6176  f _task_slots_av
+00048a90: 6169 6c61 626c 6528 7773 3a20 576f 726b  ailable(ws: Work
+00048aa0: 6572 5374 6174 652c 2073 6174 7572 6174  erState, saturat
+00048ab0: 696f 6e5f 6661 6374 6f72 3a20 666c 6f61  ion_factor: floa
+00048ac0: 7429 202d 3e20 696e 743a 0a20 2020 2022  t) -> int:.    "
+00048ad0: 2222 4e75 6d62 6572 206f 6620 7461 736b  ""Number of task
+00048ae0: 7320 7468 6174 2063 616e 2062 6520 7365  s that can be se
+00048af0: 6e74 2074 6f20 7468 6973 2077 6f72 6b65  nt to this worke
+00048b00: 7220 7769 7468 6f75 7420 6f76 6572 7361  r without oversa
+00048b10: 7475 7261 7469 6e67 2069 7422 2222 0a20  turating it""". 
+00048b20: 2020 2061 7373 6572 7420 6e6f 7420 6d61     assert not ma
+00048b30: 7468 2e69 7369 6e66 2873 6174 7572 6174  th.isinf(saturat
+00048b40: 696f 6e5f 6661 6374 6f72 290a 2020 2020  ion_factor).    
+00048b50: 7265 7475 726e 206d 6178 286d 6174 682e  return max(math.
+00048b60: 6365 696c 2873 6174 7572 6174 696f 6e5f  ceil(saturation_
+00048b70: 6661 6374 6f72 202a 2077 732e 6e74 6872  factor * ws.nthr
+00048b80: 6561 6473 292c 2031 2920 2d20 280a 2020  eads), 1) - (.  
+00048b90: 2020 2020 2020 6c65 6e28 7773 2e70 726f        len(ws.pro
+00048ba0: 6365 7373 696e 6729 202d 206c 656e 2877  cessing) - len(w
+00048bb0: 732e 6c6f 6e67 5f72 756e 6e69 6e67 290a  s.long_running).
+00048bc0: 2020 2020 290a 0a0a 6465 6620 5f77 6f72      )...def _wor
+00048bd0: 6b65 725f 6675 6c6c 2877 733a 2057 6f72  ker_full(ws: Wor
+00048be0: 6b65 7253 7461 7465 2c20 7361 7475 7261  kerState, satura
+00048bf0: 7469 6f6e 5f66 6163 746f 723a 2066 6c6f  tion_factor: flo
+00048c00: 6174 2920 2d3e 2062 6f6f 6c3a 0a20 2020  at) -> bool:.   
+00048c10: 2069 6620 6d61 7468 2e69 7369 6e66 2873   if math.isinf(s
+00048c20: 6174 7572 6174 696f 6e5f 6661 6374 6f72  aturation_factor
+00048c30: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00048c40: 6e20 4661 6c73 650a 2020 2020 7265 7475  n False.    retu
+00048c50: 726e 205f 7461 736b 5f73 6c6f 7473 5f61  rn _task_slots_a
+00048c60: 7661 696c 6162 6c65 2877 732c 2073 6174  vailable(ws, sat
+00048c70: 7572 6174 696f 6e5f 6661 6374 6f72 2920  uration_factor) 
+00048c80: 3c3d 2030 0a0a 0a63 6c61 7373 204b 696c  <= 0...class Kil
+00048c90: 6c65 6457 6f72 6b65 7228 4578 6365 7074  ledWorker(Except
+00048ca0: 696f 6e29 3a0a 2020 2020 6465 6620 5f5f  ion):.    def __
+00048cb0: 696e 6974 5f5f 2873 656c 662c 2074 6173  init__(self, tas
+00048cc0: 6b3a 2073 7472 2c20 6c61 7374 5f77 6f72  k: str, last_wor
+00048cd0: 6b65 723a 2057 6f72 6b65 7253 7461 7465  ker: WorkerState
+00048ce0: 2c20 616c 6c6f 7765 645f 6661 696c 7572  , allowed_failur
+00048cf0: 6573 3a20 696e 7429 3a0a 2020 2020 2020  es: int):.      
+00048d00: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00048d10: 5f5f 2874 6173 6b2c 206c 6173 745f 776f  __(task, last_wo
+00048d20: 726b 6572 2c20 616c 6c6f 7765 645f 6661  rker, allowed_fa
+00048d30: 696c 7572 6573 290a 0a20 2020 2040 7072  ilures)..    @pr
+00048d40: 6f70 6572 7479 0a20 2020 2064 6566 2074  operty.    def t
+00048d50: 6173 6b28 7365 6c66 2920 2d3e 2073 7472  ask(self) -> str
+00048d60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00048d70: 2073 656c 662e 6172 6773 5b30 5d0a 0a20   self.args[0].. 
+00048d80: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00048d90: 2064 6566 206c 6173 745f 776f 726b 6572   def last_worker
+00048da0: 2873 656c 6629 202d 3e20 576f 726b 6572  (self) -> Worker
+00048db0: 5374 6174 653a 0a20 2020 2020 2020 2072  State:.        r
+00048dc0: 6574 7572 6e20 7365 6c66 2e61 7267 735b  eturn self.args[
+00048dd0: 315d 0a0a 2020 2020 4070 726f 7065 7274  1]..    @propert
+00048de0: 790a 2020 2020 6465 6620 616c 6c6f 7765  y.    def allowe
+00048df0: 645f 6661 696c 7572 6573 2873 656c 6629  d_failures(self)
+00048e00: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
+00048e10: 2072 6574 7572 6e20 7365 6c66 2e61 7267   return self.arg
+00048e20: 735b 325d 0a0a 2020 2020 6465 6620 5f5f  s[2]..    def __
+00048e30: 7374 725f 5f28 7365 6c66 2920 2d3e 2073  str__(self) -> s
+00048e40: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+00048e50: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+00048e60: 2066 2241 7474 656d 7074 6564 2074 6f20   f"Attempted to 
+00048e70: 7275 6e20 7461 736b 207b 7365 6c66 2e74  run task {self.t
+00048e80: 6173 6b7d 206f 6e20 7b73 656c 662e 616c  ask} on {self.al
+00048e90: 6c6f 7765 645f 6661 696c 7572 6573 7d20  lowed_failures} 
+00048ea0: 6469 6666 6572 656e 7420 220a 2020 2020  different ".    
+00048eb0: 2020 2020 2020 2020 2277 6f72 6b65 7273          "workers
+00048ec0: 2c20 6275 7420 616c 6c20 7468 6f73 6520  , but all those 
+00048ed0: 776f 726b 6572 7320 6469 6564 2077 6869  workers died whi
+00048ee0: 6c65 2072 756e 6e69 6e67 2069 742e 2022  le running it. "
+00048ef0: 0a20 2020 2020 2020 2020 2020 2066 2254  .            f"T
+00048f00: 6865 206c 6173 7420 776f 726b 6572 2074  he last worker t
+00048f10: 6861 7420 6174 7465 6d70 7420 746f 2072  hat attempt to r
+00048f20: 756e 2074 6865 2074 6173 6b20 7761 7320  un the task was 
+00048f30: 7b73 656c 662e 6c61 7374 5f77 6f72 6b65  {self.last_worke
+00048f40: 722e 6164 6472 6573 737d 2e20 220a 2020  r.address}. ".  
+00048f50: 2020 2020 2020 2020 2020 2249 6e73 7065            "Inspe
+00048f60: 6374 696e 6720 776f 726b 6572 206c 6f67  cting worker log
+00048f70: 7320 6973 206f 6674 656e 2061 2067 6f6f  s is often a goo
+00048f80: 6420 6e65 7874 2073 7465 7020 746f 2064  d next step to d
+00048f90: 6961 676e 6f73 6520 7768 6174 2077 656e  iagnose what wen
+00048fa0: 7420 7772 6f6e 672e 2022 0a20 2020 2020  t wrong. ".     
+00048fb0: 2020 2020 2020 2022 466f 7220 6d6f 7265         "For more
+00048fc0: 2069 6e66 6f72 6d61 7469 6f6e 2073 6565   information see
+00048fd0: 2068 7474 7073 3a2f 2f64 6973 7472 6962   https://distrib
+00048fe0: 7574 6564 2e64 6173 6b2e 6f72 672f 656e  uted.dask.org/en
+00048ff0: 2f73 7461 626c 652f 6b69 6c6c 6564 2e68  /stable/killed.h
+00049000: 746d 6c2e 220a 2020 2020 2020 2020 290a  tml.".        ).
+00049010: 0a0a 636c 6173 7320 576f 726b 6572 5374  ..class WorkerSt
+00049020: 6174 7573 506c 7567 696e 2853 6368 6564  atusPlugin(Sched
+00049030: 756c 6572 506c 7567 696e 293a 0a20 2020  ulerPlugin):.   
+00049040: 2022 2222 4120 706c 7567 696e 2074 6f20   """A plugin to 
+00049050: 7368 6172 6520 776f 726b 6572 2073 7461  share worker sta
+00049060: 7475 7320 7769 7468 2061 2072 656d 6f74  tus with a remot
+00049070: 6520 6f62 7365 7276 6572 0a0a 2020 2020  e observer..    
+00049080: 5468 6973 2069 7320 7573 6564 2069 6e20  This is used in 
+00049090: 636c 7573 7465 7220 6d61 6e61 6765 7273  cluster managers
+000490a0: 2074 6f20 6b65 6570 2075 7064 6174 6564   to keep updated
+000490b0: 2061 626f 7574 2074 6865 2073 7461 7475   about the statu
+000490c0: 7320 6f66 2074 6865 2073 6368 6564 756c  s of the schedul
+000490d0: 6572 2e0a 2020 2020 2222 220a 0a20 2020  er..    """..   
+000490e0: 206e 616d 653a 2043 6c61 7373 5661 725b   name: ClassVar[
+000490f0: 7374 725d 203d 2022 776f 726b 6572 2d73  str] = "worker-s
+00049100: 7461 7475 7322 0a20 2020 2062 636f 6d6d  tatus".    bcomm
+00049110: 3a20 4261 7463 6865 6453 656e 640a 0a20  : BatchedSend.. 
+00049120: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00049130: 7365 6c66 2c20 7363 6865 6475 6c65 723a  self, scheduler:
+00049140: 2053 6368 6564 756c 6572 2c20 636f 6d6d   Scheduler, comm
+00049150: 3a20 436f 6d6d 293a 0a20 2020 2020 2020  : Comm):.       
+00049160: 2073 656c 662e 6263 6f6d 6d20 3d20 4261   self.bcomm = Ba
+00049170: 7463 6865 6453 656e 6428 696e 7465 7276  tchedSend(interv
+00049180: 616c 3d22 356d 7322 290a 2020 2020 2020  al="5ms").      
+00049190: 2020 7365 6c66 2e62 636f 6d6d 2e73 7461    self.bcomm.sta
+000491a0: 7274 2863 6f6d 6d29 0a20 2020 2020 2020  rt(comm).       
+000491b0: 2073 6368 6564 756c 6572 2e61 6464 5f70   scheduler.add_p
+000491c0: 6c75 6769 6e28 7365 6c66 290a 0a20 2020  lugin(self)..   
+000491d0: 2064 6566 2061 6464 5f77 6f72 6b65 7228   def add_worker(
+000491e0: 7365 6c66 2c20 7363 6865 6475 6c65 723a  self, scheduler:
+000491f0: 2053 6368 6564 756c 6572 2c20 776f 726b   Scheduler, work
+00049200: 6572 3a20 7374 7229 202d 3e20 4e6f 6e65  er: str) -> None
+00049210: 3a0a 2020 2020 2020 2020 6964 656e 7420  :.        ident 
+00049220: 3d20 7363 6865 6475 6c65 722e 776f 726b  = scheduler.work
+00049230: 6572 735b 776f 726b 6572 5d2e 6964 656e  ers[worker].iden
+00049240: 7469 7479 2829 0a20 2020 2020 2020 2064  tity().        d
+00049250: 656c 2069 6465 6e74 5b22 6d65 7472 6963  el ident["metric
+00049260: 7322 5d0a 2020 2020 2020 2020 6465 6c20  s"].        del 
+00049270: 6964 656e 745b 226c 6173 745f 7365 656e  ident["last_seen
+00049280: 225d 0a20 2020 2020 2020 2074 7279 3a0a  "].        try:.
+00049290: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000492a0: 2e62 636f 6d6d 2e73 656e 6428 5b22 6164  .bcomm.send(["ad
+000492b0: 6422 2c20 7b22 776f 726b 6572 7322 3a20  d", {"workers": 
+000492c0: 7b77 6f72 6b65 723a 2069 6465 6e74 7d7d  {worker: ident}}
+000492d0: 5d29 0a20 2020 2020 2020 2065 7863 6570  ]).        excep
+000492e0: 7420 436f 6d6d 436c 6f73 6564 4572 726f  t CommClosedErro
+000492f0: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
+00049300: 6368 6564 756c 6572 2e72 656d 6f76 655f  cheduler.remove_
+00049310: 706c 7567 696e 286e 616d 653d 7365 6c66  plugin(name=self
+00049320: 2e6e 616d 6529 0a0a 2020 2020 6465 6620  .name)..    def 
+00049330: 7265 6d6f 7665 5f77 6f72 6b65 7228 7365  remove_worker(se
+00049340: 6c66 2c20 7363 6865 6475 6c65 723a 2053  lf, scheduler: S
+00049350: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
+00049360: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+00049370: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00049380: 2020 2020 2020 2020 2073 656c 662e 6263           self.bc
+00049390: 6f6d 6d2e 7365 6e64 285b 2272 656d 6f76  omm.send(["remov
+000493a0: 6522 2c20 776f 726b 6572 5d29 0a20 2020  e", worker]).   
+000493b0: 2020 2020 2065 7863 6570 7420 436f 6d6d       except Comm
+000493c0: 436c 6f73 6564 4572 726f 723a 0a20 2020  ClosedError:.   
+000493d0: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
+000493e0: 6572 2e72 656d 6f76 655f 706c 7567 696e  er.remove_plugin
+000493f0: 286e 616d 653d 7365 6c66 2e6e 616d 6529  (name=self.name)
+00049400: 0a0a 2020 2020 6465 6620 7465 6172 646f  ..    def teardo
+00049410: 776e 2873 656c 6629 202d 3e20 4e6f 6e65  wn(self) -> None
+00049420: 3a0a 2020 2020 2020 2020 7365 6c66 2e62  :.        self.b
+00049430: 636f 6d6d 2e63 6c6f 7365 2829 0a0a 0a63  comm.close()...c
+00049440: 6c61 7373 2043 6f6c 6c65 6374 5461 736b  lass CollectTask
+00049450: 4d65 7461 4461 7461 506c 7567 696e 2853  MetaDataPlugin(S
+00049460: 6368 6564 756c 6572 506c 7567 696e 293a  chedulerPlugin):
+00049470: 0a20 2020 2073 6368 6564 756c 6572 3a20  .    scheduler: 
+00049480: 5363 6865 6475 6c65 720a 2020 2020 6e61  Scheduler.    na
+00049490: 6d65 3a20 7374 720a 2020 2020 6b65 7973  me: str.    keys
+000494a0: 3a20 7365 745b 7374 725d 0a20 2020 206d  : set[str].    m
+000494b0: 6574 6164 6174 613a 2064 6963 745b 7374  etadata: dict[st
+000494c0: 722c 2041 6e79 5d0a 2020 2020 7374 6174  r, Any].    stat
+000494d0: 653a 2064 6963 745b 7374 722c 2073 7472  e: dict[str, str
+000494e0: 5d0a 0a20 2020 2064 6566 205f 5f69 6e69  ]..    def __ini
+000494f0: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
+00049500: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
+00049510: 6e61 6d65 3a20 7374 7229 3a0a 2020 2020  name: str):.    
+00049520: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
+00049530: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
+00049540: 2020 2020 2020 2073 656c 662e 6e61 6d65         self.name
+00049550: 203d 206e 616d 650a 2020 2020 2020 2020   = name.        
+00049560: 7365 6c66 2e6b 6579 7320 3d20 7365 7428  self.keys = set(
+00049570: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
+00049580: 6574 6164 6174 6120 3d20 7b7d 0a20 2020  etadata = {}.   
+00049590: 2020 2020 2073 656c 662e 7374 6174 6520       self.state 
+000495a0: 3d20 7b7d 0a0a 2020 2020 6465 6620 7570  = {}..    def up
+000495b0: 6461 7465 5f67 7261 7068 280a 2020 2020  date_graph(.    
+000495c0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000495d0: 2020 7363 6865 6475 6c65 723a 2053 6368    scheduler: Sch
+000495e0: 6564 756c 6572 2c0a 2020 2020 2020 2020  eduler,.        
+000495f0: 2a2c 0a20 2020 2020 2020 206b 6579 733a  *,.        keys:
+00049600: 2073 6574 5b73 7472 5d2c 0a20 2020 2020   set[str],.     
+00049610: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
+00049620: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
+00049630: 0a20 2020 2020 2020 2073 656c 662e 6b65  .        self.ke
+00049640: 7973 2e75 7064 6174 6528 6b65 7973 290a  ys.update(keys).
+00049650: 0a20 2020 2064 6566 2074 7261 6e73 6974  .    def transit
+00049660: 696f 6e28 0a20 2020 2020 2020 2073 656c  ion(.        sel
+00049670: 662c 0a20 2020 2020 2020 206b 6579 3a20  f,.        key: 
+00049680: 7374 722c 0a20 2020 2020 2020 2073 7461  str,.        sta
+00049690: 7274 3a20 5461 736b 5374 6174 6553 7461  rt: TaskStateSta
+000496a0: 7465 2c0a 2020 2020 2020 2020 6669 6e69  te,.        fini
+000496b0: 7368 3a20 5461 736b 5374 6174 6553 7461  sh: TaskStateSta
+000496c0: 7465 2c0a 2020 2020 2020 2020 2a61 7267  te,.        *arg
+000496d0: 733a 2041 6e79 2c0a 2020 2020 2020 2020  s: Any,.        
+000496e0: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
+000496f0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00049700: 2020 2020 2020 6966 2066 696e 6973 6820        if finish 
+00049710: 696e 2028 226d 656d 6f72 7922 2c20 2265  in ("memory", "e
+00049720: 7272 6564 2229 3a0a 2020 2020 2020 2020  rred"):.        
+00049730: 2020 2020 7473 203d 2073 656c 662e 7363      ts = self.sc
+00049740: 6865 6475 6c65 722e 7461 736b 732e 6765  heduler.tasks.ge
+00049750: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
+00049760: 2020 2069 6620 7473 2069 7320 6e6f 7420     if ts is not 
+00049770: 4e6f 6e65 2061 6e64 2074 732e 6b65 7920  None and ts.key 
+00049780: 696e 2073 656c 662e 6b65 7973 3a0a 2020  in self.keys:.  
+00049790: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000497a0: 6c66 2e6d 6574 6164 6174 615b 6b65 795d  lf.metadata[key]
+000497b0: 203d 2074 732e 6d65 7461 6461 7461 0a20   = ts.metadata. 
+000497c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000497d0: 656c 662e 7374 6174 655b 6b65 795d 203d  elf.state[key] =
+000497e0: 2066 696e 6973 680a 2020 2020 2020 2020   finish.        
+000497f0: 2020 2020 2020 2020 7365 6c66 2e6b 6579          self.key
+00049800: 732e 6469 7363 6172 6428 6b65 7929 0a    s.discard(key).
```

### Comparing `distributed-2023.3.2.1/distributed/security.py` & `distributed-2023.4.0/distributed/security.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/semaphore.py` & `distributed-2023.4.0/distributed/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/shuffle/__init__.py` & `distributed-2023.4.0/distributed/shuffle/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_arrow.py` & `distributed-2023.4.0/distributed/shuffle/_arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_buffer.py` & `distributed-2023.4.0/distributed/shuffle/_buffer.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_comms.py` & `distributed-2023.4.0/distributed/shuffle/_comms.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_disk.py` & `distributed-2023.4.0/distributed/shuffle/_disk.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_limiter.py` & `distributed-2023.4.0/distributed/shuffle/_limiter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_merge.py` & `distributed-2023.4.0/distributed/shuffle/_merge.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,22 +1,17 @@
 # mypy: ignore-errors
 from __future__ import annotations
 
 from collections import defaultdict
 from typing import TYPE_CHECKING, Any, Iterable, Sequence
 
-import toolz
-
 from dask.base import is_dask_collection, tokenize
-from dask.core import keys_in_tasks
 from dask.highlevelgraph import HighLevelGraph
 from dask.layers import Layer
-from dask.utils import stringify, stringify_collection_keys
 
-from distributed.protocol.serialize import to_serialize
 from distributed.shuffle._shuffle import (
     ShuffleId,
     _get_worker_extension,
     barrier_key,
     shuffle_barrier,
     shuffle_transfer,
 )
@@ -161,18 +156,14 @@
     left_on: IndexLabel,
     right_on: IndexLabel,
     result_meta: pd.DataFrame,
     suffixes: Suffixes,
 ):
     from dask.dataframe.multi import merge_chunk
 
-    from distributed.protocol import deserialize
-
-    # FIXME: This is odd.
-    result_meta = deserialize(result_meta.header, result_meta.frames)
     ext = _get_worker_extension()
     left = ext.get_output_partition(
         shuffle_id_left, barrier_left, output_partition
     ).drop(columns=_HASH_COLUMN_NAME)
     right = ext.get_output_partition(
         shuffle_id_right, barrier_right, output_partition
     ).drop(columns=_HASH_COLUMN_NAME)
@@ -377,63 +368,7 @@
                 self.how,
                 self.left_on,
                 self.right_on,
                 self.meta_output,
                 self.suffixes,
             )
         return dsk
-
-    @classmethod
-    def __dask_distributed_unpack__(
-        cls, state: dict, dsk: dict, dependecies: dict
-    ) -> dict:
-        from distributed.worker import dumps_task
-
-        to_list = [
-            "left_on",
-            "suffixes",
-            "right_on",
-        ]
-        # msgpack will convert lists into tuples, here
-        # we convert them back to lists
-        for attr in to_list:
-            if isinstance(state[attr], tuple):
-                state[attr] = list(state[attr])
-
-        # Materialize the layer
-        layer_dsk = cls(**state)._construct_graph()
-
-        # Convert all keys to strings and dump tasks
-        layer_dsk = {
-            stringify(k): stringify_collection_keys(v) for k, v in layer_dsk.items()
-        }
-        keys = layer_dsk.keys() | dsk.keys()
-        deps = {}
-        for k, v in layer_dsk.items():
-            deps[k] = d = keys_in_tasks(keys, [v])
-            assert d
-        return {"dsk": toolz.valmap(dumps_task, layer_dsk), "deps": deps}
-
-    def __dask_distributed_pack__(
-        self,
-        all_hlg_keys: Any,
-        known_key_dependencies: Any,
-        client: Any,
-        client_keys: Any,
-    ) -> dict:
-        return {
-            "name": self.name,
-            "name_input_left": self.name_input_left,
-            "left_on": self.left_on,
-            "name_input_right": self.name_input_right,
-            "right_on": self.right_on,
-            "meta_output": to_serialize(self.meta_output),
-            "how": self.how,
-            "npartitions": self.npartitions,
-            "suffixes": self.suffixes,
-            "indicator": self.indicator,
-            "parts_out": self.parts_out,
-            "n_partitions_left": self.n_partitions_left,
-            "n_partitions_right": self.n_partitions_right,
-            "left_index": self.left_index,
-            "right_index": self.right_index,
-        }
```

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_rechunk.py` & `distributed-2023.4.0/distributed/shuffle/_rechunk.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_scheduler_extension.py` & `distributed-2023.4.0/distributed/shuffle/_scheduler_extension.py`

 * *Files 2% similar despite different names*

```diff
@@ -14,15 +14,21 @@
     ShuffleId,
     ShuffleType,
     barrier_key,
     id_from_key,
 )
 
 if TYPE_CHECKING:
-    from distributed.scheduler import Recs, Scheduler, TaskStateState, WorkerState
+    from distributed.scheduler import (
+        Recs,
+        Scheduler,
+        TaskState,
+        TaskStateState,
+        WorkerState,
+    )
 
 logger = logging.getLogger(__name__)
 
 
 @dataclass
 class ShuffleState(abc.ABC):
     _run_id_iterator: ClassVar[itertools.count] = itertools.count()
@@ -162,15 +168,15 @@
         workers = list(self.scheduler.workers)
         output_workers = set()
 
         name = barrier_key(id)
         mapping = {}
 
         for ts in self.scheduler.tasks[name].dependents:
-            part = ts.annotations["shuffle"]
+            part = get_partition_id(ts)
             if ts.worker_restrictions:
                 output_worker = list(ts.worker_restrictions)[0]
             else:
                 output_worker = get_worker_for_range_sharding(
                     part, workers, npartitions
                 )
             mapping[part] = output_worker
@@ -198,15 +204,15 @@
         workers = list(self.scheduler.workers)
         output_workers = set()
 
         name = barrier_key(id)
         mapping = {}
 
         for ts in self.scheduler.tasks[name].dependents:
-            part = ts.annotations["shuffle"]
+            part = get_partition_id(ts)
             if ts.worker_restrictions:
                 output_worker = list(ts.worker_restrictions)[0]
             else:
                 output_worker = get_worker_for_hash_sharding(part, workers)
             mapping[part] = output_worker
             output_workers.add(output_worker)
             self.scheduler.set_restrictions({ts.key: {output_worker}})
@@ -289,14 +295,27 @@
 
     def restart(self, scheduler: Scheduler) -> None:
         self.states.clear()
         self.heartbeats.clear()
         self.erred_shuffles.clear()
 
 
+def get_partition_id(ts: TaskState) -> Any:
+    """Get the output partition ID of this task state."""
+    try:
+        return ts.annotations["shuffle"]
+    except KeyError:
+        raise RuntimeError(
+            f"{ts} has lost its ``shuffle`` annotation. This may be caused by "
+            "unintended optimization during graph generation. "
+            "Please report this problem on GitHub and link it to "
+            "the tracking issue at https://github.com/dask/distributed/issues/7716."
+        )
+
+
 def get_worker_for_range_sharding(
     output_partition: int, workers: list[str], npartitions: int
 ) -> str:
     """Get address of target worker for this output partition using range sharding"""
     i = len(workers) * output_partition // npartitions
     return workers[i]
```

### Comparing `distributed-2023.3.2.1/distributed/shuffle/_worker_extension.py` & `distributed-2023.4.0/distributed/shuffle/_worker_extension.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/sizeof.py` & `distributed-2023.4.0/distributed/sizeof.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/spill.py` & `distributed-2023.4.0/distributed/spill.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,30 +1,29 @@
 from __future__ import annotations
 
 import logging
 from collections import defaultdict
-from collections.abc import Hashable, Iterator, Mapping, MutableMapping, Sized
+from collections.abc import Hashable, Iterator, Mapping, Sized
 from contextlib import contextmanager
 from functools import partial
-from typing import Any, Literal, NamedTuple, Protocol, cast
+from typing import Literal, NamedTuple, Protocol, cast
 
 from packaging.version import parse as parse_version
 
 import zict
 
 from distributed.metrics import context_meter
 from distributed.protocol import deserialize_bytes, serialize_bytelist
 from distributed.sizeof import safe_sizeof
 from distributed.utils import RateLimiterFilter
 
 logger = logging.getLogger(__name__)
 logger.addFilter(RateLimiterFilter("Spill file on disk reached capacity"))
 logger.addFilter(RateLimiterFilter("Spill to disk failed"))
 
-has_zict_220 = parse_version(zict.__version__) >= parse_version("2.2.0")
 has_zict_230 = parse_version(zict.__version__) >= parse_version("2.3.0")
 
 
 class SpilledSize(NamedTuple):
     """Size of a key/value pair when spilled to disk, in bytes"""
 
     # output of sizeof()
@@ -65,16 +64,15 @@
         fast memory and that the problem has been logged internally.
 
         This method never raises.
         """
         ...  # pragma: nocover
 
 
-# zict.Buffer[str, Any] requires zict >= 2.2.0
-class SpillBuffer(zict.Buffer):
+class SpillBuffer(zict.Buffer[str, object]):
     """MutableMapping that automatically spills out dask key/value pairs to disk when
     the total size of the stored data exceeds the target. If max_spill is provided the
     key/value pairs won't be spilled once this threshold has been reached.
 
     Parameters
     ----------
     spill_directory: str
@@ -91,21 +89,20 @@
 
     def __init__(
         self,
         spill_directory: str,
         target: int,
         max_spill: int | Literal[False] = False,
     ):
-        slow: MutableMapping[str, Any] = Slow(spill_directory, max_spill)
-        if has_zict_220:
-            # If a value is still in use somewhere on the worker since the last time it
-            # was unspilled, don't duplicate it
-            slow = zict.Cache(slow, zict.WeakValueMapping())
+        # If a value is still in use somewhere on the worker since the last time it was
+        # unspilled, don't duplicate it
+        slow = Slow(spill_directory, max_spill)
+        slow_cached = zict.Cache(slow, zict.WeakValueMapping())  # type: ignore
 
-        super().__init__(fast={}, slow=slow, n=target, weight=_in_memory_weight)
+        super().__init__(fast={}, slow=slow_cached, n=target, weight=_in_memory_weight)
         self.logged_pickle_errors = set()  # keys logged with pickle error
         self.cumulative_metrics = defaultdict(float)
 
     @contextmanager
     def _capture_metrics(self) -> Iterator[None]:
         """Capture metrics re. disk read/write, serialize/deserialize, and
         compress/decompress.
@@ -162,15 +159,15 @@
                 # failed to serialize. There's nothing wrong with the new key. The older
                 # key is still in memory.
                 if key_e not in self.logged_pickle_errors:
                     logger.error("Failed to pickle %r", key_e, exc_info=True)
                     self.logged_pickle_errors.add(key_e)
                 raise HandledError()
 
-    def __setitem__(self, key: str, value: Any) -> None:
+    def __setitem__(self, key: str, value: object) -> None:
         """If sizeof(value) < target, write key/value pair to self.fast; this may in
         turn cause older keys to be spilled from fast to slow.
         If sizeof(value) >= target, write key/value pair directly to self.slow instead.
 
         Raises
         ------
         Exception
@@ -207,15 +204,15 @@
         try:
             with self._capture_metrics(), self._handle_errors(None):
                 _, _, weight = self.fast.evict()
                 return cast(int, weight)
         except HandledError:
             return -1
 
-    def __getitem__(self, key: str) -> Any:
+    def __getitem__(self, key: str) -> object:
         with self._capture_metrics():
             if key in self.fast:
                 # Note: don't log from self.fast.__getitem__, because that's called
                 # every time a key is evicted, and we don't want to count those events
                 # here.
                 nbytes = cast(int, self.fast.weights[key])
                 # This is logged not only by the internal metrics callback but also by
@@ -225,53 +222,53 @@
 
             return super().__getitem__(key)
 
     def __delitem__(self, key: str) -> None:
         super().__delitem__(key)
         self.logged_pickle_errors.discard(key)
 
-    def pop(self, key: str, default: Any = None) -> Any:
+    def pop(self, key: str, default: object = None) -> object:
         raise NotImplementedError(
             "Are you calling .pop(key, None) as a way to discard a key if it exists?"
             "It may cause data to be read back from disk! Please use `del` instead."
         )
 
     @property
-    def memory(self) -> Mapping[str, Any]:
+    def memory(self) -> Mapping[str, object]:
         """Key/value pairs stored in RAM. Alias of zict.Buffer.fast.
         For inspection only - do not modify directly!
         """
         return self.fast
 
     @property
-    def disk(self) -> Mapping[str, Any]:
+    def disk(self) -> Mapping[str, object]:
         """Key/value pairs spilled out to disk. Alias of zict.Buffer.slow.
         For inspection only - do not modify directly!
         """
         return self.slow
 
     @property
     def _slow_uncached(self) -> Slow:
-        slow = cast(zict.Cache, self.slow).data if has_zict_220 else self.slow
-        return cast(Slow, slow)
+        cache = cast(zict.Cache, self.slow)
+        return cast(Slow, cache.data)
 
     @property
     def spilled_total(self) -> SpilledSize:
         """Number of bytes spilled to disk. Tuple of
 
         - output of sizeof()
         - pickled size
 
         The two may differ substantially, e.g. if sizeof() is inaccurate or in case of
         compression.
         """
         return self._slow_uncached.total_weight
 
 
-def _in_memory_weight(key: str, value: Any) -> int:
+def _in_memory_weight(key: str, value: object) -> int:
     return safe_sizeof(value)
 
 
 # Internal exceptions. These are never raised by SpillBuffer.
 class MaxSpillExceeded(Exception):
     pass
 
@@ -280,50 +277,53 @@
     pass
 
 
 class HandledError(Exception):
     pass
 
 
-# zict.Func[str, Any] requires zict >= 2.2.0
-class Slow(zict.Func):
+class Slow(zict.Func[str, object, bytes]):
     max_weight: int | Literal[False]
     weight_by_key: dict[str, SpilledSize]
     total_weight: SpilledSize
 
     def __init__(self, spill_directory: str, max_weight: int | Literal[False] = False):
         super().__init__(
             partial(serialize_bytelist, on_error="raise"),
             deserialize_bytes,
             zict.File(spill_directory),
         )
         self.max_weight = max_weight
         self.weight_by_key = {}
         self.total_weight = SpilledSize(0, 0)
 
-    def __getitem__(self, key: str) -> Any:
+    def __getitem__(self, key: str) -> object:
         with context_meter.meter("disk-read", "seconds"):
             pickled = self.d[key]
         context_meter.digest_metric("disk-read", 1, "count")
         context_meter.digest_metric("disk-read", len(pickled), "bytes")
         out = self.load(pickled)
         return out
 
-    def __setitem__(self, key: str, value: Any) -> None:
+    def __setitem__(self, key: str, value: object) -> None:
         try:
             pickled = self.dump(value)
         except Exception as e:
             # zict.LRU ensures that the key remains in fast if we raise.
             # Wrap the exception so that it's recognizable by SpillBuffer,
             # which will then unwrap it.
             raise PickleError(key, e)
 
         pickled_size = sum(
             frame.nbytes if isinstance(frame, memoryview) else len(frame)
-            for frame in pickled
+            # File is MutableMapping[str, bytes], but serialize_bytelist returns
+            # list[bytes | memorymapping], which files actually accepts despite its
+            # signature. This is because MutableMapping doesn't allow for asymmetric VT
+            # in __getitem__ and __setitem__.
+            for frame in cast(list, pickled)
         )
 
         # Thanks to Buffer.__setitem__, we never update existing
         # keys in slow, but always delete them and reinsert them.
         assert key not in self.d
         assert key not in self.weight_by_key
```

### Comparing `distributed-2023.3.2.1/distributed/stealing.py` & `distributed-2023.4.0/distributed/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/system.py` & `distributed-2023.4.0/distributed/system.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/system_monitor.py` & `distributed-2023.4.0/distributed/system_monitor.py`

 * *Files 3% similar despite different names*

```diff
@@ -26,14 +26,16 @@
     monitor_host_cpu: bool
     monitor_gil_contention: bool
     _last_net_io_counters: Any  # psutil namedtuple
     _last_disk_io_counters: Any  # psutil namedtuple
     _last_host_cpu_counters: Any  # dynamically-defined psutil namedtuple
     _last_gil_contention: float  # 0-1 value
 
+    _cumulative_gil_contention: float
+
     gpu_name: str | None
     gpu_memory_total: int
 
     # Defaults to 1h capture time assuming the default
     # distributed.admin.system_monitor.interval = 500ms
     def __init__(
         self,
@@ -104,14 +106,15 @@
             except ImportError:
                 warnings.warn(
                     "Monitoring GIL requires `gilknocker` to be installed. `pip install gilknocker`"
                 )
                 self.monitor_gil_contention = False
             else:
                 self.quantities["gil_contention"] = deque(maxlen=maxlen)
+                self._cumulative_gil_contention = 0.0
                 raw_interval = dask.config.get(
                     "distributed.admin.system-monitor.gil.interval",
                 )
                 interval = dask.utils.parse_timedelta(raw_interval, default="us") * 1e6
 
                 self._gilknocker = KnockKnock(polling_interval_micros=int(interval))
                 self._gilknocker.start()
@@ -187,14 +190,15 @@
                 delta = getattr(host_cpu, k) - getattr(last_cpu, k)
                 # cpu_times() has a precision of 2 decimals; suppress noise
                 result["host_cpu." + k] = round(delta / duration, 2)
             self._last_host_cpu_counters = host_cpu
 
         if self.monitor_gil_contention:
             self._last_gil_contention = self._gilknocker.contention_metric
+            self._cumulative_gil_contention += self._last_gil_contention
             result["gil_contention"] = self._last_gil_contention
             self._gilknocker.reset_contention_metric()
 
         # Note: WINDOWS constant doesn't work with `mypy --platform win32`
         if sys.platform != "win32":
             result["num_fds"] = self.proc.num_fds()
```

### Comparing `distributed-2023.3.2.1/distributed/threadpoolexecutor.py` & `distributed-2023.4.0/distributed/threadpoolexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/utils.py` & `distributed-2023.4.0/distributed/utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -63,15 +63,15 @@
 from dask import istask
 from dask.utils import ensure_bytes as _ensure_bytes
 from dask.utils import key_split
 from dask.utils import parse_timedelta as _parse_timedelta
 from dask.widgets import get_template
 
 from distributed.compatibility import WINDOWS
-from distributed.metrics import monotonic, time
+from distributed.metrics import context_meter, monotonic, time
 
 try:
     from dask.context import thread_state
 except ImportError:
     thread_state = threading.local()
 
 # For some reason this is required in python >= 3.9
@@ -1456,15 +1456,16 @@
 
     See also
     --------
     asyncio.to_thread
     run_in_executor_with_context
     https://bugs.python.org/issue34014
     """
-    return run_in_executor_with_context(_offload_executor, func, *args, **kwargs)
+    with context_meter.meter("offload"):
+        return run_in_executor_with_context(_offload_executor, func, *args, **kwargs)
 
 
 class EmptyContext:
     def __enter__(self):
         pass
 
     def __exit__(self, exc_type, exc_value, traceback):
```

### Comparing `distributed-2023.3.2.1/distributed/utils_comm.py` & `distributed-2023.4.0/distributed/utils_comm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/utils_perf.py` & `distributed-2023.4.0/distributed/utils_perf.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/utils_test.py` & `distributed-2023.4.0/distributed/utils_test.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/variable.py` & `distributed-2023.4.0/distributed/variable.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/versions.py` & `distributed-2023.4.0/distributed/versions.py`

 * *Files 5% similar despite different names*

```diff
@@ -8,16 +8,17 @@
 import struct
 import sys
 from collections.abc import Callable, Iterable
 from itertools import chain
 from types import ModuleType
 from typing import Any
 
-MIN_BOKEH_VERSION = "2.4.2"
-MAX_BOKEH_VERSION = "2.4.3"
+from packaging.requirements import Requirement
+
+BOKEH_REQUIREMENT = Requirement("bokeh>=2.4.2,!=3.0.*")
 
 required_packages = [
     ("dask", lambda p: p.__version__),
     ("distributed", lambda p: p.__version__),
     ("msgpack", lambda p: ".".join([str(v) for v in p.version])),
     ("cloudpickle", lambda p: p.__version__),
     ("tornado", lambda p: p.version),
```

### Comparing `distributed-2023.3.2.1/distributed/widgets/templates/client.html.j2` & `distributed-2023.4.0/distributed/widgets/templates/client.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/widgets/templates/cluster.html.j2` & `distributed-2023.4.0/distributed/widgets/templates/cluster.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/widgets/templates/computation.html.j2` & `distributed-2023.4.0/distributed/widgets/templates/computation.html.j2`

 * *Files 6% similar despite different names*

```diff
@@ -22,17 +22,17 @@
         </td>
         <td style="text-align: left;"></td>
     </tr>
 </table>
 
 <details>
 <summary style="margin-bottom": 20px><h4 style="display:inline">Code</h4></summary>
-{% for segment in code %}
+{% for frames in code if frames %}
 <h5>Code segment {{ loop.index }} / {{ code | length }}</h5>
-<pre><code>{{ segment }}</code></pre>
+<pre><code>{{ frames[-1] }}</code></pre>
 {% endfor %}
 </details>
 
 <details>
 <summary style="margin-bottom": 20px><h4 style="display:inline">Task Groups</h4></summary>
 <ul>
 {% for gr in groups %}
```

#### html2text {}

```diff
@@ -3,17 +3,17 @@
 Start:{{ start }}
 Groups:{{ groups | length }}
 Tasks: {% for k, v in states.items() if v %} {{ k }}: {{ v }} {{ ", " if not
 loop.last else "" }} {% endfor %}
 
  20px>
 *** Code ***
-{% for segment in code %}
+{% for frames in code if frames %}
 ** Code segment {{ loop.index }} / {{ code | length }} **
-{{ segment }}
+{{ frames[-1] }}
 {% endfor %}
  20px>
 *** Task Groups ***
     * {% for gr in groups %}
     * {{ gr.__repr__() | html_escape }}
     * {% endfor %}
```

### Comparing `distributed-2023.3.2.1/distributed/widgets/templates/future.html.j2` & `distributed-2023.4.0/distributed/widgets/templates/future.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/widgets/templates/has_what.html.j2` & `distributed-2023.4.0/distributed/widgets/templates/has_what.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/widgets/templates/log.html.j2` & `distributed-2023.4.0/distributed/widgets/templates/log.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/widgets/templates/process_interface.html.j2` & `distributed-2023.4.0/distributed/widgets/templates/process_interface.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/widgets/templates/scheduler_info.html.j2` & `distributed-2023.4.0/distributed/widgets/templates/scheduler_info.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/worker.py` & `distributed-2023.4.0/distributed/worker.py`

 * *Files 2% similar despite different names*

```diff
@@ -73,15 +73,15 @@
     coerce_to_address,
     context_meter_to_server_digest,
     error_message,
     pingpong,
 )
 from distributed.core import rpc as RPCType
 from distributed.core import send_recv
-from distributed.diagnostics import nvml
+from distributed.diagnostics import nvml, rmm
 from distributed.diagnostics.plugin import _get_plugin_name
 from distributed.diskutils import WorkDir, WorkSpace
 from distributed.http import get_handlers
 from distributed.metrics import context_meter, thread_time, time
 from distributed.node import ServerNode
 from distributed.proctitle import setproctitle
 from distributed.protocol import pickle, to_serialize
@@ -114,14 +114,15 @@
 )
 from distributed.utils_comm import gather_from_workers, pack_data, retry_operation
 from distributed.utils_perf import disable_gc_diagnosis, enable_gc_diagnosis
 from distributed.versions import get_versions
 from distributed.worker_memory import (
     DeprecatedMemoryManagerAttribute,
     DeprecatedMemoryMonitor,
+    WorkerDataParameter,
     WorkerMemoryManager,
 )
 from distributed.worker_state_machine import (
     NO_VALUE,
     AcquireReplicasEvent,
     BaseWorker,
     CancelComputeEvent,
@@ -513,24 +514,15 @@
         lifetime_restart: bool | None = None,
         transition_counter_max: int | Literal[False] = False,
         ###################################
         # Parameters to WorkerMemoryManager
         memory_limit: str | float = "auto",
         # Allow overriding the dict-like that stores the task outputs.
         # This is meant for power users only. See WorkerMemoryManager for details.
-        data: (
-            MutableMapping[str, Any]  # pre-initialised
-            | Callable[[], MutableMapping[str, Any]]  # constructor
-            # constructor receiving self.local_directory
-            | Callable[[str], MutableMapping[str, Any]]
-            | tuple[
-                Callable[..., MutableMapping[str, Any]], dict[str, Any]
-            ]  # (constructor, kwargs to constructor)
-            | None  # create internally
-        ) = None,
+        data: WorkerDataParameter = None,
         # Deprecated parameters; please use dask config instead.
         memory_target_fraction: float | Literal[False] | None = None,
         memory_spill_fraction: float | Literal[False] | None = None,
         memory_pause_fraction: float | Literal[False] | None = None,
         ###################################
         # Parameters to Server
         scheduler_sni: str | None = None,
@@ -872,15 +864,15 @@
 
     ################
     # Memory manager
     ################
     memory_manager: WorkerMemoryManager
 
     @property
-    def data(self) -> MutableMapping[str, Any]:
+    def data(self) -> MutableMapping[str, object]:
         """{task key: task payload} of all completed tasks, whether they were computed
         on this Worker or computed somewhere else and then transferred here over the
         network.
 
         When using the default configuration, this is a zict buffer that automatically
         spills to disk whenever the target threshold is exceeded.
         If spilling is disabled, it is a plain dict instead.
@@ -1040,14 +1032,15 @@
         out = dict(
             task_counts=self.state.task_counter.current_count(by_prefix=False),
             bandwidth={
                 "total": self.bandwidth,
                 "workers": dict(self.bandwidth_workers),
                 "types": keymap(typename, self.bandwidth_types),
             },
+            digests_total_since_heartbeat=dict(self.digests_total_since_heartbeat),
             managed_bytes=self.state.nbytes,
             spilled_bytes={
                 "memory": spilled_memory,
                 "disk": spilled_disk,
             },
             transfer={
                 "incoming_bytes": self.state.transfer_incoming_bytes,
@@ -1056,14 +1049,16 @@
                 "outgoing_bytes": self.transfer_outgoing_bytes,
                 "outgoing_count": self.transfer_outgoing_count,
                 "outgoing_count_total": self.transfer_outgoing_count_total,
             },
             event_loop_interval=self._tick_interval_observed,
         )
 
+        self.digests_total_since_heartbeat.clear()
+
         monitor_recent = self.monitor.recent()
         # Convert {foo.bar: 123} to {foo: {bar: 123}}
         for k, v in monitor_recent.items():
             if "." in k:
                 k0, _, k1 = k.partition(".")
                 out.setdefault(k0, {})[k1] = v
             else:
@@ -1153,38 +1148,33 @@
     async def _register_with_scheduler(self) -> None:
         self.periodic_callbacks["keep-alive"].stop()
         self.periodic_callbacks["heartbeat"].stop()
         start = time()
         if self.contact_address is None:
             self.contact_address = self.address
         logger.info("-" * 49)
+
+        # Worker reconnection is not supported
+        assert not self.data
+        assert not self.state.tasks
+
         while True:
             try:
                 _start = time()
                 comm = await connect(self.scheduler.address, **self.connection_args)
                 comm.name = "Worker->Scheduler"
                 comm._server = weakref.ref(self)
                 await comm.write(
                     dict(
                         op="register-worker",
                         reply=False,
                         address=self.contact_address,
                         status=self.status.name,
-                        keys=list(self.data),
                         nthreads=self.state.nthreads,
                         name=self.name,
-                        nbytes={
-                            ts.key: ts.get_nbytes()
-                            for ts in self.state.tasks.values()
-                            # Only if the task is in memory this is a sensible
-                            # result since otherwise it simply submits the
-                            # default value
-                            if ts.state == "memory"
-                        },
-                        types={k: typename(v) for k, v in self.data.items()},
                         now=time(),
                         resources=self.state.total_resources,
                         memory_limit=self.memory_manager.memory_limit,
                         local_directory=self.local_directory,
                         services=self.service_ports,
                         nanny=self.nanny,
                         pid=os.getpid(),
@@ -1562,15 +1552,15 @@
             except Exception:
                 logger.exception("Failed to tear down preload")
 
         for extension in self.extensions.values():
             if hasattr(extension, "close"):
                 result = extension.close()
                 if isawaitable(result):
-                    result = await result
+                    await result
 
         if nanny and self.nanny:
             with self.rpc(self.nanny) as r:
                 await r.close_gracefully(reason=reason)
 
         setproctitle("dask worker [closing]")
 
@@ -2275,28 +2265,37 @@
                     result = await apply_function_async(
                         function,
                         args2,
                         kwargs2,
                         self.scheduler_delay,
                     )
                 elif "ThreadPoolExecutor" in str(type(e)):
-                    result = await run_in_executor_with_context(
-                        e,
-                        apply_function,
-                        function,
-                        args2,
-                        kwargs2,
-                        self.execution_state,
-                        key,
-                        self.active_threads,
-                        self.active_threads_lock,
-                        self.scheduler_delay,
-                    )
+                    # The 'executor' time metric should be almost zero most of the time,
+                    # e.g. thread synchronization overhead only, since thread-noncpu and
+                    # thread-cpu inside the thread detract from it. However, it may
+                    # become substantial in case of misalignment between the size of the
+                    # thread pool and the number of running tasks in the worker state
+                    # machine (e.g. https://github.com/dask/distributed/issues/5882)
+                    with context_meter.meter("executor"):
+                        result = await run_in_executor_with_context(
+                            e,
+                            apply_function,
+                            function,
+                            args2,
+                            kwargs2,
+                            self.execution_state,
+                            key,
+                            self.active_threads,
+                            self.active_threads_lock,
+                            self.scheduler_delay,
+                        )
                 else:
-                    # Can't capture contextvars across processes
+                    # Can't capture contextvars across processes. If this is a
+                    # ProcessPoolExecutor, the 'executor' time metric will show the
+                    # whole runtime inside the executor.
                     with context_meter.meter("executor"):
                         result = await self.loop.run_in_executor(
                             e,
                             apply_function_simple,
                             function,
                             args2,
                             kwargs2,
@@ -2369,15 +2368,15 @@
                 exc,
                 key=key,
                 stimulus_id=f"execute-unknown-error-{time()}",
             )
 
     def _prepare_args_for_execution(
         self, ts: TaskState, args: tuple, kwargs: dict[str, Any]
-    ) -> tuple[tuple, dict[str, Any]]:
+    ) -> tuple[tuple[object, ...], dict[str, object]]:
         start = time()
         data = {}
         for dep in ts.dependencies:
             k = dep.key
             try:
                 data[k] = self.data[k]
             except KeyError:
@@ -3320,14 +3319,28 @@
 
     def gpu_startup(worker):
         return nvml.one_time()
 
     DEFAULT_STARTUP_INFORMATION["gpu"] = gpu_startup
 
 
+try:
+    import rmm as _rmm
+except Exception:
+    pass
+else:
+
+    async def rmm_metric(worker):
+        result = await offload(rmm.real_time)
+        return result
+
+    DEFAULT_METRICS["rmm"] = rmm_metric
+    del _rmm
+
+
 def print(
     *args,
     sep: str | None = " ",
     end: str | None = "\n",
     file: TextIO | None = None,
     flush: bool = False,
 ) -> None:
```

### Comparing `distributed-2023.3.2.1/distributed/worker_client.py` & `distributed-2023.4.0/distributed/worker_client.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed/worker_memory.py` & `distributed-2023.4.0/distributed/worker_memory.py`

 * *Files 3% similar despite different names*

```diff
@@ -24,15 +24,15 @@
 import logging
 import os
 import sys
 import warnings
 from collections.abc import Callable, Hashable, MutableMapping
 from contextlib import suppress
 from functools import partial
-from typing import TYPE_CHECKING, Any, Container, Literal, cast
+from typing import TYPE_CHECKING, Any, Container, Literal, Union, cast
 
 import psutil
 
 import dask.config
 from dask.system import CPU_COUNT
 from dask.utils import format_bytes, parse_bytes, parse_timedelta
 
@@ -41,18 +41,37 @@
 from distributed.core import Status
 from distributed.metrics import context_meter, monotonic
 from distributed.spill import ManualEvictProto, SpillBuffer
 from distributed.utils import RateLimiterFilter, has_arg, log_errors
 from distributed.utils_perf import ThrottledGC
 
 if TYPE_CHECKING:
+    # TODO import from typing (requires Python >=3.10)
+    from typing_extensions import TypeAlias
+
     # Circular imports
     from distributed.nanny import Nanny
     from distributed.worker import Worker
 
+    # TODO move outside of TYPE_CHECKING (requires Python >=3.9)
+    WorkerDataParameter: TypeAlias = Union[
+        # pre-initialized
+        MutableMapping[str, object],
+        # constructor
+        Callable[[], MutableMapping[str, object]],
+        # constructor, passed worker.local_directory
+        Callable[[str], MutableMapping[str, object]],
+        # (constructor, kwargs to constructor)
+        tuple[Callable[..., MutableMapping[str, object]], dict[str, Any]],
+        # initialize internally
+        None,
+    ]
+else:
+    WorkerDataParameter = object
+
 worker_logger = logging.getLogger("distributed.worker.memory")
 worker_logger.addFilter(RateLimiterFilter(r"Unmanaged memory use is high"))
 nanny_logger = logging.getLogger("distributed.nanny.memory")
 
 
 class WorkerMemoryManager:
     """Management of worker memory usage
@@ -86,24 +105,15 @@
         self,
         worker: Worker,
         *,
         nthreads: int,
         memory_limit: str | float = "auto",
         # This should be None most of the times, short of a power user replacing the
         # SpillBuffer with their own custom dict-like
-        data: (
-            MutableMapping[str, Any]  # pre-initialised
-            | Callable[[], MutableMapping[str, Any]]  # constructor
-            # constructor, passed worker.local_directory
-            | Callable[[str], MutableMapping[str, Any]]
-            | tuple[
-                Callable[..., MutableMapping[str, Any]], dict[str, Any]
-            ]  # (constructor, kwargs to constructor)
-            | None  # create internally
-        ) = None,
+        data: WorkerDataParameter = None,
         # Deprecated parameters; use dask.config instead
         memory_target_fraction: float | Literal[False] | None = None,
         memory_spill_fraction: float | Literal[False] | None = None,
         memory_pause_fraction: float | Literal[False] | None = None,
     ):
         self.memory_limit = parse_memory_limit(
             memory_limit, nthreads, logger=worker_logger
@@ -127,18 +137,18 @@
         max_spill = dask.config.get("distributed.worker.memory.max-spill")
         self.max_spill = False if max_spill is False else parse_bytes(max_spill)
 
         if isinstance(data, MutableMapping):
             self.data = data
         elif callable(data):
             if has_arg(data, "worker_local_directory"):
-                data = cast("Callable[[str], MutableMapping[str, Any]]", data)
+                data = cast("Callable[[str], MutableMapping[str, object]]", data)
                 self.data = data(worker.local_directory)
             else:
-                data = cast("Callable[[], MutableMapping[str, Any]]", data)
+                data = cast("Callable[[], MutableMapping[str, object]]", data)
                 self.data = data()
         elif isinstance(data, tuple):
             func, kwargs = data
             if not callable(func):
                 raise ValueError("Expecting a callable")
             if has_arg(func, "worker_local_directory"):
                 self.data = func(
@@ -160,14 +170,19 @@
                 os.path.join(worker.local_directory, "storage"),
                 target=target,
                 max_spill=self.max_spill,
             )
         else:
             self.data = {}
 
+        if not isinstance(self.data, MutableMapping):
+            raise TypeError(f"Worker.data must be a MutableMapping; got {self.data}")
+        if self.data:
+            raise ValueError("Worker.data must be empty at initialization time")
+
         self.memory_monitor_interval = parse_timedelta(
             dask.config.get("distributed.worker.memory.monitor-interval"),
             default=False,
         )
         assert isinstance(self.memory_monitor_interval, (int, float))
 
         if self.memory_limit and (
```

### Comparing `distributed-2023.3.2.1/distributed/worker_state_machine.py` & `distributed-2023.4.0/distributed/worker_state_machine.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/distributed.egg-info/PKG-INFO` & `distributed-2023.4.0/distributed.egg-info/PKG-INFO`

 * *Files 3% similar despite different names*

```diff
@@ -1,15 +1,14 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.3.2.1
+Version: 2023.4.0
 Summary: Distributed scheduler for Dask
-Home-page: https://distributed.dask.org
-Maintainer: Matthew Rocklin
-Maintainer-email: mrocklin@gmail.com
+Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
+Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
 Classifier: Intended Audience :: Science/Research
 Classifier: License :: OSI Approved :: BSD License
 Classifier: Operating System :: OS Independent
 Classifier: Programming Language :: Python
@@ -18,14 +17,15 @@
 Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
 Classifier: Programming Language :: Python :: 3.11
 Classifier: Topic :: Scientific/Engineering
 Classifier: Topic :: System :: Distributed Computing
 Requires-Python: >=3.8
+Description-Content-Type: text/x-rst
 License-File: LICENSE.txt
 License-File: AUTHORS.md
 
 Distributed
 ===========
 
 |Test Status| |Longitudinal Report (full)| |Longitudinal Report (short)| |Coverage| |Doc Status| |Discourse| |Version Status| |NumFOCUS|
```

### Comparing `distributed-2023.3.2.1/distributed.egg-info/SOURCES.txt` & `distributed-2023.4.0/distributed.egg-info/SOURCES.txt`

 * *Files 1% similar despite different names*

```diff
@@ -1,15 +1,13 @@
 AUTHORS.md
 LICENSE.txt
 MANIFEST.in
 README.rst
-requirements.txt
-setup.cfg
+pyproject.toml
 setup.py
-versioneer.py
 distributed/__init__.py
 distributed/_concurrent_futures_thread.py
 distributed/_signals.py
 distributed/_stories.py
 distributed/_version.py
 distributed/active_memory_manager.py
 distributed/actor.py
@@ -91,14 +89,15 @@
 distributed/dashboard/export_tool.py
 distributed/dashboard/scheduler.py
 distributed/dashboard/theme.yaml
 distributed/dashboard/utils.py
 distributed/dashboard/worker.py
 distributed/dashboard/components/__init__.py
 distributed/dashboard/components/nvml.py
+distributed/dashboard/components/rmm.py
 distributed/dashboard/components/scheduler.py
 distributed/dashboard/components/shared.py
 distributed/dashboard/components/worker.py
 distributed/dashboard/templates/performance_report.html
 distributed/deploy/__init__.py
 distributed/deploy/adaptive.py
 distributed/deploy/adaptive_core.py
@@ -115,14 +114,15 @@
 distributed/diagnostics/graph_layout.py
 distributed/diagnostics/memory_sampler.py
 distributed/diagnostics/nvml.py
 distributed/diagnostics/plugin.py
 distributed/diagnostics/progress.py
 distributed/diagnostics/progress_stream.py
 distributed/diagnostics/progressbar.py
+distributed/diagnostics/rmm.py
 distributed/diagnostics/task_stream.py
 distributed/diagnostics/websocket.py
 distributed/http/__init__.py
 distributed/http/health.py
 distributed/http/prometheus.py
 distributed/http/proxy.py
 distributed/http/routing.py
```

### Comparing `distributed-2023.3.2.1/docs/source/active_memory_manager.rst` & `distributed-2023.4.0/docs/source/active_memory_manager.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/actors.rst` & `distributed-2023.4.0/docs/source/actors.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/api.rst` & `distributed-2023.4.0/docs/source/api.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/asynchronous.rst` & `distributed-2023.4.0/docs/source/asynchronous.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/changelog.rst` & `distributed-2023.4.0/docs/source/changelog.rst`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,84 @@
 Changelog
 =========
 
+.. _v2023.4.0:
+
+2023.4.0
+--------
+
+Released on April 14, 2023
+
+.. note::
+
+    With this release we are making a change which will require the Dask scheduler to have
+    consistent software and hardware capabilities as the client and workers.
+
+    It's always been recommended that your client and workers have a consistent software
+    and hardware environment so that data structures and dependencies can be pickled and passed
+    between them. However recent changes to the Dask scheduler mean that we now also require
+    your scheduler to have the same consistent environment as everything else.
+
+Enhancements
+^^^^^^^^^^^^
+- Meter queue time to the offload executor (:pr:`7758`) `crusaderky`_
+- Add GIL contention metric to Prometheus (:pr:`7651`) `Miles`_
+- Add methods ``Client.forward_logging()`` and ``Client.unforward_logging()``. (:pr:`7276`) `Max Bane`_
+- Optionally capture more frames in computations (:pr:`7656`) `Gabe Joseph`_
+- Consider Jupyter activity in idle timeout (:pr:`7687`) `Gabe Joseph`_
+- Add a dashboard component that displays RMM memory (:pr:`7718`) `Peter Andreas Entschev`_
+- Improve error message if ``shuffle``/``rechunk`` lost annotations (:pr:`7707`) `Hendrik Makait`_
+- Exception chaining in P2P shuffling (:pr:`7706`) `Hendrik Makait`_
+- Use pickle for graph submissions from client to scheduler (:pr:`7564`) `Florian Jetter`_
+
+Bug Fixes
+^^^^^^^^^
+- Fix crash on missing env var in dashboard link formatting (:pr:`7729`) `Miles`_
+- Fix ``randbytes()`` on Python 3.8 (:pr:`7771`) `crusaderky`_
+- Run scheduler of ``SubprocessCluster`` in subprocess (:pr:`7727`) `Hendrik Makait`_
+- Drop id from RMM dashboard component (:pr:`7739`) `James Bourbeau`_
+
+Maintenance
+^^^^^^^^^^^
+- Bump ``peter-evans/create-pull-request`` from 4 to 5 (:pr:`7766`)
+- Fix flaky ``test_malloc_trim_threshold`` in CI (:pr:`7764`) `crusaderky`_
+- Minor polish in ``spill`` and ``worker_memory_manager`` (:pr:`7752`) `crusaderky`_
+- Merge identical ``tool.mypy.overrides`` sections (:pr:`7749`) `Thomas Grainger`_
+- Add changelog section for 2023.3.2.1 (:pr:`7755`) `Charles Blackmon-Luca`_
+- Specify ``ts`` resolution explicitly in ``test_processing_chain`` (:pr:`7744`) `Patrick Hoefler`_
+- Unignore Sphinx ``ref.python`` (:pr:`7713`) `Thomas Grainger`_
+- Temporary fix for ``test_merge_by_multiple_columns`` with `pandas` 2.0 (:pr:`7747`) `James Bourbeau`_
+- Remove ``dask/gpu`` from gpuCI update reviewers (:pr:`7741`) `Charles Blackmon-Luca`_
+- Update gpuCI ``RAPIDS_VER`` to ``23.06`` (:pr:`7728`)
+- Remove test for ``DataFrame.to_hdf`` (:pr:`7735`) `Hendrik Makait`_
+- Test P2P shuffling with ``DataFrame.to_hdf`` (:pr:`7720`) `Hendrik Makait`_
+- ``scheduler.py`` typing - remove ``allow_incomplete_defs`` (:pr:`7721`) `Florian Jetter`_
+- Remove ``bokeh`` upper bound (:pr:`7413`) `James Bourbeau`_
+- Use declarative ``setuptools`` (:pr:`7629`) `Thomas Grainger`_
+- Store performance metrics on scheduler (:pr:`7701`) `Miles`_
+- Upgrade readthedocs config to ubuntu 22.04 and Python 3.11 (:pr:`7722`) `Thomas Grainger`_
+- Clean up legacy cruft from worker reconnection (:pr:`7712`) `crusaderky`_
+- Bump ``actions/checkout`` from 3.4.0 to 3.5.0 (:pr:`7711`)
+- Drop support for zict 2.1.0 (:pr:`7709`) `crusaderky`_
+- Fix ``mypy`` warning in ``test_client.py`` (:pr:`7710`) `crusaderky`_
+- Test P2P shuffling with ``DataFrame.categorize`` (:pr:`7708`) `Hendrik Makait`_
+
+
+.. _v2023.3.2.1:
+
+2023.3.2.1
+----------
+
+Released on April 5, 2023
+
+Bug Fixes
+^^^^^^^^^
+- Register atexit handler before Distributed handlers to unblock hanging UCX clusters `Lawrence Mitchell`_ `Ben Zaitlen`_
+
+
 .. _v2023.3.2:
 
 2023.3.2
 --------
 
 Released on March 24, 2023
 
@@ -4809,7 +4883,8 @@
 .. _`Stuart Berg`: https://github.com/stuarteberg
 .. _`Dylan Wragge`: https://github.com/dwragge
 .. _`Nicholas R. Knezek`: https://github.com/nknezek
 .. _`antonymayi`: https://github.com/antonymayi
 .. _`Miles`: https://github.com/milesgranger
 .. _`Eugene Druzhynin`: https://github.com/eugene-graft
 .. _`ypogorelova`: https://github.com/ypogorelova
+.. _`Patrick Hoefler`: https://github.com/phofl
```

### Comparing `distributed-2023.3.2.1/docs/source/client.rst` & `distributed-2023.4.0/docs/source/client.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/communications.rst` & `distributed-2023.4.0/docs/source/communications.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/develop.rst` & `distributed-2023.4.0/docs/source/develop.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/diagnosing-performance.rst` & `distributed-2023.4.0/docs/source/diagnosing-performance.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/efficiency.rst` & `distributed-2023.4.0/docs/source/efficiency.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/examples/word-count.rst` & `distributed-2023.4.0/docs/source/examples/word-count.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/faq.rst` & `distributed-2023.4.0/docs/source/faq.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/foundations.rst` & `distributed-2023.4.0/docs/source/foundations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/http_services.rst` & `distributed-2023.4.0/docs/source/http_services.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/index.rst` & `distributed-2023.4.0/docs/source/index.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/install.rst` & `distributed-2023.4.0/docs/source/install.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/journey.rst` & `distributed-2023.4.0/docs/source/journey.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/killed.rst` & `distributed-2023.4.0/docs/source/killed.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/limitations.rst` & `distributed-2023.4.0/docs/source/limitations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/locality.rst` & `distributed-2023.4.0/docs/source/locality.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/logging.rst` & `distributed-2023.4.0/docs/source/logging.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/manage-computation.rst` & `distributed-2023.4.0/docs/source/manage-computation.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/memory.rst` & `distributed-2023.4.0/docs/source/memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/plugins.rst` & `distributed-2023.4.0/docs/source/plugins.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/priority.rst` & `distributed-2023.4.0/docs/source/priority.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/prometheus.rst` & `distributed-2023.4.0/docs/source/prometheus.rst`

 * *Files 7% similar despite different names*

```diff
@@ -22,14 +22,23 @@
 
 The scheduler exposes the following metrics about itself:
 
 dask_scheduler_clients
     Number of clients connected
 dask_scheduler_desired_workers
     Number of workers scheduler needs for task graph
+dask_scheduler_gil_contention_total
+    Value representing cumulative total of GIL contention,
+    in the form of summed percentages.
+
+    .. note::
+       Requires ``gilknocker`` to be installed, and 
+       ``distributed.admin.system-monitor.gil.enabled``
+       configuration to be set.
+
 dask_scheduler_workers
     Number of workers known by scheduler
 dask_scheduler_tasks
     Number of tasks known by scheduler
 dask_scheduler_tasks_suspicious_total
     Total number of times a task has been marked suspicious
 dask_scheduler_tasks_forgotten_total
@@ -113,14 +122,23 @@
 
 The worker exposes these metrics about itself:
 
 dask_worker_tasks
     Number of tasks at worker
 dask_worker_threads
     Number of worker threads
+dask_worker_gil_contention_total
+    Value representing cumulative total GIL contention on worker,
+    in the form of summed percentages.
+
+    .. note::
+       Requires ``gilknocker`` to be installed, and
+       ``distributed.admin.system-monitor.gil.enabled``
+       configuration to be set.
+
 dask_worker_latency_seconds
     Latency of worker connection
 dask_worker_memory_bytes
     Memory breakdown
 dask_worker_transfer_incoming_bytes
     Total size of open data transfers from other workers
 dask_worker_transfer_incoming_count
```

### Comparing `distributed-2023.3.2.1/docs/source/protocol.rst` & `distributed-2023.4.0/docs/source/protocol.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/publish.rst` & `distributed-2023.4.0/docs/source/publish.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/quickstart.rst` & `distributed-2023.4.0/docs/source/quickstart.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/related-work.rst` & `distributed-2023.4.0/docs/source/related-work.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/resilience.rst` & `distributed-2023.4.0/docs/source/resilience.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/resources.rst` & `distributed-2023.4.0/docs/source/resources.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/scheduling-policies.rst` & `distributed-2023.4.0/docs/source/scheduling-policies.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/scheduling-state.rst` & `distributed-2023.4.0/docs/source/scheduling-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/serialization.rst` & `distributed-2023.4.0/docs/source/serialization.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/task-launch.rst` & `distributed-2023.4.0/docs/source/task-launch.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/tls.rst` & `distributed-2023.4.0/docs/source/tls.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/work-stealing.rst` & `distributed-2023.4.0/docs/source/work-stealing.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/worker-memory.rst` & `distributed-2023.4.0/docs/source/worker-memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/worker-state.rst` & `distributed-2023.4.0/docs/source/worker-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.3.2.1/docs/source/worker.rst` & `distributed-2023.4.0/docs/source/worker.rst`

 * *Files identical despite different names*

